////////////////////////////////////////////////////////////////////////////////
// ОбменСКонтрагентамиВнутренний: механизм обмена электронными документами.
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

////////////////////////////////////////////////////////////////////////////////
// CML

// Функция получает тип значения CML.
//
// Параметры:
//  Тип - Тип - исходный тип.
//  ВерсияСхемы - Строка - версия схемы CML.
//
// Возвращаемое значение:
//  ТипЗначения - тип значения CML.
//
Функция ПолучитьТипЗначенияCML(Тип, ВерсияСхемы = "4.02") Экспорт
	
	Попытка
		Если ВерсияСхемы <> "4.02" Тогда
			ТипЗначения = ФабрикаXDTO.Тип(ВерсияСхемы, Тип);
		Иначе
			ТипЗначения = ФабрикаXDTO.Тип("http://v8.1c.ru/edi/edi_stnd", Тип);
		КонецЕсли
	Исключение
		
		ТипЗначения = Неопределено;
	КонецПопытки;
	
	Возврат ТипЗначения;
	
КонецФункции

// Получение объекта типа CML.
//
// Параметры:
//  Тип - Строка, Тип  - тип данных.
//  ВерсияСхемы - Строка - версия схемы.
// 
// Возвращаемое значение:
//  ТипЗначенияXDTO - тип XDTO.
//
Функция ПолучитьОбъектТипаCML(Тип, ВерсияСхемы = "4.01") Экспорт
	
	Если ТипЗнч(Тип) = Тип("Строка") Тогда
		ТипОбъекта = ПолучитьТипОбъектаCML(Тип, ВерсияСхемы);
	Иначе
		ТипОбъекта = Тип;
	КонецЕсли;
	
	Если ТипОбъекта = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	НовыйОбъект = ФабрикаXDTO.Создать(ТипОбъекта);
	
	Возврат НовыйОбъект;
	
КонецФункции

// Преобразует строковое представление даты в форматах DD.MM.YYYY, YYYY-MM-DD в дату.
//
// Параметры:
//  Строка	 - Строка - представление даты.
// Возвращаемое значение:
//  Дата - преобразованное значение.
//
Функция ДатаИзСтроки(Строка) Экспорт
	
	ЧастьДаты    = "";
	ЧастьВремени = "000000";
	Если Не СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(Сред(Строка, 3, 1)) Тогда
		ЧастьДаты = Сред(Строка, 7, 4) + Сред(Строка, 4, 2) + Сред(Строка, 1, 2);
	Иначе
	    ЧастьДаты = Сред(Строка, 1, 4) + Сред(Строка, 6, 2) + Сред(Строка, 9, 2);
		// заполним дополнительно время для формата 20 символов.
		Если СтрДлина(Строка) = 20 Тогда
			ЧастьВремени = СтрЗаменить(Сред(Строка, 12), ":", "");
		КонецЕсли;
	КонецЕсли;
	
	Возврат Дата(ЧастьДаты + ЧастьВремени);
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Заполнение дерева объектов разбора и дерева соответствий объектам

// Получает информацию о товаре в массиве ЭД
//
// Параметры:
//  МассивЭД - Массив - массив ссылок на элементы справочника ЭДПрисоединенныеФайлы.
//
// Возвращаемое значение:
//  ТаблицаЗначений - Таблица значений, содержащая информацию о товаре.
//
Функция ПолучитьИнформациюОТоваре(МассивЭД) Экспорт
	
	ТаблицаВозврата = Неопределено;
	ИменаДопКолонок = "";
	
	Для Каждого ТекЭД Из МассивЭД Цикл
		Если ОбменСКонтрагентамиСлужебный.ЭтоОтветныйТитул(ТекЭД.ТипЭлементаВерсииЭД) Тогда
			
			ЭД = ТекЭД.ЭлектронныйДокументВладелец;
		Иначе
			ЭД = ТекЭД;
		КонецЕсли;
		ДопИнформацияПоЭД = ОбменСКонтрагентамиСлужебный.ПолучитьДанныеФайла(ЭД, , Истина);
		Если ДопИнформацияПоЭД.Свойство("СсылкаНаДвоичныеДанныеФайла")
			И ЗначениеЗаполнено(ДопИнформацияПоЭД.СсылкаНаДвоичныеДанныеФайла) Тогда
			
			ДанныеЭД = ПолучитьИзВременногоХранилища(ДопИнформацияПоЭД.СсылкаНаДвоичныеДанныеФайла);
			
			Если ЗначениеЗаполнено(ДопИнформацияПоЭД.Расширение) Тогда
				ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла(ДопИнформацияПоЭД.Расширение);
			Иначе
				ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
			КонецЕсли;
			
			Если ИмяФайла = Неопределено Тогда
				ШаблонОшибки = НСтр("ru = 'Чтение электронного документа: %1.
				|Не удалось прочитать электронный документ. Проверьте настройку рабочего каталога.'");
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки, ЭД);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
				Продолжить;
			КонецЕсли;
			
			ДеревоДопДанных = Неопределено;
			Если НЕ ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭД, "ВладелецФайла.ВидЭД") = Перечисления.ВидыЭД.КаталогТоваров Тогда
				ВыборкаЭДДопДанных = ОбменСКонтрагентамиСлужебный.ВыборкаДопДанныеЭД(ЭД);
				Если ВыборкаЭДДопДанных.Следующий() Тогда
					ДопДанныеЭД = ОбменСКонтрагентамиСлужебный.ПолучитьДанныеФайла(
					                                                           ВыборкаЭДДопДанных.Ссылка,
					                                                           ВыборкаЭДДопДанных.Ссылка.УникальныйИдентификатор(),
					                                                           Истина);
					СсылкаНаДДДопДанныхЭД = "";
					Если ДопДанныеЭД.Свойство("СсылкаНаДвоичныеДанныеФайла", СсылкаНаДДДопДанныхЭД)
						И ЗначениеЗаполнено(СсылкаНаДДДопДанныхЭД) Тогда
						ВремФайл = ПолучитьИмяВременногоФайла("xml");
						ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(СсылкаНаДДДопДанныхЭД);
						ДвоичныеДанныеФайла.Записать(ВремФайл);
						ДеревоДопДанных = РазобратьУниверсальныйДопФайл(ВремФайл);
						ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			ДанныеЭД.Записать(ИмяФайла);
			
			Если СтрНайти(ДопИнформацияПоЭД.Расширение, "zip") > 0 ИЛИ СтрНайти(ДопИнформацияПоЭД.Расширение, "xml") > 0 Тогда
				
				ПапкаДляРаспаковки = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, ЭД.УникальныйИдентификатор());
				Если ПапкаДляРаспаковки = Неопределено Тогда
					ШаблонОшибки = НСтр("ru = 'Чтение электронного документа: %1.
					|Не удалось прочитать электронный документ. Проверьте настройку рабочего каталога.'");
					ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки, ЭД);
					ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
					Продолжить;
				КонецЕсли;
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки, "*.*");
				Если СтрНайти(ДопИнформацияПоЭД.Расширение, "zip") > 0 Тогда
					
					Если Не РаспаковатьАрхив(ИмяФайла, ПапкаДляРаспаковки, НСтр("ru = 'Распаковка пакета ЭД'")) Тогда
						
						ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
						ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
						Продолжить;
						
					КонецЕсли;
					
				Иначе
					ФайлПриемник = ПапкаДляРаспаковки + "\" + Новый УникальныйИдентификатор + ".xml";
					ОбменСКонтрагентамиСлужебный.УдалитьЛишнийСлэшВПути(ФайлПриемник);
					КопироватьФайл(ИмяФайла, ФайлПриемник);
				КонецЕсли;
				ФайлыАрхиваXML = НайтиФайлы(ПапкаДляРаспаковки, "*.xml");
				Для Каждого РаспакованныйФайл Из ФайлыАрхиваXML Цикл
					ИмяФайлаДанных = РаспакованныйФайл.ПолноеИмя;
					Если СтрНайти(РаспакованныйФайл.Имя, "packageDescription") Тогда
						Продолжить;
					КонецЕсли;
					ИнформацияОТовареИзФайлаXML(ИмяФайлаДанных, ТаблицаВозврата, ЭД, ДеревоДопДанных, ИменаДопКолонок);
				КонецЦикла;
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
		КонецЕсли;
	КонецЦикла;
	
	Если ТипЗнч(ТаблицаВозврата) = Тип("ТаблицаЗначений") Тогда
		ТаблицаВозврата.Свернуть("ИД, Артикул, Наименование, БазоваяЕдиницаКод, БазоваяЕдиницаНаименование,
			|БазоваяЕдиницаНаименованиеПолное, БазоваяЕдиницаМеждународноеСокращение, Описание, ЭД, НаименованиеХарактеристики"
			+ ИменаДопКолонок);
	КонецЕсли;

	Возврат ТаблицаВозврата;
	
КонецФункции

// Получает информацию о товаре из электронного документа.
//
// Параметры:
//  ПолноеИмяФайла - Строка - путь к файлу с содержимым электронного документа;
//  ТаблицаВозврата - ТаблицаЗначений - таблица товаров;
//  СсылкаНаЭД - ДокументСсылка.ЭлектронныйДокументВходящий - ссылка на электронный документ;
//  ДеревоДопДанных - ДеревоЗначений - дополнительные данные о товаре;
//  ИменаДопКолонок - Строка - имена дополнительных колонок через запятую.
//
Процедура ИнформацияОТовареИзФайлаXML(ПолноеИмяФайла,
									  ТаблицаВозврата,
									  СсылкаНаЭД,
									  ДеревоДопДанных = Неопределено,
									  ИменаДопКолонок = "") Экспорт
	
	ОписаниеОшибки = "";
	ДанныеФайлаЭД = ДанныеФайлаЭД(ПолноеИмяФайла, ОписаниеОшибки);
	Если НЕ ПустаяСтрока(ОписаниеОшибки) Тогда
		ВызватьИсключение ОписаниеОшибки;
	КонецЕсли;
	
	Попытка
		
		НаборДанных = Неопределено;
		ЭтоCML208   = Ложь;
		
		Если ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Каталог.Товары.Товар") <> Неопределено Тогда
			НаборДанных = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Каталог.Товары.Товар",, Истина);
			ЭтоCML208 = Истина;
		ИначеЕсли ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.Товары.Товар") <> Неопределено Тогда
			НаборДанных = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.Товары.Товар",, Истина);
			ЭтоCML208 = Истина;
		ИначеЕсли ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ПакетПредложений.Предложения.Предложение") <> Неопределено Тогда
			Список = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ПакетПредложений.Предложения.Предложение",, Истина);
			Если Список.Количество() Тогда
				НаборДанных = Список;
				ЭтоCML208 = Истина;
			КонецЕсли;
		КонецЕсли;
		
		Если ЭтоCML208 Тогда
			ДопПараметры = Новый Структура("ИменаДопКолонок", ИменаДопКолонок);
			СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
		КонецЕсли;
		
		Если ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ПрайсЛист", "4.02") Тогда
			НаборДанных = ДанныеФайлаЭД["Предложения"].Предложение;
			ДопПараметры = Новый Структура("ИменаДопКолонок", ИменаДопКолонок);
			СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
		ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("Каталог", "4.02")
				ИЛИ ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("АктОПриемке", "4.02")
				ИЛИ ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ТОРГ12", "4.02")
				ИЛИ ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("СчетНаОплату", "4.02")
				ИЛИ ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ОтчетОСписанииКомиссионногоТовара", "4.02")
				ИЛИ ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ОтчетОПродажахКомиссионногоТовара", "4.02")
				ИЛИ ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ЗаказКлиента", "4.02") Тогда
			Если ДанныеФайлаЭД["Товары"] <> Неопределено Тогда
				НаборДанных = ДанныеФайлаЭД["Товары"].Товар;
				ДопПараметры = Новый Структура("ИменаДопКолонок", ИменаДопКолонок);
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
			КонецЕсли;
		КонецЕсли;
			
		Если ДанныеФайлаЭД.Свойства().Получить("ИдФайл") <> Неопределено Тогда
			
			ДопПараметры = Новый Структура();
			ДопПараметры.Вставить("ДеревоДопДанных", ДеревоДопДанных);
			ДопПараметры.Вставить("ЕстьСвойствоИдФайл", Истина);
			ДопПараметры.Вставить("ИменаДопКолонок", ИменаДопКолонок);
			
			Если СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_SCHFDOPPR") > 0 Тогда
				
				НаборДанных = ДанныеФайлаЭД.Документ.ТаблСчФакт.СведТов;
				ДопПараметры.Вставить("ИмяТЧ", "Товары"); 
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_KORSCHFDOPPR") > 0 Тогда
				
				НаборДанных = ДанныеФайлаЭД.Документ.ТаблКСчФ.СведТов;
				ДопПараметры.Вставить("ИмяТЧ", "Товары"); 
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "OTORG12") > 0 Тогда
				
				НаборДанных = ДанныеФайлаЭД.Документ.СвТНО.ТН.Таблица.СвТов;
				ДопПараметры.Вставить("ИмяТЧ", "Товары"); 
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "OKORDOC") > 0 Тогда
				
				НаборДанных = ДанныеФайлаЭД.Документ.СвТНО.ТН.Таблица.СвТов;
				ДопПараметры.Вставить("ИмяТЧ", "Товары"); 
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "IAKTPRM") > 0 Тогда
				
				НаборДанныхОписанияРабот = ДанныеФайлаЭД.Документ.СвАктИ.ОписРабот;
				// Переберем номенклатуру из всех табличных частей акта.
				Для Сч = 0 По НаборДанныхОписанияРабот.Количество() - 1 Цикл
					ЭлементОписания = НаборДанныхОписанияРабот.ПолучитьXDTO(Сч);
					НаборДанных = ЭлементОписания.ПолучитьСписок("Работа");
					ДопПараметры.Вставить("ИмяТЧ", "Услуги");
					ДопПараметры.Вставить("НомерСтроки", Сч + 1);
					СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
				КонецЦикла;
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "KORSFAKT") > 0 Тогда
				НаборДанных = ДанныеФайлаЭД.Документ.ТаблКСчФ.СведТов;
				ДопПараметры.Вставить("ИмяТЧ", "Товары"); 
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "SFAKT") > 0 Тогда
				
				НаборДанных = ДанныеФайлаЭД.Документ.ТаблСчФакт.СведТов;
				ДопПараметры.Вставить("ИмяТЧ", "Товары"); 
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
					
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_TOVTORGPR") > 0 Тогда
				
				НаборДанных = ДанныеФайлаЭД.Документ.СвДокПТПрКроме.СодФХЖ2.СвТов;
				ДопПараметры.Вставить("ИмяТЧ", "Товары"); 
				СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
					
			ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_REZRUISP") > 0 Тогда
				
				НаборДанныхОписанияРабот = ДанныеФайлаЭД.Документ.СвДокПРУ.СодФХЖ1.ОписРабот;
				Для Сч = 0 По НаборДанныхОписанияРабот.Количество() - 1 Цикл
					ЭлементОписания = НаборДанныхОписанияРабот.ПолучитьXDTO(Сч);
					НаборДанных = ЭлементОписания.ПолучитьСписок("Работа");
					ДопПараметры.Вставить("ИмяТЧ", "Услуги");
					ДопПараметры.Вставить("НомерСтроки", Сч + 1);
					СформироватьТЗПоНаборуДанныхXDTO(ТаблицаВозврата, НаборДанных, СсылкаНаЭД, ДопПараметры);
				КонецЦикла;
				
			КонецЕсли;
		КонецЕсли;
		
		Если ТаблицаВозврата = Неопределено Тогда
			Если Пользователи.ЭтоПолноправныйПользователь(, , Ложь) Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Неизвестный тип при чтении данных из ЭД %1.'"), СсылкаНаЭД);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			КонецЕсли;
		КонецЕсли;
		
	Исключение
		Если Пользователи.ЭтоПолноправныйПользователь(, , Ложь) Тогда
			ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из ЭД %1: %2'");
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонСообщения, СсылкаНаЭД, ОписаниеОшибки());
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
	КонецПопытки;
	
КонецПроцедуры

// Определение типа электронного документа по типу владельца.
//
// Параметры:
//  СсылкаНаЭД - Ссылка - электронный документ.
// 
// Возвращаемое значение:
//  Перечисление.ТипыЭлементовВерсииЭД - возвращаемый тип.
//
Функция ОпределитьТипЭДПоТипуЭДВладельца(СсылкаНаЭД) Экспорт
	
	ТипЭлементаВерсииЭД = СсылкаНаЭД.ТипЭлементаВерсииЭД;
	Если ЗначениеЗаполнено(ТипЭлементаВерсииЭД) Тогда
		Если ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОЭСФ Тогда
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИППДОЭСФ;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДПЭСФ Тогда
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИППДПЭСФ;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ЭСФ
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД Тогда
			
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИПЭСФ;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПЭСФ Тогда
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИППДОИПЭСФ;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПУПДУКД Тогда
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИППДОИПУПДУКД;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.УУЭСФ Тогда
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИПУУЭСФ;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПервичныйЭД
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
			
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИОП;
		Иначе
			ВозвращаемыйТип = Неопределено;
		КонецЕсли;
	Иначе
		Если СсылкаНаЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура
		ИЛИ СсылкаНаЭД.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура Тогда
		
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИПЭСФ;
		ИначеЕсли СсылкаНаЭД.ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении Тогда
			
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИПУУЭСФ;
		ИначеЕсли СсылкаНаЭД.ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении
			ИЛИ СсылкаНаЭД.ВидЭД = Перечисления.ВидыЭД.Подтверждение Тогда
			
			ВозвращаемыйТип = Неопределено;
		Иначе
			ВозвращаемыйТип = Перечисления.ТипыЭлементовВерсииЭД.ИОП;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ВозвращаемыйТип;
	
КонецФункции

// Формирует печатную форму электронного документа по файлу данных.
//
// Параметры:
//  ПолноеИмяФайла - Строка - путь к файлу, по которому необходимо сформировать печатную форму.
//  НаправлениеЭД - ПеречислениеСсылка.НаправлениеЭД - НаправлениеЭД.
//  ПараметрыПечати - Структура - содержит параметры для печати документа:
//   * ИД - УникальныйИдентификатор - уникальный идентификатор объекта ЭД.
//   * ИмяФайлаПодчиненногоЭД - Строка - путь к файлу доп.данных.
//   * ВидЭД - ПеречислениеСсылка.ВидыЭД -  возвращает в вызывающую процедуру вид обрабатываемого ЭД.
//   * ИдентификаторДокумента - Строка - идентификатор.
//   * СтруктураПодписей - Структура - установленные электронные подписи.
//        ** КомуВыданСертификат - Строка - представление сертификата.
//        ** НомерСтроки - Число - Номер строки формы просмотра.
//
// Возвращаемое значение:
//  ТабличныйДокумент - Табличный документ с данными электронного документа.
//
Функция СформироватьПечатнуюФормуЭД(ПолноеИмяФайла, НаправлениеЭД, ПараметрыПечати) Экспорт
									
	ИмяФайлаДопДанных = ЗначениеПараметра(ПараметрыПечати, "ИмяФайлаДопДанных");
	Результат = СформироватьДеревоРазбора(ПолноеИмяФайла, НаправлениеЭД, ИмяФайлаДопДанных);
	
	Если Результат = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат ПечатнаяФормаЭД(Результат, НаправлениеЭД, ПараметрыПечати);
	
КонецФункции

// Формирует печатную форму электронного документа по файлу данных.
//
// Параметры:
//  СтруктураРазбораФайла - Структура - содержит дерево разбора ЭД.
//  НаправлениеЭД - ПеречислениеСсылка.НаправлениеЭД - направление.
//  ПараметрыПечати - Структура - содержит параметры для печати документа:
//   * ИД - УникальныйИдентификатор - уникальный идентификатор объекта ЭД.
//   * ИмяФайлаПодчиненногоЭД - Строка - путь к файлу доп.данных.
//   * ВидЭД - ПеречислениеСсылка.ВидыЭД - возвращает в вызывающую процедуру вид обрабатываемого ЭД.
//   * ИдентификаторДокумента - Строка - идентификатор.
//   * СтруктураПодписей - Структура - установленные электронные подписи.
//        ** КомуВыданСертификат - Строка - представление сертификата.
//        ** НомерСтроки - Число - Номер строки формы просмотра.
//
// Возвращаемое значение:
//  ТабличныйДокумент - данные электронного документа.
//
Функция ПечатнаяФормаЭД(СтруктураРазбораФайла, НаправлениеЭД, ПараметрыПечати) Экспорт
	
	ДеревоРазбора = СтруктураРазбораФайла.ДеревоРазбора;
	СтрокаОбъекта = СтруктураРазбораФайла.СтрокаОбъекта;
	
	ИдентификаторДокумента = ЗначениеПараметра(ПараметрыПечати, "ИдентификаторДокумента");
	Если ИдентификаторДокумента = Неопределено Тогда
		ИдентификаторДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
			"ИдентификаторДокумента");
	КонецЕсли;
	
	ОбщийТабДок = Новый ТабличныйДокумент;
	ОбщийТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	
	МакетИдентификатораДокумента = ПолучитьОбщийМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ИдентификаторДокумента_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	Если ЗначениеЗаполнено(ИдентификаторДокумента) Тогда
		ОбластьИдентификаторДокумента = МакетИдентификатораДокумента.ПолучитьОбласть("ИдентификаторДокумента");
		ОбластьИдентификаторДокумента.Параметры.ИдентификаторДокумента = ИдентификаторДокумента;
		ОбластьЯчеек = ОбластьИдентификаторДокумента.Область();
		ОбластьЯчеек.СоздатьФорматСтрок();
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ОбщийТабДок, ОбластьИдентификаторДокумента, "ИдентификаторДокумента");
	КонецЕсли;
	
	СтруктураПодписей = ЗначениеПараметра(ПараметрыПечати, "СтруктураПодписей");
	ТекстЭлектроннаяПодпись = "";
	Подписан = Ложь;
	Если ЗначениеЗаполнено(СтруктураПодписей) И СтруктураПодписей.Подписи.Количество() Тогда
		Подписан = Истина;
		ТекстЭлектроннаяПодпись = НСтр("ru='электронная подпись'");
		ОбластьПодпись = МакетИдентификатораДокумента.ПолучитьОбласть("Подпись");
		НомерПодписи = 1;
		Для каждого СтрокаПодписи Из СтруктураПодписей.Подписи Цикл
			ОбластьПодпись.Параметры.Значение = СтрокаПодписи.КомуВыданСертификат;
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ОбщийТабДок, ОбластьПодпись, "Подпись", НомерПодписи);
			
			НомерПодписи = НомерПодписи + 1;
		КонецЦикла;
		ОбластьЗаголовокПодписи = МакетИдентификатораДокумента.ПолучитьОбласть("ЗаголовокПодписей");
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ОбщийТабДок, ОбластьЗаголовокПодписи, "ЗаголовокПодписей");
	КонецЕсли;
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	
	ИмяФайлаПодчиненногоЭД = ЗначениеПараметра(ПараметрыПечати, "ИмяФайлаПодчиненногоЭД");
	ИД = ЗначениеПараметра(ПараметрыПечати, "ИД");
	
	Попытка
		
		Если СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.СчетФактура Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД Тогда
			
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				ИнформацияПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеИнформацииПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя);
				КонецЕсли;
				
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодпись",          ТекстЭлектроннаяПодпись);
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодписьКладовщик", ТекстЭлектроннаяПодпись);
					Если Не ДанныеЭДДляПечати.ПодвалНакладной.Свойство("ФИОКладовщика") Тогда
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ДолжностьКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ДолжностьРуководителя);
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ФИОКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ФИОРуководителя);
					КонецЕсли;
					
					ЕстьИсходящаяПодпись = Ложь;
					Для Каждого Подпись Из СтруктураПодписей.Подписи Цикл
						Если Подпись.Свойство("Входящая") И НЕ Подпись.Входящая Тогда
							ЕстьИсходящаяПодпись = Истина;
							Прервать;
						КонецЕсли;
					КонецЦикла;
					
					Если ИнформацияПокупателя.Количество() И ЕстьИсходящаяПодпись Тогда
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
						Если ИнформацияПокупателя.Свойство("ФИОКладовщикаПолучателя") Тогда
							ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись);
						Иначе
							Если ИнформацияПокупателя.Свойство("ДолжностьРуководителяПолучателя") Тогда
								 ИнформацияПокупателя.Вставить("ДолжностьКладовщикаПолучателя", ИнформацияПокупателя.ДолжностьРуководителяПолучателя)
							КонецЕсли;
							Если ИнформацияПокупателя.Свойство("ФИОРуководителяПолучателя") Тогда
								ИнформацияПокупателя.Вставить("ФИОКладовщикаПолучателя", ИнформацияПокупателя.ФИОРуководителяПолучателя)
							КонецЕсли;
							ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавца(ТабличныйДокумент, ДанныеЭДДляПечати, ИнформацияПокупателя, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
					
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД Тогда
				
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаДляПечати(СтрокаОбъекта, ДеревоРазбора);
					
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавца(ТабличныйДокумент, ДанныеЭДДляПечати, Неопределено, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
			
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД Тогда
				
				ИнформацияПокупателя = ДанныеИнформацииПокупателя(СтрокаОбъекта.ЗначениеРеквизита);
				Если Подписан Тогда
					ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
					Если ИнформацияПокупателя.Свойство("ФИОКладовщикаПолучателя")
						И ЗначениеЗаполнено(ИнформацияПокупателя.ФИОКладовщикаПолучателя) Тогда
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = ПараметрыПечати.СвойстваДокументаПервогоТитула;
				ИнформацияПокупателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
				ИнформацияПокупателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				
				ЗаполнитьТабличныйДокумент_ИнформацияПокупателя(ТабличныйДокумент, ИнформацияПокупателя);
				
			Иначе
				ДанныеЭДДляПечати = ПолучитьДанныеСчетаФактурыДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				Если Подписан Тогда
					Если ДанныеЭДДляПечати.Шапка.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Шапка.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументСчетФактура_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД Тогда
			
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаУКДДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				ИнформацияПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеИнформацииПокупателяУКД(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя);
				КонецЕсли;
				
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					Если ИнформацияПокупателя.Количество() Тогда
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавцаУКД(ТабличныйДокумент, ДанныеЭДДляПечати, ИнформацияПокупателя, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
			
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД Тогда
			
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаУКДДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавцаУКД(ТабличныйДокумент, ДанныеЭДДляПечати, Неопределено, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
				
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД Тогда
				ИнформацияПокупателя = ДанныеИнформацииПокупателяУКД(СтрокаОбъекта.ЗначениеРеквизита);
				Если Подписан Тогда
					ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
				КонецЕсли;
				СвойстваДокументаПервогоТитула = ПараметрыПечати.СвойстваДокументаПервогоТитула;
				ИнформацияПокупателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
				ИнформацияПокупателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				ЗаполнитьТабличныйДокумент_ИнформацияПокупателяУКД(ТабличныйДокумент, ИнформацияПокупателя);
				
			Иначе
				
				ДанныеЭДДляПечати = ПолучитьДанныеКорректировочногоСчетаФактурыДляПечати(СтрокаОбъекта, ДеревоРазбора);
				Если Подписан Тогда
					Если ДанныеЭДДляПечати.Шапка.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Шапка.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				ЗаполнитьТабличныйДокументКорректировочныйСчетФактура_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
				
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ТОРГ12
			Или СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
			
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				ИнформацияПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеИнформацииПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя);
				КонецЕсли;
				
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					Если Не ДанныеЭДДляПечати.ПодвалНакладной.Свойство("ФИОКладовщика") Тогда
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ДолжностьКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ДолжностьРуководителя);
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ФИОКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ФИОРуководителя);
					КонецЕсли;
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодписьКладовщик", ТекстЭлектроннаяПодпись);
					
					ЕстьИсходящаяПодпись = Ложь;
					Для Каждого Подпись Из СтруктураПодписей.Подписи Цикл
						Если Подпись.Свойство("Входящая") И НЕ Подпись.Входящая Тогда
							ЕстьИсходящаяПодпись = Истина;
							Прервать;
						КонецЕсли;
					КонецЦикла;
					
					Если ИнформацияПокупателя.Количество() И ЕстьИсходящаяПодпись Тогда
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись);
						Если Не ИнформацияПокупателя.Свойство("ФИОКладовщикаПолучателя") Тогда
							Если ИнформацияПокупателя.Свойство("ДолжностьРуководителяПолучателя") Тогда
								ИнформацияПокупателя.Вставить("ДолжностьКладовщикаПолучателя", ИнформацияПокупателя.ДолжностьРуководителяПолучателя);
							КонецЕсли;
							Если ИнформацияПокупателя.Свойство("ФИОРуководителяПолучателя") Тогда
								ИнформацияПокупателя.Вставить("ФИОКладовщикаПолучателя", ИнформацияПокупателя.ФИОРуководителяПолучателя);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавца(ТабличныйДокумент, ДанныеЭДДляПечати, ИнформацияПокупателя, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
					
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				
			Иначе
				
				ЭтоДокументПередачи = (ВРег(СтрокаОбъекта.ОписаниеОбъекта) = ВРег("ПередачаТоваров"));
				ДанныеПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ДанныеПокупателя, ЭтоДокументПередачи);
				КонецЕсли;
					
				Если ЭтоДокументПередачи Тогда
					ДанныеЭДДляПечати = ДанныеДляПечатиПередачаТоваров(СтрокаОбъекта, ДеревоРазбора);
					
				Иначе
					ДанныеЭДДляПечати = ПолучитьДанныеНакладнойДляПечати(СтрокаОбъекта, ДеревоРазбора);
					
				КонецЕсли;
				
				Если Подписан Тогда
					
					ЕстьИсходящаяПодпись = Ложь;
					Для Каждого Подпись Из СтруктураПодписей.Подписи Цикл
						Если Подпись.Свойство("Входящая") И НЕ Подпись.Входящая Тогда
							ЕстьИсходящаяПодпись = Истина;
							Прервать;
						КонецЕсли;
					КонецЦикла;
					
					Если ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОРуководителя) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					Если ДанныеЭДДляПечати.Свойство("ДанныеОПередаче") Тогда
						ДанныеЭДДляПечати.ДанныеОПередаче.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
						Если ДанныеЭДДляПечати.ДанныеОПередаче.Свойство("ФИОКладовщика") 
							И ЗначениеЗаполнено(ДанныеЭДДляПечати.ДанныеОПередаче.ФИОКладовщика) Тогда
							ДанныеЭДДляПечати.ДанныеОПередаче.Вставить("ЭлектроннаяПодписьКладовщик", ТекстЭлектроннаяПодпись);
						КонецЕсли;
					КонецЕсли;
										
					Если ДанныеПокупателя.Количество() И ЕстьИсходящаяПодпись Тогда
						ДанныеПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
						Если ДанныеПокупателя.Свойство("ГрузПринялФИО")
							И ЗначениеЗаполнено(ДанныеПокупателя.ГрузПринялФИО) Тогда
							ДанныеПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись)
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
					
				Если ЭтоДокументПередачи Тогда
					ЗаполнитьТабличныйДокументПередачаТоваров(ТабличныйДокумент, ДанныеЭДДляПечати, ДанныеПокупателя, ПараметрыПечати);
				Иначе
					ЗаполнитьТабличныйДокументТОРГ12_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ДанныеПокупателя, ПараметрыПечати);
				КонецЕсли;
			
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД Тогда
				
				ИнформацияПокупателя = ДанныеИнформацииПокупателя(СтрокаОбъекта.ЗначениеРеквизита);
				Если Подписан Тогда
					ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = ПараметрыПечати.СвойстваДокументаПервогоТитула;
				ИнформацияПокупателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
				ИнформацияПокупателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				
				ЗаполнитьТабличныйДокумент_ИнформацияПокупателя(ТабличныйДокумент, ИнформацияПокупателя);
				
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				
			Иначе
				ДанныеПокупателя = ДанныеВторогоТитула(СтрокаОбъекта, ДеревоРазбора);
				Если Подписан Тогда
					ДанныеПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
					Если ДанныеПокупателя.Свойство("ГрузПолучилФИО")
						И ЗначениеЗаполнено(ДанныеПокупателя.ГрузПолучилФИО) Тогда
						ДанныеПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = Неопределено;
				Если ПараметрыПечати.Свойство("СвойстваДокументаПервогоТитула", СвойстваДокументаПервогоТитула)
					И Не СвойстваДокументаПервогоТитула = Неопределено Тогда
					
					ДанныеПокупателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
					ДанныеПокупателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				КонецЕсли;
				
				ЗаполнитьТабличныйДокумент_ТОРГ12Покупателя(ТабличныйДокумент, ДанныеПокупателя);
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД Тогда
			
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаУКДДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				ИнформацияПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеИнформацииПокупателяУКД(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя);
				КонецЕсли;
				
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					Если ИнформацияПокупателя.Количество() Тогда
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавцаУКД(ТабличныйДокумент, ДанныеЭДДляПечати, ИнформацияПокупателя, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
			Иначе
				
				ДанныеПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий, 
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ДанныеПокупателя);
				КонецЕсли;
				
				ДанныеЭДДляПечати = ПолучитьДанныеКорректировочногоДокументаДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				Если Подписан Тогда
					ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					Если ДанныеПокупателя.Количество() Тогда
						ДанныеПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументКорректировочныйДокумент_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ДанныеПокупателя, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД Тогда
				ИнформацияПокупателя = ДанныеИнформацииПокупателяУКД(СтрокаОбъекта.ЗначениеРеквизита);
				Если Подписан Тогда
					ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = ПараметрыПечати.СвойстваДокументаПервогоТитула;
				ИнформацияПокупателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
				ИнформацияПокупателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				
				ЗаполнитьТабличныйДокумент_ИнформацияПокупателяУКД(ТабличныйДокумент, ИнформацияПокупателя);
				
			Иначе
				ДанныеПолучателя = ДанныеСоглашенияПолучатель(СтрокаОбъекта, ДеревоРазбора);
				
				Если Подписан Тогда
					ДанныеПолучателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = Неопределено;
				Если ПараметрыПечати.Свойство("СвойстваДокументаПервогоТитула", СвойстваДокументаПервогоТитула)
					И Не СвойстваДокументаПервогоТитула = Неопределено Тогда
					ДанныеПолучателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
					ДанныеПолучателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				КонецЕсли;
				ЗаполнитьТабличныйДокумент_СоглашениеПолучателя(ТабличныйДокумент, ДанныеПолучателя, ПараметрыПечати);
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
			
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				ИнформацияПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеИнформацииПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя);
				КонецЕсли;
				
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодписьКладовщик", ТекстЭлектроннаяПодпись);
					Если Не ДанныеЭДДляПечати.ПодвалНакладной.Свойство("ФИОКладовщика") Тогда
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ДолжностьКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ДолжностьРуководителя);
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ФИОКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ФИОРуководителя);
					КонецЕсли;
					Если ИнформацияПокупателя.Количество() Тогда
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись);
						Если Не ИнформацияПокупателя.Свойство("ФИОКладовщикаПолучателя") Тогда
							Если ИнформацияПокупателя.Свойство("ДолжностьРуководителяПолучателя") Тогда
								ИнформацияПокупателя.Вставить("ДолжностьКладовщикаПолучателя", ИнформацияПокупателя.ДолжностьРуководителяПолучателя);
							КонецЕсли;
							Если ИнформацияПокупателя.Свойство("ФИОРуководителяПолучателя") Тогда
								ИнформацияПокупателя.Вставить("ФИОКладовщикаПолучателя", ИнформацияПокупателя.ФИОРуководителяПолучателя);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавца(ТабличныйДокумент, ДанныеЭДДляПечати, ИнформацияПокупателя, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
					
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				
			Иначе
				ДанныеЗаказчика = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеЗаказчика(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ДанныеЗаказчика);
				КонецЕсли;
				
				Если ВРег(СтрокаОбъекта.ОписаниеОбъекта) = ВРег("ПередачаРезультатовРабот") Тогда
					ДанныеЭДДляПечати = ДанныеДляПечатиПередачаРезультатовРабот(СтрокаОбъекта, ДеревоРазбора);
					
				Иначе
					ДанныеЭДДляПечати = ПолучитьДанныеАкта501ДляПечати(СтрокаОбъекта, ДеревоРазбора);
					
				КонецЕсли;
				
				Если Подписан Тогда
					ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
						ДанныеЗаказчика.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументАкт501(ТабличныйДокумент, ДанныеЭДДляПечати, ДанныеЗаказчика, ПараметрыПечати);
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.АктЗаказчик Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД Тогда
				
				ИнформацияПокупателя = ДанныеИнформацииПокупателя(СтрокаОбъекта.ЗначениеРеквизита);
				Если Подписан Тогда
					ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = ПараметрыПечати.СвойстваДокументаПервогоТитула;
				ИнформацияПокупателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
				ИнформацияПокупателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				
				ЗаполнитьТабличныйДокумент_ИнформацияПокупателя(ТабличныйДокумент, ИнформацияПокупателя);
				
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				
			Иначе
				ДанныеЗаказчика = ДанныеАктаЗаказчика(СтрокаОбъекта, ДеревоРазбора);
				Если Подписан Тогда
					ДанныеЗаказчика.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = Неопределено;
				Если ПараметрыПечати.Свойство("СвойстваДокументаПервогоТитула", СвойстваДокументаПервогоТитула) 
					И Не СвойстваДокументаПервогоТитула = Неопределено Тогда
					ДанныеЗаказчика.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
					ДанныеЗаказчика.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				КонецЕсли;
				ЗаполнитьТабличныйДокумент_АктЗаказчик(ТабличныйДокумент, ДанныеЗаказчика);
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав Тогда
			
			Если СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
			
				ДанныеЭДДляПечати = ПолучитьДанныеИнформацияПродавцаДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				ИнформацияПокупателя = Новый Структура;
				Если ЗначениеЗаполнено(ИмяФайлаПодчиненногоЭД) Тогда
					НаправлениеЭДПокупателя = ?(НаправлениеЭД = Перечисления.НаправленияЭД.Входящий,
						Перечисления.НаправленияЭД.Исходящий, Перечисления.НаправленияЭД.Входящий);
					ЗаполнитьДанныеИнформацииПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя);
				КонецЕсли;
				
				Если Подписан Тогда
					// Если подписант ИП, то выведем информацию о нем в отдельной строке.
					Если ДанныеЭДДляПечати.Подвал.Свойство("ФИОПБОЮЛ") И ЗначениеЗаполнено(ДанныеЭДДляПечати.Подвал.ФИОПБОЮЛ) Тогда
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодписьИП", ТекстЭлектроннаяПодпись);
					Иначе
						ДанныеЭДДляПечати.Подвал.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ЭлектроннаяПодписьКладовщик", ТекстЭлектроннаяПодпись);
					Если Не ДанныеЭДДляПечати.ПодвалНакладной.Свойство("ФИОКладовщика") Тогда
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ДолжностьКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ДолжностьРуководителя);
						ДанныеЭДДляПечати.ПодвалНакладной.Вставить("ФИОКладовщика", ДанныеЭДДляПечати.ПодвалНакладной.ФИОРуководителя);
					КонецЕсли;
					Если ИнформацияПокупателя.Количество() Тогда
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
						ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьКладовщикПолучателя", ТекстЭлектроннаяПодпись);
						Если Не ИнформацияПокупателя.Свойство("ФИОКладовщикаПолучателя") Тогда
							Если ИнформацияПокупателя.Свойство("ДолжностьРуководителяПолучателя") Тогда
								ИнформацияПокупателя.Вставить("ДолжностьКладовщикаПолучателя", ИнформацияПокупателя.ДолжностьРуководителяПолучателя);
							КонецЕсли;
							Если ИнформацияПокупателя.Свойство("ФИОРуководителяПолучателя") Тогда
								ИнформацияПокупателя.Вставить("ФИОКладовщикаПолучателя", ИнформацияПокупателя.ФИОРуководителяПолучателя);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументИнформацияПродавца(ТабличныйДокумент, ДанныеЭДДляПечати, ИнформацияПокупателя, ПараметрыПечати);
				ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
					
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД Тогда
				
				ИнформацияПокупателя = ДанныеИнформацииПокупателя(СтрокаОбъекта.ЗначениеРеквизита);
				Если Подписан Тогда
					ИнформацияПокупателя.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
				КонецЕсли;
				
				СвойстваДокументаПервогоТитула = ПараметрыПечати.СвойстваДокументаПервогоТитула;
				ИнформацияПокупателя.Вставить("НомерДокументаОтправителя", СвойстваДокументаПервогоТитула.НомерДокументаОтправителя);
				ИнформацияПокупателя.Вставить("ДатаДокументаОтправителя", СвойстваДокументаПервогоТитула.ДатаДокументаОтправителя);
				
				ЗаполнитьТабличныйДокумент_ИнформацияПокупателя(ТабличныйДокумент, ИнформацияПокупателя);
				
			ИначеЕсли СтрокаОбъекта.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				
			Иначе
				ДанныеЭДДляПечати = ПолучитьДанныеАктаНаПередачуПравДляПечати(СтрокаОбъекта, ДеревоРазбора);
				
				Если Подписан Тогда
					ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
					Если ЗначениеЗаполнено(СтруктураПодписей) И СтруктураПодписей.Подписи.Количество() > 1 Тогда
						ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодписьПолучателя", ТекстЭлектроннаяПодпись);
					КонецЕсли;
					
					// Проверка второй подписи.
					Если ПараметрыПечати.Свойство("СтруктураПодписей") И ЗначениеЗаполнено(ПараметрыПечати.СтруктураПодписей)
						И ПараметрыПечати.СтруктураПодписей.Свойство("Подписи")
						И (ТипЗнч(ПараметрыПечати.СтруктураПодписей.Подписи) = Тип("ТаблицаЗначений")
							ИЛИ ТипЗнч(ПараметрыПечати.СтруктураПодписей.Подписи) = Тип("Массив"))
						И ПараметрыПечати.СтруктураПодписей.Подписи.Количество() > 1 Тогда
						
						ХранилищеДанныхСертификата = ПараметрыПечати.СтруктураПодписей.Подписи[1].Сертификат;
						ДвоичныеДанныеСертификата = ХранилищеДанныхСертификата.Получить();
						Если ЗначениеЗаполнено(ДвоичныеДанныеСертификата) Тогда
						
							Сертификат = Новый СертификатКриптографии(ДвоичныеДанныеСертификата);
							СвойстваВладельца = СвойстваВладельцаСертификата(Сертификат);
							ДанныеЭДДляПечати.Шапка.Вставить("ДолжностьПолучателя", СвойстваВладельца.Должность);
							ДанныеЭДДляПечати.Шапка.Вставить("ФИОПолучателя",
								?(ЗначениеЗаполнено(СвойстваВладельца.Фамилия), СвойстваВладельца.Фамилия
									+ ?(ЗначениеЗаполнено(СвойстваВладельца.Имя), " " + ВРег(Лев(СвойстваВладельца.Имя, 1)) + "."
										+ ?(ЗначениеЗаполнено(СвойстваВладельца.Отчество), " " + ВРег(Лев(СвойстваВладельца.Отчество, 1) + "."), ""), ""), ""));
							ДанныеЭДДляПечати.Шапка.Вставить("ДатаПодписанияПолучателя", ПараметрыПечати.СтруктураПодписей.Подписи[1].ДатаПодписи);
						КонецЕсли;
					КонецЕсли;
					
				КонецЕсли;
				
				ЗаполнитьТабличныйДокументАктНаПередачуПрав(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			КонецЕсли;
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.СчетНаОплату Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеСчетаЗаказаДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ДанныеЭДДляПечати.Шапка.Вставить("ЭлектроннаяПодпись", ТекстЭлектроннаяПодпись);
			ЗаполнитьТабличныйДокументСчетЗаказ_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ОтветНаЗаказ Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеСчетаЗаказаДляПечати(СтрокаОбъекта, ДеревоРазбора, "Заказ");
			ЗаполнитьТабличныйДокументСчетЗаказ_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати, "Заказ");
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ЗаказТовара Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеЗаказаПоставщикуДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументЗаказПоставщику_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ПрайсЛист Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеПрайсЛистаДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументПрайсЛист_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.КаталогТоваров Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеКаталогаТоваровДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументКаталогаТоваров_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.АктВыполненныхРабот Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеАктовВыполненныхРаботДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументАктВыполненныхРабот_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеОтчетаОПродажахКомиссионногоТовараДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументОтчетаОПродажахКомиссионногоТовара_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеОтчетаОСписанииКомиссионногоТовараДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументОтчетОСписанииКомиссионногоТовара_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати, ПараметрыПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.Подтверждение Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеПодтвержденияДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументПодтверждение(ТабличныйДокумент, ДанныеЭДДляПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеИзвещенияДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументИзвещение(ТабличныйДокумент, ДанныеЭДДляПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеУточненияДляПечати(СтрокаОбъекта, ДеревоРазбора, ИД);
			ЗаполнитьТабличныйДокументУточнение(ТабличныйДокумент, ДанныеЭДДляПечати);
			
		ИначеЕсли СтрокаОбъекта.ВидЭД = Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
			
			ДанныеЭДДляПечати = ПолучитьДанныеПредложенияОбАннулированииДляПечати(СтрокаОбъекта, ДеревоРазбора, ИД);
			ЗаполнитьТабличныйДокументПредложениеОбАннулировании(ТабличныйДокумент, ДанныеЭДДляПечати);
		
		ИначеЕсли ВРег(СтрокаОбъекта.ВидЭД) = ВРег("РеквизитыОрганизации") Тогда 
			
			ДанныеЭДДляПечати = ПолучитьРеквизитыОрганизацииДляПечати(СтрокаОбъекта, ДеревоРазбора);
			ЗаполнитьТабличныйДокументРеквизитыОрганизации_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати);
		
		КонецЕсли;
		
		ОбластьЯчеек = ТабличныйДокумент.Область(1, 1, 1);
		ОбластьЯчеек.СоздатьФорматСтрок();
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ОбщийТабДок, ТабличныйДокумент, "");
		
		ОбщийТабДок.ОриентацияСтраницы = ТабличныйДокумент.ОриентацияСтраницы;
		ОбщийТабДок.АвтоМасштаб = Истина;
		ОбщийТабДок.ОтображатьЗаголовки = Ложь;
		ОбщийТабДок.ОтображатьСетку = Ложь;
		ОбщийТабДок.ТолькоПросмотр = Истина;
		
		СкрыватьИдентификаторДокумента = ЗначениеПараметра(ПараметрыПечати, "СкрыватьИдентификаторДокумента", Ложь);
		Если СкрыватьИдентификаторДокумента Тогда
			ИменаОбластей = "ИдентификаторДокумента, ОбластьДД, ОбластьДДСЭП, ОбластьДДБезЭП, ОбластьДДСЭП_УС, ОбластьДДСЭП_У, ОбластьДДСЭП_С";
			ЭлектронноеВзаимодействиеСлужебный.СкрытьОбластиТабличногоДокумента(ОбщийТабДок, ИменаОбластей,
				ТипСмещенияТабличногоДокумента.БезСмещения);
			ИменаОбластей = "ДопДанныеШапки_Шапка";
			ЭлектронноеВзаимодействиеСлужебный.СкрытьОбластиТабличногоДокумента(ОбщийТабДок, ИменаОбластей,
				ТипСмещенияТабличногоДокумента.ПоВертикали);
		КонецЕсли;
		
		СкрыватьКопияВерна = ЗначениеПараметра(ПараметрыПечати, "СкрыватьКопияВерна", Ложь);
		Если Не СкрыватьКопияВерна Тогда
			ТабличныйДокументКопияВерна = ПолучитьОбщийМакет(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ИдентификаторДокумента_%1",
				ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка())).ПолучитьОбласть("КопияВерна");
			ТабличныйДокументКопияВерна.Параметры.ДатаПечати = Формат(ТекущаяДатаСеанса(), "ДЛФ=DD");
			
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ОбщийТабДок, ТабличныйДокументКопияВерна,
				"КопияВерна");
		КонецЕсли;
		
		Возврат ОбщийТабДок;
		
	Исключение
		
		ШаблонСообщения = НСтр("ru = 'Ошибка формирования табличного документа:
		|%1.'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			НСтр("ru = 'формирования табличного документа'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
			ТекстСообщения);
		
		Возврат Неопределено;
		
	КонецПопытки;
	
КонецФункции

// Получает значение реквизита шапки электронного документа по его имени из строки разобранных данных.
//
// Параметры:
//  СтрокаДерева - СтрокаДереваЗначений - параметры разбора электронного документа.
//  ИмяРеквизита - Строка - имя реквизита, значение которого надо получить.
//  ДеревоРазбора - ДеревоЗначений - полная структура с данными разбора электронного документа.
//
// Возвращаемое значение:
//  Произвольный - значение реквизита шапки электронного документа.
//
Функция ПолучитьРеквизитШапкиЭД(СтрокаДерева, ИмяРеквизита, ДеревоРазбора = Неопределено) Экспорт
	
	Результат = Неопределено;
	
	Если СтрокаДерева.Строки.Количество() > 0 Тогда
		НайденнаяСтрока = СтрокаДерева.Строки.Найти(ИмяРеквизита, "Реквизит");
	Иначе
		НайденнаяСтрока = СтрокаДерева;
	КонецЕсли;
	
	Если НайденнаяСтрока <> Неопределено Тогда
		Если ЗначениеЗаполнено(НайденнаяСтрока.СсылкаНаОбъект) Тогда // вернем ссылку
			Результат = НайденнаяСтрока.СсылкаНаОбъект;
		Иначе
			Результат = НайденнаяСтрока.ЗначениеРеквизита;
			// Если реквизит ссылочного типа (передали реквизит ДеревоРазбора),
			// тогда нашли всего лишь индекс строки.
			Если ЗначениеЗаполнено(ДеревоРазбора) Тогда
				НайденнаяСтрока = ДеревоРазбора.Строки.Найти(Результат, "ИндексСтроки", Истина);
				Если НайденнаяСтрока <> Неопределено Тогда
					Результат = НайденнаяСтрока.СсылкаНаОбъект;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Возвращает маркер.
//
// Параметры:
//  СтруктураПараметровЗапросаМаркера - Структура - содержит параметры запроса маркера.
//  Соединение - HTTPСоединение - соединение с сервисом.
//  ИнтернетПоддержкаПользователейПодключена - Булево - определяет, подключен ли сервис ИПП.
//  ДополнительныеПараметры - Структура - содержит дополнительные параметры получения маркера:
//                                         * Расшифровывать - Булево - указание, производить ли расшифровку маркера;
//                                                                     используется если расшифровка будет производиться на клиенте;
//                                         * ПоказыватьОшибки - Булево - определяет, показывать ли пользователю ошибку при их возникновении;
//                                         * ПоказыватьОшибкуАутентификацииПриОтсутствииДанных - Булево - определяет, показывать ли ошибку аутентификации
//                                                                                                        в случае, если не указан логин и пароль.
//
// Возвращаемое значение:
//  ДвоичныеДанные - двоичные данные маркера.
//
Функция ПолучитьМаркерОЭДО(СтруктураПараметровЗапросаМаркера, Соединение, ИнтернетПоддержкаПользователейПодключена = Истина, ДополнительныеПараметры = Неопределено) Экспорт
	
	ПараметрыОбработки = Новый Структура("Расшифровывать, ПоказыватьОшибки, ПоказыватьОшибкуАутентификацииПриОтсутствииДанных", Истина, Ложь, Истина);
	
	Если ДополнительныеПараметры <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(ПараметрыОбработки, ДополнительныеПараметры);
	КонецЕсли;
	
	Маркер = Неопределено;
	СертификатПодписи = Неопределено;
	СтруктураПараметровЗапросаМаркера.Свойство("СертификатПодписи", СертификатПодписи);
	Если НЕ ПараметрыОбработки.Расшифровывать ИЛИ ЗначениеЗаполнено(СертификатПодписи) Тогда
		ПарольКСертификату = Неопределено;
		СтруктураПараметровЗапросаМаркера.Свойство("ПарольПользователя", ПарольКСертификату);
		Если ПарольКСертификату <> Неопределено ИЛИ НЕ ПараметрыОбработки.Расшифровывать Тогда
			
			// Аутентификация на сайте 1С Логин для сервиса 1С ЭДО.
			ИдентификаторОрганизации = Неопределено;
			СпособОбменаЭД = Неопределено;
			ПолученныйБилет = Неопределено;
			ИнтернетПоддержкаПользователейПодключена = Истина;
			
			СтруктураПараметровЗапросаМаркера.Свойство("СпособОбменаЭД", СпособОбменаЭД);
			Если ЗначениеЗаполнено(СпособОбменаЭД) Тогда
				Если СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезСервис1СЭДО Тогда
					
					ПолученныйБилет = ОбменСКонтрагентамиСлужебный.БилетНаСайтПоддержки(ИнтернетПоддержкаПользователейПодключена,
						ПараметрыОбработки.ПоказыватьОшибки, ПараметрыОбработки.ПоказыватьОшибкуАутентификацииПриОтсутствииДанных);
					Если Не ЗначениеЗаполнено(ПолученныйБилет) Тогда
						Возврат Неопределено;
					КонецЕсли;
					СтруктураПараметровЗапросаМаркера.Свойство("ИдентификаторОрганизации", ИдентификаторОрганизации);
					
					// Если доступа к ВебСервису нет, то работу с ним прекращаем.
					Если Не ОбменСКонтрагентамиСлужебный.ЕстьДоступКВебСервису1CЭДО(Истина) Тогда
						Возврат Неопределено;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			АдресРесурса = "CertificateLogin";
			АдресРесурса = ?(ПолученныйБилет = Неопределено, АдресРесурса, АдресРесурса + "?ticket=" + ПолученныйБилет);
			АдресРесурса = ?(ИдентификаторОрганизации = Неопределено, АдресРесурса, АдресРесурса + "&edxClientId=" + ИдентификаторОрганизации);
			
			ДанныеСертификата = Неопределено;
			Если НЕ СтруктураПараметровЗапросаМаркера.Свойство("ДанныеСертификата", ДанныеСертификата) Тогда
				ДанныеСертификата = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СертификатПодписи, "ДанныеСертификата");
			КонецЕсли;
			Если ЗначениеЗаполнено(ДанныеСертификата) Тогда
				ИмяФайлаРезультата = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("txt");
				ФайлДДСертификата = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("cer");
				Если ТипЗнч(ДанныеСертификата) = Тип("ДвоичныеДанные") Тогда
					ДвоичныеДанныеСертификата = ДанныеСертификата;
				Иначе
					ДвоичныеДанныеСертификата = ДанныеСертификата.Получить();
				КонецЕсли;
				ДвоичныеДанныеСертификата.Записать(ФайлДДСертификата);
				
				Заголовки = "";
				ДобавитьПараметрВЗаголовок(Заголовки, "Integrator-Id", ИдентификаторИнтеграционногоРешения());
				
				Попытка
					Соединение.ОтправитьДляОбработки(ФайлДДСертификата, АдресРесурса, ИмяФайлаРезультата, Заголовки);
				Исключение
					ФайлРезультата = Новый ТекстовыйДокумент;
					ФайлРезультата.Прочитать(ИмяФайлаРезультата, КодировкаТекста.UTF8);
					Результат = ФайлРезультата.ПолучитьТекст();
					
					ТекстЗаголовкаСообщения = НСтр("ru = 'Ошибка аутентификации в сервисе 1С-ЭДО'");
					Если СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском Тогда
						ТекстЗаголовкаСообщения = НСтр("ru = 'Ошибка аутентификации в сервисе 1С-Такском'");
					КонецЕсли;
					
					ТекстСообщения = "";
					Если ЗначениеЗаполнено(Результат) Тогда
						Результат = СтрЗаменить(Результат, """", "");
						Результат = СтрЗаменить(Результат, ":", ",");
						МассивПараметровОшибки = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(Результат, ",");
						Если МассивПараметровОшибки.Количество() >= 7 Тогда
							
							ШаблонОшибки = НСтр("ru = '%1: %2.'");
							ТекстОшибкиОператора = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки,
								МассивПараметровОшибки[7], МассивПараметровОшибки[1]);
							
							КодОшибки = МассивПараметровОшибки[5];
							
							ТекстОшибки = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ПолучитьСообщениеОбОшибке(
								КодОшибки, ТекстОшибкиОператора);
							
							ТекстСообщения = ТекстЗаголовкаСообщения + Символы.ПС + ТекстОшибки;
						КонецЕсли;
						
					КонецЕсли;
					
					Если Не ЗначениеЗаполнено(ТекстСообщения) Тогда
						ИнформацияОбОшибке = ИнформацияОбОшибке();
						Результат = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
						ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке);
					КонецЕсли;
					
					ТекстСообщения = ОбменСКонтрагентамиСлужебный.ТекстОшибкиОбращенияКСервису(ТекстСообщения);
					ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ТекстЗаголовкаСообщения,
						Результат,
						ТекстСообщения);
					
					ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
					ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ФайлДДСертификата);
					Возврат Неопределено;
				КонецПопытки;
				
				Если ПараметрыОбработки.Расшифровывать Тогда
					Программа = Неопределено;
					СтруктураПараметровЗапросаМаркера.Свойство("Программа", Программа);
					Маркер = РасшифроватьМаркер(ИмяФайлаРезультата, ПарольКСертификату, Программа);
					СтруктураПараметровЗапросаМаркера.Вставить("МаркерРасшифрованный", Маркер);
				Иначе
					Маркер = Новый ДвоичныеДанные(ИмяФайлаРезультата);
					СтруктураПараметровЗапросаМаркера.Вставить("МаркерЗашифрованный", Маркер);
				КонецЕсли;
				
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ФайлДДСертификата);
			Иначе
				ПодробноеПредставлениеОшибки = НСтр("ru = 'Не удалось получить данные сертификата криптографии %1.'");
				ПодробноеПредставлениеОшибки = СтрЗаменить(ПодробноеПредставлениеОшибки, "%1", СертификатПодписи);
				ТекстСообщения = НСтр("ru = 'Ошибка аутентификации в сервисе ЭДО.'");
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
															НСтр("ru = 'Аутентификация в сервисе ЭДО'"),
															ПодробноеПредставлениеОшибки,
															ТекстСообщения);
			КонецЕсли;
		КонецЕсли;
	Иначе
		ТекстСообщения = НСтр("ru = 'Не указан сертификат аутентификации в сервисе ЭДО.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Возврат Маркер;
	
КонецФункции

// Получение объекта соединение.
//
// Параметры:
//  СпособОбменаЭД - ПеречислениеСсылка.СпособыОбменаЭД - способ обмена.
// 
// Возвращаемое значение:
//  HTTPСоединение - HTTP соединение.
//
Функция ПолучитьСоединение(СпособОбменаЭД) Экспорт
	
	Адрес = "";
	ЗащищенноеСоединение = Ложь;
	Протокол = "";
	
	Если СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском Тогда
		НастройкиСервисаЭДО = СтруктураНастроекТакском();
	
	ИначеЕсли СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезСервис1СЭДО Тогда
		НастройкиСервисаЭДО = СтруктураНастроек1СЭДО();
	
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ОпределитьПараметрыСайта(
		НастройкиСервисаЭДО.АдресВебСервиса, ЗащищенноеСоединение, Адрес, Протокол);
	Прокси = ЭлектронноеВзаимодействиеСлужебный.СформироватьПрокси(Протокол);
	Таймаут = 30;
	Соединение = Новый HTTPСоединение(Адрес, , , , Прокси, Таймаут, ЗащищенноеСоединение);
	
	Возврат Соединение;
	
КонецФункции

// Функция - Результат операции ЭДОПолучить
//
// Параметры:
//  РасшифрованныйМаркер - строка - расшифрованный маркет полученный от сервера ЭДО.
//  СпособОбмена		 - перечисленияСсылка.СпособыОбменаЭД - способ обмена (ЭДО или Такском).
//  АдресРесурса		 - строка - адрес вызываемого метода.
//  ВидОперации			 - строка - представление выполняемой операции.
// 
// Возвращаемое значение:
//  ОбъектXDTO - объект XDTO, полученный чтением xml полученного с сервера.
//
Функция РезультатОперацииЭДОПолучить(РасшифрованныйМаркер, СпособОбмена, АдресРесурса, ВидОперации) Экспорт
	
	Результат = Неопределено;
	
	Маркер = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.СтрокаИзДвоичныхДанных(РасшифрованныйМаркер);
	
	Заголовки = Новый Соответствие;
	Заголовки.Вставить("Assistant-Key", Маркер);
	
	Запрос = Новый HTTPЗапрос(АдресРесурса, Заголовки);
	Соединение = ПолучитьСоединение(СпособОбмена);
	
	ВидОперации = НСтр("ru = 'Получение информации о свойствах подписки ЭДО'");
	ИмяФайлаРезультата = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
	ПодробноеПредставлениеОшибки = "";
	КраткоеПредставлениеОшибки   = "";

	Попытка
		Ответ = Соединение.Получить(Запрос, ИмяФайлаРезультата);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
		КраткоеПредставлениеОшибки   = КраткоеПредставлениеОшибки(ИнформацияОбОшибке);
	КонецПопытки;
	
	Если Не ЗначениеЗаполнено(ПодробноеПредставлениеОшибки) И Не Ответ.КодСостояния = 200 Тогда
		ТекстОшибкиПоУмолчанию = НСтр("ru = 'От сервиса получен ответ %1'");
		ТекстОшибкиПоУмолчанию = СтрШаблон(ТекстОшибкиПоУмолчанию, Ответ.КодСостояния);
		Ошибка = ПрочитатьОписаниеОшибкиОператораЭДОИзФайла(ИмяФайлаРезультата, ТекстОшибкиПоУмолчанию);
		
		КраткоеПредставлениеОшибки   = Ошибка.Детали;
		ПодробноеПредставлениеОшибки = Ошибка.Текст;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ПодробноеПредставлениеОшибки) Тогда
		ТекстСообщения = НСтр("ru = 'Не удалось получить подписки на уведомления по причине:'") + Символы.ПС + КраткоеПредставлениеОшибки;
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ПодробноеПредставлениеОшибки, ТекстСообщения);
	Иначе
		ЧтениеXML = Новый ЧтениеXML;
		
		Попытка
			
			ЧтениеXML.ОткрытьФайл(ИмяФайлаРезультата);
			Результат = ФабрикаXDTO.ПрочитатьXML(ЧтениеXML);
			
		Исключение
			ИнформацияОбОшибке = ИнформацияОбОшибке();
			ТекстСообщения = НСтр("ru = 'Не удалось прочитать ответ от сервиса по причине:'") + Символы.ПС + 
				КраткоеПредставлениеОшибки(ИнформацияОбОшибке);
			ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ВидОперации, ПодробноеПредставлениеОшибки, ТекстСообщения);
		КонецПопытки;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
		
	Возврат Результат;
	
КонецФункции

// Получает данные электронного документа из файла, заполняет дерево значений для загрузки в ИБ,
// создает/изменяет необходимые объекты ИБ.
// 
// Параметры:
//  СтруктураПараметров - Структура - структура параметров для разбора электронного документа.
//
// Возвращаемое значение:
//  Структура - структура параметров с реквизитами созданных/измененных объектов ИБ.
//
Функция ПолучитьДанныеИзФайла(СтруктураПараметров) Экспорт
	
	ДеревоРазбора = ЭлектронноеВзаимодействиеСлужебный.ИнициализироватьДеревоРазбора();
	
	Если НЕ СтруктураПараметров.Свойство("ФайлДанныхСсылка") Тогда
		Возврат СтруктураПараметров;
	КонецЕсли;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ОбменСКонтрагентами");
	НовыйЭД = НайденныйТипВДереве.Строки.Добавить();
	
	Если НЕ (СтруктураПараметров.Свойство("НаправлениеЭД", НовыйЭД.НаправлениеЭД)
			И ЗначениеЗаполнено(НовыйЭД.НаправлениеЭД)) Тогда
		НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий;
	КонецЕсли;
	
	ФайлДопДанныхСсылка = "";
	ДеревоДопДанных = Неопределено;
	Если СтруктураПараметров.Свойство("ФайлДопДанных", ФайлДопДанныхСсылка) И ЗначениеЗаполнено(ФайлДопДанныхСсылка) Тогда
		ВремФайл = ПолучитьИмяВременногоФайла("xml");
		ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(ФайлДопДанныхСсылка);
		ДвоичныеДанныеФайла.Записать(ВремФайл);
		ДеревоДопДанных = РазобратьУниверсальныйДопФайл(ВремФайл);
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
		СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	ОшибкаЗаписи = Ложь;
	ВремФайл = ПолучитьИмяВременногоФайла("xml");
	ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(СтруктураПараметров.ФайлДанныхСсылка);
	ДвоичныеДанныеФайла.Записать(ВремФайл);
	
	ОшибкаЧтенияЭД = Ложь;
	ПрочитатьФайлCMLпоXDTO(ВремФайл, ДеревоРазбора, НовыйЭД, ОшибкаЧтенияЭД);
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
	
	Если Не ОшибкаЧтенияЭД Тогда
		
		ИдентификаторыДокументовОснований = Новый Массив;
		
		// Дозаполняем структуру параметров из файла данных.
		ДополнительныеРеквизиты = Новый Структура;
		Если (НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура
				ИЛИ НовыйЭД.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура)
			И (НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД
				ИЛИ НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД
				ИЛИ НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД
				ИЛИ НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД)
			
			ИЛИ (НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
					ИЛИ НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель
					ИЛИ НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав)
				И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД
				
			ИЛИ (НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель
				И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД) Тогда
				
			ДеревоДанных = НовыйЭД.ЗначениеРеквизита;
			
			// Получим идентификаторы документов оснований из дополнительных данных.
			СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
			Если СтрокаДопДанных <> Неопределено Тогда
				Если СтрокаДопДанных.Строки.Найти("ДопДанныеСчетаФактуры.ТекстоваяИнформация", "ПолныйПуть") <> Неопределено Тогда
					ТаблицаДопДанных = ЭлектронноеВзаимодействие.ДанныеДерева(СтрокаДопДанных, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
					Для Каждого Строка Из ТаблицаДопДанных Цикл
						Если Строка.Идентификатор = "ИдентификаторДокументаОснования" Тогда
							ИдентификаторыДокументовОснований.Добавить(Строка.Значение);
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
			
			НомерДокументаОтправителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, "НомерДокумента");
			НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления", Ложь);
			Если ЗначениеЗаполнено(НомерИсправления) Тогда
				ШаблонНомера = НСтр("ru = '%1 (испр. %2)'");
				НомерДокументаОтправителя = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
											ШаблонНомера, НомерДокументаОтправителя, НомерИсправления);
			КонецЕсли;
			ДатаДокументаОтправителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, "ДатаДокумента");
				
			НаименованиеДокументаОтправителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, "НаименованиеДокументаОтправителя", Ложь);
				
			СуммаДокумента = 0;
			СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
			Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
				СуммаТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
				Если Не ЗначениеЗаполнено(СуммаТовара) Тогда
					СуммаТовараБезНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
						Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
					Если СуммаТовараБезНалога = Неопределено Тогда
						СуммаТовараБезНалога = 0;
					КонецЕсли;
					СуммаНалогаПоТовару = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
						Товар, "СведенияОТоварах.НомерСтроки.СуммаНалога");
					Если СуммаНалогаПоТовару = Неопределено Тогда
						СуммаНалогаПоТовару = 0;
					КонецЕсли;
					СуммаТовара = СуммаТовараБезНалога + СуммаНалогаПоТовару;
				КонецЕсли;
				СуммаДокумента = СуммаДокумента + СуммаТовара
			КонецЦикла;
		Иначе
			НомерДокументаОтправителя = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Номер");
			НомерИсправления = ПолучитьРеквизитШапкиЭД(НовыйЭД, "НомерИсправления");
			Если Не ЗначениеЗаполнено(НомерИсправления) И ЗначениеЗаполнено(НовыйЭД.ЗначениеРеквизита) Тогда
				НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					НовыйЭД.ЗначениеРеквизита, "НомерИсправления", Ложь);
			КонецЕсли;
			Если ЗначениеЗаполнено(НомерИсправления) Тогда
				ШаблонНомера = НСтр("ru = '%1 (испр. %2)'");
				НомерДокументаОтправителя = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
											ШаблонНомера, НомерДокументаОтправителя, НомерИсправления);
			КонецЕсли;
			ДатаДокументаОтправителя = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Дата");
			
			НаименованиеДокументаОтправителя = Неопределено;
			Если ТипЗнч(НовыйЭД.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
				НаименованиеДокументаОтправителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					НовыйЭД.ЗначениеРеквизита, "НаименованиеДокументаОтправителя", Ложь);
			КонецЕсли;
			
			СуммаДокумента = ПолучитьРеквизитШапкиЭД(НовыйЭД, "СуммаДокумента");
			Если Не ЗначениеЗаполнено(СуммаДокумента) Тогда
				СуммаДокумента = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Сумма");
			КонецЕсли;
			
			ОрганизацияПолучатель = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Организация", ДеревоРазбора);
			Контрагент = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Контрагент", ДеревоРазбора);
			
			Если НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура
				Или НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
				Или НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель Тогда
				
				ИдентификаторДокументаОснования = ПолучитьРеквизитШапкиЭД(НовыйЭД, "ИдентификаторДокументаОснования", ДеревоРазбора);
			КонецЕсли;
			
			ПространствоИмен = ПолучитьРеквизитШапкиЭД(НовыйЭД, "ПространствоИмен", ДеревоРазбора);
			Если ЗначениеЗаполнено(ПространствоИмен) Тогда
				ДополнительныеРеквизиты.Вставить("ПространствоИмен", ПространствоИмен);
			КонецЕсли;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(НаименованиеДокументаОтправителя) Тогда
			НаименованиеДокументаОтправителя = НовыйЭД.ТипЭлементаВерсииЭД;
		КонецЕсли;
	
		СтруктураПараметров.Вставить("ВидЭД",      НовыйЭД.ВидЭД);
		НомерЭД = НовыйЭД.ИД;
		Если Не ЗначениеЗаполнено(НомерЭД) Тогда
			УИД = Новый УникальныйИдентификатор;
			НомерЭД = Строка(УИД) + "##1";
		КонецЕсли;
		СтруктураПараметров.Вставить("НомерЭД", НомерЭД);
		НомерВерсииЭД = ВернутьНомерВерсииИзИдЭД(НовыйЭД.ИД);
		ОписаниеТипа = Новый ОписаниеТипов("Число");
		НомерВерсииЭД = ОписаниеТипа.ПривестиЗначение(НомерВерсииЭД);
		СтруктураПараметров.Вставить("НомерВерсииЭД", НомерВерсииЭД);
		СтруктураПараметров.Вставить("НаправлениеЭД", НовыйЭД.НаправлениеЭД);
		СтруктураПараметров.Вставить("Загружен",      НЕ ОшибкаЗаписи);
		
		СтруктураПараметров.Вставить("НомерДокументаОтправителя", 			НомерДокументаОтправителя);
		СтруктураПараметров.Вставить("ДатаДокументаОтправителя",  			ДатаДокументаОтправителя);
		СтруктураПараметров.Вставить("НаименованиеДокументаОтправителя",  	НаименованиеДокументаОтправителя);
		Если ЗначениеЗаполнено(ОрганизацияПолучатель) Тогда
			СтруктураПараметров.Вставить("Организация", ОрганизацияПолучатель);
		КонецЕсли;
		СтруктураПараметров.Вставить("Контрагент",                      Контрагент);
		СтруктураПараметров.Вставить("СуммаДокумента",                  СуммаДокумента);
		СтруктураПараметров.Вставить("ИдентификаторДокументаОснования", ИдентификаторДокументаОснования);
		СтруктураПараметров.Вставить("ДополнительныеРеквизиты",         ДополнительныеРеквизиты);
		СтруктураПараметров.Вставить("ИдентификаторыОснованийУПД",      ИдентификаторыДокументовОснований);
		
	КонецЕсли;
	СтруктураПараметров.Вставить("Загружен", НЕ ОшибкаЗаписи);
	
	Возврат СтруктураПараметров;
	
КонецФункции

// Сохранение данных объекта.
//
// Параметры:
//  СтруктураПараметров	 - Структура - параметры сохранения.
//  СпособОбработки		 - Строка - способ обработки электронного документа.
// 
// Возвращаемое значение:
//  ДокументСсылка - документ учета.
//
Функция СохранитьДанныеОбъекта(СтруктураПараметров, СпособОбработки = "") Экспорт 
	
	ДеревоРазбора = ЭлектронноеВзаимодействиеСлужебный.ИнициализироватьДеревоРазбора();
	
	Если НЕ СтруктураПараметров.Свойство("ФайлДанныхСсылка") Тогда
		Возврат СтруктураПараметров;
	КонецЕсли;
	
	Если СтруктураПараметров.Свойство("ДокументыУчета") Тогда
		
		ДокументыУчета = СтруктураПараметров.ДокументыУчета;
	Иначе
		ДокументыУчета = Неопределено;
	КонецЕсли;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ОбменСКонтрагентами");
	НовыйЭД = НайденныйТипВДереве.Строки.Добавить();
	
	Если НЕ (СтруктураПараметров.Свойство("НаправлениеЭД", НовыйЭД.НаправлениеЭД)
		И ЗначениеЗаполнено(НовыйЭД.НаправлениеЭД)) Тогда
		НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий;
	КонецЕсли;
	
	ФайлДопДанныхСсылка = "";
	ДеревоДопДанных = Неопределено;
	Если СтруктураПараметров.Свойство("ФайлДопДанных", ФайлДопДанныхСсылка) И ЗначениеЗаполнено(ФайлДопДанныхСсылка) Тогда
		ВремФайл = ПолучитьИмяВременногоФайла("xml");
		ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(ФайлДопДанныхСсылка);
		ДвоичныеДанныеФайла.Записать(ВремФайл);
		ДеревоДопДанных = РазобратьУниверсальныйДопФайл(ВремФайл);
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
		СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	ОшибкаЗаписи = Ложь;
	ВремФайл = ПолучитьИмяВременногоФайла("xml");
	ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(СтруктураПараметров.ФайлДанныхСсылка);
	ДвоичныеДанныеФайла.Записать(ВремФайл);
	
	ОшибкаЧтенияЭД = Ложь;
	ПрочитатьФайлCMLпоXDTO(ВремФайл, ДеревоРазбора, НовыйЭД, ОшибкаЧтенияЭД);
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
	
	Если Не ОшибкаЧтенияЭД Тогда
		
		// Заполним ссылки на объекты из дерева соответствий, если ссылок нет,
		// тогда будем создавать объекты.
		Если Не ЗначениеЗаполнено(ДокументыУчета) Или СтруктураПараметров.Свойство("ЗаполнитьДокумент") Тогда
			
			ЗаполнитьДокументыУчета = Истина;
			
			ДокументУчета = Неопределено;
			Если ЗначениеЗаполнено(ДокументыУчета) Тогда
				ДокументУчета = ДокументыУчета[0];
			КонецЕсли;
			
			НачатьТранзакцию();
			
			Попытка
				Если ВРег(НовыйЭД.ОписаниеОбъекта) = ВРег("ПередачаТоваров") Тогда
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьДокументПередачаТоваров(НовыйЭД.ЗначениеРеквизита, ДокументУчета, , СпособОбработки);
					
				ИначеЕсли ВРег(НовыйЭД.ОписаниеОбъекта) = ВРег("ПередачаРезультатовРабот") Тогда
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьДокументПередачаРезультатовРабот(НовыйЭД.ЗначениеРеквизита, ДокументУчета, , СпособОбработки);
					
				ИначеЕсли НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура
					И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД Тогда
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУниверсальныйПередаточныйДокумент(НовыйЭД.ЗначениеРеквизита, ДокументыУчета, , СпособОбработки);
					ЗаполнитьДокументыУчета = Ложь;
					
				ИначеЕсли НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура
					И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД Тогда
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУПДСчетФактуру(НовыйЭД.ЗначениеРеквизита, ДокументУчета, , СпособОбработки);
					
				ИначеЕсли НовыйЭД.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура
					И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД Тогда
					
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУниверсальныйКорректировочныйДокумент(НовыйЭД.ЗначениеРеквизита, ДокументыУчета, , СпособОбработки);
					ЗаполнитьДокументыУчета = Ложь;
					
				ИначеЕсли НовыйЭД.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура
					И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД Тогда
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУКДСчетФактуру(НовыйЭД.ЗначениеРеквизита, ДокументУчета, , СпособОбработки);
					
				ИначеЕсли (НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
					ИЛИ НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель
					ИЛИ НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав)
					И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУПДДокументОПередаче(НовыйЭД.ЗначениеРеквизита, ДокументУчета, , СпособОбработки);
					
				ИначеЕсли НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель
					И НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД Тогда
					
					ОбменСКонтрагентамиПереопределяемый.НайтиСоздатьУКДДокументОбИзмененииСтоимости(НовыйЭД.ЗначениеРеквизита, ДокументУчета, , СпособОбработки);
					
				Иначе
		
					ЗаполнитьСсылкиНаОбъектыВДереве(ДеревоРазбора, ОшибкаЗаписи);
				 
					ОбменСКонтрагентамиПереопределяемый.СохранитьДанныеОбъектаВБД(НовыйЭД, ДеревоРазбора,
						ДокументУчета, , СпособОбработки, ДокументУчета);
					
					Если НЕ ЗначениеЗаполнено(ДокументУчета) Тогда
						ЗаполнитьДокументыУчета = Ложь;
					КонецЕсли;
				КонецЕсли;
				
				ЗафиксироватьТранзакцию();
				
			Исключение
				
				ОтменитьТранзакцию();
				
				ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Заполнение документа на основе ЭД.'"),
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
					ТекстСообщения);
				ОшибкаЗаписи = Истина;
				ЗаполнитьДокументыУчета = Ложь;
				
				ВызватьИсключение;
				
			КонецПопытки;
			
			Если ЗаполнитьДокументыУчета Тогда
				ДокументыУчета = Новый Массив;
				ДокументыУчета.Добавить(ДокументУчета);
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(ДокументыУчета) Тогда
				ТекстСообщения = НСтр("ru = 'Не удалось создать документ базы данных.'");
				АктуальныеВидыЭД = ОбменСКонтрагентамиПовтИсп.ПолучитьАктуальныеВидыЭД();
				Если АктуальныеВидыЭД.Найти(НовыйЭД.ВидЭД) = Неопределено Тогда
					ШаблонСообщения = НСтр("ru = 'Электронный документ вида ""%1"" в текущей конфигурации не поддерживается'");
					ТекстЖурналаРегистрации = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, НовыйЭД.ВидЭД);
				Иначе
					ТекстЖурналаРегистрации = НСтр("ru = 'Необходимо проверить работу процедуры
						|ОбменСКонтрагентамиПереопределяемый.СохранитьДанныеОбъектаВБД'");
				КонецЕсли;
				ВидОперации = НСтр("ru = 'Заполнение документа на основе ЭД.'");
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
					ВидОперации, ТекстЖурналаРегистрации, ТекстСообщения);
					ОшибкаЗаписи = Истина;
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат ДокументыУчета;
	
КонецФункции

// Возвращает дерево с данными файла.
//
// Параметры:
//  ПолноеИмяФайла - Строка - Строка, путь к файлу.
//  НаправлениеЭД - ПеречислениеСсылка.НаправленияЭД - направление электронного документа.
//  ФайлДопДанных - Строка - путь к файлу с дополнительными данными.
//  ФайлКартинок - Строка - путь к файлу - архиву, содержащему картинки.
//
// Возвращаемое значение:
//  Структура - данные дерева.
//
Функция СформироватьДеревоРазбора(ПолноеИмяФайла, НаправлениеЭД = Неопределено, ФайлДопДанных = Неопределено, ФайлКартинок = Неопределено) Экспорт
	
	ДеревоРазбора = ЭлектронноеВзаимодействиеСлужебный.ИнициализироватьДеревоРазбора();
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ОбменСКонтрагентами");
	НовыйЭД = НайденныйТипВДереве.Строки.Добавить();
	
	Если НаправлениеЭД = Неопределено Тогда
		НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий;
	Иначе 
		НовыйЭД.НаправлениеЭД = НаправлениеЭД;
	КонецЕсли;
	
	Если ФайлДопДанных <> Неопределено Тогда
		ДеревоДопДанных = РазобратьУниверсальныйДопФайл(ФайлДопДанных);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Если ФайлКартинок <> Неопределено Тогда
		ДеревоКартинок = ДеревоКартинок(ФайлКартинок);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоКартинок", ДеревоКартинок);
	КонецЕсли;
	
	ОшибкаЧтенияЭД = Ложь;
	ПрочитатьФайлCMLпоXDTO(ПолноеИмяФайла, ДеревоРазбора, НовыйЭД, ОшибкаЧтенияЭД);
	
	Если ОшибкаЧтенияЭД Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат Новый Структура("ДеревоРазбора, СтрокаОбъекта", ДеревоРазбора, НовыйЭД);
	
КонецФункции

// Устанавливает состояние ЭД в "Обмен завершен с исправлением"
//
Процедура УстановитьСостояниеОбменЗавершенСИсправлением(ИзменяемыеДокументы,
	ВыполняетсяОбновлениеИнформационнойБазы = Ложь) Экспорт
	
	Если ИзменяемыеДокументы.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Состояние = Перечисления.СостоянияВерсийЭД.ОбменЗавершенСИсправлением;
	
	Исключения = Новый Массив;
	
	Исключения.Добавить(Перечисления.СостоянияВерсийЭД.ОжидаетсяОтправкаПолучателю);
	Исключения.Добавить(Перечисления.СостоянияВерсийЭД.ОжидаетсяИзвещениеОПолучении);
	Исключения.Добавить(Перечисления.СостоянияВерсийЭД.ОжидаетсяПодтверждение);
	Исключения.Добавить(Перечисления.СостоянияВерсийЭД.ОбменЗавершен);
	
	Исключения.Добавить(Перечисления.СостоянияВерсийЭД.ОжидаетсяИсправление);
	Исключения.Добавить(Перечисления.СостоянияВерсийЭД.ТребуетсяУточнитьДокумент);
	Исключения.Добавить(Перечисления.СостоянияВерсийЭД.Отклонен);
	
	ОбменСКонтрагентамиСлужебный.ИзменитьСостояниеЭД(ИзменяемыеДокументы, Состояние, Исключения,
		ВыполняетсяОбновлениеИнформационнойБазы);
	
КонецПроцедуры

Процедура ЗаполнитьСсылкиНаОбъектыВДереве(ДеревоРазбора, Ошибка) Экспорт
	
	ОтборБезСсылокНаОбъекты = Новый Структура;
	ОтборБезСсылокНаОбъекты.Вставить("СсылкаНаОбъект", Неопределено);
	ПорядокСозданияТиповОбъектов = Новый ТаблицаЗначений;
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьТаблицуПорядкаСозданияТиповОбъектов(ПорядокСозданияТиповОбъектов);
	Для Каждого СтрокаТипОбъекта Из ПорядокСозданияТиповОбъектов Цикл
		НайденнаяСтрокаТипа = ДеревоРазбора.Строки.Найти(СтрокаТипОбъекта.ТипОбъекта, "ТипОбъекта");
		Если НайденнаяСтрокаТипа = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		// Всегда будет перезаполнять Номенклатуру поставщика
		Если СтрокаТипОбъекта.ТипОбъекта = "НоменклатураПоставщиков" Тогда
			Для Каждого СтрокаОбъекта Из НайденнаяСтрокаТипа.Строки Цикл
				СсылкаНаОбъект = Неопределено;
				ОбменСКонтрагентамиПереопределяемый.СоздатьОбъектВБД(СтрокаОбъекта, ДеревоРазбора, СсылкаНаОбъект);
				Если ЗначениеЗаполнено(СсылкаНаОбъект) Тогда
					СтрокаОбъекта.СсылкаНаОбъект = СсылкаНаОбъект;
				Иначе
					Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Ошибка создания элемента справочника ""%1""'"), СтрокаТипОбъекта.ТипОбъекта);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					Ошибка = Истина;
					Возврат;
				КонецЕсли;
			КонецЦикла;
		Иначе
			СтрокиБезСсылокНаОбъекты = НайденнаяСтрокаТипа.Строки.НайтиСтроки(ОтборБезСсылокНаОбъекты);
			Для Каждого СтрокаОбъекта Из СтрокиБезСсылокНаОбъекты Цикл
				СсылкаНаОбъект = Неопределено;
				ОбменСКонтрагентамиПереопределяемый.СоздатьОбъектВБД(СтрокаОбъекта, ДеревоРазбора, СсылкаНаОбъект);
				Если ЗначениеЗаполнено(СсылкаНаОбъект) Тогда
					СтрокаОбъекта.СсылкаНаОбъект = СсылкаНаОбъект;
				Иначе
					Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Ошибка создания элемента справочника ""%1""'"), СтрокаТипОбъекта.ТипОбъекта);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Текст);
					Ошибка = Истина;
					Возврат;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Функция определяет документы-основания для ВладелецФайла по идентификаторам документов ИБ.
//
// Параметры:
//   МассивИД                  - Массив - содержит строки идентификаторов документов-оснований (из базы отправителя).
//   СтруктураПараметровПоиска - Структура - дополнительные отборы для оптимизации запроса:
//      Ключ     - Строка - Наименование отбора, совпадает с именем реквизита справочника ЭДПрисоединенныеФайлы.
//      Значение - Произвольный - отбираемое значение реквизита ЭД.
//
// Возвращаемое значение:
//   ТаблицаЗначений - содержит 2 колонки:
//      Ссылка  - ДокументСсылка - ссылка на документ-основание.
//      НомерЭД - Строка - идентификатор документа-основания.
//
Функция ТаблицаЗначенийДокументовОснованийПоИдентификаторам(МассивИД, СтруктураПараметровПоиска) Экспорт
	
	Запрос = Новый Запрос;
	
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЭДПрисоединенныеФайлы.ВладелецФайла КАК Ссылка,
		|	ЭДПрисоединенныеФайлы.НомерЭД
		|ПОМЕСТИТЬ вт_ЭД
		|ИЗ
		|	Справочник.ЭДПрисоединенныеФайлы КАК ЭДПрисоединенныеФайлы";
		
	Если МассивИД.Количество() = 1 Тогда
		ТекстЗапроса = ТекстЗапроса + " Где (ЭДПрисоединенныеФайлы.НомерЭД = &ИДОснованийВладельца)";
		Запрос.УстановитьПараметр("ИДОснованийВладельца", МассивИД[0]);
	Иначе
		ТекстЗапроса = ТекстЗапроса + " Где (ЭДПрисоединенныеФайлы.НомерЭД В (&ИДОснованийВладельца))";
		Запрос.УстановитьПараметр("ИДОснованийВладельца", МассивИД);
	КонецЕсли;
	
	НаправлениеЭД = Неопределено;
	Для Каждого ЭлементСтруктуры Из СтруктураПараметровПоиска Цикл
		ИмяРеквизита = ЭлементСтруктуры.Ключ;
		Если ВРег(ИмяРеквизита) = ВРег("НаправлениеЭД") Тогда
			НаправлениеЭД = ЭлементСтруктуры.Значение;
			Если НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
				ТекстЗапроса = ТекстЗапроса + " И ЭДПрисоединенныеФайлы.ВладелецФайла Ссылка Документ.ЭлектронныйДокументВходящий";
			Иначе
				ТекстЗапроса = ТекстЗапроса + " И ЭДПрисоединенныеФайлы.ВладелецФайла Ссылка Документ.ЭлектронныйДокументИсходящий";
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Если НаправлениеЭД = Неопределено Тогда
		
		Запрос.Текст = ТекстЗапроса
		+ ТекстРазделитель()
		+ ТекстЗапросаВходящийДокумент()
		+ "
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|"
		+ ТекстЗапросаДокументИсходящий();
		
	Иначе
		
		Если НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			
			Запрос.Текст = ТекстЗапроса
			+ ТекстРазделитель()
			+ ТекстЗапросаВходящийДокумент();
			
		Иначе
			
			Запрос.Текст = ТекстЗапроса
			+ ТекстРазделитель()
			+ ТекстЗапросаДокументИсходящий();
			
		КонецЕсли;
		
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	ТЗ = Запрос.Выполнить().Выгрузить();
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат ТЗ;
	
КонецФункции

Функция ТипДокументаПоСтроке(ТипДокумента) Экспорт
	
	ФорматированнаяСтрока = НРег(СокрЛП(ТипДокумента));
	Если ФорматированнаяСтрока = "account" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.СчетНаОплату;
	ИначеЕсли ФорматированнаяСтрока = "statement" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.АктВыполненныхРабот;
	ИначеЕсли ФорматированнаяСтрока = "consignment" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.ТоварнаяНакладная;
	ИначеЕсли ФорматированнаяСтрока = "paymentorder" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.ПлатежноеПоручение;
	ИначеЕсли ФорматированнаяСтрока = "contract" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.Договор;
	ИначеЕсли ФорматированнаяСтрока = "statementappendix" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.ПриложениеКАкту;
	ИначеЕсли ФорматированнаяСтрока = "guaranteeletter" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.ГарантийноеПисьмо;
	ИначеЕсли ФорматированнаяСтрока = "other" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.Прочее;
	ИначеЕсли ФорматированнаяСтрока = "reconciliationstatement" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.АктСверки;
	ИначеЕсли ФорматированнаяСтрока = "offsettingstatement" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.АктВзаимозачета;
	ИначеЕсли ФорматированнаяСтрока = "ks11" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.КС11;
	ИначеЕсли ФорматированнаяСтрока = "ks2" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.КС2;
	ИначеЕсли ФорматированнаяСтрока = "ks3" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.КС3;
	ИначеЕсли ФорматированнаяСтрока = "report" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.Отчет;
	ИначеЕсли ФорматированнаяСтрока = "notification" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.Уведомление;
	ИначеЕсли ФорматированнаяСтрока = "edoagreement" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.СоглашениеОбЭДО;
	ИначеЕсли ФорматированнаяСтрока = "specification" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.Спецификация;
	ИначеЕсли ФорматированнаяСтрока = "additionalagreement" Тогда
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.ДополнительноеСоглашение;
	ИначеЕсли ФорматированнаяСтрока = "formalizedstatementcustomer"
		ИЛИ ФорматированнаяСтрока = "formalizedstatementvendor"
		ИЛИ ФорматированнаяСтрока = "formalizedconsignmentcustomer"
		ИЛИ ФорматированнаяСтрока = "formalizedconsignmentvendor"
		ИЛИ ФорматированнаяСтрока = "invoice"
		ИЛИ ФорматированнаяСтрока = "correctiveinvoice"
		ИЛИ ФорматированнаяСтрока = "receivenotification"
		ИЛИ ФорматированнаяСтрока = "specificationnotice"
		ИЛИ ФорматированнаяСтрока = "sendingtimeconfirmation"
		ИЛИ ФорматированнаяСтрока = "cancellationoffer"
		ИЛИ ФорматированнаяСтрока = "formalizedworkresultvendor"
		ИЛИ ФорматированнаяСтрока = "formalizedtradingvendor"
		ИЛИ ФорматированнаяСтрока = "formalizedworkresultcustomer"
		ИЛИ ФорматированнаяСтрока = "formalizedtradingcustomer"
		ИЛИ ФорматированнаяСтрока = "expinvoice"
		ИЛИ ФорматированнаяСтрока = "corexpinvoice"
		ИЛИ ФорматированнаяСтрока = "expinvoiceandprimaryaccountingdocumentvendor"
		ИЛИ ФорматированнаяСтрока = "expinvoiceandprimaryaccountingdocumentcustomer"
		ИЛИ ФорматированнаяСтрока = "corexpinvoiceandprimaryaccountingdocumentvendor"
		ИЛИ ФорматированнаяСтрока = "corexpinvoiceandprimaryaccountingdocumentcustomer"
		ИЛИ ФорматированнаяСтрока = "corprimaryaccountingdocumentcustomer"
		ИЛИ ФорматированнаяСтрока = "corprimaryaccountingdocumentvendor"
		ИЛИ ФорматированнаяСтрока = "primaryaccountingdocumentcustomer"
		ИЛИ ФорматированнаяСтрока = "primaryaccountingdocumentvendor"
		ИЛИ ФорматированнаяСтрока = "other" Тогда
		
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.Прочее;
	Иначе
		ЗаписьВЖурнал = НСтр("ru = 'Не задано сопоставление типа документа из карточки пакета ЭД ""%1"",
			|с перечислением конфигурации ""Типы ЭД""'");
		ЗаписьВЖурнал = СтрЗаменить(ЗаписьВЖурнал, "%1", ТипДокумента);
		ВидОперации = НСтр("ru = 'Чтение карточки пакета ЭД'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ЗаписьВЖурнал);
		ВозвращаемоеЗначение = Перечисления.ТипыЭД.Прочее;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Получает ключевые данные файла из заголовка электронного документа с помощью XDTO-пакета.
//
// Параметры:
//  ИмяФайла - Строка - путь к файлу, данные которого надо получить;
//  Структура - Структура параметров с реквизитами электронного документа;
//  ОписаниеОшибки - Строка - подробное описание ошибки.
//
Процедура ПрочитатьШапкуФайлаCMLпоXDTO(ДанныеФайлаЭД, СтруктураПараметров, ОписаниеОшибки) Экспорт
	
	ВидЭД = Неопределено;
	
	Отправитель = Неопределено;
	ДатаФормированияЭДОтправителем = Неопределено;
	ИдЭДВладельца = Неопределено;
	
	Если НЕ ДанныеФайлаЭД.Свойства().Получить("ИД") = Неопределено Тогда
		ИдЭД = ДанныеФайлаЭД.Ид;
	КонецЕсли;
	
	// Блок для форматов ФНС
	Если ДанныеФайлаЭД.Свойства().Получить("ИдФайл") <> Неопределено Тогда
		
		ИдЭД = ДанныеФайлаЭД.ИдФайл;
		Если СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_SCHFDOPPR") > 0 Тогда
			ВидЭД = Перечисления.ВидыЭД.СчетФактура;
			ПризнакПродавца = Истина;
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ДатаИнфПр", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
				+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ВремИнфПр", "Строка"), ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_SCHFDOPPOK") > 0 Тогда
			ВидЭД = Перечисления.ВидыЭД.СчетФактура;
			ПризнакПродавца = Ложь;
			ИдЭДВладельца = Прав(СокрП(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ИнфПок.ИдИнфПрод.ИдФайлИнфПр", "Строка")), 36);
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ИнфПок.ДатаИнфПок", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ИнфПок.ВремИнфПок", "Строка"), ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_KORSCHFDOPPR") > 0 Тогда
			ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура;
			ПризнакПродавца = Истина;
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ДатаИнфПр", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
				+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ВремИнфПр", "Строка"), ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_KORSCHFDOPPOK") > 0 Тогда
			ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура;
			ПризнакПродавца = Ложь;
			ИдЭДВладельца = Прав(СокрП(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ИнфПок.ИдИнфПрод.ИдФайлИнфПр", "Строка")), 36);
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ИнфПок.ДатаИнфПок", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ИнфПок.ВремИнфПок", "Строка"), ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_SFAKT") > 0 Тогда
			ВидЭД = Перечисления.ВидыЭД.СчетФактура;
			ПризнакПродавца = Истина;
			
			ДатаДок = ДатаИзИДФайла(ИдЭД, "ON_SFAKT");
			Если НЕ ЗначениеЗаполнено(ДатаДок) Тогда
				ДатаДокТекст = ДанныеФайлаЭД.Документ.СвСчФакт.ДатаСчФ;
				Если ЗначениеЗаполнено(ДатаДокТекст) Тогда
					ДатаДок = ДатаИзСтроки(ДатаДокТекст);
				КонецЕсли;
			КонецЕсли;
			Если ЗначениеЗаполнено(ДатаДок) Тогда
				ДатаФормированияЭДОтправителем = ДатаДок;
			КонецЕсли;

		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_KORSFAKT") > 0 Тогда // корректировочный счет-фактура
			ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура;
			ПризнакПродавца = Истина;
			
			ДатаДок = ДатаИзИДФайла(ИдЭД, "ON_KORSFAKT");
			Если НЕ ЗначениеЗаполнено(ДатаДок) Тогда
				ДатаДокТекст = ДанныеФайлаЭД.Документ.СвКСчФ.ДатаКСчФ;
				Если ЗначениеЗаполнено(ДатаДокТекст) Тогда
					ДатаДок = ДатаИзСтроки(ДатаДокТекст);
				КонецЕсли;
			КонецЕсли;
			Если ЗначениеЗаполнено(ДатаДок) Тогда
				ДатаФормированияЭДОтправителем = ДатаДок;
			КонецЕсли;
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "OKORDOC") > 0 Тогда // корректировочный торг-12 титул продавца
			ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель;
			ПризнакПродавца = Истина;
			ДатаДок = ДанныеФайлаЭД.Документ.ДатаДок;
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ДанныеФайлаЭД.Документ.ВремДок, ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "OTORG12") > 0 Тогда // торг-12 титул продавца
			ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец;
			ПризнакПродавца = Истина;
			ДатаДок = ДанныеФайлаЭД.Документ.ДатаДок;
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ДанныеФайлаЭД.Документ.ВремДок, ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "PTORG12") > 0 Тогда // торг-12 титул покупателя
			ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель;
			ПризнакПродавца = Ложь;
			ИдЭДВладельца = Прав(СокрП(ДанныеФайлаЭД.Документ.ИдТНО.ИдФайлТН), 36);
			ДатаДок = ДанныеФайлаЭД.Документ.ДатаДок;
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ДанныеФайлаЭД.Документ.ВремДок, ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "PKORDOC") > 0 Тогда // корректировочный торг-12 титул покупателя
			ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель;
			ПризнакПродавца = Ложь;
			ИдЭДВладельца = Прав(СокрП(ДанныеФайлаЭД.Документ.ИдТНО.ИдФайлТН), 36);
			ДатаДок = ДанныеФайлаЭД.Документ.ДатаДок;
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ДанныеФайлаЭД.Документ.ВремДок, ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "IAKTPRM") > 0 Тогда // Акт титул исполнителя
			ПространствоИмен = ПространствоИменАкта(ДанныеФайлаЭД, "IAKTPRM");
			АктВНовомФормате = (ПространствоИмен = "IAKTPRM2");
			
			ВидЭД = Перечисления.ВидыЭД.АктИсполнитель;
			ПризнакПродавца = Истина;
			ДатаДок = ДанныеФайлаЭД.Документ.ДатаДок;
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ ?(АктВНовомФормате, "", СтрЗаменить(ДанныеФайлаЭД.Документ.ВремДок, ".", "")));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ZAKTPRM") > 0 Тогда // Акт титул заказчика
			ПространствоИмен = ПространствоИменАкта(ДанныеФайлаЭД, "ZAKTPRM");
			АктВНовомФормате = (ПространствоИмен = "ZAKTPRM2");
			
			ВидЭД = Перечисления.ВидыЭД.АктЗаказчик;
			ПризнакПродавца = Ложь;
			ИдЭДВладельца = Прав(СокрП(ДанныеФайлаЭД.Документ.СвАктИ.ИдАктИ.ИдФайлАктИ), 36);
			ДатаДок = ДанныеФайлаЭД.Документ.ДатаДок;
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ ?(АктВНовомФормате, "", СтрЗаменить(ДанныеФайлаЭД.Документ.ВремДок, ".", "")));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_TOVTORGPR") > 0 Тогда // Передача товаров продавец
			ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец;
			ПризнакПродавца = Истина;
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ДатаИнфПр", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ВремИнфПр", "Строка"), ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_TOVTORGPOK") > 0 Тогда // Передача товаров покупатель
			ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель;
			ПризнакПродавца = Ложь;
			ИдЭДВладельца = Прав(СокрП(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ИдДокПТПр.ИдФайлИнфПр", "Строка")), 36);
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ДатаИнфПок", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
				+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ВремИнфПок", "Строка"), ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_REZRUISP") > 0 Тогда // Передача работ исполнитель
			ВидЭД = Перечисления.ВидыЭД.АктИсполнитель;
			ПризнакПродавца = Истина;
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ДатаИнфИсп", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
			+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ВремИнфИсп", "Строка"), ".", ""));
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_REZRUZAK") > 0 Тогда // Передача работ исполнитель
			ВидЭД = Перечисления.ВидыЭД.АктЗаказчик;
			ПризнакПродавца = Ложь;
			ИдЭДВладельца = Прав(СокрП(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ИдДокПРУИсп.ИдФайлИнфИсп", "Строка")), 36);
			ДатаДок = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ДатаИнфЗак", "Строка");
			ДатаФормированияЭДОтправителем = Дата(Сред(ДатаДок, 7, 4) + Сред(ДатаДок, 4, 2) + Сред(ДатаДок, 1, 2)
				+ СтрЗаменить(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ВремИнфЗак", "Строка"), ".", ""));

		КонецЕсли;
	КонецЕсли;
	
	// Блок для формата 4.02
	Если ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("АктОПриемке", "4.02") Тогда
		
		ВидЭД = Перечисления.ВидыЭД.АктВыполненныхРабот;
		Отправитель = "Продавец";
		ПризнакПродавца = Истина;
		ДатаФормированияЭДОтправителем = ДанныеФайлаЭД.ДатаФормирования;
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ТОРГ12", "4.02") Тогда
		
		ВидЭД = Перечисления.ВидыЭД.ТОРГ12;
		Отправитель = "Продавец";
		ПризнакПродавца = Истина;
		ДатаФормированияЭДОтправителем = ДанныеФайлаЭД.ДатаФормирования;
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("СчетНаОплату", "4.02") Тогда
		
		ВидЭД = Перечисления.ВидыЭД.СчетНаОплату;
		Отправитель = "Продавец";
		ПризнакПродавца = Истина;
		ДатаФормированияЭДОтправителем = ДанныеФайлаЭД.ДатаФормирования;
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ОтчетОСписанииКомиссионногоТовара", "4.02") Тогда
		
		ВидЭД = Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара;
		Отправитель = "Покупатель";
		ПризнакПродавца = Ложь;
		ДатаФормированияЭДОтправителем = ДанныеФайлаЭД.ДатаФормирования;
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ОтчетОПродажахКомиссионногоТовара", "4.02") Тогда
		
		ВидЭД = Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара;
		Отправитель = "Покупатель";
		ПризнакПродавца = Ложь;
		ДатаФормированияЭДОтправителем = ДанныеФайлаЭД.ДатаФормирования;
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ЗаказКлиента", "4.02") Тогда
		Если ДанныеФайлаЭД.Роль = "Продавец" Тогда
			ВидЭД = Перечисления.ВидыЭД.ОтветНаЗаказ;
			Отправитель = "Продавец";
			ПризнакПродавца = Истина;
		ИначеЕсли ДанныеФайлаЭД.Роль = "Покупатель" Тогда	
			ВидЭД = Перечисления.ВидыЭД.ЗаказТовара;
			Отправитель = "Покупатель";
			ПризнакПродавца = Ложь;
		КонецЕсли;
		ДатаФормированияЭДОтправителем = ДанныеФайлаЭД.ДатаФормирования;
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("Каталог", "4.02") Тогда
		ВидЭД = Перечисления.ВидыЭД.КаталогТоваров;
		ДатаДокументаОтправителя  = ДанныеФайлаЭД.ДатаФормирования;
		ПризнакПродавца = Истина;
		ДатаФормированияЭДОтправителем = ДанныеФайлаЭД.ДатаФормирования;
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ПрайсЛист", "4.02") Тогда
		ВидЭД = Перечисления.ВидыЭД.ПрайсЛист;
		ПризнакПродавца = Истина;
	КонецЕсли;
	
	// Блок для формата 2.08
	Если ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Каталог") <> Неопределено Тогда
		
		ИдЭД  = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Каталог.Ид");
		ВидЭД = Перечисления.ВидыЭД.КаталогТоваров;
		ПризнакПродавца = Истина;
		ДатаФормированияЭДОтправителем = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ДатаФормирования");
		
	ИначеЕсли ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ") <> Неопределено Тогда
		
		Если ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ",, Истина).Количество() Тогда
			
			Роль     = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.Роль", "Строка");
			Операция = ВРег(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ.ХозОперация", "Строка"));
			
			Если Операция = ВРег(НСтр("ru = 'Отчет о продажах комиссионного товара'")) Тогда
				
				ВидЭД = Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара;
				Отправитель = "Покупатель";
				ПризнакПродавца = Ложь;
				ДатаФормированияЭДОтправителем = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ДатаФормирования");
				
			ИначеЕсли Операция = ВРег(НСтр("ru = 'Отчет о списании комиссионного товара'")) Тогда
				
				ВидЭД = Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара;
				Отправитель = "Покупатель";
				ПризнакПродавца = Ложь;
				ДатаФормированияЭДОтправителем = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ДатаФормирования");
				
			ИначеЕсли Операция = ВРег(НСтр("ru = 'Счет на оплату'")) Тогда
				
				ВидЭД = Перечисления.ВидыЭД.СчетНаОплату;
				Отправитель = "Продавец";
				ПризнакПродавца = Истина;
				ДатаФормированияЭДОтправителем = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ДатаФормирования");
				
			ИначеЕсли Операция = ВРег(НСтр("ru = 'Заказ товара'")) Тогда
				
				Если Роль = "Продавец" Тогда
					ВидЭД = Перечисления.ВидыЭД.ОтветНаЗаказ;
					Отправитель = "Продавец";
					ПризнакПродавца = Истина;
				ИначеЕсли Роль = "Покупатель" Тогда
					ВидЭД = Перечисления.ВидыЭД.ЗаказТовара;
					Отправитель = "Покупатель";
					ПризнакПродавца = Ложь;
				КонецЕсли;
				ДатаФормированияЭДОтправителем = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ДатаФормирования");
				
			ИначеЕсли Операция = ВРег(НСтр("ru = 'Передача прав'")) Тогда
				
				ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав;
				ДатаФормированияЭДОтправителем = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ДатаФормирования");
			КонецЕсли;
			
		КонецЕсли;
		
	ИначеЕсли ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ПакетПредложений") <> Неопределено Тогда
		
		ВидЭД = Перечисления.ВидыЭД.ПрайсЛист;
		ПризнакПродавца = Истина;
		ДатаДокументаОтправителя = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ПакетПредложений.ДействительноС");
		ДатаФормированияЭДОтправителем = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ДатаФормирования");
		ПризнакПродавца = Истина;
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ВидЭД) Тогда
		ОписаниеОшибки = НСтр("ru = 'Неизвестный тип ЭД при чтении данных.'");
		Возврат;
	Иначе
		АктуальныеВидыЭД = ОбменСКонтрагентамиПовтИсп.ПолучитьАктуальныеВидыЭД();
		Если АктуальныеВидыЭД.Найти(ВидЭД) = Неопределено Тогда
			ОписаниеОшибки = НСтр("ru = 'Документы вида ""%1"" не поддерживаются в текущей конфигурации.'");
			ОписаниеОшибки = СтрШаблон(ОписаниеОшибки, ВидЭД);
		КонецЕсли;
	КонецЕсли;
	
	СтруктураПараметров.Вставить("НомерЭД", ИдЭД);
	СтруктураПараметров.Вставить("ВидЭД",   ВидЭД);
	СтруктураПараметров.Вставить("ПризнакПродавца", ПризнакПродавца);
	СтруктураПараметров.Вставить("ДатаФормированияЭДОтправителем", ДатаФормированияЭДОтправителем);
	СтруктураПараметров.Вставить("ИдЭДВладельца", ИдЭДВладельца);
	СтруктураПараметров.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
	
КонецПроцедуры

Процедура ПрочитатьШапкуСлужебногоФайлаCMLпоXDTO(ИмяФайла, КодРегламента, КодТранзакции, СтруктураФайлаЭД) Экспорт
	
	ОбъектXML = Новый ЧтениеXML;
	ИдЭД                      = Неопределено;
	ВидЭД                     = Неопределено;
	НаправлениеЭД             = Неопределено;
	НомерДокументаОтправителя = Неопределено;
	ДатаДокументаОтправителя  = Неопределено;
	ТипЭлементаВерсииЭД       = Неопределено;
	СтатусЭДВладельца         = Неопределено;
	ТекстСообщения            = Неопределено;
	ОписаниеОшибки            = Неопределено;
	ДополнительныеДанные      = Новый Структура;
	ТекстУточнения            = Неопределено;
	
	СтруктураУчастников = Новый Структура;
	
	Попытка
		ОбъектXML.ОткрытьФайл(ИмяФайла);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
		ОбъектXML.Закрыть();
		
		Если КодТранзакции = "ErrorMessage" Тогда
			ОписаниеОшибки      = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ПолучитьСообщениеОбОшибке(ЭД.КодОшибки, ЭД.Описание);
			ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.Ошибка;
			СтатусЭДВладельца   = Перечисления.СтатусыЭД.ОшибкаПередачи;
		Иначе
			ИдЭД = ЭД.ИдФайл;
			НомерВерсииЭД = 0;
			
			Если КодРегламента = "Nonformalized" ИЛИ КодРегламента = "Formalized" Тогда
				
				Если КодТранзакции = "PostDateConfirmation" Тогда
					ВидЭД               = Перечисления.ВидыЭД.Подтверждение;
					Если ЭД.Документ.КНД = "1115112" Тогда
						ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДП;
					Иначе
						ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДО;
					КонецЕсли;
					СтатусЭДВладельца   = Перечисления.СтатусыЭД.Отправлен;
					ДатаДокументаОтправителя  = Дата(РазобратьСтрокуДаты(ЭД.Документ.СведПодтв.ДатаОтпр)
						+ СтрЗаменить(ЭД.Документ.СведПодтв.ВремяОтпр, ".", ""));
				ИначеЕсли КодТранзакции = "CorrectionNotice"
					ИЛИ КодТранзакции = "MainDocumentReject"
					ИЛИ КодТранзакции = "CancellationOfferReject" Тогда
					ВидЭД               = Перечисления.ВидыЭД.УведомлениеОбУточнении;
					ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.УОУ;
					СтатусЭДВладельца   = Перечисления.СтатусыЭД.ОтклоненПолучателем;
					
					СвойстваСвУведУточ = ЭД.Документ.СвУведУточ.Свойства();
					Если СвойстваСвУведУточ.Получить("ДатаВремяПол") <> Неопределено Тогда
						ДатаДокументаОтправителя = ПолучитьДатуВремяИзСтроки(ЭД.Документ.СвУведУточ.ДатаВремяПол);
					ИначеЕсли СвойстваСвУведУточ.Получить("ДатаПол") <> Неопределено Тогда
						ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СвУведУточ.ДатаПол)
							+ СтрЗаменить(ЭД.Документ.СвУведУточ.ВремяПол, ".", ""));
					КонецЕсли;
					
					ТекстУточнения = "";
					Если СвойстваСвУведУточ.Получить("ТекстУведУточ") <> Неопределено
						И ЭД.Документ.СвУведУточ.ТекстУведУточ <> Неопределено
						И ТипЗнч(ЭД.Документ.СвУведУточ.ТекстУведУточ) = Тип("Строка") Тогда
						
						ТекстУточнения = ЭД.Документ.СвУведУточ.ТекстУведУточ;
					КонецЕсли;
				ИначеЕсли КодТранзакции = "ReceiveNotice" Тогда
					ВидЭД               = Перечисления.ВидыЭД.ИзвещениеОПолучении;
					ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИОП;
					СтатусЭДВладельца   = Перечисления.СтатусыЭД.Доставлен;
					
					СвойстваСвИзвПолуч = ЭД.Документ.СвИзвПолуч.Свойства();
					Если СвойстваСвИзвПолуч.Получить("ДатаВремяПол") <> Неопределено Тогда
						ДатаДокументаОтправителя = ПолучитьДатуВремяИзСтроки(ЭД.Документ.СвИзвПолуч.ДатаВремяПол);
					ИначеЕсли СвойстваСвИзвПолуч.Получить("ДатаПол") <> Неопределено Тогда
						ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СвИзвПолуч.ДатаПол)
							+ СтрЗаменить(ЭД.Документ.СвИзвПолуч.ВремяПол, ".", ""));
					КонецЕсли;
				ИначеЕсли КодТранзакции = "CancellationOffer" Тогда
					ВидЭД               = Перечисления.ВидыЭД.ПредложениеОбАннулировании;
					ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПОА;
					СтатусЭДВладельца   = Перечисления.СтатусыЭД.ПолученоПредложениеОбАннулировании;
					ДатаДокументаОтправителя  = Дата(1, 1, 1);
					ТекстУточнения      = ЭД.Документ.СвПредАн.ТекстПредАн;
					ДополнительныеДанные.Вставить("НаименованиеВладельца", СокрЛП(ЭД.Документ.СвПредАн.СведАнФайл.ИмяАнФайла));
				Иначе
					ТекстСообщения = НСтр("ru = 'Данный вид электронного документа ""%1"" не поддерживается в текущей версии программы.
						|Необходимо обновить конфигурацию до актуальной версии.'");
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, КодТранзакции);
					ТекстОшибки = НСтр("ru = 'При чтении данных из файла ""%1"" возникла ошибка: неизвестный код транзакции ""%2"".'");
					ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстОшибки, ИмяФайла, КодТранзакции);
					ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
						ТекстОшибки, ТекстСообщения);
				КонецЕсли;
			Иначе
				Если КодТранзакции = "PostDateConfirmation" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.Подтверждение;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.ПДПЭСФ;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.Отправлен;
					ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СведПодтв.ДатаОтпр)
						+ СтрЗаменить(ЭД.Документ.СведПодтв.ВремяОтпр, ".", ""));
				ИначеЕсли КодТранзакции = "CustomerInformationPostDateConfirmation" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.Подтверждение;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПУПДУКД;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.Отправлен;
					ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СведПодтв.ДатаОтпр)
						+ СтрЗаменить(ЭД.Документ.СведПодтв.ВремяОтпр, ".", ""));
				ИначеЕсли КодТранзакции = "SendConfirmation" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.Подтверждение;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.ПДОЭСФ;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.Получен;
					ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СведПодтв.ДатаОтпр)
						+ СтрЗаменить(ЭД.Документ.СведПодтв.ВремяОтпр, ".", ""));
				ИначеЕсли КодТранзакции = "ReceiveNoticePostDateConfirmation" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.Подтверждение;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПЭСФ;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.Получен;
					ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СведПодтв.ДатаОтпр)
						+ СтрЗаменить(ЭД.Документ.СведПодтв.ВремяОтпр, ".", ""));
				ИначеЕсли КодТранзакции = "ReceiveNotice" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.ИзвещениеОПолучении;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.ИПЭСФ;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.Доставлен;
					
					СвойстваСвИзвПолуч = ЭД.Документ.СвИзвПолуч.Свойства();
					Если СвойстваСвИзвПолуч.Получить("ДатаВремяПол") <> Неопределено Тогда
						ДатаДокументаОтправителя = ПолучитьДатуВремяИзСтроки(ЭД.Документ.СвИзвПолуч.ДатаВремяПол);
					ИначеЕсли СвойстваСвИзвПолуч.Получить("ДатаПол") <> Неопределено Тогда
						ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СвИзвПолуч.ДатаПол)
							+ СтрЗаменить(ЭД.Документ.СвИзвПолуч.ВремяПол, ".", ""));
					КонецЕсли;
				ИначеЕсли КодТранзакции = "CorrectionNotice" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.УведомлениеОбУточнении;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.УУЭСФ;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.ОтклоненПолучателем;
					ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СвУведУточ.ДатаПол)
						+ СтрЗаменить(ЭД.Документ.СвУведУточ.ВремяПол, ".", ""));
						
					ТекстУточнения = "";
					СвойстваСвУведУточ = ЭД.Документ.СвУведУточ.Свойства();
					Если СвойстваСвУведУточ.Получить("ТекстУведУточ") <> Неопределено
						И ЭД.Документ.СвУведУточ.ТекстУведУточ <> Неопределено
						И ТипЗнч(ЭД.Документ.СвУведУточ.ТекстУведУточ) = Тип("Строка") Тогда
						
						ТекстУточнения = ЭД.Документ.СвУведУточ.ТекстУведУточ;
					КонецЕсли;
				ИначеЕсли КодТранзакции = "CorrectionNoticeReceiveNotice" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.ИзвещениеОПолучении;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.ИПУУЭСФ;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.Отклонен;
					ДатаДокументаОтправителя = Дата(РазобратьСтрокуДаты(ЭД.Документ.СвИзвПолуч.ДатаПол)
						+ СтрЗаменить(ЭД.Документ.СвИзвПолуч.ВремяПол, ".", ""));
				ИначеЕсли КодТранзакции = "CancellationOffer" Тогда
					ВидЭД                    = Перечисления.ВидыЭД.ПредложениеОбАннулировании;
					ТипЭлементаВерсииЭД      = Перечисления.ТипыЭлементовВерсииЭД.ПОА;
					СтатусЭДВладельца        = Перечисления.СтатусыЭД.ПолученоПредложениеОбАннулировании;
					ДатаДокументаОтправителя = Дата(1, 1, 1);
					ТекстУточнения           = ЭД.Документ.СвПредАн.ТекстПредАн;
					ДополнительныеДанные.Вставить("НаименованиеВладельца", СокрЛП(ЭД.Документ.СвПредАн.СведАнФайл.ИмяАнФайла));
				Иначе
					ТекстСообщения = НСтр("ru = 'Данный вид электронного документа ""%1"" не поддерживается в текущей версии программы.
						|Необходимо обновить конфигурацию до актуальной версии.'");
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, КодТранзакции);
					ТекстОшибки = НСтр("ru = 'При чтении данных из файла ""%1"" возникла ошибка: неизвестный код транзакции ""%2"".'");
					ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстОшибки, ИмяФайла, КодТранзакции);
					ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
						ТекстОшибки, ТекстСообщения);
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ТекстСообщения) Тогда
			ВызватьИсключение(ТекстСообщения);
		КонецЕсли;
		
		СтруктураФайлаЭД.НомерЭД                   = ИдЭД;
		СтруктураФайлаЭД.НаправлениеЭД             = НаправлениеЭД;
		СтруктураФайлаЭД.СтатусЭДВладельца         = СтатусЭДВладельца;
		СтруктураФайлаЭД.ТипЭлементаВерсииЭД       = ТипЭлементаВерсииЭД;
		СтруктураФайлаЭД.ОписаниеОшибки            = ОписаниеОшибки;
		СтруктураФайлаЭД.ТекстУточнения            = ТекстУточнения;
		СтруктураФайлаЭД.ДополнительныеДанные      = ДополнительныеДанные;
	Исключение
		ОбъектXML.Закрыть();
		ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из файла %1: %2.'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			ИмяФайла, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
	КонецПопытки;
	
КонецПроцедуры

// Параметры файлов ЭДО.
//
// Параметры:
//  ФайлИнформации	 - Строка - имя файла электронного документа.
//  ФайлКарточки	 - Строка - имя файла карточки.
// 
// Возвращаемое значение:
//  Соответствие - параметры файлов.
//
Функция ПараметрыФайловЭДО(ФайлИнформации, ФайлКарточки) Экспорт
	
	МассивПутейКПодписям = Новый Массив;
	СоответствиеВозврата  = Новый Соответствие;
	КодТранзакции = "";
	КодРегламента = "";
	ТипКарточкиЭД = Перечисления.ТипыЭД.Прочее;
	ТипКарточкиЭДПолучен = Ложь;
	НомерЭДКарточки = Строка(Новый УникальныйИдентификатор);
	НомерЭД = "";
	СтруктураДопДанных = Новый Структура;
	ТребуетсяПодтверждение = Истина;
	ПроизвольныйЭД = Ложь;
	МассивИдентификаторовДокументовОснований = Новый Массив;
	
	ОбъектXML = Новый ЧтениеXML;
	СтруктураЗначений = Новый Структура;
	
	Попытка
		ОбъектXML.ОткрытьФайл(ФайлКарточки.ПолноеИмя);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML,
			ПолучитьТипЗначенияCML("Card", "http://api-invoice.taxcom.ru/card"));
		ОбъектXML.Закрыть();
		НомерЭДКарточки = НомерЭДВКарточкеЭД(ЭД);
		Если ЭД.Description <> Неопределено Тогда
			Если ЭД.Description.AdditionalData <> Неопределено И ЭД.Description.AdditionalData.AdditionalParameter <> Неопределено Тогда
				СтруктураДопПараметров = Новый Структура;
				Для Каждого Свойство Из ЭД.Description.AdditionalData.AdditionalParameter Цикл
					Если Свойство.Name = "ParentDocument" Тогда
						МассивИдентификаторовДокументовОснований.Добавить(Свойство.Value);
					ИначеЕсли Свойство.Name = "DocumentType" Тогда
						// После расширения состава типов документов, типы передаются в доп.данных
						ТипКарточкиЭД = ТипДокументаПоСтроке(Свойство.Value);
						ТипКарточкиЭДПолучен = Истина;
					ИначеЕсли Свойство.Name = "Комментарий" Тогда
						СтруктураДопДанных.Вставить("КомментарийЭД", Свойство.Value);
					Иначе
						СтруктураДопПараметров.Вставить(Свойство.Name, Свойство.Value);
					КонецЕсли;
				КонецЦикла;
				Если СтруктураДопПараметров.Количество() > 0 Тогда
					СтруктураДопДанных.Вставить("ДопПараметры", СтруктураДопПараметров);
				КонецЕсли;
			КонецЕсли;
			// Определим заголовок произвольного ЭД.
			Если ЭД.Description.Свойства().Получить("Title") <> Неопределено Тогда
				Если ЭД.Description.Title <> Неопределено Тогда
					ПроизвольныйЭД = (ЭД.Description.Title = Строка(Перечисления.ВидыЭД.ПроизвольныйЭД));
				КонецЕсли;
			КонецЕсли;
				
			КомментарийЭД = ЭД.Description.Comment;
		КонецЕсли;
		Если ЭД.Type <> Неопределено Тогда
			Если НЕ ТипКарточкиЭДПолучен Тогда
				ТипКарточкиЭД = ТипДокументаПоСтроке(ЭД.Type.Name);
			КонецЕсли;
			Если ЭД.Type.ResignRequired <> Неопределено Тогда
				ТребуетсяПодтверждение = Булево(ЭД.Type.ResignRequired);
			КонецЕсли;
		КонецЕсли;
	Исключение
		ОбъектXML.Закрыть();
		ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из файла %1: %2.'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			ФайлКарточки.ПолноеИмя, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
	КонецПопытки;
	
	Попытка
		ОбъектXML.ОткрытьФайл(ФайлИнформации.ПолноеИмя);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML,
			ПолучитьТипЗначенияCML("ContainerDescription", "http://api-invoice.taxcom.ru/meta"));
		ОбъектXML.Закрыть();
		Для Каждого ДокОборот Из ЭД.DocFlow Цикл
			НомерЭДТИ = ДокОборот.Id;
			Для Каждого Документ Из ДокОборот.Documents.Document Цикл
				
				КодТранзакции = ЗначениеСвойстваXDTO(Документ, "TransactionCode");
				КодРегламента = ЗначениеСвойстваXDTO(Документ, "ReglamentCode");
				
				НомерЭД = ?(СтрНайти(КодТранзакции, "Resign") > 0, НомерЭДКарточки, НомерЭДТИ);
				
				// Определим произвольный документ по типу ЭД в карточке и по коду транзакции в файле информации пакета.
				Если КодТранзакции = "MainDocument" И ПроизвольныйЭД Тогда
					СтруктураДопДанных.Вставить("КомментарийЭД", КомментарийЭД);
				КонецЕсли;
				
				ПутьКДокументу = "";
				ДокументСодержитПодписи = Ложь;
				Если ЕстьСвойствоXDTO(Документ, "Files") Тогда
					Если Документ.Files.MainImage <> Неопределено Тогда
						ПутьКДокументу = ПолучитьИмяФайлаДанных(Документ.Files.MainImage.Path);
					КонецЕсли;
					Если Документ.Files.MainImageSignature <> Неопределено Тогда
						МассивПутейКПодписям = Новый Массив;
						ДокументСодержитПодписи = Истина;
						Для Каждого Подпись Из Документ.Files.MainImageSignature Цикл
							ПредставлениеПодписи = ПолучитьИмяФайлаДанных(Подпись.Path);
							Если НЕ ЗначениеЗаполнено(ПутьКДокументу) Тогда
								// Если MainImage - пустое, значит пришел контейнер с подтверждением (подписью).
								СтруктураВложения = Новый Структура();
								СтруктураВложения.Вставить("Подписи",       МассивПутейКПодписям);
								СтруктураВложения.Вставить("УникальныйИД",  НомерЭД);
								СтруктураВложения.Вставить("НомерЭД",       НомерЭДКарточки);
								СтруктураВложения.Вставить("КодТранзакции", КодТранзакции);
								СтруктураВложения.Вставить("КодРегламента", КодРегламента);
								СтруктураВложения.Вставить("ДопДанные",     СтруктураДопДанных);
								СтруктураВложения.Вставить("НомерЭДТИ",     НомерЭДТИ);
								СтруктураВложения.Вставить("ТипДокумента",  ТипКарточкиЭД);
								СтруктураВложения.Вставить("ПроизвольныйЭД",ПроизвольныйЭД);
								СтруктураВложения.Вставить("ДокументСодержитПодписи", ДокументСодержитПодписи);
								СоответствиеВозврата.Вставить(ПредставлениеПодписи, СтруктураВложения);
							Иначе
								МассивПутейКПодписям.Добавить(ПредставлениеПодписи);
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
					
					Если Документ.Files.DataImage <> Неопределено Тогда
						ПодписиДопДанных = Новый Массив;
						ДокументСодержитПодписи = Истина;
						Если Документ.Files.DataImageSignature <> Неопределено Тогда
							Для Каждого Подпись Из Документ.Files.DataImageSignature Цикл
								ПодписиДопДанных.Добавить(ПолучитьИмяФайлаДанных(Подпись.Path));
							КонецЦикла;
						КонецЕсли;
						СтруктураДопДанных.Вставить("ФайлДопДанных", ПолучитьИмяФайлаДанных(Документ.Files.DataImage.Path));
						СтруктураДопДанных.Вставить("ПодписиДопДанных", ПодписиДопДанных);
					КонецЕсли;
				КонецЕсли;
				Если ЗначениеЗаполнено(ПутьКДокументу) Тогда
					СтруктураВложения = Новый Структура();
					СтруктураВложения.Вставить("Подписи",                МассивПутейКПодписям);
					СтруктураВложения.Вставить("УникальныйИД",           НомерЭД);
					СтруктураВложения.Вставить("НомерЭД",                НомерЭДКарточки);
					СтруктураВложения.Вставить("КодТранзакции",          КодТранзакции);
					СтруктураВложения.Вставить("КодРегламента",          КодРегламента);
					СтруктураВложения.Вставить("ДопДанные",              СтруктураДопДанных);
					СтруктураВложения.Вставить("ТребуетсяПодтверждение", ТребуетсяПодтверждение);
					СтруктураВложения.Вставить("ТипДокумента",           ТипКарточкиЭД);
					СтруктураВложения.Вставить("ПроизвольныйЭД",         ПроизвольныйЭД);
					СтруктураВложения.Вставить("ДокументСодержитПодписи",ДокументСодержитПодписи);
					СтруктураВложения.Вставить("МассивИдентификаторовДокументовОснований", МассивИдентификаторовДокументовОснований);
					СоответствиеВозврата.Вставить(ПутьКДокументу, СтруктураВложения);
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
	Исключение
		ОбъектXML.Закрыть();
		ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из файла %1: %2.'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			ФайлИнформации.ПолноеИмя, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		СоответствиеВозврата.Очистить();
	КонецПопытки;
	
	Возврат СоответствиеВозврата;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Работа с извещением о получении

// Формирует пакет электронных документов.
//
// Параметры:
//  ТекСтрокаПЭД  - ТаблицаЗначений - перечень электронных документов для включения в пакет.
//  АдресЗашифрованныхДанныхНаКлиенте - Строка - адрес временного хранилища зашифрованных данных,
//												если они были зашифрованы на клиенте.
//	ТребуетсяИзвещениеОПолучении - Булево - признак ожидания извещения о получении от принимающей стороны.
// Возвращаемое значение:
//  Булево - Истина - извещение сформировано, иначе Ложь.
//
Функция СформироватьЭДПрисоединенныйФайлПакетаОператораЭДО(Конверт, АдресЗашифрованныхДанныхНаКлиенте = Неопределено,
	ТребуетсяИзвещениеОПолучении = Истина) Экспорт
	
	КонтейнерСформирован = Ложь;
	
	ПодготовленныеДокументы = Конверт.ЭлектронныеДокументы.ВыгрузитьКолонку("ЭлектронныйДокумент");
	Если ПодготовленныеДокументы.Количество() = 1 Тогда
		
		Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог("send", ПодготовленныеДокументы[0].УникальныйИдентификатор());
		
		Для Каждого ДокументНаОтправку Из ПодготовленныеДокументы Цикл
			
			// Сохраняем основной файл и дополнительный файл с подписями.
			СтруктураФайловЭД = Новый Структура;
			СтруктураФайловЭД.Вставить("ГлавныйФайл");
			СтруктураФайловЭД.Вставить("ДополнительныйФайл");
			
			// Создадим таблицу подписей для загрузки в дерево транспортной информации такском
			ТаблицаПодписей = Новый ТаблицаЗначений;
			ТаблицаПодписей.Колонки.Добавить("Имя");
			ТаблицаПодписей.Колонки.Добавить("Путь");
			
			СтруктураФайловЭД.Вставить("ГлавныйФайлПодписи", ТаблицаПодписей);
			СтруктураФайловЭД.Вставить("ДополнительныйФайлПодписи", ТаблицаПодписей);
			
			ДанныеФайла = ОбменСКонтрагентамиСлужебный.ПолучитьДанныеФайла(ДокументНаОтправку);
			
			// Шифрование ЭД
			Если Конверт.ДанныеЗашифрованы Тогда
				Если АдресЗашифрованныхДанныхНаКлиенте <> Неопределено Тогда // шифрование произведено на клиенте
					ДанныеФайла.СсылкаНаДвоичныеДанныеФайла = АдресЗашифрованныхДанныхНаКлиенте;
				Иначе
					ПараметрыШифрования = ОбменСКонтрагентамиСлужебный.АдресаСертификатовШифрования(ДокументНаОтправку);
					Если ПараметрыШифрования <> Неопределено Тогда
						Отказ = Ложь;
						МенеджерКриптографии = ЭлектронноеВзаимодействиеСлужебный.МенеджерКриптографии(Отказ);
						Если Отказ Тогда
							ТекстСообщения = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ПолучитьСообщениеОбОшибке("110");
							ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
							
							ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(АдресКаталога, "*");
							Возврат КонтейнерСформирован;
						КонецЕсли;
						
						МассивСертификатов = Новый Массив;
						Для каждого СтрокаСертификата Из ПараметрыШифрования Цикл
							
							ДвоичныеДанныеСертификата = ПолучитьИзВременногоХранилища(СтрокаСертификата);
							Сертификат = Новый СертификатКриптографии(ДвоичныеДанныеСертификата);
							МассивСертификатов.Добавить(Сертификат);
						КонецЦикла;
						
						ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(ДанныеФайла.СсылкаНаДвоичныеДанныеФайла);
						ЗашифрованныеДанные = МенеджерКриптографии.Зашифровать(ДвоичныеДанныеФайла, МассивСертификатов);
						ДанныеФайла.СсылкаНаДвоичныеДанныеФайла = ПоместитьВоВременноеХранилище(ЗашифрованныеДанные);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			Если ДокументНаОтправку.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий  Тогда
				ОбменСКонтрагентамиСлужебный.СохранитьВместеСПоследнейЭП(ДокументНаОтправку, ДанныеФайла, АдресКаталога,
					СтруктураФайловЭД);
			Иначе
				ОбменСКонтрагентамиСлужебный.СохранитьВместеСЭП(ДокументНаОтправку, ДанныеФайла, АдресКаталога, СтруктураФайловЭД);
				ОбменСКонтрагентамиСлужебный.СохранитьФайлыДопДанныхЭД(ДокументНаОтправку, АдресКаталога, СтруктураФайловЭД);
			КонецЕсли;
			
			// Формируем meta.xml.
			СформироватьТранспортнуюИнформацию(ДокументНаОтправку, СтруктураФайловЭД, АдресКаталога, Ошибки);
			
			// Формируем card.xml
			СформироватьКарточку(ДокументНаОтправку, АдресКаталога, Ошибки, Конверт.ДанныеЗашифрованы, ТребуетсяИзвещениеОПолучении);
			
		КонецЦикла;
		
		Если Не ЗначениеЗаполнено(Ошибки) Тогда
			
			// Формируем пакет ЭД через создание zip-контейнера.
			ЗипКонтейнер = Новый ЗаписьZipФайла();
			ИмяФайла = "EDI_" + Конверт.УникальныйИдентификатор();
			ИмяФайла = ОбщегоНазначенияКлиентСервер.ЗаменитьНедопустимыеСимволыВИмениФайла(ИмяФайла);
			ЗипКонтейнер.Открыть(АдресКаталога + ИмяФайла + ".zip");
			
			ОбъектыДобавляемыеВАрхив = АдресКаталога + "*";
			ЗипКонтейнер.Добавить(ОбъектыДобавляемыеВАрхив, РежимСохраненияПутейZIP.СохранятьОтносительныеПути,
			РежимОбработкиПодкаталоговZIP.ОбрабатыватьРекурсивно);
			
			Попытка
				ЗипКонтейнер.Записать();
				// Сохраним зип-контейнер в присоединенных файлах к конверту.
				ОбменСКонтрагентамиСлужебный.ПоместитьПакетЭДВКонверт(Конверт, АдресКаталога + ИмяФайла + ".zip");
				КонтейнерСформирован = Истина;
			Исключение
				ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование пакета ЭД'"),
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), ТекстСообщения);
			КонецПопытки;
		Иначе
			ШаблонСообщения = НСтр("ru = 'При формировании пакета возникли следующие ошибки:
			|%1'");
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, ТекстОшибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(АдресКаталога);
	Иначе
		ШаблонСообщения = НСтр("ru = 'Ошибка при обработке пакета ЭД %1.
		|Для передачи через сервис ЭДО, пакет ЭД должен содержать 1 электронный документ.
		|Необходимо повторно сформировать электронный документ.'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, Конверт.Наименование);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Возврат КонтейнерСформирован;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Отправка ЭД

// Функция выполняет отправку файлов, находящихся в каталоге "АдресКаталогаОтправки".
//
// Параметры:
//  Маркер                - двоичные данные, маркер, полученный на клиенте.
//  АдресКаталогаОтправки - строка, полный путь к каталогу с передаваемыми файлами.
//  АдресРесурса          - строка, адрес веб-сервиса.
//  ПрофильНастроекЭДО    - СправочникСсылка.ПрофилиНастроекЭДО - профиль настроек ЭДО, по которому происходит отправка.
//  ПовторнаяОтправка     - Булево - требуется повторная отправка.
//
// Возвращаемое значение:
//  РезультатОтправки - Число (количество отправленных документов).
//
Функция ОтправитьЧерезОператораЭДО(Маркер, АдресКаталогаОтправки, АдресРесурса, ПрофильНастроекЭДО, ПовторнаяОтправка = Ложь) Экспорт
	
	РезультатОтправки = 0;
	
	Соединение = ПолучитьСоединение(ПрофильНастроекЭДО.СпособОбменаЭД);
	
	Если ЗначениеЗаполнено(Маркер) Тогда
		Если ТипЗнч(Маркер) <> Тип("Строка") Тогда
			Маркер = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.СтрокаИзДвоичныхДанных(Маркер);
		КонецЕсли;
		ФайлыОтправки = НайтиФайлы(АдресКаталогаОтправки, "*");
		Для Каждого Файл Из ФайлыОтправки Цикл
			ПромежуточныйРезультат = ПередатьПакетЭДОператораЭДО(
													Файл,
													Маркер,
													Соединение,
													АдресРесурса,
													ПрофильНастроекЭДО,
													ПовторнаяОтправка);
			
			Если ПовторнаяОтправка Тогда
				Прервать;
			КонецЕсли;
			РезультатОтправки = РезультатОтправки + ПромежуточныйРезультат;
		КонецЦикла;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(АдресКаталогаОтправки);
	
	Возврат РезультатОтправки;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Получение ЭД

// Получить новые электронные документы от оператора ЭДО.
//
// Параметры:
//  СтруктураВозврата - структура с полями: "ПараметрыРаспаковки, МассивВозврата, ВызватьОповещение"
//  СоотвСоглашенийИСтруктурСертификатов - Соответствие - соответствие соглашений и структур сертификатов авторизации;
//  ПолучитьВесьСписок - получить список ЭД без ограничения выборки по дате
//  ПовторноеПолучение - Булево - признак, что получение вызвано повторно, т.к. маркер протух.
//
Процедура ПолучитьНовыеЭДОператораЭДО(
			СтруктураВозврата,
			СоотвСоглашенийИСтруктурСертификатов,
			ПолучитьВесьСписок = Ложь,
			ПовторноеПолучение = Ложь) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СоотвСоглашенийИСтруктурСертификатов) Тогда
		Соответствие = Неопределено;
		Если НЕ ОбменСКонтрагентамиСлужебный.ДоступныПараметрыДляАвторизацииНаСервереОператора(, Соответствие) Тогда
			Возврат;
		КонецЕсли;
		СоотвСоглашенийИСтруктурСертификатов = Новый Соответствие;
		Для Каждого Элемент Из Соответствие Цикл
			ПрофильНастроекЭДО = Элемент.Ключ;
			Для Каждого Элемент1 Из Элемент.Значение Цикл
				СоотвСоглашенийИСтруктурСертификатов.Вставить(ПрофильНастроекЭДО, Элемент1.Значение);
				Прервать;
			КонецЦикла;
		КонецЦикла;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПрофилиНастроекЭДОЧерезОЭДО.Ссылка КАК ПрофильНастроекЭДО,
	|	СостоянияОбменовЭДЧерезОператоровЭДО.ДатаПолученияЭД КАК ДатаПолученияЭД
	|ИЗ
	|	Справочник.ПрофилиНастроекЭДО КАК ПрофилиНастроекЭДОЧерезОЭДО
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияОбменовЭДЧерезОператоровЭДО КАК СостоянияОбменовЭДЧерезОператоровЭДО
	|		ПО (СостоянияОбменовЭДЧерезОператоровЭДО.ПрофильНастроекЭДО = ПрофилиНастроекЭДОЧерезОЭДО.Ссылка)
	|ГДЕ
	|	ПрофилиНастроекЭДОЧерезОЭДО.СпособОбменаЭД В (ЗНАЧЕНИЕ(Перечисление.СпособыОбменаЭД.ЧерезОператораЭДОТакском), ЗНАЧЕНИЕ(Перечисление.СпособыОбменаЭД.ЧерезСервис1СЭДО))
	|	И НЕ ПрофилиНастроекЭДОЧерезОЭДО.ПометкаУдаления";
	
	ТаблицаДатПолученияЭД = Запрос.Выполнить().Выгрузить();
	
	ИдентификаторыЭДО = Новый Массив;
	Для Каждого Элемент Из СоотвСоглашенийИСтруктурСертификатов Цикл
		
		ПрофильНастроекЭДО = Элемент.Ключ;
		СтруктураСертификата = Элемент.Значение;
		
		ПараметрыПрофиляНастроекЭДО = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПрофильНастроекЭДО,
			"СпособОбменаЭД, ИдентификаторОрганизации");
		СтруктураПараметровЗапросаМаркера = СтруктураСертификата;
		СтруктураПараметровЗапросаМаркера.Вставить("СпособОбменаЭД", ПараметрыПрофиляНастроекЭДО.СпособОбменаЭД);
		СтруктураПараметровЗапросаМаркера.Вставить("ИдентификаторОрганизации", ПараметрыПрофиляНастроекЭДО.ИдентификаторОрганизации);
		
		МаркерРасшифрованный = Неопределено;
		МаркерЗашифрованный = Неопределено;
		ПарольКСертификату = Неопределено;
		Если ТипЗнч(СтруктураСертификата) = Тип("Структура")
			И (СтруктураСертификата.Свойство("МаркерРасшифрованный", МаркерРасшифрованный)
			ИЛИ СтруктураСертификата.Свойство("МаркерЗашифрованный", МаркерЗашифрованный))
			И (ЗначениеЗаполнено(МаркерРасшифрованный) ИЛИ ЗначениеЗаполнено(МаркерЗашифрованный)) Тогда
			СтруктураСертификата.Свойство("ПарольПользователя", ПарольКСертификату);
			Если НЕ ЗначениеЗаполнено(МаркерРасшифрованный) И ПарольКСертификату = Неопределено
				ИЛИ НЕ ОбменСКонтрагентамиСлужебный.РасшифроватьМаркерИзСтруктурыСертификатаНаСервере(СтруктураСертификата) Тогда
				Продолжить;
			Иначе
				МаркерРасшифрованный = СтруктураСертификата.МаркерРасшифрованный;
			КонецЕсли;
			СтрокаТаблицы = ТаблицаДатПолученияЭД.Найти(ПрофильНастроекЭДО);
			ДатаВремяЗапроса = Неопределено;
			Если СтрокаТаблицы <> Неопределено Тогда
				ДатаВремяЗапроса = СтрокаТаблицы.ДатаПолученияЭД;
			КонецЕсли;
		Иначе
			Продолжить;
		КонецЕсли;
		
		СтруктураВозврата.Профили.Добавить(ПрофильНастроекЭДО);
		
		Соединение = ПолучитьСоединение(ПараметрыПрофиляНастроекЭДО.СпособОбменаЭД);
		Маркер = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.СтрокаИзДвоичныхДанных(МаркерРасшифрованный);
		
		ФорматДатыЗапроса = "ДФ='yyyy-MM-dd HH:mm:ss'";
		Если ПараметрыПрофиляНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском Тогда
			ФорматДатыЗапроса = "ДФ='yyyy-MM-ddTHH:mm:ss'";
		КонецЕсли;
		
		СдвигатьДату = Истина;
		ПолученыВсеДокументы = Ложь;
		Пока Не ПолученыВсеДокументы Цикл
			
			ДатаВремяЗапроса = Формат(ДатаВремяЗапроса, ФорматДатыЗапроса);
			ДатаВремяЗапроса = КодироватьСтроку(ДатаВремяЗапроса, СпособКодированияСтроки.КодировкаURL);
			
			АдресРесурса = "GetMessageList" + ?(ЗначениеЗаполнено(ДатаВремяЗапроса), "?date=" + ДатаВремяЗапроса, "");
			СписокЭД_XML = ПолучитьЭлектронныеДокументыОператораЭДО(Маркер, Соединение, АдресРесурса, ПрофильНастроекЭДО,
				ПовторноеПолучение);
			
			Если СписокЭД_XML = Неопределено Тогда
				Возврат;
			КонецЕсли;
			
			СписокИДДокументов = "";
			ДатаВремяЗапроса = РазобратьТекстСпискаЭД(СписокЭД_XML, СписокИДДокументов);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(СписокЭД_XML);
			
			Если СписокИДДокументов.Количество() = 0 Тогда
				ПолученыВсеДокументы = Истина;
				Прервать;
			КонецЕсли;
			
			СписокИДДокументовДляЗагрузки = ИсключитьЗагруженныеПакетыЭД(СписокИДДокументов);
			НеЗагружено = Новый Массив;
			
			Для Каждого Стр Из СписокИДДокументовДляЗагрузки Цикл
				
				ФайлЭД = ПолучитьЭДОператораЭДО(Маркер, Соединение, СтруктураПараметровЗапросаМаркера, Стр.ИДДокумента,
					ПрофильНастроекЭДО, ПовторноеПолучение);
				
				Если ФайлЭД = Неопределено Тогда
					Возврат;
				КонецЕсли;
				
				Если ФайлЭД <> Неопределено Тогда
					ДвоичныеДанныеЭлемента = Новый ДвоичныеДанные(ФайлЭД);
					
					СтруктураПараметров = ПолучитьДанныеВходящегоЭД(ДвоичныеДанныеЭлемента,
																	Стр.КодТранзакции,
																	Стр.ИДДокументооборота,
																	Стр.ИДДокумента);
																	
					НачатьТранзакцию();
					Попытка
						Если ЗначениеЗаполнено(СтруктураПараметров) Тогда
							ПакетЭД = ОбменСКонтрагентамиСлужебный.СформироватьНовыйПакетЭД(СтруктураПараметров);
							
							Если ЗначениеЗаполнено(ПакетЭД.Ссылка) Тогда
								ИмяФайла = "EDI_" + СтруктураПараметров.ВнешнийУИД;
								АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеЭлемента);
								
								ПараметрыФайла = Новый Структура();
								ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
								ПараметрыФайла.Вставить("ВладелецФайлов", ПакетЭД.Ссылка);
								ПараметрыФайла.Вставить("ИмяБезРасширения", ИмяФайла);
								ПараметрыФайла.Вставить("РасширениеБезТочки", "zip");
								ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");
								
								ПрисоединенныйФайл = РаботаСФайлами.ДобавитьФайл(
									ПараметрыФайла, АдресВХранилище);
								
								СтруктураВозврата.МассивПакетовЭД.Добавить(ПакетЭД);
							Иначе
								СдвигатьДату = Ложь;
							КонецЕсли;
						ИначеЕсли Стр.КодТранзакции = "PostDateConfirmation"
							ИЛИ Стр.КодТранзакции = "SendConfirmation"
							ИЛИ Стр.КодТранзакции = "ReceiveNoticePostDateConfirmation"
							ИЛИ Стр.КодТранзакции = "CustomerInformationPostDateConfirmation" Тогда
							СдвигатьДату = Ложь;
							НеЗагружено.Добавить(Стр.ИДДокумента);
						Иначе
							СохранитьНеизвестныйПакет(ДвоичныеДанныеЭлемента, ПрофильНастроекЭДО, Стр.ИДДокумента);
						КонецЕсли;
						ЗафиксироватьТранзакцию();
					Исключение
						ОтменитьТранзакцию();
						СдвигатьДату = Ложь;
						НеЗагружено.Добавить(Стр.ИДДокумента);
						ВидОперации = НСтр("ru = 'Получение пакета ЭД'");
						ТекстСообщения = НСтр("ru = 'Не удалось сохранить пакет электронного документа с идентификатором:'") + " " + Стр.ИДДокумента;
						ТекстОшибки = ТекстСообщения + Символы.ПС 
							+ НСтр("ru = 'По причине:'") + Символы.ПС
							+ ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()) + Символы.ПС 
							+ НСтр("ru = 'Для повторного получения пакета следует обратиться в тех. поддержку 1С-ЭДО, указав идентификатор электронного документа.'");
						ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, ТекстСообщения);
					КонецПопытки;
					ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ФайлЭД);
				КонецЕсли;
				
			КонецЦикла;
			
			// Подтверждение получения электронных документов
			Для каждого СтрокаДокумента Из СписокИДДокументов Цикл
				
				Если НеЗагружено.Найти(СтрокаДокумента.ИДДокумента) <> Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				ПодтвердитьПолучениеЭДОператораЭДО(Маркер, Соединение, СтрокаДокумента.ИДДокумента);
				
			КонецЦикла;
			
			Если СдвигатьДату И ЗначениеЗаполнено(ДатаВремяЗапроса) И СписокИДДокументов.Количество() > 0 Тогда
				Запись = РегистрыСведений.СостоянияОбменовЭДЧерезОператоровЭДО.СоздатьМенеджерЗаписи();
				Запись.ПрофильНастроекЭДО = ПрофильНастроекЭДО;
				Запись.Прочитать();
				Запись.ДатаПолученияЭД = Дата(СтрЗаменить(СтрЗаменить(СтрЗаменить(Сред(ДатаВремяЗапроса, 0,
					СтрНайти(ДатаВремяЗапроса, ".") - 1), "-", ""), " ", ""), ":", ""));
				Запись.Записать();
			КонецЕсли;
			
		КонецЦикла;
		
		Если ПолученыВсеДокументы И ПараметрыПрофиляНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезСервис1СЭДО Тогда
			 ИдентификаторыЭДО.Добавить(ПараметрыПрофиляНастроекЭДО.ИдентификаторОрганизации);
		КонецЕсли;
		
	КонецЦикла;
	
	ПовторноеПолучение = Ложь;
	
	СтруктураВозврата.Вставить("ИдентификаторыЭДО", ИдентификаторыЭДО);
	
КонецПроцедуры

// Отправляет запрос приглашений оператора ЭДО.
//
// Параметры:
//  ТаблицаОбработки  - Таблица значений - таблица приглашений
//                      продолжение описания параметра
//  СтруктураДопПараметров  - структура - перечень дополнительных параметров.
//
// Возвращаемое значение:
//  ИмяФайла - Строка, имя файла либо пустая.
//
Функция ИсходящийЗапросПриглашенияОператораЭДО(ТаблицаОбработки, СтруктураДопПараметров) Экспорт
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	ПутьКОписанию = "{http://api-invoice.taxcom.ru/contacts}.Contacts";
	Попытка
		Контакты = ПолучитьОбъектТипаCML(ПутьКОписанию);
		ЗаполнитьСвойствоXDTO(Контакты, "Asof", ТекущаяДатаСеанса(), , Ошибки);
		Для Каждого ТекСтрока Из ТаблицаОбработки Цикл
			Контакт = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Contact");
			ЗаполнитьСвойствоXDTO(Контакт, "Name",              ТекСтрока.Наименование, , Ошибки);
			ЗаполнитьСвойствоXDTO(Контакт, "Inn",               ТекСтрока.ИНН, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(Контакт, "Kpp",               ТекСтрока.КПП, , Ошибки);
			ЗаполнитьСвойствоXDTO(Контакт, "Email",             ТекСтрока.АдресЭП, , Ошибки);
			ЗаполнитьСвойствоXDTO(Контакт, "Comment",           ТекСтрока.ТекстПриглашения, , Ошибки);
			ЗаполнитьСвойствоXDTO(Контакт, "ExternalContactId", ТекСтрока.ВнешнийКод, , Ошибки);
			ЗаполнитьСвойствоXDTO(Контакт, "EDXClientId",       ТекСтрока.Идентификатор, , Ошибки);
			Контакты.Contact.Добавить(Контакт);
		КонецЦикла;
		Контакты.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ВызватьИсключение ТекстОшибки;
		КонецЕсли;
		
		ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Контакты, ИмяФайла, Ложь);
		
		Возврат ИмяФайла;
	Исключение
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование приглашения к обмену'"),
																					ТекстОшибки,
																					ТекстОшибки);
			
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Отправляет спец. оператору информацию об принятии или отклонении приглашения
// 
// Возвращаемое значение - Булево (Истина - операция выполнена успешно, иначе Ложь)
//
Функция ПринятьОтклонитьКонтактЧерезОператораЭДО(Идентификатор, ПриглашениеПринято, Маркер, ПрофильНастроекЭДО) Экспорт
	
	Соединение = ПолучитьСоединение(ПрофильНастроекЭДО.СпособОбменаЭД);
	Маркер = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.СтрокаИзДвоичныхДанных(Маркер);
	
	ОперацияВыполнена = Ложь;
	Если ЗначениеЗаполнено(Маркер) Тогда
		Если ПриглашениеПринято Тогда
			АдресРесурса = "AcceptContact?id=" + Идентификатор;
		Иначе
			АдресРесурса = "RejectContact?id=" + Идентификатор;
		КонецЕсли;
		
		Заголовки = "";
		ДобавитьПараметрВЗаголовок(Заголовки, "Assistant-Key", Маркер);
		ИмяФайлаРезультата = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		Попытка
			Соединение.Получить(АдресРесурса, ИмяФайлаРезультата, Заголовки);
			ОперацияВыполнена = Истина;
		Исключение
			ТекстовыйДокумент = Новый ТекстовыйДокумент;
			ТекстовыйДокумент.Прочитать(ИмяФайлаРезультата, "UTF-8");
			СтрокаТекста = ТекстовыйДокумент.ПолучитьТекст();
			Если СтрНайти(СтрокаТекста, НСтр("ru ='Статус контакта'") + " ") * СтрНайти(СтрокаТекста, НСтр("ru =', ожидался'")) > 0 Тогда
				// Если пришла строка вида: "Статус контакта Accepted, ожидался Incoming" или подобная,
				// то это не ошибка, а особенность работы сервиса.
				НачПозСтатуса = СтрНайти(СтрокаТекста, НСтр("ru ='Статус контакта'")) + СтрДлина(НСтр("ru ='Статус контакта'") + " ");
				КонПозСтатуса = СтрНайти(СтрокаТекста, НСтр("ru =', ожидался'"));
				ТекСтатусКонтакта = СокрЛП(Сред(СтрокаТекста, НачПозСтатуса, КонПозСтатуса - НачПозСтатуса));
				ТекСтатусКонтакта = ПреобразоватьТекстСтатуса(ТекСтатусКонтакта);
				Если ТекСтатусКонтакта = "Присоединен" Тогда
					ОперацияВыполнена = Истина;
				Иначе
					ТекстСообщения = НСтр("ru = 'Текущий статус подключения Контрагента в настройке ЭДО 
												|не соответствует действительному статусу %1 на сервере оператора ЭДО.
												|Необходимо выполнить команду ""Обновить статусы настроек ЭДО"".'");
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1", ТекСтатусКонтакта);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
					ОперацияВыполнена = Ложь;
				КонецЕсли;
			Иначе
				ШаблонСообщения = НСтр("ru = 'Ошибка обработки %1 приглашения на сервере оператора ЭДО.'");
				СтрокаПараметра = ?(ПриглашениеПринято, НСтр("ru = 'принятия'"), НСтр("ru = 'отклонения'"));
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, СтрокаПараметра);
				ПодробноеПредставлениеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Получение ЭД.'"),
																							ПодробноеПредставлениеОшибки,
																							ТекстСообщения);
				ОперацияВыполнена = Ложь;
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
		КонецПопытки;
	КонецЕсли;
	
	Возврат ОперацияВыполнена;
	
КонецФункции

Функция ТаблицаДанныхУчастниковОбмена(СоотвСоглашенийИСтруктурСертификатов) Экспорт
	
	АдресРесурса = "GetContactListUpdates";
	ТаблицаПриглашений = ИнициализироватьТаблицуДанныхУчастниковОбмена();
	
	Для Каждого Элемент Из СоотвСоглашенийИСтруктурСертификатов Цикл
		
		ПрофильНастроекЭДО = Элемент.Ключ;
		СтруктураСертификата = Элемент.Значение;
		
		ПараметрыПрофиляНастроекЭДО = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПрофильНастроекЭДО,
			"СпособОбменаЭД, ИдентификаторОрганизации");
		СтруктураСертификата.Вставить("СпособОбменаЭД", ПараметрыПрофиляНастроекЭДО.СпособОбменаЭД);
		СтруктураСертификата.Вставить("ИдентификаторОрганизации", ПараметрыПрофиляНастроекЭДО.ИдентификаторОрганизации);
		
		Маркер = "";
		Если ТипЗнч(СтруктураСертификата) = Тип("Структура") Тогда
			СтруктураСертификата.Свойство("МаркерРасшифрованный", Маркер);
		КонецЕсли;
		Если Не ЗначениеЗаполнено(Маркер) Тогда
			Продолжить;
		КонецЕсли;
		
		ПолученыВсеЗаписи = Ложь;
		
		ФорматДатыЗапроса = "ДФ='yyyy-MM-dd HH:mm:ss'";
		Если ПараметрыПрофиляНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском Тогда
			ФорматДатыЗапроса = "ДФ='yyyy-MM-ddTHH:mm:ss'";
		КонецЕсли;
		
		ДатаПоследнегоЗапроса = Формат(ДатаПоследнегоПолученияПриглашений(ПрофильНастроекЭДО), ФорматДатыЗапроса);
		ДатаПоследнегоЗапроса = КодироватьСтроку(ДатаПоследнегоЗапроса, СпособКодированияСтроки.КодировкаURL);
		
		Пока Не ПолученыВсеЗаписи Цикл
			АдресРесурсаПолный = АдресРесурса + "?date=" + ДатаПоследнегоЗапроса;
			Если ПараметрыПрофиляНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском Тогда
				АдресРесурсаПолный = АдресРесурсаПолный + "&status=ContactStatus.Incoming";
			КонецЕсли;
			
			ФайлПриглашения = ПолучитьЧерезОператораЭДО(АдресРесурсаПолный, Неопределено, Маркер, СтруктураСертификата, ПрофильНастроекЭДО);
			Если ФайлПриглашения = Неопределено Тогда
				Прервать;
			КонецЕсли;
				
			КолСтрокТзДоЧтения = ТаблицаПриглашений.Количество();
			ПрочитатьЗапросПриглашенияОператораЭДО(ФайлПриглашения, ТаблицаПриглашений, ДатаПоследнегоЗапроса, ПрофильНастроекЭДО);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ФайлПриглашения);
				
			Если КолСтрокТзДоЧтения = ТаблицаПриглашений.Количество() Тогда
				ПолученыВсеЗаписи = Истина;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Возврат ТаблицаПриглашений;
	
КонецФункции

Процедура СформироватьКарточку(ЭлектронныйДокумент, АдресКаталога, Ошибки, Зашифрован = Ложь, ТребуетсяИзвещениеОПолучении = Истина) Экспорт
	
	ДеревоКарточкиТакском = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.КарточкаПередаваемыхДанных");
	
	// Готовим дерево данных для карточки пакета.
	ПодготовитьДанныеПоКарточке(ЭлектронныйДокумент, ДеревоКарточкиТакском, Зашифрован, ТребуетсяИзвещениеОПолучении);
	
	// Выполним проверку на заполненность обязательных полей.
	Если Не ЗначениеЗаполнено(Ошибки) Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоКарточкиТакском, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) Тогда
		Карточка = СформироватьКарточкуCML(ДеревоКарточкиТакском, Ошибки);
		КопироватьФайл(Карточка, АдресКаталога + "card.xml");
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(Карточка);
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьТранспортнуюИнформацию(ЭлектронныйДокумент, СтруктураФайловЭД, АдресКаталога, Ошибки) Экспорт
	
	ДеревоТранспортнойИнформации = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ТранспортнаяИнформация");
	
	// Готовим дерево данных с транспортной информацией.
	ПодготовитьДанныеПоТранспортнойИнформации(ЭлектронныйДокумент, СтруктураФайловЭД, ДеревоТранспортнойИнформации);
	
	// Выполним проверку на заполненность обязательных полей.
	Если Не ЗначениеЗаполнено(Ошибки) Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоТранспортнойИнформации, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) Тогда
		ИмяФайлаТранспортнойИнформации = СформироватьТранспортнуюИнформациюCML(ДеревоТранспортнойИнформации, Ошибки);
		КопироватьФайл(ИмяФайлаТранспортнойИнформации, АдресКаталога + "meta.xml");
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаТранспортнойИнформации);
	КонецЕсли;
	
КонецПроцедуры

// Ищет документы основания для ЭД счет фактура
// 1. Находит документ Торг- 12 (например) на основании которого был введен
// 2. Ищет все основания для найденного Торг-12
// 3. Находит все с.ф. для всех торг-12 из п.2
// 4. Устанавливает состояние "Обмен завершен с исправлением" для найденных в п. 3 с.ф.
//
// Параметры:
//  ПервичныйЭД - Ссылка, Массив - ссылка ЭД вида счет-фактура
//  НаправлениеЭД - Перечисление.НаправленияЭД - направление для поиска основания.
//
Процедура ИзменитьСостояниеСФОснований(ПервичныйЭД, НаправлениеЭД, ВыполняетсяОбновлениеИнформационнойБазы = Ложь) Экспорт
	
	Если Не ТипЗнч(ПервичныйЭД) = Тип("Массив") Тогда
		МассивЭД = Новый Массив;
		МассивЭД.Добавить(ПервичныйЭД);
	Иначе
		МассивЭД = ПервичныйЭД;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Если НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЭДПрисоединенныеФайлы.ВладелецФайла КАК СсылкаНаЭД,
		|	ЭДПрисоединенныеФайлы.НомерЭД КАК НомерЭД
		|ПОМЕСТИТЬ ВТ_ВладельцыФайлов
		|ИЗ
		|	Справочник.ЭДПрисоединенныеФайлы КАК ЭДПрисоединенныеФайлы
		|ГДЕ
		|	ЭДПрисоединенныеФайлы.Ссылка В(&МассивЭД)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СсылкаНаЭД
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЭлектронныйДокументВходящийИдентификаторыОснованийВладельцаФайла.Ссылка КАК Ссылка,
		|	ЭлектронныйДокументВходящийИдентификаторыОснованийВладельцаФайла.ИдентификаторДокументаОснования КАК ИДОснования
		|ИЗ
		|	Документ.ЭлектронныйДокументВходящий.ИдентификаторыОснованийВладельцаФайла КАК ЭлектронныйДокументВходящийИдентификаторыОснованийВладельцаФайла
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ВладельцыФайлов КАК ВТ_ВладельцыФайлов
		|		ПО ЭлектронныйДокументВходящийИдентификаторыОснованийВладельцаФайла.Ссылка = ВТ_ВладельцыФайлов.СсылкаНаЭД
		|			И ЭлектронныйДокументВходящийИдентификаторыОснованийВладельцаФайла.ИдентификаторДокументаОснования <> ВТ_ВладельцыФайлов.НомерЭД";
		
	Иначе
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЭДПрисоединенныеФайлы.ВладелецФайла КАК СсылкаНаЭД,
		|	ЭДПрисоединенныеФайлы.НомерЭД КАК НомерЭД
		|ПОМЕСТИТЬ ВТ_ВладельцыФайлов
		|ИЗ
		|	Справочник.ЭДПрисоединенныеФайлы КАК ЭДПрисоединенныеФайлы
		|ГДЕ
		|	ЭДПрисоединенныеФайлы.Ссылка В(&МассивЭД)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СсылкаНаЭД
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЭлектронныйДокументИсходящийИдентификаторыОснованийВладельцаФайла.Ссылка КАК Ссылка,
		|	ЭлектронныйДокументИсходящийИдентификаторыОснованийВладельцаФайла.ИдентификаторДокументаОснования КАК ИДОснования
		|ИЗ
		|	Документ.ЭлектронныйДокументИсходящий.ИдентификаторыОснованийВладельцаФайла КАК ЭлектронныйДокументИсходящийИдентификаторыОснованийВладельцаФайла
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ВладельцыФайлов КАК ВТ_ВладельцыФайлов
		|		ПО ЭлектронныйДокументИсходящийИдентификаторыОснованийВладельцаФайла.Ссылка = ВТ_ВладельцыФайлов.СсылкаНаЭД
		|			И ЭлектронныйДокументИсходящийИдентификаторыОснованийВладельцаФайла.ИдентификаторДокументаОснования <> ВТ_ВладельцыФайлов.НомерЭД";
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("МассивЭД", МассивЭД);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	МассивНомеровЭД = Новый Массив;
	ТекущиеСФ = Новый Массив;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		МассивНомеровЭД.Добавить(Выборка.ИДОснования);
		Если ТекущиеСФ.Найти(Выборка.Ссылка) = Неопределено Тогда
			ТекущиеСФ.Добавить(Выборка.Ссылка);
		КонецЕсли;
	КонецЦикла;
	
	// Для каждой счет фактуры ищем ссылку на документ ИБ основания
	// и НомерЭД документа, на основании которого введен документ основания.
	ОснованияИБ = Новый Массив;
	ОбменСКонтрагентамиСлужебный.НайтиДокументыОснования(МассивНомеровЭД, НаправлениеЭД, ОснованияИБ);
	
	Если ОснованияИБ.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	СФДляИзменения = Новый Массив;
	// Из них получает массив введенных сф.
	ЗаполнитьСФПоДокументамОснования(СФДляИзменения, ОснованияИБ, НаправлениеЭД);
	
	СФДляИзменения = ОбщегоНазначенияКлиентСервер.РазностьМассивов(СФДляИзменения, ТекущиеСФ);
	
	// Для списка СФ меняем состояние ЭД.
	УстановитьСостояниеОбменЗавершенСИсправлением(СФДляИзменения, ВыполняетсяОбновлениеИнформационнойБазы);
		
КонецПроцедуры

Процедура ИзменитьСостояниеОснованийРТУ(УтвержденныеРТУ, ВыполняетсяОбновлениеИнформационнойБазы = Ложь) Экспорт
	
	Для Каждого УтвержденныйЭД Из УтвержденныеРТУ Цикл
		
		Направление = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(УтвержденныйЭД, "НаправлениеЭД");
		ОбменСКонтрагентамиСлужебный.УстановитьСостояниеЗавершен(УтвержденныйЭД,
			Направление, ВыполняетсяОбновлениеИнформационнойБазы);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ОбновитьДатуИзмененияСтатуса(НастройкаЭДО) Экспорт
	
	ДатаСтатуса = ТекущаяДатаСеанса();
	НастройкаЭДО.ДатаИзмененияСтатуса = ДатаСтатуса;
	
КонецПроцедуры

Функция РегистрационныеДанныеДляОператораЭДО(ДеревоРегистрационнойИнформации) Экспорт
	
	Ошибки = Неопределено;
	ДвоичныеДанныеДляОператораЭДО = Неопределено;
	
	// Выполним проверку на заполненность обязательных полей.
	Если Не ЗначениеЗаполнено(Ошибки) Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоРегистрационнойИнформации, Ошибки);
	КонецЕсли;	
	
	Если Не ЗначениеЗаполнено(Ошибки) Тогда
	
		ИмяФайлаРегистрационнойИнформации = СформироватьРегистрационнуюИнформациюCML(ДеревоРегистрационнойИнформации);
		Если ЗначениеЗаполнено(ИмяФайлаРегистрационнойИнформации) Тогда
			ДвоичныеДанныеДляОператораЭДО = Новый ДвоичныеДанные(ИмяФайлаРегистрационнойИнформации);
		КонецЕсли;
		
	Иначе
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		ШаблонСообщения = НСтр("ru = 'При формировании регистрационного пакета возникли следующие ошибки:
		|%1'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, ТекстОшибки);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Возврат ДвоичныеДанныеДляОператораЭДО;
	
КонецФункции

Функция ДанныеФайлаЭД(ИмяФайлаЭД, ОписаниеОшибки, ПространствоИменФНС = Неопределено, ИмяКорневогоУзла = "", МягкоеЧтение = Ложь) Экспорт
	
	ДанныеФайлаЭД         = Неопределено;
	ПространствоИменФайла = "";
	
	ЧтениеXML = Новый ЧтениеXML;
	
	Попытка
		
		ЧтениеXML.ОткрытьФайл(ИмяФайлаЭД);
		
		Если ЧтениеXML.Прочитать() Тогда
			
			ИмяКорневогоУзла = ЧтениеXML.ЛокальноеИмя;
			ПространствоИменФайла = ЧтениеXML.URIПространстваИмен;
			
			// Для форматов ФНС.
			ИдФайл   = "";
			ВерсФорм = "";
			
			Если ПространствоИменФайла = ОбменСКонтрагентамиСлужебный.ПространствоИменCML() И МягкоеЧтение Тогда
				// Для актуальных CML вырезаем пространство имен.
				ЧтениеXML.Закрыть();
				УдалитьПространствоИменCML(ИмяФайлаЭД);
			Иначе
				
				Пока ЧтениеXML.ПрочитатьАтрибут() Цикл
					
					Если ПространствоИменФайла = "DP_UVUTOCH" И ЧтениеXML.Имя = "ВерсФорм" И ЧтениеXML.Значение = "1.01" Тогда
						// Для возможности чтения старых служебных ЭД "Уведомление об уточнении".
						ЧтениеXML.Закрыть();
						ЗаменитьПространствоИменDP_UVUTOCH(ИмяФайлаЭД);
						Прервать;
						
					ИначеЕсли ЧтениеXML.Имя = "ИдФайл" Тогда
						ИдФайл = ЧтениеXML.Значение;
						
					ИначеЕсли ЧтениеXML.Имя = "ВерсФорм" Тогда
						ВерсФорм = ЧтениеXML.Значение;
						
					КонецЕсли;
					
				КонецЦикла;
				
				ЧтениеXML.Закрыть();
				
			КонецЕсли;
			
		КонецЕсли;
		
	Исключение
		ШаблонСообщения = НСтр("ru = 'Ошибка при чтении данных из файла:
			|%1'");
		ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, ИмяФайлаЭД);
		
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
	КонецПопытки;
	
	Если ЗначениеЗаполнено(ИдФайл) И Не ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		
		// Чтение файлов по форматам ФНС
		
		URIПространстваИмен = "";
		
		Если Не МягкоеЧтение Тогда
			
			// Установим пространство имен для актуальных форматов, если нужно читать строго в соответствии со схемой.
			
			Если СтрНайти(ИдФайл, "ON_SCHFDOPPR") Тогда
				URIПространстваИмен = "ON_SCHFDOPPR";
				
			ИначеЕсли СтрНайти(ИдФайл, "ON_SCHFDOPPOK") Тогда
				URIПространстваИмен = "ON_SCHFDOPPOK";
				
			ИначеЕсли СтрНайти(ИдФайл, "ON_KORSCHFDOPPR") Тогда
				URIПространстваИмен = "ON_KORSCHFDOPPR";
				
			ИначеЕсли СтрНайти(ИдФайл, "ON_KORSCHFDOPPOK") Тогда
				URIПространстваИмен = "ON_KORSCHFDOPPOK";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_IZVPOL") И ВерсФорм <> "1.01" Тогда
				URIПространстваИмен = "DP_IZVPOL";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_UVUTOCH") Тогда
				
				Если ВерсФорм = "1.01" Тогда
					URIПространстваИмен = "DP_UVUTOCH_01_01";
				Иначе
					URIПространстваИмен = "DP_UVUTOCH";
				КонецЕсли;
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_PRANNUL") Тогда
				URIПространстваИмен = "DP_PRANNUL";
				
			ИначеЕсли СтрНайти(ИдФайл, "POD_DPIZVPOL") Тогда
				URIПространстваИмен = "DP_IZVPOL";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_PDOTPR") Тогда
				URIПространстваИмен = "DP_PDOTPR";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_PDPOL") Тогда
				URIПространстваИмен = "DP_PDPOL";
				
			ИначеЕсли СтрНайти(ИдФайл, "POD") Тогда
				URIПространстваИмен = "PDO";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_TOVTORGPR") Тогда // Передача товаров продавец
				URIПространстваИмен = "TORGPR";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_TOVTORGPOK") Тогда // Передача товаров покупатель
				URIПространстваИмен = "TORGPOK";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_REZRUISP") Тогда // Передача товаров покупатель
				URIПространстваИмен = "RUISP";
				
			ИначеЕсли СтрНайти(ИдФайл, "DP_REZRUZAK") Тогда // Передача товаров покупатель
				URIПространстваИмен = "RUZAK";
				
			КонецЕсли;
			
		КонецЕсли;
		
		// Устанавливаем пространство имен для устаревших форматов всегда.
		
		Если СтрНайти(ИДФайл, "ON_SFAKT") Тогда
			
			Если ВерсФорм = "5.01" Тогда
				URIПространстваИмен = "SFAKT";
			Иначе
				URIПространстваИмен = "SFAKT_5_02";
			КонецЕсли;
			
		ИначеЕсли СтрНайти(ИдФайл, "ON_KORSFAKT") Тогда // корректировочный счет-фактура
			
			Если ВерсФорм = "5.01" Тогда
				URIПространстваИмен = "KORSFAKT";
			Иначе
				URIПространстваИмен = "KORSFAKT_5_02";
			КонецЕсли;
			
		ИначеЕсли СтрНайти(ИдФайл, "OKORDOC") > 0 Тогда // корректировочный торг-12 титул продавца
			URIПространстваИмен = "OKORDOC";
			
		ИначеЕсли СтрНайти(ИдФайл, "PKORDOC") > 0 Тогда // корректировочный торг-12 титул продавца
			URIПространстваИмен = "PKORDOC";
			
		Иначе
			
			Форматы = Новый Массив;
			Форматы.Добавить("OTORG12"); // торг-12 титул продавца
			Форматы.Добавить("PTORG12"); // торг-12 титул покупателя
			Форматы.Добавить("IAKTPRM"); // Акт титул исполнителя
			Форматы.Добавить("ZAKTPRM"); // Акт титул заказчика
			
			Для Каждого Формат Из Форматы Цикл
				
				Если СтрНайти(ИдФайл, Формат) Тогда
					
					ЧтениеXML.ОткрытьФайл(ИмяФайлаЭД);
					ДанныеФайлаЭД = ФабрикаXDTO.ПрочитатьXML(ЧтениеXML);
					ЧтениеXML.Закрыть();
					
					URIПространстваИмен = ПространствоИменАкта(ДанныеФайлаЭД, Формат);
					ПространствоИменФНС = URIПространстваИмен;
					
					Прервать;
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ПространствоИменФайла) И ЗначениеЗаполнено(URIПространстваИмен) Тогда
			
			ЧтениеXML.ОткрытьФайл(ИмяФайлаЭД);
			
			ПостроительDOM = Новый ПостроительDOM();
			ДокументDOM = ПостроительDOM.Прочитать(ЧтениеXML);
			ЧтениеXML.Закрыть();
			
			ДокументDOM.ЭлементДокумента.УстановитьСоответствиеПространстваИмен("", URIПространстваИмен);
			
			ЗаписьXML = Новый ЗаписьXML;
			ЗаписьXML.ОткрытьФайл(ИмяФайлаЭД);
			
			ЗаписьDOM = Новый ЗаписьDOM;
			ЗаписьDOM.Записать(ДокументDOM, ЗаписьXML);
			ЗаписьXML.Закрыть();
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		
		Попытка
			ЧтениеXML.ОткрытьФайл(ИмяФайлаЭД);
			ДанныеФайлаЭД = ФабрикаXDTO.ПрочитатьXML(ЧтениеXML,
				?(ЗначениеЗаполнено(URIПространстваИмен), ПолучитьТипЗначенияCML("Файл", URIПространстваИмен), Неопределено));
		Исключение
			ШаблонСообщения = НСтр("ru = 'Ошибка при чтении данных из файла:
			|%1'");
			ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, ИмяФайлаЭД);
			
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат ДанныеФайлаЭД;
	
КонецФункции

Функция ДокументЯвляетсяСчетомФактурой(ДокументСсылка) Экспорт
	
	Результат = Ложь;
	ОбменСКонтрагентамиПереопределяемый.ОпределитьДокументЯвляетсяСчетомФактурой(ДокументСсылка, Результат);
	Возврат Результат;
	
КонецФункции

// Сохраняет файл на диск по переданной ссылке.
//
// Параметры:
//  ЭДСсылка		 - СправочникСсылка.ЭДПрисоединенныеФайлы - ссылка на файл.
//  ПараметрыФайла	 - Структура - см. функцию ОбменСКонтрагентамиВнутренний.СвойстваФайла().
//
Процедура СохранитьЭДВФайл(ЭДСсылка, ПараметрыФайла = Неопределено) Экспорт
	
	Если ПараметрыФайла = Неопределено Тогда
		ПараметрыФайла = СвойстваФайла();
	КонецЕсли;
	
	ДопИнформацияПоЭД = ОбменСКонтрагентамиСлужебный.ПолучитьДанныеФайла(ЭДСсылка, ЭДСсылка.УникальныйИдентификатор(), Истина);
	
	Расширение = ДопИнформацияПоЭД.Расширение;
	Если ДопИнформацияПоЭД.Свойство("СсылкаНаДвоичныеДанныеФайла")
		И ЗначениеЗаполнено(ДопИнформацияПоЭД.СсылкаНаДвоичныеДанныеФайла) Тогда
		
		Если ЗначениеЗаполнено(Расширение) Тогда
			ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла(Расширение);
		Иначе
			ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
			Расширение = "xml";
		КонецЕсли;
		
		Если ИмяФайла = Неопределено Тогда
			ТекстОшибки = НСтр("ru = 'Не удалось просмотреть электронный документ. Проверьте настройку рабочего каталога'");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			Возврат ;
		КонецЕсли;
		
		ДанныеЭД = ПолучитьИзВременногоХранилища(ДопИнформацияПоЭД.СсылкаНаДвоичныеДанныеФайла);
		ДанныеЭД.Записать(ИмяФайла);
		
	КонецЕсли;
	
	ПараметрыФайла.ИмяФайла = ИмяФайла;
	ПараметрыФайла.Расширение = Расширение;
	ПараметрыФайла.Наименование = ДопИнформацияПоЭД.Наименование;
	
КонецПроцедуры

// Возвращает номер электронного документа, указанный в его карточке.
//
// Параметры:
//  КарточкаЭД - ОбъектXDTO - данные карточки электронного документа в пакете.
//
// Возвращаемое значение:
//  Строка - номер электронного документа, указанный в переданной карточке.
//
Функция НомерЭДВКарточкеЭД(Знач КарточкаЭД) Экспорт
	
	НомерЭД = "";
	
	Если КарточкаЭД.Identifiers.ExternalIdentifier <> Неопределено Тогда
		НомерЭД = КарточкаЭД.Identifiers.ExternalIdentifier;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(НомерЭД) Тогда
		
		НомерОператора = "";
		Если КарточкаЭД.Identifiers.InternalId <> Неопределено Тогда
			НомерОператора = КарточкаЭД.Identifiers.InternalId;
		КонецЕсли;
		
		Если КарточкаЭД.Sender.Abonent <> Неопределено Тогда
			ПрефиксОператора = "";
			Если КарточкаЭД.Sender.Abonent.Id <> Неопределено Тогда
				ИдентификаторОтправителя = КарточкаЭД.Sender.Abonent.Id;
				ПрефиксОператора = Лев(ИдентификаторОтправителя, 4);
			КонецЕсли;
			НомерЭД = ПрефиксОператора + НомерОператора;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат НомерЭД;
	
КонецФункции

// Распаковывает архив "ИмяФайла" в каталог "ИмяКаталога".
// В случае неудачи пишет ошибку в журнал регистрации с пометкой "Операция".
//
// Параметры:
//  ИмяФайла     - Строка - полный путь к файлу.
//  ИмяКаталога  - Строка - полный путь к каталогу распаковки.
//  Операция     - Строка - вид операции при которой возникло исключение.
//  РежимВосстановленияПутей - РежимВосстановленияПутейФайловZIP - Указывает, требуется ли восстанавливать структуру каталогов.
//                            Значение по умолчанию "РежимВосстановленияПутейФайловZIP.Восстанавливать".
//
// Возвращаемое значение:
//   Булево   - Истина, если успешно.
//
Функция РаспаковатьАрхив(ИмяФайла, ИмяКаталога, Операция, РежимВосстановленияПутей = Неопределено) Экспорт
	
	Успех = Ложь;
	
	Если РежимВосстановленияПутей = Неопределено Тогда
		РежимВосстановленияПутей = РежимВосстановленияПутейФайловZIP.Восстанавливать;
	КонецЕсли;
	
	Попытка
		
		ЧтениеАрхива = Новый ЧтениеZipФайла(ИмяФайла);
		ЧтениеАрхива.ИзвлечьВсе(ИмяКаталога, РежимВосстановленияПутей);
		ЧтениеАрхива.Закрыть();
		
		Успех = Истина;
		
	Исключение
		
		ТекстОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		
		Если ЧтениеАрхива = Неопределено Тогда
			ТекстСообщения = НСтр("ru = 'Невозможно прочитать архив'")
		Иначе
			Если Не ЭлектронноеВзаимодействиеСлужебный.ВозможноИзвлечьФайлы(ЧтениеАрхива, ИмяКаталога) Тогда
				ТекстСообщения = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ПолучитьСообщениеОбОшибке("006");
			КонецЕсли;
			ЧтениеАрхива.Закрыть();
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(Операция, ТекстОшибки, ТекстСообщения);
		
	КонецПопытки;
	
	Возврат Успех;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Возвращает макет электронного документа по имени.
//
// Параметры:
//  ИмяМакета - Строка - название электронного документа.
//
// Возвращаемое значение:
//  ТабличныйДокумент - макет с описанием структуры электронного документа.
//
Функция МакетЭлектронногоДокумента(Знач ИмяМакета)
	
	УстановитьПривилегированныйРежим(Истина);
	Макет = Обработки.ОбменСКонтрагентами.ПолучитьМакет(ИмяМакета);
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат Макет;
	
КонецФункции

// Удаляет пространство имен из файла.
//
// Параметры:
//   ИмяФайла - Строка - путь к файлу на диске;
//   ПространствоИмен - Строка - удаляемое пространство имен.
//
Процедура УдалитьПространствоИменCML(ИмяФайла)
	
	ПространствоИмен = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	
	Текст = Новый ТекстовыйДокумент;
	Текст.Прочитать(ИмяФайла, "windows-1251");
	
	СтрокаФайл = Текст.ПолучитьСтроку(2);
	
	СтрокаФайл = СтрЗаменить(СтрокаФайл, "xmlns=""" + ПространствоИмен + """" , "");
	СтрокаФайл = СтрЗаменить(СтрокаФайл, "xsi:type=""Контрагент"""            , "");
	СтрокаФайл = СтрЗаменить(СтрокаФайл, "xsi:type=""КоммерческаяИнформация""", "");
	
	Текст.ЗаменитьСтроку(2, СтрокаФайл);
	ТекстДокумента = Текст.ПолучитьТекст();
	
	Текст = Новый ЗаписьТекста(ИмяФайла, "windows-1251");
	Текст.Записать(ТекстДокумента);
	Текст.Закрыть();
	
КонецПроцедуры

Процедура ЗаменитьПространствоИменDP_UVUTOCH(ИмяФайлаЭД)
	
	Текст = Новый ТекстовыйДокумент;
	
	Текст.Прочитать(ИмяФайлаЭД, "windows-1251");
	
	СтрокаФайл = Текст.ПолучитьСтроку(2);
	ШаблонСтроки = "xmlns=""%1""";
	
	СтрокаФайл = СтрЗаменить(СтрокаФайл,
		СтрШаблон(ШаблонСтроки, "DP_UVUTOCH"),
		СтрШаблон(ШаблонСтроки, "DP_UVUTOCH_01_01"));
	
	Текст.ЗаменитьСтроку(2, СтрокаФайл);
	Текст.Записать(ИмяФайлаЭД, "windows-1251");
	
КонецПроцедуры

Функция ДатаИзИДФайла(Знач ИдФайла, ПрефиксТипаДокумента, ИндексЭлементаДата = 2)
	
	Результат = Неопределено;
	
	ИдФайла = СтрЗаменить(ИдФайла, ПрефиксТипаДокумента + "_", "");
	ЭлементыИДФайла = СтрРазделить(ИдФайла, "_");
	Если ЭлементыИДФайла.Количество() > ИндексЭлементаДата Тогда
		ДатаТекст = ЭлементыИДФайла[ИндексЭлементаДата];
		Результат = Дата(ДатаТекст + "000000");
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

Функция ПеречислениеИзЗначенияXML(ЗначениеXML, ИмяПеречисления)

	МенеджерПеречисления = Перечисления[ИмяПеречисления];
	Результат = МенеджерПеречисления.ПустаяСсылка();
	
	Если ЗначениеЗаполнено(ЗначениеXML) Тогда
		МетаданныеПеречисления = Метаданные.Перечисления[ИмяПеречисления];
		Если МетаданныеПеречисления.ЗначенияПеречисления.Найти(ЗначениеXML) <> Неопределено Тогда
			Результат = МенеджерПеречисления[ЗначениеXML];
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

Функция ПолучитьСвойствоПоляXDTOСхемы(ПространствоИменСхемы, ИмяОбъекта, ИмяСвойства, ВидФасета)
	
	ВозвращаемоеЗначение = Неопределено;
	
	ОбъектCML = ПолучитьОбъектТипаCML(ИмяОбъекта, ПространствоИменСхемы);
	
	Если ОбъектCML <> Неопределено И ТипЗнч(ВидФасета) = Тип("ВидФасетаXDTO") Тогда
		СвойстваОбъекта = ОбъектCML.Свойства();
		ИскомоеСвойство = СвойстваОбъекта.Получить(ИмяСвойства);
		Если ИскомоеСвойство <> Неопределено Тогда
			Фасет = ИскомоеСвойство.Тип.Фасеты.Получить(ВидФасета);
			ВозвращаемоеЗначение = Фасет.Значение;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция ТекстРазделитель()
	
	Разделитель =
	"
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|";
	
	Возврат Разделитель;
	
КонецФункции

Функция ТекстЗапросаДокументИсходящий()
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЭлектронныйДокументИсходящийДокументыОснования.ДокументОснование КАК Ссылка,
	|	вт_ЭД.НомерЭД
	|ИЗ
	|	Документ.ЭлектронныйДокументИсходящий.ДокументыОснования КАК ЭлектронныйДокументИсходящийДокументыОснования
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ вт_ЭД КАК вт_ЭД
	|		ПО ЭлектронныйДокументИсходящийДокументыОснования.Ссылка = вт_ЭД.Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаВходящийДокумент()
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЭлектронныйДокументВходящийДокументыОснования.ДокументОснование КАК Ссылка,
	|	вт_ЭД.НомерЭД КАК УникальныйИД
	|ИЗ
	|	вт_ЭД КАК вт_ЭД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументВходящий.ДокументыОснования КАК ЭлектронныйДокументВходящийДокументыОснования
	|		ПО вт_ЭД.Ссылка = ЭлектронныйДокументВходящийДокументыОснования.Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Проверяет, умещаются ли переданные табличные документы
// на страницу при печати.
//
// Параметры
//  ТабДокумент        - Табличный документ.
//  ВыводимыеОбласти   - Массив из проверяемых таблиц или табличный документ.
//  РезультатПриОшибке - Какой возвращать результат при возникновении ошибки.
//
// Возвращаемое значение:
//  Булево - умещаются или нет переданные документы.
//
Функция ПроверитьВыводТабличногоДокумента(ТабДокумент, ВыводимыеОбласти, РезультатПриОшибке = Истина)

	Попытка
		Возврат ТабДокумент.ПроверитьВывод(ВыводимыеОбласти);
	Исключение
		Возврат РезультатПриОшибке;
	КонецПопытки;

КонецФункции

// Собирает из элементов структуры адреса строку записи адреса в формате 8 запятых.
Функция СобратьАдрес(Знач СтруктураАдрес)
	
	Адрес = "";
	
	Для Каждого КлючЗначение Из СтруктураАдрес Цикл
		
		Если Не ЗначениеЗаполнено(КлючЗначение.Значение) Тогда
			Продолжить;
		КонецЕсли;
		
		ЗначениеАдресногоПоля = КлючЗначение.Значение;
		НаименованиеРегиона = "";
		Если Врег(КлючЗначение.Ключ) = Врег("КодРегион") Тогда
			ОбменСКонтрагентамиПереопределяемый.НазваниеРегиона(ЗначениеАдресногоПоля, НаименованиеРегиона);
			Если ЗначениеЗаполнено(НаименованиеРегиона) Тогда
				ЗначениеАдресногоПоля = НаименованиеРегиона
			КонецЕсли;
		КонецЕсли;
		
		ДобавитьПрефиксКЭлементуАдреса(КлючЗначение.Ключ, ЗначениеАдресногоПоля);
		
		Адрес = Адрес + ?(ЗначениеЗаполнено(Адрес), ","+ " " + ЗначениеАдресногоПоля, ЗначениеАдресногоПоля);
		
	КонецЦикла;
	
	Возврат Адрес;
	
КонецФункции

Процедура ДобавитьПрефиксКЭлементуАдреса(Знач ИмяЭлемента, ЗначениеЭлемента)
	
	Если Не ЗначениеЗаполнено(ЗначениеЭлемента) Тогда
		Возврат;
	КонецЕсли;
	
	ИмяЭлемента = ВРег(ИмяЭлемента);
	Префикс = "";
	
	Если ИмяЭлемента = "ДОМ" Тогда
		
		// Добавляем префикс "дом № ", если
		// значение начинается с цифры 
		// и состоит из одного слова.
		// Например, добавляем для "15А", не добавляем для "15А д".
		
		НачальныйСимвол = Лев(ЗначениеЭлемента, 1);
		НачальныйСимволЦифра = СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(НачальныйСимвол);
		ТолькоОдноСлово = (СтрНайти(СокрЛП(ЗначениеЭлемента), " ") = 0);
		
		Если НачальныйСимволЦифра И ТолькоОдноСлово Тогда
			Префикс = НСтр("ru = 'дом №'") + " ";
		КонецЕсли;
		
	ИначеЕсли ИмяЭлемента = "КОРПУС" Тогда
		
		// Добавляем префикс "корпус ", если
		// значение состоит из одного символа
		// или из одних цифр.
		
		ТолькоЦифры = СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(ЗначениеЭлемента);
		ТолькоОдинСимвол = (СтрДлина(ЗначениеЭлемента) = 1);
		
		Если ТолькоЦифры ИЛИ ТолькоОдинСимвол Тогда
			Префикс = НСтр("ru = 'корпус'") + " ";
		КонецЕсли;
		
	ИначеЕсли ИмяЭлемента = "КВАРТИРА" ИЛИ ИмяЭлемента = "КВАРТ" Тогда
		
		// Добавляем префикс "кв. ", если
		// значение состоит из одних цифр.
		
		ТолькоЦифры = СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(ЗначениеЭлемента);
		
		Если ТолькоЦифры Тогда
			Префикс = НСтр("ru = 'кв.'") + " ";
		КонецЕсли;
		
	КонецЕсли;
	
	ЗначениеЭлемента = Префикс + ЗначениеЭлемента;
	
КонецПроцедуры

// Раскладывание строки с данными об адресе (в формате 8 запятых) на элементы структуры.
//
// Параметры:
//  СтрокаАдрес - Строка - исходное представление адреса.
//
// Возвращаемое значение:
//  Структура - адрес в структуре.
//
Функция РазложитьАдрес(Знач СтрокаАдрес)
	
	Индекс = "";
	КодРегион = "";
	Район = "";
	Город = "";
	НаселПункт = "";
	Улица = "";
	Дом = "";
	Корпус = "";
	Кварт = "";

	МассивАдрес = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрокаАдрес);
	ЭлементовВМассиве = МассивАдрес.Количество();

	Если ЭлементовВМассиве > 0 Тогда
		Индекс = СокрЛП(МассивАдрес[0]);
	КонецЕсли;
	Если ЭлементовВМассиве > 1 Тогда
		КодРегион = СокрЛП(МассивАдрес[1]);
	КонецЕсли;
	Если ЭлементовВМассиве > 2 Тогда
		Район = СокрЛП(МассивАдрес[2]);
	КонецЕсли;
	Если ЭлементовВМассиве > 3 Тогда
		Город = СокрЛП(МассивАдрес[3]);
	КонецЕсли;
	Если ЭлементовВМассиве > 4 Тогда
		НаселПункт = СокрЛП(МассивАдрес[4]);
	КонецЕсли;
	Если ЭлементовВМассиве > 5 Тогда
		Улица = СокрЛП(МассивАдрес[5]);
	КонецЕсли;
	Если ЭлементовВМассиве > 6 Тогда
		Дом = СокрЛП(МассивАдрес[6]);
	КонецЕсли;
	Если ЭлементовВМассиве > 7 Тогда
		Корпус = СокрЛП(МассивАдрес[7]);
	КонецЕсли;
	Если ЭлементовВМассиве > 8 Тогда
		Кварт = СокрЛП(МассивАдрес[8]);
	КонецЕсли;

	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Индекс", Индекс);
	СтруктураВозврата.Вставить("КодРегион", КодРегион);
	СтруктураВозврата.Вставить("Район", Район);
	СтруктураВозврата.Вставить("Город", Город);
	СтруктураВозврата.Вставить("НаселПункт", НаселПункт);
	СтруктураВозврата.Вставить("Улица", Улица);
	СтруктураВозврата.Вставить("Дом", Дом);
	СтруктураВозврата.Вставить("Корпус", Корпус);
	СтруктураВозврата.Вставить("Кварт", Кварт);
	
	Возврат СтруктураВозврата;
	
КонецФункции

// Структура настроек Такском
// 
// Возвращаемое значение:
//  Структура - параметра настроек Такском.
//
Функция СтруктураНастроекТакском()
	
	СтруктураНастроек = Новый Структура;
	
	СтруктураНастроек.Вставить("Наименование", НСтр("ru ='ООО Такском'"));
	СтруктураНастроек.Вставить("АдресВебСервиса", "https://1C-api.taxcom.ru/v1.2/API/");
	СтруктураНастроек.Вставить("ИНН", "7704211201");
	СтруктураНастроек.Вставить("ИдентификаторОператора", "2AL");
	
	Возврат СтруктураНастроек;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД ТОРГ12(ответный титул).
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьИнформациюПокупателяУКДXML(ДеревоДанных)
	
	ПространствоИменСхемы = "ON_KORSCHFDOPPOK";
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПол", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор.СвОЭДОтпр", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИдЭДО",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, "СвОЭДОтпр", СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		ИнфПок = ПолучитьОбъектТипаCML("Файл.ИнфПок", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(ИнфПок, "КНД", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "КНД"), Истина, Ошибки);
		ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок"));
		ЗаполнитьСвойствоXDTO(ИнфПок, "ДатаИнфПок", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИнфПок, "ВремИнфПок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИнфПок, "НаимЭконСубСост",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИнфПок, "ОснДоверОргСост",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаДоверенность"), , Ошибки);
		
		ИдИнфПрод = ПолучитьОбъектТипаCML("Файл.ИнфПок.ИдИнфПрод", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(ИдИнфПрод, "ИдФайлИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайлаИнфПр"), Истина, Ошибки);
		ДатаДокИнфПр = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФайлаИнфПр"));
		ЗаполнитьСвойствоXDTO(ИдИнфПрод, "ДатаФайлИнфПр", ДатаДокИнфПр, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИдИнфПрод, "ВремФайлИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремФайлаИнфПр"), Истина, Ошибки);
		
		Подписи = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолученныеЭП");
		Если Не ЗначениеЗаполнено(Подписи) Тогда
			Подписи = Новый Массив;
			Подписи.Добавить("---");
		КонецЕсли;
		Для Каждого Подпись Из Подписи Цикл
			ИдИнфПрод.ЭП.Добавить(Подпись);
		КонецЦикла;
		
		ЗаполнитьСвойствоXDTO(ИнфПок, "ИдИнфПрод", ИдИнфПрод, Истина, Ошибки);
		
		СодФХЖ4 = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "НаимДокОпрПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "НаименованиеДокументаОтправителя"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "ФункцияПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "НомДокИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИнфПр"), , Ошибки);
		ДатаИнформацииПродавца = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИнфПр"));
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "ДатаДокИнфПр", ДатаИнформацииПродавца, Истина, Ошибки);
		
		СвСоглас = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.СвСоглас", ПространствоИменСхемы);
		ДатаСогласования = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаСогласования"));
		ЗаполнитьСвойствоXDTO(СвСоглас, "ДатаСоглас", ДатаСогласования, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвСоглас, "СодОпер",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "СвСоглас", СвСоглас, Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеДокументаПолучения")) Тогда
			ИнфПолФХЖ4 = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.ИнфПолФХЖ4", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(ИнфПолФХЖ4, "ИдФайлИнфПол",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеДокументаПолучения.ИдентификаторФайла"), , Ошибки);
			
			СтрокиДопДанныеДокументаПолучения = ДеревоДанных.Строки.Найти("ДопДанныеДокументаПолучения", "ПолныйПуть");
			СтрокаТаблицы = СтрокиДопДанныеДокументаПолучения.Строки.Найти("ДопДанныеДокументаПолучения.ТекстоваяИнформация", "ПолныйПуть");
			Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
				Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
					ТекстИнф = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.ИнфПолФХЖ4.ТекстИнф", ПространствоИменСхемы);
					
					ЗаполнитьСвойствоXDTO(ТекстИнф, "Идентиф",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеДокументаПолучения.ТекстоваяИнформация.НомерСтроки.Идентификатор"), Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(ТекстИнф, "Значен",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеДокументаПолучения.ТекстоваяИнформация.НомерСтроки.Значение"), Истина, Ошибки);
					
					ИнфПолФХЖ4.ТекстИнф.Добавить(ТекстИнф);
				КонецЦикла;
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СодФХЖ4, "ИнфПолФХЖ4", ИнфПолФХЖ4, Истина, Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ИнфПок, "СодФХЖ4", СодФХЖ4, Истина, Ошибки);
		
		// Сведения о лице, подписывающем файл обмена.
		Подписант = ПолучитьОбъектТипаCML("Файл.ИнфПок.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", "3", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", "1", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолн", "Должностные обязанности", Истина, Ошибки);
		
		ФЛ = ПолучитьОбъектТипаCML("Файл.ИнфПок.Подписант.ФЛ", ПространствоИменСхемы);
		ФИО = ПолучитьОбъектТипаCML("Файл.ИнфПок.Подписант.ФЛ.ФИО", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", "-", , Ошибки);
		ЗаполнитьСвойствоXDTO(ФИО, "Имя", "-", , Ошибки);
		ЗаполнитьСвойствоXDTO(ФЛ, "ФИО", ФИО, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ФЛ", ФЛ, Истина, Ошибки);
		
		ИнфПок.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "ИнфПок", ИнфПок, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД УПД.
//
// Параметры:
//  СтруктураПараметров - структура параметров для формирования.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьИнформациюПродавцаXML(ДеревоДанных)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ИдФайл", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"));
	
	ВерсияФормата = "5.01";
	ПространствоИменСхемы = "ON_SCHFDOPPR";
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Техническая информация по документу.
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ВерсияФормата, Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПол", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор.СвОЭДОтпр", ПространствоИменСхемы);
		НаимОрг = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг");
		ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг", НаимОрг, Истина, Ошибки);
		ИННЮЛ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ");
		ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ", ИННЮЛ, Истина, Ошибки);
		ИдЭДО = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО");
		ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИдЭДО", ИдЭДО, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "СвОЭДОтпр",СвОЭДОтпр, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "КНД"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "Функция", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ПоФактХЖ", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПоФактХЖ"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "НаимДокОпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НаименованиеДокументаОтправителя"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ДатаИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ВремИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "НаимЭконСубСост", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ОснДоверОргСост", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаДоверенность"), , Ошибки);
		
		// Сведения о счете-фактуре.
		ДанныеСчетаФактуры = ПолучитьОбъектТипаCML("Файл.Документ.СвСчФакт", ПространствоИменСхемы);
		
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента");
		ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
		КодВалюты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод");
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "НомерСчФ", НомерДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ДатаСчФ", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "КодОКВ", КодВалюты, Истина, Ошибки);
		
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
		ДатаДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления");
		Если ЗначениеЗаполнено(НомерДок) И ЗначениеЗаполнено(ДатаДок) Тогда
			ДатаДок = ДатаДД_ММ_ГГГГ(ДатаДок);
			ИспрСчФ = ПолучитьОбъектТипаCML("Файл.Документ.СвСчФакт.ИспрСчФ", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ИспрСчФ, "НомИспрСчФ", НомерДок, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ИспрСчФ, "ДатаИспрСчФ", ДатаДок, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры,"ИспрСчФ", ИспрСчФ, , Ошибки);
		КонецЕсли;
		
		СвПрод = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ЗаполнитьСведенияОбУчастникеУПД(СвПрод, ДеревоДанных, Ошибки, ПространствоИменСхемы, "СведенияОПродавце");
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "СвПрод", СвПрод, Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОГрузоотправителе")) Тогда
			ГрузОт = ПолучитьОбъектТипаCML("Файл.Документ.СвСчФакт.ГрузОт", ПространствоИменСхемы);
			Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОГрузоотправителе") = "ОнЖе" Тогда
				ЗаполнитьСвойствоXDTO(ГрузОт, "ОнЖе", НСтр("ru = 'он же'"), , Ошибки);
			Иначе
				ГрузОтпр = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
				ЗаполнитьСведенияОбУчастникеУПД(ГрузОтпр, ДеревоДанных, Ошибки, ПространствоИменСхемы, "СведенияОГрузоотправителе.Грузоотправитель");
				ЗаполнитьСвойствоXDTO(ГрузОт, "ГрузОтпр", ГрузОтпр, Истина, Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ГрузОт", ГрузОт, Истина, Ошибки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОГрузополучателе")) Тогда
			ГрузПолуч = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
			ЗаполнитьСведенияОбУчастникеУПД(ГрузПолуч, ДеревоДанных, Ошибки, ПространствоИменСхемы, "СведенияОГрузополучателе");
			ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ГрузПолуч", ГрузПолуч, Истина, Ошибки);
		КонецЕсли;
		
		СвПокуп = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ЗаполнитьСведенияОбУчастникеУПД(СвПокуп, ДеревоДанных, Ошибки, ПространствоИменСхемы, "СведенияОПокупателе");
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "СвПокуп", СвПокуп, Истина, Ошибки);
		
		СтрокаТаблицы = ДеревоДанных.Строки.Найти("ПлатежноРасчетныеДокументы", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого ПРД Из СтрокаТаблицы.Строки Цикл
				СвПРД = ПолучитьОбъектТипаCML("Файл.Документ.СвСчФакт.СвПРД", ПространствоИменСхемы);
				
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ПРД, "ПлатежноРасчетныеДокументы.НомерСтроки.НомерПРД");
				ЗаполнитьСвойствоXDTO(СвПРД, "НомерПРД", Реквизит, Истина, Ошибки);
				Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ПРД, "ПлатежноРасчетныеДокументы.НомерСтроки.ДатаПРД"));
				ЗаполнитьСвойствоXDTO(СвПРД, "ДатаПРД", Реквизит, Истина, Ошибки);
				ДанныеСчетаФактуры.СвПРД.Добавить(СвПРД);
			КонецЦикла;
		КонецЕсли;
		
		ДопСвФХЖ1 = ПолучитьОбъектТипаCML("Файл.Документ.СвСчФакт.ДопСвФХЖ1", ПространствоИменСхемы);
		ЗаполнитьНаименованиеВалютыXML(ДопСвФХЖ1, КодВалюты, Ошибки);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках")) Тогда
			ЗаполнитьСвойствоXDTO(ДопСвФХЖ1, "ИдГосКон",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта"), , Ошибки);
			ЗаполнитьСвойствоXDTO(ДопСвФХЖ1, "КурсВал",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс"), , Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ДопСвФХЖ1", ДопСвФХЖ1, , Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеСчетаФактуры")) Тогда
			ИнфПолФХЖ1 = ПолучитьОбъектТипаCML("Файл.Документ.СвСчФакт.ИнфПолФХЖ1", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(ИнфПолФХЖ1, "ИдФайлИнфПол",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеСчетаФактуры.ИдентификаторФайла"), , Ошибки);
				
			СтрокиДопДанныеСчетаФактуры = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
			СтрокаТаблицы = СтрокиДопДанныеСчетаФактуры.Строки.Найти("ДопДанныеСчетаФактуры.ТекстоваяИнформация", "ПолныйПуть");
			Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
				Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
					ТекстИнфТип = ПолучитьОбъектТипаCML("ТекстИнфТип", ПространствоИменСхемы);
					
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Идентиф",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Идентификатор"), Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Значен",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Значение"), Истина, Ошибки);
					
					ИнфПолФХЖ1.ТекстИнф.Добавить(ТекстИнфТип);
				КонецЦикла;
				
				ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ИнфПолФХЖ1", ИнфПолФХЖ1, , Ошибки);
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Документ, "СвСчФакт", ДанныеСчетаФактуры, Истина, Ошибки);
		
		// Сведения таблицы счета-фактуры.
		ТабличнаяЧасть = ПолучитьОбъектТипаCML("Файл.Документ.ТаблСчФакт", ПространствоИменСхемы);
		ВсеСтрокиБезНДС = Истина;
		
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
			СведенияОТоваре = ПолучитьОбъектТипаCML("Файл.Документ.ТаблСчФакт.СведТов", ПространствоИменСхемы);
			
			// Обязательные реквизиты:
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "НомСтр", Товар.Значение, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ТоварНаименование");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "НаимТов", Реквизит, Истина, Ошибки);
			
			РеквизитСтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
			СтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия( , РеквизитСтавкаНДС);
			СтавкаXDTO = СтавкаНДСXDTO(СтавкаНДС);
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "НалСт", СтавкаXDTO, Истина, Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СтТовУчНал", Реквизит, Истина, Ошибки);
			
			СумАкцизТип = ПолучитьОбъектТипаCML("СумАкцизТип", ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаАкциза");
			Если НЕ ЗначениеЗаполнено(Реквизит) Тогда
				ЗаполнитьСвойствоXDTO(СумАкцизТип, "БезАкциз", НСтр("ru ='без акциза'"), Истина, Ошибки);
			Иначе
				ЗаполнитьСвойствоXDTO(СумАкцизТип, "СумАкциз", Реквизит, Истина, Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "Акциз", СумАкцизТип, Истина, Ошибки);
			
			СумНДСТип = ПолучитьОбъектТипаCML("СумНДСТип", ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаНалога");
			Если НЕ ЗначениеЗаполнено(Реквизит) И ВРег(СтавкаНДС) = ВРег("без НДС") Тогда
				ЗаполнитьСвойствоXDTO(СумНДСТип, "БезНДС", НСтр("ru = 'без НДС'"), Истина, Ошибки);
			Иначе
				ВсеСтрокиБезНДС = Ложь;
				ЗаполнитьСвойствоXDTO(СумНДСТип, "СумНал", Реквизит, Истина, Ошибки, Истина);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СумНал", СумНДСТип, Истина, Ошибки);
			
			// Необязательные реквизиты:
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКод");
			КодЕдиницыИзмерения = Реквизит;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ОКЕИ_Тов", СокрЛП(Реквизит), , Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.Количество");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "КолТов", Реквизит, , Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ЦенаТов", Реквизит, , Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СтТовБезНДС", Реквизит, , Ошибки);
			
			КодСтраны = "";
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации");
			Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
				СтрокиТД = Товар.Строки.Найти("СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации", "ПолныйПуть", Истина);
				Для Каждого СтрокаТД Из СтрокиТД.Строки Цикл
					СвТД = ПолучитьОбъектТипаCML("Файл.Документ.ТаблСчФакт.СведТов.СвТД", ПространствоИменСхемы);
					КодСтраны = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаТД, "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.СтранаПроисхожденияКод");
					НомерТД = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаТД, "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.ТаможеннаяДекларацияНомер");
					ЗаполнитьСвойствоXDTO(СвТД, "КодПроисх", КодСтраны, Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(СвТД, "НомерТД", НомерТД, Истина, Ошибки);
					СведенияОТоваре.СвТД.Добавить(СвТД);
				КонецЦикла;
			КонецЕсли;
			
			ДопСведТов = ПолучитьОбъектТипаCML("Файл.Документ.ТаблСчФакт.СведТов.ДопСведТов", ПространствоИменСхемы);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.Признак");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "ПрТовРаб", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ПризнакДополнительнаяИнформация");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "ДопПризн", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ТоварКод");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "КодТов", Реквизит, , Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияНаименование");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "НаимЕдИзм", Реквизит, , Ошибки);
			
			Если ЗначениеЗаполнено(КодСтраны) Тогда
				ДанныеСтраныПоКлассификатору = ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеКлассификатораСтранМираПоКоду(КодСтраны);
				Если ДанныеСтраныПоКлассификатору <> Неопределено Тогда
					ЗаполнитьСвойствоXDTO(ДопСведТов, "КрНаимСтрПр", ДанныеСтраныПоКлассификатору.Наименование, , Ошибки);
				ИначеЕсли КодСтраны = "980" Тогда
					ЗаполнитьСвойствоXDTO(ДопСведТов, "КрНаимСтрПр", НСтр("ru = 'Евросоюз'"), , Ошибки);
				ИначеЕсли КодСтраны = "981" Тогда
					ЗаполнитьСвойствоXDTO(ДопСведТов, "КрНаимСтрПр", НСтр("ru = 'ЕАЭС'"), , Ошибки);
				КонецЕсли;
			КонецЕсли;
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.КоличествоНадлежитОтпустить");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "НадлОтп", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.КорреспондирующиеСчетаДебет");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "КорСчДебет", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.КорреспондирующиеСчетаКредит");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "КорСчКредит", Реквизит, , Ошибки);
			
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ДопСведТов", ДопСведТов, Истина, Ошибки);
			
			СтрокаТаблицы = Товар.Строки.Найти("СведенияОТоварах.НомерСтроки.ТекстоваяИнформация", "ПолныйПуть");
			Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
				Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
					ТекстИнфТип = ПолучитьОбъектТипаCML("ТекстИнфТип", ПространствоИменСхемы);
					
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Идентиф",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Идентификатор"), Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Значен",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Значение"), Истина, Ошибки);
					
					СведенияОТоваре.ИнфПолФХЖ2.Добавить(ТекстИнфТип);
				КонецЦикла;
			КонецЕсли;
			ТабличнаяЧасть.СведТов.Добавить(СведенияОТоваре);
		КонецЦикла;
		
		ВсегоОпл = ПолучитьОбъектТипаCML("Файл.Документ.ТаблСчФакт.ВсегоОпл", ПространствоИменСхемы);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровБезНалога");
		ЗаполнитьСвойствоXDTO(ВсегоОпл, "СтТовБезНДСВсего", Реквизит, , Ошибки);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом");
		ЗаполнитьСвойствоXDTO(ВсегоОпл, "СтТовУчНалВсего", Реквизит, Истина, Ошибки);
		
		СумНДСТип = ПолучитьОбъектТипаCML("СумНДСТип", ПространствоИменСхемы);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоСуммаНалога");
		Если Не ЗначениеЗаполнено(Реквизит) И ВсеСтрокиБезНДС Тогда
			ЗаполнитьСвойствоXDTO(СумНДСТип, "БезНДС", НСтр("ru = 'без НДС'"), Истина, Ошибки);
		Иначе
			ЗначениеСумНДСТип = Формат(Реквизит, "ЧДЦ=2; ЧРД=.; ЧГ=; ЧН=");
			ЗаполнитьСвойствоXDTO(СумНДСТип, "СумНал", ЗначениеСумНДСТип, Истина, Ошибки, Истина);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ВсегоОпл, "СумНалВсего", СумНДСТип, Истина, Ошибки);
		
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоКОплате.ВсегоКоличество");
		ЗаполнитьСвойствоXDTO(ВсегоОпл, "НеттоВс", Реквизит, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ТабличнаяЧасть, "ВсегоОпл", ВсегоОпл, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ТаблСчФакт", ТабличнаяЧасть, Истина, Ошибки);
		
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция") <> "СЧФ" Тогда
			
			// Сведения о факте отгрузки товаров.
			ДанныеОбОтгрузкеТоваров = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер", ПространствоИменСхемы);
			ОтгрузкаТоваров = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(ОтгрузкаТоваров, "СодОпер",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ОтгрузкаТоваров, "ВидОпер",
				XMLСтрока(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидОперации")), , Ошибки);
			ДатаОтгрузкиТоваров = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаОтгрузкиТоваров"));
			ЗаполнитьСвойствоXDTO(ОтгрузкаТоваров, "ДатаПер", ДатаОтгрузкиТоваров, , Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОснованиеОтгрузкиТоваров");
			Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
				СтрокаТаблицы = ДеревоДанных.Строки.Найти("ОснованиеОтгрузкиТоваров", "ПолныйПуть");
				Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
					Для Каждого Основание Из СтрокаТаблицы.Строки Цикл
						ОснПер = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.ОснПер", ПространствоИменСхемы);
						
						ЗаполнитьСвойствоXDTO(ОснПер, "НаимОсн",
							ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
							"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНаименование"), Истина, Ошибки);
						ЗаполнитьСвойствоXDTO(ОснПер, "НомОсн",
							ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
							"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНомер"), , Ошибки);
						ДокументДата = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
							"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументДата"));
						ЗаполнитьСвойствоXDTO(ОснПер, "ДатаОсн", ДокументДата, , Ошибки);
						ЗаполнитьСвойствоXDTO(ОснПер, "ДопСвОсн",
							ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
							"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументДопСведения"), , Ошибки);
						
						ОтгрузкаТоваров.ОснПер.Добавить(ОснПер);
					КонецЦикла;
				КонецЕсли;
			Иначе
				ОснПер = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.ОснПер", ПространствоИменСхемы);
				ЗаполнитьСвойствоXDTO(ОснПер, "НаимОсн", "Отсутствует", Истина, Ошибки);
				ОтгрузкаТоваров.ОснПер.Добавить(ОснПер);
			КонецЕсли;
			
			ТранГруз = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.ТранГруз", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ТранГруз, "СвТранГруз",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОТранспортировке"), , Ошибки);
				
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары")) Тогда
				
				СвЛицПер = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвЛицПер", ПространствоИменСхемы);
				Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары") = "РаботникОрганизацииПродавца" Тогда
					
					РабОргПрод = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод", ПространствоИменСхемы);
					
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Должность");
					ЗаполнитьСвойствоXDTO(РабОргПрод, "Должность", Реквизит, Истина, Ошибки);
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ИныеСведения");
					ЗаполнитьСвойствоXDTO(РабОргПрод, "ИныеСвед", Реквизит, , Ошибки);
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ОснованиеПолномочий");
					ЗаполнитьСвойствоXDTO(РабОргПрод, "ОснПолн", Реквизит, , Ошибки);
					
					ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
					Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Фамилия");
					ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
					Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Имя");
					ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
					Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Отчество");
					ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
					ЗаполнитьСвойствоXDTO(РабОргПрод, "ФИО", ФИО,  , Ошибки);
					
					ЗаполнитьСвойствоXDTO(СвЛицПер, "РабОргПрод", РабОргПрод, , Ошибки);
					
				ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары") = "ИноеЛицо" Тогда
					
					ИнЛицо = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо", ПространствоИменСхемы);
					Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ПредставительОрганизации" Тогда
						ПредОргПер = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер", ПространствоИменСхемы);
						
						Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Должность");
						ЗаполнитьСвойствоXDTO(ПредОргПер, "Должность", Реквизит, Истина, Ошибки);
						Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ИныеСведения");
						ЗаполнитьСвойствоXDTO(ПредОргПер, "ИныеСвед", Реквизит, , Ошибки);
						Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.НаименованиеОрганизации");
						ЗаполнитьСвойствоXDTO(ПредОргПер, "НаимОргПер", Реквизит, Истина, Ошибки);
						Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ДоверенностьНаОтгрузку");
						ЗаполнитьСвойствоXDTO(ПредОргПер, "ОснДоверОргПер", Реквизит, , Ошибки);
						Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ОснованиеПолномочий");
						ЗаполнитьСвойствоXDTO(ПредОргПер, "ОснПолнПредПер", Реквизит, , Ошибки);
						
						ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
						Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия");
						ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
						Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Имя");
						ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
						Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество");
						ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
						ЗаполнитьСвойствоXDTO(ПредОргПер, "ФИО", ФИО,  , Ошибки);
							
						ЗаполнитьСвойствоXDTO(ИнЛицо, "ПредОргПер", ПредОргПер, , Ошибки);
					ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ФЛ" Тогда
						ФЛПер = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер", ПространствоИменСхемы);
						
						Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ИныеСведения");
						ЗаполнитьСвойствоXDTO(ФЛПер, "ИныеСвед", Реквизит, , Ошибки);
						Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ДоверенностьНаОтгрузку");
						ЗаполнитьСвойствоXDTO(ФЛПер, "ОснДоверФЛ", Реквизит, , Ошибки);
						
						ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
						Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия");
						ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
						Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя");
						ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
						Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
							"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество");
						ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
						ЗаполнитьСвойствоXDTO(ФЛПер, "ФИО", ФИО,  , Ошибки);
						
						ЗаполнитьСвойствоXDTO(ИнЛицо, "ФЛПер", ФЛПер, , Ошибки);
						
					КонецЕсли;
					ЗаполнитьСвойствоXDTO(СвЛицПер, "ИнЛицо", ИнЛицо, , Ошибки);
					
				КонецЕсли;
				
				ЗаполнитьСвойствоXDTO(ОтгрузкаТоваров, "СвЛицПер", СвЛицПер, , Ошибки);
				
			КонецЕсли;
				
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ТранспортнаяНакладная");
			Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
				СтрокаТаблицы = ДеревоДанных.Строки.Найти("ТранспортнаяНакладная", "ПолныйПуть");
				Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
					Для Каждого Накладная Из СтрокаТаблицы.Строки Цикл
						ТранНакл = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.ТранГруз.ТранНакл", ПространствоИменСхемы);
						
						ЗаполнитьСвойствоXDTO(ТранНакл, "НомТранНакл",
							ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Накладная,
							"ТранспортнаяНакладная.НомерСтроки.ТранспортнаяНакладнаяНомер"), Истина, Ошибки);
						ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Накладная,
							"ТранспортнаяНакладная.НомерСтроки.ТранспортнаяНакладнаяДата"));
						ЗаполнитьСвойствоXDTO(ТранНакл, "ДатаТранНакл", ДатаДок, Истина, Ошибки);
							
						ТранГруз.ТранНакл.Добавить(ТранНакл);
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОПеревозчике")) Тогда
				Перевозчик = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
				ЗаполнитьСведенияОбУчастникеУПД(Перевозчик, ДеревоДанных, Ошибки, ПространствоИменСхемы, "СведенияОПеревозчике");
				ЗаполнитьСвойствоXDTO(ТранГруз, "Перевозчик", Перевозчик, Истина, Ошибки);
			КонецЕсли;
			
			ЗаполнитьСвойствоXDTO(ОтгрузкаТоваров, "ТранГруз", ТранГруз, , Ошибки);
			
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОПередачеВещи")) Тогда
				СвПерВещи = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвПерВещи", ПространствоИменСхемы);
				
				ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОПередачеВещи.ПередачаВещиДата"));
				ЗаполнитьСвойствоXDTO(СвПерВещи, "ДатаПерВещ", ДатаДок, , Ошибки);
				ЗаполнитьСвойствоXDTO(СвПерВещи, "СвПерВещ",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОПередачеВещи.ПередачаВещиСведения"), , Ошибки);
					
				ЗаполнитьСвойствоXDTO(ОтгрузкаТоваров, "СвПерВещи", СвПерВещи, , Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(ДанныеОбОтгрузкеТоваров, "СвПер", ОтгрузкаТоваров, Истина, Ошибки);
			
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеДокументаОтгрузки")) Тогда
				ИнфПолФХЖ3 = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.ИнфПолФХЖ3", ПространствоИменСхемы);
				
				ЗаполнитьСвойствоXDTO(ИнфПолФХЖ3, "ИдФайлИнфПол",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеДокументаОтгрузки.ИдентификаторФайла"), , Ошибки);
				
				СтрокиДопДанныеДокументаОтгрузки = ДеревоДанных.Строки.Найти("ДопДанныеДокументаОтгрузки", "ПолныйПуть");
				СтрокаТаблицы = СтрокиДопДанныеДокументаОтгрузки.Строки.Найти("ДопДанныеДокументаОтгрузки.ТекстоваяИнформация", "ПолныйПуть");
				Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
					Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
						ТекстИнфТип = ПолучитьОбъектТипаCML("ТекстИнфТип", ПространствоИменСхемы);
						
						ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Идентиф",
							ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
							"ДопДанныеДокументаОтгрузки.ТекстоваяИнформация.НомерСтроки.Идентификатор"), Истина, Ошибки);
						ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Значен",
							ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
							"ДопДанныеДокументаОтгрузки.ТекстоваяИнформация.НомерСтроки.Значение"), Истина, Ошибки);
						
						ИнфПолФХЖ3.ТекстИнф.Добавить(ТекстИнфТип);
					КонецЦикла;
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(ДанныеОбОтгрузкеТоваров, "ИнфПолФХЖ3", ИнфПолФХЖ3, Истина, Ошибки);
			КонецЕсли;
			
			ЗаполнитьСвойствоXDTO(Документ, "СвПродПер", ДанныеОбОтгрузкеТоваров, Истина, Ошибки);
		КонецЕсли;
		
		// Сведения о лице, подписывающем файл обмена.
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", "5", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", "1", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолн", "Должностные обязанности", Истина, Ошибки);
		
		// В подписанте пустым значением заполняется поле Физ.лицо.
		ЗаполнитьФизЛицоПодписанта(Подписант, ПространствоИменСхемы, Ошибки);
		
		Документ.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		Файл.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ВызватьИсключение ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
		УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
		Возврат Истина;
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), ТекстСообщения);
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД ТОРГ12(ответный титул).
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьИнформациюПокупателяXML(ДеревоДанных)
	
	ПространствоИменСхемы = "ON_SCHFDOPPOK";
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПол", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор.СвОЭДОтпр", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИдЭДО",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, "СвОЭДОтпр", СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		ИнфПок = ПолучитьОбъектТипаCML("Файл.ИнфПок", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(ИнфПок, "КНД", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "КНД"), Истина, Ошибки);
		ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок"));
		ЗаполнитьСвойствоXDTO(ИнфПок, "ДатаИнфПок", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИнфПок, "ВремИнфПок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ВремДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИнфПок, "НаимЭконСубСост",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, "СоставительДокументаНаименование"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИнфПок, "ОснДоверОргСост",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, "СоставительДокументаДоверенность"), , Ошибки);
		
		ИдИнфПрод = ПолучитьОбъектТипаCML("Файл.ИнфПок.ИдИнфПрод", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(ИдИнфПрод, "ИдФайлИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ИдФайлаИнфПр"), Истина, Ошибки);
		ДатаДокИнфПр = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ДатаФайлаИнфПр"));
		ЗаполнитьСвойствоXDTO(ИдИнфПрод, "ДатаФайлИнфПр", ДатаДокИнфПр, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИдИнфПрод, "ВремФайлИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ВремФайлаИнфПр"), Истина, Ошибки);
		
		Подписи = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолученныеЭП");
		Если Не ЗначениеЗаполнено(Подписи) Тогда
			Подписи = Новый Массив;
			Подписи.Добавить("---");
		КонецЕсли;
		Для Каждого Подпись Из Подписи Цикл
			ИдИнфПрод.ЭП.Добавить(Подпись);
		КонецЦикла;
		
		ЗаполнитьСвойствоXDTO(ИнфПок, "ИдИнфПрод", ИдИнфПрод, Истина, Ошибки);
		
		СодФХЖ4 = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "НаимДокОпрПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "НаименованиеДокументаОтправителя"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "Функция", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "Функция"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "НомСчФИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "НомерИнфПр"), , Ошибки);
		ДатаИнформацииПродавца = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ДатаИнфПр"));
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "ДатаСчФИнфПр", ДатаИнформацииПродавца, Истина, Ошибки);
		
		СвПрин = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.СвПрин", ПространствоИменСхемы);
		ДатаПолучения = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаПолученияТоваров"));
		ЗаполнитьСвойствоXDTO(СвПрин, "ДатаПрин", ДатаПолучения, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвПрин, "СодОпер",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации"), Истина, Ошибки);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары")) Тогда
			
			СвЛицПрин = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин", ПространствоИменСхемы);
			Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары") = "РаботникОрганизацииПокупателя" Тогда
				
				РабОргПок = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок", ПространствоИменСхемы);
				
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Должность");
				ЗаполнитьСвойствоXDTO(РабОргПок, "Должность", Реквизит, Истина, Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.ИныеСведения");
				ЗаполнитьСвойствоXDTO(РабОргПок, "ИныеСвед", Реквизит, , Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.ОснованиеПолномочий");
				ЗаполнитьСвойствоXDTO(РабОргПок, "ОснПолн", Реквизит, , Ошибки);
				
				ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
				Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Фамилия");
				ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
				Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Имя");
				ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
				Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Отчество");
				ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
				ЗаполнитьСвойствоXDTO(РабОргПок, "ФИО", ФИО,  , Ошибки);
				
				ЗаполнитьСвойствоXDTO(СвЛицПрин, "РабОргПок", РабОргПок, , Ошибки);
				
			ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары") = "ИноеЛицо" Тогда
				
				ИнЛицо = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо", ПространствоИменСхемы);
				Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары.ИноеЛицо") = "ПредставительОрганизации" Тогда
					ПредОргПрин = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ПредОргПрин", ПространствоИменСхемы);
					
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Должность");
					ЗаполнитьСвойствоXDTO(ПредОргПрин, "Должность", Реквизит, Истина, Ошибки);
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.ИныеСведения");
					ЗаполнитьСвойствоXDTO(ПредОргПрин, "ИныеСвед", Реквизит, , Ошибки);
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.НаименованиеОрганизации");
					ЗаполнитьСвойствоXDTO(ПредОргПрин, "НаимОргПрин", Реквизит, Истина, Ошибки);
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.ДоверенностьНаПринятие");
					ЗаполнитьСвойствоXDTO(ПредОргПрин, "ОснДоверОргПрин", Реквизит, , Ошибки);
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.ОснованиеПолномочий");
					ЗаполнитьСвойствоXDTO(ПредОргПрин, "ОснПолнПредПрин", Реквизит, , Ошибки);
					
					ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
					Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия");
					ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
					Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Имя");
					ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
					Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество");
					ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
					ЗаполнитьСвойствоXDTO(ПредОргПрин, "ФИО", ФИО,  , Ошибки);
					
					ЗаполнитьСвойствоXDTO(ИнЛицо, "ПредОргПрин", ПредОргПрин, , Ошибки);
				ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары.ИноеЛицо") = "ФЛ" Тогда
					ФЛПрин = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ФЛПрин", ПространствоИменСхемы);
					
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.ИныеСведения");
					ЗаполнитьСвойствоXDTO(ФЛПрин, "ИныеСвед", Реквизит, , Ошибки);
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.ДоверенностьНаПринятие");
					ЗаполнитьСвойствоXDTO(ФЛПрин, "ОснДоверФЛ", Реквизит, , Ошибки);
					
					ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
					Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Фамилия");
					ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
					Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Имя");
					ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
					Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Отчество");
					ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
					ЗаполнитьСвойствоXDTO(ФЛПрин, "ФИО", ФИО,  , Ошибки);
					
					ЗаполнитьСвойствоXDTO(ИнЛицо, "ФЛПрин", ФЛПрин, , Ошибки);
					
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(СвЛицПрин, "ИнЛицо", ИнЛицо, , Ошибки);
				
			КонецЕсли;
			
			ЗаполнитьСвойствоXDTO(СвПрин, "СвЛицПрин", СвЛицПрин, , Ошибки);
			
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(СодФХЖ4, "СвПрин", СвПрин, Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеДокументаПолучения")) Тогда
			ИнфПолФХЖ4 = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.ИнфПолФХЖ4", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(ИнфПолФХЖ4, "ИдФайлИнфПол",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, "ДопДанныеДокументаПолучения.ИдентификаторФайла"), , Ошибки);
			
			СтрокиДопДанныеДокументаПолучения = ДеревоДанных.Строки.Найти("ДопДанныеДокументаПолучения", "ПолныйПуть");
			СтрокаТаблицы = СтрокиДопДанныеДокументаПолучения.Строки.Найти("ДопДанныеДокументаПолучения.ТекстоваяИнформация", "ПолныйПуть");
			Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
				Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
					ТекстИнф = ПолучитьОбъектТипаCML("Файл.ИнфПок.СодФХЖ4.ИнфПолФХЖ4.ТекстИнф", ПространствоИменСхемы);
					
					ЗаполнитьСвойствоXDTO(ТекстИнф, "Идентиф",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеДокументаПолучения.ТекстоваяИнформация.НомерСтроки.Идентификатор"), Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(ТекстИнф, "Значен",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеДокументаПолучения.ТекстоваяИнформация.НомерСтроки.Значение"), Истина, Ошибки);
					
					ИнфПолФХЖ4.ТекстИнф.Добавить(ТекстИнф);
				КонецЦикла;
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СодФХЖ4, "ИнфПолФХЖ4", ИнфПолФХЖ4, Истина, Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ИнфПок, "СодФХЖ4", СодФХЖ4, Истина, Ошибки);
		
		// Сведения о лице, подписывающем файл обмена.
		Подписант = ПолучитьОбъектТипаCML("Файл.ИнфПок.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", "2", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", "1", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолн", "Должностные обязанности", Истина, Ошибки);
		
		// В подписанте пустым значением заполняется поле Физ.лицо.
		ФЛ = ПолучитьОбъектТипаCML("Файл.ИнфПок.Подписант.ФЛ", ПространствоИменСхемы);
		ФИО = ПолучитьОбъектТипаCML("Файл.ИнфПок.Подписант.ФЛ.ФИО", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", "-", , Ошибки);
		ЗаполнитьСвойствоXDTO(ФИО, "Имя", "-", , Ошибки);
		ЗаполнитьСвойствоXDTO(ФЛ, "ФИО", ФИО, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ФЛ", ФЛ, Истина, Ошибки);
		
		ИнфПок.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "ИнфПок", ИнфПок, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл,
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД УПД.
//
// Параметры:
//  СтруктураПараметров - структура параметров для формирования.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьИнформациюПродавцаУКДXML(ДеревоДанных)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ИдФайл", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"));
	
	ВерсияФормата = "5.01";
	ПространствоИменСхемы = "ON_KORSCHFDOPPR";
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Техническая информация по документу.
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ВерсияФормата, Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПол", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор.СвОЭДОтпр", ПространствоИменСхемы);
		НаимОрг = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг");
		ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг", НаимОрг, Истина, Ошибки);
		ИННЮЛ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ");
		ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ", ИННЮЛ, Истина, Ошибки);
		ИдЭДО = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО");
		ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИдЭДО", ИдЭДО, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "СвОЭДОтпр",СвОЭДОтпр, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "КНД"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "Функция", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ПоФактХЖ", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПоФактХЖ"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "НаимДокОпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НаименованиеДокументаОтправителя"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ДатаИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ВремИнфПр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "НаимЭконСубСост", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ОснДоверОргСост", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаДоверенность"), , Ошибки);
		
		// Сведения о счете-фактуре.
		ДанныеСчетаФактуры = ПолучитьОбъектТипаCML("Файл.Документ.СвКСчФ", ПространствоИменСхемы);
		
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента");
		ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"));
		КодВалюты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод");
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "НомерКСчФ", НомерДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ДатаКСчФ", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "КодОКВ", КодВалюты, Истина, Ошибки);
		
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
		ДатаДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления");
		Если ЗначениеЗаполнено(НомерДок) И ЗначениеЗаполнено(ДатаДок) Тогда
			ДатаДок = ДатаДД_ММ_ГГГГ(ДатаДок);
			ИспрКСчФ = ПолучитьОбъектТипаCML("Файл.Документ.СвКСчФ.ИспрКСчФ", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ИспрКСчФ, "НомИспрКСчФ", НомерДок, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ИспрКСчФ, "ДатаИспрКСчФ", ДатаДок, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры,"ИспрКСчФ", ИспрКСчФ, , Ошибки);
		КонецЕсли;
		
		СчФ = ПолучитьОбъектТипаCML("Файл.Документ.СвКСчФ.СчФ", ПространствоИменСхемы);
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсходногоДокумента");
		ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсходногоДокумента"));
		ЗаполнитьСвойствоXDTO(СчФ, "НомерСчФ", НомерДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СчФ, "ДатаСчФ", ДатаДок, Истина, Ошибки);
		
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправленияИсходногоДокумента");
		ДатаДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправленияИсходногоДокумента");
		
		Если ЗначениеЗаполнено(НомерДок) И ЗначениеЗаполнено(ДатаДок) Тогда
			ДатаДок = ДатаДД_ММ_ГГГГ(ДатаДок);
			ИспрСчФ = ПолучитьОбъектТипаCML("Файл.Документ.СвКСчФ.СчФ.ИспрСчФ", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ИспрСчФ, "НомИспрСчФ", НомерДок, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ИспрСчФ, "ДатаИспрСчФ", ДатаДок, Истина, Ошибки);
			СчФ.ИспрСчФ.Добавить(ИспрСчФ);
		КонецЕсли;
		ДанныеСчетаФактуры.СчФ.Добавить(СчФ);
		
		СвПрод = ПолучитьОбъектТипаCML("СвПродПокТип", ПространствоИменСхемы);
		ЗаполнитьСведенияОбУчастникеУКД(СвПрод, ДеревоДанных, Ошибки, ПространствоИменСхемы, "СведенияОПродавце");
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "СвПрод", СвПрод, Истина, Ошибки);
		
		СвПокуп = ПолучитьОбъектТипаCML("СвПродПокТип", ПространствоИменСхемы);
		ЗаполнитьСведенияОбУчастникеУКД(СвПокуп, ДеревоДанных, Ошибки, ПространствоИменСхемы, "СведенияОПокупателе");
		ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "СвПокуп", СвПокуп, Истина, Ошибки);
		
		ДопСвФХЖ1 = ПолучитьОбъектТипаCML("Файл.Документ.СвКСчФ.ДопСвФХЖ1", ПространствоИменСхемы);
		ЗаполнитьНаименованиеВалютыXML(ДопСвФХЖ1, КодВалюты, Ошибки);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках")) Тогда
			ЗаполнитьСвойствоXDTO(ДопСвФХЖ1, "ИдГосКон",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта"), , Ошибки);
			ЗаполнитьСвойствоXDTO(ДопСвФХЖ1, "КурсВал",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаКурс"), , Ошибки);
		КонецЕсли;
			ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ДопСвФХЖ1", ДопСвФХЖ1, , Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеСчетаФактуры")) Тогда
			ИнфПолФХЖ1 = ПолучитьОбъектТипаCML("Файл.Документ.СвКСчФ.ИнфПолФХЖ1", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(ИнфПолФХЖ1, "ИдФайлИнфПол",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеСчетаФактуры.ИдентификаторФайла"), , Ошибки);
				
			СтрокиДопДанныеСчетаФактуры = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
			СтрокаТаблицы = СтрокиДопДанныеСчетаФактуры.Строки.Найти("ДопДанныеСчетаФактуры.ТекстоваяИнформация", "ПолныйПуть");
			Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
				Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
					ТекстИнфТип = ПолучитьОбъектТипаCML("ТекстИнфТип", ПространствоИменСхемы);
					
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Идентиф",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Идентификатор"), Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Значен",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Значение"), Истина, Ошибки);
					
					ИнфПолФХЖ1.ТекстИнф.Добавить(ТекстИнфТип);
				КонецЦикла;
				
				ЗаполнитьСвойствоXDTO(ДанныеСчетаФактуры, "ИнфПолФХЖ1", ИнфПолФХЖ1, , Ошибки);
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Документ, "СвКСчФ", ДанныеСчетаФактуры, Истина, Ошибки);
		
		// Сведения таблицы счета-фактуры.
		ТабличнаяЧасть = ПолучитьОбъектТипаCML("Файл.Документ.ТаблКСчФ", ПространствоИменСхемы);
		ВсеСтрокиБезНДСДо = Истина; ВсеСтрокиБезНДСПосле = Истина;
		
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
			СведенияОТоваре = ПолучитьОбъектТипаCML("Файл.Документ.ТаблКСчФ.СведТов", ПространствоИменСхемы);
			
			// Обязательные реквизиты:
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "НомСтр", Товар.Значение, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ТоварНаименование");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "НаимТов", Реквизит, Истина, Ошибки);
			
			РеквизитСтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.НалоговаяСтавкаДоКорректировки");
			СтавкаНДСДо = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия( , РеквизитСтавкаНДС);
			СтавкаXDTO = СтавкаНДСXDTO(СтавкаНДСДо);
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "НалСтДо", СтавкаXDTO, Истина, Ошибки);
			РеквизитСтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
			СтавкаНДСПосле = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия( , РеквизитСтавкаНДС);
			СтавкаXDTO = СтавкаНДСXDTO(СтавкаНДСПосле);
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "НалСтПосле", СтавкаXDTO, Истина, Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКодДоКорректировки");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ОКЕИ_ТовДо", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКод");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ОКЕИ_ТовПосле", Реквизит, , Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.КоличествоДоКорректировки");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "КолТовДо", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.Количество");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "КолТовПосле", Реквизит, , Ошибки);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмеренияДоКорректировки");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ЦенаТовДо", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ЦенаТовПосле", Реквизит, , Ошибки);
			
			СумАкцизТип = ПолучитьОбъектТипаCML("СумАкцизТип", ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаАкцизаДоКорректировки");
			Если НЕ ЗначениеЗаполнено(Реквизит) Тогда
				ЗаполнитьСвойствоXDTO(СумАкцизТип, "БезАкциз", НСтр("ru ='без акциза'"), Истина, Ошибки);
			Иначе
				ЗаполнитьСвойствоXDTO(СумАкцизТип, "СумАкциз", Реквизит, Истина, Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "АкцизДо", СумАкцизТип, Истина, Ошибки);
			
			СумАкцизТип = ПолучитьОбъектТипаCML("СумАкцизТип", ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаАкциза");
			Если НЕ ЗначениеЗаполнено(Реквизит) Тогда
				ЗаполнитьСвойствоXDTO(СумАкцизТип, "БезАкциз", НСтр("ru ='без акциза'"), Истина, Ошибки);
			Иначе
				ЗаполнитьСвойствоXDTO(СумАкцизТип, "СумАкциз", Реквизит, Истина, Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "АкцизПосле", СумАкцизТип, Истина, Ошибки);
			
			РазнСумНалТип = ПолучитьОбъектТипаCML("РазнСумНалТип", ПространствоИменСхемы);
			СумУвел = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаАкцизаУвеличение");
			СумУм = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаАкцизаУменьшение");
			Если Не ЗначениеЗаполнено(СумУвел) И Не ЗначениеЗаполнено(СумУм) Тогда
				ЗаполнитьСвойствоXDTO(РазнСумНалТип, "СумУвел", 0, Истина, Ошибки);
			ИначеЕсли ЗначениеЗаполнено(СумУвел) Тогда
				ЗаполнитьСвойствоXDTO(РазнСумНалТип, "СумУвел", Реквизит, Истина, Ошибки);
			ИначеЕсли ЗначениеЗаполнено(СумУм) Тогда
				ЗаполнитьСвойствоXDTO(РазнСумНалТип, "СумУм", Реквизит, Истина, Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "АкцизРазн", РазнСумНалТип, Истина, Ошибки);
			
			СумНДСТип = ПолучитьОбъектТипаCML("СумНДСТип", ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаНалогаДоКорректировки");
			Если НЕ ЗначениеЗаполнено(Реквизит) И ВРег(СтавкаНДСДо) = ВРег("без НДС") Тогда
				ЗаполнитьСвойствоXDTO(СумНДСТип, "БезНДС", НСтр("ru = 'без НДС'"), Истина, Ошибки);
			Иначе
				ВсеСтрокиБезНДСДо = Ложь;
				ЗаполнитьСвойствоXDTO(СумНДСТип, "СумНДС", Реквизит, Истина, Ошибки, Истина);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СумНалДо", СумНДСТип, Истина, Ошибки);
			
			СумНДСТип = ПолучитьОбъектТипаCML("СумНДСТип", ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаНалога");
			Если НЕ ЗначениеЗаполнено(Реквизит) И ВРег(СтавкаНДСПосле) = ВРег("без НДС") Тогда
				ЗаполнитьСвойствоXDTO(СумНДСТип, "БезНДС", НСтр("ru = 'без НДС'"), Истина, Ошибки);
			Иначе
				ВсеСтрокиБезНДСПосле = Ложь;
				ЗаполнитьСвойствоXDTO(СумНДСТип, "СумНДС", Реквизит, Истина, Ошибки ,Истина);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СумНалПосле", СумНДСТип, Истина, Ошибки);
			
			РазнСумНалТип = ПолучитьОбъектТипаCML("РазнСумНалТип", ПространствоИменСхемы);
			СумУвел = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаНалогаУвеличение");
			СумУм = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СуммаНалогаУменьшение");
			Если Не ЗначениеЗаполнено(СумУвел) И Не ЗначениеЗаполнено(СумУм) Тогда
				ЗаполнитьСвойствоXDTO(РазнСумНалТип, "СумУвел", 0, Истина, Ошибки);
				
			ИначеЕсли ЗначениеЗаполнено(СумУвел) Тогда
				ЗаполнитьСвойствоXDTO(РазнСумНалТип, "СумУвел", СумУвел, Истина, Ошибки);
				
			ИначеЕсли ЗначениеЗаполнено(СумУм) Тогда
				ЗаполнитьСвойствоXDTO(РазнСумНалТип, "СумУм", СумУм, Истина, Ошибки);
				
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СумНалРазн", РазнСумНалТип, Истина, Ошибки);
			
			// Стоимость без налога
			СуммаДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалогаДоКорректировки");
			СуммаПосле = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
			Если ЗначениеЗаполнено(СуммаДо) ИЛИ ЗначениеЗаполнено(СуммаПосле) Тогда
				СтоимТип = ПолучитьОбъектТипаCML("СтоимТип", ПространствоИменСхемы);
				ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимДоИзм", СуммаДо, Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимПослеИзм", СуммаПосле, Истина, Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалогаУвеличение");
				Если ЗначениеЗаполнено(Реквизит) Тогда
					ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимУвел", Реквизит, , Ошибки);
				КонецЕсли;
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалогаУменьшение");
				Если ЗначениеЗаполнено(Реквизит) Тогда
					ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимУм", Реквизит, , Ошибки);
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СтТовБезНДС", СтоимТип, , Ошибки);
			КонецЕсли;
			
			// Стоимость с налогом
			СтоимТип = ПолучитьОбъектТипаCML("СтоимТип", ПространствоИменСхемы);
			СуммаДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомДоКорректировки");
			ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимДоИзм", СуммаДо, Истина, Ошибки);
			СуммаПосле = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
			ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимПослеИзм", СуммаПосле, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомУвеличение");
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимУвел", Реквизит, Истина, Ошибки);
			КонецЕсли;
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомУменьшение");
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЗаполнитьСвойствоXDTO(СтоимТип, "СтоимУм", Реквизит, Истина, Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "СтТовУчНал", СтоимТип, Истина, Ошибки);
			
			// Дополнительные сведения о товаре
			ДопСведТов = ПолучитьОбъектТипаCML("Файл.Документ.ТаблКСчФ.СведТов.ДопСведТов", ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.КорреспондирующиеСчетаДебет");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "КорСчДебет", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.КорреспондирующиеСчетаКредит");
			ЗаполнитьСвойствоXDTO(ДопСведТов, "КорСчКредит", Реквизит, , Ошибки);
			ЗаполнитьСвойствоXDTO(СведенияОТоваре, "ДопСведТов", ДопСведТов, Истина, Ошибки);
			
			СтрокаТаблицы = Товар.Строки.Найти("СведенияОТоварах.НомерСтроки.ТекстоваяИнформация", "ПолныйПуть");
			Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
				Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
					ТекстИнфТип = ПолучитьОбъектТипаCML("Файл.Документ.ТаблКСчФ.СведТов.ИнфПолФХЖ2", ПространствоИменСхемы);
					
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Идентиф",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Идентификатор"), Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(ТекстИнфТип, "Значен",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Значение"), Истина, Ошибки);
					
					СведенияОТоваре.ИнфПолФХЖ2.Добавить(ТекстИнфТип);
				КонецЦикла;
			КонецЕсли;
			ТабличнаяЧасть.СведТов.Добавить(СведенияОТоваре);
		КонецЦикла;
		
		// Всего увеличение/уменьшение.
		ВсегоУвел = ПолучитьОбъектТипаCML("Файл.Документ.ТаблКСчФ.ВсегоУвел", ПространствоИменСхемы);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУвеличение");
		ЗаполнитьСвойствоXDTO(ВсегоУвел, "СтТовБезНДСВсего", Реквизит, Истина, Ошибки, Истина);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУвеличение");
		ЗаполнитьСвойствоXDTO(ВсегоУвел, "СтТовУчНалВсего", Реквизит, Истина, Ошибки, Истина);
		
		СумНДСТип = ПолучитьОбъектТипаCML("СумНДСТип", ПространствоИменСхемы);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУвеличение");
		Если Не ЗначениеЗаполнено(Реквизит) И ВсеСтрокиБезНДСДо И ВсеСтрокиБезНДСПосле Тогда
			ЗаполнитьСвойствоXDTO(СумНДСТип, "БезНДС", НСтр("ru = 'без НДС'"), Истина, Ошибки);
		Иначе
			ЗаполнитьСвойствоXDTO(СумНДСТип, "СумНДС", Реквизит, Истина, Ошибки, Истина);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ВсегоУвел, "СумНал", СумНДСТип, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ТабличнаяЧасть, "ВсегоУвел", ВсегоУвел, Истина, Ошибки);
		
		ВсегоУм = ПолучитьОбъектТипаCML("Файл.Документ.ТаблКСчФ.ВсегоУм", ПространствоИменСхемы);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУменьшение");
		ЗаполнитьСвойствоXDTO(ВсегоУм, "СтТовБезНДСВсего", Реквизит, Истина, Ошибки, Истина);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУменьшение");
		ЗаполнитьСвойствоXDTO(ВсегоУм, "СтТовУчНалВсего", Реквизит, Истина, Ошибки, Истина);
		
		СумНДСТип = ПолучитьОбъектТипаCML("СумНДСТип", ПространствоИменСхемы);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУменьшение");
		Если Не ЗначениеЗаполнено(Реквизит) И ВсеСтрокиБезНДСДо И ВсеСтрокиБезНДСПосле Тогда
			ЗаполнитьСвойствоXDTO(СумНДСТип, "БезНДС", НСтр("ru = 'без НДС'"), Истина, Ошибки);
		Иначе
			ЗаполнитьСвойствоXDTO(СумНДСТип, "СумНДС", Реквизит, Истина, Ошибки, Истина);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ВсегоУм, "СумНал", СумНДСТип, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ТабличнаяЧасть, "ВсегоУм", ВсегоУм, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "ТаблКСчФ", ТабличнаяЧасть, Истина, Ошибки);
	
		// Сведения о факте отгрузки товаров.
		ДанныеОбИзмененииСтоимости = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(ДанныеОбИзмененииСтоимости, "СодОпер",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации"), Истина, Ошибки);
		ДатаНаправленияНаСогласование = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ДатаНаправленияНаСогласование"));
		ЗаполнитьСвойствоXDTO(ДанныеОбИзмененииСтоимости, "ДатаНапр", ДатаНаправленияНаСогласование, , Ошибки);
		ЗаполнитьСвойствоXDTO(ДанныеОбИзмененииСтоимости, "ИныеСвИзмСтоим",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИныеСведенияОбИзмененииСтоимости"), , Ошибки);
			
		РеквизитыПередаточныхДокументов = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "РеквизитыПередаточныхДокументов");
		Если РеквизитыПередаточныхДокументов = Неопределено Тогда
			РеквизитыПередаточныхДокументов = "";
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ДанныеОбИзмененииСтоимости, "ПередатДокум", РеквизитыПередаточныхДокументов, Истина, Ошибки);
			
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОснованиеКорректировки");
		Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
			СтрокаТаблицы = ДеревоДанных.Строки.Найти("ОснованиеКорректировки", "ПолныйПуть");
			Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
				Для Каждого Основание Из СтрокаТаблицы.Строки Цикл
					ОснКор = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3.ОснКор", ПространствоИменСхемы);
					
					ЗаполнитьСвойствоXDTO(ОснКор, "НаимОсн",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
						"ОснованиеКорректировки.НомерСтроки.ДокументНаименование"), Истина, Ошибки);
					ЗаполнитьСвойствоXDTO(ОснКор, "НомОсн",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
						"ОснованиеКорректировки.НомерСтроки.ДокументНомер"), , Ошибки);
						
					ДокументДата = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
						"ОснованиеКорректировки.НомерСтроки.ДокументДата"));
					ЗаполнитьСвойствоXDTO(ОснКор, "ДатаОсн", ДокументДата, , Ошибки);
					ЗаполнитьСвойствоXDTO(ОснКор, "ДопСвОсн",
						ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
						"ОснованиеКорректировки.НомерСтроки.ДокументДопСведения"), , Ошибки);
					
					ДанныеОбИзмененииСтоимости.ОснКор.Добавить(ОснКор);
				КонецЦикла;
			КонецЕсли;
		Иначе
			ОснКор = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3.ОснКор", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ОснКор, "НаимОсн", "Отсутствует", Истина, Ошибки);
			ДанныеОбИзмененииСтоимости.ОснКор.Добавить(ОснКор);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(Документ, "СодФХЖ3", ДанныеОбИзмененииСтоимости, Истина, Ошибки);
	
		// Сведения о лице, подписывающем файл обмена.
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", "6", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", "1", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолн", "Должностные обязанности", Истина, Ошибки);
		
		// В подписанте пустым значением заполняется поле Физ.лицо.
		ЗаполнитьФизЛицоПодписанта(Подписант, ПространствоИменСхемы, Ошибки);
		
		Документ.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		Файл.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ВызватьИсключение ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
		УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
		Возврат Истина;
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), ТекстСообщения);
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Формирование электронного документа Передача работ заказчику по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаЭД - Ссылка - объект, по которому необходимо сформировать электронный документ.
//
// Возвращаемое значение: 
//  Структура - параметры данных.
//
Функция СформироватьПередачаРаботЗаказчик(СсылкаНаЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
			
	РеквизитыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаЭД, "НаименованиеФайла, ВладелецФайла,
		|ДатаФормированияЭДОтправителем, ОтправительЭД, ПолучательЭД");
		
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО, НастройкаЭДО, Контрагент,
		|НомерДокументаОтправителя, ДатаДокументаОтправителя, НаименованиеДокументаОтправителя, Организация, СуммаДокумента, ВерсияРегламентаЭДО");
			
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД",                   Перечисления.ВидыЭД.АктЗаказчик);
	СтруктураЭД.Вставить("НаправлениеЭД",           Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("НомерЭД",                 Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("УникальныйИдентификатор", Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("Получатель", РеквизитыФайлаЭД.ОтправительЭД);
	
	СтруктураЭД.Вставить("ДатаЭД",                           ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Отправитель",                      РеквизитыФайлаЭД.ПолучательЭД);
	СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыФайлаЭД.НаименованиеФайла);
	СтруктураЭД.Вставить("ВладелецЭД",                       РеквизитыФайлаЭД.ВладелецФайла);
	СтруктураЭД.Вставить("НомерДокументаОтправителя",        РеквизитыЭД.НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",         РеквизитыЭД.ДатаДокументаОтправителя);
	СтруктураЭД.Вставить("Организация",                      РеквизитыЭД.Организация);
	СтруктураЭД.Вставить("Контрагент",                       РеквизитыЭД.Контрагент);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",               РеквизитыЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",                     РеквизитыЭД.НастройкаЭДО);
	СтруктураЭД.Вставить("ПрефиксИдФайла",                   "DP_REZRUZAK");
	СтруктураЭД.Вставить("КНД",                              "1175013");
	СтруктураЭД.Вставить("СуммаДокумента",                   РеквизитыЭД.СуммаДокумента);
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.Акт501_Заказчик");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоАкт501ЗаказчикФНС(СсылкаНаЭД, СтруктураЭД, ДеревоДокумента, Отказ);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки, Истина);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
		ДобавитьСлужебныеПоляФНС(ДеревоДокумента, СтруктураЭД);
		
		Реквизит = Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДФ=HH.mm.ss");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ВремДокАктИ", Реквизит);
		Реквизит = Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДЛФ=D");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаДокАктИ", Реквизит);
		ВставитьЗначениеВДерево(ДеревоДокумента, "НомерАкт", РеквизитыЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаАкт",  РеквизитыЭД.ДатаДокументаОтправителя);
		
		НаименованиеДокументаОтправителя = РеквизитыЭД.НаименованиеДокументаОтправителя;
		Если Не ЗначениеЗаполнено(НаименованиеДокументаОтправителя) Тогда
			НаименованиеДокументаОтправителя = НаименованиеДокументаПередачаРабот();
		КонецЕсли;
		ВставитьЗначениеВДерево(ДеревоДокумента, "НаименованиеДокументаОтправителя", НаименованиеДокументаОтправителя);
		
		НаименованиеОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РеквизитыЭД.Организация, "Наименование");
		ВставитьЗначениеВДерево(ДеревоДокумента, "НаименованиеОрганизации", НаименованиеОрганизации);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИмяФайлаПродавца", РеквизитыФайлаЭД.НаименованиеФайла);
		
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ПолученныеЭП",
								ЭППолученногоФайла(СсылкаНаЭД));
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаЭД.УникальныйИдентификатор());
		ИдФайл = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, "ИдФайл");
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		
		СтруктураПараметров.Вставить("ПолученныеЭП", ЭППолученногоФайла(СсылкаНаЭД));
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИдФайлАктИ", РеквизитыФайлаЭД.НаименованиеФайла);
		
		Если СформироватьПередачаРаботЗаказчикCML(ДеревоДокумента) Тогда
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(СтруктураПараметров.ПолноеИмяФайла));
			СтруктураЭД.Вставить("ИдФайла", ИдФайл);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			ВозвращаемоеЗначение = СтруктураЭД;
		КонецЕсли;
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаЭД);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Процедура ЗаполнитьФизЛицоПодписанта(Подписант, ПространствоИменСхемы, Ошибки)
	
	ФЛ = ПолучитьОбъектТипаCML("Файл.Документ.Подписант.ФЛ", ПространствоИменСхемы);
	ФИО = ПолучитьОбъектТипаCML("Файл.Документ.Подписант.ФЛ.ФИО", ПространствоИменСхемы);
	ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", "-", , Ошибки);
	ЗаполнитьСвойствоXDTO(ФИО, "Имя", "-", , Ошибки);
	ЗаполнитьСвойствоXDTO(ФЛ, "ФИО", ФИО, Истина, Ошибки);
	ЗаполнитьСвойствоXDTO(Подписант, "ФЛ", ФЛ, Истина, Ошибки);
	
КонецПроцедуры

Процедура ЗаполнитьИППодписанта(Подписант, ПространствоИменСхемы, Ошибки)
	
	ИП = ПолучитьОбъектТипаCML("Файл.Документ.Подписант.ИП", ПространствоИменСхемы);
	ФИО = ПолучитьОбъектТипаCML("Файл.Документ.Подписант.ИП.ФИО", ПространствоИменСхемы);
	ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", "-", , Ошибки);
	ЗаполнитьСвойствоXDTO(ФИО, "Имя", "-", , Ошибки);
	ЗаполнитьСвойствоXDTO(ИП, "ФИО", ФИО, Истина, Ошибки);
	ЗаполнитьСвойствоXDTO(ИП, "ИННФЛ", "011000000000", , Ошибки);
	ЗаполнитьСвойствоXDTO(Подписант, "ИП", ИП, Истина, Ошибки);
	
КонецПроцедуры

Процедура ЗаполнитьСведенияОбУчастникеУПД(УчастникXDTO, СтрокаДереваДанных, Ошибки, ПространствоИменСхемы, ВидУчастника)
	
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "ОКПО",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".КодОКПО"), , Ошибки);
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "СтруктПодр",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".СтруктурноеПодразделение"), , Ошибки);
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "ИнфДляУчаст",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ИнформацияДляУчастника"), , Ошибки);
	
	ИдСв = ПолучитьОбъектТипаCML("УчастникТип.ИдСв", ПространствоИменСхемы);
	Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		СвЮЛУч = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвЮЛУч", ПространствоИменСхемы);
		
		Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
		ЗаполнитьСвойствоXDTO(СвЮЛУч, "НаимОрг", Наименование, Истина, Ошибки);
		ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		ЗаполнитьСвойствоXDTO(СвЮЛУч, "ИННЮЛ", ИНН, Истина, Ошибки);
		КПП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		ЗаполнитьСвойствоXDTO(СвЮЛУч, "КПП", КПП, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ИдСв, "СвЮЛУч", СвЮЛУч, , Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		СвИПТип = ПолучитьОбъектТипаCML("СвИПТип", ПространствоИменСхемы);
		
		ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		ЗаполнитьСвойствоXDTO(СвИПТип, "ИННФЛ", ИНН, Истина, Ошибки);
		
		СвидетельствоОГосРегистрации = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации");
		ЗаполнитьСвойствоXDTO(СвИПТип, "СвГосРегИП", СвидетельствоОГосРегистрации, , Ошибки);
		ИныеСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.ИныеСведения");
		ЗаполнитьСвойствоXDTO(СвИПТип, "ИныеСвед", ИныеСведения, , Ошибки);
		
		ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
		Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия");
		ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
		Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Имя");
		ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
		Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество");
		ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
		ЗаполнитьСвойствоXDTO(СвИПТип, "ФИО", ФИО,  , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ИдСв, "СвИП",  СвИПТип, , Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ИЛ" Тогда
		СвИнНеУч = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвИнНеУч", ПространствоИменСхемы);
		
		Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации");
		ЗаполнитьСвойствоXDTO(СвИнНеУч, "НаимОрг", Наименование, , Ошибки);
		ИныеСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИЛ.ИныеСведения");
		ЗаполнитьСвойствоXDTO(СвИнНеУч, "ИныеСвед", ИныеСведения, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ИдСв, "СвИнНеУч",  СвИнНеУч, , Ошибки);
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "ИдСв", ИдСв, Истина, Ошибки);
	
	АдресТип = ПолучитьОбъектТипаCML("АдресТип", ПространствоИменСхемы);
	Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Адрес") = "АдресРФ" Тогда
		АдрРФ = ПолучитьОбъектТипаCML("АдрРФТип", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(АдрРФ, "Индекс", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Индекс"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "КодРегион", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.КодРегиона"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Район", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Район"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Город", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Город"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "НаселПункт", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.НаселенныйПункт"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Улица", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Улица"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Дом", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Дом"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Корпус", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Корпус"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Кварт", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Квартира"), , Ошибки);
		
		ЗаполнитьСвойствоXDTO(АдресТип, "АдрРФ", АдрРФ, Истина, Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Адрес") = "АдресИнформация" Тогда
		АдрИнфТип = ПолучитьОбъектТипаCML("АдрИнфТип", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(АдрИнфТип, "КодСтр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресИнформация.КодСтраны"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(АдрИнфТип, "АдрТекст", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресИнформация.АдресТекст"), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(АдресТип, "АдрИнф", АдрИнфТип, Истина, Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Адрес") = "КодГАР" Тогда
		
		ЗаполнитьСвойствоXDTO(АдресТип, "КодГАР",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.КодГАР"), Истина, Ошибки);
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "Адрес", АдресТип, Истина, Ошибки);
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".КонтактныеСведения")) Тогда
		КонтактТип = ПолучитьОбъектТипаCML("КонтактТип", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(КонтактТип, "Тлф", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".КонтактныеСведения.Телефон"), , Ошибки);
		ЗаполнитьСвойствоXDTO(КонтактТип, "ЭлПочта", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".КонтактныеСведения.ЭлектроннаяПочта"), , Ошибки);
		
		ЗаполнитьСвойствоXDTO(УчастникXDTO, "Контакт", КонтактТип, Истина, Ошибки);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты")) Тогда
		БанкРекв = ПолучитьОбъектТипаCML("УчастникТип.БанкРекв", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(БанкРекв, "НомерСчета", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.НомерСчета"), , Ошибки);
		
		СвБанк = ПолучитьОбъектТипаCML("УчастникТип.БанкРекв.СвБанк", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СвБанк, "НаимБанк", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.НаименованиеБанка"), , Ошибки);
		ЗаполнитьСвойствоXDTO(СвБанк, "БИК", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.БИКБанка"), , Ошибки);
		ЗаполнитьСвойствоXDTO(СвБанк, "КорСчет", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.КорреспондентскийСчетБанка"), , Ошибки);
		ЗаполнитьСвойствоXDTO(БанкРекв, "СвБанк", СвБанк, Истина, Ошибки);
			
		ЗаполнитьСвойствоXDTO(УчастникXDTO, "БанкРекв", БанкРекв, Истина, Ошибки);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСведенияОбУчастникеУКД(УчастникXDTO, СтрокаДереваДанных, Ошибки, ПространствоИменСхемы, ВидУчастника)
	
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "ОКПО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		СтрокаДереваДанных, ВидУчастника + ".КодОКПО"), , Ошибки);
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "СтруктПодр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		СтрокаДереваДанных, ВидУчастника + ".СтруктурноеПодразделение"), , Ошибки);
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "ИнфДляУчаст", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		СтрокаДереваДанных, ВидУчастника + ".ИнформацияДляУчастника"), , Ошибки);
	
	ИдСв = ПолучитьОбъектТипаCML("СвПродПокТип.ИдСв", ПространствоИменСхемы);
	Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		СвЮЛУч = ПолучитьОбъектТипаCML("СвПродПокТип.ИдСв.СвЮЛУч", ПространствоИменСхемы);
		
		Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
		ЗаполнитьСвойствоXDTO(СвЮЛУч, "НаимОрг", Наименование, Истина, Ошибки);
		ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		ЗаполнитьСвойствоXDTO(СвЮЛУч, "ИННЮЛ", ИНН, Истина, Ошибки);
		КПП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		ЗаполнитьСвойствоXDTO(СвЮЛУч, "КПП", КПП, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ИдСв, "СвЮЛУч", СвЮЛУч, , Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		СвИПТип = ПолучитьОбъектТипаCML("СвИПТип", ПространствоИменСхемы);
		
		ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		ЗаполнитьСвойствоXDTO(СвИПТип, "ИННФЛ", ИНН, Истина, Ошибки);
		
		СвидетельствоОГосРегистрации = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации");
		ЗаполнитьСвойствоXDTO(СвИПТип, "СвГосРегИП", СвидетельствоОГосРегистрации, , Ошибки);
		ИныеСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.ИныеСведения");
		ЗаполнитьСвойствоXDTO(СвИПТип, "ИныеСвед", ИныеСведения, , Ошибки);
		
		ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
		Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия");
		ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
		Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Имя");
		ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
		Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество");
		ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
		ЗаполнитьСвойствоXDTO(СвИПТип, "ФИО", ФИО,  , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ИдСв, "СвИП",  СвИПТип, , Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ИЛ" Тогда
		СвИнНеУч = ПолучитьОбъектТипаCML("СвПродПокТип.ИдСв.СвИнНеУч", ПространствоИменСхемы);
		
		Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации");
		ЗаполнитьСвойствоXDTO(СвИнНеУч, "НаимОрг", Наименование, , Ошибки);
		ИныеСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИЛ.ИныеСведения");
		ЗаполнитьСвойствоXDTO(СвИнНеУч, "ИныеСвед", ИныеСведения, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ИдСв, "СвИнНеУч",  СвИнНеУч, , Ошибки);
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "ИдСв", ИдСв, Истина, Ошибки);
	
	АдресТип = ПолучитьОбъектТипаCML("АдресТип", ПространствоИменСхемы);
	Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Адрес") = "АдресРФ" Тогда
		АдрРФ = ПолучитьОбъектТипаCML("АдрРФТип", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(АдрРФ, "Индекс",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Индекс"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "КодРегион",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.КодРегиона"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Район",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Район"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Город",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Город"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "НаселПункт",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.НаселенныйПункт"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Улица",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Улица"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Дом",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Дом"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Корпус",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Корпус"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АдрРФ, "Кварт",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресРФ.Квартира"), , Ошибки);
		
		ЗаполнитьСвойствоXDTO(АдресТип, "АдрРФ", АдрРФ, Истина, Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Адрес") = "АдресИнформация" Тогда
		АдрИнфТип = ПолучитьОбъектТипаCML("АдрИнфТип", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(АдрИнфТип, "КодСтр",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресИнформация.КодСтраны"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(АдрИнфТип, "АдрТекст",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.АдресИнформация.АдресТекст"), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(АдресТип, "АдрИнф", АдрИнфТип, Истина, Ошибки);
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес") = "КодГАР" Тогда
		
		ЗаполнитьСвойствоXDTO(АдресТип, "КодГАР",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".Адрес.КодГАР"), Истина, Ошибки);
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(УчастникXDTO, "Адрес", АдресТип, Истина, Ошибки);
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".КонтактныеСведения")) Тогда
		КонтактТип = ПолучитьОбъектТипаCML("КонтактТип", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(КонтактТип, "Тлф",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".КонтактныеСведения.Телефон"), , Ошибки);
		ЗаполнитьСвойствоXDTO(КонтактТип, "ЭлПочта",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".КонтактныеСведения.ЭлектроннаяПочта"), , Ошибки);
		
		ЗаполнитьСвойствоXDTO(УчастникXDTO, "Контакт", КонтактТип, Истина, Ошибки);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты")) Тогда
		БанкРекв = ПолучитьОбъектТипаCML("СвПродПокТип.БанкРекв", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(БанкРекв, "НомерСчета",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.НомерСчета"), , Ошибки);
		
		СвБанк = ПолучитьОбъектТипаCML("СвПродПокТип.БанкРекв.СвБанк", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СвБанк, "НаимБанк",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.НаименованиеБанка"), , Ошибки);
		ЗаполнитьСвойствоXDTO(СвБанк, "БИК",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.БИКБанка"), , Ошибки);
		ЗаполнитьСвойствоXDTO(СвБанк, "КорСчет",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				СтрокаДереваДанных, ВидУчастника + ".БанковскиеРеквизиты.КорреспондентскийСчетБанка"), , Ошибки);
		ЗаполнитьСвойствоXDTO(БанкРекв, "СвБанк", СвБанк, Истина, Ошибки);
			
		ЗаполнитьСвойствоXDTO(УчастникXDTO, "БанкРекв", БанкРекв, Истина, Ошибки);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьИнформациюПродавцаXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УПД_ИнформацияПродавца");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
		
	ФункцияДокумента = ЗначениеСвойстваXDTO(ЭД, "Документ.Функция");
	Если ФункцияДокумента = "СЧФДОП" Тогда
		
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД;
		
	ИначеЕсли ФункцияДокумента = "СЧФ" Тогда
		
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД;
		
	ИначеЕсли ФункцияДокумента = "ДОП" Тогда
		
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД;
		
	КонецЕсли;
	
	// Характеристики электронного документа.
	ВставитьЗначениеВДерево(ДеревоДанных, "Функция",      ФункцияДокумента);
	ВставитьЗначениеВДерево(ДеревоДанных, "Наименование", ЗначениеСвойстваXDTO(ЭД, "Документ.ПоФактХЖ"));
	
	ВставитьЗначениеВДерево(ДеревоДанных, "НаименованиеДокументаОтправителя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.НаимДокОпр"));
		
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование",
		ЗначениеСвойстваXDTO(ЭД, "Документ.НаимЭконСубСост"));
		
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаДоверенность",
		ЗначениеСвойстваXDTO(ЭД, "Документ.ОснДоверОргСост"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.НомерСчФ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ДатаСчФ", "Дата"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.КодОКВ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ИспрСчФ.НомИспрСчФ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ИспрСчФ.ДатаИспрСчФ", "Дата"));
	
	Грузоотправитель = ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ГрузОт.ГрузОтпр");
	Если Грузоотправитель <> Неопределено Тогда
		ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, Грузоотправитель, "СведенияОГрузоотправителе.Грузоотправитель");
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ГрузОт.ОнЖе") <> Неопределено Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОГрузоотправителе.ОнЖе", Истина);
	КонецЕсли;
	
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных,
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ГрузПолуч"), "СведенияОГрузополучателе");
	
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных,
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.СвПрод"), "СведенияОПродавце");
		
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных,
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.СвПокуп"), "СведенияОПокупателе");
		
	ПРД = ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.СвПРД",, Истина);
	Если ПРД <> Неопределено Тогда
		
		ТаблицаПлатежноРасчетныеДокументы = Новый ТаблицаЗначений;
		ТаблицаПлатежноРасчетныеДокументы.Колонки.Добавить("НомерПРД");
		ТаблицаПлатежноРасчетныеДокументы.Колонки.Добавить("ДатаПРД");

		Для Каждого СтрокаПлатежа Из ПРД Цикл
			НоваяСтрока = ТаблицаПлатежноРасчетныеДокументы.Добавить();
			НоваяСтрока.НомерПРД = ЗначениеСвойстваXDTO(СтрокаПлатежа, "НомерПРД");
			НоваяСтрока.ДатаПРД  = ЗначениеСвойстваXDTO(СтрокаПлатежа, "ДатаПРД", "Дата");
		КонецЦикла;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаПлатежноРасчетныеДокументы, "ПлатежноРасчетныеДокументы");
	КонецЕсли;
	

	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ДопСвФХЖ1.ИдГосКон"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ВалютаНаименование",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ДопСвФХЖ1.НаимОКВ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ВалютаКурс",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ДопСвФХЖ1.КурсВал"));
	
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ИнфПолФХЖ1") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ДопДанныеСчетаФактуры.ИдентификаторФайла", ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ИнфПолФХЖ1.ИдФайлИнфПол"));
		
		ТекстИнф = ЗначениеСвойстваXDTO(ЭД, "Документ.СвСчФакт.ИнфПолФХЖ1.ТекстИнф",, Истина);
		Если ТекстИнф <> Неопределено Тогда
			
			// Сведения о организации.
			ИННОрганизации = "";
			КППОрганизации = "";
			ВидУчастника   = "СведенияОПродавце";
			
			Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
				ВидУчастника = "СведенияОПокупателе";
				
				Для Каждого СтрокаИнформации Из ТекстИнф Цикл
					Если ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф") = "ДанныеКомиссионера" Тогда
						
						ВидУчастника = "СведенияОКомиссионере";
						ОбъектXML = Новый ЧтениеXML;
						СтрокаXML = "<УчастникТип>" + ЗначениеСвойстваXDTO(СтрокаИнформации, "Значен") + "</УчастникТип>";
						ОбъектXML.УстановитьСтроку(СтрокаXML);
						СведенияОКомиссионере = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
						ОбъектXML.Закрыть();
						ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОКомиссионере, "СведенияОКомиссионере");
						
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			СвойстваОрганизации = ДанныеУчастникаСделкиУПД_УКД(ВидУчастника, ДеревоДанных, "ИНН, КПП");
			Организация = Неопределено; 
			ОбменСКонтрагентамиПереопределяемый.СсылкаНаОбъектПоИННКПП("Организации", СвойстваОрганизации.ИНН, СвойстваОрганизации.КПП, Организация);
			
			ДокументыОснованияСчетаФактуры = Новый Массив;
			
			ТекстоваяИнформация = Новый ТаблицаЗначений;
			ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
			ТекстоваяИнформация.Колонки.Добавить("Значение");
			
			Для Каждого СтрокаИнформации Из ТекстИнф Цикл
				
				Идентиф = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
				Значен  = ЗначениеСвойстваXDTO(СтрокаИнформации, "Значен");
				
				Если Значен = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				Если Идентиф = "ИдентификаторДокументаОснования" Тогда
					
					СтруктураОтбора = Новый Структура;
					СтруктураОтбора.Вставить("Организация",   Организация);
					СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
					
					ДокументОснование = ДокументОснованиеПоИдентификатору(Значен, СтруктураОтбора, НовыйЭД.ТипЭлементаВерсииЭД);
					Если ДокументОснование <> Неопределено
						И ДокументыОснованияСчетаФактуры.Найти(ДокументОснование) = Неопределено Тогда
						ДокументыОснованияСчетаФактуры.Добавить(ДокументОснование);
					КонецЕсли;
					
				ИначеЕсли Идентиф = "ИДЭДДокументаОснования" Тогда
					
					СтруктураОтбора = Новый Структура;
					СтруктураОтбора.Вставить("Организация",   Организация);
					
					Если ВидУчастника = "СведенияОКомиссионере" Тогда
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Исходящий);
					Иначе
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
					КонецЕсли;
					
					ДокументОснование = ПолучитьДокументОснование(Значен, СтруктураОтбора);
					Если ДокументОснование <> Неопределено
						И ДокументыОснованияСчетаФактуры.Найти(ДокументОснование) = Неопределено Тогда
						ДокументыОснованияСчетаФактуры.Добавить(ДокументОснование);
					КонецЕсли;
					
				ИначеЕсли Идентиф = "ВидСчетаФактуры" Тогда
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"ВидСчетаФактуры", Значен);
					
				ИначеЕсли Идентиф = "ТолькоУслуги" Тогда
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"ТолькоУслуги", Булево(Значен));
					
				КонецЕсли;
				
				НоваяСтрока = ТекстоваяИнформация.Добавить();
				НоваяСтрока.Идентификатор = Идентиф;
				НоваяСтрока.Значение      = Значен;
				
			КонецЦикла;
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры",
				ДокументыОснованияСчетаФактуры);
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТекстоваяИнформация, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблСчФакт") <> Неопределено Тогда
		
		СведенияОТоварах = Новый ТаблицаЗначений;
		СведенияОТоварах.Колонки.Добавить("ИдТовараУКонтрагента");
		СведенияОТоварах.Колонки.Добавить("ТоварНаименование");
		СведенияОТоварах.Колонки.Добавить("ЕдиницаИзмеренияКод");
		СведенияОТоварах.Колонки.Добавить("Количество");
		СведенияОТоварах.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровБезНалога");
		СведенияОТоварах.Колонки.Добавить("НалоговаяСтавка");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровСНалогом");
		СведенияОТоварах.Колонки.Добавить("СуммаАкциза");
		СведенияОТоварах.Колонки.Добавить("СуммаНалога");
		СведенияОТоварах.Колонки.Добавить("СведенияОТаможеннойДекларации");
		СведенияОТоварах.Колонки.Добавить("ДокументОснование");
		СведенияОТоварах.Колонки.Добавить("Признак");
		СведенияОТоварах.Колонки.Добавить("ПризнакДополнительнаяИнформация");
		СведенияОТоварах.Колонки.Добавить("ТоварКод");
		СведенияОТоварах.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
		СведенияОТоварах.Колонки.Добавить("СтранаПроисхожденияНаименование");
		СведенияОТоварах.Колонки.Добавить("КоличествоНадлежитОтпустить");
		СведенияОТоварах.Колонки.Добавить("КорреспондирующиеСчетаДебет");
		СведенияОТоварах.Колонки.Добавить("КорреспондирующиеСчетаКредит");
		СведенияОТоварах.Колонки.Добавить("ТекстоваяИнформация");
		
		СведТов = ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблСчФакт.СведТов",, Истина);
		Если СведТов <> Неопределено Тогда
			Для Каждого Товар Из СведТов Цикл
				
				// Основные характеристики товара.
				НоваяСтрока = СведенияОТоварах.Добавить();
				
				НоваяСтрока.ТоварНаименование         = ЗначениеСвойстваXDTO(Товар, "НаимТов");
				НоваяСтрока.ЕдиницаИзмеренияКод       = ЗначениеСвойстваXDTO(Товар, "ОКЕИ_Тов");
				НоваяСтрока.Количество                = ЗначениеСвойстваXDTO(Товар, "КолТов",      "Число");
				НоваяСтрока.ЦенаЗаЕдиницуИзмерения    = ЗначениеСвойстваXDTO(Товар, "ЦенаТов",     "Число");
				НоваяСтрока.СтоимостьТоваровБезНалога = ЗначениеСвойстваXDTO(Товар, "СтТовБезНДС", "Число");
				
				НоваяСтрока.НалоговаяСтавка = 
					ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(ЗначениеСвойстваXDTO(Товар, "НалСт"));
				
				НоваяСтрока.СтоимостьТоваровСНалогом = ЗначениеСвойстваXDTO(Товар, "СтТовУчНал", "Число");
				
				СумАкциз = ЗначениеСвойстваXDTO(Товар, "Акциз.СумАкциз", "Число");
				НоваяСтрока.СуммаАкциза = ?(СумАкциз <> Неопределено, СумАкциз, НСтр("ru ='без акциза'"));
				
				НоваяСтрока.СуммаНалога = ЗначениеСвойстваXDTO(Товар, "СумНал.СумНал", "Число");
				
				// Сведения о таможенной декларации.
				СвТД = ЗначениеСвойстваXDTO(Товар, "СвТД",, Истина);
				Если СвТД <> Неопределено Тогда
					
					СведенияОТаможеннойДекларации = Новый ТаблицаЗначений;
					
					СведенияОТаможеннойДекларации.Колонки.Добавить(
						"СтранаПроисхожденияКод",    Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(3)));
					СведенияОТаможеннойДекларации.Колонки.Добавить(
						"ТаможеннаяДекларацияНомер", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(29)));
					
					Для Каждого СведенияТД Из СвТД Цикл
						СтрокаТаблицы = СведенияОТаможеннойДекларации.Добавить();
						СтрокаТаблицы.СтранаПроисхожденияКод    = ЗначениеСвойстваXDTO(СведенияТД, "КодПроисх");
						СтрокаТаблицы.ТаможеннаяДекларацияНомер = ЗначениеСвойстваXDTO(СведенияТД, "НомерТД");
					КонецЦикла;
					
					НоваяСтрока.СведенияОТаможеннойДекларации = СведенияОТаможеннойДекларации;
					
				КонецЕсли;
				
				
				ИнфПолФХЖ2 = ЗначениеСвойстваXDTO(Товар, "ИнфПолФХЖ2",, Истина);
				Если ИнфПолФХЖ2 <> Неопределено Тогда
					
					ТекстоваяИнформация = Новый ТаблицаЗначений;
					ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
					ТекстоваяИнформация.Колонки.Добавить("Значение");
					
					ДокументОснованиеНайден = Ложь;
					
					Для Каждого СтрокаИнформации Из ИнфПолФХЖ2 Цикл
						
						Идентиф = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
						Значен  = ЗначениеСвойстваXDTO(СтрокаИнформации, "Значен");
						
						Если Значен = Неопределено Тогда
							Продолжить;
						КонецЕсли;
						
						Если Идентиф = "ИдентификаторДокументаОснования" И НЕ ДокументОснованиеНайден Тогда
							
							СтруктураОтбора = Новый Структура;
							СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
							НоваяСтрока.ДокументОснование = ДокументОснованиеПоИдентификатору(Значен, СтруктураОтбора);
							ДокументОснованиеНайден = Истина;
							
						ИначеЕсли Идентиф = "ИДЭДДокументаОснования" И НЕ ДокументОснованиеНайден Тогда
							
							СтруктураОтбора = Новый Структура;
							СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
							НоваяСтрока.ДокументОснование = ПолучитьДокументОснование(Значен, СтруктураОтбора);
							
						ИначеЕсли Идентиф = "ИД" Тогда
							
							НоваяСтрока.ИдТовараУКонтрагента = Значен;
						КонецЕсли;
						
						СтрокаТаблицы = ТекстоваяИнформация.Добавить();
						СтрокаТаблицы.Идентификатор = Идентиф;
						СтрокаТаблицы.Значение      = Значен;
						
					КонецЦикла;
					
					НоваяСтрока.ТекстоваяИнформация = ТекстоваяИнформация;
				КонецЕсли;
				
				// Заполним идентификатор товара / услуги по наименованию, если не был передан идентификатор номенклатуры.
				Если Не ЗначениеЗаполнено(НоваяСтрока.ИдТовараУКонтрагента) Тогда
					НоваяСтрока.ИдТовараУКонтрагента = ИдентификаторТовараПоСтроке(ВРег(СтрЗаменить(НоваяСтрока.ТоварНаименование, " ", "")) + "###");
				КонецЕсли;
				
				// Дополнительные характеристики товара.
				Если ЗначениеСвойстваXDTO(Товар, "ДопСведТов") <> Неопределено Тогда
					НоваяСтрока.Признак                         = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.ПрТовРаб");
					НоваяСтрока.ПризнакДополнительнаяИнформация = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.ДопПризн");
					НоваяСтрока.ТоварКод                        = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.КодТов");
					НоваяСтрока.ЕдиницаИзмеренияНаименование    = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.НаимЕдИзм");
					НоваяСтрока.СтранаПроисхожденияНаименование = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.КрНаимСтрПр");
					НоваяСтрока.КоличествоНадлежитОтпустить     = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.НадлОтп", "Число");
					НоваяСтрока.КорреспондирующиеСчетаДебет     = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.КорСчДебет");
					НоваяСтрока.КорреспондирующиеСчетаКредит    = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.КорСчКредит");
				КонецЕсли;
				
			КонецЦикла;
		КонецЕсли;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, СведенияОТоварах, "СведенияОТоварах");
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоКОплате.ВсегоСтоимостьТоваровБезНалога",
			ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблСчФакт.ВсегоОпл.СтТовБезНДСВсего", "Число"));
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом",
			ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблСчФакт.ВсегоОпл.СтТовУчНалВсего", "Число"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоКОплате.ВсегоСуммаНалога",
			СуммаНДССФПривестиКТребуемомуФормату(ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблСчФакт.ВсегоОпл.СумНалВсего.СумНал", "Число")));
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоКОплате.ВсегоКоличество", ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблСчФакт.ВсегоОпл.НеттоВс", "Число"));
		
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СодОпер"));
			
		ВидОперации = ПеречислениеИзЗначенияXML(ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.ВидОпер"), "ВидыОперацийЭД");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидОперации", ВидОперации);
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаОтгрузкиТоваров",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.ДатаПер", "Дата"));
		
		ОснованиеОтгрузкиТоваров = Новый ТаблицаЗначений;
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументНаименование");
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументНомер");
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументДата");
		ОснованиеОтгрузкиТоваров.Колонки.Добавить("ДокументДопСведения");
		
		ОснованияДокумента = ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.ОснПер",, Истина);
		Для Каждого Основание Из ОснованияДокумента Цикл
			
			НоваяСтрока = ОснованиеОтгрузкиТоваров.Добавить();
			НоваяСтрока.ДокументНаименование = ЗначениеСвойстваXDTO(Основание, "НаимОсн");
			НоваяСтрока.ДокументНомер        = ЗначениеСвойстваXDTO(Основание, "НомОсн");
			НоваяСтрока.ДокументДата         = ЗначениеСвойстваXDTO(Основание, "ДатаОсн", "Дата");
			НоваяСтрока.ДокументДопСведения  = ЗначениеСвойстваXDTO(Основание, "ДопСвОсн");
			
		КонецЦикла;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ОснованиеОтгрузкиТоваров, "ОснованиеОтгрузкиТоваров");
		
		Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер") <> Неопределено Тогда
			
			Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод") <> Неопределено Тогда
				
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Должность",
					ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод.Должность"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ИныеСведения",
					ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод.ИныеСвед"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ОснованиеПолномочий",
					ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод.ОснПолн"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Фамилия",
					ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод.ФИО.Фамилия"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Имя",
					ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод.ФИО.Имя"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Отчество",
					ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.РабОргПрод.ФИО.Отчество"));
				
			ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо") <> Неопределено Тогда
				
				Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер") <> Неопределено Тогда
					
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Должность",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.Должность"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ИныеСведения",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.ИныеСвед"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.НаименованиеОрганизации",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.НаимОргПер"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ДоверенностьНаОтгрузку",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.ОснДоверОргПер"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ОснованиеПолномочий",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.ОснПолнПредПер"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.ФИО.Фамилия"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Имя",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.ФИО.Имя"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер.ФИО.Отчество"));
					
				ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер") <> Неопределено Тогда
					
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ИныеСведения",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер.ИныеСвед"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ДоверенностьНаОтгрузку",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер.ОснДоверФЛ"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер.ФИО.Фамилия"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер.ФИО.Имя"));
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество",
						ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер.ФИО.Отчество"));
						
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.ТранГруз") <> Неопределено Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОТранспортировке", ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.ТранГруз.СвТранГруз"));
			
			ТранспортнаяНакладная = ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.ТранГруз.ТранНакл",, Истина);
			Если ТранспортнаяНакладная <> Неопределено Тогда
				
				ТаблицаНакладных = Новый ТаблицаЗначений;
				ТаблицаНакладных.Колонки.Добавить("ТранспортнаяНакладнаяНомер");
				ТаблицаНакладных.Колонки.Добавить("ТранспортнаяНакладнаяДата");
				
				Для Каждого Накладная Из ТранспортнаяНакладная Цикл
					НоваяСтрока = ТаблицаНакладных.Добавить();
					НоваяСтрока.ТранспортнаяНакладнаяНомер = ЗначениеСвойстваXDTO(Накладная, "НомТранНакл");
					НоваяСтрока.ТранспортнаяНакладнаяДата  = ЗначениеСвойстваXDTO(Накладная, "ДатаТранНакл", "Дата");
				КонецЦикла;
				
				ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТаблицаНакладных, "ТранспортнаяНакладная");
			КонецЕсли;
			
			ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, 
				ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.ТранГруз.Перевозчик"), "СведенияОПеревозчике");
			
		КонецЕсли;
			
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОПередачеВещи.ПередачаВещиДата",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвПерВещи.ДатаПерВещ", "Дата"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОПередачеВещи.ПередачаВещиСведения",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.СвПер.СвПерВещи.СвПерВещ"));
		
		Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.ИнфПолФХЖ3") <> Неопределено Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"ДопДанныеДокументаОтгрузки.ИдентификаторФайла",
				ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.ИнфПолФХЖ3.ИдФайлИнфПол"));
				
			ТекстИнф = ЗначениеСвойстваXDTO(ЭД, "Документ.СвПродПер.ИнфПолФХЖ3.ТекстИнф",, Истина);
			Если ТекстИнф <> Неопределено Тогда
				
				ДокументыОснованияДокументаОтгрузки = Новый Массив;
				
				ТекстоваяИнформация = Новый ТаблицаЗначений;
				ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
				ТекстоваяИнформация.Колонки.Добавить("Значение");
				
				Для Каждого СтрокаИнформации Из ТекстИнф Цикл
					
					Идентиф = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
					Значен  = ЗначениеСвойстваXDTO(СтрокаИнформации, "Значен");
					
					Если Значен = Неопределено Тогда
						Продолжить;
					КонецЕсли;
					
					Если Идентиф = "ИдентификаторДокументаОснования" Тогда
						
						СтруктураОтбора = Новый Структура;
						СтруктураОтбора.Вставить("Организация",   Организация);
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
						ДокументОснование = ДокументОснованиеПоИдентификатору(Значен, СтруктураОтбора);
						Если ДокументОснование <> Неопределено Тогда
							ДокументыОснованияДокументаОтгрузки.Добавить(ДокументОснование);
						КонецЕсли;
						
					ИначеЕсли Идентиф = "ИДЭДДокументаОснования" Тогда
						
						СтруктураОтбора = Новый Структура;
						СтруктураОтбора.Вставить("Организация",   Организация);
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
						ДокументОснование = ПолучитьДокументОснование(Значен, СтруктураОтбора);
						Если ДокументОснование <> Неопределено Тогда
							ДокументыОснованияДокументаОтгрузки.Добавить(ДокументОснование);
						КонецЕсли;
						
					ИначеЕсли СтрокаИнформации.Идентиф = "ИныеСведенияОбОтгрузке" Тогда
						ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
							"ИныеСведенияОбОтгрузке", Значен);
					КонецЕсли;
					
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = Идентиф;
					НоваяСтрока.Значение      = Значен;
					
				КонецЦикла;
				
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"ДокументыОснованияДокументаОтгрузки",
					ДокументыОснованияДокументаОтгрузки);
					
				ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных,
					ТекстоваяИнформация,
					"ДопДанныеДокументаОтгрузки.ТекстоваяИнформация");
					
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
		
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОПБОЮЛ", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя",       "");
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", "");
		ВставитьЗначениеВДерево(ДеревоДанных, "Свидетельство", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ГосРегИПВыдДов"));
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОПБОЮЛ", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", "");
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", НСтр("ru = 'ИП'"));
		ВставитьЗначениеВДерево(ДеревоДанных, "Свидетельство", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.СвГосРегИП"));
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.Должн"));
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОПБОЮЛ", "");
		ВставитьЗначениеВДерево(ДеревоДанных, "Свидетельство", "");
		
	КонецЕсли;
	
	НовыйЭД.ЗначениеРеквизита = ДеревоДанных;
	НовыйЭД.ВидЭД = УточненныйВидЭДИнформацииПродавцаУПД(ДеревоДанных, НовыйЭД.ВидЭД);
	
КонецПроцедуры

Процедура ПрочитатьИнформациюПродавцаУКДXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УКД_ИнформацияПродавца");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
	ФункцияДокумента = ЗначениеСвойстваXDTO(ЭД, "Документ.Функция");
	Если ФункцияДокумента = "КСЧФДИС" Тогда
		НовыйЭД.ВидЭД               = Перечисления.ВидыЭД.КорректировочныйСчетФактура;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД;
	ИначеЕсли ФункцияДокумента = "КСЧФ" Тогда
		НовыйЭД.ВидЭД               = Перечисления.ВидыЭД.КорректировочныйСчетФактура;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД;
	ИначеЕсли ФункцияДокумента = "ДИС" Тогда
		НовыйЭД.ВидЭД               = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД;
	КонецЕсли;
	
	// Характеристики электронного документа.
	ВставитьЗначениеВДерево(ДеревоДанных, "Функция",      ФункцияДокумента);
	ВставитьЗначениеВДерево(ДеревоДанных, "Наименование", ЗначениеСвойстваXDTO(ЭД, "Документ.ПоФактХЖ"));
	
	ВставитьЗначениеВДерево(ДеревоДанных, "НаименованиеДокументаОтправителя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.НаимДокОпр"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование",
		ЗначениеСвойстваXDTO(ЭД, "Документ.НаимЭконСубСост"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаДоверенность",
		ЗначениеСвойстваXDTO(ЭД, "Документ.ОснДоверОргСост"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.НомерКСчФ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ДатаКСчФ", "Дата"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.КодОКВ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ИспрКСчФ.НомИспрКСчФ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ИспрКСчФ.ДатаИспрКСчФ", "Дата"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсходногоДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.СчФ.НомерСчФ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсходногоДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.СчФ.НомерСчФ.ДатаСчФ", "Дата"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправленияИсходногоДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.СчФ.ИспрСчФ.НомИспрСчф"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправленияИсходногоДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.СчФ.ИспрСчФ.ДатаИспрСчФ", "Дата"));
	
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.СвПрод"),  "СведенияОПродавце");
	ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.СвПокуп"), "СведенияОПокупателе");
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ДопСвФХЖ1.ИдГосКон"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ВалютаНаименование",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ДопСвФХЖ1.НаимОКВ"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ВалютаКурс",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ДопСвФХЖ1.КурсВал"));
	
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ИнфПолФХЖ1") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ДопДанныеСчетаФактуры.ИдентификаторФайла", ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ИнфПолФХЖ1.ИдФайлИнфПол"));
		
		ТекстИнф = ЗначениеСвойстваXDTO(ЭД, "Документ.СвКСчФ.ИнфПолФХЖ1.ТекстИнф",, Истина);
		Если ТекстИнф <> Неопределено Тогда
			
			// Сведения о организации.
			ИННОрганизации = "";
			КППОрганизации = "";
			ВидУчастника   = "СведенияОПродавце";
			
			Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
				ВидУчастника = "СведенияОПокупателе";
			КонецЕсли;
			
			СвойстваОрганизации = ДанныеУчастникаСделкиУПД_УКД(ВидУчастника, ДеревоДанных, "ИНН, КПП");
			Организация = Неопределено;
			ОбменСКонтрагентамиПереопределяемый.СсылкаНаОбъектПоИННКПП("Организации", СвойстваОрганизации.ИНН, СвойстваОрганизации.КПП, Организация);
			
			ДокументыОснованияСчетаФактуры = Новый Массив;
			
			ТекстоваяИнформация = Новый ТаблицаЗначений;
			ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
			ТекстоваяИнформация.Колонки.Добавить("Значение");
			
			Для Каждого СтрокаИнформации Из ТекстИнф Цикл
				
				Идентиф = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
				Значен  = ЗначениеСвойстваXDTO(СтрокаИнформации, "Значен");
				
				Если Значен = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				Если Идентиф = "ИдентификаторДокументаОснования" Тогда
					
					СтруктураОтбора = Новый Структура;
					СтруктураОтбора.Вставить("Организация",   Организация);
					СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);

					ДокументОснование = ДокументОснованиеПоИдентификатору(Значен, СтруктураОтбора, НовыйЭД.ТипЭлементаВерсииЭД);
					Если ДокументОснование <> Неопределено Тогда
						ДокументыОснованияСчетаФактуры.Добавить(ДокументОснование);
					КонецЕсли;
					
				ИначеЕсли Идентиф = "ИДЭДДокументаОснования" Тогда
					
					СтруктураОтбора = Новый Структура;
					СтруктураОтбора.Вставить("Организация",   Организация);
					СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
					ДокументОснование = ПолучитьДокументОснование(Значен, СтруктураОтбора);
					Если ДокументОснование <> Неопределено Тогда
						ДокументыОснованияСчетаФактуры.Добавить(ДокументОснование);
					КонецЕсли;
				
				ИначеЕсли Идентиф = "ДанныеКомиссионера" Тогда
					
					ОбъектXML = Новый ЧтениеXML;
					СтрокаXML = "<СвПродПокТип> " + Значен + " <Адрес> <АдрРФ КодРегион=""00""/> </Адрес> </СвПродПокТип>";
					ОбъектXML.УстановитьСтроку(СтрокаXML);
					СведенияОКомиссионере = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
					ОбъектXML.Закрыть();
					ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОКомиссионере, "СведенияОКомиссионере");
					
				ИначеЕсли Идентиф = "ТолькоУслуги" Тогда
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
						"ТолькоУслуги", Булево(Значен));
				КонецЕсли;
				
				НоваяСтрока = ТекстоваяИнформация.Добавить();
				НоваяСтрока.Идентификатор = Идентиф;
				НоваяСтрока.Значение      = Значен;
				
			КонецЦикла;
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснованияСчетаФактуры",
				ДокументыОснованияСчетаФактуры);
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТекстоваяИнформация, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		КонецЕсли;
	КонецЕсли;
	
	СведТов = ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблКСчФ.СведТов",, Истина);
	Если СведТов <> Неопределено Тогда
		
		СведенияОТоварах = Новый ТаблицаЗначений;
		СведенияОТоварах.Колонки.Добавить("ИдТовараУКонтрагента");
		СведенияОТоварах.Колонки.Добавить("ТоварНаименование");
		СведенияОТоварах.Колонки.Добавить("ЕдиницаИзмеренияКодДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("ЕдиницаИзмеренияКод");
		СведенияОТоварах.Колонки.Добавить("КоличествоДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("Количество");
		СведенияОТоварах.Колонки.Добавить("ЦенаЗаЕдиницуИзмеренияДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровБезНалогаДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровБезНалога");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровБезНалогаУвеличение");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровБезНалогаУменьшение");
		СведенияОТоварах.Колонки.Добавить("НалоговаяСтавкаДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("НалоговаяСтавка");
		СведенияОТоварах.Колонки.Добавить("СуммаНалогаДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("СуммаНалога");
		СведенияОТоварах.Колонки.Добавить("СуммаНалогаУвеличение");
		СведенияОТоварах.Колонки.Добавить("СуммаНалогаУменьшение");
		СведенияОТоварах.Колонки.Добавить("СуммаАкцизаДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("СуммаАкциза");
		СведенияОТоварах.Колонки.Добавить("СуммаАкцизаУвеличение");
		СведенияОТоварах.Колонки.Добавить("СуммаАкцизаУменьшение");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровСНалогомДоКорректировки");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровСНалогом");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровСНалогомУвеличение");
		СведенияОТоварах.Колонки.Добавить("СтоимостьТоваровСНалогомУменьшение");
		СведенияОТоварах.Колонки.Добавить("ДокументОснование");
		СведенияОТоварах.Колонки.Добавить("КорреспондирующиеСчетаДебет");
		СведенияОТоварах.Колонки.Добавить("КорреспондирующиеСчетаКредит");
		СведенияОТоварах.Колонки.Добавить("ТекстоваяИнформация");
		
		Для Каждого Товар Из СведТов Цикл
			
			// Основные характеристики товара.
			НоваяСтрока = СведенияОТоварах.Добавить();
			НоваяСтрока.ТоварНаименование                     = ЗначениеСвойстваXDTO(Товар, "НаимТов");
			НоваяСтрока.ЕдиницаИзмеренияКодДоКорректировки    = ЗначениеСвойстваXDTO(Товар, "ОКЕИ_ТовДо");
			НоваяСтрока.ЕдиницаИзмеренияКод                   = ЗначениеСвойстваXDTO(Товар, "ОКЕИ_ТовПосле");
			НоваяСтрока.КоличествоДоКорректировки             = ЗначениеСвойстваXDTO(Товар, "КолТовДо",     "Число");
			НоваяСтрока.Количество                            = ЗначениеСвойстваXDTO(Товар, "КолТовПосле",  "Число");
			НоваяСтрока.ЦенаЗаЕдиницуИзмеренияДоКорректировки = ЗначениеСвойстваXDTO(Товар, "ЦенаТовДо",    "Число");
			НоваяСтрока.ЦенаЗаЕдиницуИзмерения                = ЗначениеСвойстваXDTO(Товар, "ЦенаТовПосле", "Число");
			
			Если ЗначениеСвойстваXDTO(Товар, "СтТовБезНДС") <> Неопределено Тогда
				
				НоваяСтрока.СтоимостьТоваровБезНалогаДоКорректировки = ЗначениеСвойстваXDTO(Товар, "СтТовБезНДС.СтоимДоИзм",    "Число");
				НоваяСтрока.СтоимостьТоваровБезНалога                = ЗначениеСвойстваXDTO(Товар, "СтТовБезНДС.СтоимПослеИзм", "Число");
				НоваяСтрока.СтоимостьТоваровБезНалогаУвеличение      = ЗначениеСвойстваXDTO(Товар, "СтТовБезНДС.СтоимУвел", "Число");
				НоваяСтрока.СтоимостьТоваровБезНалогаУменьшение      = ЗначениеСвойстваXDTO(Товар, "СтТовБезНДС.СтоимУм",   "Число");
				
			КонецЕсли;
			
			НоваяСтрока.НалоговаяСтавкаДоКорректировки = 
				ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(ЗначениеСвойстваXDTO(Товар, "НалСтДо"));
			
			НоваяСтрока.НалоговаяСтавка = 
				ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(ЗначениеСвойстваXDTO(Товар, "НалСтПосле"));
			
			НоваяСтрока.СуммаНалогаДоКорректировки = ЗначениеСвойстваXDTO(Товар, "СумНалДо.СумНДС",    "Число");
			НоваяСтрока.СуммаНалога                = ЗначениеСвойстваXDTO(Товар, "СумНалПосле.СумНДС", "Число");
			
			НоваяСтрока.СуммаНалогаУвеличение = ЗначениеСвойстваXDTO(Товар, "СумНалРазн.СумУвел", "Число");
			НоваяСтрока.СуммаНалогаУменьшение = ЗначениеСвойстваXDTO(Товар, "СумНалРазн.СумУм",   "Число");
			
			АкцизДо    = ЗначениеСвойстваXDTO(Товар, "АкцизДо.СумАкциз",    "Число");
			АкцизПосле = ЗначениеСвойстваXDTO(Товар, "АкцизПосле.СумАкциз", "Число");
			
			НоваяСтрока.СуммаАкцизаДоКорректировки = ?(ЗначениеЗаполнено(АкцизДо),    АкцизДо,    НСтр("ru ='без акциза'"));
			НоваяСтрока.СуммаАкциза                = ?(ЗначениеЗаполнено(АкцизПосле), АкцизПосле, НСтр("ru ='без акциза'"));
			
			НоваяСтрока.СуммаАкцизаУвеличение = ЗначениеСвойстваXDTO(Товар, "АкцизРазн.СумУвел", "Число");
			НоваяСтрока.СуммаАкцизаУменьшение = ЗначениеСвойстваXDTO(Товар, "АкцизРазн.СумУм",   "Число");
			
			НоваяСтрока.СтоимостьТоваровСНалогомДоКорректировки = ЗначениеСвойстваXDTO(Товар, "СтТовУчНал.СтоимДоИзм",    "Число");
			НоваяСтрока.СтоимостьТоваровСНалогом                = ЗначениеСвойстваXDTO(Товар, "СтТовУчНал.СтоимПослеИзм", "Число");
			НоваяСтрока.СтоимостьТоваровСНалогомУвеличение      = ЗначениеСвойстваXDTO(Товар, "СтТовУчНал.СтоимУвел",     "Число");
			НоваяСтрока.СтоимостьТоваровСНалогомУменьшение      = ЗначениеСвойстваXDTO(Товар, "СтТовУчНал.СтоимУм",       "Число");
			
			Информация = ЗначениеСвойстваXDTO(Товар, "ИнфПолФХЖ2",, Истина);
			
			Если Информация <> Неопределено Тогда
				
				ТекстоваяИнформация = Новый ТаблицаЗначений;
				ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
				ТекстоваяИнформация.Колонки.Добавить("Значение");
				
				ДокументОснованиеНайден = Ложь;
				
				Для Каждого СтрокаИнформации Из Информация Цикл
					
					Идентиф = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
					Значен  = ЗначениеСвойстваXDTO(СтрокаИнформации, "Значен");
					
					Если Значен = Неопределено Тогда
						Продолжить;
					КонецЕсли;
					
					Если Идентиф = "ИдентификаторДокументаОснования" И НЕ ДокументОснованиеНайден Тогда
						
						СтруктураОтбора = Новый Структура;
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
						НоваяСтрока.ДокументОснование = ДокументОснованиеПоИдентификатору(Значен, СтруктураОтбора);
						ДокументОснованиеНайден = Истина;
						
					ИначеЕсли Идентиф = "ИДЭДДокументаОснования" И НЕ ДокументОснованиеНайден Тогда
						
						СтруктураОтбора = Новый Структура;
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
						НоваяСтрока.ДокументОснование = ПолучитьДокументОснование(Значен, СтруктураОтбора);
						
					ИначеЕсли Идентиф = "ИД" Тогда
						
						НоваяСтрока.ИдТовараУКонтрагента = Значен;
						
					КонецЕсли;
					
					СтрокаТаблицы = ТекстоваяИнформация.Добавить();
					СтрокаТаблицы.Идентификатор = Идентиф;
					СтрокаТаблицы.Значение      = Значен;
					
				КонецЦикла;
				
				НоваяСтрока.ТекстоваяИнформация = ТекстоваяИнформация;
			КонецЕсли;
			
			// Заполним идентификатор товара / услуги по наименованию, если не был передан идентификатор номенклатуры.
			Если Не ЗначениеЗаполнено(НоваяСтрока.ИдТовараУКонтрагента) Тогда
				НоваяСтрока.ИдТовараУКонтрагента = ИдентификаторТовараПоСтроке(ВРег(СтрЗаменить(НоваяСтрока.ТоварНаименование, " ", "")) + "###");
			КонецЕсли;
			
			// Дополнительные характеристики товара.
			НоваяСтрока.КорреспондирующиеСчетаДебет  = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.КорСчДебет");
			НоваяСтрока.КорреспондирующиеСчетаКредит = ЗначениеСвойстваXDTO(Товар, "ДопСведТов.КорСчКредит");
			
		КонецЦикла;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, СведенияОТоварах, "СведенияОТоварах");
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУвеличение",
			ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблКСчФ.ВсегоУвел.СтТовБезНДСВсего", "Число"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУвеличение",
			ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблКСчФ.ВсегоУвел.СтТовУчНалВсего", "Число"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУвеличение",
			СуммаНДССФПривестиКТребуемомуФормату(ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблКСчФ.ВсегоУвел.СумНал.СумНДС", "Число")));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУменьшение",
			ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблКСчФ.ВсегоУм.СтТовБезНДСВсего", "Число"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУменьшение",
			ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблКСчФ.ВсегоУм.СтТовУчНалВсего", "Число"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУменьшение",
			СуммаНДССФПривестиКТребуемомуФормату(ЗначениеСвойстваXDTO(ЭД, "Документ.ТаблКСчФ.ВсегоУм.СумНал.СумНДС", "Число")));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.СодОпер"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПередаточныхДокументов",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.ПередатДокум"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаНаправленияНаСогласование",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.ДатаНапр"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ИныеСведенияОбИзмененииСтоимости",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.ИныеСвИзмСтоим"));
		
		ОснованиеКорректировки = Новый ТаблицаЗначений;
		ОснованиеКорректировки.Колонки.Добавить("ДокументНаименование");
		ОснованиеКорректировки.Колонки.Добавить("ДокументНомер");
		ОснованиеКорректировки.Колонки.Добавить("ДокументДата");
		ОснованиеКорректировки.Колонки.Добавить("ДокументДопСведения");
		
		Основания = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.ОснКор",, Истина);
		Если Основания <> Неопределено Тогда
			Для Каждого Основание Из Основания Цикл
				НоваяСтрока = ОснованиеКорректировки.Добавить();
				НоваяСтрока.ДокументНаименование = ЗначениеСвойстваXDTO(Основание, "НаимОсн");
				НоваяСтрока.ДокументНомер        = ЗначениеСвойстваXDTO(Основание, "НомОсн");
				НоваяСтрока.ДокументДата         = ЗначениеСвойстваXDTO(Основание, "ДатаОсн", "Дата");
				НоваяСтрока.ДокументДопСведения  = ЗначениеСвойстваXDTO(Основание, "ДопСвОсн");
			КонецЦикла;
		КонецЕсли;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ОснованиеКорректировки, "ОснованиеКорректировки");
		
	КонецЕсли;
		
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОПБОЮЛ", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя",       "");
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", "");
		ВставитьЗначениеВДерево(ДеревоДанных, "Свидетельство", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ФЛ.ГосРегИППодп"));
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОПБОЮЛ", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", "");
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", НСтр("ru = 'ИП'"));
		ВставитьЗначениеВДерево(ДеревоДанных, "Свидетельство", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ИП.СвГосРегИП"));
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант.ЮЛ.Должн"));
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОПБОЮЛ", "");
		ВставитьЗначениеВДерево(ДеревоДанных, "Свидетельство", "");
		
	КонецЕсли;
	
	НовыйЭД.ЗначениеРеквизита = ДеревоДанных;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеУчастникаУПД(ДеревоДанных, СведенияОбУчастнике, ВидУчастника)
	
	Если СведенияОбУчастнике = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвЮЛУч") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвЮЛУч.НаимОрг"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ЮЛ.ИНН",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвЮЛУч.ИННЮЛ"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ЮЛ.КПП",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвЮЛУч.КПП"));
	
	ИначеЕсли ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИнНеУч") <> Неопределено Тогда
	
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИнНеУч.НаимОрг"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИЛ.ИныеСведения",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИнНеУч.ИныеСвед"));
	
	ИначеЕсли ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвЮЛНеУч") <> Неопределено Тогда
	
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвЮЛНеУч.НаимОрг"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИЛ.ИныеСведения",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвЮЛНеУч.ИныеСвед"));
	
	Иначе
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.ИНН",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ИННФЛ"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.СвГосРегИП"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.ИныеСведения",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ИныеСвед"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.Фамилия",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ФИО.Фамилия"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.Имя",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ФИО.Имя"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".ТипУчастника.ИП.Отчество",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ФИО.Отчество"));
	
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес") <> Неопределено Тогда

		Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ") <> Неопределено Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.Индекс",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.Индекс"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.КодРегиона",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.КодРегион"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.Район",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.Район"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.Город",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.Город"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.НаселенныйПункт",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.НаселПункт"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.Улица",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.Улица"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.Дом",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.Дом"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.Корпус",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.Корпус"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресРФ.Квартира",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрРФ.Кварт"));
										
		ИначеЕсли СведенияОбУчастнике.Адрес.АдрИнф <> Неопределено Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресИнформация.КодСтраны",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрИнф.КодСтр"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.АдресИнформация.АдресТекст",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.АдрИнф.АдрТекст"));
										
		Иначе
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".Адрес.КодГАР",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес.КодГАР"));
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Контакт") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".КонтактныеСведения.Телефон",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Контакт.Тлф"));
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
									ДеревоДанных,
									ВидУчастника + ".КонтактныеСведения.ЭлектроннаяПочта",
									ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Контакт.ЭлПочта"));
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
				ДеревоДанных,
				ВидУчастника + ".БанковскиеРеквизиты.НомерСчета",
				ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.НомерСчета"));
				
		Если ЗначениеСвойстваXDTO(СведенияОбУчастнике.БанкРекв, "СвБанк") <> Неопределено Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.НаименованиеБанка",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.СвБанк.НаимБанк"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.БИКБанка",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.СвБанк.БИК"));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
										ДеревоДанных,
										ВидУчастника + ".БанковскиеРеквизиты.КорреспондентскийСчетБанка",
										ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.СвБанк.КорСчет"));
		
		КонецЕсли;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".КодОКПО",
		ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ОКПО"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".СтруктурноеПодразделение",
		ЗначениеСвойстваXDTO(СведенияОбУчастнике, "СтруктПодр"));
		
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ИнформацияДляУчастника",
		ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИнфДляУчаст"));
	
КонецПроцедуры

Процедура ПрочитатьИнформациюПокупателяXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УПД_ИнформацияПокупателя");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
		
	ФункцияДокумента = ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.Функция");
	Если ФункцияДокумента = "С" ИЛИ ФункцияДокумента = "СЧФДОП" Тогда
		НовыйЭД.ВидЭД               = Перечисления.ВидыЭД.СчетФактура;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД;
	ИначеЕсли ФункцияДокумента = "Д" ИЛИ ФункцияДокумента = "ДОП" Тогда
		НовыйЭД.ВидЭД               = Перечисления.ВидыЭД.ТОРГ12Покупатель;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование",
		ЗначениеСвойстваXDTO(ЭД, "ИнфПок.НаимЭконСубСост"));
		
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаДоверенность",
		ЗначениеСвойстваXDTO(ЭД, "ИнфПок.ОснДоверОргСост"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации",
		ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СодОпер"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДатаПолученияТоваров", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.ДатаПрин", "Дата"));
	
	Если ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин") <> Неопределено Тогда
		
		Если ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок") <> Неопределено Тогда
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Должность",
				ЭД.ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок.Должность);
				
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.ИныеСведения",
				ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок.ИныеСвед"));
				
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.ОснованиеПолномочий",
				ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок.ОснПолн"));
				
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Фамилия",
				ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок.ФИО.Фамилия"));
				
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Имя",
				ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок.ФИО.Имя"));
				
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Отчество",
				ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.РабОргПок.ФИО.Отчество"));
			
		ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо") <> Неопределено Тогда
			Если ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин") <> Неопределено Тогда
				
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Должность",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.Должность"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.ИныеСведения",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.ИныеСвед"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.НаименованиеОрганизации",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.НаимОргПрин"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.ДоверенностьНаПринятие",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.ОснДоверОргПрин"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.ОснованиеПолномочий",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.ОснПолнПредПрин"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.ФИО.Фамилия"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Имя",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.ФИО.Имя"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ПредОргПрин.ФИО.Отчество"));
				
			ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ФЛПрин") <> Неопределено Тогда
				
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.ИныеСведения",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ФЛПрин.ИныеСвед"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.ДоверенностьНаПринятие",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ФЛПрин.ОснДоверФЛ"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Фамилия",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ФЛПрин.ФИО.Фамилия"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Имя",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ФЛПрин.ФИО.Имя"));
					
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Отчество",
					ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвПрин.СвЛицПрин.ИнЛицо.ФЛПрин.ФИО.Отчество"));
					
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.ИнфПолФХЖ4") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ДопДанныеДокументаПолучения.ИдентификаторФайла",
			ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.ИнфПолФХЖ4.ИдФайлИнфПол"));
			
		ТекстИнф = ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.ИнфПолФХЖ4.ТекстИнф",, Истина);
		Если ТекстИнф <> Неопределено Тогда
			
			ТекстоваяИнформация = Новый ТаблицаЗначений;
			ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
			ТекстоваяИнформация.Колонки.Добавить("Значение");
			
			Для Каждого СтрокаИнформации Из ТекстИнф Цикл
				НоваяСтрока = ТекстоваяИнформация.Добавить();
				НоваяСтрока.Идентификатор = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
				НоваяСтрока.Значение      = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
			КонецЦикла;
			
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТекстоваяИнформация, "ДопДанныеДокументаПолучения.ТекстоваяИнформация");
		КонецЕсли;
	КонецЕсли;
		
	Если ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", "");
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", НСтр("ru = 'ИП'"));
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.Должн"));
		
	КонецЕсли;
	
	НовыйЭД.ЗначениеРеквизита = ДеревоДанных;
	
КонецПроцедуры

Процедура ПрочитатьИнформациюПокупателяУКДXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УКД_ИнформацияПокупателя");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
	ФункцияДокумента = ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.ФункцияПр");
	Если ФункцияДокумента = "К" ИЛИ ФункцияДокумента = "КСЧФДИС" Тогда
		НовыйЭД.ВидЭД               = Перечисления.ВидыЭД.КорректировочныйСчетФактура;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД;
	ИначеЕсли ФункцияДокумента = "Д" ИЛИ ФункцияДокумента = "ДИС" Тогда
		НовыйЭД.ВидЭД               = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель;
		НовыйЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование",
		ЗначениеСвойстваXDTO(ЭД, "ИнфПок.НаимЭконСубСост"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаДоверенность",
		ЗначениеСвойстваXDTO(ЭД, "ИнфПок.ОснДоверОргСост"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации",
		ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвСоглас.СодОпер"));
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДатаСогласования", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.СвСоглас.ДатаСоглас", "Дата"));
	
	Если ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.ИнфПолФХЖ4") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных,
			"ДопДанныеДокументаПолучения.ИдентификаторФайла",
			ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.ИнфПолФХЖ4.ИдФайлИнфПол"));
			
		ТекстИнф = ЗначениеСвойстваXDTO(ЭД, "ИнфПок.СодФХЖ4.ИнфПолФХЖ4.ТекстИнф");
		Если ТекстИнф <> Неопределено Тогда
			
			ТекстоваяИнформация = Новый ТаблицаЗначений;
			ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
			ТекстоваяИнформация.Колонки.Добавить("Значение");
			
			Для Каждого СтрокаИнформации Из ТекстИнф Цикл
				НоваяСтрока               = ТекстоваяИнформация.Добавить();
				НоваяСтрока.Идентификатор = ЗначениеСвойстваXDTO(СтрокаИнформации, "Идентиф");
				НоваяСтрока.Значение      = ЗначениеСвойстваXDTO(СтрокаИнформации, "Значен");
			КонецЦикла;
			
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоДанных, ТекстоваяИнформация, "ДопДанныеДокументаПолучения.ТекстоваяИнформация");
		КонецЕсли;
	КонецЕсли;
		
	Если ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ФЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", "");
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ИП.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", НСтр("ru = 'ИП'"));
		
	ИначеЕсли ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ") <> Неопределено Тогда
		
		ФИО = Новый Структура;
		ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.ФИО.Фамилия",  "Строка"));
		ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.ФИО.Имя",      "Строка"));
		ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.ФИО.Отчество", "Строка"));
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
		ВставитьЗначениеВДерево(ДеревоДанных, "ДолжностьРуководителя", ЗначениеСвойстваXDTO(ЭД, "ИнфПок.Подписант.ЮЛ.Должн"));
		
	КонецЕсли;
	
	НовыйЭД.ЗначениеРеквизита = ДеревоДанных;
	
КонецПроцедуры

Функция СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД)
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("Владелец",                СсылкаНаОбъект);
	СтруктураЭД.Вставить("НаправлениеЭД",           Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Отправитель",             НастройкиОбменаЭД.ИдентификаторОрганизации);
	СтруктураЭД.Вставить("Получатель",              НастройкиОбменаЭД.ИдентификаторКонтрагента);
	СтруктураЭД.Вставить("НомерВерсииЭД",           ОбменСКонтрагентамиСлужебный.НомерВерсииЭДПоВладельцу(СсылкаНаОбъект));
	
	Если ТипЗнч(СсылкаНаОбъект) = Тип("Структура") И СсылкаНаОбъект.Свойство("Идентификатор") Тогда
		// Бизнес-сеть.
		СтруктураЭД.Вставить("НомерЭД",             СсылкаНаОбъект.Идентификатор);
	Иначе
		СтруктураЭД.Вставить("НомерЭД",             ВернутьИдЭД(СсылкаНаОбъект));
	КонецЕсли;
	
	СтруктураЭД.Вставить("ДатаЭД",                  ТекущаяДатаСеанса());
	
	СтруктураЭД.Вставить("Организация",             СсылкаНаОбъект.Организация);
	СтруктураЭД.Вставить("Контрагент",              НастройкиОбменаЭД.Контрагент);
	
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",      НастройкиОбменаЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",            НастройкиОбменаЭД.СоглашениеЭД);
	СтруктураЭД.Вставить("УникальныйИдентификатор", Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",     Перечисления.ТипыЭлементовВерсииЭД.ПервичныйЭД);
	
	ДокументыОснования = Новый Массив;
	ДокументыОснования.Добавить(СсылкаНаОбъект);
	СтруктураЭД.Вставить("ДокументыОснования",      ДокументыОснования);
	
	ТаблицаИдентификаторовОснований = Новый ТаблицаЗначений;
	ТаблицаИдентификаторовОснований.Колонки.Добавить("ИдентификаторДокументаОснования");
	ТаблицаИдентификаторовОснований.Колонки.Добавить("ИдентификаторЭДДокументаОснования");
	СтруктураЭД.Вставить("ИдентификаторыДокументовИЭДОснований", ТаблицаИдентификаторовОснований);
	
	Возврат СтруктураЭД;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД ТОРГ12(ответный титул).
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьТорг12ПокупательФНСCML(ДеревоДанных)
	
	ПространствоИменСхемы = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,"ПространствоИмен");
	
	Если ВРег(ПространствоИменСхемы) = ВРег("PTORG_5_01_02") Тогда
		
		НаименованиеОтправителя = "СвОЭДОтпрСФ";
		НаименованиеИД = "ИдЭДОСФ";
		
	Иначе
		
		Если Не ЗначениеЗаполнено(ПространствоИменСхемы) Тогда
			ПространствоИменСхемы = "PTORG12";
		КонецЕсли;
		НаименованиеОтправителя = "СвОЭДОтпр";
		НаименованиеИД = "ИдЭДО";
		
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,"ИдФайл"));
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор." + НаименованиеОтправителя, ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(
					СвОЭДОтпр,
					"НаимОрг",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(
					СвОЭДОтпр,
					"ИННЮЛ",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(
					СвОЭДОтпр,
					НаименованиеИД,
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, НаименованиеОтправителя, СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "КНД"), Истина, Ошибки);
		ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок"));
		ЗаполнитьСвойствоXDTO(Документ, "ДатаДок", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ВремДок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДок"), Истина, Ошибки);
		
		ИдТНО = ПолучитьОбъектТипаCML("Файл.Документ.ИдТНО", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(ИдТНО, "ИдФайлТН", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайлТН"), Истина, Ошибки);
		ДатаДокТН = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокТН"));
		ЗаполнитьСвойствоXDTO(ИдТНО, "ДатаДокТН", ДатаДокТН, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИдТНО, "ВремДокТН", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДокТН"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ИдТНО", ИдТНО, Истина, Ошибки);
		
		СвТНП = ПолучитьОбъектТипаCML("Файл.Документ.СвТНП", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СвТНП, "НаимПервДок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НаимПервДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвТНП, "ОКУДПервДок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОКУДПервДок"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвТНП, "НомФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомФорм"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвТНП, "НомТН", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерТоварнойНакладной"), , Ошибки);
		ДатаТоварнойНакладной = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаТоварнойНакладной"));
		ЗаполнитьСвойствоXDTO(СвТНП, "ДатаТН", ДатаТоварнойНакладной, Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаПолученияГруза")) Тогда
			ПолучилГруз = ПолучитьОбъектТипаCML("Файл.Документ.СвТНП.ПолучилГруз", ПространствоИменСхемы);
			ДатаПолучения = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаПолученияГруза"));
			ЗаполнитьСвойствоXDTO(ПолучилГруз, "ДатаПолуч", ДатаПолучения, Истина, Ошибки);
			
			Доверенность = ПолучитьОбъектТипаCML("ДоверенностьТип", ПространствоИменСхемы);
			Если ЗаполнитьДанныеДоверенностиCML(Доверенность, ДеревоДанных, Ошибки, ПространствоИменСхемы) Тогда
				ЗаполнитьСвойствоXDTO(ПолучилГруз, "Доверенность", Доверенность, , Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СвТНП, "ПолучилГруз", ПолучилГруз, , Ошибки);
		КонецЕсли;
		
		СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные", "ПолныйПуть", Истина);
		Если СтрокаДопДанных <> Неопределено Тогда
			ЗаполнитьДопДанныеИзДереваДанных(СвТНП, СтрокаДопДанных, "", СтруктураПараметров, ПространствоИменСхемы,
				"Файл.Документ.СвТНП.ИнфПол", "ТекстИнф", "Шапка", Неопределено, Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Документ, "СвТНП", СвТНП, Истина, Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		
		ЗаполнитьИППодписанта(Подписант, ПространствоИменСхемы, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "Подписант", Подписант, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
			
		// Удалим файл дополнительной информации в случае ошибок.
		Если СтруктураПараметров.Свойство("ПолноеИмяДопФайла") Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(СтруктураПараметров.ПолноеИмяДопФайла);
		КонецЕсли;
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Счет-фактура.
//
// Параметры:
//  СтруктураПараметров - структура параметров для формирования.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьАкт501ЗаказчикФНСCML(ДеревоДанных, ВерсияРегламентаЭДО)
	
	ФНСВерсия2 = Ложь;
	Если ВерсияРегламентаЭДО = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
		
		ПространствоИменСхемы = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПространствоИмен");
		
		Если Не ЗначениеЗаполнено(ПространствоИменСхемы) Тогда
			ПространствоИменСхемы = "ZAKTPRM_5_01_02";
		КонецЕсли;
		
		Если ПространствоИменСхемы = "ZAKTPRM_5_01_02" Тогда
			ФНСВерсия2 = Истина;
		КонецЕсли;
		
	Иначе
		ПространствоИменСхемы = "ZAKTPRM";
	КонецЕсли;;
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,"ИдФайл"));
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,"ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО")) Тогда
			Если ФНСВерсия2 Тогда
				НаименованиеОтправителя = "СвОЭДОтпрСФ";
				НаименованиеИд = "ИдЭДОСФ";
			Иначе
				НаименованиеОтправителя = "СвОЭДОтпр";
				НаименованиеИд = "ИдЭДО";
			КонецЕсли;
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор."+ НаименованиеОтправителя, ПространствоИменСхемы);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, НаименованиеИд, Реквизит, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, НаименованиеОтправителя, СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок"));
		ЗаполнитьСвойствоXDTO(Документ, "ДатаДок", Реквизит, Истина, Ошибки);
		Если ВерсияРегламентаЭДО = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
			Если ФНСВерсия2 Тогда
				ЗаполнитьСвойствоXDTO(Документ, "ВремДок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДок"), Истина, Ошибки);
			Иначе
				ЗаполнитьСвойствоXDTO(Документ, "ВремДок", Реквизит, Истина, Ошибки);
			КонецЕсли;
		Иначе
			ЗаполнитьСвойствоXDTO(Документ, "ВремДок", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДок"), Истина, Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "КНД"), Истина, Ошибки);
		
		ИдАктИ = ПолучитьОбъектТипаCML("Файл.Документ.СвАктИ.ИдАктИ", ПространствоИменСхемы);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайлАктИ");
		ЗаполнитьСвойствоXDTO(ИдАктИ, "ИдФайлАктИ", Реквизит, Истина, Ошибки);
		Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокАктИ"));
		ЗаполнитьСвойствоXDTO(ИдАктИ, "ДатаДокАктИ", Реквизит, Истина, Ошибки);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДокАктИ");
		ЗаполнитьСвойствоXDTO(ИдАктИ, "ВремДокАктИ", Реквизит, Истина, Ошибки);
		
		СведенияАктИ = ПолучитьОбъектТипаCML("Файл.Документ.СвАктИ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СведенияАктИ, "ИдАктИ", ИдАктИ, Истина, Ошибки);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НаимПервДок");
		ЗаполнитьСвойствоXDTO(СведенияАктИ, "НаимПервДок", Реквизит, Истина, Ошибки);
		
		СвАктИ = ПолучитьОбъектТипаCML("Файл.Документ.СвАктИ.СвАктИ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СвАктИ, "НомАкт", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерАкт"), , Ошибки);
		Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаАкт"));
		ЗаполнитьСвойствоXDTO(СвАктИ, "ДатаАкт", Реквизит, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(СведенияАктИ, "СвАктИ", СвАктИ, Истина, Ошибки);
		
		ПринялАкт = ПолучитьОбъектТипаCML("Файл.Документ.СвАктИ.Принял", ПространствоИменСхемы);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияПоВыполнениюУслуг.ДатаЗаказа")) Тогда
			Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияПоВыполнениюУслуг.ДатаЗаказа"));
			ЗаполнитьСвойствоXDTO(ПринялАкт, "ДатаЗаказ", Реквизит, , Ошибки);
		КонецЕсли;
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияПоВыполнениюУслуг.Претензия")) Тогда
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияПоВыполнениюУслуг.Претензия");
			ЗаполнитьСвойствоXDTO(ПринялАкт, "Претензия", Реквизит, , Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(СведенияАктИ, "Принял", ПринялАкт, Истина, Ошибки);
		
		СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные", "ПолныйПуть", Истина);
		Если СтрокаДопДанных <> Неопределено Тогда
			ЗаполнитьДопДанныеИзДереваДанных(СведенияАктИ, СтрокаДопДанных, "", СтруктураПараметров, ПространствоИменСхемы,
				"Файл.Документ.СвАктИ.ИнфПол", "ТекстИнф", "Шапка", Неопределено, Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Документ, "СвАктИ", СведенияАктИ, Истина, Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		
		ЗаполнитьИППодписанта(Подписант, ПространствоИменСхемы, Ошибки);

		ЗаполнитьСвойствоXDTO(Документ, "Подписант", Подписант, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
			
		// Удалим файл дополнительной информации в случае ошибок.
		Если СтруктураПараметров.Свойство("ПолноеИмяДопФайла") Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(СтруктураПараметров.ПолноеИмяДопФайла);
		КонецЕсли;
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Корректировочный документ(ответный титул).
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьКорректировочныйДокументПокупательCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	ПространствоИменСхемы = "PKORDOC";
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,"ИдФайл"));
	
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПок",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдПок"),  Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор.СвОЭДОтпр", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(
					СвОЭДОтпр,
					"НаимОрг",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(
					СвОЭДОтпр,
					"ИННЮЛ",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(
					СвОЭДОтпр,
					"ИдЭДО",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, "СвОЭДОтпр",СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(
				Документ,
				"ДатаДок",
				ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок")),
				Истина,
				Ошибки);
		ЗаполнитьСвойствоXDTO(
				Документ,
				"ВремДок",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДок"),
				Истина,
				Ошибки);
		
		ИдТНО = ПолучитьОбъектТипаCML("Файл.Документ.ИдТНО", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(ИдТНО, "ИдФайлТН", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайлТН"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(
				ИдТНО,
				"ДатаДокТН",
				ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокТН")),
				Истина,
				Ошибки);
		ЗаполнитьСвойствоXDTO(ИдТНО, "ВремДокТН", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВремДокТН"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ИдТНО", ИдТНО, Истина, Ошибки);
		
		СвТНП = ПолучитьОбъектТипаCML("Файл.Документ.СвТНП", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СвТНП, "НомФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомФорм"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(
				СвТНП,
				"НомТН",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерТоварнойНакладной"),
				,
				Ошибки);
		ЗаполнитьСвойствоXDTO(
				СвТНП,
				"ДатаТН",
				ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаТоварнойНакладной")),
				Истина,
				Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаПолученияГруза")) Тогда
			ПолучилГруз = ПолучитьОбъектТипаCML("Файл.Документ.СвТНП.ПолучилГруз", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(
					ПолучилГруз,
					"ДатаПолуч",
					ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаПолученияГруза")),
					Истина,
					Ошибки);
					
			ЗаполнитьСвойствоXDTO(СвТНП, "ПолучилГруз", ПолучилГруз, , Ошибки);
		КонецЕсли;
		
		СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные", "ПолныйПуть", Истина);
		Если СтрокаДопДанных <> Неопределено Тогда
			ЗаполнитьДопДанныеИзДереваДанных(СвТНП, СтрокаДопДанных, "", СтруктураПараметров, ПространствоИменСхемы,
				"Файл.Документ.СвТНП.ИнфПол", "ТекстИнф", "Шапка", Неопределено, Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Документ, "СвТНП", СвТНП, Истина, Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Документ, "Подписант", Подписант, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
			
		// Удалим файл дополнительной информации в случае ошибок.
		Если СтруктураПараметров.Свойство("ПолноеИмяДопФайла") Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(СтруктураПараметров.ПолноеИмяДопФайла);
		КонецЕсли;
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Передача товаров данные продавца.
//
// Параметры:
//  ДеревоДокумента - дерево значений - данные для формирования.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьПередачаТоваровПродавецCML(ДеревоДанных)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ЗначениеРеквизитаДерева(ДеревоДанных,"ИдФайл"));
	
	ПространствоИменСхемы = ПространствоИменПередачаТоваровПродавец();
	НаименованиеОтправителя = "СвОЭДОтпр";
	НаименованиеИД = "ИдЭДО";
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЗначениеРеквизитаДерева(ДеревоДанных,"ПолноеИмяФайла"));
		
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЗначениеРеквизитаДерева(ДеревоДанных,"ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЗначениеРеквизитаДерева(ДеревоДанных, "ВерсПрог"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЗначениеРеквизитаДерева(ДеревоДанных,"ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЗначениеРеквизитаДерева(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПол", ЗначениеРеквизитаДерева(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор." + НаименованиеОтправителя, ПространствоИменСхемы);
			НаимОрг = ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.НаимОрг");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг", НаимОрг, Истина, Ошибки);
			ИННЮЛ = ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.ИННЮЛ");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ", ИННЮЛ, Истина, Ошибки);
			ИдЭДО = ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.ИдЭДО");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, НаименованиеИД, ИдЭДО, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, НаименованиеОтправителя, СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЗначениеРеквизитаДерева(ДеревоДанных,"КНД"), Истина, Ошибки);
		ДатаДок = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных,"ДатаДок"));
		ЗаполнитьСвойствоXDTO(Документ, "ДатаИнфПр", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ВремИнфПр", ЗначениеРеквизитаДерева(ДеревоДанных,"ВремДок"), Истина, Ошибки);
		
		// Поля уникальные для документа "Передача товаров".
		НаименованиеПродавца = ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеСоставителяДокумента");
		Если Не ЗначениеЗаполнено(НаименованиеПродавца) Тогда
			НаименованиеПродавца = ДанныеУчастникаСделкиCML(ДеревоДанных,"Поставщик");
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(Документ, "НаимЭконСубСост", НаименованиеПродавца, Истина, Ошибки);
		
		НаименованиеДокумента = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр.НаимДок", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(НаименованиеДокумента, "ПоФактХЖ", НаименованиеФактаПередачаТоваров(), Истина, Ошибки);
		
		НаименованиеДокументаОтправителя = ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеДокументаОтправителя");
		ЗаполнитьСвойствоXDTO(НаименованиеДокумента, "НаимДокОпр", НаименованиеДокументаОтправителя, Истина, Ошибки);
		
		СведенияПродавца = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СведенияПродавца, "НаимДок", НаименованиеДокумента, Истина, Ошибки);
	
		НомерДатаДокумента = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр.ИдентДок", ПространствоИменСхемы);
		НомерНакладной = ЗначениеРеквизитаДерева(ДеревоДанных, "НомерТоварнойНакладной");
		ЗаполнитьСвойствоXDTO(НомерДатаДокумента, "НомДокПТ", НомерНакладной, Истина, Ошибки);
		
		ДатаНакладной = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаТоварнойНакладной"));
		ЗаполнитьСвойствоXDTO(НомерДатаДокумента, "ДатаДокПТ", ДатаНакладной, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(СведенияПродавца, "ИдентДок", НомерДатаДокумента);
		
		НомерИсправления = ЗначениеРеквизитаДерева(ДеревоДанных, "НомерИсправления");
		ДатаИсправления = ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаИсправления");
		Если ЗначениеЗаполнено(НомерИсправления) И ЗначениеЗаполнено(ДатаИсправления) Тогда
			НомерДатаИсправления = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр.ИспрДокПТ", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(НомерДатаИсправления, "НомИспрДокПТ", НомерИсправления, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(НомерДатаИсправления, "ДатаИспрДокПТ", ДатаДД_ММ_ГГГГ(ДатаИсправления), Истина, Ошибки);
			
			ЗаполнитьСвойствоXDTO(СведенияПродавца, "ИспрДокПТ", НомерДатаИсправления);
			
		КонецЕсли;
		
		ДенежныеПоказатели = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр.ДенИзм", ПространствоИменСхемы);
		КодВалюты = ЗначениеРеквизитаДерева(ДеревоДанных, "ВалютаКод");
		ЗаполнитьСвойствоXDTO(ДенежныеПоказатели, "КодОКВ", КодВалюты, Истина, Ошибки);
		
		ЗаполнитьНаименованиеВалютыXML(ДенежныеПоказатели, КодВалюты, Ошибки);

		ЗаполнитьСвойствоXDTO(СведенияПродавца, "ДенИзм", ДенежныеПоказатели, Истина, Ошибки);
			
		СведенияСделки = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1", ПространствоИменСхемы);
		
		ВидОперации = ЗначениеРеквизитаДерева(ДеревоДанных, "ВидОперации");
		ЗаполнитьСвойствоXDTO(СведенияСделки, "ВидОперации", XMLСтрока(ВидОперации), , Ошибки);
		
		ИдГосКонтракта = ЗначениеРеквизитаДерева(ДеревоДанных, "ИдГосКонтракта");
		ЗаполнитьСвойствоXDTO(СведенияСделки, "ИдГосКон", XMLСтрока(ИдГосКонтракта), , Ошибки);
		
		Грузоотправитель = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ГрузоотправительЗаполнен = ЗаполнитьДанныеУчастникаФНС(Грузоотправитель, ДеревоДанных, Ошибки,
			ПространствоИменСхемы, "Грузоотправитель");
		Если ГрузоотправительЗаполнен Тогда
			ЗаполнитьСвойствоXDTO(СведенияСделки, "ГрузОтпр", Грузоотправитель, , Ошибки);
		КонецЕсли;
		
		Грузополучатель = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ГрузополучательЗаполнен = ЗаполнитьДанныеУчастникаФНС(Грузополучатель, ДеревоДанных, Ошибки,
			ПространствоИменСхемы, "Грузополучатель");
		Если ГрузополучательЗаполнен Тогда
			ЗаполнитьСвойствоXDTO(СведенияСделки, "ГрузПолуч", Грузополучатель, , Ошибки);
		КонецЕсли;
		
		Продавец = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ПродавецЗаполнен = ЗаполнитьДанныеУчастникаФНС(Продавец, ДеревоДанных, Ошибки,
			ПространствоИменСхемы, "Поставщик");
		Если ПродавецЗаполнен Тогда
			ЗаполнитьСвойствоXDTO(СведенияСделки, "Продавец", Продавец, Истина, Ошибки);
		КонецЕсли;
		
		Покупатель = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ПокупательЗаполнен = ЗаполнитьДанныеУчастникаФНС(Покупатель, ДеревоДанных, Ошибки,
			ПространствоИменСхемы, "Плательщик");
		Если ПокупательЗаполнен Тогда
			ЗаполнитьСвойствоXDTO(СведенияСделки, "Покупатель", Покупатель, Истина, Ошибки);
		КонецЕсли;
		
		ДеревоДанныхОснование = ЗначениеТаблицыДереваЭД(ДеревоДанных, "Основание");
		Если ЗначениеЗаполнено(ДеревоДанныхОснование) Тогда
			Для Каждого СтрокаДереваОснование Из ДеревоДанныхОснование.Строки Цикл
				Основание = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.Основание", ПространствоИменСхемы);
				
				ДокОснованиеНаименование = ЗначениеРеквизитаДерева(СтрокаДереваОснование, "Основание.НомерСтроки.ДокОснованиеНаименование");
				Если Не ЗначениеЗаполнено(ДокОснованиеНаименование) Тогда
					ДокОснованиеНаименование = "-";
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(Основание, "НаимОсн", ДокОснованиеНаименование, Истина, Ошибки);
				
				НомерОснования = ЗначениеРеквизитаДерева(ДеревоДанных, "Основание.НомерСтроки.ДокОснованиеНомер");
				ЗаполнитьСвойствоXDTO(Основание, "НомОсн", НомерОснования, , Ошибки);
				
				ДатаОснования = ЗначениеРеквизитаДерева(ДеревоДанных, "Основание.НомерСтроки.ДокОснованиеДата");
				Если ЗначениеЗаполнено(ДатаОснования) Тогда
					ЗаполнитьСвойствоXDTO(Основание, "ДатаОсн", ДатаДД_ММ_ГГГГ(ДатаОснования), , Ошибки);
				КонецЕсли;
				
				ДопСведенияОснования = ЗначениеРеквизитаДерева(ДеревоДанных, "Основание.НомерСтроки.ДокОснованиеДопСведения");
				ЗаполнитьСвойствоXDTO(Основание, "ДопСвОсн", ДопСведенияОснования, , Ошибки);
				
				СведенияСделки.Основание.Добавить(Основание);
				
			КонецЦикла;
				
		Иначе
			Основание = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.Основание", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(Основание, "НаимОсн", "-", Истина, Ошибки);
			СведенияСделки.Основание.Добавить(Основание);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(СведенияПродавца, "СодФХЖ1", СведенияСделки, Истина, Ошибки);
		
		СведенияДокумента = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СведенияДокумента, "СвДокПТПр", СведенияПродавца, Истина, Ошибки);
		
		СведенияОТоварах = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СодФХЖ2", ПространствоИменСхемы);
		
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("ТаблицаТоваров", "ПолныйПуть");
		
		Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
			
			СведТов =  ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СодФХЖ2.СвТов", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(СведТов, "НомТов", Товар.Значение, Истина, Ошибки);
			
			БазоваяЕдиницаКод = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.БазоваяЕдиницаКод");
			ЗаполнитьСвойствоXDTO(СведТов, "ОКЕИ_Тов", СокрЛП(БазоваяЕдиницаКод), , Ошибки);
			
			Реквизит = Строка(ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.ЕдиницаИзмеренияНаименование"));
			ЗаполнитьСвойствоXDTO(СведТов, "НаимЕдИзм", Реквизит, Истина, Ошибки);
			
			МассаНетто = ?(ЗначениеЗаполнено(ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.МассаНетто")),
							ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.МассаНетто"),
							0);
			ЗаполнитьСвойствоXDTO(СведТов, "НеттоПередано", МассаНетто, Истина, Ошибки);
			
			НаименованиеНоменклатуры = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.НаименованиеНоменклатуры");
			ЗаполнитьСвойствоXDTO(СведТов, "НаимТов", НаименованиеНоменклатуры, , Ошибки);
			
			НаименованиеХарактеристики = ЗначениеРеквизитаДерева(Товар,
			                                                      "ТаблицаТоваров.НомерСтроки.НаименованиеХарактеристики");
			ЗаполнитьСвойствоXDTO(СведТов, "ХарактерТов", НаименованиеХарактеристики, , Ошибки);
			
			Сорт = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.Сорт");
			ЗаполнитьСвойствоXDTO(СведТов, "СортТов", Сорт, , Ошибки);
			
			Артикул = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.Артикул");
			ЗаполнитьСвойствоXDTO(СведТов, "АртикулТов", Артикул, , Ошибки);
			
			КодТовара = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.КодТовара");
			ЗаполнитьСвойствоXDTO(СведТов, "КодТов", КодТовара, , Ошибки);
			
			ВидУпаковки = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.ВидУпаковки");
			ЗаполнитьСвойствоXDTO(СведТов, "ВидУпак", ВидУпаковки, , Ошибки);
			
			КоличествоВОдномМесте = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.КоличествоВОдномМесте");
			ЗаполнитьСвойствоXDTO(СведТов, "Место", КоличествоВОдномМесте, , Ошибки);
			
			КоличествоМест = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.КоличествоМест");
			ЗаполнитьСвойствоXDTO(СведТов, "КолМест", КоличествоМест, , Ошибки);
			
			МассаБрутто = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.МассаБрутто");
			ЗаполнитьСвойствоXDTO(СведТов, "Брутто", МассаБрутто, , Ошибки);
			
			МассаНетто = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.МассаНетто");
			ЗаполнитьСвойствоXDTO(СведТов, "НеттоПередано", МассаНетто, , Ошибки);
			
			Цена = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.Цена");
			ЗаполнитьСвойствоXDTO(СведТов, "Цена", Цена, , Ошибки);
			
			СуммаБезНДС = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СуммаБезНДС");
			ЗаполнитьСвойствоXDTO(СведТов, "СтБезНДС", СуммаБезНДС, , Ошибки);
			
			СтавкаНДС = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СтавкаНДС");
			ПеречислениеСтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСПеречисление(СтавкаНДС);
			Если ЗначениеЗаполнено(ПеречислениеСтавкаНДС) Тогда
				ЗаполнитьСвойствоXDTO(СведТов, "НалСт", ПеречислениеСтавкаНДС, , Ошибки);
			КонецЕсли;
			
			СуммаСНДС = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СуммаСНДС");
			ЗаполнитьСвойствоXDTO(СведТов, "СтУчНДС", СуммаСНДС, Истина, Ошибки);
			
			СуммаНДС = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СуммаНДС");
			ЗаполнитьСвойствоXDTO(СведТов, "СумНДС", СуммаНДС, , Ошибки);
			
			ЗаполнитьДопДанныеТаблицыПередачиТоваров(СведТов, Товар, СтруктураПараметров, ПространствоИменСхемы, Ошибки);
			
			СведенияОТоварах.СвТов.Добавить(СведТов);
			
		КонецЦикла;
		
		// Заполняем Итоги табличной части
		КоличествоМест = ЗначениеРеквизитаДерева(ДеревоДанных, "ВсегоПоНакладной.КоличествоМест");
		МассаБрутто = ЗначениеРеквизитаДерева(ДеревоДанных, "ВсегоПоНакладной.МассаБрутто");
		МассаНетто = ЗначениеРеквизитаДерева(ДеревоДанных, "ВсегоПоНакладной.МассаНетто");
		СуммаБезНДС = ЗначениеРеквизитаДерева(ДеревоДанных, "ВсегоПоНакладной.СуммаБезНДС");
		СуммаНДС = ЗначениеРеквизитаДерева(ДеревоДанных, "ВсегоПоНакладной.СуммаНДС");
		СуммаСНДС = ЗначениеРеквизитаДерева(ДеревоДанных, "ВсегоПоНакладной.СуммаСНДС");
		Если ЗначениеЗаполнено(КоличествоМест) 
			Или ЗначениеЗаполнено(МассаБрутто)
			Или ЗначениеЗаполнено(МассаНетто)
			Или ЗначениеЗаполнено(СуммаБезНДС)
			Или ЗначениеЗаполнено(СуммаНДС) Тогда
			
			Итоги = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПТПрКроме.СодФХЖ2.Всего", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(Итоги, "КолМестВс", КоличествоМест, , Ошибки);
			ЗаполнитьСвойствоXDTO(Итоги, "БруттоВс", МассаБрутто, , Ошибки);
			ЗаполнитьСвойствоXDTO(Итоги, "НеттоВс", МассаНетто, , Ошибки);
			ЗаполнитьСвойствоXDTO(Итоги, "СтБезНДСВс", СуммаБезНДС, , Ошибки);
			ЗаполнитьСвойствоXDTO(Итоги, "СумНДСВс", СуммаНДС, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(Итоги, "СтУчНДСВс", СуммаСНДС, Истина, Ошибки);
			
			ЗаполнитьСвойствоXDTO(СведенияОТоварах, "Всего", Итоги, , Ошибки);
			
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(СведенияДокумента, "СодФХЖ2", СведенияОТоварах, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "СвДокПТПрКроме", СведенияДокумента, Истина, Ошибки);

		СведенияОПередаче = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3", ПространствоИменСхемы);
		
		СодержаниеОперации = СодержаниеОперацииПередачаТоваров();
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "СодОпер", СодержаниеОперации, ,Ошибки);
		
		КоличествоЛистов = ЗначениеРеквизитаДерева(ДеревоДанных, "ОбщиеСведенияОТоварнойНакладной.КоличествоПорядковыхНомеровЗаписей");
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "КолПрил", КоличествоЛистов, ,Ошибки);
		
		СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные", "ПолныйПуть", Истина);
		Если СтрокаДопДанных <> Неопределено Тогда
			ЗаполнитьДопДанныеШапкиДокумента(СведенияОПередаче, ДеревоДанных, ПространствоИменСхемы, СтруктураПараметров, Ошибки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияПоОтпускуГруза.ДатаОтпуска")) Тогда
			Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияПоОтпускуГруза.ДатаОтпуска"));
			ЗаполнитьСвойствоXDTO(СведенияОПередаче, "ДатаОтпуск", Реквизит, , Ошибки);
		КонецЕсли;
		
		// Заполняем таблицу ТранспортнаяНакладная
		ТранспортнаяНакладнаяДеревоДанных = ЗначениеТаблицыДереваЭД(ДеревоДанных, "ТранспортнаяНакладная");
		Если ЗначениеЗаполнено(ТранспортнаяНакладнаяДеревоДанных) Тогда
			
			Для Каждого СтрокаТранспортнаяНакладная Из ТранспортнаяНакладнаяДеревоДанных.Строки Цикл
				
				НомерНакладной = ЗначениеРеквизитаДерева(СтрокаТранспортнаяНакладная, "ТранспортнаяНакладная.НомерСтроки.ТранспортнаяНакладнаяНомер");
				ДатаНакладной = ЗначениеРеквизитаДерева(СтрокаТранспортнаяНакладная, "ТранспортнаяНакладная.НомерСтроки.ТранспортнаяНакладнаяДата");
				Если ЗначениеЗаполнено(НомерНакладной) И ЗначениеЗаполнено(ДатаНакладной) Тогда
					ТранспортнаяНакладная = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3.ТранНакл", ПространствоИменСхемы);
					ЗаполнитьСвойствоXDTO(ТранспортнаяНакладная, "НомТранНакл", НомерНакладной, , Ошибки);
					ЗаполнитьСвойствоXDTO(ТранспортнаяНакладная, "ДатаТранНакл", ДатаДД_ММ_ГГГГ(ДатаНакладной), , Ошибки);
					СведенияОПередаче.ТранНакл.Добавить(ТранспортнаяНакладная);
				КонецЕсли;
				
			КонецЦикла;
		КонецЕсли;
		
		ЗаполнитьСведенияОЛицеПередавшемТовар(ДеревоДанных, СведенияОПередаче, ПространствоИменСхемы, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "СодФХЖ3", СведенияОПередаче, Истина, Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолн", ДолжностныеОбязанности(), Истина, Ошибки);
		
		// В подписанте пустым значением заполняется поле Физ.лицо.
		ЗаполнитьФизЛицоПодписанта(Подписант, ПространствоИменСхемы, Ошибки);
		
		Документ.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ВызватьИсключение ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
		УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
		Возврат Истина;
		
	Исключение
		ТекстСообщения = ?(ЗначениеЗаполнено(Ошибки), 
			ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки),
			КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		
		// Удалим файл дополнительной информации в случае ошибок.
		Если СтруктураПараметров.Свойство("ПолноеИмяДопФайла") Тогда
			УдалитьФайлы(СтруктураПараметров.ПолноеИмяДопФайла);
		КонецЕсли;
		
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Возвращает результат формирования файла ЭД Передача товаров данные покупателя.
//
// Параметры:
//  ДеревоДокумента - дерево значений - данные для формирования.
//
// Возвращаемое значение:
//  Булево - результат корректного формирования.
//
Функция СформироватьПередачаТоваровПокупательCML(ДеревоДанных)
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ЗначениеРеквизитаДерева(ДеревоДанных,"ИдФайл"));
	
	ПространствоИменСхемы = "TORGPOK";
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЗначениеРеквизитаДерева(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЗначениеРеквизитаДерева(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЗначениеРеквизитаДерева(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЗначениеРеквизитаДерева(ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		СведенияУчастника = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СведенияУчастника, "ИдОтпр", ЗначениеРеквизитаДерева(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СведенияУчастника, "ИдПол", ЗначениеРеквизитаДерева(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СведенияОтправителя = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор.СвОЭДОтпр", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(
					СведенияОтправителя,
					"НаимОрг",
					ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(
					СведенияОтправителя,
					"ИННЮЛ",
					ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(
					СведенияОтправителя,
					"ИдЭДО",
					ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО"),
					Истина,
					Ошибки);
			ЗаполнитьСвойствоXDTO(СведенияУчастника, "СвОЭДОтпр", СведенияОтправителя, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СведенияУчастника, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		
		НаименованиеСубъекта = ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеОрганизации");
		ЗаполнитьСвойствоXDTO(Документ, "НаимЭконСубСост", НаименованиеСубъекта, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЗначениеРеквизитаДерева(ДеревоДанных, "КНД"), Истина, Ошибки);
		ДатаДок = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДок"));
		ЗаполнитьСвойствоXDTO(Документ, "ДатаИнфПок", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ВремИнфПок", ЗначениеРеквизитаДерева(ДеревоДанных, "ВремДок"), Истина, Ошибки);
		
		ИнформацияПродавца = ПолучитьОбъектТипаCML("Файл.Документ.ИдДокПТПр", ПространствоИменСхемы);
		ИмяФайлаПродавца = ЗначениеРеквизитаДерева(ДеревоДанных, "ИмяФайлаПродавца");
		ЗаполнитьСвойствоXDTO(ИнформацияПродавца, "ИдФайлИнфПр", ИмяФайлаПродавца, Истина, Ошибки);
		ДатаДокТН = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаДокТН"));
		ЗаполнитьСвойствоXDTO(ИнформацияПродавца, "ДатаФайлИнфПр", ДатаДокТН, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ИнформацияПродавца, "ВремФайлИнфПр", ЗначениеРеквизитаДерева(ДеревоДанных, "ВремДокТН"), Истина, Ошибки);
		
		Подписи = ЗначениеРеквизитаДерева(ДеревоДанных, "ПолученныеЭП");
		Если Не ЗначениеЗаполнено(Подписи) Тогда
			Подписи = Новый Массив;
			Подписи.Добавить("---");
		КонецЕсли;
		Для Каждого Подпись Из Подписи Цикл
			ИнформацияПродавца.ЭП.Добавить(Подпись);
		КонецЦикла;
		
		ЗаполнитьСвойствоXDTO(Документ, "ИдДокПТПр", ИнформацияПродавца, Истина, Ошибки);
		
		СведенияОбОперации = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ4", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СведенияОбОперации, "НаимДокОпрПр", ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеДокументаОтправителя"), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(СведенияОбОперации, "НомДокПТПр", ЗначениеРеквизитаДерева(ДеревоДанных, "НомерТоварнойНакладной"), , Ошибки);
		ДатаТоварнойНакладной = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаТоварнойНакладной"));
		ЗаполнитьСвойствоXDTO(СведенияОбОперации, "ДатаДокПТПр", ДатаТоварнойНакладной, Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаПолученияГруза")) Тогда
			ПолучилГруз = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ4.ГрузПолучил", ПространствоИменСхемы);
			ДатаПолучения = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаПолученияГруза"));
			ЗаполнитьСвойствоXDTO(ПолучилГруз, "ДатаПолуч", ДатаПолучения, Истина, Ошибки);
			
			ЗаполнитьСвойствоXDTO(ПолучилГруз, "СодОпер", СодержаниеОперацииПередачаТоваровПокупатель(), , Ошибки);
			
			ЗаполнитьСвойствоXDTO(СведенияОбОперации, "ГрузПолучил", ПолучилГруз, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Документ, "СодФХЖ4", СведенияОбОперации, Истина, Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолн", ДолжностныеОбязанности(), Истина, Ошибки);
		
		// В подписанте пустым значением заполняется поле Физ.лицо.
		ЗаполнитьФизЛицоПодписанта(Подписант, ПространствоИменСхемы, Ошибки);
		
		Документ.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
			
		// Удалим файл дополнительной информации в случае ошибок.
		Если СтруктураПараметров.Свойство("ПолноеИмяДопФайла") Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(СтруктураПараметров.ПолноеИмяДопФайла);
		КонецЕсли;
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат формирования файла ЭД Передача работ данные исполнителя.
//
// Параметры:
//  ДеревоДанных - ДеревоЗначений - данные для формирования.
//
// Возвращаемое значение:
//  Булево - признак корректного формирования.
//
Функция СформироватьПередачаРаботИсполнительCML(ДеревоДанных)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ЗначениеРеквизитаДерева(ДеревоДанных,"ИдФайл"));
	
	ПространствоИменСхемы = ПространствоИменПередачаРаботИсполнитель();
	НаименованиеОтправителя = "СвОЭДОтпр";
	НаименованиеИД = "ИдЭДО";
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЗначениеРеквизитаДерева(ДеревоДанных,"ПолноеИмяФайла"));
		
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЗначениеРеквизитаДерева(ДеревоДанных,"ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЗначениеРеквизитаДерева(ДеревоДанных, "ВерсПрог"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЗначениеРеквизитаДерева(ДеревоДанных,"ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЗначениеРеквизитаДерева(ДеревоДанных, "ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПол", ЗначениеРеквизитаДерева(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор." + НаименованиеОтправителя, ПространствоИменСхемы);
			НаимОрг = ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.НаимОрг");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг", НаимОрг, Истина, Ошибки);
			ИННЮЛ = ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.ИННЮЛ");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ", ИННЮЛ, Истина, Ошибки);
			ИдЭДО = ЗначениеРеквизитаДерева(ДеревоДанных,"РеквизитыОператораЭДО.ИдЭДО");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, НаименованиеИД, ИдЭДО, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, НаименованиеОтправителя, СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЗначениеРеквизитаДерева(ДеревоДанных,"КНД"), Истина, Ошибки);
		ДатаДок = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных,"ДатаДок"));
		ЗаполнитьСвойствоXDTO(Документ, "ДатаИнфИсп", ДатаДок, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ВремИнфИсп", ЗначениеРеквизитаДерева(ДеревоДанных,"ВремДок"), Истина, Ошибки);
		
		// Поля уникальные для документа "Передача товаров".
		НаименованиеПродавца = ДанныеУчастникаСделкиCML(ДеревоДанных,"Исполнитель");
		ЗаполнитьСвойствоXDTO(Документ, "НаимЭконСубСост", НаименованиеПродавца, Истина, Ошибки);
		
		НаименованиеДокумента = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.НаимДок", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(НаименованиеДокумента, "ПоФактХЖ", НаименованиеФактаПередачаРабот(), Истина, Ошибки);
		НаименованиеДокументаОтправителя = ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеДокументаОтправителя");
		ЗаполнитьСвойствоXDTO(НаименованиеДокумента, "НаимДокОпр", НаименованиеДокументаОтправителя, Истина, Ошибки);
		
		СведенияДокумента = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СведенияДокумента, "НаимДок", НаименованиеДокумента, Истина, Ошибки);
	
		НомерДатаДокумента = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.ИдентДок", ПространствоИменСхемы);
		НомерАкта = ЗначениеРеквизитаДерева(ДеревоДанных, "НомерАкта");
		ЗаполнитьСвойствоXDTO(НомерДатаДокумента, "НомДокПРУ", НомерАкта, Истина, Ошибки);
		
		ДатаАкта = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаАкта"));
		ЗаполнитьСвойствоXDTO(НомерДатаДокумента, "ДатаДокПРУ", ДатаАкта, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(СведенияДокумента, "ИдентДок", НомерДатаДокумента);
		
		НомерИсправления = ЗначениеРеквизитаДерева(ДеревоДанных, "НомерИсправления");
		ДатаИсправления = ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаИсправления");
		Если ЗначениеЗаполнено(НомерИсправления) И ЗначениеЗаполнено(ДатаИсправления) Тогда
			НомерДатаИсправления = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.ИспрДокПРУ", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(НомерДатаИсправления, "НомИспрДокПРУ", НомерИсправления, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(НомерДатаИсправления, "ДатаИспрДокПРУ", ДатаДД_ММ_ГГГГ(ДатаИсправления), Истина, Ошибки);
			
			ЗаполнитьСвойствоXDTO(СведенияДокумента, "ИспрДокПРУ", НомерДатаИсправления);
			
		КонецЕсли;
		
		ДенежныеПоказатели = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.ДенИзм", ПространствоИменСхемы);
		КодВалюты = ЗначениеРеквизитаДерева(ДеревоДанных, "ВалютаКод");		
		ЗаполнитьСвойствоXDTO(ДенежныеПоказатели, "КодОКВ", КодВалюты, Истина, Ошибки);
		ЗаполнитьНаименованиеВалютыXML(ДенежныеПоказатели, КодВалюты, Ошибки);
		
		ЗаполнитьСвойствоXDTO(СведенияДокумента, "ДенИзм", ДенежныеПоказатели, Истина, Ошибки);
		
		СведенияСделки = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.СодФХЖ1", ПространствоИменСхемы);
		
		ЗаголовокОперации = ЗначениеРеквизитаДерева(ДеревоДанных, "Заголовок");
		ЗаполнитьСвойствоXDTO(СведенияСделки, "ЗагСодОпер", ЗаголовокОперации, , Ошибки);
		
		ВидОперации = ЗначениеРеквизитаДерева(ДеревоДанных, "ВидОперации");
		ЗаполнитьСвойствоXDTO(СведенияСделки, "ВидОперации",  XMLСтрока(ВидОперации), , Ошибки);
		
		ИдГосКонтракта = ЗначениеРеквизитаДерева(ДеревоДанных, "ИдГосКонтракта");
		ЗаполнитьСвойствоXDTO(СведенияСделки, "ИдГосКон", XMLСтрока(ИдГосКонтракта), , Ошибки);
		
		Исполнитель = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ИсполнительЗаполнен = ЗаполнитьДанныеУчастникаФНС(Исполнитель, ДеревоДанных, Ошибки,
			ПространствоИменСхемы, "Исполнитель");
		Если ИсполнительЗаполнен Тогда
			ЗаполнитьСвойствоXDTO(СведенияСделки, "Исполнитель", Исполнитель, , Ошибки);
		КонецЕсли;
		
		Заказчик = ПолучитьОбъектТипаCML("УчастникТип", ПространствоИменСхемы);
		ЗаказчикЗаполнен = ЗаполнитьДанныеУчастникаФНС(Заказчик, ДеревоДанных, Ошибки,
			ПространствоИменСхемы, "Заказчик");
		Если ЗаказчикЗаполнен Тогда
			ЗаполнитьСвойствоXDTO(СведенияСделки, "Заказчик", Заказчик, , Ошибки);
		КонецЕсли;
		
		// Заполним сведения об основании выполнения работ.
		ДеревоДанныхОснование = ЗначениеТаблицыДереваЭД(ДеревоДанных, "Основание");
		Если ЗначениеЗаполнено(ДеревоДанныхОснование) Тогда
			Для Каждого СтрокаДереваОснование Из ДеревоДанныхОснование.Строки Цикл
				Основание = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.СодФХЖ1.Основание", ПространствоИменСхемы);
				
				ДокОснованиеНаименование = ЗначениеРеквизитаДерева(СтрокаДереваОснование, "Основание.НомерСтроки.ДокОснованиеНаименование");
				Если Не ЗначениеЗаполнено(ДокОснованиеНаименование) Тогда
					ДокОснованиеНаименование = "-";
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(Основание, "НаимОсн", ДокОснованиеНаименование, Истина, Ошибки);
				
				НомерОснования = ЗначениеРеквизитаДерева(ДеревоДанных, "Основание.НомерСтроки.ДокОснованиеНомер");
				ЗаполнитьСвойствоXDTO(Основание, "НомОсн", НомерОснования, , Ошибки);
				
				ДатаОснования = ЗначениеРеквизитаДерева(ДеревоДанных, "Основание.НомерСтроки.ДокОснованиеДата");
				Если ЗначениеЗаполнено(ДатаОснования) Тогда
					ЗаполнитьСвойствоXDTO(Основание, "ДатаОсн", ДатаДД_ММ_ГГГГ(ДатаОснования), , Ошибки);
				КонецЕсли;
				
				ДопСведенияОснования = ЗначениеРеквизитаДерева(ДеревоДанных, "Основание.НомерСтроки.ДокОснованиеДопСведения");
				ЗаполнитьСвойствоXDTO(Основание, "ДопСвОсн", ДопСведенияОснования, , Ошибки);
				
				СведенияСделки.Основание.Добавить(Основание);
			КонецЦикла;
		Иначе
			Основание = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.СодФХЖ1.Основание", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(Основание, "НаимОсн", "-", Истина, Ошибки);
			СведенияСделки.Основание.Добавить(Основание);
		КонецЕсли;
		
		СведенияОРаботах = ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.СодФХЖ1.ОписРабот", ПространствоИменСхемы);
		
		СтрокаТаблицаРабот = ДеревоДанных.Строки.Найти("ТаблицаУслуг", "ПолныйПуть");
		
		Для Каждого Работа Из СтрокаТаблицаРабот.Строки Цикл
			
			ОписаниеРаботы =  ПолучитьОбъектТипаCML("Файл.Документ.СвДокПРУ.СодФХЖ1.ОписРабот.Работа", ПространствоИменСхемы);
			
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "Номер", Работа.Значение, Истина, Ошибки);
			
			НаименованиеНоменклатуры = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.НаименованиеНоменклатуры");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "НаимРабот", НаименованиеНоменклатуры, , Ошибки);
			
			ОписаниеНоменклатуры = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.Описание");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "Описание", ОписаниеНоменклатуры, , Ошибки);
			
			БазоваяЕдиницаКод = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.ЕдиницаИзмеренияКод");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "ОКЕИ", СокрЛП(БазоваяЕдиницаКод), , Ошибки);
			
			НаименованиеЕдиницы = Строка(ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.ЕдиницаИзмеренияНаименование"));
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "НаимЕдИзм", НаименованиеЕдиницы, , Ошибки);
			
			МассаБрутто = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.Количество");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "Количество", МассаБрутто, , Ошибки);
			
			Цена = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.Цена");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "Цена", Цена, , Ошибки);
			
			// Сведения о стоимости работ.
			СуммаБезНДС = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.СуммаБезНДС");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "СтоимБезНДС", СуммаБезНДС, , Ошибки);
			
			СтавкаНДС = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.СтавкаНДС");
			ПеречислениеСтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСПеречисление(СтавкаНДС);
			Если ЗначениеЗаполнено(ПеречислениеСтавкаНДС) Тогда
				ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "НалСт", ПеречислениеСтавкаНДС, , Ошибки);
			КонецЕсли;
			
			СуммаСНДС = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.СуммаСНДС");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "СтоимУчНДС", СуммаСНДС, , Ошибки);
			
			СуммаНДС = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.СуммаНДС");
			ЗаполнитьСвойствоXDTO(ОписаниеРаботы, "СумНДС", СуммаНДС, , Ошибки);
			
			ЗаполнитьДопДанныеТаблицыПередачиТоваров(ОписаниеРаботы, Работа, СтруктураПараметров, ПространствоИменСхемы, Ошибки);
			
			СведенияОРаботах.Работа.Добавить(ОписаниеРаботы);
			
		КонецЦикла;
		
		// Заполняем Итоги табличной части.
		НачалоРабот = ЗначениеРеквизитаДерева(ДеревоДанных, "ОписаниеУслуги.НачалоРабот");
		КонецРабот = ЗначениеРеквизитаДерева(ДеревоДанных, "ОписаниеУслуги.КонецРабот");
		СуммаБезНДС = ЗначениеРеквизитаДерева(ДеревоДанных, "ОписаниеУслуги.СуммаБезНДСИтого");
		СуммаНДС = ЗначениеРеквизитаДерева(ДеревоДанных, "ОписаниеУслуги.СуммаНДСИтого");
		СуммаСНДС = ЗначениеРеквизитаДерева(ДеревоДанных, "ОписаниеУслуги.СуммаСНДСИтого");
		
		Если ЗначениеЗаполнено(НачалоРабот) 
			Или ЗначениеЗаполнено(КонецРабот)
			Или ЗначениеЗаполнено(СуммаБезНДС)
			Или ЗначениеЗаполнено(СуммаНДС)
			Или ЗначениеЗаполнено(СуммаСНДС) Тогда
			
			ЗаполнитьСвойствоXDTO(СведенияОРаботах, "НачРабот", ДатаДД_ММ_ГГГГ(НачалоРабот), , Ошибки);
			ЗаполнитьСвойствоXDTO(СведенияОРаботах, "КонРабот", ДатаДД_ММ_ГГГГ(КонецРабот), , Ошибки);
			ЗаполнитьСвойствоXDTO(СведенияОРаботах, "СтБезНДСИт", СуммаБезНДС, , Ошибки);
			ЗаполнитьСвойствоXDTO(СведенияОРаботах, "СумНДСИт", СуммаНДС, , Ошибки);
			ЗаполнитьСвойствоXDTO(СведенияОРаботах, "СтУчНДСИт", СуммаСНДС, , Ошибки);
			
		КонецЕсли;
		
		СведенияСделки.ОписРабот.Добавить(СведенияОРаботах);
		
		ЗаполнитьСвойствоXDTO(СведенияДокумента, "СодФХЖ1", СведенияСделки, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "СвДокПРУ", СведенияДокумента, Истина, Ошибки);

		СведенияОПередаче = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ2", ПространствоИменСхемы);
		
		СодержаниеОперации = СодержаниеОперацииПередачаРабот();
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "СодОпер", СодержаниеОперации, ,Ошибки);
		
		СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные", "ПолныйПуть", Истина);
		Если СтрокаДопДанных <> Неопределено Тогда
			ЗаполнитьДопДанныеШапкиДокумента(СведенияОПередаче, ДеревоДанных, ПространствоИменСхемы, СтруктураПараметров, Ошибки);
		КонецЕсли;
		
		ДатаИсполнения = ЗначениеРеквизитаДерева(ДеревоДанных, "СведенияПоВыполнениюУслуг.ДатаИсполнения");
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "ДатаПер", ДатаДД_ММ_ГГГГ(ДатаИсполнения), ,Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "СодФХЖ2", СведенияОПередаче, Истина, Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолнПодп", ДолжностныеОбязанности(), Истина, Ошибки);
		
		// В подписанте пустым значением заполняется поле Физ.лицо.
		ЗаполнитьФизЛицоПодписанта(Подписант, ПространствоИменСхемы, Ошибки);
		
		Документ.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ВызватьИсключение ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);;
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
		УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
		Возврат Истина;
		
	Исключение
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		ТекстСообщения = ?(ЗначениеЗаполнено(ТекстОшибки), ТекстОшибки, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		
		// Удалим файл дополнительной информации в случае ошибок.
		Если СтруктураПараметров.Свойство("ПолноеИмяДопФайла") Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(СтруктураПараметров.ПолноеИмяДопФайла);
		КонецЕсли;
		
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Передача работ заказчик.
//
// Параметры:
//  ДеревоДокумента - дерево значений - данные для формирования.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьПередачаРаботЗаказчикCML(ДеревоДанных)
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,"ИдФайл"));
	
	ПространствоИменСхемы = "RUZAK";
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИменСхемы);
		
		ФайлНаДиске = Новый Файл(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЗначениеРеквизитаДерева(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЗначениеРеквизитаДерева(ДеревоДанных, "ВерсПрог"),       , Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЗначениеРеквизитаДерева(ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		СвУчДокОбор = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдОтпр", ЗначениеРеквизитаДерева(ДеревоДанных,"ИдОтпр"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(СвУчДокОбор, "ИдПол", ЗначениеРеквизитаДерева(ДеревоДанных, "ИдПок"), Истина, Ошибки);
		
		Если ЗначениеЗаполнено(ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО")) Тогда
			СвОЭДОтпр = ПолучитьОбъектТипаCML("Файл.СвУчДокОбор.СвОЭДОтпр", ПространствоИменСхемы);
			Реквизит = ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.НаимОрг");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "НаимОрг", Реквизит, Истина, Ошибки);
			Реквизит = ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.ИННЮЛ");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИННЮЛ", Реквизит, Истина, Ошибки);
			Реквизит = ЗначениеРеквизитаДерева(ДеревоДанных, "РеквизитыОператораЭДО.ИдЭДО");
			ЗаполнитьСвойствоXDTO(СвОЭДОтпр, "ИдЭДО", Реквизит, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(СвУчДокОбор, "СвОЭДОтпр", СвОЭДОтпр, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Файл, "СвУчДокОбор", СвУчДокОбор, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИменСхемы);
		Реквизит = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаДок"));
		ЗаполнитьСвойствоXDTO(Документ, "ДатаИнфЗак", Реквизит, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ВремИнфЗак", ЗначениеРеквизитаДерева(ДеревоДанных, "ВремДок"), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "КНД", ЗначениеРеквизитаДерева(ДеревоДанных, "КНД"), Истина, Ошибки);
		
		НаименованиеСубъекта = ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеОрганизации");
		ЗаполнитьСвойствоXDTO(Документ, "НаимЭконСубСост", НаименованиеСубъекта, Истина, Ошибки);
		
		ДанныеДокумента = ПолучитьОбъектТипаCML("Файл.Документ.ИдДокПРУИсп", ПространствоИменСхемы);
		
		ИмяФайлаПродавца = ЗначениеРеквизитаДерева(ДеревоДанных, "ИмяФайлаПродавца");
		ЗаполнитьСвойствоXDTO(ДанныеДокумента, "ИдФайлИнфИсп", ИмяФайлаПродавца, Истина, Ошибки);
		
		Реквизит = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаДокАктИ"));
		ЗаполнитьСвойствоXDTO(ДанныеДокумента, "ДатаФайлИнфИсп", Реквизит, Истина, Ошибки);
		Реквизит = ЗначениеРеквизитаДерева(ДеревоДанных, "ВремДокАктИ");
		ЗаполнитьСвойствоXDTO(ДанныеДокумента, "ВремФайлИнфИсп", Реквизит, Истина, Ошибки);
		
		Подписи = ЗначениеРеквизитаДерева(ДеревоДанных, "ПолученныеЭП");
		Если Не ЗначениеЗаполнено(Подписи) Тогда
			Подписи = Новый Массив;
			Подписи.Добавить("---");
		КонецЕсли;
		Для Каждого Подпись Из Подписи Цикл
			ДанныеДокумента.ЭП.Добавить(Подпись);
		КонецЦикла;
		
		ЗаполнитьСвойствоXDTO(Документ, "ИдДокПРУИсп", ДанныеДокумента, Истина, Ошибки);
		
		СведенияОПередаче = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3", ПространствоИменСхемы);
		
		ПервичныйДокумент = ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеДокументаОтправителя");
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "НаимДокОпрИсп", ПервичныйДокумент, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "НомДокПРУИсп", ЗначениеРеквизитаДерева(ДеревоДанных, "НомерАкт"), , Ошибки);
		ДатаДокумента = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаАкт"));
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "ДатаДокПРУИсп", ДатаДокумента, Истина, Ошибки);
		
		ДанныеОПринятии = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3.РезПринял", ПространствоИменСхемы);
		Если ЗначениеЗаполнено(ЗначениеРеквизитаДерева(ДеревоДанных, "СведенияПоВыполнениюУслуг.ДатаЗаказа")) Тогда
			Реквизит = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(ДеревоДанных, "СведенияПоВыполнениюУслуг.ДатаЗаказа"));
			ЗаполнитьСвойствоXDTO(ДанныеОПринятии, "ДатаПрием", Реквизит, , Ошибки);
		КонецЕсли;
		
		Претензия = ЗначениеРеквизитаДерева(ДеревоДанных, "СведенияПоВыполнениюУслуг.Претензия");
		Если Не ЗначениеЗаполнено(Претензия) Тогда
			Претензия = НСтр("ru ='Результаты работ (оказанных услуг) приняты без претензий'");
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(ДанныеОПринятии, "СодОпер", Претензия, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "РезПринял", ДанныеОПринятии, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "СодФХЖ3", СведенияОПередаче, Истина, Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(Подписант, "ОблПолн", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Статус", 1, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ОснПолн", ДолжностныеОбязанности(), Истина, Ошибки);
		
		// В подписанте пустым значением заполняется поле Физ.лицо.
		ЗаполнитьФизЛицоПодписанта(Подписант, ПространствоИменСхемы, Ошибки);
		
		Документ.Подписант.Добавить(Подписант);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЗначениеРеквизитаДерева(ДеревоДанных, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЗначениеРеквизитаДерева(ДеревоДанных, "ПолноеИмяФайла"), ПространствоИменСхемы);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
			
		// Удалим файл дополнительной информации в случае ошибок.
		Если СтруктураПараметров.Свойство("ПолноеИмяДопФайла") Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(СтруктураПараметров.ПолноеИмяДопФайла);
		КонецЕсли;
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Формирование ЭД CML из документов БД

// Возвращает результат успеха формирования файла ЭД Каталог товаров.
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//  МассивФайлов - если имеются присоединенные файлы - то в этом параметре возвращается массив файлов.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования ЭД.
//
Функция СформироватьКаталогCML(ДеревоДанных, МассивФайлов)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	ФайлСформирован = Ложь;
	
	ПространствоИменСхемы = "urn:1C.ru:commerceml_2";
	Попытка
		
		КоммерческаяИнформация = ПолучитьОбъектТипаCML("КоммерческаяИнформация", ПространствоИменСхемы);
		Каталог = ПолучитьОбъектТипаCML("Каталог", ПространствоИменСхемы);
		
		// Коммерческая информация.
		ВерсияСхемы = СокрЛП(СтрЗаменить(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы"), "CML", ""));
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ВерсияСхемы", ВерсияСхемы, Истина, Ошибки);

		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ДатаФормирования", XMLДатаВремя(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"ДатаФормирования")), Истина, Ошибки);
		
		// Каталог.
		ЗаполнитьСвойствоXDTO(Каталог, "Ид", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Каталог, "СодержитТолькоИзменения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СодержитТолькоИзменения"), Ложь, Ошибки);
		ЗаполнитьСвойствоXDTO(Каталог, "Наименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Наименование"), Истина, Ошибки);
		
		// Владелец.
		Владелец = ПолучитьОбъектТипаCML("Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Владелец, ДеревоДанных, "Владелец", Ошибки);
		ЗаполнитьСвойствоXDTO(Каталог, "Владелец", Владелец, Истина, Ошибки);
		
		// Товары.
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
		Если СтрокаТаблицаТоваров.Строки.Количество() > 0 Тогда
			Товары = ПолучитьОбъектТипаCML("Каталог.Товары", ПространствоИменСхемы);
			Для Каждого ТекущийТовар Из СтрокаТаблицаТоваров.Строки Цикл
				Товар = ПолучитьОбъектТипаCML("Каталог.Товары.Товар", ПространствоИменСхемы);
				СформироватьДанныеПоТоваруCML_206(Товар, ТекущийТовар, ПространствоИменСхемы, Ошибки, МассивФайлов);
				Товары.Товар.Добавить(Товар);
			КонецЦикла;
			ЗаполнитьСвойствоXDTO(Каталог, "Товары", Товары, Истина, Ошибки);
		КонецЕсли;
		
		// Для каталога номенклатуры возможно передать только не подписанные данные
		ЗаполнитьНеПодписанныеДанныеШапки(ДеревоДанных, Каталог, Ошибки);
		
		
		// Добавим заготовку Подписанта для заполнения при подписи
		Подписанты = ПолучитьОбъектТипаCML("Каталог.Подписанты", ПространствоИменСхемы);
		Подписант = ПолучитьОбъектТипаCML("Каталог.Подписанты.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "Фамилия", "-", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Имя", "-", Истина, Ошибки);
		Подписанты.Подписант.Добавить(Подписант);
		ЗаполнитьСвойствоXDTO(Каталог, "Подписанты", Подписанты, Ложь, Ошибки);
		
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "Каталог", Каталог, Истина, Ошибки);
		// Запись файла электронного документа.
		КоммерческаяИнформация.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(КоммерческаяИнформация, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Прайс-лист.
// 
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьПрайсЛистCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	
	Попытка
		
		КоммерческаяИнформация = ПолучитьОбъектТипаCML("КоммерческаяИнформация", ПространствоИменСхемы);
		
		ВерсияСхемы = СокрЛП(СтрЗаменить(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы"), "CML", ""));
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ВерсияСхемы", ВерсияСхемы, Истина, Ошибки);
		
		ДатаФормирования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования");
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ДатаФормирования", ДатаФормирования, Истина, Ошибки);
		
		ПрайсЛист = ПолучитьОбъектТипаCML("ПакетПредложений", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "СодержитТолькоИзменения", Ложь, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "Ид", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "ИдКаталога", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид"), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "Наименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Наименование",,, Истина), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "Описание", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Описание"), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "ДействительноС", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДействительноС"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "ДействительноДо", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДействительноДо"), Истина, Ошибки);
		
		// Владелец.
		Владелец = ПолучитьОбъектТипаCML("Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Владелец, ДеревоДанных, "Владелец", Ошибки);
		
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "Владелец", Владелец, Истина, Ошибки);
		
		// Предложения.
		ТаблицаТоваров = ВеткаТаблицыВДереве(ДеревоДанных, "Товары");
				
		// Если не найдена таблица, например,
		// ошибка в заполнении дерева документа
		// то не будем формировать пустой ЭД.
		Если ТаблицаТоваров = Неопределено Тогда
			Возврат Ложь;
		КонецЕсли;
		
		// Если у таблицы товаров нет строк,
		// то не будем формировать пустой ЭД.
		Если ТаблицаТоваров.Строки.Количество() = Неопределено Тогда
			Возврат Ложь;
		КонецЕсли;
		
		Предложения = ПолучитьОбъектТипаCML("ПакетПредложений.Предложения", ПространствоИменСхемы);
		Для Каждого СтрокаТаблицыТоваров Из ТаблицаТоваров.Строки Цикл
			
			Предложение = ПолучитьОбъектТипаCML("ПакетПредложений.Предложения.Предложение", ПространствоИменСхемы);
			
			// Заполняем свойства товара.
			СформироватьДанныеПоТоваруCML_206(Предложение, СтрокаТаблицыТоваров, ПространствоИменСхемы, Ошибки);
			// Заполняем свойства предложения.
			СформироватьДанныеПоТоваруПредложенияCML_206(Предложение, СтрокаТаблицыТоваров, ПространствоИменСхемы, Ошибки);
			
			// Добавляем строку в список.
			Предложения.Предложение.Добавить(Предложение);
		КонецЦикла;
		ПрайсЛист.Предложения = Предложения;
		
		//  Заполняем таблицу "Типы цен".
		ТаблицаТипыЦен = ВеткаТаблицыВДереве(ДеревоДанных, "ТипыЦен");
		
		ТипыЦен = ПолучитьОбъектТипаCML("ПакетПредложений.ТипыЦен", ПространствоИменСхемы);
		Если ПустаяТаблицаДерева(ТаблицаТипыЦен) Тогда
			
			// Если тип цен не заполнен - присвоим новый идентификатор, так как типы цены обязательны в схеме.
			ТипЦены = ПолучитьОбъектТипаCML("ПакетПредложений.ТипыЦен.ТипЦены", ПространствоИменСхемы);
			ИдТипаЦены = Строка(Новый УникальныйИдентификатор);
			ЗаполнитьСвойствоXDTO(ТипЦены, "Ид", ИдТипаЦены, Истина, Ошибки);
			ТипыЦен.ТипЦены.Добавить(ТипЦены)
			
		Иначе
			Для Каждого ТекСтрока Из ТаблицаТипыЦен.Строки Цикл
				
				ТипЦеныXDTO = ПолучитьОбъектТипаCML("ПакетПредложений.ТипыЦен.ТипЦены", ПространствоИменСхемы);
				ЗаполнитьТипЦены(ТекСтрока, ТипЦеныXDTO);
				
				ТипыЦен.ТипЦены.Добавить(ТипЦеныXDTO)
			КонецЦикла;
		КонецЕсли;
		// Добавляем типы цен в прайс.
		ПрайсЛист.ТипыЦен = ТипыЦен;
		
		// Для Прайс листа возможно передать только не подписанные данные
		ЗаполнитьНеПодписанныеДанныеШапки(ДеревоДанных, ПрайсЛист, Ошибки);
		
		// Добавим заготовку Подписанта для заполнения при подписи
		Подписанты = ПолучитьОбъектТипаCML("ПакетПредложений.Подписанты", ПространствоИменСхемы);
		Подписант = ПолучитьОбъектТипаCML("ПакетПредложений.Подписанты.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "Фамилия", "-", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Имя", "-", Истина, Ошибки);
		Подписанты.Подписант.Добавить(Подписант);
		ЗаполнитьСвойствоXDTO(ПрайсЛист, "Подписанты", Подписанты, Ложь, Ошибки);
		
		// Проверяем XDTO.
		ПрайсЛист.Проверить();
		КоммерческаяИнформация.ПакетПредложений = ПрайсЛист;
		КоммерческаяИнформация.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(КоммерческаяИнформация, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		
		ФайлСформирован = Ложь;
 	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Заказ поставщику.
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьЗаказCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	
	Попытка
		
		КоммерческаяИнформация = ПолучитьОбъектТипаCML("КоммерческаяИнформация", ПространствоИменСхемы);
		
		ВерсияСхемы = СокрЛП(СтрЗаменить(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы"), "CML", ""));
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ВерсияСхемы", ВерсияСхемы, Истина, Ошибки);
		
		ДатаФормирования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования");
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ДатаФормирования", ДатаФормирования, Истина, Ошибки);
		
		// Документ.
		ДокументПродажи = ПолучитьОбъектТипаCML("Документ", ПространствоИменСхемы);
		
		Ид = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Ид", Ид, Истина, Ошибки);
		
		Номер = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Номер", Номер, Истина, Ошибки);
		
		Дата = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Дата", Дата, Истина, Ошибки);
		
		ХозОперация = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ХозОперация");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "ХозОперация", ХозОперация, Истина, Ошибки);
		
		Валюта = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Валюта");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Валюта", Валюта, Истина, Ошибки);
		
		Комментарий = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Комментарий");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Комментарий", Комментарий, , Ошибки);
		
		Курс = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Курс");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Курс", Курс, Истина, Ошибки);
		
		Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Сумма", Сумма, Истина, Ошибки);
		
		Роль = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Роль");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Роль", Роль, Истина, Ошибки);

		// заполняем контрагентов
		Контрагенты = ПолучитьОбъектТипаCML("Документ.Контрагенты", ПространствоИменСхемы);
		ВерсияСхемы = ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2();
		
		// Определяем роль Контрагента и организации.
		Если ВРег(Роль) = ВРег("Продавец") Тогда
			РольКонтрагента = "Покупатель";
			РольОрганизации = "Продавец";
		Иначе
			РольКонтрагента = "Продавец";
			РольОрганизации = "Покупатель";
		КонецЕсли;
		
		// Добавим в контрагенты Покупателя.
		Покупатель = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Покупатель, ДеревоДанных, РольОрганизации, Ошибки);
		Покупатель.Роль = РольОрганизации;
		
		Если ВРег(Роль) = ВРег("Продавец") Тогда
			// Банковский счет из шапки документа помещаем в расширения контрагента в документе.
			ЗаполнитьБанковскийСчет(Покупатель, ДеревоДанных);
		КонецЕсли;
		
		Контрагенты.Контрагент.Добавить(Покупатель);
		
		// Добавим в контрагенты Организацию.
		Продавец = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Продавец, ДеревоДанных, РольКонтрагента, Ошибки);
		Продавец.Роль = РольКонтрагента;
		
		Если ВРег(Роль) = ВРег("Покупатель") Тогда
			// Банковский счет из шапки документа помещаем в расширения контрагента в документе.
			ЗаполнитьБанковскийСчет(Продавец, ДеревоДанных);
		КонецЕсли;
		
		Контрагенты.Контрагент.Добавить(Продавец);
		
		// Добавим в контрагенты Грузополучателя.
		Получатель = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Получатель, ДеревоДанных, "Получатель", Ошибки);
		Получатель.Роль = "Получатель";
		Контрагенты.Контрагент.Добавить(Получатель);
		
		ДокументПродажи.Контрагенты = Контрагенты;
		
		// Заполняем товары
		Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
		
		Если СтрокаТаблицаТоваров.Строки.Количество() > 0 Тогда
			Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
			Для Каждого ТекущийТовар Из СтрокаТаблицаТоваров.Строки Цикл
				Товар = ПолучитьОбъектТипаCML("Документ.Товары.Товар", ПространствоИменСхемы);
				// Заполняем ИД товара, базовую единицу, штрихкод т.е. те свойства которые относятся непосредственно к каталога товаров.
				СформироватьДанныеПоТоваруCML_206(Товар, ТекущийТовар, ПространствоИменСхемы, Ошибки);
				
				Товары.Товар.Добавить(Товар);
				
			КонецЦикла;
			
			ЗаполнитьСвойствоXDTO(ДокументПродажи, "Товары", Товары, Истина, Ошибки);
		КонецЕсли;
		
		СпособДоставки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Доставка.СпособДоставки");
		Если СпособДоставки <> Неопределено Тогда
			АдресДоставки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Доставка.АдресДоставки");
			АдресДоставкиЗначенияПолей = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Доставка.АдресДоставкиЗначенияПолей");
			Доставка = Новый Структура;
			Доставка.Вставить("СпособДоставки", СпособДоставки);
			Доставка.Вставить("АдресДоставки", АдресДоставки);
			Доставка.Вставить("АдресДоставкиЗначенияПолей", АдресДоставкиЗначенияПолей);
			ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоДанных, Доставка, Ложь);
		КонецЕсли;
		
		// Помещаем доп данные в ЗначенияРеквизитов документа.
		ПоместитьДопДанныеШапки(ДеревоДанных, ДокументПродажи, Ошибки);
		
		// Добавим заготовку Подписанта для заполнения при подписи.
		Подписанты = ПолучитьОбъектТипаCML("Документ.Подписанты", ПространствоИменСхемы);
		Подписант = ПолучитьОбъектТипаCML("Документ.Подписанты.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "Фамилия", "-", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Имя", "-", Истина, Ошибки);
		Подписанты.Подписант.Добавить(Подписант);
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Подписанты", Подписанты, Ложь, Ошибки);
		
		ДокументПродажи.Проверить();
		КоммерческаяИнформация.Документ.Добавить(ДокументПродажи);
		КоммерческаяИнформация.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДВФайл(КоммерческаяИнформация, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Счет на оплату.
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьСчетНаОплатуCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	
	Попытка
		КоммерческаяИнформация = ПолучитьОбъектТипаCML("КоммерческаяИнформация", ПространствоИменСхемы);
		
		ВерсияСхемы = СокрЛП(СтрЗаменить(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы"), "CML", ""));
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ВерсияСхемы", ВерсияСхемы, Истина, Ошибки);
		
		ДатаФормирования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования");
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ДатаФормирования", ДатаФормирования, Истина, Ошибки);
		
		ДокументЭО = ПолучитьОбъектТипаCML("Документ", ПространствоИменСхемы);
		
		ХозОперация = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ХозОперация");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "ХозОперация", ХозОперация, Истина, Ошибки);
		
		Ид = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Ид", Ид, Истина, Ошибки);
		
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Номер", НомерДок, Истина, Ошибки);
		
		ДатаДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Дата", ДатаДок, Истина, Ошибки);
		
		СрокПлатежа = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СрокПлатежа");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "СрокПлатежа", СрокПлатежа, Истина, Ошибки);
		
		Валюта = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Валюта");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Валюта", Валюта, Истина, Ошибки);
		
		Курс = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Курс");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Курс", Курс, Истина, Ошибки);
		
		СуммаДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Сумма", СуммаДок, Истина, Ошибки);
		
		// Заполнение контрагентов
		Контрагенты = ПолучитьОбъектТипаCML("Документ.Контрагенты", ПространствоИменСхемы);
		
		// Добавление в контрагенты Продавца.
		Поставщик = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Поставщик, ДеревоДанных, "Продавец", Ошибки);
		
		// Заполнение расчетного счета.
		ЗаполнитьРасчетныйСчетПоставщика(ДеревоДанных, Поставщик, ПространствоИменСхемы, Ошибки);

		Контрагенты.Контрагент.Добавить(Поставщик);
		
		// Добавим в контрагенты Покупателя.
		Покупатель = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Покупатель, ДеревоДанных, "Покупатель", Ошибки);
		Контрагенты.Контрагент.Добавить(Покупатель);
		
		ДокументЭО.Контрагенты = Контрагенты;
		ДокументЭО.Роль = "Продавец";
		
		НДСИтог = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИтогоПоДокументу.СуммаНДС");
		НДСВходитВСтоимость = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИтогоПоДокументу.ЦенаВключаетНДС");
		
		Налог = ПолучитьОбъектТипаCML("Документ.Налоги.Налог", ПространствоИменСхемы);
		Налог.Наименование = "НДС";
		Налог.УчтеноВСумме = НДСВходитВСтоимость;
		Налог.Сумма = НДСИтог;
		
		ДокументЭОНалоги = ПолучитьОбъектТипаCML("Документ.Налоги", ПространствоИменСхемы);
		ДокументЭОНалоги.Налог.Добавить(Налог);
		
		ДокументЭО.Налоги = ДокументЭОНалоги;
		
		НомерДокументаОснования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументОснования.НомерДокументаОснования");
		ДатаДокументаОснования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументОснования.ДатаДокументаОснования");
		Если ЗначениеЗаполнено(НомерДокументаОснования) И ЗначениеЗаполнено(ДатаДокументаОснования) Тогда
			
			ДобавитьВЗначенияРеквизитовДокумента("НомерДокументаОснования", НомерДокументаОснования, ДокументЭО);
			ДобавитьВЗначенияРеквизитовДокумента("ДатаДокументаОснования", ДатаДокументаОснования, ДокументЭО);
			
			НаименованиеДокументаОснование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументОснования.НаименованиеДокументаОснования");
			КомментарийДокументаОснование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументОснования.Комментарий");
			
			ДобавитьВЗначенияРеквизитовДокумента("НаименованиеДокументаОснование", НаименованиеДокументаОснование, ДокументЭО);
			ДобавитьВЗначенияРеквизитовДокумента("КомментарийДокументаОснование", КомментарийДокументаОснование, ДокументЭО);
			
		КонецЕсли;
		
		ЧастичнаяОплата = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ЧастичнаяОплата");
		Если Не ЗначениеЗаполнено(ЧастичнаяОплата) Тогда
			ЧастичнаяОплата = Ложь;
		КонецЕсли;
		
		Если Не ЧастичнаяОплата Тогда
			Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
			
			СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
			
			Если СтрокаТаблицаТоваров.Строки.Количество() > 0 И СтрокаТаблицаТоваров.Значение > 0 Тогда
				Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
				Для Каждого ТекущийТовар Из СтрокаТаблицаТоваров.Строки Цикл
					Товар = ПолучитьОбъектТипаCML("Документ.Товары.Товар", ПространствоИменСхемы);
					// Заполняем ИД товара, базовую единицу, штрихкод т.е. те свойства которые относятся непосредственно к каталога товаров.
					СформироватьДанныеПоТоваруCML_206(Товар, ТекущийТовар, ПространствоИменСхемы, Ошибки);
					
					Товары.Товар.Добавить(Товар);
				КонецЦикла;
				
				ЗаполнитьСвойствоXDTO(ДокументЭО, "Товары", Товары, Истина, Ошибки);
			КонецЕсли;
		КонецЕсли;
		
		// Формируем строку доп данных и файл.
		ПоместитьДопДанныеШапки(ДеревоДанных, ДокументЭО, Ошибки);
		
		// Добавим заготовку Подписанта для заполнения при подписи.
		Подписанты = ПолучитьОбъектТипаCML("Документ.Подписанты", ПространствоИменСхемы);
		Подписант = ПолучитьОбъектТипаCML("Документ.Подписанты.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "Фамилия", "-", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Имя", "-", Истина, Ошибки);
		Подписанты.Подписант.Добавить(Подписант);
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Подписанты", Подписанты, Ложь, Ошибки);
		
		КоммерческаяИнформация.Документ.Добавить(ДокументЭО);
		КоммерческаяИнформация.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДВФайл(КоммерческаяИнформация, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Отчет о списании комиссионного товара.
//
// Параметры:
//  СтруктураПараметров - структура параметров для формирования.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьОтчетОСписанииКомиссионногоТовараCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
		
	Попытка
		
		ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
		
		// Коммерческая информация
		КоммерческаяИнформация = ПолучитьОбъектТипаCML("КоммерческаяИнформация", ПространствоИменСхемы);
		
		ВерсияСхемы = СокрЛП(СтрЗаменить(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы"), "CML", ""));
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ВерсияСхемы", ВерсияСхемы, Истина, Ошибки);
		
		ДатаФормирования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования");
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ДатаФормирования", ДатаФормирования, Истина, Ошибки);

		ДокументЭО = ПолучитьОбъектТипаCML("Документ", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(ДокументЭО, "ХозОперация", НСтр("ru = 'Отчет о списании комиссионного товара'"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Роль", "Комитент", Истина, Ошибки);

		Ид = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Ид", Ид, Истина, Ошибки);
		
		НомерДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Номер", НомерДок, Истина, Ошибки);
		
		ДатаДок = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Дата", ДатаДок, Истина, Ошибки);
		
		Валюта = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Валюта");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Валюта", Валюта, Истина, Ошибки);
		
		Курс = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Курс");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Курс", Курс, Истина, Ошибки);
		
		Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Сумма", Сумма, Истина, Ошибки);
		
		// заполняем контрагентов
		Контрагенты = ПолучитьОбъектТипаCML("Документ.Контрагенты", ПространствоИменСхемы);
		ВерсияСхемы = ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2();
		
		// Добавим в контрагенты Комитента
		Комитент = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Комитент, ДеревоДанных, "Комитент", Ошибки);
		Комитент.Роль = "Комитент";
		Контрагенты.Контрагент.Добавить(Комитент);
		
		// добавим в контрагенты Организацию
		Комиссионер = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Комиссионер, ДеревоДанных, "Комиссионер", Ошибки);
		Комиссионер.Роль = "Комиссионер";
		Контрагенты.Контрагент.Добавить(Комиссионер);
		
		ДокументЭО.Контрагенты = Контрагенты;
		
		// Заполняем товары
		Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
		
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
		
		Если СтрокаТаблицаТоваров.Строки.Количество() > 0 Тогда
			Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
			Для Каждого ТекущийТовар Из СтрокаТаблицаТоваров.Строки Цикл
				Товар = ПолучитьОбъектТипаCML("Документ.Товары.Товар", ПространствоИменСхемы);
				// Заполняем ИД товара, базовую единицу, штрихкод т.е. те свойства которые относятся непосредственно к каталога товаров.
				СформироватьДанныеПоТоваруCML_206(Товар, ТекущийТовар, ПространствоИменСхемы, Ошибки);
				
				Товары.Товар.Добавить(Товар);
			КонецЦикла;
			
			ЗаполнитьСвойствоXDTO(ДокументЭО, "Товары", Товары, Истина, Ошибки);
		КонецЕсли;
		
		
		// Помещаем доп данные в ЗначенияРеквизитов документа
		ПоместитьДопДанныеШапки(ДеревоДанных, ДокументЭО, Ошибки);
		
		ИтоговаяСтрока = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИтогиПрописью");
		ДобавитьВЗначенияРеквизитовДокумента("ИтогиПрописью", ИтоговаяСтрока, ДокументЭО);
		
		// Добавим заготовку Подписанта для заполнения при подписи
		Подписанты = ПолучитьОбъектТипаCML("Документ.Подписанты", ПространствоИменСхемы);
		Подписант = ПолучитьОбъектТипаCML("Документ.Подписанты.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "Фамилия", "-", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Имя", "-", Истина, Ошибки);
		Подписанты.Подписант.Добавить(Подписант);
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Подписанты", Подписанты, Ложь, Ошибки);
		
		КоммерческаяИнформация.Документ.Добавить(ДокументЭО);
		КоммерческаяИнформация.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДВФайл(КоммерческаяИнформация, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Отчет о продажах комиссионного товара.
//
// Параметры:
//  ДеревоДанных - Дерево Значений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьОтчетОПродажахКомиссионногоТовараCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	ТаблицаТоваров = Новый ТаблицаЗначений;
	
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	Попытка
		
		КоммерческаяИнформация = ПолучитьОбъектТипаCML("КоммерческаяИнформация", ПространствоИменСхемы);
		
		ВерсияСхемы = СокрЛП(СтрЗаменить(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы"), "CML", ""));
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ВерсияСхемы", ВерсияСхемы, Истина, Ошибки);
		
		ДатаФормирования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования");
		ЗаполнитьСвойствоXDTO(КоммерческаяИнформация, "ДатаФормирования", ДатаФормирования, Истина, Ошибки);
		
		// Документ.
		ДокументПродажи = ПолучитьОбъектТипаCML("Документ", ПространствоИменСхемы);
		
		Ид = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Ид", Ид, Истина, Ошибки);
		
		Номер = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Номер", Номер, Истина, Ошибки);
		
		Дата = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Дата", Дата, Истина, Ошибки);
		
		ХозОперация = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ХозОперация");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "ХозОперация", ХозОперация, Истина, Ошибки);
		
		Роль = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Роль");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Роль", Роль, Истина, Ошибки);
		
		Валюта = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Валюта");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Валюта", Валюта, Истина, Ошибки);
		
		Курс = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Курс");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Курс", Курс, Истина, Ошибки);
		
		Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма");
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Сумма", Сумма, Истина, Ошибки);
		
		ИтоговаяСтрока = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИтогиПрописью");
		ДобавитьВЗначенияРеквизитовДокумента("ИтогиПрописью", ИтоговаяСтрока, ДокументПродажи);
		
		// Заполняем контрагентов
		Контрагенты = ПолучитьОбъектТипаCML("Документ.Контрагенты", ПространствоИменСхемы);
		ВерсияСхемы = ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2();
		
		// Добавим в контрагенты Комитента.
		Комитент = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Комитент, ДеревоДанных, "Комитент", Ошибки);
		Комитент.Роль = "Комитент";
		Контрагенты.Контрагент.Добавить(Комитент);
		
		// Добавим в контрагенты Организацию.
		Комиссионер = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
		ЗаполнитьДанныеУчастникаCML(Комиссионер, ДеревоДанных, "Комиссионер", Ошибки);
		Комиссионер.Роль = "Комиссионер";
		Контрагенты.Контрагент.Добавить(Комиссионер);
		
		ДокументПродажи.Контрагенты = Контрагенты;
		
		// Помещаем доп данные в ЗначенияРеквизитов документа.
		ПоместитьДопДанныеШапки(ДеревоДанных, ДокументПродажи, Ошибки);
		
		// Заполняем товары
		Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
		
		Если СтрокаТаблицаТоваров.Строки.Количество() > 0 Тогда
			Товары = ПолучитьОбъектТипаCML("Документ.Товары", ПространствоИменСхемы);
			МассивДобавленныхПокупателей = Новый Массив;
			Для Каждого ТекущийТовар Из СтрокаТаблицаТоваров.Строки Цикл
				Товар = ПолучитьОбъектТипаCML("Документ.Товары.Товар", ПространствоИменСхемы);
				// Заполняем ИД товара, базовую единицу, штрихкод т.е. те свойства которые относятся непосредственно к каталога товаров.
				СформироватьДанныеПоТоваруCML_206(Товар, ТекущийТовар, ПространствоИменСхемы, Ошибки);
				
				// Заполняем свойства товара, которые относятся к документу.
				СформироватьДанныеПоТабЧастиТоварыДокументаCML_206(Товар, ТекущийТовар, ПространствоИменСхемы);
				
				// Добавим в контрагенты покупателя.
				Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ТекущийТовар, "Товары.НомерСтроки.Покупатель") Тогда
					Покупатель = ПолучитьОбъектТипаCML("Документ.Контрагенты.Контрагент", ПространствоИменСхемы);
					ДопДанные = Новый Структура;
					ЗаполнитьДанныеУчастникаCML(Покупатель, ТекущийТовар, "Товары.НомерСтроки.Покупатель", Ошибки, ДопДанные);
					ИдПокупателя = "";
					Если ДопДанные.Свойство("Ид", ИдПокупателя) Тогда
						Если МассивДобавленныхПокупателей.Найти(ИдПокупателя) = Неопределено Тогда
							Покупатель.Роль = "Покупатель";
							Контрагенты.Контрагент.Добавить(Покупатель);
							МассивДобавленныхПокупателей.Добавить(ИдПокупателя);
						КонецЕсли;
						
						ЗначенияРеквизитов = ПолучитьОбъектТипаCML("Документ.Товары.Товар.ДополнительныеЗначенияРеквизитов", ПространствоИменСхемы);
						ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
						ЗаполнитьСвойствоXDTO(ЗначениеРеквизита, "Наименование", "ИдПокупателя", Истина, Ошибки);
						ЗначениеРеквизита.Значение.Добавить(ИдПокупателя);
						ЗначенияРеквизитов.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
						
						// Для совместимости с более ранними версиями БЭД необходимо передать еще 3 реквизита:
						ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
						ЗаполнитьСвойствоXDTO(ЗначениеРеквизита, "Наименование", "ПокупательНаименование", Истина, Ошибки);
						ЗначениеРеквизита.Значение.Добавить(ДопДанные.Наименование);
						ЗначенияРеквизитов.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
						
						ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
						ЗаполнитьСвойствоXDTO(ЗначениеРеквизита, "Наименование", "ПокупательИНН", Истина, Ошибки);
						ЗначениеРеквизита.Значение.Добавить(ДопДанные.ИНН);
						ЗначенияРеквизитов.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
						
						ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
						ЗаполнитьСвойствоXDTO(ЗначениеРеквизита, "Наименование", "ПокупательКПП", Истина, Ошибки);
						ЗначениеРеквизита.Значение.Добавить(ДопДанные.КПП);
						ЗначенияРеквизитов.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
						Товар.ДополнительныеЗначенияРеквизитов = ЗначенияРеквизитов;
					КонецЕсли;
				КонецЕсли;
				Товары.Товар.Добавить(Товар);
			КонецЦикла;
			
			ЗаполнитьСвойствоXDTO(ДокументПродажи, "Товары", Товары, Истина, Ошибки);
		КонецЕсли;
		
		// Добавим заготовку Подписанта для заполнения при подписи.
		Подписанты = ПолучитьОбъектТипаCML("Документ.Подписанты", ПространствоИменСхемы);
		Подписант = ПолучитьОбъектТипаCML("Документ.Подписанты.Подписант", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Подписант, "Фамилия", "-", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "Имя", "-", Истина, Ошибки);
		Подписанты.Подписант.Добавить(Подписант);
		ЗаполнитьСвойствоXDTO(ДокументПродажи, "Подписанты", Подписанты, Ложь, Ошибки);
		
		ДокументПродажи.Проверить();
		КоммерческаяИнформация.Документ.Добавить(ДокументПродажи);
		КоммерческаяИнформация.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДВФайл(КоммерческаяИнформация, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			ФайлСформирован = Истина;
		КонецЕсли;

		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Реквизиты организации.
//
// Параметры:
//  ДеревоДанных - ДеревоЗначений - Дерево значений, содержащее данные для формирования ЭД.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьРеквизитыОрганизацииCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	
	Попытка
		
		Контрагент = ПолучитьОбъектТипаCML("Контрагент", ПространствоИменСхемы);
		ЗаполнитьКонтрагентаCML(Контрагент, ДеревоДанных, "Организация", Ошибки);
		
		Контрагент.Проверить();
		
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДВФайл(Контрагент, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		ФайлСформирован = Истина;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование ЭД'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

// Возвращает результат успеха формирования файла ЭД Отчет о продажах комиссионного товара.
//
// Параметры:
//  СтруктураПараметров - структура параметров для формирования.
//
// Возвращаемое значение:
//  Булево - признак успеха формирования.
//
Функция СформироватьПередачуВозвратТоваровМеждуОрганизациямиCML(ДеревоДанных, ПолноеИмяФайла)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	ВерсияСхемы = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы");
	
	Попытка
		
		ДокументЭО = ПолучитьОбъектТипаCML("ТОРГ12", ВерсияСхемы);
		
		// Коммерческая информация.
		
		ЗаполнитьСвойствоXDTO(ДокументЭО, "ИдИсполнителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Исполнитель"), Истина, Ошибки);
			
		ЗаполнитьСвойствоXDTO(ДокументЭО, "ДатаФормирования",
			XMLДатаВремя(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования")), Истина, Ошибки);
			
		ЗаполнитьСвойствоXDTO(ДокументЭО, "ВерсияСхемы", ВерсияСхемы, Истина, Ошибки);
			
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Ид",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Ид"), Истина, Ошибки);
			
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Номер",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Номер"), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Дата",
			XMLДата(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Дата")), Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(ДокументЭО, "ОКУД", "0330212", Истина, Ошибки);
		
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "Валюта") Тогда
			
			Валюта    = ПолучитьОбъектТипаCML("Валюта", ВерсияСхемы);
			
			ВалютаСсылка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Валюта");
			ВалютаРеквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ВалютаСсылка, "Код, Наименование, НаименованиеПолное");
			КодВалюты = XMLЧисло(ВалютаРеквизиты.Код);
			
			ЗаполнитьСвойствоXDTO(Валюта, "КодОКВ", КодВалюты, Истина , Ошибки);
			ЗаполнитьСвойствоXDTO(Валюта, "Курс",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Курс"), , Ошибки);
			ЗаполнитьСвойствоXDTO(Валюта, "НаименованиеСокращенноеОКВ", ВалютаРеквизиты.Наименование,       , Ошибки);
			ЗаполнитьСвойствоXDTO(Валюта, "НаименованиеПолноеОКВ",      ВалютаРеквизиты.НаименованиеПолное, , Ошибки);
			
			ЗаполнитьСвойствоXDTO(ДокументЭО, "Валюта", Валюта, , Ошибки);

		КонецЕсли;
		
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "Основание") Тогда
			
			Основание = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Основание");
			Если ТипЗнч(Основание) = Тип("Структура") Тогда
				
				ОснованиеCML = ПолучитьОбъектТипаCML("ДокументОснования", ВерсияСхемы);
				
				РеквизитыОснования = Новый Структура("ДокументНомер, ДокументДата, ДокументНаименование");
				ЗаполнитьЗначенияСвойств(РеквизитыОснования, Основание);
				
				ЗаполнитьСвойствоXDTO(ОснованиеCML, "НомерДокументаОснования",
					РеквизитыОснования.ДокументНомер, Истина , Ошибки);
				ЗаполнитьСвойствоXDTO(ОснованиеCML, "ДатаДокументаОснования",
					XMLДата(РеквизитыОснования.ДокументДата), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ОснованиеCML, "НаименованиеДокументаОснования",
					РеквизитыОснования.ДокументНаименование, Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ДокументЭО, "Основание", ОснованиеCML, , Ошибки);
				
			КонецЕсли;
			
		КонецЕсли;
		
		Грузоотправитель = ПолучитьОбъектТипаCML("ТОРГ12.Грузоотправитель", ВерсияСхемы);
		СформироватьДанныеПоКонтрагентуCML(Грузоотправитель, ДеревоДанных,
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ТипГрузоотправителя"), Ошибки, ВерсияСхемы, "Грузоотправитель");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Грузоотправитель", Грузоотправитель, , Ошибки);
		
		Грузополучатель = ПолучитьОбъектТипаCML("ТОРГ12.Грузополучатель", ВерсияСхемы);
		СформироватьДанныеПоКонтрагентуCML(Грузополучатель, ДеревоДанных, "Контрагент", Ошибки, ВерсияСхемы, "Грузополучатель");
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Грузополучатель", Грузополучатель, , Ошибки);
		
		Организация = ПолучитьОбъектТипаCML("ТОРГ12.Поставщик", ВерсияСхемы);
		СформироватьДанныеПоКонтрагентуCML(Организация, ДеревоДанных, "Организация", Ошибки, ВерсияСхемы);
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Поставщик", Организация, , Ошибки);
		
		Контрагент = ПолучитьОбъектТипаCML("ТОРГ12.Плательщик", ВерсияСхемы);
		СформироватьДанныеПоКонтрагентуCML(Контрагент, ДеревоДанных, "Контрагент", Ошибки, ВерсияСхемы);
		ЗаполнитьСвойствоXDTO(ДокументЭО, "Плательщик", Контрагент, , Ошибки);
		
		СуммаИтог     = 0;
		СуммаНДСИтог  = 0;
		СуммаСНДСИтог = 0;
		ПП            = 0;
		
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
		Если СтрокаТаблицаТоваров.Строки.Количество() Тогда
			
			Товары = ПолучитьОбъектТипаCML("ТОРГ12.Товары", ВерсияСхемы);
			
			Для Каждого ТекущийТовар Из СтрокаТаблицаТоваров.Строки Цикл
				
				ПП = ПП + 1;
				
				Товар = ПолучитьОбъектТипаCML("ТОРГ12.Товары.Товар", ВерсияСхемы);
				СформироватьДанныеПоТоваруCML(Товар, ТекущийТовар, Ошибки, ВерсияСхемы);
				ЗаполнитьСвойствоXDTO(Товар, "НомерПП", ПП, , Ошибки);
				
				ЕдиницаИзмерения = ПолучитьОбъектТипаCML("ЕдиницаИзмерения", ВерсияСхемы);
				
				ЗаполнитьСвойствоXDTO(ЕдиницаИзмерения, "Код",
					СокрЛП(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.УпаковкаКод")), , Ошибки);
				ЗаполнитьСвойствоXDTO(ЕдиницаИзмерения, "Наименование",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.УпаковкаНаименование"), ,Ошибки);
				ЗаполнитьСвойствоXDTO(ЕдиницаИзмерения, "Коэффициент",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.Коэффициент"), , Ошибки);
					
				ЗаполнитьСвойствоXDTO(Товар, "ЕдиницаИзмерения", ЕдиницаИзмерения, Истина, Ошибки);
				
				Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.Количество");
				Сумма      = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.Сумма");
				СуммаНДС   = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.СуммаНДС");
				СуммаСНДС  = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.СуммаСНДС");
				
				СуммаИтог     = СуммаИтог     + Сумма;
				СуммаНДСИтог  = СуммаНДСИтог  + СуммаНДС;
				СуммаСНДСИтог = СуммаСНДСИтог + СуммаСНДС;
				
				ЗаполнитьСвойствоXDTO(Товар, "Количество", Количество, , Ошибки);
				
				Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ЦенаВключаетНДС") Тогда
					СуммаБезНДС = Сумма - СуммаНДС;
				Иначе
					СуммаБезНДС = Сумма;
				КонецЕсли;
				
				Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.Цена");
				Если Не ЗначениеЗаполнено(Цена) Тогда
					Цена = Окр(СуммаБезНДС / Количество, 2);
				КонецЕсли;
				
				ЗаполнитьСвойствоXDTO(Товар, "Цена",            Цена,        , Ошибки);
				ЗаполнитьСвойствоXDTO(Товар, "СуммаБезНДС",     СуммаБезНДС, , Ошибки);
				ЗаполнитьСвойствоXDTO(Товар, "СуммаСУчетомНДС", СуммаСНДС,   , Ошибки);
				
				// Заполняем налог в любом случае: и при СтавкеНДС = "БезНДС", и при СтавкеНДС = "0%".
				НалогПоСтроке = ПолучитьОбъектТипаCML("Налог", ВерсияСхемы);
				ЗаполнитьСвойствоXDTO(НалогПоСтроке, "ТипНалога", "НДС", Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(НалогПоСтроке, "Сумма",     СуммаНДС, , Ошибки, Истина);
				
				СтавкаНДСЧислом = ОбменСКонтрагентамиСлужебный.ЗначениеСтавкиНДСИзПеречисления(
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ТекущийТовар, "Товары.НомерСтроки.СтавкаНДС"));
				ЗаполнитьСвойствоXDTO(НалогПоСтроке, "ВеличинаСтавкиНалога", СтавкаНДСЧислом, , Ошибки, Истина);
				
				ЗаполнитьСвойствоXDTO(Товар, "Налог", НалогПоСтроке, , Ошибки);
				
				Товары.Товар.Добавить(Товар);
				
			КонецЦикла;
			
			ЗаполнитьСвойствоXDTO(ДокументЭО, "Товары", Товары, , Ошибки);
		КонецЕсли;
		
		ИтогоПоДокументу = ПолучитьОбъектТипаCML("ТОРГ12.ИтогоПоДокументу", ВерсияСхемы);
		ЗаполнитьСвойствоXDTO(ИтогоПоДокументу, "КоличествоЗаписей", ПП, , Ошибки);
		ЗаполнитьСвойствоXDTO(ИтогоПоДокументу, "КоличествоМест",    ПП, , Ошибки);
		
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ЦенаВключаетНДС") Тогда
			ЗаполнитьСвойствоXDTO(ИтогоПоДокументу, "СуммаБезНДС", СуммаИтог - СуммаНДСИтог, , Ошибки);
		Иначе
			ЗаполнитьСвойствоXDTO(ИтогоПоДокументу, "СуммаБезНДС", СуммаИтог , , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(ИтогоПоДокументу, "СуммаНДС",         СуммаНДСИтог,  , Ошибки);
		ЗаполнитьСвойствоXDTO(ИтогоПоДокументу, "СуммаСУчетомНДС",  СуммаСНДСИтог, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(ДокументЭО,       "ИтогоПоДокументу", ИтогоПоДокументу, , Ошибки);
		
		ИтогиПрописью = ПолучитьОбъектТипаCML("ТОРГ12.ИтогиПрописью", ВерсияСхемы);
		ЗаполнитьСвойствоXDTO(ИтогиПрописью, "КоличествоЗаписейПрописью", ЧислоПрописью(ПП, ,",,,,,,,,0"), , Ошибки);
		ЗаполнитьСвойствоXDTO(ИтогиПрописью, "КоличествоМестПрописью",    ЧислоПрописью(ПП, ,",,,,,,,,0"), , Ошибки);
		
		СуммаВсегоПрописью = "";
		ОбменСКонтрагентамиПереопределяемый.СуммаПрописью(СуммаСНДСИтог, КодВалюты, СуммаВсегоПрописью);
		
		ЗаполнитьСвойствоXDTO(ИтогиПрописью, "СуммаВсегоПрописью", СуммаВсегоПрописью, , Ошибки);
		ЗаполнитьСвойствоXDTO(ДокументЭО,    "ИтогиПрописью",      ИтогиПрописью,      , Ошибки);
		
		ДокументЭО.Проверить();
		
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДВФайл(ДокументЭО, ПолноеИмяФайла);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
			НСтр("ru = 'Формирование ЭД'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
			ТекстСообщения);
		
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Проверка обязательных полей

Функция ПроверитьЗаполнениеОбязательныхПолейТЗ(Источник, ТЗ, Знач ПоляТЗ, ИмяТЗ, ТекстОшибки)
	
	Если ТЗ.Количество() > 0 Тогда
		МассивОбязательныхКолонок = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ПоляТЗ);
		КоличествоКолонок = МассивОбязательныхКолонок.Количество();
		Для Индекс = 1 По КоличествоКолонок Цикл
			Элемент = СокрЛП(МассивОбязательныхКолонок[КоличествоКолонок - Индекс]);
			// Доп. проверка наличия обязательных колонок во вложенных таблицах см. функцию Акт501СтруктураПараметров.
			Если СтрНайти(Элемент, ".") = 0 И ТЗ.Колонки.Найти(Элемент) = Неопределено Тогда
					ШаблонОшибки = НСтр("ru = 'В таблице ""%1"" отсутствует обязательная к заполнению колонка: ""%2.""'");
					ПользовательскоеПредставление = Элемент;
					ТекстТекущейОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
																	ШаблонОшибки,
																	ИмяТЗ,
																	ПользовательскоеПредставление);
					ТекстОшибки = ТекстОшибки + ТекстТекущейОшибки + Символы.ПС;
					МассивОбязательныхКолонок.Удалить(КоличествоКолонок - Индекс);
			КонецЕсли;
			
		КонецЦикла;
		Для Каждого Строка Из ТЗ Цикл
			Для Каждого Элемент Из МассивОбязательныхКолонок Цикл
				Элемент = СокрЛП(Элемент);
				// Проверка заполненности обязательных полей во вложенных таблицах см. функцию Акт501СтруктураПараметров.
				Если СтрНайти(Элемент, ".") <> 0 Тогда
					ВложеннаяТаблица = Лев(Элемент, СтрНайти(Элемент, ".") - 1);
					ОбязательныйПараметрВложеннойТаблицы = Сред(Элемент, СтрНайти(Элемент, ".") + 1);
					
					ПользовательскоеПредставлениеТЗ = ВложеннаяТаблица;
					ПроверитьЗаполнениеОбязательныхПолейТЗ(Источник, Строка[ВложеннаяТаблица], ОбязательныйПараметрВложеннойТаблицы,
						ПользовательскоеПредставлениеТЗ, ТекстОшибки);
				Иначе
					ЗначениеПараметра = Строка[Элемент];
					Если ТипЗнч(ЗначениеПараметра) = Тип("Структура") Тогда
						ПроверитьЗаполнениеОбязательныхПолей(ЗначениеПараметра, ТекстОшибки);
						
					ИначеЕсли Не ЗначениеЗаполнено(ЗначениеПараметра) И Не ТипЗнч(ЗначениеПараметра) = Тип("Число") Тогда
						ШаблонОшибки = НСтр("ru = 'В строке №%1 таблицы ""%2"" не заполнено значение ""%3.""'");
						
						ПользовательскоеПредставление = Элемент;
						ТекстОшибки = ТекстОшибки + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки,
							ТЗ.Индекс(Строка) + 1, ИмяТЗ, ПользовательскоеПредставление) + Символы.ПС;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
	Иначе
		ШаблонОшибки = НСтр("ru = 'Не заполнена обязательная таблица: ""%1.""'");
		ТекстОшибки = ТекстОшибки + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки, ИмяТЗ) + Символы.ПС;
	КонецЕсли;
	ПараметрыЗаполнены = НЕ ЗначениеЗаполнено(ТекстОшибки);
	
	Возврат ПараметрыЗаполнены;
	
КонецФункции

// Проверяет заполнение обязательных полей в СтруктуреПараметров, если значением
// обязательного поля является вложенная структура, то она рекурсивно проверяется
// в этой же функции, если значением обязательного поля является вложенная таблица
// значений, то она передается на проверку в функцию ПроверитьЗаполнениеОбязательныхПолейТЗ.
// Список обязательных полей проверяемой структуры, берется из значения элемента
// структуры с ключем "ОбязательныеПоля".
// Список обязательных колонок таблицы значений, берется из значения элемента структуры
// с ключом "ОбязательныеПоляТаблицыЗначений".
//
// Параметры:
//  Источник             - ссылка - ссылка на объект информационной базы.
//  СтруктураПараметров  - структура - проверяемая структура с данными.
//  ТекстОшибки - Строка - строка содержащая описание незаполненных полей
//    проверяемой структуры, может быть показана пользователю в вызывающей процедуре.
//
// Возвращаемое значение:
//  ПараметрыЗаполнены - Булево - Истина - если обязательные поля заполнены, иначе - Ложь.
//
Функция ПроверитьЗаполнениеОбязательныхПолей(Источник, СтруктураПараметров, ТекстОшибки = "")
	
	ОбязательныеПоля = "";
	ЗначениеПараметра = "";
	ДанныеПодготовлены = Ложь;
	
	Если СтруктураПараметров.Свойство("ДанныеПодготовлены", ДанныеПодготовлены) И НЕ ДанныеПодготовлены Тогда
		Возврат Ложь;
	КонецЕсли;
	
	СообщениеОбОшибке = Неопределено;
	Если СтруктураПараметров.Свойство("ТекстОшибки", СообщениеОбОшибке) И ЗначениеЗаполнено(СообщениеОбОшибке) Тогда
		ТекстОшибки = СообщениеОбОшибке;
		Возврат Ложь;
	КонецЕсли;
	
	СтруктураОбязательныхПолей = СтруктураПараметров;
	Если СтруктураПараметров.Свойство("ОбязательныеПоля", ОбязательныеПоля) Тогда
		СтруктураОбязательныхПолей = Новый Структура(ОбязательныеПоля);
	КонецЕсли;
	
	Для Каждого Элемент Из СтруктураОбязательныхПолей Цикл
		Если СтруктураПараметров.Свойство(Элемент.Ключ, ЗначениеПараметра) Тогда
			Если ТипЗнч(ЗначениеПараметра) = Тип("Структура") Тогда
				ПроверитьЗаполнениеОбязательныхПолей(Источник, ЗначениеПараметра, ТекстОшибки);
			ИначеЕсли ТипЗнч(ЗначениеПараметра) = Тип("ТаблицаЗначений") Тогда
				ПоляТЗ = "";
				ПользовательскоеПредставлениеТЗ = Элемент.Ключ;
				Если СтруктураПараметров.Свойство("ОбязательныеПоляТаблицыЗначений", ПоляТЗ) Тогда
					ПроверитьЗаполнениеОбязательныхПолейТЗ(Источник, ЗначениеПараметра, ПоляТЗ, ПользовательскоеПредставлениеТЗ,
						ТекстОшибки);
				Иначе
					ШаблонОшибки = НСтр("ru = 'Не заполнен перечень обязательных полей таблицы: ""%1"".'");
					ТекстОшибки = ТекстОшибки + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки,
						ПользовательскоеПредставлениеТЗ) + Символы.ПС;
				КонецЕсли;
			ИначеЕсли ТипЗнч(ЗначениеПараметра) = Тип("СписокЗначений") Тогда
				Для Каждого ЭлементСЗ Из ЗначениеПараметра Цикл
					Если ЭлементСЗ.Пометка Тогда
						СтруктураПроверки = Новый Структура("Элемент", ЭлементСЗ.Значение);
						ПроверитьЗаполнениеОбязательныхПолей(Источник, СтруктураПроверки, ТекстОшибки);
					КонецЕсли;
				КонецЦикла;
			Иначе
				Если НЕ ЗначениеЗаполнено(ЗначениеПараметра) И Не ТипЗнч(ЗначениеПараметра) = Тип("Число") Тогда
					ШаблонОшибки = НСтр("ru = 'Не заполнено обязательное поле структуры параметров: ""%1"".'");
					
					ПользовательскоеПредставление = Элемент.Ключ;
					ТекстОшибки = ТекстОшибки + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки,
						ПользовательскоеПредставление) + Символы.ПС;
				КонецЕсли;
			КонецЕсли;
		Иначе
			ШаблонОшибки = НСтр("ru = 'Отсутствует обязательное поле в структуре параметров: ""%1"".'");
			ТекстОшибки = ТекстОшибки + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонОшибки,
				Элемент.Ключ) + Символы.ПС;
		КонецЕсли;
	КонецЦикла;
	ПараметрыЗаполнены = НЕ ЗначениеЗаполнено(ТекстОшибки);
	
	Возврат ПараметрыЗаполнены;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Заполнение файлов

Процедура ЗаполнитьДанныеПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ДанныеПокупателя, ЭтоДокументПередачи = Ложь)
	
	Результат = СформироватьДеревоРазбора(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя);
	
	Если Результат <> Неопределено Тогда
		ДеревоРазбора = Результат.ДеревоРазбора;
		СтрокаОбъекта = Результат.СтрокаОбъекта;
		
		ГрузПринялДолжность = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
			ДеревоРазбора, СтрокаОбъекта, "ГрузПолучилДолжность");
		ДанныеПокупателя.Вставить("ГрузПринялДолжность", ГрузПринялДолжность);
		ГрузПринялФИО = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
			ДеревоРазбора, СтрокаОбъекта, "ГрузПринялФИО");
		ДанныеПокупателя.Вставить("ГрузПринялФИО", ГрузПринялФИО);
			
		ГрузПолучилДолжность = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ГрузПолучилДолжность");
		Если Не ГрузПолучилДолжность = "---" Тогда
			ДанныеПокупателя.Вставить("ГрузПолучилДолжность", ГрузПолучилДолжность);
		КонецЕсли;
		ДанныеПокупателя.Вставить("ГрузПолучилФИО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ГрузПолучилФИО"));
		ДатаПолучения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаПолучения");
		Если ЗначениеЗаполнено(ДатаПолучения) Тогда
			Если ЭтоДокументПередачи Тогда
				ДатаПолучения = Формат(ДатаПолучения, "ДЛФ=D");
			КонецЕсли;
			ДанныеПокупателя.Вставить("ДатаПолучения", ДатаПолучения);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеЗаказчика(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ДанныеЗаказчика)
	
	Результат = СформироватьДеревоРазбора(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя);
	
	Если Результат <> Неопределено Тогда
	
		ДеревоРазбора = Результат.ДеревоРазбора;
		СтрокаОбъекта = Результат.СтрокаОбъекта;
		ДанныеЗаказчика.Вставить("Претензии", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Претензии"));
		
		ДанныеЗаказчика.Вставить("ПринялДолжность", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ПринялДолжность"));
		ДанныеЗаказчика.Вставить("ПринялФИО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ПринялФИО"));
		ДанныеЗаказчика.Вставить("ДатаПолучения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаПолучения"));
		
	КонецЕсли;
	
КонецПроцедуры

Функция ЗаполнитьДанныеДоверенностиCML(ДоверенностьXDTO, ДеревоДанных, Ошибки, ПространствоИменСхемы, Префикс = "")
	
	ОбъектЗаполнен = Ложь;
	Префикс = Префикс + ?(ЗначениеЗаполнено(Префикс), ".", "");
	ВыданаКем = ПолучитьОбъектТипаCML("ДоверенностьТип.ВыданаКем", ПространствоИменСхемы);
	БлокЗаполнен = Ложь;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ОрганизацияВыдавшаяДоверенность") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ОрганизацияВыдавшаяДоверенность");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(ВыданаКем, "НаимОргКем", Реквизит, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ЛицоВыдавшееДоверенность.Должность") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ЛицоВыдавшееДоверенность.Должность");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(ВыданаКем, "ДолжнКем", Реквизит, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ЛицоВыдавшееДоверенность.Фамилия") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ЛицоВыдавшееДоверенность.Фамилия");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ФИОТип = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ФИОТип, "Фамилия", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ЛицоВыдавшееДоверенность.Имя");
			ЗаполнитьСвойствоXDTO(ФИОТип, "Имя", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ЛицоВыдавшееДоверенность.Отчество");
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЗаполнитьСвойствоXDTO(ФИОТип, "Отчество", Реквизит, , Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(ВыданаКем, "ФИО", ФИОТип, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "НомерДоверенности") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "НомерДоверенности");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(ДоверенностьXDTO, "НомДоверен", Реквизит, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ДатаДоверенности") Тогда
		Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ДатаДоверенности"));
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(ДоверенностьXDTO, "ДатаДоверен", Реквизит, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ДопСведенияОВыдачеДоверенности") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ДопСведенияОВыдачеДоверенности");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(ВыданаКем, "ДопСведКем", Реквизит, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если БлокЗаполнен Тогда
		ЗаполнитьСвойствоXDTO(ДоверенностьXDTO, "ВыданаКем", ВыданаКем, , Ошибки);
		ОбъектЗаполнен = Истина;
	КонецЕсли;
	
	ВыданаКому = ПолучитьОбъектТипаCML("ДоверенностьТип.ВыданаКому", ПространствоИменСхемы);
	БлокЗаполнен = Ложь;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ДопСведенияОДоверенномЛице") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ДопСведенияОДоверенномЛице");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(ВыданаКому, "ДопСведКому", Реквизит, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ДоверенноеЛицо.Должность") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ДоверенноеЛицо.Должность");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(ВыданаКому, "Должн", Реквизит, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, Префикс + "ДоверенноеЛицо.Фамилия") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ДоверенноеЛицо.Фамилия");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ФИОТип = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ФИОТип, "Фамилия", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ДоверенноеЛицо.Имя");
			ЗаполнитьСвойствоXDTO(ФИОТип, "Имя", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, Префикс + "ДоверенноеЛицо.Отчество");
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЗаполнитьСвойствоXDTO(ФИОТип, "Отчество", Реквизит, , Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(ВыданаКому, "ФИО", ФИОТип, , Ошибки);
			БлокЗаполнен = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если БлокЗаполнен Тогда
		ЗаполнитьСвойствоXDTO(ДоверенностьXDTO, "ВыданаКому", ВыданаКому, , Ошибки);
		ОбъектЗаполнен = Истина;
	КонецЕсли;
	
	Возврат ОбъектЗаполнен;
	
КонецФункции

Процедура СформироватьДанныеПоКонтрагентуCML(Контрагент, ДеревоДанных, ВидКонтрагента, Ошибки, ВерсияСхемы = "4.01", ИмяСвойства = Неопределено)
	
	Если Не ЗначениеЗаполнено(ИмяСвойства) Тогда
		ИмяСвойства = ВидКонтрагента;
	КонецЕсли;
	
	ДанныеКонтрагента = Неопределено;
	Если НЕ ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ИмяСвойства) Тогда
		Возврат;
	Иначе
		ДанныеКонтрагента = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ИмяСвойства);
	КонецЕсли;
	
	ЭтоФизЛицо = Ложь;
	ОбменСКонтрагентамиПереопределяемый.ЭтоФизЛицо(ДанныеКонтрагента, ЭтоФизЛицо);
	ИдКонтрагента = "";
	ОбменСКонтрагентамиПереопределяемый.ПолучитьИДКонтрагента(ДанныеКонтрагента, ВидКонтрагента, ИдКонтрагента);
	ЗаполнитьСвойствоXDTO(Контрагент, "Ид", ИдКонтрагента, Истина, Ошибки);
	
	// Заполнение реквизитов юридического или физического лица.
	ДанныеЮрФизЛица = Неопределено; 
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ДанныеКонтрагента, ДанныеЮрФизЛица);
	
	ПолноеНаименованиеИмя = ?(ЭтоФизЛицо, "ПолноеНаименование", "ОфициальноеНаименование");
	ПолноеНаименование = "";
	Если НЕ ДанныеЮрФизЛица.Свойство(ПолноеНаименованиеИмя, ПолноеНаименование) ИЛИ ПустаяСтрока(ПолноеНаименование) Тогда
		ДанныеЮрФизЛица.Свойство("Представление", ПолноеНаименование);
	КонецЕсли;
	
	РеквизитыКонтрагентаИмя  = ?(ЭтоФизЛицо, "ФизЛицо", "ЮрЛицо");
	РеквизитыКонтрагентаXDTO = ПолучитьОбъектТипаCML("Контрагент."+РеквизитыКонтрагентаИмя, ВерсияСхемы);
	
	ЗаполнитьСвойствоXDTO(РеквизитыКонтрагентаXDTO, ПолноеНаименованиеИмя, ПолноеНаименование, Истина, Ошибки);
	ЗаполнитьСвойствоXDTO(РеквизитыКонтрагентаXDTO, "ИНН", ДанныеЮрФизЛица.ИНН, , Ошибки);
	
	Если НЕ ЭтоФизЛицо Тогда
		// КПП есть только в реквизитах ЮрЛица
		ЗаполнитьСвойствоXDTO(РеквизитыКонтрагентаXDTO, "КПП", ДанныеЮрФизЛица.КПП, , Ошибки);
		ЗаполнитьСвойствоXDTO(РеквизитыКонтрагентаXDTO, "ОКПО", ДанныеЮрФизЛица.КодПоОКПО, , Ошибки);
	КонецЕсли;
	
	// Юр.адрес или адрес регистрации.
	Если ЗначениеЗаполнено(ДанныеЮрФизЛица.ЮридическийАдрес) Тогда
		
		ЮридическийАдресИмя  = ?(ЭтоФизЛицо, "АдресРегистрации", "ЮридическийАдрес");
		ЮридическийАдресXDTO = ПолучитьОбъектТипаCML("Адрес", ВерсияСхемы);
		
		ЗаполнитьСвойствоXDTO(ЮридическийАдресXDTO, "Представление", ДанныеЮрФизЛица.ЮридическийАдрес, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(РеквизитыКонтрагентаXDTO, ЮридическийАдресИмя, ЮридическийАдресXDTO, , Ошибки);
		
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(Контрагент, РеквизитыКонтрагентаИмя, РеквизитыКонтрагентаXDTO, , Ошибки);
	
	// РасчетныеСчета.
	РасчСчет = Неопределено;
	
	ВидыКонтрагентов = Новый Массив;
	ВидыКонтрагентов.Добавить("Организация"); // 0
	ВидыКонтрагентов.Добавить("Контрагент");  // 1
	ВидыКонтрагентов.Добавить("Организация"); // 2
	ВидыКонтрагентов.Добавить("Контрагент");  // 3
	ВидыКонтрагентов.Добавить("Контрагент");  // 4
	
	ИмяРеквизитаСчет = Новый Массив;
	ИмяРеквизитаСчет.Добавить("РасчетныйСчетОрганизации");      // 0
	ИмяРеквизитаСчет.Добавить("РасчетныйСчетКонтрагента");      // 1
	ИмяРеквизитаСчет.Добавить("РасчетныйСчетГрузоотправителя"); // 2
	ИмяРеквизитаСчет.Добавить("РасчетныйСчетГрузоотправителя"); // 3
	ИмяРеквизитаСчет.Добавить("РасчетныйСчетГрузополучателя");  // 4
	
	Для н = 0 По 4 Цикл
		Если ВидКонтрагента = ВидыКонтрагентов[н]
			И ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ИмяРеквизитаСчет[н]) Тогда
			РасчСчет = ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, ИмяРеквизитаСчет[н]);
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(РасчСчет) Тогда
		
		РасчетныеСчета = ПолучитьОбъектТипаCML("Контрагент.РасчетныеСчета", ВерсияСхемы);
		РасчетныйСчет  = ПолучитьОбъектТипаCML("РасчетныйСчет",             ВерсияСхемы);
		
		ЗаполнитьСвойствоXDTO(РасчетныйСчет, "НомерСчета", РасчСчет.НомерСчета, Истина, Ошибки);
		
		// Банк
		Банк = ПолучитьОбъектТипаCML("Банк", ВерсияСхемы);
		ЗаполнитьСвойствоXDTO(Банк, "СчетКорреспондентский", РасчСчет.Банк.КоррСчет, , Ошибки);
		ЗаполнитьСвойствоXDTO(Банк, "Наименование", РасчСчет.Банк.Наименование, , Ошибки);
		ЗаполнитьСвойствоXDTO(Банк, "БИК", РасчСчет.Банк.Код, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(РасчетныйСчет, "Банк", Банк, Истина, Ошибки);
		
		// Банк корреспондент
		Если ЗначениеЗаполнено(РасчСчет.БанкДляРасчетов) Тогда
			
			БанкКорр = ПолучитьОбъектТипаCML("Банк", ВерсияСхемы);
			
			ЗаполнитьСвойствоXDTO(БанкКорр, "СчетКорреспондентский", РасчСчет.БанкДляРасчетов.КоррСчет, , Ошибки);
			ЗаполнитьСвойствоXDTO(БанкКорр, "Наименование", РасчСчет.БанкДляРасчетов.Наименование, , Ошибки);
			ЗаполнитьСвойствоXDTO(БанкКорр, "БИК", РасчСчет.БанкДляРасчетов.Код, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(РасчетныйСчет, "БанкКорреспондент", БанкКорр, , Ошибки);
			
		КонецЕсли;
		
		РасчетныеСчета.РасчетныйСчет.Добавить(РасчетныйСчет);
		ЗаполнитьСвойствоXDTO(Контрагент, "РасчетныеСчета", РасчетныеСчета, , Ошибки);
		
	КонецЕсли;
	
	// Адрес
	Если ТипЗнч(ДанныеЮрФизЛица) = Тип("Структура") И ДанныеЮрФизЛица.Свойство("ФактическийАдрес")
		И ЗначениеЗаполнено(ДанныеЮрФизЛица.ФактическийАдрес) Тогда
		
		АдресXDTO = ПолучитьОбъектТипаCML("Адрес", ВерсияСхемы);
		ЗаполнитьСвойствоXDTO(АдресXDTO, "Представление", ДанныеЮрФизЛица.ФактическийАдрес, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Контрагент, "Адрес", АдресXDTO, , Ошибки);
	КонецЕсли;
	
	// Контакты организации
	Если (ВидКонтрагента = "Организация") Тогда
		ТаблицаКонтактов = Неопределено; 
		ОбменСКонтрагентамиПереопределяемый.ПолучитьКонтактнуюИнформацию(ДанныеКонтрагента, ТаблицаКонтактов);

		Если ТаблицаКонтактов.Количество()>0 Тогда
			Контакты = ПолучитьОбъектТипаCML("Контрагент.Контакты", ВерсияСхемы);
			ЕстьКонтакты = Ложь;
			Для Каждого СтрокаКонтакта Из ТаблицаКонтактов Цикл
				Контакт = ПолучитьОбъектТипаCML("КонтактнаяИнформация", ВерсияСхемы);
				ОшибкиКонтакта = Неопределено;
				Если СтрокаКонтакта.Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации",
					"EmailОрганизации") Тогда
						
					Тип = ПолучитьЗначениеТипаCML("КонтактТип", "Почта");
					ЗаполнитьСвойствоXDTO(Контакт, "Тип", Тип, Истина, ОшибкиКонтакта);
					ЗаполнитьСвойствоXDTO(Контакт, "Комментарий", СтрокаКонтакта.Комментарий, , ОшибкиКонтакта);
					ЗаполнитьСвойствоXDTO(Контакт, "Значение", СтрокаКонтакта.Значение, Истина, ОшибкиКонтакта);
				ИначеЕсли СтрокаКонтакта.Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации",
					"ТелефонОрганизации") Тогда
					
					Тип = ПолучитьЗначениеТипаCML("КонтактТип", НСтр("ru = 'Телефон рабочий'"));
					ЗаполнитьСвойствоXDTO(Контакт, "Тип",Тип,Истина, ОшибкиКонтакта);
					ЗаполнитьСвойствоXDTO(Контакт, "Комментарий", СтрокаКонтакта.Комментарий, , ОшибкиКонтакта);
					ЗаполнитьСвойствоXDTO(Контакт, "Значение", СтрокаКонтакта.Значение, Истина, ОшибкиКонтакта);
				ИначеЕсли СтрокаКонтакта.Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации",
					"ФаксОрганизации") Тогда
					
					Тип = ПолучитьЗначениеТипаCML("КонтактТип", "Факс");
					ЗаполнитьСвойствоXDTO(Контакт, "Тип",Тип,Истина, ОшибкиКонтакта);
					ЗаполнитьСвойствоXDTO(Контакт, "Комментарий", СтрокаКонтакта.Комментарий, , ОшибкиКонтакта);
					ЗаполнитьСвойствоXDTO(Контакт, "Значение", СтрокаКонтакта.Значение, Истина, ОшибкиКонтакта);
					
				КонецЕсли;
				Если Не ЗначениеЗаполнено(ОшибкиКонтакта) Тогда
					Контакты.Контакт.Добавить(Контакт);
					ЕстьКонтакты = Истина;
				Иначе
					Если Не ЗначениеЗаполнено(Ошибки) Тогда
						Ошибки = Новый Массив;
					КонецЕсли;
					
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Ошибки, ОшибкиКонтакта);
				КонецЕсли;
			КонецЦикла;
			
			Если ЕстьКонтакты Тогда
				ЗаполнитьСвойствоXDTO(Контрагент, "Контакты",	Контакты, , Ошибки);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли
	
КонецПроцедуры

Процедура СформироватьДанныеПоТоваруCML(Товар, СтрокаДерева, Ошибки, ВерсияСхемы = "4.01")
	
	// Формируем ИД товара.
	ИДТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.Ид");
	Если Не ЗначениеЗаполнено(ИДТовара) Тогда

		Номенклатура = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.Номенклатура");
		ИДНоменклатуры = Номенклатура.УникальныйИдентификатор();
		
		ИДХарактеристики = "";
		ИДУпаковки       = "";
		
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДерева, "Товары.НомерСтроки.Характеристика") Тогда
			Характеристика = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.Характеристика");
			ИДХарактеристики = ?(ЗначениеЗаполнено(Характеристика), Характеристика.УникальныйИдентификатор(), "");
		КонецЕсли;
		
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДерева, "Товары.НомерСтроки.Упаковка") Тогда
			Упаковка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.Упаковка");
			ИДУпаковки = ?(ЗначениеЗаполнено(Упаковка), Упаковка.УникальныйИдентификатор(), "");
		КонецЕсли;
		
		ИДТовара = Строка(ИДНоменклатуры) + "#" + Строка(ИДХарактеристики) + "#" + Строка(ИДУпаковки);
		
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(Товар, "Ид", ИДТовара, Истина, Ошибки);
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДерева, "Товары.НомерСтроки.ШтрихКод") Тогда
		ЗаполнитьСвойствоXDTO(Товар, "ШтрихКод",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.ШтрихКод"), , Ошибки);
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДерева, "Товары.НомерСтроки.Артикул") Тогда
		ЗаполнитьСвойствоXDTO(Товар, "Артикул",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.Артикул"), , Ошибки);
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДерева, "Товары.НомерСтроки.ИДТовара") Тогда
		ЗаполнитьСвойствоXDTO(Товар, "ИДТовара",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.ИДТовара"), , Ошибки);
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(Товар, "Наименование",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.Наименование"), Истина, Ошибки);
	
	БазоваяЕдиница = ПолучитьОбъектТипаCML("Товар.БазоваяЕдиница", ВерсияСхемы);
	ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "Код",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.БазоваяЕдиницаКод"), Истина, Ошибки);
	ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "Наименование",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.БазоваяЕдиницаНаименование"), , Ошибки);
	ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "НаименованиеПолное",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.БазоваяЕдиницаНаименованиеПолное"), , Ошибки);
	ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "МеждународноеСокращение",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.БазоваяЕдиницаМеждународноеСокращение"), , Ошибки);
		
	ЗаполнитьСвойствоXDTO(Товар, "БазоваяЕдиница", БазоваяЕдиница, Истина, Ошибки);
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДерева, "Товары.НомерСтроки.Описание") Тогда
		ЗаполнитьСвойствоXDTO(Товар, "Описание",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "Товары.НомерСтроки.Описание"), , Ошибки);
	КонецЕсли;
	
	ДопРеквизиты = Неопределено;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДерева, "Товары.НомерСтроки.ДополнительныеРеквизиты") Тогда
		ДопРеквизиты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			СтрокаДерева, "Товары.НомерСтроки.ДополнительныеРеквизиты");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ДопРеквизиты) Тогда
		
		Для Каждого Элемент Из ДопРеквизиты Цикл
			Если Не ЗначениеЗаполнено(Элемент.Значение) Тогда
				Продолжить;
			КонецЕсли;
			ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ВерсияСхемы);
			ЗаполнитьСвойствоXDTO(ЗначениеРеквизита, "Наименование", Элемент.Ключ, Истина, Ошибки);
			
			Если ТипЗнч(Элемент.Значение) = Тип("Массив") Тогда
				Для Каждого ЭлементМассива Из Элемент.Значение Цикл
					// Для корректной передачи адресов покупателя соберем структура адреса ФНС в строку.
					Если Элемент.Ключ = "ПокупательФактАдрес" ИЛИ Элемент.Ключ = "ПокупательЮрАдрес" Тогда
						Если ТипЗнч(ЭлементМассива) = Тип("СписокЗначений") Тогда
							ЗаполненныйТип = Неопределено;
							Для Каждого Элемент Из ЭлементМассива Цикл
								Если Элемент.Пометка Тогда
									ЗаполненныйТип = Элемент;
									Прервать;
								КонецЕсли;
							КонецЦикла;
							Если ЗаполненныйТип <> Неопределено И ТипЗнч(ЗаполненныйТип.Значение) = Тип("Структура") Тогда
								Адрес = ЗаполненныйТип.Значение;
								Если ЗаполненныйТип.Представление = "Структурированный" Тогда
									ЭлементМассива = СобратьАдрес(Адрес);
								Иначе
									ЭлементМассива = Адрес.АдресСтрокой;
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
					ЗначениеРеквизита.Значение.Добавить(ЭлементМассива)
				КонецЦикла;
			Иначе
				// Для корректной передачи адресов покупателя соберем структура адреса ФНС в строку.
				Если Элемент.Ключ = "ПокупательФактАдрес" ИЛИ Элемент.Ключ = "ПокупательЮрАдрес" Тогда
					Если ТипЗнч(Элемент.Значение) = Тип("СписокЗначений") Тогда
						ЗаполненныйТип = Неопределено;
						Для Каждого Элемент Из Элемент.Значение Цикл
							Если Элемент.Пометка Тогда
								ЗаполненныйТип = Элемент;
								Прервать;
							КонецЕсли;
						КонецЦикла;
						Если ЗаполненныйТип <> Неопределено И ТипЗнч(ЗаполненныйТип.Значение) = Тип("Структура") Тогда
							Адрес = ЗаполненныйТип.Значение;
							Если ЗаполненныйТип.Представление = "Структурированный" Тогда
								Элемент.Значение = СобратьАдрес(Адрес);
							Иначе
								Элемент.Значение = Адрес.АдресСтрокой;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				ЗначениеРеквизита.Значение.Добавить(Элемент.Значение)
			КонецЕсли;
			
			Товар.ДополнительныеРеквизиты.Добавить(ЗначениеРеквизита);
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьЗначениеXDTO(ОбъектXDTO, ИмяСвойства, Значение, Ошибки)
	
	Попытка
		ОбъектXDTO.Установить(ИмяСвойства, Значение);
	Исключение
		ШаблонСообщения = НСтр("ru = 'Выполнение операции: Заполнение XDTO.
			|Ошибка установки значения свойства ""%1"".'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, ИмяСвойства);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибку(Ошибки, ТекстСообщения);
		
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ТекстСообщения + Символы.ПС
			+ ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "ОбменСКонтрагентами");
	КонецПопытки
	
КонецПроцедуры

Функция XMLЧисло(Значение)
	
	Возврат Формат(Значение, "ЧРД=.; ЧН=0; ЧГ=");
	
КонецФункции

Функция XMLДатаВремя(Значение)
	
	Если ЗначениеЗаполнено(Значение) Тогда
		Возврат Формат(Значение, "ДФ=yyyy-MM-dd'T'ЧЧ:мм:сс");
	КонецЕсли;
	
	Возврат "0001-01-01T00:00:00";
	
КонецФункции

Функция XMLДата(Значение)
	
	Если ЗначениеЗаполнено(Значение) Тогда
		Возврат Формат(Значение, "ДФ=yyyy-MM-dd");
	КонецЕсли;
	
	Возврат "0001-01-01";
	
КонецФункции

Функция ДатаДД_ММ_ГГГГ(ДатаВремя)
	
	Если ТипЗнч(ДатаВремя) = Тип("Дата") Тогда
		ВозврЗначение = Формат(ДатаВремя, "ДЛФ=D");
	Иначе
		ВозврЗначение = Лев(ДатаВремя, 10);
	КонецЕсли;
	
	Возврат ВозврЗначение;
	
КонецФункции

Функция ВернутьНомерВерсииИзИдЭД(ИдОтправителя)
	
	НомерВерсии = 0;
	НачПозиция = СтрНайти(ИдОтправителя, "##");
	Если НачПозиция > 0 Тогда
		НомерВерсии = Сред(ИдОтправителя, НачПозиция + 2, СтрДлина(ИдОтправителя) - (НачПозиция + 1));
	КонецЕсли;
	
	Возврат НомерВерсии;
	
КонецФункции

Процедура ЗаполнитьРасчетныйСчетПоставщика(ДеревоДанных, Контрагент, ПространствоИменСхемы, Ошибки)
	
	НомерСчета = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.НомерСчета");
	
	СтруктураСчет = Новый Структура("НомерСчета, БИК, СчетКорреспондентский, НаименованиеБанка, БикКорр,
			|СчетКорр, НаименованиеКорр");
	
	Если ЗначениеЗаполнено(НомерСчета) Тогда
		
		// заполняем расчетный счет
		СтруктураСчет.НомерСчета = НомерСчета;
		
		// заполняем банк
		
		БикБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.Банк.БИК", Ложь);
		Если ЗначениеЗаполнено(БикБанка) Тогда
			СтруктураСчет.БИК = БикБанка;
		КонецЕсли;
		
		СчетКорреспондентский = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.Банк.СчетКорреспондентский", Ложь);
		Если ЗначениеЗаполнено(СчетКорреспондентский) Тогда	
			СтруктураСчет.СчетКорреспондентский = СчетКорреспондентский;
		КонецЕсли;
		
		НаименованиеБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.Банк.Наименование", Ложь);
		Если ЗначениеЗаполнено(НаименованиеБанка) Тогда
			СтруктураСчет.НаименованиеБанка = НаименованиеБанка;
		КонецЕсли;
		
		// заполняем банк корреспондент
		
		БикКорБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.БИК");
		
		Если ЗначениеЗаполнено(БикКорБанка) Тогда
			СтруктураСчет.БикКорр = БикКорБанка;
		КонецЕсли;
		
		КорСчетКорреспондентский = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.СчетКорреспондентский");
		Если ЗначениеЗаполнено(КорСчетКорреспондентский) Тогда
			СтруктураСчет.СчетКорр = КорСчетКорреспондентский;
		КонецЕсли;
		
		НаименованиеКорБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.Наименование");
		Если ЗначениеЗаполнено(НаименованиеКорБанка) Тогда
			СтруктураСчет.НаименованиеКорр =  НаименованиеКорБанка;
		КонецЕсли;
		
		БанковскиеРеквизиты = ПолучитьОбъектТипаCML("РасчетныйСчет", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(БанковскиеРеквизиты, "НомерСчета", СтруктураСчет.НомерСчета, Истина, Ошибки);
		
		СвБанк = ПолучитьОбъектТипаCML("Банк", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(СвБанк, "Наименование", СтруктураСчет.НаименованиеБанка, ,Ошибки);
		ЗаполнитьСвойствоXDTO(СвБанк, "БИК", СтруктураСчет.БИК, ,Ошибки);
		ЗаполнитьСвойствоXDTO(СвБанк, "СчетКорреспондентский", СтруктураСчет.СчетКорреспондентский, ,Ошибки);
		ЗаполнитьСвойствоXDTO(БанковскиеРеквизиты, "Банк", СвБанк, Истина, Ошибки);
		
		БанкКорреспондент = ПолучитьОбъектТипаCML("Банк", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(БанкКорреспондент, "Наименование", СтруктураСчет.НаименованиеКорр, ,Ошибки);
		ЗаполнитьСвойствоXDTO(БанкКорреспондент, "БИК", СтруктураСчет.БикКорр, ,Ошибки);
		ЗаполнитьСвойствоXDTO(БанкКорреспондент, "СчетКорреспондентский", СтруктураСчет.СчетКорр, ,Ошибки);
		
		ЗаполнитьСвойствоXDTO(БанковскиеРеквизиты, "БанкКорреспондент", БанкКорреспондент, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(Контрагент, "РасчетныйСчет", БанковскиеРеквизиты, , Ошибки);
	
	КонецЕсли;
	

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// CML

Функция ПолучитьТипОбъектаCML(Тип, ВерсияСхемы)
	
	МассивПути = ЭлектронноеВзаимодействиеСлужебный.МассивПодстрок(Тип, ".");
	
	ПервыйЭлемент = МассивПути[0];
	Если Лев(ПервыйЭлемент,1) = "{" И Прав(ПервыйЭлемент,1) = "}" Тогда
		ИмяПакета = Сред(ПервыйЭлемент, 2, СтрДлина(ПервыйЭлемент) - 2);
		Коллекция = ФабрикаXDTO.Пакеты.Получить(ИмяПакета).КорневыеСвойства;
	ИначеЕсли ВерсияСхемы <> "4.02" Тогда
		ТипОбъекта = ФабрикаXDTO.Тип(ВерсияСхемы, ПервыйЭлемент);
		Коллекция = ТипОбъекта.Свойства;
	Иначе
		ТипОбъекта = ФабрикаXDTO.Тип("http://v8.1c.ru/edi/edi_stnd", ПервыйЭлемент);
		Коллекция = ТипОбъекта.Свойства;
	КонецЕсли;
	
	МассивПути.Удалить(0);
	Пока МассивПути.Количество() > 0 Цикл
		
		Если Коллекция = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Свойство = Коллекция.Получить(МассивПути[0]);
		Если Свойство = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		ТипОбъекта = Свойство.Тип;
		МассивПути.Удалить(0);
		Попытка
			Коллекция = ТипОбъекта.Свойства;
		Исключение
			Коллекция = Неопределено;
		КонецПопытки;
		
	КонецЦикла;
	
	Возврат ТипОбъекта;
	
КонецФункции

Функция ПолучитьЗначениеТипаCML(Тип, Значение)
	
	Если ТипЗнч(Тип) = Тип("Строка") Тогда
		ТипЗначения = ПолучитьТипЗначенияCML(Тип);
	Иначе
		ТипЗначения = Тип;
	КонецЕсли;
	
	Если ТипЗначения = Неопределено Тогда
		
		Возврат Неопределено;
	КонецЕсли;
	
	НовоеЗначение = ФабрикаXDTO.Создать(ТипЗначения, Значение);
	
	Возврат НовоеЗначение;
	
КонецФункции

Процедура ДобавитьВЗначенияРеквизитовДокумента(НаименованиеРеквизита, ДобавляемоеЗначение, ДокументXDTO)
	
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	ЗначенияРеквизитаДокумента = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
	ЗначенияРеквизитаДокумента.Наименование = НаименованиеРеквизита;
	
	Если ТипЗнч(ДобавляемоеЗначение) = Тип("Массив") Тогда
		Для Каждого ЭлементМассива Из ДобавляемоеЗначение Цикл
			ЗначенияРеквизитаДокумента.Значение.Добавить(Строка(ЭлементМассива));
		КонецЦикла;
	ИначеЕсли СтрНайти(НаименованиеРеквизита, "СтавкаНДС") > 0 Тогда
		ЗначенияРеквизитаДокумента.Значение.Добавить(ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия(, ДобавляемоеЗначение));
		
	Иначе
		ЗначенияРеквизитаДокумента.Значение.Добавить(Строка(ДобавляемоеЗначение))
		
	КонецЕсли;
	
	Если ДокументXDTO.ЗначенияРеквизитов = Неопределено Тогда
		
		Если ДокументXDTO.Тип() = ПолучитьТипОбъектаCML("Документ", ПространствоИменСхемы) Тогда
			ДокументXDTOЗначенияРеквизитов = ПолучитьОбъектТипаCML("Документ.ЗначенияРеквизитов", ПространствоИменСхемы);
			
		ИначеЕсли ДокументXDTO.Тип() = ПолучитьТипОбъектаCML("ПакетПредложений", ПространствоИменСхемы) Тогда
			ДокументXDTOЗначенияРеквизитов = ПолучитьОбъектТипаCML("ПакетПредложений.ЗначенияРеквизитов", ПространствоИменСхемы);
	
		Иначе
			ДокументXDTOЗначенияРеквизитов = ПолучитьОбъектТипаCML("Товар.ЗначенияРеквизитов", ПространствоИменСхемы);
		КонецЕсли;
		
		ДокументXDTOЗначенияРеквизитов.ЗначениеРеквизита.Добавить(ЗначенияРеквизитаДокумента);
		
		ДокументXDTO.ЗначенияРеквизитов = ДокументXDTOЗначенияРеквизитов;
	Иначе
		
		ДокументXDTO.ЗначенияРеквизитов.ЗначениеРеквизита.Добавить(ЗначенияРеквизитаДокумента);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьТипЦены(СтрокаДерева, ТипЦеныXDTO)
	
	ТипЦены = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "ТипыЦен.НомерСтроки.ТипЦены");
	ИдТипаЦены = Строка(ТипЦены.УникальныйИдентификатор());
	ЗаполнитьСвойствоXDTO(ТипЦеныXDTO, "Ид", ИдТипаЦены);
	
	Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "ТипыЦен.НомерСтроки.Наименование");
	ЗаполнитьСвойствоXDTO(ТипЦеныXDTO, "Наименование", Наименование);
	
	Валюта = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "ТипыЦен.НомерСтроки.Валюта");
	ЗаполнитьСвойствоXDTO(ТипЦеныXDTO, "Валюта", Валюта);
	
	Налог = ВеткаТаблицыВДереве(СтрокаДерева, "ТипыЦен.НомерСтроки.ВключаетНДС");
	Если Не ЗначениеЗаполнено(Налог) Тогда
		Возврат;
	КонецЕсли;
	
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	
	
	НалогТипаЦены =  ПолучитьОбъектТипаCML("ПакетПредложений.ТипыЦен.ТипЦены.Налог", ПространствоИменСхемы);
	
	
	ЗаполнитьСвойствоXDTO(НалогТипаЦены, "Наименование", "НДС");
	
	УчтеноВСумме = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДерева, "ТипыЦен.НомерСтроки.ВключаетНДС");
	ЗаполнитьСвойствоXDTO(НалогТипаЦены, "УчтеноВСумме", УчтеноВСумме);
	
	
	ЗаполнитьСвойствоXDTO(НалогТипаЦены, "Акциз", Ложь);
	
	ТипЦеныXDTO.Налог.Добавить(НалогТипаЦены);
	
КонецПроцедуры

Функция СтавкаНДСXDTO(ЗначениеСтавки)
	
	СтавкиФНС = Новый Соответствие;
	СтавкиФНС.Вставить("0", "0%");
	СтавкиФНС.Вставить("10", "10%");
	СтавкиФНС.Вставить("18", "18%");
	СтавкиФНС.Вставить("10/110", "10/110");
	СтавкиФНС.Вставить("18/118", "18/118");
	СтавкиФНС.Вставить("20", "20%");
	СтавкиФНС.Вставить("20/120", "20/120");
	СтавкиФНС.Вставить(ВРег("без НДС"), "без НДС");
	СтавкиФНС.Вставить(ВРег("НДС исчисляется налоговым агентом"), "НДС исчисляется налоговым агентом");
	
	СтавкаXDTO = СтавкиФНС.Получить(ВРег(ЗначениеСтавки));
	
	Возврат СтавкаXDTO;
	
КонецФункции

/////////////////////////////////////////////////////////////////////////////////
// Дерево значений

Функция ВеткаТаблицыВДереве(СтрокаДерева, ИмяРеквизита)
	
	НайденнаяСтрока = СтрокаДерева.Строки.Найти(ИмяРеквизита,"ПолныйПуть", Истина);
	Если НайденнаяСтрока <> Неопределено Тогда
		Возврат НайденнаяСтрока;
	КонецЕсли;

КонецФункции

Функция ПустаяТаблицаДерева(ТаблицаТипыЦен)
	
	ТаблицаПустая = Ложь;
	
	Если ТаблицаТипыЦен = Неопределено Тогда
		ТаблицаПустая = Истина;
	КонецЕсли;
	
	Если ТаблицаТипыЦен.Строки.Количество() = 0 Тогда
		ТаблицаПустая = Истина;
	КонецЕсли;
	
	ЗначениеНомераСтройки = ТаблицаТипыЦен.Строки[0].Значение;
	
	Если Не ЗначениеЗаполнено(ЗначениеНомераСтройки) Тогда
		ТаблицаПустая = Истина;
	КонецЕсли;
	
	Возврат ТаблицаПустая;
	
КонецФункции

Процедура УдалитьПрочитатьАктОПриемкеXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ИД = ЭД.Ид;
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктВыполненныхРабот;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Номер);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.Дата);
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		ВалютаXDTO = ЭД.Получить(СвойствоЭД);
		КодВалюты = ВалютаXDTO.КодОКВ;
		Если КодВалюты <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("Наименование", ВалютаXDTO.НаименованиеСокращенноеОКВ);
			ДопРеквизиты.Вставить("НаименованиеПолное", ВалютаXDTO.НаименованиеПолноеОКВ);
			ДопРеквизиты.Вставить("КодМКВ", ВалютаXDTO.КодМКВ);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ВалютаXDTO.Курс;
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогоПоДокументу");
	Если СвойствоЭД <> Неопределено Тогда
		ИтогоПоДокументуXDTO = ЭД.Получить(СвойствоЭД);
		СвойствоСуммаОбщая = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаОбщая");
		Если СвойствоСуммаОбщая <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", ИтогоПоДокументуXDTO.Получить(СвойствоСуммаОбщая));
		КонецЕсли;
		СвойствоЦенаВключаетНДС = ИтогоПоДокументуXDTO.Свойства().Получить("ЦенаВключаетНалог");
		Если СвойствоЦенаВключаетНДС <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЦенаВключаетНДС", ИтогоПоДокументуXDTO.Получить(СвойствоЦенаВключаетНДС));
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Исполнитель");
	Если СвойствоЭД <> Неопределено Тогда
		Исполнитель = ЭД.Получить(СвойствоЭД);
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
			ПрочитатьДанныеКонтрагента(Исполнитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Исполнитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Заказчик");
	Если СвойствоЭД <> Неопределено Тогда
		Заказчик = ЭД.Получить(СвойствоЭД);
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
			ПрочитатьДанныеКонтрагента(Заказчик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Заказчик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ТекстДокумента");
	Если СвойствоЭД <> Неопределено Тогда
		ТекстДокумента = ЭД.Получить(СвойствоЭД);
		СвойствоЗаголовок = ТекстДокумента.Свойства().Получить("Заголовок");
		Если СвойствоЗаголовок <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Заголовок", ТекстДокумента.Получить(СвойствоЗаголовок));
		КонецЕсли;
		СвойствоЗаголовок = ТекстДокумента.Свойства().Получить("ОписаниеВыполненныхРабот");
		Если СвойствоЗаголовок <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОписаниеВыполненныхРабот", ТекстДокумента.Получить(СвойствоЗаголовок));
		КонецЕсли;
		СвойствоЗаголовок = ТекстДокумента.Свойства().Получить("Претензии");
		Если СвойствоЗаголовок <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Претензии", ТекстДокумента.Получить(СвойствоЗаголовок));
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогиПрописью");
	Если СвойствоЭД <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИтогиПрописью", ЭД.Получить(СвойствоЭД));
	КонецЕсли;
	
	НаборДанных = ЭД["Товары"].Товар;
	ПрочитатьДанныеПоТЧАктаОПриемке(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
КонецПроцедуры

Процедура ПрочитатьАкт501XDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	ИнфПол = ЭД.Документ.СвАктИ.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено И СтрНайти(ИнфПол.ТекстИнф, "xml") = 0 Тогда
		ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
	КонецЕсли;
	
	Исполнитель = ЭД.Документ.СвАктИ.Исполнитель;
	Если Исполнитель <> Неопределено Тогда
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
			ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			ПрочитатьДанныеКонтрагента(Исполнитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Исполнитель");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Исполнитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Заказчик");
		КонецЕсли;
	КонецЕсли;
	
	Заказчик = Неопределено;
	Если НЕ ЭД.Документ.СвАктИ.Свойства().Получить("Заказчик") = Неопределено Тогда
		Заказчик = ЭД.Документ.СвАктИ.Заказчик;
	ИначеЕсли ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		Заказчик = ДанныеЗаказчикаИзДопДанных(ДеревоДопДанных);
	КонецЕсли;
	
	Если Заказчик <> Неопределено Тогда
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
			ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			ПрочитатьДанныеКонтрагента(Заказчик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Заказчик");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Заказчик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Исполнитель");
		КонецЕсли;
	КонецЕсли;
		
	Организация = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Организация", ДеревоРазбора);
	Если Организация = Неопределено Тогда // получен Акт из не-1С системы, подставим Организацию по ИД
		УстановитьПривилегированныйРежим(Истина);
		ИдЗаказчика = ЭД.СвУчДокОбор.ИдПок;
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
		               |	ПрофилиНастроекЭДО.Организация
		               |ИЗ
		               |	Справочник.ПрофилиНастроекЭДО КАК ПрофилиНастроекЭДО
		               |ГДЕ
		               |	ПрофилиНастроекЭДО.ИдентификаторОрганизации = &ИдентификаторОрганизации";
		Запрос.УстановитьПараметр("ИдентификаторОрганизации", ИдЗаказчика);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			ОрганизацияПоИД = Выборка.Организация;
		КонецЕсли;
		Если ЗначениеЗаполнено(ОрганизацияПоИД) Тогда
			Организация = ОрганизацияПоИД;
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Организации");
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", Организация.Код);
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдЗаказчика, НСтр("ru = 'ИД организации:'") + " " + ИдЗаказчика,
				Организация, ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Организация", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		УстановитьПривилегированныйРежим(Ложь);
	КонецЕсли;
	Структура = Новый Структура("Организация", Организация);
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
		
		СтрокаВалюты = НовыйЭД.Строки.Найти("ВалютаКод", "Реквизит", Истина);
		Если СтрокаВалюты <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			КодВалюты = СтрокаВалюты.ЗначениеРеквизита;
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты,
				Валюта, ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Организация) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация);
		КонецЕсли;
	КонецЕсли;
	
	ВидОперации = НовыйЭД.Строки.Найти("ВидОперации", "Реквизит", Истина);
	Если ВидОперации <> Неопределено Тогда
		ВидОперации.ЗначениеРеквизита = ПеречислениеИзЗначенияXML(ВидОперации.ЗначениеРеквизита, "ВидыОперацийЭД");
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Документ.СвАктИ.НомАкт);
	ДатаДок = ЭД.Документ.СвАктИ.ДатаАкт;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ДатаИзСтроки(ДатаДок));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Заголовок", ЭД.Документ.СвАктИ.Заголовок);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИдФайл);
	
	Если ЭД.Документ.СвАктИ.Сдал <> Неопределено Тогда
		ДатаДок = ЭД.Документ.СвАктИ.Сдал.ДатаИсполн;
		Если ЗначениеЗаполнено(ДатаДок) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаИсполнения", ДатаИзСтроки(ДатаДок));
		КонецЕсли;
		
		Если ЭД.Документ.СвАктИ.Сдал.ПодписьИсполн <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СдалДолжность", ЭД.Документ.СвАктИ.Сдал.ПодписьИсполн.Должность);
			ФИО = ЭД.Документ.СвАктИ.Сдал.ПодписьИсполн.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СдалФИО", ФамилияИнициалы);
		КонецЕсли;
	КонецЕсли;
	
	НаборДанныхОписанияРабот = ЭД.Документ.СвАктИ.ОписРабот;
	СуммаДокумента = 0;
	Если ТипЗнч(НаборДанныхОписанияРабот) = Тип("СписокXDTO") Тогда
		Сч = 1;
		Для Каждого ЭлементОписания Из НаборДанныхОписанияРабот Цикл
			
			СписокОписаний = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "СписокОписаний");
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СписокОписаний, "НачРабот",  ЭлементОписания.НачРабот);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СписокОписаний, "КонРабот",  ЭлементОписания.КонРабот);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СписокОписаний, "Сумма",     ЭлементОписания.СумБезНДСИт);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СписокОписаний, "СуммаНДС",  ЭлементОписания.СумНДСИт);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СписокОписаний, "СуммаСНДС", ЭлементОписания.СумУчНДСИт);
			
			СуммаДокумента = СуммаДокумента + ?(ЗначениеЗаполнено(ЭлементОписания.СумУчНДСИт), ЭлементОписания.СумУчНДСИт, 0);
			
			// Определяем вариант ЭД для выбора алгоритма заполнения номенклатуры
			АвторЭДПокупатель = Ложь;
			ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
				ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани);
			
			НаборДанных = ЭлементОписания.Работа;
			Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
				Для Каждого Элемент Из НаборДанных Цикл
					НаимТовара = ""; ИдТовара = "";
					ЕстьДопРеквизиты = Ложь;
					
					СписокТЧ = Новый СписокЗначений;
					СписокТЧ.Добавить(Элемент.Номер,      "Номер");
					Если ЗначениеЗаполнено(Элемент.НаимРабот) Тогда
						СписокТЧ.Добавить(Элемент.НаимРабот,  "Наименование");
					Иначе
						СписокТЧ.Добавить(Элемент.Описание,  "Наименование");	
					КонецЕсли;
					СписокТЧ.Добавить(Элемент.Количество, "Количество");
					СписокТЧ.Добавить(Элемент.Цена,       "Цена");
					СписокТЧ.Добавить(Элемент.СумБезНДС,  "Сумма");
					СписокТЧ.Добавить(Элемент.СумНДС,     "СуммаНДС");
					СписокТЧ.Добавить(Элемент.СумУчНДС,   "СуммаСНДС");
					СписокТЧ.Добавить(Элемент.Описание,   "Описание");
					СписокТЧ.Добавить(Элемент.НаимЕдИзм,  "ЕдиницаИзмеренияНаименование");
					СписокТЧ.Добавить(Элемент.ОКЕИ,       "ЕдиницаИзмеренияКод");
					
					// Удалить первую ветку - нужна лишь, чтобы читать старые документы.
					Если ЗначениеЗаполнено(Элемент.ИнфПолСтр) Тогда
						Если СтрНайти(Элемент.ИнфПолСтр, "xml") > 0 Тогда
							// В инф.поле xml-строка неактуального формата.
							ОбъектXML = Новый ЧтениеXML;
							Попытка
								ОбъектXML.УстановитьСтроку(Элемент.ИнфПолСтр);
								УслугаXDTO = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
								СписокТЧ.Добавить(УслугаXDTO["Ид"], "ИД");
							Исключение
								ВидОперации = НСтр("ru = 'Чтение неактуального формата Акт.'");
								ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
								ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
								ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, ТекстСообщения);
							КонецПопытки;
						Иначе
							// В инф.поле xml-строка Актуального формата.
							ИнфПол = Элемент.ИнфПолСтр;
							ПрочитатьИнфПол(ИнфПол, ДеревоДопДанных, "Услуги", Строка(Сч) + "." + Элемент.Номер);
						КонецЕсли;
					КонецЕсли;
					
					ИдТовара = "";
					ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, СписокТЧ, Строка(Сч) + "." + Элемент.Номер, "Услуги", Ошибка);
					
					РеквизитыНоменклатуры = Новый Структура;
					РеквизитыЕдиницыИзмерения = Новый Структура;
					РеквизитыБазовойЕдиницыИзмерения = Новый Структура;
					
					ДокументОснованиеНайден = Ложь;
					
					Для Каждого ЭлементСЗ Из СписокТЧ Цикл
						
						// Номенклатура.
						Если ЭлементСЗ.Представление = "Наименование" Тогда
							РеквизитыНоменклатуры.Вставить("Наименование", ЭлементСЗ.Значение);
						ИначеЕсли ЭлементСЗ.Представление = "БазоваяЕдиницаКод" Тогда
							РеквизитыБазовойЕдиницыИзмерения.Вставить("Код", ЭлементСЗ.Значение);
						ИначеЕсли ЭлементСЗ.Представление = "БазоваяЕдиницаНаименование" Тогда
							РеквизитыБазовойЕдиницыИзмерения.Вставить("Наименование", ЭлементСЗ.Значение);
						ИначеЕсли ЭлементСЗ.Представление = "ЕдиницаИзмеренияКод" Тогда
							РеквизитыЕдиницыИзмерения.Вставить("Код", ЭлементСЗ.Значение);
						ИначеЕсли ЭлементСЗ.Представление = "ОКЕИ_Тов" Тогда
							РеквизитыЕдиницыИзмерения.Вставить("Код", ЭлементСЗ.Значение);
						ИначеЕсли ЭлементСЗ.Представление = "ЕдиницаИзмеренияНаименование" Тогда
							РеквизитыЕдиницыИзмерения.Вставить("Наименование", ЭлементСЗ.Значение);
						ИначеЕсли ЭлементСЗ.Представление = "ИД" Тогда
							ИдТовара = ЭлементСЗ.Значение;
						ИначеЕсли ЭлементСЗ.Представление = "СтавкаНДС" Тогда
							ЭлементСЗ.Значение = ЭлементСЗ.Значение;
						ИначеЕсли ЭлементСЗ.Представление = "ИдентификаторДокументаОснования"
							И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
							И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
							// Актуальный алгоритм передачи связки с документами-основаниями.
							// В качестве идентификатора документа-основания во входящем ЭД приходит
							// идентификатор документа ИБ, в результате даже если ЭД для документа-потомка
							// был сформирован и отправлен раньше, чем ЭД документа-основания, после получения
							// ЭД документа-основания можно перезаполнить документ-потомок и ссылка на основание
							// будет найдена.
							СтруктураОтбора = Новый Структура;
							СтруктураОтбора.Вставить("Организация",   Организация);
							СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
							ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСЗ.Значение, СтруктураОтбора);
							Если ДокументОснование <> Неопределено Тогда
								СписокТЧ.Добавить(ДокументОснование, "ДокументОснование");
								ДокументОснованиеНайден = Истина;
							КонецЕсли;
						ИначеЕсли ЭлементСЗ.Представление = "ИДЭДДокументаОснования"
							И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
							И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
							
							ДокументОснование = ПолучитьДокументОснование(ЭлементСЗ.Значение, Структура);
							Если ДокументОснование <> Неопределено Тогда
								СписокТЧ.Добавить(ДокументОснование, "ДокументОснование");
								ДокументОснованиеНайден = Истина;
							КонецЕсли;
						КонецЕсли;
					КонецЦикла;
					
					НаимРабот = "";
					РеквизитыНоменклатуры.Свойство("Наименование", НаимРабот);
					КодЕдИзм = "";
					Если РеквизитыБазовойЕдиницыИзмерения.Свойство("Код", КодЕдИзм) Тогда
						НаименованиеЕдИзм = "";
						РеквизитыБазовойЕдиницыИзмерения.Свойство("Наименование", НаименованиеЕдИзм);
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(КодЕдИзм),
							РеквизитыБазовойЕдиницыИзмерения);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Строка(КодЕдИзм), НаименованиеЕдИзм,
							ЕдИзм, РеквизитыБазовойЕдиницыИзмерения, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(НайденнаяСтрока) Тогда
							РеквизитыНоменклатуры.Вставить("БазоваяЕдиница", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
					
					КодЕдИзм = "";
					Если РеквизитыЕдиницыИзмерения.Свойство("Код", КодЕдИзм) Тогда
						НаименованиеЕдИзм = "";
						РеквизитыЕдиницыИзмерения.Свойство("Наименование", НаименованиеЕдИзм);
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(КодЕдИзм),
							РеквизитыЕдиницыИзмерения);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока     = НайтиСоздатьСтрокуВДеревеРазбора( НайденныйТипВДереве, Строка(КодЕдИзм),
							НаименованиеЕдИзм, ЕдИзм, РеквизитыЕдиницыИзмерения, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(НайденнаяСтрока) Тогда
							РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
					
					// Идентификация по номенклатуре компании, когда сторона разбора ЭД - сама компания
					Если ИдентификацияПоНоменклатуреКомпании Тогда
						СтруктураИд = РазобратьИДТовара(ИдТовара);
						Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
					Иначе
						// Номенклатура поставщиков.
						РеквизитыНоменклатурыПоставщика = Новый Структура;
						ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
						ВладелецНоменклатуры  = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
						
						РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
						
						Если ЗначениеЗаполнено(НаимРабот) Тогда
							РеквизитыНоменклатурыПоставщика.Вставить("Наименование", НаимРабот);
							
							// Если пришел пустой ИД, используем вместо него наименование товара.
							// Актуально для входящих ЭД из учетных систем отличных от 1С.
							Если Не ЗначениеЗаполнено(ИдТовара) Тогда
								ИдТовара = ИдентификаторТовараПоСтроке(ВРег(СтрЗаменить(НаимРабот, " ", "")) + "###");
							КонецЕсли;
						КонецЕсли;
						
						Если ЗначениеЗаполнено(ИдТовара) Тогда
							
							РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ИдТовара);
							
							НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
							РеквизитыНоменклатурыПоставщика);
							
							НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
							НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимРабот, НоменклатураПоставщика,
							РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
							СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "НоменклатураПоставщика");
							
							Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
								РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
								РеквизитыНоменклатурыПоставщика.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
							КонецЕсли;
							СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
							ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(РеквизитыНоменклатурыПоставщика, СтруктураРеквизитовТовара);
							
							Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
						КонецЕсли;
					КонецЕсли;
					
					Если ЗначениеЗаполнено(Номенклатура) Тогда
						
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимРабот, Номенклатура,
						РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
						
						СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
						
					КонецЕсли;
					
					ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(СписокОписаний, "Работа", СписокТЧ);
					
				КонецЦикла;
			КонецЕсли;
			Сч = Сч + 1;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СписокОписаний", СписокОписаний);
		КонецЦикла;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", СуммаДокумента);
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьАкт501ЗаказчикXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктЗаказчик;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	ИнфПол = ЭД.Документ.СвАктИ.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено Тогда
		ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
	КонецЕсли;
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИдФайл);
	Если ЭД.Документ.СвАктИ.Принял <> Неопределено Тогда
		Если ЭД.Документ.СвАктИ.Принял.ДатаЗаказ <> Неопределено Тогда
			ДатаДок = ЭД.Документ.СвАктИ.Принял.ДатаЗаказ;
			ДатаПолучения = ДатаИзСтроки(ДатаДок);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПолучения", ДатаПолучения);
		КонецЕсли;
		Если ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьНомер", ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.НомДоверен);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьДата", ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ДатаДоверен);
			ДоверенностьВыдана = "";
			Если ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКем <> Неопределено Тогда
				ВспомогательнаяСтруктура = Новый Структура;
				ВспомогательнаяСтруктура.Вставить("Организация", ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКем.НаимОргКем);
				ВспомогательнаяСтруктура.Вставить("Должность", ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКем.ДолжнКем);
				ВспомогательнаяСтруктура.Вставить("ДопСведения", ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКем.ДопСведКем);
				Если ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКем.ФИО <> Неопределено Тогда
					ФИО = ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКем.ФИО;
					ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
					ВспомогательнаяСтруктура.Вставить("ФИО", ФамилияИнициалы);
				КонецЕсли;
				Для Каждого Элемент Из ВспомогательнаяСтруктура Цикл
					Если ЗначениеЗаполнено(Элемент.Значение) Тогда
						ДоверенностьВыдана = ДоверенностьВыдана + ?(ЗначениеЗаполнено(ДоверенностьВыдана), ", ", "") + СокрЛП(Элемент.Значение);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКому <> Неопределено Тогда
				ВспомогательнаяСтруктура = Новый Структура;
				ВспомогательнаяСтруктура.Вставить("Должность", ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКому.Должн);
				ВспомогательнаяСтруктура.Вставить("ДопСведения", ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКому.ДопСведКому);
				Если ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКому.ФИО <> Неопределено Тогда
					ФИО = ЭД.Документ.СвАктИ.Принял.ДоверенЗаказ.ВыданаКому.ФИО;
					ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
					ВспомогательнаяСтруктура.Вставить("ФИО", ФамилияИнициалы);
				КонецЕсли;
				Для Каждого Элемент Из ВспомогательнаяСтруктура Цикл
					Если ЗначениеЗаполнено(Элемент.Значение) Тогда
						ДоверенностьВыдана = ДоверенностьВыдана + ?(ЗначениеЗаполнено(ДоверенностьВыдана), ", ", "") + СокрЛП(Элемент.Значение);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьВыдана", ДоверенностьВыдана);
		ИначеЕсли ЭД.Документ.СвАктИ.Принял.ПодписьЗаказ <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПринялДолжность", ЭД.Документ.СвАктИ.Принял.ПодписьЗаказ.Должность);
			ФИО = ЭД.Документ.СвАктИ.Принял.ПодписьЗаказ.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПринялФИО", ФамилияИнициалы);
		КонецЕсли;
		Если ЭД.Документ.СвАктИ.Принял.Претенз <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Претензии", ЭД.Документ.СвАктИ.Принял.Претенз);
		КонецЕсли;
	КонецЕсли;
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьТОРГ12XDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Документ.СвТНО.ТН.НомТН);
	ДатаДок = ЭД.Документ.СвТНО.ТН.ДатаТН;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ДатаИзСтроки(ДатаДок));
	
	СуммаДокумента = 0;
	Если ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл <> Неопределено
		И ЗначениеЗаполнено(ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумУчНДСВс) Тогда
		
		СуммаДокумента = ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумУчНДСВс;
	ИначеЕсли ЭД.Документ.СвТНО.ОтпускГруз <> Неопределено
		И ЗначениеЗаполнено(ЭД.Документ.СвТНО.ОтпускГруз.СумОтпуск) Тогда
		
		СуммаДокумента = ЭД.Документ.СвТНО.ОтпускГруз.СумОтпуск;
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", СуммаДокумента);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИДФайл);
	
	Грузоотправитель = Неопределено;
	ДопПараметрыГрузоотправителя = Новый Структура;
	Поставщик = ЭД.Документ.СвТНО.Поставщик;
	Если ЭД.Документ.СвТНО.ГрузОт <> Неопределено И ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр <> Неопределено Тогда
		ДопПараметрыГрузоотправителя.Вставить("СтруктурноеПодразделение", ЭД.Документ.СвТНО.ГрузОт.СтруктПодр);
		ДопПараметрыГрузоотправителя.Вставить("ОКДП", ЭД.Документ.СвТНО.ГрузОт.ОКДП);
		Грузоотправитель = ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр;
		Если Не ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт = Неопределено Тогда
			Если НЕ ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Тлф = Неопределено Тогда
				ДопПараметрыГрузоотправителя.Вставить("Телефоны", ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Тлф);
			КонецЕсли;
			Если НЕ ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Факс = Неопределено Тогда
				ДопПараметрыГрузоотправителя.Вставить("Факс", ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Факс);
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли Поставщик <> Неопределено Тогда
		Грузоотправитель = Поставщик;
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.ОтпускГруз <> Неопределено Тогда
		Если ЭД.Документ.СвТНО.ОтпускГруз.ОтпускРазреш <> Неопределено Тогда
			ДопПараметрыГрузоотправителя.Вставить("ДолжностьРуководителя", ЭД.Документ.СвТНО.ОтпускГруз.ОтпускРазреш.Должность);
			ФИО = ЭД.Документ.СвТНО.ОтпускГруз.ОтпускРазреш.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ДопПараметрыГрузоотправителя.Вставить("ФИОРуководителя", ФамилияИнициалы);
		КонецЕсли;
		Если ЭД.Документ.СвТНО.ОтпускГруз.Бухгалтер <> Неопределено Тогда
			ДопПараметрыГрузоотправителя.Вставить("ДолжностьГлавБухгалтера", ЭД.Документ.СвТНО.ОтпускГруз.Бухгалтер.Должность);
			ФИО = ЭД.Документ.СвТНО.ОтпускГруз.Бухгалтер.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ДопПараметрыГрузоотправителя.Вставить("ФИОГлавБухгалтера", ФамилияИнициалы);
		КонецЕсли;
		Если ЭД.Документ.СвТНО.ОтпускГруз.ОтпускПроизв <> Неопределено Тогда
			ДопПараметрыГрузоотправителя.Вставить("ДолжностьКладовщика", ЭД.Документ.СвТНО.ОтпускГруз.ОтпускПроизв.Должность);
			ФИО = ЭД.Документ.СвТНО.ОтпускГруз.ОтпускПроизв.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ДопПараметрыГрузоотправителя.Вставить("ФИОКладовщика", ФамилияИнициалы);
		КонецЕсли;
	КонецЕсли;
	
	Если Грузоотправитель <> Неопределено Тогда
		ПрочитатьДанныеКонтрагента(Грузоотправитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Грузоотправитель");
		Если ДопПараметрыГрузоотправителя.Количество() > 0 Тогда
			ИндексУзла = ДеревоРазбора.Строки.Найти("Грузоотправитель", "Реквизит", Истина);
			Если ИндексУзла <> Неопределено И ЗначениеЗаполнено(ИндексУзла.ЗначениеРеквизита) Тогда
				СтрокаГрузоотправителя = ДеревоРазбора.Строки.Найти(ИндексУзла.ЗначениеРеквизита, "ИндексСтроки", Истина);
				Если СтрокаГрузоотправителя <> Неопределено Тогда
					Для Каждого ДопПараметр Из ДопПараметрыГрузоотправителя Цикл
						ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СтрокаГрузоотправителя, ДопПараметр.Ключ, ДопПараметр.Значение);
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.ГрузПолуч <> Неопределено Тогда
		ПрочитатьДанныеКонтрагента(ЭД.Документ.СвТНО.ГрузПолуч, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Грузополучатель");
	КонецЕсли;
	
	// Грузоотправитель и Поставщик - необязательные элементы xsd-схемы,
	// но один из этих элементов обязательно должен быть заполнен
	// (Согласно подп. "в" п.2 ст. 9 Федерального закона от 21.11.1996 №129-ФЗ).
	Если Поставщик = Неопределено Тогда
		Поставщик = Грузоотправитель;
	КонецЕсли;
	
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий 
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	КонецЕсли;
	
	Плательщик = ЭД.Документ.СвТНО.Плательщик;
	Если Плательщик <> Неопределено Тогда
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
			ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			ПрочитатьДанныеКонтрагента(Плательщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Плательщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		КонецЕсли;
	КонецЕсли;
	
	Организация = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Организация", ДеревоРазбора);
	Структура = Новый Структура("Организация", Организация);
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	ИнфПол = ЭД.Документ.СвТНО.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено И СтрНайти(ИнфПол.ТекстИнф, "xml") = 0 Тогда
		ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
	КонецЕсли;
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
		
		СтрокаВалюты = НовыйЭД.Строки.Найти("ВалютаКод", "Реквизит", Истина);
		Если СтрокаВалюты <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			КодВалюты = СтрокаВалюты.ЗначениеРеквизита;
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты,
				Валюта, ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Организация) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация);
		КонецЕсли;
	КонецЕсли;
	
	ВидОперации = НовыйЭД.Строки.Найти("ВидОперации", "Реквизит", Истина);
	Если ВидОперации <> Неопределено Тогда
		ВидОперации.ЗначениеРеквизита = ПеречислениеИзЗначенияXML(ВидОперации.ЗначениеРеквизита, "ВидыОперацийЭД");
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.Основание <> Неопределено Тогда
		ДатаПоДаннымКлиента = ЭД.Документ.СвТНО.Основание.ДатаОсн;
		Если ЗначениеЗаполнено(ДатаПоДаннымКлиента) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПоДаннымКлиента", Дата(Сред(ДатаПоДаннымКлиента, 7, 4)
				+ Сред(ДатаПоДаннымКлиента, 4, 2) + Сред(ДатаПоДаннымКлиента, 1, 2)));
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерПоДаннымКлиента", ЭД.Документ.СвТНО.Основание.НомОсн);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеОснования", ЭД.Документ.СвТНО.Основание.НаимОсн);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКУД", ЭД.Документ.СвТНО.ОКУДПервДок);
	
	Если ЭД.Документ.СвТНО.ТН.ТНОбщ <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЗаписей", ЭД.Документ.СвТНО.ТН.ТНОбщ.КолНомЗап);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЗаписейПрописью", ЭД.Документ.СвТНО.ТН.ТНОбщ.КолНомЗапПр);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоМест", ЭД.Документ.СвТНО.ТН.ТНОбщ.ВсМест);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоМестПрописью", ЭД.Документ.СвТНО.ТН.ТНОбщ.ВсМестПр);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "МассаГрузаПрописью", ЭД.Документ.СвТНО.ТН.ТНОбщ.БруттоПр);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "МассаГрузаНеттоПрописью", ЭД.Документ.СвТНО.ТН.ТНОбщ.НеттоПр);
	КонецЕсли;
	Если ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумБезНДСВс);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаНДС", ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумНДСВс);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаСУчетомНДС", ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумУчНДСВс);
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.ОтпускГруз <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаВсегоПрописью", ЭД.Документ.СвТНО.ОтпускГруз.СумОтпускПр);
		ДатаДок = ЭД.Документ.СвТНО.ОтпускГруз.ДатаОтпуск;
		Если ЗначениеЗаполнено(ДатаДок) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОтпуска", ДатаИзСтроки(ДатаДок));
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЛистовВПрилПрописью", ЭД.Документ.СвТНО.ОтпускГруз.КолПрилПр);
	КонецЕсли;
	
	НаборДанных = ЭД.Документ.СвТНО.ТН.Таблица.СвТов;
	
	// Определяем вариант ЭД для выбора алгоритма заполнения номенклатуры
	АвторЭДПокупатель = Ложь;
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани);
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
			
		ИдентификаторыСтрокСерии = ИдентификаторыСерийНоменклатуры();

		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			НаимТовара = "";
			ИдТовара = "";
			ЕстьДопРеквизиты = Ложь;
			
			СписокТЧ.Добавить(Элемент.НомТов,      "Номер");
			СписокТЧ.Добавить(Элемент.НаимТов,     "Наименование");
			СписокТЧ.Добавить(Элемент.ХарактерТов, "НаименованиеХарактеристики");
			СписокТЧ.Добавить(Элемент.СортТов,     "Сорт");
			СписокТЧ.Добавить(Элемент.АртикулТов,  "Артикул");
			СписокТЧ.Добавить(Элемент.НаимЕдИзм,   "ЕдиницаИзмеренияНаименование");
			СписокТЧ.Добавить(Элемент.ОКЕИ_Тов,    "ЕдиницаИзмеренияКод");
			СписокТЧ.Добавить(Элемент.КодТов,      "ТоварКод");
	
			СписокТЧ.Добавить(Элемент.Нетто,     "Количество");
			СписокТЧ.Добавить(Элемент.КолМест,   "Мест");
			СписокТЧ.Добавить(Элемент.ВидУпак,   "Упаковка");
			СписокТЧ.Добавить(Элемент.Место,     "КоличествоВОдномМесте");
			СписокТЧ.Добавить(Элемент.Нетто,     "МассаНетто");
			СписокТЧ.Добавить(Элемент.Брутто,    "МассаБрутто");
			СписокТЧ.Добавить(Элемент.Цена,      "Цена");
			СписокТЧ.Добавить(Элемент.СумБезНДС, "Сумма");
			СписокТЧ.Добавить(Элемент.СумНДС,    "СуммаНДС");
			СписокТЧ.Добавить(Элемент.СумУчНДС,  "СуммаСНДС");
			
			// Удалить первую ветку - нужна лишь, чтобы читать старые документы.
			Если ЗначениеЗаполнено(Элемент.ИнфПолСтр) И СтрНайти(Элемент.ИнфПолСтр, "xml") > 0 Тогда
				
				СписокТЧ.Добавить(Элемент.СтавкаНДС, "СтавкаНДС");
				
				// В инф.поле xml-строка неактуального формата.
				ОбъектXML = Новый ЧтениеXML;
				Попытка
					ОбъектXML.УстановитьСтроку(Элемент.ИнфПолСтр);
					ТоварXDTO = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
					РазобратьСтрокуТЧCML(ТоварXDTO, СписокТЧ, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Элемент.НомТов);
				Исключение
					ВидОперации = НСтр("ru = 'Чтение неактуального формата ТОРГ-12.'");
					ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
					ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
					ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, ТекстСообщения);
				КонецПопытки;
			Иначе
				Если ЗначениеЗаполнено(Элемент.ИнфПолСтр) Тогда
					// В инф.поле xml-строка Актуального формата.
					ИнфПол = Элемент.ИнфПолСтр;
					ПрочитатьИнфПол(ИнфПол, ДеревоДопДанных, "Товары", Элемент.НомТов);
					ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, СписокТЧ, Элемент.НомТов, "Товары", Ошибка);
				КонецЕсли;
				РеквизитыНоменклатуры = Новый Структура;
				РеквизитыЕдиницыИзмерения = Новый Структура;
				ИдТовара = "";
				СтавкаНДСПереданаДопПараметром = Ложь;
				ДокументОснованиеНайден = Ложь;
				Для Каждого ЭлементСЗ Из СписокТЧ Цикл
					
					// Номенклатура.
					Если ЭлементСЗ.Представление = "Наименование" Тогда
						РеквизитыНоменклатуры.Вставить("Наименование", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "НаименованиеХарактеристики" Тогда
						РеквизитыНоменклатуры.Вставить("НаименованиеХарактеристики", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "Артикул" Тогда
						РеквизитыНоменклатуры.Вставить("Артикул", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "ТоварКод" Тогда
						РеквизитыНоменклатуры.Вставить("ТоварКод", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "Сорт" Тогда
						РеквизитыНоменклатуры.Вставить("Сорт", ЭлементСЗ.Значение);
						
					ИначеЕсли ЭлементСЗ.Представление = "ЕдиницаИзмеренияКод" Тогда
						РеквизитыЕдиницыИзмерения.Вставить("Код", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "ОКЕИ_Тов" Тогда
						РеквизитыЕдиницыИзмерения.Вставить("Код", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "ЕдиницаИзмеренияНаименование" Тогда
						РеквизитыЕдиницыИзмерения.Вставить("Наименование", ЭлементСЗ.Значение);
						
					ИначеЕсли ЭлементСЗ.Представление = "ИД" Тогда
						ИдТовара = ЭлементСЗ.Значение;
					ИначеЕсли ЭлементСЗ.Представление = "СтавкаНДС" Тогда
						ЭлементСЗ.Значение = ЭлементСЗ.Значение;
						СтавкаНДСПереданаДопПараметром = Истина;
					ИначеЕсли ЭлементСЗ.Представление = "ИдентификаторДокументаОснования"
						И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
						И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
						// Актуальный алгоритм передачи связки с документами-основаниями.
						// В качестве идентификатора документа-основания во входящем ЭД приходит
						// идентификатор документа ИБ, в результате даже если ЭД для документа-потомка
						// был сформирован и отправлен раньше, чем ЭД документа-основания, после получения
						// ЭД документа-основания можно перезаполнить документ-потомок и ссылка на основание
						// будет найдена.
						СтруктураОтбора = Новый Структура;
						СтруктураОтбора.Вставить("Организация",   Организация);
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
						ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСЗ.Значение, СтруктураОтбора);
						Если ДокументОснование <> Неопределено Тогда
							СписокТЧ.Добавить(ДокументОснование, "ДокументОснование");
							ДокументОснованиеНайден = Истина;
						КонецЕсли;
					ИначеЕсли ЭлементСЗ.Представление = "ИДЭДДокументаОснования"
						И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
						И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
						
						ДокументОснование = ПолучитьДокументОснование(ЭлементСЗ.Значение, Структура);
						Если ДокументОснование <> Неопределено Тогда
							СписокТЧ.Добавить(ДокументОснование, "ДокументОснование");
							ДокументОснованиеНайден = Истина;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
				// Ставка НДС может прийти в доп. параметрах.
				Если НЕ СтавкаНДСПереданаДопПараметром Тогда
					СписокТЧ.Добавить(Элемент.СтавкаНДС, "СтавкаНДС");
				КонецЕсли;
				
				КодЕдИзм = "";
				Если РеквизитыЕдиницыИзмерения.Свойство("Код", КодЕдИзм) Тогда
					НаименованиеЕдИзм = "";
					РеквизитыЕдиницыИзмерения.Свойство("Наименование", НаименованиеЕдИзм);
					ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(КодЕдИзм),
						РеквизитыЕдиницыИзмерения);
					НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
					НайденнаяСтрока     = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Строка(КодЕдИзм),
						НаименованиеЕдИзм, ЕдИзм, РеквизитыЕдиницыИзмерения, ДеревоРазбора, Ошибка);
					Если ЗначениеЗаполнено(НайденнаяСтрока) Тогда
						РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
					КонецЕсли;
				КонецЕсли;
				
				// Идентификация по номенклатуре компании, когда сторона разбора ЭД - сама компания
				Если ИдентификацияПоНоменклатуреКомпании Тогда
					СтруктураИд = РазобратьИДТовара(ИдТовара);
					Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
					Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
						ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры",
							СтруктураИд.ИДХарактеристики);
						Если СписокТЧ.НайтиПоЗначению(ХарактеристикаНоменклатуры) <> Неопределено Тогда
							СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
						КонецЕсли;
					КонецЕсли;
					Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
						УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры",
							СтруктураИд.ИДУпаковки);
						Если СписокТЧ.НайтиПоЗначению(УпаковкаНоменклатуры) <> Неопределено Тогда
							СписокТЧ.Добавить(УпаковкаНоменклатуры, "Упаковка");
						КонецЕсли;
					КонецЕсли;
				Иначе
					// Номенклатура поставщиков.
					РеквизитыНоменклатурыПоставщика = Новый Структура;
					
					ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
					ВладелецНоменклатуры  = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
					РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
					
					НаименованиеИД = ""; ТоварКодИД = ""; АртикулИД = ""; НаименованиеХарактеристикиИД = "";
					Если РеквизитыНоменклатуры.Свойство("Наименование") Тогда
						РеквизитыНоменклатурыПоставщика.Вставить("Наименование", РеквизитыНоменклатуры.Наименование);
						НаименованиеИД = ВРег(СтрЗаменить(РеквизитыНоменклатуры.Наименование, " ", ""));
					КонецЕсли;
					Если РеквизитыНоменклатуры.Свойство("ТоварКод") Тогда
						РеквизитыНоменклатурыПоставщика.Вставить("ТоварКод", РеквизитыНоменклатуры.ТоварКод);
						ТоварКодИД = ВРег(СтрЗаменить(РеквизитыНоменклатуры.ТоварКод, " ", ""));
					КонецЕсли;
					Если РеквизитыНоменклатуры.Свойство("Артикул") Тогда
						РеквизитыНоменклатурыПоставщика.Вставить("Артикул", РеквизитыНоменклатуры.Артикул);
						АртикулИД = ВРег(СтрЗаменить(РеквизитыНоменклатуры.Артикул, " ", ""));
					КонецЕсли;
					Если РеквизитыНоменклатуры.Свойство("НаименованиеХарактеристики") Тогда
						РеквизитыНоменклатурыПоставщика.Вставить("НаименованиеХарактеристики",
							РеквизитыНоменклатуры.НаименованиеХарактеристики);
						НаименованиеХарактеристикиИД = ВРег(СтрЗаменить(РеквизитыНоменклатуры.НаименованиеХарактеристики, " ", ""));
					КонецЕсли;
					
					// Если пришел пустой ИД, используем вместо него наименование товара.
					// Актуально для входящих ЭД из учетных систем отличных от 1С.
					Если Не ЗначениеЗаполнено(ИдТовара) Тогда
						ИдТовара = ИдентификаторТовараПоСтроке(НаименованиеИД + "#" + НаименованиеХарактеристикиИД + "#" + ТоварКодИД + "#" +АртикулИД);
					КонецЕсли;
					
					РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ИдТовара);
					НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
						РеквизитыНоменклатурыПоставщика);
					
					НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
					НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, НоменклатураПоставщика,
						РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
					СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки,"НоменклатураПоставщика");
					
					Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
						РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
						РеквизитыНоменклатурыПоставщика.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
					КонецЕсли;
					СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
					ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(РеквизитыНоменклатурыПоставщика, СтруктураРеквизитовТовара);
					
					Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
					ХарактеристикаНоменклатуры = СтруктураРеквизитовТовара.Характеристика;
					Если ЗначениеЗаполнено(ХарактеристикаНоменклатуры) Тогда
						СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
					КонецЕсли;
					Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Упаковка) Тогда
						СписокТЧ.Добавить(СтруктураРеквизитовТовара.Упаковка, "Упаковка");
					КонецЕсли;
				КонецЕсли;
				
				НоваяСтрока = ИдентификаторыСтрокСерии.Добавить();
				НоваяСтрока.Идентификатор = ИдТовара;
				НоваяСтрока.Номенклатура = Номенклатура;
				НоваяСтрока.Характеристика = ХарактеристикаНоменклатуры;
				
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
					РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
				СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
		КонецЦикла;
	КонецЕсли;
	
	ПрочитатьСерииНоменклатуры(НовыйЭД, ИдентификаторыСтрокСерии);
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьТОРГ12ПокупательXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	ИнфПол = ЭД.Документ.СвТНП.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено Тогда
		ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
	КонецЕсли;
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИдФайл);
	Если ЭД.Документ.СвТНП.ПолучилГруз <> Неопределено Тогда
		ДатаДок = ЭД.Документ.СвТНП.ПолучилГруз.ДатаПолуч;
		ДатаПолучения = ДатаИзСтроки(ДатаДок);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПолучения", ДатаПолучения);
		Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьНомер", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.НомДоверен);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьДата", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ДатаДоверен);
			ДоверенностьВыдана = "";
			Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем <> Неопределено Тогда
				ВспомогательнаяСтруктура = Новый Структура;
				ВспомогательнаяСтруктура.Вставить("Организация", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.НаимОргКем);
				ВспомогательнаяСтруктура.Вставить("Должность", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ДолжнКем);
				ВспомогательнаяСтруктура.Вставить("ДопСведения", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ДопСведКем);
				Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ФИО <> Неопределено Тогда
					ФИО = ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ФИО;
					ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
					ВспомогательнаяСтруктура.Вставить("ФИО", ФамилияИнициалы);
				КонецЕсли;
				Для Каждого Элемент Из ВспомогательнаяСтруктура Цикл
					Если ЗначениеЗаполнено(Элемент.Значение) Тогда
						ДоверенностьВыдана = ДоверенностьВыдана + ?(ЗначениеЗаполнено(ДоверенностьВыдана), ", ", "") + СокрЛП(Элемент.Значение);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому <> Неопределено Тогда
				ВспомогательнаяСтруктура = Новый Структура;
				ВспомогательнаяСтруктура.Вставить("Должность", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.Должн);
				ВспомогательнаяСтруктура.Вставить("ДопСведения", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.ДопСведКому);
				Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.ФИО <> Неопределено Тогда
					ФИО = ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.ФИО;
					ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
					ВспомогательнаяСтруктура.Вставить("ФИО", ФамилияИнициалы);
				КонецЕсли;
				Для Каждого Элемент Из ВспомогательнаяСтруктура Цикл
					Если ЗначениеЗаполнено(Элемент.Значение) Тогда
						ДоверенностьВыдана = ДоверенностьВыдана + ?(ЗначениеЗаполнено(ДоверенностьВыдана), ", ", "") + СокрЛП(Элемент.Значение);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьВыдана", ДоверенностьВыдана);
		КонецЕсли;
		Если ЭД.Документ.СвТНП.ПолучилГруз.ГрузПринял <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПринялДолжность", ЭД.Документ.СвТНП.ПолучилГруз.ГрузПринял.Должность);
			ФИО = ЭД.Документ.СвТНП.ПолучилГруз.ГрузПринял.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПринялФИО", ФамилияИнициалы);
		КонецЕсли;
		Если ЭД.Документ.СвТНП.ПолучилГруз.ГрузПолучил <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилДолжность", ЭД.Документ.СвТНП.ПолучилГруз.ГрузПолучил.Должность);
			ФИО = ЭД.Документ.СвТНП.ПолучилГруз.ГрузПолучил.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилФИО", ФамилияИнициалы);
		КонецЕсли;
	КонецЕсли;
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Процедура УдалитьПрочитатьНакладнуюXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена
	НовыйЭД.ИД = ЭД.Ид;
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Номер);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.Дата);
	
	// Валюта, курс
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		ВалютаXDTO = ЭД.Получить(СвойствоЭД);
		Если ВалютаXDTO <> Неопределено Тогда
			КодВалюты = ВалютаXDTO.КодОКВ;
			Если КодВалюты <> Неопределено Тогда
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
				
				ДопРеквизиты = Новый Структура;
				ДопРеквизиты.Вставить("Код", КодВалюты);
				ДопРеквизиты.Вставить("Наименование", ВалютаXDTO.НаименованиеСокращенноеОКВ);
				ДопРеквизиты.Вставить("НаименованиеПолное", ВалютаXDTO.НаименованиеПолноеОКВ);
				ДопРеквизиты.Вставить("КодМКВ", ВалютаXDTO.КодМКВ);
				
				Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
			КонецЕсли;
			
			Курс = ВалютаXDTO.Курс;
			Если Курс <> Неопределено Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("СуммаВсего");
	Если СвойствоЭД <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", ЭД.Получить(СвойствоЭД));
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Грузоотправитель");
	Если СвойствоЭД <> Неопределено Тогда
		Грузоотправитель = ЭД.Получить(СвойствоЭД);
		ПрочитатьДанныеКонтрагента(Грузоотправитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Грузоотправитель");
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Грузополучатель");
	Если СвойствоЭД <> Неопределено Тогда
		Грузополучатель = ЭД.Получить(СвойствоЭД);
		ПрочитатьДанныеКонтрагента(Грузополучатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Грузополучатель");
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Поставщик");
	Если СвойствоЭД <> Неопределено Тогда
		Поставщик = ЭД.Получить(СвойствоЭД);
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий 
			ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Плательщик");
	Если СвойствоЭД <> Неопределено Тогда
		Плательщик = ЭД.Получить(СвойствоЭД);
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
			ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			ПрочитатьДанныеКонтрагента(Плательщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Плательщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Основание");
	Если СвойствоЭД<>Неопределено Тогда
		Основание = ЭД.Получить(СвойствоЭД);
		Если НЕ Основание=Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПоДаннымКлиента", Основание.ДатаДокументаОснования);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерПоДаннымКлиента", Основание.НомерДокументаОснования);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеОснования", Основание.НаименованиеДокументаОснования);
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ОКУД");
	Если СвойствоЭД<>Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКУД", ЭД.Получить(СвойствоЭД));
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогоПоДокументу");
	Если СвойствоЭД <> Неопределено Тогда
		ИтогоПоДокументуXDTO = ЭД.Получить(СвойствоЭД);
		КоличествоЗаписей = ИтогоПоДокументуXDTO.Свойства().Получить("КоличествоЗаписей");
		Если КоличествоЗаписей<>Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЗаписей", ИтогоПоДокументуXDTO.Получить(КоличествоЗаписей));
		КонецЕсли;
		КоличествоМест = ИтогоПоДокументуXDTO.Свойства().Получить("КоличествоМест");
		Если КоличествоМест <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоМест", ИтогоПоДокументуXDTO.Получить(КоличествоМест));
		КонецЕсли;
		СуммаБезНДС = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаБезНДС");
		Если СуммаБезНДС <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ИтогоПоДокументуXDTO.Получить(СуммаБезНДС));
		КонецЕсли;
		СуммаНДС = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаНДС");
		Если СуммаНДС <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаНДС", ИтогоПоДокументуXDTO.Получить(СуммаНДС));
		КонецЕсли;
		СуммаСУчетомНДС = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаСУчетомНДС");
		Если СуммаСУчетомНДС <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаСНДС", ИтогоПоДокументуXDTO.Получить(СуммаСУчетомНДС));
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогиПрописью");
	Если СвойствоЭД <> Неопределено Тогда
		ИтогиПрописьюXDTO = ЭД.Получить(СвойствоЭД);
		КоличествоЗаписейПрописью = ИтогоПоДокументуXDTO.Свойства().Получить("КоличествоЗаписейПрописью");
		Если КоличествоЗаписейПрописью<>Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЗаписейПрописью", ИтогоПоДокументуXDTO.Получить(
				КоличествоЗаписейПрописью));
		КонецЕсли;
		КоличествоМестПрописью = ИтогоПоДокументуXDTO.Свойства().Получить("КоличествоМестПрописью");
		Если КоличествоМестПрописью<>Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоМестПрописью", ИтогоПоДокументуXDTO.Получить(КоличествоМестПрописью));
		КонецЕсли;
		СуммаВсегоПрописью = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаВсегоПрописью");
		Если СуммаВсегоПрописью<>Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаВсегоПрописью", ИтогоПоДокументуXDTO.Получить(СуммаВсегоПрописью));
		КонецЕсли;
	КонецЕсли;
	
	НаборДанных = ЭД["Товары"].Товар;
	ПрочитатьДанныеПоТЧНакладной(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
КонецПроцедуры

Процедура ПрочитатьКаталогXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ИД    = ЗначениеСвойстваXDTO(ЭД, "Каталог.Ид");
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.КаталогТоваров;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Каталог.Ид"));
	
	// Заполняем данные о владельце каталога.
	// Контрагент.
	Элемент = ЗначениеСвойстваXDTO(ЭД, "Каталог.Владелец");
	Если Элемент <> Неопределено Тогда
		
		РеквизитыКонтрагента = Новый Структура;
		
		Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
			
			ЗнДанных = Элемент[ТекСвойство.Имя];
			
			Если ЗнДанных = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда 
				
				ИдКонтрагента = ЗнДанных;
				
				// Разберем ИД на ИНН и КПП
				СтруктураПоиска = РазобратьИДКонтрагента(ИдКонтрагента);
				
				Если СтруктураПоиска.Свойство("ИНН") Тогда
					РеквизитыКонтрагента.Вставить("ИНН", СтруктураПоиска.ИНН);
				КонецЕсли;
				Если СтруктураПоиска.Свойство("КПП") Тогда
					РеквизитыКонтрагента.Вставить("КПП", СтруктураПоиска.КПП);
				КонецЕсли;
				
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЮрЛицо") ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ФизЛицо") Тогда
				
				РеквизитыУчастника = ЗнДанных;
				Для Каждого СвойствоУчастника Из РеквизитыУчастника.Свойства() Цикл
					
					РеквизитУчастника = РеквизитыУчастника[СвойствоУчастника.Имя];
					
					Если РеквизитУчастника <> Неопределено Тогда
						Если ВРег(СвойствоУчастника.Имя) = ВРег("ЮридическийАдрес")
							ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("АдресРегистрации") Тогда
							
							РеквизитыКонтрагента.Вставить(СвойствоУчастника.Имя + "_Представление", ЗначениеСвойстваXDTO(РеквизитУчастника, "Представление", "Строка"));
						ИначеЕсли ВРег(СвойствоУчастника.Имя) = ВРег("ОфициальноеНаименование")
							ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("ПолноеНаименование") Тогда
							
							РеквизитыКонтрагента.Вставить("ПолноеНаименование", РеквизитУчастника);
						Иначе
							РеквизитыКонтрагента.Вставить(СвойствоУчастника.Имя, РеквизитУчастника);
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			Иначе
				РеквизитыКонтрагента.Вставить(ТекСвойство.Имя, ЗнДанных);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Контрагенты");
	
	РеквизитыПоиска = Новый Структура;
	РеквизитыПоиска.Вставить("ИНН", РеквизитыКонтрагента.ИНН);
	РеквизитыПоиска.Вставить("КПП", РеквизитыКонтрагента.КПП);
	Контрагент = ЭлектронноеВзаимодействие.НайтиСсылку("Контрагенты", ИдКонтрагента, РеквизитыПоиска);
	
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдКонтрагента, "ИНН+КПП: " + ИдКонтрагента,
		Контрагент, РеквизитыКонтрагента, ДеревоРазбора, Ошибка);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Контрагент", НайденнаяСтрока.ИндексСтроки);
	
	ДатаФормирования = ЗначениеСвойстваXDTO(ЭД, "ДатаФормирования");
	Если ДатаФормирования <> Неопределено Тогда
		ДатаФормирования = XMLЗначение(Тип("Дата"), ДатаФормирования);
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаФормирования", ДатаФормирования);
	
	Если ОбменСКонтрагентамиПовтИсп.ИспользуетсяДополнительнаяАналитикаКонтрагентовСправочникПартнеры() Тогда
		РеквизитыПартнера = Новый Структура();
		РеквизитыПартнера.Вставить("Контрагент", Контрагент);
		ИмяПрикладногоСправочника = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ИмяПрикладногоСправочника("Партнеры");
		ЗнДопАналитики = ЭлектронноеВзаимодействие.НайтиСсылку(ИмяПрикладногоСправочника, , РеквизитыПартнера);
		
		Если ЗначениеЗаполнено(ЗнДопАналитики) Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Партнеры");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДопАналитики.Код, "Код: "
				+ ЗнДопАналитики.Код, ЗнДопАналитики, РеквизитыПартнера, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Партнер", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
	КонецЕсли;
	
	// Заполняем данные о товарах каталога.
	НаборДанных = ЗначениеСвойстваXDTO(ЭД, "Каталог.Товары.Товар",, Истина);
	ПрочитатьДанныеТЧКаталогТоваров(НаборДанных, ЗначениеСвойстваXDTO(ЭД, "Каталог"), ДеревоРазбора, НовыйЭД, Ошибка);
	
	ПоместитьНеПодписанныеДанныеВШапку(НовыйЭД);
	
КонецПроцедуры

Процедура ПрочитатьПрайсXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ИД = ЗначениеСвойстваXDTO(ЭД, "Ид");
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ПрайсЛист;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата",
		ЗначениеСвойстваXDTO(ЭД, "ДействительноС", "Дата"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДействительноПо",
		ЗначениеСвойстваXDTO(ЭД, "ДействительноДо", "Дата"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", НовыйЭД.ИД);
	
	// Контрагент
	Владелец = ЗначениеСвойстваXDTO(ЭД, "Владелец");
	РеквизитыКонтрагента = Новый Структура;
	Роль = "Покупатель";
	
	ПрочитатьДанныеКонтрагентаCML(Владелец, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Роль, РеквизитыКонтрагента);

	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаФормирования",
		ЗначениеСвойстваXDTO(ЭД, "ДействительноС", "Дата"));
	
	// Товары
	НомерСтроки = 0;
	
	Предложения = ЗначениеСвойстваXDTO(ЭД, "Предложения.Предложение",, Истина);
	Для Каждого Элемент Из Предложения Цикл
		
		СписокТЧ = Новый СписокЗначений;
		
		НаименованиеТовара = "";
		ИдТовара           = "";
		АртикулТовара      = "";
		
		// Номенклатура.
		РеквизитыНоменклатуры           = Новый Структура;
		РеквизитыНоменклатурыПоставщика = Новый Структура;
		
		ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
		ВладелецНоменклатуры  = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
		РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
		
		// Читаем доп данные строки т.ч.
		Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
		ДопПараметры = Новый Структура;
		ДопПараметры.Вставить("Организация", Организация);
		
		НомерСтроки = НомерСтроки + 1;
		ПрочитатьДопДанныеСтрокиТЧ(Элемент, НовыйЭД, "Товары", НомерСтроки, СписокТЧ, ДопПараметры);
		
		Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
			
			ЗнДанных = Элемент[ТекСвойство.Имя];
			
			Если ЗнДанных = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			// Разберем свойства Товара.
			Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
				
				РеквизитыНоменклатуры.Вставить("Ид", ЗнДанных);
				РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ЗнДанных);
				ИдТовара = ЗнДанных;
				
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
				
				РеквизитыНоменклатуры.Вставить("Наименование", ЗнДанных);
				РеквизитыНоменклатурыПоставщика.Вставить("Наименование", ЗнДанных);
				
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
				
				РеквизитыНоменклатуры.Вставить("Артикул", ЗнДанных);
				РеквизитыНоменклатурыПоставщика.Вставить("Артикул", ЗнДанных);
				
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
				Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
					
					РеквизитыЕдИзм = Новый Структура;
					РеквизитыЕдИзм.Вставить("Код", ЗначениеСвойстваXDTO(ЗнДанных, "Код"));
					
					ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", РеквизитыЕдИзм.Код, РеквизитыЕдИзм);
					РеквизитыЕдИзм.Вставить("Наименование", ЗначениеСвойстваXDTO(ЗнДанных, "НаименованиеКраткое"));
					
					НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
					НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных.Код, ЗнДанных.НаименованиеКраткое, ЕдИзм,
						РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
					Если ЗначениеЗаполнено(ЕдИзм) Тогда
						РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
					КонецЕсли;
					
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
		Если Не ЗначениеЗаполнено(ИдТовара) Тогда
			НайтиЗначениеВСписке(ИдТовара, "Ид", СписокТЧ);
			РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ИдТовара);
		КонецЕсли;
		
		РеквизитыНоменклатурыПоставщика.Вставить("Наименование", РеквизитыНоменклатуры.Наименование);
		НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков",
			ИдТовара, РеквизитыНоменклатурыПоставщика);
		
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, РеквизитыНоменклатурыПоставщика.Наименование,
			НоменклатураПоставщика, РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
		
		СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "НоменклатураПоставщика");
		
		Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
			РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
			РеквизитыНоменклатурыПоставщика.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
		КонецЕсли;
		
		СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
		ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(РеквизитыНоменклатурыПоставщика,
			СтруктураРеквизитовТовара, ЗначениеСвойстваXDTO(ЭД, "Ид"));
		Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
		Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Характеристика) Тогда
			СписокТЧ.Добавить(СтруктураРеквизитовТовара.Характеристика, "Характеристика");
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Упаковка) Тогда
			СписокТЧ.Добавить(СтруктураРеквизитовТовара.Упаковка, "Упаковка");
		КонецЕсли;
		
		
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара,
			РеквизитыНоменклатурыПоставщика.Наименование, Номенклатура, РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
		СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки,"Номенклатура");
		
		ЕдиницаИзмерения = "";
		
		Цены = ЗначениеСвойстваXDTO(Элемент, "Цены.Цена",, Истина);
		Для Каждого Цена Из Цены Цикл
			
			СписокТЧ.Добавить(ЗначениеСвойстваXDTO(Цена, "ЦенаЗаЕдиницу", "Число"), "Цена");
			СписокТЧ.Добавить(ЗначениеСвойстваXDTO(Цена, "МинКоличество", "Число"), "Количество");
			
			ЗнДанных = ЗначениеСвойстваXDTO(Цена, "Единица");
			
			Если ЗнДанных <> Неопределено Тогда
				
				РеквизитыЕдИзм = Новый Структура;
				РеквизитыЕдИзм.Вставить("Код", ЗнДанных);
				
				ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных, РеквизитыЕдИзм);
				
				Если ЗначениеЗаполнено(ЕдИзм) Тогда
					Наименование = ЕдИзм.Наименование;
				Иначе
					Наименование = "шт.";
				КонецЕсли;
				РеквизитыЕдИзм.Вставить("Наименование", Наименование);
				
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(
					ДеревоРазбора, "ЕдиницыИзмерения");
					
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных, Наименование, ЕдИзм,
					РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
				
				Если ЗначениеЗаполнено(ЕдИзм) Тогда
					СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "ЕдиницаИзмерения");
				КонецЕсли;
			КонецЕсли;
			
			Прервать;
			
		КонецЦикла;
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
		
	КонецЦикла;
	
	// Читаем таб. часть "Виды цен"
	ТаблицаТипыЦен = Новый ТаблицаЗначений;
	ТаблицаТипыЦен.Колонки.Добавить("ИдТипЦены");
	ТаблицаТипыЦен.Колонки.Добавить("ТипЦены");
	ТаблицаТипыЦен.Колонки.Добавить("Наименование");
	ТаблицаТипыЦен.Колонки.Добавить("Валюта");
	ТаблицаТипыЦен.Колонки.Добавить("ВключаетНДС");
	
	ТипыЦен = ЗначениеСвойстваXDTO(ЭД, "ТипыЦен.ТипЦены",, Истина);
	Для Каждого ТекСтрока Из ТипыЦен Цикл
		
		НоваяСтрока = ТаблицаТипыЦен.Добавить();
		
		НоваяСтрока.ТипЦены      = ЗначениеСвойстваXDTO(ТекСтрока, "Ид");
		НоваяСтрока.Наименование = ЗначениеСвойстваXDTO(ТекСтрока, "Наименование");
		НоваяСтрока.Валюта       = ЗначениеСвойстваXDTO(ТекСтрока, "Валюта");
		
		Налоги = ЗначениеСвойстваXDTO(ТекСтрока, "Налог",, Истина);
		Если Налоги <> Неопределено Тогда
			Для Каждого Налог Из Налоги Цикл
				НоваяСтрока.ВключаетНДС = ЗначениеСвойстваXDTO(Налог, "УчтеноВСумме", "Булево");
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТипыЦен", ТаблицаТипыЦен);
	
	ПоместитьНеПодписанныеДанныеВШапку(НовыйЭД);
	
КонецПроцедуры

Процедура УдалитьПрочитатьПрайсXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена.
	НовыйЭД.ИД = ЭД.Ид;
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ПрайсЛист;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.ДействительноС);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	
	// Контрагент
	Элемент = ЭД.Владелец;
	РеквизитыКонтрагента = Новый Структура;
	Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
		
		ЗнДанных = Элемент[ТекСвойство.Имя];
		
		Если ЗнДанных = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
			
			ИдКонтрагента = ЗнДанных;
			// Разберем ИД на ИНН и КПП.
			СтруктураПоиска = РазобратьИДКонтрагента(ИдКонтрагента);
			Если СтруктураПоиска.Свойство("ИНН") Тогда
				РеквизитыКонтрагента.Вставить("ИНН", СтруктураПоиска.ИНН);
			КонецЕсли;
			Если СтруктураПоиска.Свойство("КПП") Тогда
				РеквизитыКонтрагента.Вставить("КПП", СтруктураПоиска.КПП);
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЮрЛицо") ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ФизЛицо") Тогда
			РеквизитыУчастника = ЗнДанных;
			Для Каждого СвойствоУчастника Из РеквизитыУчастника.Свойства() Цикл
				РеквизитУчастника = РеквизитыУчастника[СвойствоУчастника.Имя];
				Если РеквизитУчастника <> Неопределено Тогда
					Если ВРег(СвойствоУчастника.Имя) = ВРег("ЮридическийАдрес")
						ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("АдресРегистрации") Тогда
						
						РеквизитыКонтрагента.Вставить(СвойствоУчастника.Имя+"_Представление", РеквизитУчастника.Представление);
					ИначеЕсли ВРег(СвойствоУчастника.Имя) = ВРег("ОфициальноеНаименование")
						ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("ПолноеНаименование") Тогда
						
						РеквизитыКонтрагента.Вставить("ПолноеНаименование", РеквизитУчастника);
					Иначе
						РеквизитыКонтрагента.Вставить(СвойствоУчастника.Имя, РеквизитУчастника);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		Иначе
			РеквизитыКонтрагента.Вставить(ТекСвойство.Имя, ЗнДанных);
		КонецЕсли;
		
	КонецЦикла;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Контрагенты");
	Контрагент = ЭлектронноеВзаимодействие.НайтиСсылку("Контрагенты", ИдКонтрагента, РеквизитыКонтрагента);
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдКонтрагента, "ИНН+КПП: " + ИдКонтрагента,
		Контрагент, РеквизитыКонтрагента, ДеревоРазбора, Ошибка);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Контрагент", НайденнаяСтрока.ИндексСтроки);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаФормирования", ЭД.ДействительноС);
	
	Если ОбменСКонтрагентамиПовтИсп.ИспользуетсяДополнительнаяАналитикаКонтрагентовСправочникПартнеры() Тогда
		РеквизитыПартнера = Новый Структура();
		РеквизитыПартнера.Вставить("Контрагент", Контрагент);
		ИмяПрикладногоСправочника = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ИмяПрикладногоСправочника("Партнеры");
		ЗнДопАналитики = ЭлектронноеВзаимодействие.НайтиСсылку(ИмяПрикладногоСправочника, , РеквизитыПартнера);
		
		Если ЗначениеЗаполнено(ЗнДопАналитики) Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Партнеры");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДопАналитики.Код, "Код: "
				+ ЗнДопАналитики.Код, ЗнДопАналитики, РеквизитыПартнера, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Партнер", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
	КонецЕсли;
	
	// Товары
	Предложения = ЭД.Предложения.ПолучитьСписок("Предложение");
	Для Каждого Элемент Из Предложения Цикл
		
		СписокТЧ = Новый СписокЗначений;
		НаименованиеТовара = "";
		ИдТовара           = "";
		АртикулТовара      = "";
		
		// Номенклатура.
		РеквизитыНоменклатуры = Новый Структура;
		РеквизитыНоменклатурыПоставщика = Новый Структура;
		ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
		ВладелецНоменклатуры = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
		РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
		Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
			
			ЗнДанных = Элемент[ТекСвойство.Имя];
			
			Если ЗнДанных = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			// Разберем свойства Товара.
			Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
				РеквизитыНоменклатуры.Вставить("Ид", ЗнДанных);
				РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ЗнДанных);
				ИдТовара = ЗнДанных;
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
				РеквизитыНоменклатуры.Вставить("Наименование", ЗнДанных);
				РеквизитыНоменклатурыПоставщика.Вставить("Наименование", ЗнДанных);
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
				РеквизитыНоменклатуры.Вставить("Артикул", ЗнДанных);
				РеквизитыНоменклатурыПоставщика.Вставить("Артикул", ЗнДанных);
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
				Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
					РеквизитыЕдИзм = Новый Структура;
					РеквизитыЕдИзм.Вставить("Код", ЗнДанных.Код);
					РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
					ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных.Код, РеквизитыЕдИзм);
					НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
					НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных.Код, ЗнДанных.Наименование, ЕдИзм,
						РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
					Если ЗначениеЗаполнено(ЕдИзм) Тогда
						РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
					КонецЕсли;
				КонецЕсли;
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЕдиницаИзмерения") Тогда
				Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
					РеквизитыЕдИзм = Новый Структура;
					РеквизитыЕдИзм.Вставить("Код", ЗнДанных.Код);
					РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
					
					ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных.Код, РеквизитыЕдИзм);
					НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
					НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных.Код, ЗнДанных.Наименование, ЕдИзм,
						РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
						
					Если ЗначениеЗаполнено(ЕдИзм) Тогда
						СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "ЕдиницаИзмерения");
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
		РеквизитыНоменклатурыПоставщика.Вставить("Наименование", РеквизитыНоменклатуры.Наименование);
		НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ИдТовара,
			РеквизитыНоменклатурыПоставщика);
		
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, РеквизитыНоменклатурыПоставщика.Наименование,
			НоменклатураПоставщика, РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
		
		СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "НоменклатураПоставщика");
		
		Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
			РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
			РеквизитыНоменклатурыПоставщика.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
		КонецЕсли;
		
		СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
		ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(РеквизитыНоменклатурыПоставщика,
			СтруктураРеквизитовТовара, ЭД.Ид);
		Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
		Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Характеристика) Тогда
			СписокТЧ.Добавить(СтруктураРеквизитовТовара.Характеристика, "Характеристика");
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Упаковка) Тогда
			СписокТЧ.Добавить(СтруктураРеквизитовТовара.Упаковка, "Упаковка");
		КонецЕсли;
		
		
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара,
			РеквизитыНоменклатурыПоставщика.Наименование, Номенклатура, РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
		СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки,"Номенклатура");
		
		ЗначениеЦены = 0;
		ЕдиницаИзмерения = "";
		Цены = Элемент.Цены.ПолучитьСписок("Цена");
		Для Каждого Цена Из Цены Цикл
			ЗначениеЦены = Цена.Цена;
			СписокТЧ.Добавить(ЗначениеЦены, "Цена");
			ЗнДанных = Цена.ЕдиницаИзмерения;
			
			РеквизитыЕдИзм = Новый Структура;
			РеквизитыЕдИзм.Вставить("Код", ЗнДанных.Код);
			РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
			СвойствоКоличество = Цена.Свойства().Получить("МинКоличество");
			Если СвойствоКоличество<>Неопределено Тогда
				СписокТЧ.Добавить(Цена.МинКоличество, "Количество");
			КонецЕсли;
			ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных.Код, РеквизитыЕдИзм);
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных.Код, ЗнДанных.Наименование, ЕдИзм,
				РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
			Если ЗначениеЗаполнено(ЕдИзм) Тогда
				СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "ЕдиницаИзмерения");
			КонецЕсли;
			Прервать;
		КонецЦикла;
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
	КонецЦикла;
	
	ТаблицаТипыЦен = Новый ТаблицаЗначений;
	ТаблицаТипыЦен.Колонки.Добавить("Валюта");
	ТаблицаТипыЦен.Колонки.Добавить("ВключаетНДС");
	
	Для Каждого ТекСтрока Из ЭД.ТипыЦен.ТипЦены Цикл
		НоваяСтрока = ТаблицаТипыЦен.Добавить();
		Если ТипЗнч(ТекСтрока.Валюта) = Тип("ОбъектXDTO") Тогда
			НоваяСтрока.Валюта = ТекСтрока.Валюта.КодОКВ;
		КонецЕсли;
		НоваяСтрока.ВключаетНДС = Ложь;
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТипыЦен", ТаблицаТипыЦен);
	
КонецПроцедуры

Процедура ПрочитатьСчетНаОплатуXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена
	НовыйЭД.ИД = ЗначениеСвойстваXDTO(ЭД, "Ид");
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетНаОплату;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", НовыйЭД.ИД);
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЗначениеСвойстваXDTO(ЭД, "Номер"));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата",  ЗначениеСвойстваXDTO(ЭД, "Дата", "XMLДата"));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ЗначениеСвойстваXDTO(ЭД, "Сумма", "Число"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОкончанияДействияСчета", 
		ЗначениеСвойстваXDTO(ЭД, "СрокПлатежа"));
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		
		КодВалюты = ЭД.Получить(СвойствоЭД);
		Если КодВалюты <> Неопределено Тогда
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("КодМКВ", КодВалюты);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			Если ЗначениеЗаполнено(Валюта) Тогда
				РеквизитыВалюты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Валюта, "Наименование, НаименованиеПолное");
				ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.Наименование);
				ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.НаименованиеПолное);
			Иначе
				РеквизитыВалюты = ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеВалютыПоКлассификатору(КодВалюты);
				Если РеквизитыВалюты <> Неопределено Тогда
					ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.КодВалютыБуквенный);
					ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.Наименование);
				КонецЕсли;
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ЗначениеСвойстваXDTO(ЭД, "Курс");
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
	КонецЕсли;
	
	ДопПараметрыКонтрагента = Неопределено;
	СвойствоРасчетныйСчет   = ЗначениеДопРеквизитаДокумента("РасчетныйСчет", ЭД);
	
	Если Не СвойствоРасчетныйСчет = Неопределено Тогда
		СтруктураРасчетныйСчет =  РеквизитыРасчетногоСчета(СвойствоРасчетныйСчет, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
		
		ДопПараметрыКонтрагента = Новый Структура;
		ДопПараметрыКонтрагента.Вставить("РасчетныйСчет", СтруктураРасчетныйСчет);
		
	КонецЕсли;
	
	Контрагенты = ЗначениеСвойстваXDTO(ЭД, "Контрагенты.Контрагент",, Истина);
	Если Контрагенты <> Неопределено Тогда
		Для Каждого ТекКонтрагент Из Контрагенты Цикл
			
			РольКонтрагента = ЗначениеСвойстваXDTO(ТекКонтрагент, "Роль");
			
			Если РольКонтрагента = "Продавец" Тогда
				Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
					Роль = "Продавец";
				ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
					Роль = "Покупатель";
				КонецЕсли;
			КонецЕсли;
			
			Если РольКонтрагента = "Покупатель" Тогда
				Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
					Роль = "Покупатель";
				ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
					Роль = "Продавец";
				КонецЕсли;
			КонецЕсли;
			
			ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Роль, ДопПараметрыКонтрагента);
			
		КонецЦикла;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаИтог",
		ЗначениеСвойстваXDTO(ЭД, "Сумма", "Число"));
	
	СуммаНалогаИтог  = 0;
	СуммаВключаетНДС = Ложь;
	
	Налоги = ЗначениеСвойстваXDTO(ЭД, "Налоги.Налог",, Истина);
	Для Каждого НалогДокумента Из Налоги Цикл
		
		СуммаНалогаИтог = СуммаНалогаИтог + ЗначениеСвойстваXDTO(НалогДокумента, "Сумма", "Число");
		
		Если Врег(ЗначениеСвойстваXDTO(НалогДокумента, "Наименование")) = "НДС" Тогда
			СуммаВключаетНДС = ЗначениеСвойстваXDTO(НалогДокумента, "УчтеноВСумме", "Булево");
		КонецЕсли;
		
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаНалогаИтог", СуммаНалогаИтог);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЦенаВключаетНДС", СуммаВключаетНДС);
	
	ИтогиПрописью = ЗначениеДопРеквизитаДокумента("ИтогиПрописью", ЭД);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИтогиПрописью", ИтогиПрописью);
	
	НаборДанных = ЗначениеСвойстваXDTO(ЭД, "Товары.Товар",, Истина);
	ПрочитатьДанныеПоТЧСчетаНаОплату(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	Подписанты = ЗначениеСвойстваXDTO(ЭД, "Подписанты.Подписант",, Истина);
	Для Каждого Подписант Из Подписанты Цикл
		
		Должность = ЗначениеСвойстваXDTO(Подписант, "Должность", "Строка");
		Фамилия   = ЗначениеСвойстваXDTO(Подписант, "Фамилия",   "Строка");
		Имя       = ЗначениеСвойстваXDTO(Подписант, "Имя",       "Строка");
		Отчество  = ЗначениеСвойстваXDTO(Подписант, "Отчество",  "Строка");
		
		Если ВРег(Должность) = ВРег("Руководитель") ИЛИ ВРег(Должность) = ВРег("Директор") Тогда
			Руководитель = Фамилия + " " + Имя + " " + Отчество;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Руководитель", Руководитель);
		ИначеЕсли ВРег(Должность) = ВРег("Бухгалтер") Тогда
			Бухгалтер = Фамилия + " " + Имя + " " + Отчество;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Бухгалтер", Бухгалтер);
		ИначеЕсли Не ЗначениеЗаполнено(Должность) И Фамилия <> "-" Тогда
			// Заполнение для индивидуального предпринимателя, для которого должность не указывается.
			Руководитель = Фамилия + " " + Имя + " " + Отчество;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Руководитель", Руководитель);
		КонецЕсли;
		
	КонецЦикла;
	
	СвойствоЭД = ЗначениеДопРеквизитаДокумента("ГрафикОплаты", ЭД);
	Если СвойствоЭД <> Неопределено Тогда
		ПрочитатьДанныеПоГрафикуОплаты(СвойствоЭД, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	КонецЕсли;
	
	// Значения реквизитов
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
	
	ДопРеквизиты = Новый Структура;
	Если ЗначениеЗаполнено(Организация) Тогда
		ДопРеквизиты.Вставить("Организация", Организация);
	КонецЕсли;
	
	ПрочитатьДопДанныеШапкиДокумента(ЭД, НовыйЭД, Ошибка, ДопРеквизиты);
	
	ПрочитатьСписокЗначенийРеквизитовCML(
		ЗначениеСвойстваXDTO(ЭД, "ЗначенияРеквизитов.ЗначениеРеквизита",, Истина), НовыйЭД, Ошибка, ДопРеквизиты);
	
	НомерДокументаОснования = ЗначениеДопРеквизитаДокумента("НомерДокументаОснования", ЭД);
	Если НомерДокументаОснования <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерДокументаОснования", НомерДокументаОснования);
	КонецЕсли;
	
	ДатаДокументаОснования = ЗначениеДопРеквизитаДокумента("ДатаДокументаОснования", ЭД);
	Если ДатаДокументаОснования <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаДокументаОснования", ДатаДокументаОснования);
	КонецЕсли;
	
	ВладелецДоговора = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Контрагент");
	
	// Документы сделки
	ПрочитатьДокументыСделки(ДеревоРазбора, НовыйЭД, Организация, ВладелецДоговора, Ошибка);
	
КонецПроцедуры

Процедура УдалитьПрочитатьСчетНаОплатуXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена
	НовыйЭД.ИД = ЭД.Ид;
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетНаОплату;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Номер);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.Дата);
			
	СвойствоЭД = ЭД.Свойства().Получить("НазначениеПлатежа");
	НазначениеПлатежа = ЭД.Получить(СвойствоЭД);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НазначениеПлатежа", НазначениеПлатежа);
	
	СвойствоЭД = ЭД.Свойства().Получить("ДатаОкончанияДействияСчета");
	ДатаОкончанияДействияСчета = ЭД.Получить(СвойствоЭД);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОкончанияДействияСчета", ДатаОкончанияДействияСчета);
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		ВалютаXDTO = ЭД.Получить(СвойствоЭД);
		Если Не ВалютаXDTO = Неопределено Тогда
			КодВалюты = ВалютаXDTO.КодОКВ;
			Если КодВалюты <> Неопределено Тогда
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
				
				ДопРеквизиты = Новый Структура;
				ДопРеквизиты.Вставить("Код", КодВалюты);
				ДопРеквизиты.Вставить("Наименование", ВалютаXDTO.НаименованиеСокращенноеОКВ);
				ДопРеквизиты.Вставить("НаименованиеПолное", ВалютаXDTO.НаименованиеПолноеОКВ);
				ДопРеквизиты.Вставить("КодМКВ", ВалютаXDTO.КодМКВ);
				
				Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
			КонецЕсли;
			
			Курс = ВалютаXDTO.Курс;
			Если Курс <> Неопределено Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Поставщик");
	Поставщик = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Покупатель");
	Покупатель = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогоПоДокументу");
	ИтогоПоДокументуXDTO = ЭД.Получить(СвойствоЭД);
	СуммаИтог = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаИтог");
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаИтог",      ИтогоПоДокументуXDTO.Получить(СуммаИтог));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", ИтогоПоДокументуXDTO.Получить(СуммаИтог));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ИтогоПоДокументуXDTO.Получить(СуммаИтог));
	СвойствоСуммаНалогаИтог = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаНалогаИтог");
	Если СвойствоСуммаНалогаИтог <> Неопределено Тогда
		СуммаНалогаИтог = ИтогоПоДокументуXDTO.Получить(СвойствоСуммаНалогаИтог);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаНалогаИтог", СуммаНалогаИтог);
	КонецЕсли;
	
	СвойствоЦенаВключаетНДС = ИтогоПоДокументуXDTO.Свойства().Получить("ЦенаВключаетНалог");
	Если СвойствоЦенаВключаетНДС <> Неопределено Тогда
		ЦенаВключаетНДС =  ИтогоПоДокументуXDTO.Получить(СвойствоЦенаВключаетНДС);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЦенаВключаетНДС", ЦенаВключаетНДС);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИтогиПрописью", ЭД.ИтогиПрописью);
	
	СвойствоЭД = ЭД.Свойства().Получить("Товары");
	Если СвойствоЭД <> Неопределено И ЭД.Получить(СвойствоЭД) <> Неопределено Тогда
		НаборДанных = ЭД["Товары"].Товар;
		УдалитьПрочитатьДанныеПоТЧСчетаНаОплату(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Руководитель");
	Если СвойствоЭД <> Неопределено Тогда
		Руководитель = ЭД.Получить(СвойствоЭД);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Руководитель", Руководитель.ПолноеНаименование);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Бухгалтер");
	Если СвойствоЭД <> Неопределено Тогда
		Бухгалтер = ЭД.Получить(СвойствоЭД);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Бухгалтер", Бухгалтер.ПолноеНаименование);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ЭтапОплаты");
	Если СвойствоЭД <> Неопределено Тогда
		УдалитьПрочитатьДанныеПоГрафикуОплаты(ЭД.ЭтапОплаты, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ДокументОснования");
	Если СвойствоЭД <> Неопределено Тогда
		Для Каждого ДокументОснованияXDTO Из ЭД.ДокументОснования Цикл
			СвойствоНомерДокументаОснования = ДокументОснованияXDTO.Свойства().Получить("НомерДокументаОснования");
			Если СвойствоНомерДокументаОснования <> Неопределено Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерДокументаОснования", ДокументОснованияXDTO.НомерДокументаОснования);
			КонецЕсли;
			СвойствоДатаДокументаОснования = ДокументОснованияXDTO.Свойства().Получить("ДатаДокументаОснования");
			Если СвойствоДатаДокументаОснования <> Неопределено Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаДокументаОснования", ДокументОснованияXDTO.ДатаДокументаОснования);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьЗаказXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена
	НовыйЭД.ИД = ЗначениеСвойстваXDTO(ЭД, "Ид");
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", НовыйЭД.ИД);
	
	Если ЭД.Роль = "Покупатель" Тогда
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ЗаказТовара;
	ИначеЕсли ЭД.Роль = "Продавец" Тогда
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ОтветНаЗаказ;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЗначениеСвойстваXDTO(ЭД, "Номер"));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата",  ЗначениеСвойстваXDTO(ЭД, "Дата", "XMLДата"));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ЗначениеСвойстваXDTO(ЭД, "Сумма", "Число"));
	
	НазначениеПлатежа = ЗначениеДопРеквизитаДокумента("НазначениеПлатежа", ЭД);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НазначениеПлатежа", НазначениеПлатежа);
	
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		
		Если ВРег(ЭД.Роль) = ВРег("Покупатель") Тогда
			РольКонтрагента = "Продавец";
			РольОрганизации = "Покупатель";
		Иначе
			РольКонтрагента = "Покупатель";
			РольОрганизации = "Продавец";
		КонецЕсли;
		
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		
		Если ВРег(ЭД.Роль) = ВРег("Покупатель") Тогда
			РольКонтрагента = "Покупатель";
			РольОрганизации = "Продавец";
		Иначе
			РольКонтрагента = "Продавец";
			РольОрганизации = "Покупатель";
		КонецЕсли;
		
	КонецЕсли;
	
	Контрагенты = ЗначениеСвойстваXDTO(ЭД, "Контрагенты.Контрагент",, Истина);
	Если Контрагенты <> Неопределено Тогда
		Для Каждого ТекКонтрагент Из Контрагенты Цикл
			
			Роль = ЗначениеСвойстваXDTO(ТекКонтрагент, "Роль");
			
			Если ВРег(Роль) = ВРег("Покупатель") Тогда
				ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, РольКонтрагента);
			ИначеЕсли ВРег(Роль) = ВРег("Продавец") Тогда
				ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, РольОрганизации);
			Иначе
				ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Получатель");
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
	// Читаем товары.
	НаборДанных = ЗначениеСвойстваXDTO(ЭД, "Товары.Товар",, Истина);
	
	ПрочитатьДанныеПоТЧЗаказаКлиента(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
	
	ДопРеквизиты = Новый Структура;
	Если ЗначениеЗаполнено(Организация) Тогда
		ДопРеквизиты.Вставить("Организация", Организация);
	КонецЕсли;
	
	// Значения реквизитов.
	ПрочитатьСписокЗначенийРеквизитовCML(
		ЗначениеСвойстваXDTO(ЭД, "ЗначенияРеквизитов.ЗначениеРеквизита",, Истина), НовыйЭД, Ошибка, ДопРеквизиты);
	
	// Читаем доп данные из xdto и помещаем их в шапку в дерево значений.
	ПрочитатьДопДанныеШапкиДокумента(ЭД, НовыйЭД, Ошибка, ДопРеквизиты);
	
	// Договор контрагента.
	ДоговорНомер = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, НовыйЭД, "ДоговорНомер");
	ДоговорДата  = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, НовыйЭД, "ДоговорДата");
	Если ЗначениеЗаполнено(ДоговорДата) Тогда
		ДоговорДата = ДатаИзСтроки(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, НовыйЭД, "ДоговорДата"));
	КонецЕсли;
	
	ВладелецДоговора = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Контрагент");
	
	РеквизитыДоговора = Новый Структура;
	РеквизитыДоговора.Вставить("НомерДоговора", ДоговорНомер);
	РеквизитыДоговора.Вставить("ДатаДоговора",  ДоговорДата);
	РеквизитыДоговора.Вставить("Организация",   Организация);
	РеквизитыДоговора.Вставить("Владелец",      ВладелецДоговора);
	
	ДобавитьДоговорВДеревоДокумента(РеквизитыДоговора, НовыйЭД, ДеревоРазбора, Ошибка);
	
	ПрочитатьДокументыСделки(ДеревоРазбора, НовыйЭД, Организация, ВладелецДоговора, Ошибка);
	
	// Банковский счет 
	Если РольОрганизации = "Продавец" Тогда
		ВладелецБС = "Организация";
		ТипСчета = "БанковскиеСчетаОрганизаций";
		ИмяСчета = "БанковскийСчетОрганизации";
	Иначе
		ВладелецБС = "Контрагент";
		ТипСчета = "БанковскиеСчетаКонтрагентов";
		ИмяСчета = "БанковскийСчетКонтрагента";
	КонецЕсли;
	
	ВладелецСчета = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, ВладелецБС);
	
	СвойствоРасчетныйСчет = ЗначениеДопРеквизитаДокумента("РасчетныйСчет", ЭД);
	Если СвойствоРасчетныйСчет <> Неопределено Тогда
		
		СтруктураРасчетныйСчет = РеквизитыРасчетногоСчета(СвойствоРасчетныйСчет, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
		
		НомерСчета = СтруктураРасчетныйСчет.НомерСчета;
		
		РеквизитыСчета = Новый Структура;
		РеквизитыСчета.Вставить("Владелец", ВладелецСчета);
		
		БанковскийСчет = ЭлектронноеВзаимодействие.НайтиСсылку(ТипСчета, НомерСчета, РеквизитыСчета);
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ТипСчета);
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, НомерСчета, НСтр("ru = 'Номер счета:'") + " " + НомерСчета, БанковскийСчет,
				РеквизитыСчета, ДеревоРазбора, Ошибка);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчет", НайденнаяСтрока.ИндексСтроки);
		
	Иначе
		
		РасчетныйСчет = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, ИмяСчета);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчет", РасчетныйСчет);
		
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		КодВалюты = ЭД.Получить(СвойствоЭД);
		
		Если КодВалюты <> Неопределено Тогда
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("КодМКВ", КодВалюты);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			Если ЗначениеЗаполнено(Валюта) Тогда
				РеквизитыВалюты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Валюта, "Наименование, НаименованиеПолное");
				ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.Наименование);
				ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.НаименованиеПолное);
			Иначе
				РеквизитыВалюты = ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеВалютыПоКлассификатору(КодВалюты);
				Если РеквизитыВалюты <> Неопределено Тогда
					ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.КодВалютыБуквенный);
					ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.Наименование);
				КонецЕсли;
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ЗначениеСвойстваXDTO(ЭД, "Курс");
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЗначениеДопРеквизитаДокумента("ГрафикОплаты", ЭД);
	
	Если СвойствоЭД <> Неопределено Тогда
		ПрочитатьДанныеПоГрафикуОплаты(СвойствоЭД, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	КонецЕсли;
	
	Комментарий = ЗначениеСвойстваXDTO(ЭД, "Комментарий");
	Если Комментарий <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДополнительнаяИнформация", Комментарий);
	КонецЕсли;
	
КонецПроцедуры

Процедура УдалитьПрочитатьЗаказXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена
	НовыйЭД.ИД = ЭД.Ид;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	Если ЭД.Роль = "Покупатель" Тогда
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ЗаказТовара;
	ИначеЕсли ЭД.Роль = "Продавец" Тогда
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ОтветНаЗаказ;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Номер);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.Дата);
	
	СвойствоЭД = ЭД.Свойства().Получить("Исполнитель");
	Исполнитель = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ПрочитатьДанныеКонтрагента(Исполнитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, ЭД.Роль);
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		Если ЭД.Роль = "Покупатель" Тогда
			ПрочитатьДанныеКонтрагента(Исполнитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		ИначеЕсли ЭД.Роль = "Продавец" Тогда
			ПрочитатьДанныеКонтрагента(Исполнитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Заказчик");
	Заказчик = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		Если ЭД.Роль = "Покупатель" Тогда
			ПрочитатьДанныеКонтрагента(Заказчик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		ИначеЕсли ЭД.Роль = "Продавец" Тогда
			ПрочитатьДанныеКонтрагента(Заказчик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		КонецЕсли;
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Заказчик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, ЭД.Роль);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Товары");
	НаборДанных = ЭД["Товары"].Товар;
	УдалитьПрочитатьДанныеПоТЧЗаказаКлиента(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогоПоДокументу");
	ИтогоПоДокументуXDTO = ЭД.Получить(СвойствоЭД);
	СуммаИтог = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаИтог");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаИтог",      ИтогоПоДокументуXDTO.Получить(СуммаИтог));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", ИтогоПоДокументуXDTO.Получить(СуммаИтог));
	СвойствоСуммаНалогаИтог = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаНалогаИтог");
	Если СвойствоСуммаНалогаИтог <> Неопределено Тогда
		СуммаНалогаИтог = ИтогоПоДокументуXDTO.Получить(СвойствоСуммаНалогаИтог);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаНалогаИтог", СуммаНалогаИтог);
	КонецЕсли;
	
	СвойствоСуммаБезСкидкиИтог = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаБезСкидкиИтог");
	Если СвойствоСуммаБезСкидкиИтог <> Неопределено Тогда
		СуммаБезСкидкиИтог = ИтогоПоДокументуXDTO.Получить(СвойствоСуммаБезСкидкиИтог);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаБезСкидкиИтог", СуммаБезСкидкиИтог);
	КонецЕсли;
	
	СвойствоСуммаСкидкиИтог = ИтогоПоДокументуXDTO.Свойства().Получить("СуммаСкидкиИтог");
	Если СвойствоСуммаСкидкиИтог <> Неопределено Тогда
		СуммаСкидкиИтог = ИтогоПоДокументуXDTO.Получить(СвойствоСуммаСкидкиИтог);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаСкидкиИтог", СуммаСкидкиИтог);
	КонецЕсли;
	
	СвойствоЦенаВключаетНДС = ИтогоПоДокументуXDTO.Свойства().Получить("ЦенаВключаетНалог");
	Если СвойствоЦенаВключаетНДС <> Неопределено Тогда
		ЦенаВключаетНДС = ИтогоПоДокументуXDTO.Получить(СвойствоЦенаВключаетНДС);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЦенаВключаетНДС", ЦенаВключаетНДС);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИтогиПрописью", ЭД.ИтогиПрописью);
	
	СвойствоЭД = ЭД.Свойства().Получить("ДокументОснования");
	Если СвойствоЭД <> Неопределено Тогда
		Для Каждого ДокументОснованияXDTO Из ЭД.ДокументОснования Цикл
			СвойствоНаименованиеДокументаОснования = ДокументОснованияXDTO.Свойства().Получить("НаименованиеДокументаОснования");
			Если СвойствоНаименованиеДокументаОснования <> Неопределено Тогда
				Если ДокументОснованияXDTO.НаименованиеДокументаОснования = НСтр("ru = 'По данным клиента'") Тогда
					СвойствоНомерДокументаОснования = ДокументОснованияXDTO.Свойства().Получить("НомерДокументаОснования");
					Если СвойствоНомерДокументаОснования <> Неопределено Тогда
						ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерПоДаннымКлиента", ДокументОснованияXDTO.НомерДокументаОснования);
					КонецЕсли;
					СвойствоДатаДокументаОснования = ДокументОснованияXDTO.Свойства().Получить("ДатаДокументаОснования");
					Если СвойствоДатаДокументаОснования <> Неопределено Тогда
						ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПоДаннымКлиента", ДокументОснованияXDTO.ДатаДокументаОснования);
					КонецЕсли;
				ИначеЕсли ДокументОснованияXDTO.НаименованиеДокументаОснования = НСтр("ru = 'По данным поставщика'") Тогда
					СвойствоНомерДокументаОснования = ДокументОснованияXDTO.Свойства().Получить("НомерДокументаОснования");
					Если СвойствоНомерДокументаОснования <> Неопределено Тогда
						ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерПоДаннымПоставщика", ДокументОснованияXDTO.НомерДокументаОснования);
					КонецЕсли;
					СвойствоДатаДокументаОснования = ДокументОснованияXDTO.Свойства().Получить("ДатаДокументаОснования");
					Если СвойствоДатаДокументаОснования <> Неопределено Тогда
						ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПоДаннымПоставщика", ДокументОснованияXDTO.ДатаДокументаОснования);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		ВалютаXDTO = ЭД.Получить(СвойствоЭД);
		КодВалюты = ВалютаXDTO.КодОКВ;
		Если КодВалюты <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("Наименование", ВалютаXDTO.НаименованиеСокращенноеОКВ);
			ДопРеквизиты.Вставить("НаименованиеПолное", ВалютаXDTO.НаименованиеПолноеОКВ);
			ДопРеквизиты.Вставить("КодМКВ", ВалютаXDTO.КодМКВ);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ВалютаXDTO.Курс;
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭД.АдресДоставкиСклад <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "АдресДоставки", ЭД.АдресДоставкиСклад.Наименование);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ЭтапОплаты");
	Если СвойствоЭД <> Неопределено Тогда
		УдалитьПрочитатьДанныеПоГрафикуОплаты(ЭД.ЭтапОплаты, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Комментарий");
	Если СвойствоЭД <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДополнительнаяИнформация", ЭД.Комментарий);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьОтчетОСписанииКомиссионногоТовараXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена.
	НовыйЭД.ИД    = ЗначениеСвойстваXDTO(ЭД, "Ид");
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЗначениеСвойстваXDTO(ЭД, "Номер"));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата",  ЗначениеСвойстваXDTO(ЭД, "Дата", "XMLДата"));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ЗначениеСвойстваXDTO(ЭД, "Сумма", "Число"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", НовыйЭД.ИД);
	
	// Читаем контрагентов.
	Контрагенты = ЗначениеСвойстваXDTO(ЭД, "Контрагенты.Контрагент",, Истина);
	Если Контрагенты <> Неопределено Тогда
		Для Каждого ТекКонтрагент Из Контрагенты Цикл
			
			Роль = ЗначениеСвойстваXDTO(ТекКонтрагент, "Роль");
			
			Если ВРег(Роль) = ВРег("Комитент") Тогда
				
				Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
					ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
				ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
					ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
				КонецЕсли;
				
			ИначеЕсли ВРег(Роль) = ВРег("Комиссионер") Тогда
				
				Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
					ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
				ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
					ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
				КонецЕсли;
				
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	НаборДанных = ЗначениеСвойстваXDTO(ЭД, "Товары.Товар",, Истина);
	ПрочитатьДанныеПоТЧОтчетаОСписанииКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	// Дополнительные реквизиты.
	ПрочитатьСписокЗначенийРеквизитовCML(
		ЗначениеСвойстваXDTO(ЭД, "ЗначенияРеквизитов.ЗначениеРеквизита",, Истина), НовыйЭД, Ошибка);
	
	// Читаем доп данные.
	ПрочитатьДопДанныеШапкиДокумента(ЭД, НовыйЭД, Ошибка);
	
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
	ВладелецДоговора = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Контрагент");
	
	// Документы сделки.
	ПрочитатьДокументыСделки(ДеревоРазбора, НовыйЭД, Организация, ВладелецДоговора, Ошибка);
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		КодВалюты = ЭД.Получить(СвойствоЭД);
		Если КодВалюты <> Неопределено Тогда
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("КодМКВ", КодВалюты);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			Если ЗначениеЗаполнено(Валюта) Тогда
				РеквизитыВалюты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Валюта, "Наименование, НаименованиеПолное");
				ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.Наименование);
				ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.НаименованиеПолное);
			Иначе
				РеквизитыВалюты = ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеВалютыПоКлассификатору(КодВалюты);
				Если РеквизитыВалюты <> Неопределено Тогда
					ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.КодВалютыБуквенный);
					ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.Наименование);
				КонецЕсли;
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ЗначениеСвойстваXDTO(ЭД, "Курс");
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура УдалитьПрочитатьОтчетОСписанииКомиссионногоТовараXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена
	НовыйЭД.ИД = ЭД.Ид;
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Номер);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.Дата);
	
	СвойствоЭД = ЭД.Свойства().Получить("Комитент");
	Комитент = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ПрочитатьДанныеКонтрагента(Комитент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда		
		ПрочитатьДанныеКонтрагента(Комитент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Комиссионер");
	Комиссионер = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ПрочитатьДанныеКонтрагента(Комиссионер, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Комиссионер, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	КонецЕсли;
	
	НаборДанных = ЭД["Товары"].Товар;
	УдалитьПрочитатьДанныеПоТЧОтчетаОСписанииКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогоПоДокументу");
	ИтогоПоДокументу = ЭД.Получить(СвойствоЭД);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИтогоПоДокументу", ИтогоПоДокументу);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента",   ИтогоПоДокументу);
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИтогиПрописью", ЭД.ИтогиПрописью);
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		ВалютаXDTO = ЭД.Получить(СвойствоЭД);
		КодВалюты = ВалютаXDTO.КодОКВ;
		Если КодВалюты <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("Наименование", ВалютаXDTO.НаименованиеСокращенноеОКВ);
			ДопРеквизиты.Вставить("НаименованиеПолное", ВалютаXDTO.НаименованиеПолноеОКВ);
			ДопРеквизиты.Вставить("КодМКВ", ВалютаXDTO.КодМКВ);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ВалютаXDTO.Курс;
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьОтчетОПродажахКомиссионногоТовараXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Уникальный номер ЭД в разрезе участников обмена.
	НовыйЭД.ИД    = ЗначениеСвойстваXDTO(ЭД, "Ид");
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЗначениеСвойстваXDTO(ЭД, "Номер"));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата",  ЗначениеСвойстваXDTO(ЭД, "Дата", "XMLДата"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "Ид"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ЗначениеСвойстваXDTO(ЭД, "Сумма", "Число"));
	
	// Читаем доп данные.
	ПрочитатьДопДанныеШапкиДокумента(ЭД, НовыйЭД, Ошибка);
	
	МассивИдКонтрагентов = Новый Массив;
	Контрагенты = ЗначениеСвойстваXDTO(ЭД, "Контрагенты.Контрагент",, Истина);
	Если Контрагенты <> Неопределено Тогда
		Для Каждого ТекКонтрагент Из Контрагенты Цикл
			Роль = ЗначениеСвойстваXDTO(ТекКонтрагент, "Роль");
			Если Роль = "Покупатель" Тогда
				Роль = "ПокупательКомиссионногоТовара";
			КонецЕсли;
			ПрочитатьДанныеКонтрагентаCML(ТекКонтрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Роль, Новый Структура("МассивИдКонтрагентов", МассивИдКонтрагентов));
		КонецЦикла;
	КонецЕсли;
	НаборДанных = ЗначениеСвойстваXDTO(ЭД, "Товары.Товар",, Истина);
	ПрочитатьДанныеПоТЧОтчетаОПродажахКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	// Значения реквизитов.
	ПрочитатьСписокЗначенийРеквизитовCML(
		ЗначениеСвойстваXDTO(ЭД, "ЗначенияРеквизитов.ЗначениеРеквизита",, Истина), НовыйЭД, Ошибка);
	
	Организация      = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
	ВладелецДоговора = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Контрагент");
	
	// Документы сделки.
	ПрочитатьДокументыСделки(ДеревоРазбора, НовыйЭД, Организация, ВладелецДоговора, Ошибка);
	
	ГрафикОплаты = ЗначениеДопРеквизитаДокумента("ГрафикОплаты", ЭД);
	ПрочитатьДанныеПоГрафикуОплаты(ГрафикОплаты, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		
		КодВалюты = ЭД.Получить(СвойствоЭД);
		Если КодВалюты <> Неопределено Тогда
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("КодМКВ", КодВалюты);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			Если ЗначениеЗаполнено(Валюта) Тогда
				РеквизитыВалюты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Валюта, "Наименование, НаименованиеПолное");
				ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.Наименование);
				ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.НаименованиеПолное);
			Иначе
				РеквизитыВалюты = ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеВалютыПоКлассификатору(КодВалюты);
				Если РеквизитыВалюты <> Неопределено Тогда
					ДопРеквизиты.Вставить("Наименование",       РеквизитыВалюты.КодВалютыБуквенный);
					ДопРеквизиты.Вставить("НаименованиеПолное", РеквизитыВалюты.Наименование);
				КонецЕсли;
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ЗначениеСвойстваXDTO(ЭД, "Курс");
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

Процедура УдалитьПрочитатьОтчетОПродажахКомиссионногоТовараXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// уникальный номер ЭД в разрезе участников обмена
	НовыйЭД.ИД = ЭД.Ид;
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Номер);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЭД.Дата);
	
	СвойствоЭД = ЭД.Свойства().Получить("Комитент");
	Комитент = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ПрочитатьДанныеКонтрагента(Комитент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Комитент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Комиссионер");
	Комиссионер = ЭД.Получить(СвойствоЭД);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ПрочитатьДанныеКонтрагента(Комиссионер, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Комиссионер, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	КонецЕсли;
	
	НаборДанных = ЭД["Товары"].Товар;
	УдалитьПрочитатьДанныеПоТЧОтчетаОПродажахКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
	СвойствоЭД = ЭД.Свойства().Получить("ИтогоПоДокументу");
	ИтогоПоДокументу = ЭД.Получить(СвойствоЭД);
	СвойствоСуммаКомитентаИтог = ИтогоПоДокументу.Свойства().Получить("СуммаКомитентаИтог");
	СуммаКомитентаИтог = ИтогоПоДокументу.Получить(СвойствоСуммаКомитентаИтог);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаКомитента", СуммаКомитентаИтог);
	СвойствоСуммаПродажиИтог = ИтогоПоДокументу.Свойства().Получить("СуммаПродажиИтог");
	СуммаПродажиИтог = ИтогоПоДокументу.Получить(СвойствоСуммаПродажиИтог);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", СуммаПродажиИтог);
	СвойствоСуммаВознагражденияИтог = ИтогоПоДокументу.Свойства().Получить("СуммаВознагражденияИтог");
	Если СвойствоСуммаВознагражденияИтог <> Неопределено Тогда
		СуммаВознагражденияИтог = ИтогоПоДокументу.Получить(СвойствоСуммаВознагражденияИтог);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаВознаграждения", СуммаВознагражденияИтог);
	КонецЕсли;
	
	СвойствоПроцент = ИтогоПоДокументу.Свойства().Получить("Процент");
	Если СвойствоПроцент <> Неопределено Тогда
		Процент = ИтогоПоДокументу.Получить(СвойствоПроцент);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПроцентВознаграждения", Процент);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИтогиПрописью", ЭД.ИтогиПрописью);
	
	СвойствоЭД = ЭД.Свойства().Получить("Валюта");
	Если СвойствоЭД <> Неопределено Тогда
		ВалютаXDTO = ЭД.Получить(СвойствоЭД);
		КодВалюты = ВалютаXDTO.КодОКВ;
		Если КодВалюты <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			ДопРеквизиты.Вставить("Наименование", ВалютаXDTO.НаименованиеСокращенноеОКВ);
			ДопРеквизиты.Вставить("НаименованиеПолное", ВалютаXDTO.НаименованиеПолноеОКВ);
			ДопРеквизиты.Вставить("КодМКВ", ВалютаXDTO.КодМКВ);
			
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты, Валюта,
				ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Курс = ВалютаXDTO.Курс;
		Если Курс <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Курс", Курс);
		КонецЕсли;
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ЭтапОплаты");
	Если СвойствоЭД <> Неопределено Тогда
		УдалитьПрочитатьДанныеПоГрафикуОплаты(ЭД.ЭтапОплаты, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ДатаНачала");
	Если СвойствоЭД <> Неопределено Тогда
		ДатаНачала = ЭД.Получить(СвойствоЭД);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НачалоПериода", ДатаНачала);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ДатаКонца");
	Если СвойствоЭД <> Неопределено Тогда
		ДатаКонца = ЭД.Получить(СвойствоЭД);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КонецПериода", ДатаКонца);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ФормаОплаты");
	Если СвойствоЭД <> Неопределено Тогда
		ФормаОплаты = ЭД.Получить(СвойствоЭД);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ФормаОплаты",
			ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ФормыОплаты", ФормаОплаты));
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("СпособРасчета");
	Если СвойствоЭД <> Неопределено Тогда
		СпособРасчета = ЭД.Получить(СвойствоЭД);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СпособРасчетаВознаграждения",
			ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("СпособРасчета", СпособРасчета));
	Иначе
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СпособРасчетаВознаграждения",
			ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("СпособРасчета", НСтр("ru = 'Не рассчитывается'")));
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("ДатаОплаты");
	Если СвойствоЭД <> Неопределено Тогда
		ДатаОплаты = ЭД.Получить(СвойствоЭД);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПлатежа", ДатаОплаты);
	КонецЕсли;
	
	СвойствоЭД = ЭД.Свойства().Получить("Услуга");
	Если СвойствоЭД <> Неопределено Тогда
		Услуга = ЭД.Получить(СвойствоЭД);
		Если Услуга <> Неопределено Тогда
			СвойствоНалог = Услуга.Свойства().Получить("Налог");
			Если СвойствоНалог <> Неопределено Тогда
				Налог = Услуга.Получить(СвойствоНалог);
				Если ВРег(Налог.ТипНалога) = "НДС" Тогда
					СтавкаНалога = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(Налог.ВеличинаСтавкиНалога);
					ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СтавкаНДСВознаграждения", СтавкаНалога);
					
					СвойствоСумма = Налог.Свойства().Получить("Сумма");
					Если СвойствоСумма <> Неопределено Тогда
						ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаНДСВознаграждения", Налог.Сумма);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Услуга", Услуга.Наименование);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьСчетФактуруXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Документ.СвСчФакт.НомерСчФ);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИдФайл);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ДатаИзСтроки(ЭД.Документ.СвСчФакт.ДатаСчФ));
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВалКод", ЭД.Документ.СвСчФакт.КодОКВ);
	Если НЕ ЭД.Документ.СвСчФакт.ИспрСчФ = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерИсправления", ЭД.Документ.СвСчФакт.ИспрСчФ.НомИспрСчФ);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаИсправления", ДатаИзСтроки(ЭД.Документ.СвСчФакт.ИспрСчФ.ДатаИспрСчФ));
	КонецЕсли;
	
	Если НЕ ЭД.Документ.СвСчФакт.ГрузОт = Неопределено Тогда
		Если НЕ ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр = Неопределено Тогда
			Если НЕ ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.НаимГоп.НаимОрг = Неопределено Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Грузоотправитель", ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.НаимГоп.НаимОрг);
			Иначе
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Грузоотправитель",
				ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.НаимГоп.ФИОИП.Фамилия + " " + ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.НаимГоп.ФИОИП.Имя
					+ " " + ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.НаимГоп.ФИОИП.Отчество);
			КонецЕсли;
			Если Не ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.Адрес.АдрИно = Неопределено Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузоотправительАдрес", ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.Адрес.АдрИно.АдрТекст);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузоотправительКодСтраны", ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.Адрес.АдрИно.КодСтр);
			Иначе
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузоотправительАдрес", СоставнойАдрес(ЭД.Документ.СвСчФакт.ГрузОт.ГрузОтпр.Адрес.АдрРФ));
			КонецЕсли
		ИначеЕсли НЕ ЭД.Документ.СвСчФакт.ГрузОт.ОнЖе = Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Грузоотправитель", НСтр("ru = 'он же'"));
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЭД.Документ.СвСчФакт.ГрузПолуч = Неопределено Тогда
		Если НЕ ЭД.Документ.СвСчФакт.ГрузПолуч.НаимГоп.НаимОрг = Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Грузополучатель", ЭД.Документ.СвСчФакт.ГрузПолуч.НаимГоп.НаимОрг);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(
			НовыйЭД,
			"Грузополучатель",
			ЭД.Документ.СвСчФакт.ГрузПолуч.НаимГоп.ФИОИП.Фамилия + " " + ЭД.Документ.СвСчФакт.ГрузПолуч.НаимГоп.ФИОИП.Имя
				+ " " + ЭД.Документ.СвСчФакт.ГрузПолуч.НаимГоп.ФИОИП.Отчество);
		КонецЕсли;
		
		Если НЕ ЭД.Документ.СвСчФакт.ГрузПолуч.Адрес.АдрИно = Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузополучательАдрес", ЭД.Документ.СвСчФакт.ГрузПолуч.Адрес.АдрИно.АдрТекст);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузополучательКодСтраны", ЭД.Документ.СвСчФакт.ГрузПолуч.Адрес.АдрИно.КодСтр);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузополучательАдрес", СоставнойАдрес(ЭД.Документ.СвСчФакт.ГрузПолуч.Адрес.АдрРФ));
		КонецЕсли
	КонецЕсли;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	ИнфПол = ЭД.Документ.СвСчФакт.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено И СтрНайти(ИнфПол.ТекстИнф, "xml") = 0 Тогда
		Если ЭД.ВерсФорм = "5.02" Тогда
			
			ПрочитатьДопДанныеФНС_502(ИнфПол, ДеревоДопДанных, "Шапка");
			
		Иначе
			Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено И СтрНайти(ИнфПол.ТекстИнф, "xml") = 0 Тогда
				ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Комиссионер = Неопределено;
	КомиссионнаяСФ = Ложь;
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
		КомиссионнаяСФ = ЗаполнитьДанныеКомиссионераИзДопДанных(ДеревоРазбора, НовыйЭД, "SFAKT", Ошибка);
		Если Ошибка Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Продавец = ЭД.Документ.СвСчФакт.СвПрод;
	Покупатель = ЭД.Документ.СвСчФакт.СвПокуп;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВыставленныйКомитентом", КомиссионнаяСФ);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ПрочитатьДанныеКонтрагента(Продавец, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Продавец, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		Если КомиссионнаяСФ Тогда
			ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "ПокупательКомиссии");
		Иначе
			ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		КонецЕсли;
	КонецЕсли;
	
	Организация = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Организация", ДеревоРазбора);
	Структура = Новый Структура("Организация", Организация);
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		Если ЗначениеЗаполнено(Организация) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация, Истина);
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЭД.Документ.СвСчФакт.СвПРД = Неопределено И ЭД.Документ.СвСчФакт.СвПРД.Количество() > 0 Тогда
		ПлатежныеДокументы = "";
		ПервыйЭлемент = Истина;
		Для Каждого СтрокаПлатежа Из ЭД.Документ.СвСчФакт.СвПРД Цикл
			ПлатежныеДокументы = ПлатежныеДокументы + ?(ПервыйЭлемент,"",", № ") + СтрокаПлатежа.НомерПРД + " от " + СтрокаПлатежа.ДатаПРД;
			ПервыйЭлемент = Ложь;
		КонецЦикла;
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПлатежныйДокумент", ПлатежныеДокументы);
	КонецЕсли;
	
	Если Не ЭД.Документ.Подписант.Свойства().Получить("ИП") = Неопределено
		И Не ЭД.Документ.Подписант.ИП = Неопределено Тогда
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантИП", ЭД.Документ.Подписант.ИП.ФИО.Фамилия + " "
			+ ЭД.Документ.Подписант.ИП.ФИО.Имя + " " + ЭД.Документ.Подписант.ИП.ФИО.Отчество);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантИННФЛ", ЭД.Документ.Подписант.ИП.ИННФЛ);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантСвГосРегИП", ЭД.Документ.Подписант.ИП.СвГосРегИП);
	ИначеЕсли Не ЭД.Документ.Подписант.Свойства().Получить("ЮЛ") = Неопределено
		И Не ЭД.Документ.Подписант.ЮЛ = Неопределено Тогда
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантЮЛ", ЭД.Документ.Подписант.ЮЛ.ФИО.Фамилия + " "
			+ ЭД.Документ.Подписант.ЮЛ.ФИО.Имя + " " + ЭД.Документ.Подписант.ЮЛ.ФИО.Отчество);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантИННЮЛ", ЭД.Документ.Подписант.ЮЛ.ИННЮЛ);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СтТовБезНДС",ЭД.Документ.ТаблСчФакт.ВсегоОпл.СтТовБезНДСВсего);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СтТовУчНал", ЭД.Документ.ТаблСчФакт.ВсегоОпл.СтТовУчНалВсего);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", ЭД.Документ.ТаблСчФакт.ВсегоОпл.СтТовУчНалВсего);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СумНДС",     СуммаНДССФПривестиКТребуемомуФормату(
		ЭД.Документ.ТаблСчФакт.ВсегоОпл.СумНалВсего.СумНДС));
	
	Для Каждого Товар Из ЭД.Документ.ТаблСчФакт.СведТов Цикл
		
		СписокТЧ = Новый СписокЗначений;
		СписокТЧ.Добавить(Товар.НомСтр,         "НомСтр");
		СписокТЧ.Добавить(Товар.НаимТов,        "НаимТов");
		СписокТЧ.Добавить(Товар.ОКЕИ_Тов,       "ОКЕИ_Тов");
		СписокТЧ.Добавить(Товар.КолТов,         "КолТов");
		СписокТЧ.Добавить(Товар.ЦенаТов,        "ЦенаТов");
		СписокТЧ.Добавить(Товар.СтТовБезНДС,    "СтТовБезНДС");
		СписокТЧ.Добавить(Товар.СтТовУчНал,     "СтТовУчНал");
		Если ЭД.ВерсФорм = "5.01" Тогда
			СписокТЧ.Добавить(Товар.НалСт.НалСтВел, "НалСтВел");
			СписокТЧ.Добавить(Товар.НалСт.НалСтТип, "НалСтТип");
		Иначе
			СписокТЧ.Добавить(Товар.НалСт, "НалСтВел");
		КонецЕсли;
		
		СумАкциз = Товар.Акциз.СумАкциз;
		Если Не ЗначениеЗаполнено(СумАкциз) Тогда
			СумАкциз = Товар.Акциз.БезАкциз;
		КонецЕсли;
		СписокТЧ.Добавить(СумАкциз, "СумАкциз");
		
		СписокТЧ.Добавить(СуммаНДССФПривестиКТребуемомуФормату(Товар.СумНал.СумНДС), "СумНДС");
		Если ЗначениеЗаполнено(Товар.ОКЕИ_Тов) Тогда
			ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(Товар.ОКЕИ_Тов));
			Если ЗначениеЗаполнено(ЕдИзм) Тогда
				СписокТЧ.Добавить(Строка(ЕдИзм), "ЕдиницаИзмерения");
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Товар.ИнфПолСтр) Тогда
			// В инф.поле xml-строка Актуального формата.
			ИнфПол = Товар.ИнфПолСтр;
			Если ЭД.ВерсФорм = "5.01" Тогда
				
				ПрочитатьИнфПол(ИнфПол, ДеревоДопДанных, "Товары", Товар.НомСтр);
				
			Иначе
				
				ПрочитатьДопДанныеТЧ_ФНС502(ИнфПол, ДеревоДопДанных, "Товары", Товар.НомСтр);
				
			КонецЕсли;
			ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, СписокТЧ, Товар.НомСтр, "Товары", Ошибка);
		КонецЕсли;
		
		Если ЭД.ВерсФорм = "5.01" Тогда
			
			Если НЕ Товар.НомерТД = Неопределено И Товар.НомерТД.Количество() > 0 Тогда
				НомераТД = "";
				Для Каждого СтрокаТД Из Товар.НомерТД Цикл
					НомераТД = НомераТД + СтрокаТД + ", ";
				КонецЦикла;
				СписокТЧ.Добавить(НомераТД, "НомерТД");
			КонецЕсли;
			
			Если НЕ Товар.КодПроисх = Неопределено И Товар.КодПроисх.Количество() > 0 Тогда
				СписокТЧ.Добавить(Товар.КодПроисх[0], "КодПроисх");
			КонецЕсли;
			
		Иначе
			НомераТД = "";
			КодПроисх = "";
			НаименованиеСтраныПроисхождения = "";
			
			ДопДанныеТаможеннойДекларации = Неопределено;
			СписокТЧДопДанныеТаможеннойДекларации = СписокТЧ.НайтиПоЗначению("ДопДанныеТаможеннойДекларации");
			Если Не СписокТЧДопДанныеТаможеннойДекларации = Неопределено Тогда 
				ЧтениеXML = Новый ЧтениеXML;
				ЧтениеXML.УстановитьСтроку(СписокТЧДопДанныеТаможеннойДекларации.Представление);
				ДопДанныеТаможеннойДекларации = СериализаторXDTO.ПрочитатьXML(ЧтениеXML, Тип("ТаблицаЗначений"));
			КонецЕсли;
			Для Каждого СведенияТД Из Товар.СвТД Цикл
				НомераТД = НомераТД + СведенияТД.НомерТД;
				КодПроисх = КодПроисх + СведенияТД.КодПроисх;
				Если Не ДопДанныеТаможеннойДекларации = Неопределено Тогда 
					НаименованиеСтраныИзДопДанных = ДопДанныеТаможеннойДекларации.Найти(КодПроисх, "КодСтраныПроисхождения");
					Если Не НаименованиеСтраныИзДопДанных = Неопределено Тогда
						НаименованиеСтраныПроисхождения = НаименованиеСтраныПроисхождения + НаименованиеСтраныИзДопДанных.НаименованиеСтраныПроисхождения;
					КонецЕсли
				КонецЕсли;
			КонецЦикла;
			
			СписокТЧ.Добавить(НомераТД, "НомерТД");
			СписокТЧ.Добавить(КодПроисх, "КодПроисх");
			СписокТЧ.Добавить(НаименованиеСтраныПроисхождения, "НаименованиеСтраныПроисхождения");

			Если Не СписокТЧДопДанныеТаможеннойДекларации = Неопределено Тогда
				СписокТЧ.Удалить(СписокТЧДопДанныеТаможеннойДекларации);
			КонецЕсли;
		КонецЕсли;
		
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
	КонецЦикла;
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьКорректировочныйСчетФактуруXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура;
	НовыйЭД.ОписаниеОбъекта = "Корректировочный";
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Документ.СвКСчФ.НомерКСчФ);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ДатаИзСтроки(ЭД.Документ.СвКСчФ.ДатаКСчФ));
	Если ЭД.ВерсФорм = "5.02" Тогда
		ДанныеСФ = ЭД.Документ.СвКСчФ.СчФ;
		Если ДанныеСФ.Количество() > 0 Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерСчетаФактуры", ДанныеСФ[0].НомерСчФ);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСчетаФактуры", ДанныеСФ[0].ДатаСчФ);
			ИспрСФ = ДанныеСФ[0].ИспрСчФ;
			Если ИспрСФ.Количество() > 0 Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерИсправленияСчетаФактуры", ИспрСФ[0].НомИспрСчФ);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаИсправленияСчетаФактуры", ДатаИзСтроки(ИспрСФ[0].ДатаИспрСчФ));
				
			КонецЕсли;
			
		КонецЕсли;
	Иначе
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерСчетаФактуры", ЭД.Документ.СвКСчФ.НомерСчФ);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаСчетаФактуры", ДатаИзСтроки(ЭД.Документ.СвКСчФ.ДатаСчФ));
		Если НЕ ЭД.Документ.СвКСчФ.Свойства().Получить("ИспрКСчФ") = Неопределено
			И НЕ ЭД.Документ.СвКСчФ.ИспрКСчФ = Неопределено Тогда
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерИсправления", ЭД.Документ.СвКСчФ.ИспрКСчФ.НомИспрКСчФ);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаИсправления", ДатаИзСтроки(ЭД.Документ.СвКСчФ.ИспрКСчФ.ДатаИспрКСчФ));
		КонецЕсли;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВалКод", ЭД.Документ.СвКСчФ.КодОКВ);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИдФайл);
	Если НЕ ЭД.Документ.СвКСчФ.Свойства().Получить("ИспрКСчФ") = Неопределено
		И НЕ ЭД.Документ.СвКСчФ.ИспрКСчФ = Неопределено Тогда
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерИсправления", ЭД.Документ.СвКСчФ.ИспрКСчФ.НомИспрКСчФ);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаИсправления", ДатаИзСтроки(ЭД.Документ.СвКСчФ.ИспрКСчФ.ДатаИспрКСчФ));
	КонецЕсли;
	Если НЕ ЭД.Документ.СвКСчФ.Свойства().Получить("ИспрСчФ") = Неопределено
		И НЕ ЭД.Документ.СвКСчФ.ИспрСчФ = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерИсправленияСчетаФактуры", ЭД.Документ.СвКСчФ.ИспрСчФ.НомИспрСчФ);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаИсправленияСчетаФактуры", ДатаИзСтроки(ЭД.Документ.СвКСчФ.ИспрСчФ.ДатаИспрСчФ));
	КонецЕсли;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	ИнфПол = ЭД.Документ.СвКСчФ.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено И СтрНайти(ИнфПол.ТекстИнф, "xml") = 0 Тогда
		Если ЭД.ВерсФорм = "5.02" Тогда
			ПрочитатьДопДанныеФНС_502(ИнфПол, ДеревоДопДанных, "Шапка");
		Иначе
			ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
		КонецЕсли;
	КонецЕсли;
	
	Комиссионер = Неопределено;
	КомиссионнаяСФ = Ложь;
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
		КомиссионнаяСФ = ЗаполнитьДанныеКомиссионераИзДопДанных(ДеревоРазбора, НовыйЭД, "KORSFAKT", Ошибка);
		Если Ошибка Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Продавец = ЭД.Документ.СвКСчФ.СвПрод;
	Покупатель = ЭД.Документ.СвКСчФ.СвПокуп;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВыставленныйКомитентом", КомиссионнаяСФ);
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ПрочитатьДанныеКонтрагента(Продавец, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Продавец, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		Если КомиссионнаяСФ Тогда
			ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "ПокупательКомиссии");
		Иначе
			ПрочитатьДанныеКонтрагента(Покупатель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		КонецЕсли;
	КонецЕсли;
	
	Организация = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Организация", ДеревоРазбора);
	Структура = Новый Структура("Организация", Организация);
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
		
		Если ЗначениеЗаполнено(Организация) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация, Истина);
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЭД.Документ.Подписант.Свойства().Получить("ИП") = Неопределено
		И Не ЭД.Документ.Подписант.ИП = Неопределено Тогда
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантИП", ЭД.Документ.Подписант.ИП.ФИО.Фамилия + " "
			+ ЭД.Документ.Подписант.ИП.ФИО.Имя + " " + ЭД.Документ.Подписант.ИП.ФИО.Отчество);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантИННФЛ", ЭД.Документ.Подписант.ИП.ИННФЛ);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантСвГосРегИП", ЭД.Документ.Подписант.ИП.СвГосРегИП);
	ИначеЕсли Не ЭД.Документ.Подписант.Свойства().Получить("ЮЛ") = Неопределено
		И Не ЭД.Документ.Подписант.ЮЛ = Неопределено Тогда
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантЮЛ", ЭД.Документ.Подписант.ЮЛ.ФИО.Фамилия + " "
			+ ЭД.Документ.Подписант.ЮЛ.ФИО.Имя + " " + ЭД.Документ.Подписант.ЮЛ.ФИО.Отчество);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПодписантИННЮЛ", ЭД.Документ.Подписант.ЮЛ.ИННЮЛ);
	КонецЕсли;
	
	Если НЕ ЭД.Документ.ТаблКСчФ.Свойства().Получить("ВсегоУвел") = Неопределено
		И НЕ ЭД.Документ.ТаблКСчФ.ВсегоУвел = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СтТовБезНДСВсегоУвел", ЭД.Документ.ТаблКСчФ.ВсегоУвел.СтТовБезНДСВсего);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СтТовУчНалВсегоУвел", ЭД.Документ.ТаблКСчФ.ВсегоУвел.СтТовУчНалВсего);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СумНДСУвел", СуммаНДССФПривестиКТребуемомуФормату(
			ЭД.Документ.ТаблКСчФ.ВсегоУвел.СумНал.СумНДС));
	КонецЕсли;
	
	Если НЕ ЭД.Документ.ТаблКСчФ.Свойства().Получить("ВсегоУм") = Неопределено
		И НЕ ЭД.Документ.ТаблКСчФ.ВсегоУм = Неопределено Тогда
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СтТовБезНДСВсегоУм", ЭД.Документ.ТаблКСчФ.ВсегоУм.СтТовБезНДСВсего);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СтТовУчНалВсегоУм", ЭД.Документ.ТаблКСчФ.ВсегоУм.СтТовУчНалВсего);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СумНДСУм", СуммаНДССФПривестиКТребуемомуФормату(
			ЭД.Документ.ТаблКСчФ.ВсегоУм.СумНал.СумНДС));
	КонецЕсли;
	
	СуммаДокумента = 0;
	
	Для каждого Товар Из ЭД.Документ.ТаблКСчФ.СведТов Цикл
		
		СписокТЧ = Новый СписокЗначений;
		СписокТч.Добавить(Товар.НомСтр, "НомСтр");
		СписокТч.Добавить(Товар.НаимТов, "НаимТов");
		Если НЕ Товар.Свойства().Получить("ОКЕИ_ТовДо") = Неопределено Тогда
			Если ЗначениеЗаполнено(Товар.ОКЕИ_ТовДо) Тогда
				СписокТч.Добавить(Товар.ОКЕИ_ТовДо, "ОКЕИ_ТовДо");
				ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(Товар.ОКЕИ_ТовДо));
				Если ЗначениеЗаполнено(ЕдИзм) Тогда
					СписокТЧ.Добавить(Строка(ЕдИзм), "ЕдиницаИзмеренияДо");
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		Если НЕ Товар.Свойства().Получить("ОКЕИ_ТовПосле") = Неопределено Тогда
			Если ЗначениеЗаполнено(Товар.ОКЕИ_ТовПосле) Тогда
				СписокТч.Добавить(Товар.ОКЕИ_ТовПосле, "ОКЕИ_ТовПосле");
				ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(Товар.ОКЕИ_ТовПосле));
				Если ЗначениеЗаполнено(ЕдИзм) Тогда
					СписокТЧ.Добавить(Строка(ЕдИзм), "ЕдиницаИзмерения");
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		Если НЕ Товар.Свойства().Получить("КолТовДо") = Неопределено Тогда
			СписокТч.Добавить(Товар.КолТовДо, "КолТовДо");
		КонецЕсли;
		Если НЕ Товар.Свойства().Получить("КолТовПосле") = Неопределено Тогда
			СписокТч.Добавить(Товар.КолТовПосле, "КолТовПосле");
		КонецЕсли;
		Если НЕ Товар.Свойства().Получить("ЦенаТовДо") = Неопределено Тогда
			СписокТч.Добавить(Товар.ЦенаТовДо, "ЦенаТовДо");
		КонецЕсли;
		Если НЕ Товар.Свойства().Получить("ЦенаТовПосле") = Неопределено Тогда
			СписокТч.Добавить(Товар.ЦенаТовПосле, "ЦенаТовПосле");
		КонецЕсли;
		
		Если НЕ Товар.Свойства().Получить("СтТовБезНДС") = Неопределено
			И НЕ Товар.СтТовБезНДС = Неопределено Тогда
			СписокТЧ.Добавить(Товар.СтТовБезНДС.СтоимДоИзм, "СтТовБезНДСДоИзм");
			СписокТЧ.Добавить(Товар.СтТовБезНДС.СтоимПослеИзм, "СтТовБезНДСПослеИзм");
			Если НЕ Товар.СтТовБезНДС.Свойства().Получить("СтоимУвел") = Неопределено Тогда
				СписокТЧ.Добавить(Товар.СтТовБезНДС.СтоимУвел, "СтТовБезНДСУвел");
			КонецЕсли;
			Если НЕ Товар.СтТовБезНДС.Свойства().Получить("СтоимУм") = Неопределено Тогда
				СписокТЧ.Добавить(Товар.СтТовБезНДС.СтоимУм, "СтТовБезНДСУм");
			КонецЕсли;
		КонецЕсли;
		
		СписокТч.Добавить(Товар.АкцизДо.СумАкциз, "АкцизДо");
		СписокТч.Добавить(Товар.АкцизПосле.СумАкциз, "АкцизПосле");
		СписокТч.Добавить(Товар.АкцизРазн.СумУвел, "АкцизУвел");
		СписокТч.Добавить(Товар.АкцизРазн.СумУм, "АкцизУм");
		Если ЭД.ВерсФорм = "5.02" Тогда
			СписокТч.Добавить(Товар.НалСтДо, "НалСтВелДо");
			СписокТч.Добавить(Товар.НалСтПосле, "НалСтВелПосле");
			
		Иначе
			СписокТч.Добавить(Товар.НалСтДо.НалСтВел, "НалСтВелДо");
			СписокТч.Добавить(Товар.НалСтДо.НалСтТип, "НалСтТипДо");
			СписокТч.Добавить(Товар.НалСтПосле.НалСтВел, "НалСтВелПосле");
			СписокТч.Добавить(Товар.НалСтПосле.НалСтТип, "НалСтТипПосле");
			
		КонецЕсли;
		
		СписокТч.Добавить(СуммаНДССФПривестиКТребуемомуФормату(Товар.СумНалДо.СумНДС), "СумНДСДо");
		СписокТч.Добавить(СуммаНДССФПривестиКТребуемомуФормату(Товар.СумНалПосле.СумНДС), "СумНДСПосле");
		СписокТч.Добавить(Товар.СумНалРазн.СумУвел, "СумНДСУвел");
		СписокТч.Добавить(Товар.СумНалРазн.СумУм, "СумНДСУм");
		СписокТч.Добавить(Товар.СтТовУчНал.СтоимДоИзм, "СтТовУчНалДоИзм");
		СписокТч.Добавить(Товар.СтТовУчНал.СтоимПослеИзм, "СтТовУчНалПослеИзм");
		СуммаДокумента = СуммаДокумента
						+ ?(ЗначениеЗаполнено(Товар.СтТовУчНал.СтоимПослеИзм), Товар.СтТовУчНал.СтоимПослеИзм, 0);
		Если НЕ Товар.СтТовУчНал.Свойства().Получить("СтоимУвел") = Неопределено Тогда
			СписокТч.Добавить(Товар.СтТовУчНал.СтоимУвел, "СтТовУчНалУвел");
		КонецЕсли;
		Если НЕ Товар.СтТовУчНал.Свойства().Получить("СтоимУм") = Неопределено Тогда
			СписокТч.Добавить(Товар.СтТовУчНал.СтоимУм, "СтТовУчНалУм");
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Товар.ИнфПолСтр) Тогда
			// В инф.поле xml-строка Актуального формата.
			ИнфПол = Товар.ИнфПолСтр;
			Если ЭД.ВерсФорм = "5.02" Тогда
				ПрочитатьДопДанныеТЧ_ФНС502(ИнфПол, ДеревоДопДанных, "Товары", Товар.НомСтр);
			Иначе
				ПрочитатьИнфПол(ИнфПол, ДеревоДопДанных, "Товары", Товар.НомСтр);
			КонецЕсли;
			ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, СписокТЧ, Товар.НомСтр, "Товары", Ошибка);
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
	КонецЦикла;
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", СуммаДокумента);
	
КонецПроцедуры

Процедура ПрочитатьКорректировочныйДокументXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель;
	НовыйЭД.ОписаниеОбъекта = "Корректировочный";
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", ЭД.Документ.СвТНО.ТН.НомТН);
	ДатаДок = ЭД.Документ.СвТНО.ТН.ДатаТН;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ДатаИзСтроки(ДатаДок));
	
	СуммаДокумента = 0;
	Если ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл <> Неопределено
		И ЗначениеЗаполнено(ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумУчНДСВс) Тогда
		
		СуммаДокумента = ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумУчНДСВс;
	ИначеЕсли ЭД.Документ.СвТНО.ОтпускГруз <> Неопределено
		И ЗначениеЗаполнено(ЭД.Документ.СвТНО.ОтпускГруз.СумОтпуск) Тогда
		
		СуммаДокумента = ЭД.Документ.СвТНО.ОтпускГруз.СумОтпуск;
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", СуммаДокумента);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИдФайл);
	
	Грузоотправитель = Неопределено;
	ДопПараметрыГрузоотправителя = Новый Структура;
	Поставщик = ЭД.Документ.СвТНО.Поставщик;
	Если ЭД.Документ.СвТНО.ГрузОт <> Неопределено И ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр <> Неопределено Тогда
		ДопПараметрыГрузоотправителя.Вставить("СтруктурноеПодразделение", ЭД.Документ.СвТНО.ГрузОт.СтруктПодр);
		ДопПараметрыГрузоотправителя.Вставить("ОКДП", ЭД.Документ.СвТНО.ГрузОт.ОКДП);
		Грузоотправитель = ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр;
		Если Не ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт = Неопределено Тогда
			Если НЕ ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Тлф = Неопределено Тогда
				ДопПараметрыГрузоотправителя.Вставить("Телефоны", ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Тлф);
			КонецЕсли;
			Если НЕ ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Факс = Неопределено Тогда
				ДопПараметрыГрузоотправителя.Вставить("Факс", ЭД.Документ.СвТНО.ГрузОт.ГрузОтпр.Контакт.Факс);
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли Поставщик <> Неопределено Тогда
		Грузоотправитель = Поставщик;
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.ОтпускГруз <> Неопределено Тогда
		Если ЭД.Документ.СвТНО.ОтпускГруз.ОтпускРазреш <> Неопределено Тогда
			ДопПараметрыГрузоотправителя.Вставить("ДолжностьРуководителя", ЭД.Документ.СвТНО.ОтпускГруз.ОтпускРазреш.Должность);
			ФИО = ЭД.Документ.СвТНО.ОтпускГруз.ОтпускРазреш.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ДопПараметрыГрузоотправителя.Вставить("ФИОРуководителя", ФамилияИнициалы);
		КонецЕсли;
		Если ЭД.Документ.СвТНО.ОтпускГруз.Бухгалтер <> Неопределено Тогда
			ДопПараметрыГрузоотправителя.Вставить("ДолжностьГлавБухгалтера", ЭД.Документ.СвТНО.ОтпускГруз.Бухгалтер.Должность);
			ФИО = ЭД.Документ.СвТНО.ОтпускГруз.Бухгалтер.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ДопПараметрыГрузоотправителя.Вставить("ФИОГлавБухгалтера", ФамилияИнициалы);
		КонецЕсли;
		Если ЭД.Документ.СвТНО.ОтпускГруз.ОтпускПроизв <> Неопределено Тогда
			ДопПараметрыГрузоотправителя.Вставить("ДолжностьКладовщика", ЭД.Документ.СвТНО.ОтпускГруз.ОтпускПроизв.Должность);
			ФИО = ЭД.Документ.СвТНО.ОтпускГруз.ОтпускПроизв.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ДопПараметрыГрузоотправителя.Вставить("ФИОКладовщика", ФамилияИнициалы);
		КонецЕсли;
	КонецЕсли;
	
	Если Грузоотправитель <> Неопределено Тогда
		ПрочитатьДанныеКонтрагента(Грузоотправитель, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Грузоотправитель");
		Если ДопПараметрыГрузоотправителя.Количество() > 0 Тогда
			ИндексУзла = ДеревоРазбора.Строки.Найти("Грузоотправитель", "Реквизит", Истина);
			Если ИндексУзла <> Неопределено И ЗначениеЗаполнено(ИндексУзла.ЗначениеРеквизита) Тогда
				СтрокаГрузоотправителя = ДеревоРазбора.Строки.Найти(ИндексУзла.ЗначениеРеквизита, "ИндексСтроки", Истина);
				Если СтрокаГрузоотправителя <> Неопределено Тогда
					Для Каждого ДопПараметр Из ДопПараметрыГрузоотправителя Цикл
						ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СтрокаГрузоотправителя, ДопПараметр.Ключ, ДопПараметр.Значение);
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.ГрузПолуч <> Неопределено Тогда
		ПрочитатьДанныеКонтрагента(ЭД.Документ.СвТНО.ГрузПолуч, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Грузополучатель");
	КонецЕсли;
	
	// Грузоотправитель и Поставщик - необязательные элементы xsd-схемы,
	// но один из этих элементов обязательно должен быть заполнен
	// (Согласно подп. "в" п.2 ст. 9 Федерального закона от 21.11.1996 №129-ФЗ).
	Если Поставщик = Неопределено Тогда
		Поставщик = Грузоотправитель;
	КонецЕсли;
	
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий 
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ПрочитатьДанныеКонтрагента(Поставщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	КонецЕсли;
	
	Плательщик = ЭД.Документ.СвТНО.Плательщик;
	Если Плательщик <> Неопределено Тогда
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
			ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			ПрочитатьДанныеКонтрагента(Плательщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
		ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ПрочитатьДанныеКонтрагента(Плательщик, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Продавец");
		КонецЕсли;
	КонецЕсли;
	
	Организация = ПолучитьРеквизитШапкиЭД(НовыйЭД, "Организация", ДеревоРазбора);
	Структура = Новый Структура("Организация", Организация);
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	ИнфПол = ЭД.Документ.СвТНО.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено И СтрНайти(ИнфПол.ТекстИнф, "xml") = 0 Тогда
		ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
	КонецЕсли;
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
		
		СтрокаВалюты = НовыйЭД.Строки.Найти("ВалютаКод", "Реквизит", Истина);
		Если СтрокаВалюты <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
			КодВалюты = СтрокаВалюты.ЗначениеРеквизита;
			ДопРеквизиты = Новый Структура;
			ДопРеквизиты.Вставить("Код", КодВалюты);
			Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(КодВалюты));
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, КодВалюты, НСтр("ru = 'Код валюты:'") + " " + КодВалюты,
				Валюта, ДопРеквизиты, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Организация) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация);
		КонецЕсли;
	КонецЕсли;
	
	ВидОперации = НовыйЭД.Строки.Найти("ВидОперации", "Реквизит", Истина);
	Если ВидОперации <> Неопределено Тогда
		ВидОперации.ЗначениеРеквизита = ПеречислениеИзЗначенияXML(ВидОперации.ЗначениеРеквизита, "ВидыОперацийЭД");
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.Основание <> Неопределено Тогда
		ДатаПоДаннымКлиента = ЭД.Документ.СвТНО.Основание.ДатаОсн;
		Если ЗначениеЗаполнено(ДатаПоДаннымКлиента) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПоДаннымКлиента", Дата(Сред(ДатаПоДаннымКлиента, 7, 4)
				+ Сред(ДатаПоДаннымКлиента, 4, 2) + Сред(ДатаПоДаннымКлиента, 1, 2)));
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НомерПоДаннымКлиента", ЭД.Документ.СвТНО.Основание.НомОсн);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "НаименованиеОснования", ЭД.Документ.СвТНО.Основание.НаимОсн);
	КонецЕсли;
	
	Если ЭД.Документ.СвТНО.ТН.ТНОбщ <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЗаписей", ЭД.Документ.СвТНО.ТН.ТНОбщ.КолНомЗап);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЗаписейПрописью", ЭД.Документ.СвТНО.ТН.ТНОбщ.КолНомЗапПр);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоМест", ЭД.Документ.СвТНО.ТН.ТНОбщ.ВсМест);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоМестПрописью", ЭД.Документ.СвТНО.ТН.ТНОбщ.ВсМестПр);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "МассаГрузаПрописью", ЭД.Документ.СвТНО.ТН.ТНОбщ.БруттоПр);
	КонецЕсли;
	Если ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумБезНДСВс);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаНДС", ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумНДСВс);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаСУчетомНДС", ЭД.Документ.СвТНО.ТН.Таблица.ВсегоНакл.СумУчНДСВс);
	КонецЕсли;
	Если ЭД.Документ.СвТНО.ОтпускГруз <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаВсегоПрописью", ЭД.Документ.СвТНО.ОтпускГруз.СумОтпускПр);
		ДатаДок = ЭД.Документ.СвТНО.ОтпускГруз.ДатаОтпуск;
		Если ЗначениеЗаполнено(ДатаДок) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОтпуска", ДатаИзСтроки(ДатаДок));
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КоличествоЛистовВПрилПрописью", ЭД.Документ.СвТНО.ОтпускГруз.КолПрилПр);
	КонецЕсли;
	
	НаборДанных = ЭД.Документ.СвТНО.ТН.Таблица.СвТов;
	
	// Определяем вариант ЭД для выбора алгоритма заполнения номенклатуры
	АвторЭДПокупатель = Ложь;
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани);
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			НаимТовара = "";
			ИдТовара = "";
			ЕстьДопРеквизиты = Ложь;
			
			СписокТЧ.Добавить(Элемент.НомТов,      "Номер");
			СписокТЧ.Добавить(Элемент.НаимТов,     "Наименование");
			СписокТЧ.Добавить(Элемент.ХарактерТов, "НаименованиеХарактеристики");
			СписокТЧ.Добавить(Элемент.КодТов,      "ТоварКод");
			СписокТЧ.Добавить(Элемент.СортТов,     "Сорт");
			СписокТЧ.Добавить(Элемент.АртикулТов,  "Артикул");
			СписокТЧ.Добавить(Элемент.НаимЕдИзм,   "ЕдиницаИзмеренияНаименование");
			СписокТЧ.Добавить(Элемент.ОКЕИ_Тов,    "ЕдиницаИзмеренияКод");
	
			СписокТЧ.Добавить(Элемент.НеттоДоКорректировки, "КоличествоДоКорректировки");
			СписокТЧ.Добавить(Элемент.Нетто,     "Количество");
			СписокТЧ.Добавить(Элемент.КолМест,   "Мест");
			СписокТЧ.Добавить(Элемент.ВидУпак,   "Упаковка");
			СписокТЧ.Добавить(Элемент.Место,     "КоличествоВОдномМесте");
			СписокТЧ.Добавить(Элемент.НеттоДоКорректировки, "МассаНеттоДоКорректировки");
			СписокТЧ.Добавить(Элемент.Нетто,     "МассаНетто");
			СписокТЧ.Добавить(Элемент.Брутто,    "МассаБрутто");
			СписокТЧ.Добавить(Элемент.ЦенаДоКорректировки,      "ЦенаДоКорректировки");
			СписокТЧ.Добавить(Элемент.Цена,      "Цена");
			СписокТЧ.Добавить(Элемент.СумБезНДСДоКорректировки, "СуммаДоКорректировки");
			СписокТЧ.Добавить(Элемент.СумБезНДС, "Сумма");
			СписокТЧ.Добавить(Элемент.СумНДСДоКорректировки,    "СуммаНДСДоКорректировки");
			СписокТЧ.Добавить(Элемент.СумНДС,    "СуммаНДС");
			СписокТЧ.Добавить(Элемент.СумУчНДСДоКорректировки,  "СуммаСНДСДоКорректировки");
			СписокТЧ.Добавить(Элемент.СумУчНДС,  "СуммаСНДС");
			
			// Удалить первую ветку - нужна лишь, чтобы читать старые документы.
			Если ЗначениеЗаполнено(Элемент.ИнфПолСтр) И СтрНайти(Элемент.ИнфПолСтр, "xml") > 0 Тогда
				
				СписокТЧ.Добавить(Элемент.СтавкаНДС, "СтавкаНДС");
				
				// В инф.поле xml-строка неактуального формата.
				ОбъектXML = Новый ЧтениеXML;
				Попытка
					ОбъектXML.УстановитьСтроку(Элемент.ИнфПолСтр);
					ТоварXDTO = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
					РазобратьСтрокуТЧCML(ТоварXDTO, СписокТЧ, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Элемент.НомТов);
				Исключение
					ВидОперации = НСтр("ru = 'Чтение неактуального формата Корректировочный документ.'");
					ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
					ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
					ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ТекстОшибки, ТекстСообщения);
				КонецПопытки;
			Иначе
				Если ЗначениеЗаполнено(Элемент.ИнфПолСтр) Тогда
					// В инф.поле xml-строка Актуального формата.
					ИнфПол = Элемент.ИнфПолСтр;
					ПрочитатьИнфПол(ИнфПол, ДеревоДопДанных, "Товары", Элемент.НомТов);
					ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, СписокТЧ, Элемент.НомТов, "Товары", Ошибка);
				КонецЕсли;
				РеквизитыНоменклатуры = Новый Структура;
				РеквизитыЕдиницыИзмерения = Новый Структура;
				ИдТовара = "";
				СтавкаНДСПереданаДопПараметром = Ложь;
				ДокументОснованиеНайден = Ложь;
				Для Каждого ЭлементСЗ Из СписокТЧ Цикл
					
					// Номенклатура.
					Если ЭлементСЗ.Представление = "Наименование" Тогда
						РеквизитыНоменклатуры.Вставить("Наименование", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "Характеристика" Тогда
						РеквизитыНоменклатуры.Вставить("Характеристика", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "Артикул" Тогда
						РеквизитыНоменклатуры.Вставить("Артикул", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "ЕдиницаИзмеренияКод" Тогда
						РеквизитыЕдиницыИзмерения.Вставить("Код", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "ЕдиницаИзмеренияНаименование" Тогда
						РеквизитыЕдиницыИзмерения.Вставить("Наименование", ЭлементСЗ.Значение);
					ИначеЕсли ЭлементСЗ.Представление = "ИД" Тогда
						ИдТовара = ЭлементСЗ.Значение;
						
					// Проверка наличия ставки НДС в доп. параметрах.
					ИначеЕсли ЭлементСЗ.Представление = "СтавкаНДС" Тогда
						СтавкаНДСПереданаДопПараметром = Истина;
					ИначеЕсли ЭлементСЗ.Представление = "ИдентификаторДокументаОснования"
						И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
						И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
						// Актуальный алгоритм передачи связки с документами-основаниями.
						// В качестве идентификатора документа-основания во входящем ЭД приходит
						// идентификатор документа ИБ, в результате даже если ЭД для документа-потомка
						// был сформирован и отправлен раньше, чем ЭД документа-основания, после получения
						// ЭД документа-основания можно перезаполнить документ-потомок и ссылка на основание
						// будет найдена.
						СтруктураОтбора = Новый Структура;
						СтруктураОтбора.Вставить("Организация",   Организация);
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
						ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСЗ.Значение, СтруктураОтбора);
						Если ДокументОснование <> Неопределено Тогда
							СписокТЧ.Добавить(ДокументОснование, "ДокументОснование");
							ДокументОснованиеНайден = Истина;
						КонецЕсли;
					ИначеЕсли ЭлементСЗ.Представление = "ИДЭДДокументаОснования"
						И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
						И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
						
						ДокументОснование = ПолучитьДокументОснование(ЭлементСЗ.Значение, Структура);
						Если ДокументОснование <> Неопределено Тогда
							СписокТЧ.Добавить(ДокументОснование, "ДокументОснование");
							ДокументОснованиеНайден = Истина;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
				// Ставка НДС может прийти в доп. параметрах.
				Если НЕ СтавкаНДСПереданаДопПараметром Тогда
					СписокТЧ.Добавить(Элемент.СтавкаНДС, "СтавкаНДС");
				КонецЕсли;
				
				НаимТовара = "";
				РеквизитыНоменклатуры.Свойство("Наименование", НаимТовара);
				
				КодЕдИзм = "";
				Если РеквизитыЕдиницыИзмерения.Свойство("Код", КодЕдИзм) Тогда
					НаименованиеЕдИзм = "";
					РеквизитыЕдиницыИзмерения.Свойство("Наименование", НаименованиеЕдИзм);
					ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(КодЕдИзм),
						РеквизитыЕдиницыИзмерения);
					НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
					НайденнаяСтрока     = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Строка(КодЕдИзм),
						НаименованиеЕдИзм, ЕдИзм, РеквизитыЕдиницыИзмерения, ДеревоРазбора, Ошибка);
					Если ЗначениеЗаполнено(НайденнаяСтрока) Тогда
						РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
					КонецЕсли;
				КонецЕсли;
				
				// Идентификация по номенклатуре компании, когда сторона разбора ЭД - сама компания
				Если ИдентификацияПоНоменклатуреКомпании Тогда
					СтруктураИд = РазобратьИДТовара(ИдТовара);
					Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
					Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
						ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры", СтруктураИд.ИДХарактеристики);
						Если СписокТЧ.НайтиПоЗначению(ХарактеристикаНоменклатуры) <> Неопределено Тогда
							СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
						КонецЕсли;
					КонецЕсли;
					Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
						УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры", СтруктураИд.ИДУпаковки);
						Если СписокТЧ.НайтиПоЗначению(УпаковкаНоменклатуры) <> Неопределено Тогда
							СписокТЧ.Добавить(УпаковкаНоменклатуры, "Упаковка");
						КонецЕсли;
					КонецЕсли;
				Иначе
					// Номенклатура поставщиков.
					РеквизитыНоменклатурыПоставщика = Новый Структура;
					ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
					ВладелецНоменклатуры  = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
					
					РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
					РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ИдТовара);
					Если РеквизитыНоменклатуры.Свойство("Артикул") Тогда
						РеквизитыНоменклатурыПоставщика.Вставить("Артикул", РеквизитыНоменклатуры.Артикул);
					КонецЕсли;
					
					Если ЗначениеЗаполнено(НаимТовара) Тогда
						РеквизитыНоменклатурыПоставщика.Вставить("Наименование", НаимТовара);
					КонецЕсли;
					
					НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
						РеквизитыНоменклатурыПоставщика);
					
					НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
					НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, НоменклатураПоставщика,
						РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
					СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки,"НоменклатураПоставщика");
					
					Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
						РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
						РеквизитыНоменклатурыПоставщика.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
					КонецЕсли;
					СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
					ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(РеквизитыНоменклатурыПоставщика, СтруктураРеквизитовТовара);
					
					Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
					Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Характеристика) Тогда
						СписокТЧ.Добавить(СтруктураРеквизитовТовара.Характеристика, "Характеристика");
					КонецЕсли;
					Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Упаковка) Тогда
						СписокТЧ.Добавить(СтруктураРеквизитовТовара.Упаковка, "Упаковка");
					КонецЕсли;
				КонецЕсли;
				
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
					РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
				СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
		КонецЦикла;
	КонецЕсли;
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьКорректировочныйДокументПолучательXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	
	ИнфПол = ЭД.Документ.СвТНП.ИнфПол;
	Если ИнфПол <> Неопределено И ИнфПол.ТекстИнф <> Неопределено Тогда
		ПрочитатьИнфПол(ИнфПол.ТекстИнф, ДеревоДопДанных, "Шапка");
	КонецЕсли;
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.ИдФайл);
	Если ЭД.Документ.СвТНП.ПолучилГруз <> Неопределено Тогда
		ДатаДок = ЭД.Документ.СвТНП.ПолучилГруз.ДатаПолуч;
		ДатаПолучения = ДатаИзСтроки(ДатаДок);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПолучения", ДатаПолучения);
		Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьНомер", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.НомДоверен);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьДата", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ДатаДоверен);
			ДоверенностьВыдана = "";
			Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем <> Неопределено Тогда
				ВспомогательнаяСтруктура = Новый Структура;
				ВспомогательнаяСтруктура.Вставить("Организация", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.НаимОргКем);
				ВспомогательнаяСтруктура.Вставить("Должность", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ДолжнКем);
				ВспомогательнаяСтруктура.Вставить("ДопСведения", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ДопСведКем);
				Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ФИО <> Неопределено Тогда
					ФИО = ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКем.ФИО;
					ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
					ВспомогательнаяСтруктура.Вставить("ФИО", ФамилияИнициалы);
				КонецЕсли;
				Для Каждого Элемент Из ВспомогательнаяСтруктура Цикл
					Если ЗначениеЗаполнено(Элемент.Значение) Тогда
						ДоверенностьВыдана = ДоверенностьВыдана + ?(ЗначениеЗаполнено(ДоверенностьВыдана), ", ", "") + СокрЛП(Элемент.Значение);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому <> Неопределено Тогда
				ВспомогательнаяСтруктура = Новый Структура;
				ВспомогательнаяСтруктура.Вставить("Должность", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.Должн);
				ВспомогательнаяСтруктура.Вставить("ДопСведения", ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.ДопСведКому);
				Если ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.ФИО <> Неопределено Тогда
					ФИО = ЭД.Документ.СвТНП.ПолучилГруз.Доверенность.ВыданаКому.ФИО;
					ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
					ВспомогательнаяСтруктура.Вставить("ФИО", ФамилияИнициалы);
				КонецЕсли;
				Для Каждого Элемент Из ВспомогательнаяСтруктура Цикл
					Если ЗначениеЗаполнено(Элемент.Значение) Тогда
						ДоверенностьВыдана = ДоверенностьВыдана + ?(ЗначениеЗаполнено(ДоверенностьВыдана), ", ", "") + СокрЛП(Элемент.Значение);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоверенностьВыдана", ДоверенностьВыдана);
		КонецЕсли;
		Если ЭД.Документ.СвТНП.ПолучилГруз.ГрузПринял <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПринялДолжность", ЭД.Документ.СвТНП.ПолучилГруз.ГрузПринял.Должность);
			ФИО = ЭД.Документ.СвТНП.ПолучилГруз.ГрузПринял.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПринялФИО", ФамилияИнициалы);
		КонецЕсли;
		Если ЭД.Документ.СвТНП.ПолучилГруз.ГрузПолучил <> Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилДолжность", ЭД.Документ.СвТНП.ПолучилГруз.ГрузПолучил.Должность);
			ФИО = ЭД.Документ.СвТНП.ПолучилГруз.ГрузПолучил.ФИО;
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО.Фамилия + " " + ФИО.Имя + " " + ФИО.Отчество);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилФИО", ФамилияИнициалы);
		КонецЕсли;
	КонецЕсли;
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьАктНаПередачуПравXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	Документ = ЗначениеСвойстваXDTO(ЭД, "Документ");
	
	Если Документ.ХозОперация = НСтр("ru = 'Передача прав'") Тогда
		НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав;
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаФормирования",
		ЗначениеСвойстваXDTO(ЭД, "ДатаФормирования"));
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(Документ, "Ид"));
	
	// Контрагенты
	Контрагенты = ЗначениеСвойстваXDTO(Документ, "Контрагенты.Контрагент",, Истина);
	Для Каждого Контрагент Из Контрагенты Цикл
		ПрочитатьДанныеКонтрагентаCML(Контрагент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, ЗначениеСвойстваXDTO(Контрагент, "Роль"));
	КонецЦикла;
	
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
	
	ДопРеквизиты = Новый Структура;
	Если ЗначениеЗаполнено(Организация) Тогда
		ДопРеквизиты.Вставить("Организация", Организация);
	КонецЕсли;
	
	ДопРеквизиты.Вставить("НаправлениеЭД", НовыйЭД.НаправлениеЭД);
	
	// Значения реквизитов
	ПрочитатьСписокЗначенийРеквизитовCML(
		ЗначениеСвойстваXDTO(Документ, "ЗначенияРеквизитов.ЗначениеРеквизита",, Истина), НовыйЭД, Ошибка, ДопРеквизиты);
	
	// Читаем доп данные из xdto  и помещаем их в шапку в дерево значений
	ПрочитатьДопДанныеШапкиДокумента(Документ, НовыйЭД, Ошибка, ДопРеквизиты);
	
	ВидОперации = НовыйЭД.Строки.Найти("ВидОперации", "Реквизит", Истина);
	Если ВидОперации <> Неопределено Тогда
		ВидОперации.ЗначениеРеквизита = ПеречислениеИзЗначенияXML(ВидОперации.ЗначениеРеквизита, "ВидыОперацийЭД");
	КонецЕсли;
	
	Для Каждого ТекСвойство Из Документ.Свойства() Цикл
		
		Элемент = Документ.Получить(ТекСвойство);
		Если Элемент = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ЭтоПростойТипЭлементаXDTO(Элемент) Тогда
			Если ТекСвойство.Имя = "Валюта" Тогда
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Валюты");
				
				ДопРеквизиты = Новый Структура;
				ДопРеквизиты.Вставить("Код", Элемент);
				
				Валюта = ЭлектронноеВзаимодействие.НайтиСсылку("Валюты", Строка(Элемент));
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Элемент, НСтр("ru = 'Код валюты:'") + " " + Элемент, Валюта,
					ДопРеквизиты, ДеревоРазбора, Ошибка);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Валюта", НайденнаяСтрока.ИндексСтроки);
			ИначеЕсли ТекСвойство.Имя = "Сумма" Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СуммаДокумента", Число(Элемент));
			ИначеЕсли ТекСвойство.Имя = "Дата" Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ЗначениеСвойстваXDTO(Документ, "Дата", "XMLДата"));
			Иначе
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, ТекСвойство.Имя, Элемент);
			КонецЕсли;
			
		ИначеЕсли ТекСвойство.Имя = "Товары" Тогда
			НаборДанных = ЗначениеСвойстваXDTO(Документ, "Товары.Товар",, Истина);
			ПрочитатьДанныеТЧАктаНаПередачу(НаборДанных, Документ, ДеревоРазбора, НовыйЭД, Ошибка);
			
		ИначеЕсли СтрНайти(НСтр("ru = 'Налоги Скидки ДопРасходы'"), ТекСвойство.Имя) > 0 Тогда
			ДанныеСпискаЗначенийCML(Элемент, НовыйЭД, Ошибка);
			
		ИначеЕсли ТекСвойство.Имя = "Подписанты" Тогда
			ДанныеСпискаЗначенийCML(Элемент, НовыйЭД, Ошибка);
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьДанныеТЧАктаНаПередачу(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани);
	
	ПрочитатьДанныеПоТоваруКаталога(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, ИдентификацияПоНоменклатуреКомпании);
	
КонецПроцедуры

Процедура ПрочитатьРеквизитыОрганизацииXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = "РеквизитыОрганизации";
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИНН",
		ЗначениеСвойстваXDTO(ЭД, "ИНН"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КПП",
		ЗначениеСвойстваXDTO(ЭД, "КПП"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКПО",
		ЗначениеСвойстваXDTO(ЭД, "ОКПО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Наименование",
		ЗначениеСвойстваXDTO(ЭД, "Наименование"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОфициальноеНаименование",
		ЗначениеСвойстваXDTO(ЭД, "ОфициальноеНаименование"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОсновнойВидДеятельности",
		ЗначениеСвойстваXDTO(ЭД, "ОсновнойВидДеятельности"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ЕГРПО",
		ЗначениеСвойстваXDTO(ЭД, "ЕГРПО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКВЭД",
		ЗначениеСвойстваXDTO(ЭД, "ОКВЭД"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКДП",
		ЗначениеСвойстваXDTO(ЭД, "ОКДП"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКОПФ",
		ЗначениеСвойстваXDTO(ЭД, "ОКОПФ"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКФС",
		ЗначениеСвойстваXDTO(ЭД, "ОКФС"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОКПО",
		ЗначениеСвойстваXDTO(ЭД, "ОКПО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаРегистрации",
		ЗначениеСвойстваXDTO(ЭД, "ДатаРегистрации"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПолноеНаименование",
		ЗначениеСвойстваXDTO(ЭД, "ПолноеНаименование"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Обращение",
		ЗначениеСвойстваXDTO(ЭД, "Обращение"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Фамилия",
		ЗначениеСвойстваXDTO(ЭД, "Фамилия"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Имя",
		ЗначениеСвойстваXDTO(ЭД, "Имя"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отчество",
		ЗначениеСвойстваXDTO(ЭД, "Отчество"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаРождения",
		ЗначениеСвойстваXDTO(ЭД, "ДатаРождения"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "МестоРождения",
		ЗначениеСвойстваXDTO(ЭД, "МестоРождения"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Пол",
		ЗначениеСвойстваXDTO(ЭД, "Пол"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "УдостоверениеЛичности",
		ЗначениеСвойстваXDTO(ЭД, "УдостоверениеЛичности"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "АдресРегистрации",
		ЗначениеСвойстваXDTO(ЭД, "АдресРегистрации"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Должность",
		ЗначениеСвойстваXDTO(ЭД, "Должность"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Комментарий",
		ЗначениеСвойстваXDTO(ЭД, "Комментарий"));
	
	ПрочитатьДанныеКонтрагентаCML(ЭД, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, "Покупатель");
	
КонецПроцедуры

Процедура ПрочитатьПередачаТоваровПродавецXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ДеревоЭД = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ТОРГ12_Продавец");
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец;
	
	ИдентификаторДокумента = ЗначениеСвойстваXDTO(ЭД, "ИдФайл");
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ИдентификаторДокумента);
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	
	НомерТоварнойНакладной = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.ИдентДок.НомДокПТ");
	ЗаполнитьРеквизитДерева(ДеревоЭД, "НомерТоварнойНакладной", НомерТоварнойНакладной);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", НомерТоварнойНакладной);
	
	ДатаТоварнойНакладной = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.ИдентДок.ДатаДокПТ", "Дата");
	ЗаполнитьРеквизитДерева(ДеревоЭД, "ДатаТоварнойНакладной", ДатаТоварнойНакладной);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ДатаТоварнойНакладной);
	
	ВставитьЗначениеВДерево(ДеревоЭД, "НаименованиеДокументаОтправителя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.НаимДок.НаимДокОпр"));
	
	Исправление = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.ИспрДокПТ");
	Если Исправление <> Неопределено Тогда
		
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ДатаИсправления",
			ЗначениеСвойстваXDTO(Исправление, "ДатаИспрДокПТ", "Дата"));
		
		ЗаполнитьРеквизитДерева(ДеревоЭД, "НомерИсправления",
			ЗначениеСвойстваXDTO(Исправление, "НомИспрДокПТ"));
			
	КонецЕсли;
	
	ВидОперации = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.ВидОперации");
	Если ВидОперации <> Неопределено Тогда
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ВидОперации", ПеречислениеИзЗначенияXML(ВидОперации, "ВидыОперацийЭД"));
	КонецЕсли;
		
	ЗаполнитьРеквизитДерева(ДеревоЭД, "НаименованиеСоставителяДокумента", ЗначениеСвойстваXDTO(ЭД, "Документ.НаимЭконСубСост"));
	
	КодВалюты = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.ДенИзм.КодОКВ");
	ЗаполнитьРеквизитДерева(ДеревоЭД, "ВалютаКод", КодВалюты);
	
	НаименованиеВалюты = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.ДенИзм.НаимОКВ");
	ЗаполнитьРеквизитДерева(ДеревоЭД, "ВалютаНаименование", НаименованиеВалюты);
	
	Основания = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.Основание",, Истина);
	
	Если Основания <> Неопределено Тогда
		ОснованияДокумента = ШаблонОснованияДокумента();
		Для Каждого СтрокаОснования Из Основания Цикл
			
			Если СтрокаОснования.НаимОсн = "-" Тогда
				Продолжить;
			КонецЕсли;
			
			НоваяСтрока = ОснованияДокумента.Добавить();
			
			НоваяСтрока.ДокОснованиеНаименование = ЗначениеСвойстваXDTO(СтрокаОснования, "НаимОсн");
			НоваяСтрока.ДокОснованиеНомер        = ЗначениеСвойстваXDTO(СтрокаОснования, "НомОсн");
			
			ДатаОсн = ЗначениеСвойстваXDTO(СтрокаОснования, "ДатаОсн");
			Если ДатаОсн <> Неопределено Тогда
				ДокОснованиеДата = ДатаДД_ММ_ГГГГ(ДатаОсн);
				НоваяСтрока.ДокОснованиеДата = ДокОснованиеДата;
			КонецЕсли;
			
			НоваяСтрока.ДокОснованиеДопСведения = ЗначениеСвойстваXDTO(СтрокаОснования, "ДопСвОсн");
			
		КонецЦикла;
	КонецЕсли;
	
	Если ОснованияДокумента.Количество() Тогда
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ОснованияДокумента, "Основание");
	КонецЕсли;
	
	ДопПараметрыГрузоотправителя = Новый Структура;
	
	Грузоотправитель = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.ГрузОтпр");
	ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Грузоотправитель, "Грузоотправитель");
	
	Грузополучатель = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.ГрузПолуч");
	ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Грузополучатель, "Грузополучатель");
	
	Продавец = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.Продавец");
	ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Продавец, "Поставщик");
	
	Покупатель = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СвДокПТПр.СодФХЖ1.Покупатель");
	ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Покупатель, "Плательщик");
	
	// Сведения о организации.
	ВидУчастника = "Поставщик";
	ВидКонтрагента = "Плательщик";
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ВидУчастника = "Плательщик";
		ВидКонтрагента = "Поставщик";
	КонецЕсли;
	РеквизитыУчастникаСделки = ДанныеУчастникаСделки(ДеревоЭД, ВидУчастника);
		
	Организация = Неопределено;
	ОбменСКонтрагентамиПереопределяемый.СсылкаНаОбъектПоИННКПП("Организации",
		РеквизитыУчастникаСделки.ИНН, РеквизитыУчастникаСделки.КПП, Организация);
	
	Если ЗначениеЗаполнено(Организация) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация);
	КонецЕсли;
	
	// Поиск по ИНН, КПП ссылки на контрагента.
	РеквизитыКонтрагента = ДанныеУчастникаСделки(ДеревоЭД, ВидКонтрагента);
	
	// Добавление контрагента в дерево разбора.
	// Используется для поиска контрагента в форме однократной сделки.
	ДобавитьКонтрагентаВДеревоРазбора(ДеревоРазбора, НовыйЭД, ВидКонтрагента, РеквизитыКонтрагента, Ошибка);
	
	СведенияОПередаче = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3");
	
	Если СведенияОПередаче <> Неопределено Тогда
		ДатаДок = ЗначениеСвойстваXDTO(СведенияОПередаче, "ДатаОтпуск", "Дата");
		Если ЗначениеЗаполнено(ДатаДок) Тогда
			ЗаполнитьРеквизитДерева(ДеревоЭД, "СведенияПоОтпускуГруза.ДатаОтпуска", ДатаДок);
		КонецЕсли;
	КонецЕсли;
	
	ЛицоПередавшееГруз = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.СвЛицОтпГруз");
	Если ЛицоПередавшееГруз <> Неопределено Тогда
		ЗаполнитьДанныеЛицаПередавшегоГруз(ДеревоЭД, ЛицоПередавшееГруз);
	КонецЕсли;
	
	Накладные = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.ТранНакл",, Истина);
	Если Накладные <> Неопределено Тогда
		
		ТранспортнаяНакладная = ШаблонТранспортнаяНакладная();
		
		Для Каждого СтрокаНакладная Из Накладные Цикл
			НоваяСтрока = ТранспортнаяНакладная.Добавить();
			НоваяСтрока.ТранспортнаяНакладнаяНомер = ЗначениеСвойстваXDTO(СтрокаНакладная, "НомТранНакл");
			НоваяСтрока.ТранспортнаяНакладнаяДата  = ЗначениеСвойстваXDTO(СтрокаНакладная, "ДатаТранНакл");
		КонецЦикла;
		
		Если ТранспортнаяНакладная.Количество() Тогда
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ТранспортнаяНакладная, "ТранспортнаяНакладная");
		КонецЕсли;
		
	КонецЕсли;
	
	// Чтение дополнительных данных.
	ИнфПол = ЗначениеСвойстваXDTO(СведенияОПередаче, "ИнфПолФХЖ3");
	ПрочитатьДопДанныеФНС_502(ИнфПол, ДеревоДопДанных, "Шапка");
	ПоместитьТабличнуюЧастьВШапкуДокумента(ДеревоЭД, ДеревоДопДанных, "Серии");
	
	// Из дерева доп. данных  получаем ИД документа основания.
	// По Ид документа основания находим документа основания.
	ПараметрыПоиска = Новый Структура("Организация, НаправлениеЭД", Организация, Перечисления.НаправленияЭД.Входящий);
	ЗаполнитьДокументыОснования(ДеревоДопДанных, ПараметрыПоиска, ДеревоЭД);
	
	// Чтение табличной части документа.
	НаборДанных = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СодФХЖ2.СвТов",, Истина);
	Если НаборДанных <> Неопределено Тогда
		
		ТаблицаТоваров = ШаблонТаблицыПередачаТоваров();
		
		Для Каждого Элемент Из НаборДанных Цикл
				
			НоваяСтрока = ТаблицаТоваров.Добавить();
			
			НаименованиеНоменклатуры = ЗначениеСвойстваXDTO(Элемент, "НаимТов");
			НоваяСтрока.НаименованиеНоменклатуры = НаименованиеНоменклатуры;
			
			НаименованиеХарактеристики = ЗначениеСвойстваXDTO(Элемент, "ХарактерТов");
			НоваяСтрока.НаименованиеХарактеристики = НаименованиеХарактеристики;
			
			НоваяСтрока.Сорт                         = ЗначениеСвойстваXDTO(Элемент, "СортТов");
			НоваяСтрока.Артикул                      = ЗначениеСвойстваXDTO(Элемент, "АртикулТов");
			НоваяСтрока.КодТовара                    = ЗначениеСвойстваXDTO(Элемент, "КодТов");
			НоваяСтрока.ЕдиницаИзмеренияНаименование = ЗначениеСвойстваXDTO(Элемент, "НаимЕдИзм");
			НоваяСтрока.БазоваяЕдиницаКод            = ЗначениеСвойстваXDTO(Элемент, "ОКЕИ_Тов");
			НоваяСтрока.КодТовара                    = ЗначениеСвойстваXDTO(Элемент, "КодТов");
			НоваяСтрока.МассаБрутто                  = ЗначениеСвойстваXDTO(Элемент, "Брутто",        "Число");
			НоваяСтрока.МассаНетто                   = ЗначениеСвойстваXDTO(Элемент, "НеттоПередано", "Число");
			НоваяСтрока.КоличествоВОдномМесте        = ЗначениеСвойстваXDTO(Элемент, "Место",         "Число");
			
			КоличествоМест = ЗначениеСвойстваXDTO(Элемент, "КолМест", "Число");
			Если Не ЗначениеЗаполнено(КоличествоМест) Тогда
				КоличествоМест = НоваяСтрока.МассаНетто;
			КонецЕсли;
			НоваяСтрока.КоличествоМест = КоличествоМест;
			
			НоваяСтрока.Цена        = ЗначениеСвойстваXDTO(Элемент, "Цена",     "Число");
			НоваяСтрока.СуммаБезНДС = ЗначениеСвойстваXDTO(Элемент, "СтБезНДС", "Число");
			НоваяСтрока.СуммаНДС    = ЗначениеСвойстваXDTO(Элемент, "СумНДС",   "Число");
			НоваяСтрока.СуммаСНДС   = ЗначениеСвойстваXDTO(Элемент, "СтУчНДС",  "Число");
			НоваяСтрока.СтавкаНДС   = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(Элемент.НалСт);
			
			ИнфПолФХЖ2 = ЗначениеСвойстваXDTO(Элемент, "ИнфПолФХЖ2");
			Если ИнфПолФХЖ2 <> Неопределено Тогда
				
				ИдентификаторыСтрокСерии = ИдентификаторыСерийНоменклатуры();
				
				ПрочитатьДопДанныеТЧ_ФНС502(ИнфПолФХЖ2, ДеревоДопДанных, "Товары", ЗначениеСвойстваXDTO(Элемент, "НомТов"));
				
				ДопРеквизитыСтрокиТч = Новый СписокЗначений;
				ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, ДопРеквизитыСтрокиТч, ЗначениеСвойстваXDTO(Элемент, "НомТов"), "Товары", Ошибка);
				
				ДопДанные = Новый Структура;
				Для Каждого ЭлементСпискаДопДанные Из ДопРеквизитыСтрокиТч Цикл
					
					Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("Ид") Тогда
						ИдТовара = ЭлементСпискаДопДанные.Значение;
						НоваяСтрока.ИдТовараУКонтрагента = ИдТовара;
					КонецЕсли;
					
					Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("НомерСерии") Тогда
						НоваяСтрока.НомерСерии = ЭлементСпискаДопДанные.Значение;
					КонецЕсли;
					
					Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("СрокГодностиСерии") Тогда
						НоваяСтрока.СрокГодностиСерии = ЭлементСпискаДопДанные.Значение;
					КонецЕсли;
					
					Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("ИдентификаторДокументаОснования") Тогда
						ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСпискаДопДанные.Значение, ПараметрыПоиска);
						НоваяСтрока.ДокументОснование = ДокументОснование;
					КонецЕсли;
					Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("ИДЭДДокументаОснования") Тогда
						ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСпискаДопДанные.Значение, ПараметрыПоиска);
						НоваяСтрока.ДокументОснование = ДокументОснование;
					КонецЕсли;
						
					ДопДанные.Вставить(СтрокаВКлючСтруктуры(ЭлементСпискаДопДанные.Представление), ЭлементСпискаДопДанные.Значение);
					
				КонецЦикла;
				Если ДопДанные.Количество()> 0 Тогда
					НоваяСтрока.ДопДанныеПодписанные = ДопДанные;
				КонецЕсли;
				
				ДопРеквизитыСтрокиТчНеПодписанные = Новый СписокЗначений;
				ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, ДопРеквизитыСтрокиТчНеПодписанные, Элемент.НомТов, "Товары", Ошибка, Ложь);
				
				ДопДанныеНеПодписанные = Новый Структура;
				Для Каждого ЭлементСпискаНеПодписанные Из ДопРеквизитыСтрокиТчНеПодписанные Цикл
					ДопДанныеНеПодписанные.Вставить(ЭлементСпискаНеПодписанные.Представление, ЭлементСпискаНеПодписанные.Значение);
				КонецЦикла;
				
				Если ДопДанныеНеПодписанные.Количество()> 0 Тогда
					НоваяСтрока.ДопДанныеНеПодписанные = ДопДанныеНеПодписанные;
				КонецЕсли;
				
				НоваяСтрокаСерии = ИдентификаторыСтрокСерии.Добавить();
				НоваяСтрокаСерии.Идентификатор  = ИдТовара;
				НоваяСтрокаСерии.Номенклатура   = НаименованиеНоменклатуры;
				НоваяСтрокаСерии.Характеристика = НаименованиеХарактеристики;

			КонецЕсли;
			
			// Заполним идентификатор товара / услуги по наименованию, если не был передан идентификатор номенклатуры.
			Если Не ЗначениеЗаполнено(НоваяСтрока.ИдТовараУКонтрагента) Тогда
				СлужебныйИД = НоваяСтрока.НаименованиеНоменклатуры
					+ "#" + НоваяСтрока.НаименованиеХарактеристики
					+ "#" + НоваяСтрока.КодТовара
					+ "#" + НоваяСтрока.Артикул;
				СлужебныйИД = ВРег(СтрЗаменить(СлужебныйИД, " ", ""));
				НоваяСтрока.ИдТовараУКонтрагента = ИдентификаторТовараПоСтроке(СлужебныйИД);
			КонецЕсли;
			
		КонецЦикла;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ТаблицаТоваров, "ТаблицаТоваров");
	
	КонецЕсли;
	
	СуммаСНДС = 0;
	// Чтение итогов документа
	Всего = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СодФХЖ2.Всего");
	Если Всего <> Неопределено Тогда
		
		Итоги = Всего;
		
		Если ЕстьСвойствоXDTO(Итоги, "БруттоВс") Тогда
			МассаБрутто = ЗначениеСвойстваXDTO(Итоги, "БруттоВс", "Число");
			ЗаполнитьРеквизитДерева(ДеревоЭД, "ВсегоПоНакладной.МассаБрутто", МассаБрутто);
		КонецЕсли;
		
		Если ЕстьСвойствоXDTO(Итоги, "НеттоВс") Тогда
			МассаНетто = ЗначениеСвойстваXDTO(Итоги, "НеттоВс");
			ЗаполнитьРеквизитДерева(ДеревоЭД, "ВсегоПоНакладной.МассаНетто", МассаНетто);
		КонецЕсли;
		
		Если ЕстьСвойствоXDTO(Итоги, "СтБезНДСВс") Тогда
			СуммаБезНДС = ЗначениеСвойстваXDTO(Итоги, "СтБезНДСВс", "Число");
			ЗаполнитьРеквизитДерева(ДеревоЭД, "ВсегоПоНакладной.СуммаБезНДС", СуммаБезНДС, Истина);
		КонецЕсли;
		
		Если ЕстьСвойствоXDTO(Итоги, "СумНДСВс") Тогда
			СуммаНДС = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СодФХЖ2.Всего.СумНДСВс", "Число");
			ЗаполнитьРеквизитДерева(ДеревоЭД, "ВсегоПоНакладной.СуммаНДС", СуммаНДС, Истина);
		КонецЕсли;
		
		Если ЕстьСвойствоXDTO(Итоги, "СтУчНДСВс") Тогда
			СуммаСНДС = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПТПрКроме.СодФХЖ2.Всего.СтУчНДСВс", "Число");
			ЗаполнитьРеквизитДерева(ДеревоЭД, "ВсегоПоНакладной.СуммаСНДС", СуммаСНДС, Истина);
			
		КонецЕсли;
		
	КонецЕсли;
	
	СуммаДокумента = СуммаСНДС;
	Если СуммаДокумента = 0 Тогда
		СуммаДокумента = ТаблицаТоваров.Итог("СуммаСНДС");
		Если СуммаДокумента = 0 Тогда
			СуммаДокумента = ТаблицаТоваров.Итог("СуммаБезНДС")+ ТаблицаТоваров.Итог("СуммаНДС");
		КонецЕсли;
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", СуммаДокумента);
	
	ПрочитатьПодписанта(НовыйЭД, ЭД.Документ);
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	ПоместитьДопДанныеВДеревоЭД(ДеревоЭД, ДеревоДопДанных);
	
	НовыйЭД.ЗначениеРеквизита = ДеревоЭД;
	НовыйЭД.ОписаниеОбъекта = "ПередачаТоваров";
	
КонецПроцедуры

Функция ШаблонТаблицыПередачаТоваров()
	
	МакетПередачаТоваров = МакетЭлектронногоДокумента("ТОРГ12_Продавец");
	ОбластьТовары = МакетПередачаТоваров.ПолучитьОбласть("Товары");
	ВысотаОбласти = ОбластьТовары.ВысотаТаблицы;
	
	Товары = Новый ТаблицаЗначений;
	
	Для н = 3 По ВысотаОбласти Цикл
		ЯчейкаТовары = ОбластьТовары.Область(н,3);
		Товары.Колонки.Добавить(ЯчейкаТовары.Текст);
	КонецЦикла;
	
	Возврат Товары;
	
КонецФункции

Функция ШаблонТаблицыПередачаРабот()
	
	МакетПередачаТоваров = МакетЭлектронногоДокумента("Акт501_Исполнитель");
	ОбластьУслуги = МакетПередачаТоваров.ПолучитьОбласть("Услуги");
	ВысотаОбласти = ОбластьУслуги.ВысотаТаблицы;
	
	Услуги = Новый ТаблицаЗначений;
	
	Для н = 3 По ВысотаОбласти Цикл
		ЯчейкаТовары = ОбластьУслуги.Область(н,3);
		Услуги.Колонки.Добавить(ЯчейкаТовары.Текст);
	КонецЦикла;
	
	Возврат Услуги;

КонецФункции

Процедура ПрочитатьПередачаТоваровПокупательXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ4.ГрузПолучил") <> Неопределено Тогда
		
		ДатаДок = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ4.ГрузПолучил.ДатаПолуч", "Дата");
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПолучения", ДатаДок);
		
		Если ЕстьСвойствоXDTO(ЭД.Документ.СодФХЖ4.ГрузПолучил, "СвЛицПолГруз") Тогда
			
			ЛицоГрузополучатель = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ4.ГрузПолучил.СвЛицПолГруз");
			Если ЛицоГрузополучатель <> Неопределено Тогда
				
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПринялДолжность",
					ЗначениеСвойстваXDTO(ЛицоГрузополучатель, "РабОргПок.Должность"));
					
				ФИО = ЗначениеСвойстваXDTO(ЛицоГрузополучатель, "РабОргПок.ФИО");
				ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(
					ЗначениеСвойстваXDTO(ФИО, "Фамилия", "Строка") + " "
						+ ЗначениеСвойстваXDTO(ФИО, "Имя", "Строка") + " "
						+ ЗначениеСвойстваXDTO(ФИО, "Отчество", "Строка"));
						
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПринялФИО", ФамилияИнициалы);
				
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Подписант = ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант");
	
	Если Подписант <> Неопределено Тогда
		
		Если ТипЗнч(Подписант) = Тип("СписокXDTO") Тогда
			ИндексПодписанта = ЭД.Документ.Подписант.Количество() - 1;
			Подписант = ЭД.Документ.Подписант[ИндексПодписанта];
		КонецЕсли;
		
		Если ЗначениеСвойстваXDTO(Подписант, "ФЛ") <> Неопределено Тогда
			
			ФИО = Новый Структура;
			ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(Подписант, "ФЛ.ФИО.Фамилия",  "Строка"));
			ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(Подписант, "ФЛ.ФИО.Имя",      "Строка"));
			ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(Подписант, "ФЛ.ФИО.Отчество", "Строка"));
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилФИО",
				ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилДолжность", "");
			
		ИначеЕсли ЗначениеСвойстваXDTO(Подписант, "ИП") <> Неопределено Тогда
			
			ФИО = Новый Структура;
			ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(Подписант, "ИП.ФИО.Фамилия",  "Строка"));
			ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(Подписант, "ИП.ФИО.Имя",      "Строка"));
			ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(Подписант, "ИП.ФИО.Отчество", "Строка"));
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилФИО",
				ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилДолжность", НСтр("ru = 'ИП'"));
			
		ИначеЕсли ЗначениеСвойстваXDTO(Подписант, "ЮЛ") <> Неопределено Тогда
			
			ФИО = Новый Структура;
			ФИО.Вставить("Фамилия",  ЗначениеСвойстваXDTO(Подписант, "ЮЛ.ФИО.Фамилия",  "Строка"));
			ФИО.Вставить("Имя",      ЗначениеСвойстваXDTO(Подписант, "ЮЛ.ФИО.Имя",      "Строка"));
			ФИО.Вставить("Отчество", ЗначениеСвойстваXDTO(Подписант, "ЮЛ.ФИО.Отчество", "Строка"));
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилФИО",
				ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ГрузПолучилДолжность",Подписант.ЮЛ.Должн);
			
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьПередачаРаботИсполнительXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИдентификаторДокумента", ЗначениеСвойстваXDTO(ЭД, "ИДФайл"));
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	
	ИнфПол = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ2.ИнфПолФХЖ2");
	ПрочитатьДопДанныеФНС_502(ИнфПол, ДеревоДопДанных, "Шапка");
	
	ДеревоЭД = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.Акт501_Исполнитель");
	
	НомерАкта = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.ИдентДок.НомДокПРУ");
	ЗаполнитьРеквизитДерева(ДеревоЭД, "НомерАкта", НомерАкта);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Номер", НомерАкта);
	
	ДатаАкта = ДатаИзСтроки(ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.ИдентДок.ДатаДокПРУ"));
	ЗаполнитьРеквизитДерева(ДеревоЭД, "ДатаАкта", ДатаАкта);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Дата", ДатаАкта);
	
	ВставитьЗначениеВДерево(ДеревоЭД, "НаименованиеДокументаОтправителя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.НаимДок.НаимДокОпр"));
	
	Исполнитель = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.СодФХЖ1.Исполнитель");
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Исполнитель, "Исполнитель");
		
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Исполнитель, "Заказчик");
		
	КонецЕсли;
	
	Заказчик = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.СодФХЖ1.Заказчик");
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Заказчик, "Заказчик");
		
	ИначеЕсли НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоЭД, Заказчик, "Исполнитель");
		
	КонецЕсли;
	
	ВидУчастника = "Заказчик";
	ВидКонтрагента = "Исполнитель";
	Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ВидУчастника = "Исполнитель";
		ВидКонтрагента = "Заказчик";
	КонецЕсли;
	
	РеквизитыУчастникаСделки = ДанныеУчастникаСделки(ДеревоЭД, ВидУчастника);
	
	Организация = Неопределено; 
	ОбменСКонтрагентамиПереопределяемый.СсылкаНаОбъектПоИННКПП("Организации",
		РеквизитыУчастникаСделки.ИНН, РеквизитыУчастникаСделки.КПП, Организация);
		
	Структура = Новый Структура("Организация", Организация);
	
	ЗаполнитьРеквизитДерева(ДеревоЭД, "ВалютаКод",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.ДенИзм.КодОКВ"));
	
	ЗаполнитьРеквизитДерева(ДеревоЭД, "ВалютаНаименование",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.ДенИзм.НаимОКВ"));
	
	Основания = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.СодФХЖ1.Основание");
	ОснованияДокумента = ШаблонОснованияДокумента();
	
	Если ТипЗнч(Основания) = Тип("ОбъектXDTO") Тогда
		
		НоваяСтрока = ОснованияДокумента.Добавить();
		НоваяСтрока.ДокОснованиеНаименование = ЗначениеСвойстваXDTO(Основания, "НаимОсн");
		НоваяСтрока.ДокОснованиеНомер        = ЗначениеСвойстваXDTO(Основания, "НомОсн");
		ДатаОсн = ЭлектронноеВзаимодействиеСлужебный.ЗначениеСвойстваXDTO(Основания, "ДатаОсн");
		Если ЗначениеЗаполнено(ДатаОсн) Тогда
			ДокОснованиеДата = ДатаДД_ММ_ГГГГ(ДатаОсн);
			НоваяСтрока.ДокОснованиеДата = ДатаОсн;
		КонецЕсли;
		НоваяСтрока.ДокОснованиеДопСведения = ЗначениеСвойстваXDTO(Основания, "ДопСвОсн");
		
	Иначе
		
		Для Каждого СтрокаОснования Из Основания Цикл
			Если СтрокаОснования.НаимОсн = "-" Тогда
				Продолжить;
			КонецЕсли;
			НоваяСтрока = ОснованияДокумента.Добавить();
			НоваяСтрока.ДокОснованиеНаименование = ЗначениеСвойстваXDTO(СтрокаОснования, "НаимОсн");
			НоваяСтрока.ДокОснованиеНомер        = ЗначениеСвойстваXDTO(СтрокаОснования, "НомОсн");
			ДатаОсн = ЭлектронноеВзаимодействиеСлужебный.ЗначениеСвойстваXDTO(СтрокаОснования, "ДатаОсн");
			Если ЗначениеЗаполнено(ДатаОсн) Тогда
				ДокОснованиеДата = ДатаДД_ММ_ГГГГ(ДатаОсн);
				НоваяСтрока.ДокОснованиеДата = ДатаОсн;
			КонецЕсли;
			НоваяСтрока.ДокОснованиеДопСведения = ЗначениеСвойстваXDTO(СтрокаОснования, "ДопСвОсн");
		КонецЦикла;
		
	КонецЕсли;
	
	Если ОснованияДокумента.Количество() Тогда
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ОснованияДокумента, "Основание");
	КонецЕсли;

	Если ЗначениеЗаполнено(Организация) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация);
	КонецЕсли;
	
	ВидОперации = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.СодФХЖ1.ВидОперации");
	Если ЗначениеЗаполнено(ВидОперации) Тогда
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ВидОперации", ПеречислениеИзЗначенияXML(ВидОперации, "ВидыОперацийЭД"));
	КонецЕсли;
	
	ЗаполнитьРеквизитДерева(ДеревоЭД, "Заголовок", ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.СодФХЖ1.ЗагСодОпер"));
	
	// Поиск по ИНН, КПП ссылки на контрагента.
	РеквизитыКонтрагента = ДанныеУчастникаСделки(ДеревоЭД, ВидКонтрагента);
	
	// Добавление контрагента в дерево разбора.
	// Используется для поиска контрагента в форме однократной сделки.
	ДобавитьКонтрагентаВДеревоРазбора(ДеревоРазбора, НовыйЭД, ВидКонтрагента, РеквизитыКонтрагента, Ошибка);
	
	ДатаИсправления = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.ИспрДокПРУ.ДатаИспрДокПРУ");
	Если ЗначениеЗаполнено(ДатаИсправления) Тогда
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ДатаИсправления", ДатаИзСтроки(ДатаИсправления));
	КонецЕсли;
		
	ЗаполнитьРеквизитДерева(ДеревоЭД, "НомерИсправления",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.ИспрДокПРУ.НомИспрДокПРУ"));
	
	ИтогДокумента = ЗначениеСвойстваXDTO(ЭД, "Документ.СвДокПРУ.СодФХЖ1.ОписРабот");
	
	СуммаСНДС = 0;
	Если ИтогДокумента <> Неопределено Тогда
		
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ОписаниеУслуги.НачалоРабот",
			ЗначениеСвойстваXDTO(ИтогДокумента, "НачРабот"));
			
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ОписаниеУслуги.КонецРабот",
			ЗначениеСвойстваXDTO(ИтогДокумента, "КонРабот"));
			
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ОписаниеУслуги.СуммаБезНДСИтого",
			ЗначениеСвойстваXDTO(ИтогДокумента, "СтБезНДСИт", "Число"));
			
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ОписаниеУслуги.СуммаНДСИтого",
			ЗначениеСвойстваXDTO(ИтогДокумента, "СумНДСИт", "Число"));
		
		СуммаСНДС = ЗначениеСвойстваXDTO(ИтогДокумента, "СтУчНДСИт", "Число");
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ОписаниеУслуги.СуммаСНДСИтого", СуммаСНДС);
		
	КонецЕсли;
	
	// Из дерева доп. данных  получаем ИД документа основания.
	// По Ид документа основания находим документа основания.
	ПараметрыПоиска = Новый Структура("Организация, НаправлениеЭД", Организация, Перечисления.НаправленияЭД.Входящий);
	ЗаполнитьДокументыОснования(ДеревоДопДанных, ПараметрыПоиска, ДеревоЭД);
	
	ДатаИсполнения = ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ2.ДатаПер");
	Если ЗначениеЗаполнено(ДатаИсполнения) Тогда
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ДатаИсполнения", ДатаИзСтроки(ДатаИсполнения));
	КонецЕсли;
		
	Если ИтогДокумента <> Неопределено И ТипЗнч(ИтогДокумента) = Тип("ОбъектXDTO") Тогда
		
		ТаблицаУслуг = ШаблонТаблицыПередачаРабот();
		ДокументОснованиеНайден = Ложь;
		
		Работы = ЗначениеСвойстваXDTO(ИтогДокумента, "Работа",, Истина);
		Если Работы <> Неопределено Тогда
			Для Каждого Элемент Из Работы Цикл
				
				НоваяСтрока = ТаблицаУслуг.Добавить();
				
				НоваяСтрока.НаименованиеНоменклатуры     = ЗначениеСвойстваXDTO(Элемент, "НаимРабот");
				НоваяСтрока.Описание                     = ЗначениеСвойстваXDTO(Элемент, "Описание");
				НоваяСтрока.ЕдиницаИзмеренияНаименование = ЗначениеСвойстваXDTO(Элемент, "НаимЕдИзм");
				
				// Код 0000 используется из-за требования стандарта.
				КодОКЕИ = ЗначениеСвойстваXDTO(Элемент, "ОКЕИ");
				Если КодОКЕИ = "0000" Тогда
					КодОКЕИ = "";
				КонецЕсли;
				
				НоваяСтрока.ЕдиницаИзмеренияКод = КодОКЕИ;
				НоваяСтрока.Количество  = ЗначениеСвойстваXDTO(Элемент, "Количество",  "Число");
				НоваяСтрока.Цена        = ЗначениеСвойстваXDTO(Элемент, "Цена",        "Число");
				НоваяСтрока.СуммаБезНДС = ЗначениеСвойстваXDTO(Элемент, "СтоимБезНДС", "Число");
				НоваяСтрока.СуммаНДС    = ЗначениеСвойстваXDTO(Элемент, "СумНДС",      "Число");
				НоваяСтрока.СуммаСНДС   = ЗначениеСвойстваXDTO(Элемент, "СтоимУчНДС",  "Число");
				НоваяСтрока.СтавкаНДС   = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(ЗначениеСвойстваXDTO(Элемент, "НалСт"));
				
				ДопРеквизитыСтрокиТч = Новый СписокЗначений;
				
				Если ЗначениеСвойстваXDTO(Элемент, "ИнфПолеОписРабот") <> Неопределено Тогда
					ПрочитатьДопДанныеТЧ_ФНС502(Элемент.ИнфПолеОписРабот, ДеревоДопДанных, "Услуги","1." + ЗначениеСвойстваXDTO(Элемент, "Номер"));
					ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, ДопРеквизитыСтрокиТч, "1." + ЗначениеСвойстваXDTO(Элемент, "Номер"), "Услуги", Ошибка);
				КонецЕсли;
				
				Для Каждого ЭлементСЗ Из ДопРеквизитыСтрокиТч Цикл
					
					// Номенклатура.
					Если ЭлементСЗ.Представление = "ИД" Тогда
						НоваяСтрока.ИдТовараУКонтрагента = ЭлементСЗ.Значение;
						
					ИначеЕсли ЭлементСЗ.Представление = "НалСт" Тогда
						ЭлементСЗ.Значение = ЭлементСЗ.Значение;
						НоваяСтрока.СтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(ЭлементСЗ.Значение);
						
					ИначеЕсли ЭлементСЗ.Представление = "ИдентификаторДокументаОснования"
						И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
						И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
						
						// Актуальный алгоритм передачи связки с документами-основаниями.
						// В качестве идентификатора документа-основания во входящем ЭД приходит
						// идентификатор документа ИБ, в результате даже если ЭД для документа-потомка
						// был сформирован и отправлен раньше, чем ЭД документа-основания, после получения
						// ЭД документа-основания можно перезаполнить документ-потомок и ссылка на основание
						// будет найдена.
						
						СтруктураОтбора = Новый Структура;
						СтруктураОтбора.Вставить("Организация",   Организация);
						СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
						ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСЗ.Значение, СтруктураОтбора);
						Если ДокументОснование <> Неопределено Тогда
							ДопРеквизитыСтрокиТч.Добавить(ДокументОснование, "ДокументОснование");
							ДокументОснованиеНайден = Истина;
						КонецЕсли;
						
					ИначеЕсли ЭлементСЗ.Представление = "ИДЭДДокументаОснования"
						И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
						И НЕ ДокументОснованиеНайден И ЗначениеЗаполнено(Организация) Тогда
						
						ДокументОснование = ПолучитьДокументОснование(ЭлементСЗ.Значение, Структура);
						Если ДокументОснование <> Неопределено Тогда
							ДопРеквизитыСтрокиТч.Добавить(ДокументОснование, "ДокументОснование");
							ДокументОснованиеНайден = Истина;
						КонецЕсли;
						
					КонецЕсли;
					
					ДопДанные = Новый Структура;
					
					Для Каждого ЭлементСпискаДопДанные Из ДопРеквизитыСтрокиТч Цикл
						Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("Ид") Тогда
							НоваяСтрока.ИдТовараУКонтрагента = ЭлементСпискаДопДанные.Значение;
						КонецЕсли;
						Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("ИдентификаторДокументаОснования") Тогда
							ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСпискаДопДанные.Значение, ПараметрыПоиска);
							НоваяСтрока.ДокументОснование = ДокументОснование;
						КонецЕсли;
						Если ВРег(ЭлементСпискаДопДанные.Представление) = ВРег("ИДЭДДокументаОснования") Тогда
							ДокументОснование = ДокументОснованиеПоИдентификатору(ЭлементСпискаДопДанные.Значение, ПараметрыПоиска);
							НоваяСтрока.ДокументОснование = ДокументОснование;
						КонецЕсли;
						
						ДопДанные.Вставить(СтрокаВКлючСтруктуры(ЭлементСпискаДопДанные.Представление), ЭлементСпискаДопДанные.Значение);
						
					КонецЦикла;
					
					Если ДопДанные.Количество()> 0 Тогда
						НоваяСтрока.ДопДанныеПодписанные = ДопДанные;
					КонецЕсли;
					
					ДопРеквизитыСтрокиТчНеПодписанные = Новый СписокЗначений;
					ЗаполнитьСтрокуТЧПоДопДанным(
						ДеревоДопДанных, ДопРеквизитыСтрокиТчНеПодписанные, ЗначениеСвойстваXDTO(Элемент, "Номер"), "Услуги", Ошибка, Ложь);
					
					ДопДанныеНеПодписанные = Новый Структура;
					Для Каждого ЭлементСпискаНеПодписанные Из ДопРеквизитыСтрокиТчНеПодписанные Цикл
						ДопДанныеНеПодписанные.Вставить(ЭлементСпискаНеПодписанные.Представление, ЭлементСпискаНеПодписанные.Значение);
					КонецЦикла;
					
					Если ДопДанныеНеПодписанные.Количество() Тогда
						НоваяСтрока.ДопДанныеНеПодписанные = ДопДанныеНеПодписанные;
					КонецЕсли;
					
				КонецЦикла;
				
			КонецЦикла;
		КонецЕсли;
		
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ТаблицаУслуг, "ТаблицаУслуг");
		
	КонецЕсли;
	
	Подписанты = ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант");
	Если Подписанты <> Неопределено Тогда
		
		ЮрЛицо = ЗначениеСвойстваXDTO(Подписанты, "ЮЛ");
		Если ЮрЛицо <> Неопределено Тогда
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СдалДолжность", 
				ЗначениеСвойстваXDTO(ЮрЛицо, "Должн"));
			
			ФИО = ЗначениеСвойстваXDTO(ЮрЛицо, "ФИО");
			Если ФИО <> Неопределено Тогда
				
				ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(
					ЗначениеСвойстваXDTO(ФИО, "Фамилия", "Строка")
					+ " "
					+ ЗначениеСвойстваXDTO(ФИО, "Имя", "Строка")
					+ " "
					+ ЗначениеСвойстваXDTO(ФИО, "Отчество", "Строка"));
					
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СдалФИО", ФамилияИнициалы);
				
			КонецЕсли;
			
		КонецЕсли;
		
		ИП = ЗначениеСвойстваXDTO(Подписанты, "ИП");
		Если ИП <> Неопределено Тогда
			ФИО = ЗначениеСвойстваXDTO(ИП, "ФИО");
			
			ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(
				ЗначениеСвойстваXDTO(ФИО, "Фамилия",  "Строка")
				+ " "
				+ ЗначениеСвойстваXDTO(ФИО, "Имя",      "Строка")
				+ " "
				+ ЗначениеСвойстваXDTO(ФИО, "Отчество", "Строка"));
				
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "СдалФИО", ФамилияИнициалы);
				
		КонецЕсли;
		
	КонецЕсли;
	
	Если СуммаСНДС = 0 Тогда
		СуммаСНДС = ТаблицаУслуг.Итог("СуммаСНДС");
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Сумма", СуммаСНДС);
	
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	ПоместитьДопДанныеВДеревоЭД(ДеревоЭД, ДеревоДопДанных);
	
	НовыйЭД.ЗначениеРеквизита = ДеревоЭД;
	НовыйЭД.ОписаниеОбъекта = "ПередачаРезультатовРабот";
	
КонецПроцедуры

Процедура ПрочитатьПередачаРаботЗаказчикXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.АктЗаказчик;
	
	ДеревоДопДанных = Неопределено;
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева <> Неопределено И ТипЗнч(СтрокаДерева.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДерева.ЗначениеРеквизита;
	КонецЕсли;
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ИдентификаторДокумента", ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(
		НовыйЭД, "ДатаПолучения", ЗначениеСвойстваXDTO(ЭД, "Документ.СодФХЖ3.РезПринял.ДатаПрием", "Дата"));
	
	Подписант = ЗначениеСвойстваXDTO(ЭД, "Документ.Подписант");
	
	ИП = ЗначениеСвойстваXDTO(Подписант, "ИП");
	Если ИП <> Неопределено Тогда
		
		ФИО = ИП.ФИО;
		ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(
			ЗначениеСвойстваXDTO(ФИО, "Фамилия", "Строка") + " "
			+ ЗначениеСвойстваXDTO(ФИО, "Имя",      "Строка") + " "
			+ ЗначениеСвойстваXDTO(ФИО, "Отчество", "Строка"));
			
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПринялФИО", ФамилияИнициалы);
		
	КонецЕсли;
	
	ЮрЛицо = ЗначениеСвойстваXDTO(Подписант, "ЮЛ");
	Если ЮрЛицо <> Неопределено Тогда
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПринялДолжность", ЗначениеСвойстваXDTO(ЮрЛицо, "Должн"));
		ФамилияИнициалы = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(
			ЗначениеСвойстваXDTO(ЮрЛицо.ФИО, "Фамилия", "Строка") + " "
			+ ЗначениеСвойстваXDTO(ЮрЛицо.ФИО, "Имя", "Строка")   + " "
			+ ЗначениеСвойстваXDTO(ЮрЛицо.ФИО, "Отчество", "Строка"));
			
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПринялФИО", ФамилияИнициалы);
		
	КонецЕсли;
		
	СтрокаДерева = НовыйЭД.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если СтрокаДерева = Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
КонецПроцедуры

Функция ЗаполнитьДанныеКомиссионераИзДопДанных(ДеревоРазбора, НовыйЭД, ПространствоИменСхемы, Ошибка)
	
	КомиссионнаяСФ = Ложь;
	СтрКомиссионер = НовыйЭД.Строки.Найти("ДанныеКомиссионера", "Реквизит", Истина);
	КомиссионерНаименование = НовыйЭД.Строки.Найти("КомиссионерНаименование", "Реквизит", Истина);
	КомиссионерДобавлен = Ложь;
	Если ЗначениеЗаполнено(СтрКомиссионер) Тогда
		КомиссионнаяСФ = Истина;
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ОбъектXML = Новый ЧтениеXML;
			Попытка
				СтрокаXML = "<СвПродПокТип xmlns=""" + ПространствоИменСхемы + """> " + СтрКомиссионер.ЗначениеРеквизита
					+ " <Адрес> <АдрРФ КодРегион=""00""/> </Адрес> </СвПродПокТип>";
				ОбъектXML.УстановитьСтроку(СтрокаXML);
				Комиссионер = ФабрикаXDTO.ПрочитатьXML(ОбъектXML, ПолучитьТипЗначенияCML("СвПродПокТип", ПространствоИменСхемы));
				ОбъектXML.Закрыть();
				ПрочитатьДанныеКонтрагента(Комиссионер, Комиссионер, ДеревоРазбора, НовыйЭД, Ошибка, "Комиссионер");
				КомиссионерДобавлен = Истина;
			Исключение
				Ошибка = Истина;
				ТекстСообщения = НСтр("ru = 'Не удалось прочитать данные Комиссионера
					|при извлечении данных ЭД (корр)счет-фактура.'");
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД'"),
																							ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																							ТекстСообщения);
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(КомиссионерНаименование) Тогда
		// Из прикладных решений с БЭД версии 1.1.15.3 и меньше могут приходить данные о комиссионере
		// в виде набора данных КомиссионерНаименование, КомиссионерИНН, КомиссионерКПП.
		КомиссионнаяСФ = Истина;
		Если НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий И НЕ КомиссионерДобавлен Тогда
			РеквизитыКонтрагента = Новый Структура;
			РеквизитыКонтрагента.Вставить("ПолноеНаименование", КомиссионерНаименование.ЗначениеРеквизита);
			СтрокаИНН = НовыйЭД.Строки.Найти("КомиссионерИНН", "Реквизит", Истина);
			РеквизитыКонтрагента.Вставить("ИНН", ?(ЗначениеЗаполнено(СтрокаИНН), СтрокаИНН.ЗначениеРеквизита, ""));
			СтрокаКПП = НовыйЭД.Строки.Найти("КомиссионерКПП", "Реквизит", Истина);
			РеквизитыКонтрагента.Вставить("КПП", ?(ЗначениеЗаполнено(СтрокаКПП), СтрокаКПП.ЗначениеРеквизита, ""));
			ИдКонтрагента = РеквизитыКонтрагента.ИНН + ?(ЗначениеЗаполнено(РеквизитыКонтрагента.КПП), РеквизитыКонтрагента.КПП, "");
			ВидКонтрагента = "Организации";
			ИмяРеквизита = "Организация";
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ВидКонтрагента);
			Контрагент = ЭлектронноеВзаимодействие.НайтиСсылку(ВидКонтрагента, ИдКонтрагента, РеквизитыКонтрагента);
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдКонтрагента, "ИНН+КПП: " + ИдКонтрагента,
				Контрагент, РеквизитыКонтрагента, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, ИмяРеквизита, НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
	КонецЕсли;
	
	Возврат КомиссионнаяСФ;
	
КонецФункции

// Разбираем строковую конструкцию вида "ИНН_КПП".
//
// Возвращаемое значение:
//  Структура параметров с ИНН и КПП.
//
Функция РазобратьИДКонтрагента(Знач СтрокаИД)
	
	ПозицияРазделителя1 = СтрНайти(СтрокаИД, "#");
	СтруктураПоиска = Новый Структура;
	ПозицияРазделителя1 = СтрНайти(СтрокаИД, "_");
	Если ПозицияРазделителя1 > 0 Тогда
		ИНН = Лев(СтрокаИД, ПозицияРазделителя1 - 1);
		КПП = Сред(СтрокаИД, ПозицияРазделителя1 + 1, СтрДлина(СтрокаИД) - ПозицияРазделителя1);
	ИначеЕсли СтрДлина(СтрокаИД) > 0 Тогда
		ИНН = СокрЛП(СтрокаИД);
		КПП = "";
	КонецЕсли;
	
	СтруктураПоиска.Вставить("ИНН", ИНН);
	СтруктураПоиска.Вставить("КПП", КПП);
	
	Возврат СтруктураПоиска;
	
КонецФункции

// Функция преобразует строку в дату и время.
//
// Параметры:
//  ДатаВремя - строка - дата в формате "ГГГГ-ММ-ДД ЧЧ:ММ:СС".
//
// Возвращаемое значение:
//  Значение типа "ДатаВремя".
//
Функция ПолучитьДатуВремяИзСтроки(ДатаВремя)
	
	Результат = Неопределено;
	ДатаВремя = СтрЗаменить(ДатаВремя, "-", "");
	ДатаВремя = СтрЗаменить(ДатаВремя, ":", "");
	Если СтрДлина(ДатаВремя) - СтрНайти(ДатаВремя, " ") = 5 Тогда // время в формате Ч:ММ:СС
		ДатаВремя = СтрЗаменить(ДатаВремя, " ", "0");
	ИначеЕсли СтрНайти(ДатаВремя, "T") > 0 Тогда //время в формате ГГГГММДДTЧЧММСС
		ДатаВремя = СтрЗаменить(ДатаВремя, "T", "");
	Иначе // время в формате ЧЧ:ММ:СС
		ДатаВремя = СтрЗаменить(ДатаВремя, " ", "");
	КонецЕсли;
	
	ОписаниеТипа = Новый ОписаниеТипов("Дата");
	Результат = ОписаниеТипа.ПривестиЗначение(ДатаВремя);  // дата и время в виде "ГГГГММДДЧЧММСС"
	Если Не ЗначениеЗаполнено(Результат) Тогда
		Результат = ОписаниеТипа.ПривестиЗначение(Лев(ДатаВремя, 8));  // только дата "ГГГГММДД"
	КонецЕсли;

	Возврат Результат;
	
КонецФункции

Процедура ПрочитатьФайлCMLпоXDTO(ИмяФайла, ДеревоРазбора, НовыйЭД, ОшибкаРазбора)
	
	ОписаниеОшибки      = "";
	ПространствоИменФНС = Неопределено;
	ИмяКорневогоУзла    = ""; // для идентификации файла с реквизитами организации
	
	ДанныеФайлаЭД = ДанныеФайлаЭД(ИмяФайла, ОписаниеОшибки, ПространствоИменФНС, ИмяКорневогоУзла, Истина);
	
	Если НЕ ПустаяСтрока(ОписаниеОшибки) Тогда
		ОшибкаРазбора = Истина;
		Если Пользователи.ЭтоПолноправныйПользователь( , , Ложь) Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки);
		КонецЕсли;
		Возврат;
	КонецЕсли;
	
	// Блок для форматов ФНС.
	Если ДанныеФайлаЭД.Свойства().Получить("ИдФайл") <> Неопределено Тогда //чтение файлов без namespace по форматам ФНС
		
		Если СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_SCHFDOPPR") > 0 Тогда
			ПрочитатьИнформациюПродавцаXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_SCHFDOPPOK") > 0 Тогда
			ПрочитатьИнформациюПокупателяXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_KORSCHFDOPPR") > 0 Тогда
			ПрочитатьИнформациюПродавцаУКДXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_KORSCHFDOPPOK") > 0 Тогда
			ПрочитатьИнформациюПокупателяУКДXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_SFAKT") > 0 Тогда
			ПрочитатьСчетФактуруXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ON_KORSFAKT") > 0 Тогда
			ПрочитатьКорректировочныйСчетФактуруXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "OTORG12") > 0 Тогда
			ПрочитатьТОРГ12XDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "PTORG12") > 0 Тогда
			ПрочитатьТОРГ12ПокупательXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "IAKTPRM") > 0 Тогда
			ПрочитатьАкт501XDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "ZAKTPRM") > 0 Тогда
			ПрочитатьАкт501ЗаказчикXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "OKORDOC") > 0 Тогда
			ПрочитатьКорректировочныйДокументXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "PKORDOC") > 0 Тогда
			ПрочитатьКорректировочныйДокументПолучательXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_IZVPOL") > 0 Тогда
			ПрочитатьИзвещениеXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_UVUTOCH") > 0 Тогда
			ПрочитатьУточнениеXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_PRANNUL") > 0 Тогда
			ПрочитатьПредложениеОбАннулированииXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "POD_DPIZVPOL") > 0 Тогда
			ПрочитатьПодтверждениеXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_PDOTPR") > 0 Тогда
			ПрочитатьПодтверждениеДатыОтправкиXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_PDPOL") > 0 Тогда
			ПрочитатьПодтверждениеДатыПолученияXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "POD") > 0 Тогда
			ПрочитатьПодтверждениеXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_TOVTORGPR") > 0 Тогда
			ПрочитатьПередачаТоваровПродавецXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_TOVTORGPOK") > 0 Тогда
			ПрочитатьПередачаТоваровПокупательXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_REZRUISP") > 0 Тогда
			ПрочитатьПередачаРаботИсполнительXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли СтрНайти(ДанныеФайлаЭД.ИдФайл, "DP_REZRUZAK") > 0 Тогда
			ПрочитатьПередачаРаботЗаказчикXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);

		КонецЕсли;
		
		// Помещаем в шапку имя пространства имен, чтобы по нему формировать ответный титул.
		Если Не ПространствоИменФНС = Неопределено Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПространствоИмен", ПространствоИменФНС);
		КонецЕсли;
		
	КонецЕсли;
	
	// Блок для формата 4.02
	Если ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("Каталог", "4.02") Тогда
		УдалитьПрочитатьКаталогXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ПрайсЛист", "4.02") Тогда
		УдалитьПрочитатьПрайсXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("АктОПриемке", "4.02") Тогда
		УдалитьПрочитатьАктОПриемкеXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ТОРГ12", "4.02") Тогда
		УдалитьПрочитатьНакладнуюXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("СчетНаОплату", "4.02") Тогда
		УдалитьПрочитатьСчетНаОплатуXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ОтчетОСписанииКомиссионногоТовара", "4.02") Тогда
		УдалитьПрочитатьОтчетОСписанииКомиссионногоТовараXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ОтчетОПродажахКомиссионногоТовара", "4.02") Тогда
		УдалитьПрочитатьОтчетОПродажахКомиссионногоТовараXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ДанныеФайлаЭД.Тип() = ПолучитьТипЗначенияCML("ЗаказКлиента", "4.02") Тогда
		УдалитьПрочитатьЗаказXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	КонецЕсли;
	
	// Блок для формата 2.08
	Если ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ") <> Неопределено Тогда
		
		ЭДокумент = ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Документ");
		Если ВРег(ЗначениеСвойстваXDTO(ЭДокумент, "ХозОперация")) = ВРег(НСтр("ru = 'Отчет о продажах комиссионного товара'")) Тогда
			
			ПрочитатьОтчетОПродажахКомиссионногоТовараXDTO(ЭДокумент, ДеревоРазбора, НовыйЭД, ОшибкаРазбора); 
			
		ИначеЕсли ВРег(ЗначениеСвойстваXDTO(ЭДокумент, "ХозОперация")) = ВРег(НСтр("ru = 'Отчет о списании комиссионного товара'")) Тогда
			ПрочитатьОтчетОСписанииКомиссионногоТовараXDTO(ЭДокумент, ДеревоРазбора, НовыйЭД, ОшибкаРазбора); 
			
		ИначеЕсли ВРег(ЗначениеСвойстваXDTO(ЭДокумент, "ХозОперация")) = ВРег(НСтр("ru = 'Счет на оплату'")) Тогда
			ПрочитатьСчетНаОплатуXDTO(ЭДокумент, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли ВРег(ЗначениеСвойстваXDTO(ЭДокумент, "ХозОперация")) = ВРег(НСтр("ru = 'Заказ товара'")) Тогда
			ПрочитатьЗаказXDTO(ЭДокумент, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		ИначеЕсли ВРег(ЗначениеСвойстваXDTO(ЭДокумент, "ХозОперация")) = ВРег(НСтр("ru = 'Передача прав'")) Тогда
			ПрочитатьАктНаПередачуПравXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
			
		КонецЕсли;
		
	ИначеЕсли ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ПакетПредложений") <> Неопределено Тогда
		ПрочитатьПрайсXDTO(ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "ПакетПредложений"), ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ЗначениеСвойстваXDTO(ДанныеФайлаЭД, "Каталог") <> Неопределено Тогда
		ПрочитатьКаталогXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	ИначеЕсли ИмяКорневогоУзла = "Контрагент" Тогда
		ПрочитатьРеквизитыОрганизацииXDTO(ДанныеФайлаЭД, ДеревоРазбора, НовыйЭД, ОшибкаРазбора);
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(НовыйЭД.ВидЭД) Тогда
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Неизвестный тип электронного документа при чтении данных из файла %1.'"), ИмяФайла);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		
		ОшибкаРазбора = Истина;
	Иначе
		Строки = ДеревоРазбора.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтавкаНДС"), Истина);
		Для Каждого СтрокаДерева Из Строки Цикл
			СтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзПредставления(СтрокаДерева.ЗначениеРеквизита);
			Если ЗначениеЗаполнено(СтавкаНДС) Тогда
				СтрокаДерева.ЗначениеРеквизита = СтавкаНДС;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Функция СоставнойАдрес(Параметры)
	
	Если Параметры = Неопределено Тогда
		Возврат Неопределено
	КонецЕсли;
	
	ВозврЗнч = "";
	Для Каждого Свойство Из Параметры.Свойства() Цикл
		ДобПараметр = "";
		Если НЕ ЗначениеЗаполнено(Параметры[Свойство.Имя]) Тогда
			Продолжить;
		КонецЕсли;
		Если Свойство.Имя = "Индекс" Тогда
			ДобПараметр = Параметры[Свойство.Имя];
		ИначеЕсли Свойство.Имя = "КодРегион" Тогда
			ОбменСКонтрагентамиПереопределяемый.НазваниеРегиона(Параметры.КодРегион, ДобПараметр);
		Иначе
			ДобПараметр = Параметры[Свойство.Имя];
		КонецЕсли;
		ДобавитьПрефиксКЭлементуАдреса(Свойство.Имя, ДобПараметр);
		Если ЗначениеЗаполнено(ДобПараметр) Тогда
			ВозврЗнч = ?(ЗначениеЗаполнено(ВозврЗнч), ВозврЗнч + ", ", "") + ДобПараметр;
		КонецЕсли;
	КонецЦикла;
	
	Возврат ВозврЗнч;
	
КонецФункции

Процедура ПрочитатьДанныеКонтрагента(Элемент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Роль = "")
	
	ВидКонтрагента  = "";
	ВидДопАналитики = "";
	Если (ЗначениеЗаполнено(НовыйЭД.НаправлениеЭД) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани) Тогда
		ВидКонтрагента = "Организации";
		Если Роль = "Продавец" ИЛИ Роль = "Исполнитель" Тогда
			ИмяРеквизита = "Организация";
			ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций";
		ИначеЕсли Роль = "Покупатель" ИЛИ Роль = "Заказчик" Тогда
			ИмяРеквизита = "Контрагент";
			ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		ИначеЕсли Роль = "Грузоотправитель" ИЛИ Роль = "Грузополучатель" Тогда
			ИмяРеквизита = Роль;
			ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		КонецЕсли;
		
	ИначеЕсли Роль = "Комиссионер" Тогда
		Если (ЗначениеЗаполнено(НовыйЭД.НаправлениеЭД) И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий) Тогда
			ВидКонтрагента = "Организации";
			ИмяРеквизита = "Организация";
			ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций";
		Иначе
			ВидКонтрагента = "Контрагенты";
			ИмяРеквизита = "Комиссионер";
			ВидДопАналитики = "Партнеры";
			ДопАналитика = "Партнер";
			ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		КонецЕсли;
		
	ИначеЕсли Роль = "Продавец" ИЛИ Роль = "Исполнитель" Тогда
		ВидКонтрагента = "Организации";
		ИмяРеквизита = "Организация";
		ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций";
		
	ИначеЕсли Роль = "Покупатель" ИЛИ Роль = "Заказчик" Тогда
		ВидКонтрагента = "Контрагенты";
		ИмяРеквизита = "Контрагент";
		ВидДопАналитики = "Партнеры";
		ДопАналитика = "Партнер";
		ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		
	ИначеЕсли Роль = "Грузоотправитель"  Тогда
		
			ВидКонтрагента = "Контрагенты";
			ИмяРеквизита = Роль;
			ВидДопАналитики = "Партнеры";
			ДопАналитика = "Партнер";
			ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		
	ИначеЕсли Роль = "Грузополучатель"  Тогда
			
			ВидКонтрагента = "Контрагенты";
			ИмяРеквизита = Роль;
			ВидДопАналитики = "Партнеры";
			ДопАналитика = "Партнер";
			ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
			
	ИначеЕсли Роль = "ПокупательКомиссии" Тогда
		ВидКонтрагента = "Контрагенты";
		ИмяРеквизита = "Покупатель";
		ВидДопАналитики = "Партнеры";
		ДопАналитика = "Партнер";
		ВидБанковскогоСчета = "БанковскиеСчетаПокупателя";
	КонецЕсли;
	
	// Контрагент
	РеквизитыКонтрагента = Новый Структура;
	Если ТипЗнч(Элемент) = Тип("Структура") Тогда
		РеквизитыКонтрагента = Элемент;
	ИначеЕсли Элемент.Тип().URIПространстваИмен = "OTORG12"
		ИЛИ Элемент.Тип().URIПространстваИмен = "IAKTPRM"
		ИЛИ Элемент.Тип().URIПространстваИмен = "IAKTPRM2"
		ИЛИ Элемент.Тип().URIПространстваИмен = "OKORDOC"
		ИЛИ Элемент.Тип().URIПространстваИмен = "IAKTPRM_5_01_02"
		ИЛИ Элемент.Тип().URIПространстваИмен = "OTORG_5_01_02"
		ИЛИ Элемент.Тип().URIПространстваИмен = "PTORG_5_01_02"
		ИЛИ Элемент.Тип().URIПространстваИмен = "SFAKT_5_02"
		ИЛИ Элемент.Тип().URIПространстваИмен = "KORSFAKT_5_02"
		ИЛИ Элемент.Тип().URIПространстваИмен = "SFAKT"
		ИЛИ Элемент.Тип().URIПространстваИмен = "KORSFAKT" Тогда
		ИдКонтрагента = "";
		Если Элемент.ИдСв <> Неопределено Тогда
			Если Элемент.ИдСв.СвЮЛ <> Неопределено И НЕ Элемент.ИдСв.СвЮЛ.НаимОрг = "---" Тогда
				РеквизитыКонтрагента.Вставить("ПолноеНаименование", Элемент.ИдСв.СвЮЛ.НаимОрг);
				РеквизитыКонтрагента.Вставить("Наименование", Элемент.ИдСв.СвЮЛ.НаимОрг);
				РеквизитыКонтрагента.Вставить("ИНН", Элемент.ИдСв.СвЮЛ.ИННЮЛ);
				РеквизитыКонтрагента.Вставить("КПП", Элемент.ИдСв.СвЮЛ.КПП);
				Если Элемент.ИдСв.СвЮЛ.Свойства().Получить("ОКОПФ") <> Неопределено Тогда
					РеквизитыКонтрагента.Вставить("ОКОПФ", Элемент.ИдСв.СвЮЛ.ОКОПФ);
				КонецЕсли;
				Если ЗначениеЗаполнено(Элемент.ИдСв.СвЮЛ.ИННЮЛ) Тогда
					ИдКонтрагента = Элемент.ИдСв.СвЮЛ.ИННЮЛ + Элемент.ИдСв.СвЮЛ.КПП;
				КонецЕсли;
				РеквизитыКонтрагента.Вставить("ЮрФизЛицо", ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ЮрФизЛицо", "ЮрЛицо"));
			ИначеЕсли Элемент.ИдСв.СвФЛ <> Неопределено Тогда
				ПолноеНаименование = Элемент.ИдСв.СвФЛ.ФИОИП.Фамилия +" "+ Элемент.ИдСв.СвФЛ.ФИОИП.Имя
					+ " " + Элемент.ИдСв.СвФЛ.ФИОИП.Отчество;
				РеквизитыКонтрагента.Вставить("ПолноеНаименование", ПолноеНаименование);
				РеквизитыКонтрагента.Вставить("Наименование", ПолноеНаименование);
				РеквизитыКонтрагента.Вставить("ИНН", Элемент.ИдСв.СвФЛ.ИННФЛ);
				ИдКонтрагента = Элемент.ИдСв.СвФЛ.ИННФЛ;
				РеквизитыКонтрагента.Вставить("ЮрФизЛицо", ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ЮрФизЛицо", "ФизЛицо"));
			КонецЕсли;
		КонецЕсли;
		Если Элемент.Свойства().Получить("ОКПО") <> Неопределено Тогда
			РеквизитыКонтрагента.Вставить("ОКПО", Элемент.ОКПО);
		КонецЕсли;
		ЭлементАдрес = Элемент.Адрес;
		Если ЭлементАдрес <> Неопределено Тогда
			ПрефиксАдреса = ?(Роль = "Грузоотправитель" ИЛИ Роль = "Грузополучатель", "Фактический", "Юридический");
			Если ЭлементАдрес.АдрРФ <> Неопределено Тогда
				РеквизитыКонтрагента.Вставить(ПрефиксАдреса + "Адрес_Представление", СоставнойАдрес(ЭлементАдрес.АдрРФ));
			ИначеЕсли ЭлементАдрес.АдрИно <> Неопределено Тогда
				РеквизитыКонтрагента.Вставить(ПрефиксАдреса + "Адрес_Представление", ЭлементАдрес.АдрИно.АдрТекст);
				РеквизитыКонтрагента.Вставить("КодСтраны", ЭлементАдрес.АдрИно.КодСтр);
			ИначеЕсли ЗначениеЗаполнено(ЭлементАдрес.АдрТекст) Тогда
				РеквизитыКонтрагента.Вставить(ПрефиксАдреса + "Адрес_Представление", ЭлементАдрес.АдрТекст);
			КонецЕсли;
		КонецЕсли;
		Если Элемент.Свойства().Получить("Контакт") <> Неопределено Тогда
			ЭлементКонтакты = Элемент.Контакт;
			Если ЭлементКонтакты <> Неопределено Тогда
				Если ЭлементКонтакты.Тлф <> Неопределено Тогда
					РеквизитыКонтрагента.Вставить("Телефоны", ЭлементКонтакты.Тлф);
				КонецЕсли;
				Если ЭлементКонтакты.Факс <> Неопределено Тогда
					РеквизитыКонтрагента.Вставить("Факс", ЭлементКонтакты.Факс);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли Элемент.Тип().URIПространстваИмен = "TORGPR"
		ИЛИ Элемент.Тип().URIПространстваИмен = "RUISP" Тогда
		
		СведенияЮрЛица = Неопределено;
		Если Не Элемент.ИдСв.СвОрг = Неопределено Тогда
			СведенияЮрЛица = Элемент.ИдСв.СвОрг.СвЮЛ;
		КонецЕсли;
		СведенияФизЛица = Элемент.ИдСв.СвФЛ;
		
		Если Не СведенияЮрЛица = Неопределено И НЕ СведенияЮрЛица.НаимОрг = "---" Тогда
			РеквизитыКонтрагента.Вставить("ПолноеНаименование", СведенияЮрЛица.НаимОрг);
			РеквизитыКонтрагента.Вставить("ИНН", СведенияЮрЛица.ИННЮЛ);
			РеквизитыКонтрагента.Вставить("КПП", СведенияЮрЛица.КПП);
			
			Если ЗначениеЗаполнено(СведенияЮрЛица.ИННЮЛ) Тогда
				ИдКонтрагента = СведенияЮрЛица.ИННЮЛ + СведенияЮрЛица.КПП;
			КонецЕсли;
			РеквизитыКонтрагента.Вставить("ЮрФизЛицо", ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ЮрФизЛицо", "ЮрЛицо"));
			
		ИначеЕсли Не СведенияФизЛица = Неопределено Тогда
			
			ФИОФизЛица = СведенияФизЛица.ФИО;
			РеквизитыКонтрагента.Вставить("ПолноеНаименование",
			ФИОФизЛица.Фамилия +" "+ ФИОФизЛица.Имя
			+ " " + ФИОФизЛица.Отчество);
			РеквизитыКонтрагента.Вставить("ИНН", СведенияФизЛица.ИННФЛ);
			ИдКонтрагента = СведенияФизЛица.ИННФЛ;
			РеквизитыКонтрагента.Вставить("ЮрФизЛицо", ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ЮрФизЛицо", "ФизЛицо"));
			
		Иначе
			СведенияИностраннаяОрганизация = Неопределено;
			Если Не Элемент.ИдСв.СвОрг = Неопределено Тогда
				СведенияИностраннаяОрганизация = Элемент.ИдСв.СвОрг.ИнОрг;
			КонецЕсли;
			РеквизитыКонтрагента.Вставить("ПолноеНаименование", СведенияИностраннаяОрганизация.НаимОрг);
			РеквизитыКонтрагента.Вставить("Наименование", СведенияИностраннаяОрганизация.НаимОрг);
			РеквизитыКонтрагента.Вставить("Страна", СведенияИностраннаяОрганизация.Страна);
			РеквизитыКонтрагента.Вставить("ИныеСведения", СведенияИностраннаяОрганизация.ИныеСвед);
			
		КонецЕсли;
		
		Если Элемент.Свойства().Получить("ОКПО") <> Неопределено Тогда
			РеквизитыКонтрагента.Вставить("ОКПО", Элемент.ОКПО);
		КонецЕсли;
		
		ЭлементАдрес = Элемент.Адрес;
		Если ЭлементАдрес <> Неопределено Тогда
			ПрефиксАдреса = ?(Роль = "Грузоотправитель" ИЛИ Роль = "Грузополучатель", "Фактический", "Юридический");
			Если Не ЭлементАдрес.АдрРФ = Неопределено Тогда
				РеквизитыКонтрагента.Вставить(ПрефиксАдреса + "Адрес_Представление", СоставнойАдрес(ЭлементАдрес.АдрРФ));
				
			ИначеЕсли ЕстьСвойствоXDTO(ЭлементАдрес, "АдрИнф") Тогда
				Если ЕстьСвойствоXDTO(ЭлементАдрес.АдрИнф, "АдрТекст") Тогда
					РеквизитыКонтрагента.Вставить(ПрефиксАдреса + "Адрес_Представление", ЭлементАдрес.АдрИнф.АдрТекст);
				КонецЕсли;
				Если ЕстьСвойствоXDTO(ЭлементАдрес.АдрИнф, "КодСтр") Тогда
					РеквизитыКонтрагента.Вставить("КодСтраны", ЭлементАдрес.АдрИнф.КодСтр);
				КонецЕсли;
				
			ИначеЕсли ЕстьСвойствоXDTO(ЭлементАдрес, "АдрИно") Тогда
				Если ЕстьСвойствоXDTO(ЭлементАдрес.АдрИно, "АдрТекст") Тогда
					РеквизитыКонтрагента.Вставить(ПрефиксАдреса + "Адрес_Представление", ЭлементАдрес.АдрИно.АдрТекст);
				КонецЕсли;
				Если ЕстьСвойствоXDTO(ЭлементАдрес.АдрИно, "КодСтр") Тогда
					РеквизитыКонтрагента.Вставить("КодСтраны", ЭлементАдрес.АдрИно.КодСтр);
				КонецЕсли				
			КонецЕсли;
			
		КонецЕсли;
		
		Если ЕстьСвойствоXDTO(Элемент, "Контакт") Тогда
			ЭлементКонтакты = Элемент.Контакт;
			Если ЭлементКонтакты <> Неопределено Тогда
				Если ЕстьСвойствоXDTO(ЭлементКонтакты, "Тлф") Тогда
					РеквизитыКонтрагента.Вставить("Телефоны", ЭлементКонтакты.Тлф);
				КонецЕсли;
				Если ЕстьСвойствоXDTO(ЭлементКонтакты, "Факс") Тогда
					РеквизитыКонтрагента.Вставить("Факс", ЭлементКонтакты.Факс);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
			
	Иначе
		Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
			
			ЗнДанных = Элемент[ТекСвойство.Имя];
			
			Если ЗнДанных = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
				ИдКонтрагента = ЗнДанных;
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Роль") Тогда
				Если ВРег(ЗнДанных) = ВРег("Продавец") Тогда
					Если НовыйЭД.ВидЭД=Перечисления.ВидыЭД.ЗаказТовара Тогда
						ВидКонтрагента = "Организации";
						ИмяРеквизита = "Организация";
						ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций";
					Иначе
						ВидКонтрагента = "Контрагенты";
						ИмяРеквизита = "Контрагент";
						// доп.аналитика по Партнеру
						ВидДопАналитики = "Партнеры";
						ДопАналитика = "Партнер";
						ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
					КонецЕсли;
				ИначеЕсли ВРег(ЗнДанных) = ВРег("Покупатель") Тогда
					Если НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ЗаказТовара Тогда
						ВидКонтрагента = "Контрагенты";
						ИмяРеквизита = "Контрагент";
						ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
						// доп.аналитика по Партнеру
						ВидДопАналитики = "Партнеры";
						ДопАналитика = "Партнер";
					Иначе
						ВидКонтрагента = "Организации";
						ИмяРеквизита = "Организация";
						ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций";
					КонецЕсли;
				КонецЕсли;
			ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЮрЛицо") ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ФизЛицо") Тогда
				РеквизитыУчастника = ЗнДанных;
				Для Каждого СвойствоУчастника Из РеквизитыУчастника.Свойства() Цикл
					РеквизитУчастника = РеквизитыУчастника[СвойствоУчастника.Имя];
					Если РеквизитУчастника <> Неопределено Тогда
						Если ВРег(СвойствоУчастника.Имя) = ВРег("ЮридическийАдрес")
							ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("АдресРегистрации") Тогда
							РеквизитыКонтрагента.Вставить("ЮридическийАдрес_Представление", РеквизитУчастника.Представление);
						ИначеЕсли ВРег(СвойствоУчастника.Имя) = ВРег("ОфициальноеНаименование")
							ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("ПолноеНаименование") Тогда
							РеквизитыКонтрагента.Вставить("ПолноеНаименование", РеквизитУчастника);
						Иначе // остальное по именам
							РеквизитыКонтрагента.Вставить(СвойствоУчастника.Имя, РеквизитУчастника);
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			ИначеЕсли ВРег(ТекСвойство) = ВРег("Адрес") Тогда
				РеквизитыКонтрагента.Вставить("ФактическийАдрес_Представление", ЗнДанных.Представление);
			ИначеЕсли ВРег(ТекСвойство) = ВРег("Контакты") Тогда
				ТаблицаКонтактов = Новый ТаблицаЗначений();
				ТаблицаКонтактов.Колонки.Добавить("Вид");
				ТаблицаКонтактов.Колонки.Добавить("Представление");
				ТаблицаКонтактов.Колонки.Добавить("ЗначенияПолей");
				Для Каждого Контакт Из ЗнДанных.Контакт Цикл
					Вид = Неопределено;
					Если Контакт.Тип = НСтр("ru = 'Почта'") Тогда
						Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации","EmailКонтрагента");
					ИначеЕсли Контакт.Тип = НСтр("ru = 'Телефон рабочий'") Тогда
						Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации","ТелефонКонтрагента");
					ИначеЕсли Контакт.Тип = НСтр("ru = 'Факс'") Тогда
						Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации","ФаксКонтрагента");
					КонецЕсли;
					Если ЗначениеЗаполнено(Вид) Тогда // добавляем только, если есть виды контактной информации в конфигурации-приемнике
						НовКонт = ТаблицаКонтактов.Добавить();
						НовКонт.Вид = Вид;
						НовКонт.Представление = Контакт.Значение;
						НовКонт.ЗначенияПолей = Контакт.Комментарий;
					КонецЕсли;
				КонецЦикла;
				РеквизитыКонтрагента.Вставить(ТекСвойство.Имя, ТаблицаКонтактов);
			Иначе // остальное по именам
				РеквизитыКонтрагента.Вставить(ТекСвойство.Имя, ЗнДанных);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	// заполняем значения в зависимости от вида
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ВидКонтрагента);
	
	СтруктураПоиска = Новый Структура;
	СтруктураПоиска.Вставить("ИНН", РеквизитыКонтрагента.ИНН);
	Если РеквизитыКонтрагента.Свойство("КПП") Тогда
		СтруктураПоиска.Вставить("КПП", РеквизитыКонтрагента.КПП);
	КонецЕсли;
	Контрагент = ЭлектронноеВзаимодействие.НайтиСсылку(ВидКонтрагента, ИдКонтрагента, СтруктураПоиска);
	
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдКонтрагента, "ИНН+КПП: "+ИдКонтрагента,
		Контрагент, РеквизитыКонтрагента, ДеревоРазбора, Ошибка);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, ИмяРеквизита, НайденнаяСтрока.ИндексСтроки);
	
	// Определяем расчетный счет контрагента
	Если НЕ ТипЗнч(Элемент) = Тип("Структура") Тогда
		Если Элемент.Свойства().Получить("РасчетныеСчета") <> Неопределено Тогда
			РасчетныеСчета = Элемент.РасчетныеСчета;
			Если РасчетныеСчета <> Неопределено Тогда
				РасчетныеСчетаXDTO = РасчетныеСчета.ПолучитьСписок("РасчетныйСчет");
				Для Каждого РасчетныйСчетXDTO Из РасчетныеСчетаXDTO Цикл
					ПрочитатьДанныеПоРасчетномуСчету(НовыйЭД, РасчетныйСчетXDTO, ДеревоРазбора, ВидБанковскогоСчета, Роль, Контрагент, Ошибка);
					Прервать;
				КонецЦикла;
			КонецЕсли;
		ИначеЕсли Элемент.Свойства().Получить("БанкРекв") <> Неопределено И Элемент.БанкРекв <> Неопределено Тогда
			ПрочитатьДанныеПоРасчетномуСчетуТорг12(НовыйЭД, Элемент.БанкРекв, ДеревоРазбора, ВидБанковскогоСчета, Роль, Контрагент, Ошибка);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭД.Свойства().Получить("РеквизитыПолучателя") <> Неопределено Тогда
		СвойствоЭД = ЭД.Свойства().Получить("РеквизитыПолучателя");
		РеквизитыПолучателя = ЭД.Получить(СвойствоЭД);
		ПрочитатьДанныеПоРасчетномуСчету(НовыйЭД, РеквизитыПолучателя, ДеревоРазбора, ВидБанковскогоСчета, Роль, Контрагент, Ошибка);
	КонецЕсли;
	
	// Доп.аналитику добавим, если заполнена
	Если ЗначениеЗаполнено(ВидДопАналитики) Тогда
		Если ОбменСКонтрагентамиПовтИсп.ИспользуетсяДополнительнаяАналитикаКонтрагентовСправочникПартнеры() Тогда
			РеквизитыПартнера = Новый Структура();
			РеквизитыПартнера.Вставить("Контрагент", Контрагент);
			ИмяПрикладногоСправочника = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ИмяПрикладногоСправочника("Партнеры");
			
			ЗнДопАналитики = ЭлектронноеВзаимодействие.НайтиСсылку(ИмяПрикладногоСправочника, , РеквизитыПартнера);
			Если ЗначениеЗаполнено(ЗнДопАналитики) Тогда
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Партнеры");
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДопАналитики.Код, "Код: "
					+ ЗнДопАналитики.Код, ЗнДопАналитики, РеквизитыПартнера, ДеревоРазбора, Ошибка);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Партнер", НайденнаяСтрока.ИндексСтроки);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоТЧАктаОПриемке(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Определяем вариант ЭД для выбора алгоритма заполнения номенклатуры.
	АвторЭДПокупатель = Ложь;
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий);
	
	
	
	Если Не ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Возврат;
	КонецЕсли;
	
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");

	Для Каждого Элемент Из НаборДанных Цикл
		
		НомерСтроки = НомерСтроки + 1;
		
		СписокТЧ = Новый СписокЗначений;
		
		ПоляПоискаТовара = Новый Структура;
		ПоляПоискаТовара.Вставить("Ид", "");
		ПоляПоискаТовара.Вставить("Наименование", "");
		ПоляПоискаТовара.Вставить("Артикул", "");
		ПоляПоискаТовара.Вставить("ЕдиницаИзмерения", "");
		ПоляПоискаТовара.Вставить("Организация", Организация);
		ПоляПоискаТовара.Вставить("НомерСтроки", НомерСтроки);
		
		ПрочитатьСтрокуТоваровCML(Элемент, НовыйЭД, СписокТЧ, ПоляПоискаТовара, ДеревоРазбора, Ошибка);
		
		// Идентификация по номенклатуре компании, когда сторона разбора ЭД - сама компания.
		Если ИдентификацияПоНоменклатуреКомпании Тогда 
			
			НайтиНоменклатуруТЧ(ПоляПоискаТовара, СписокТЧ);
			
		Иначе
			
			НайтиНоменклатуруПоставщикаТЧ(ПоляПоискаТовара, СписокТЧ, НовыйЭД, ДеревоРазбора, ЭД, Ошибка);
			
		КонецЕсли;
		
		ДобавитьСтрокуТабличнойЧасти(ДеревоРазбора, НовыйЭД, ПоляПоискаТовара, СписокТЧ, Ошибка);
		
	КонецЦикла;

		
КонецПроцедуры

Процедура РазобратьСтрокуТЧCML(Элемент, СписокТЧ, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, НомерСтроки = Неопределено)
	
	ИдЭД = ?(ЭД.Свойства().Получить("ИД") = Неопределено, "", ЭД.Ид);
	
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани);
	
	НаимТовара = "";
	ИдТовара = "";
	ЕстьДопРеквизиты = Ложь;
	
	// Номенклатура.
	РеквизитыНоменклатуры = Новый Структура;
	Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
		ЗнДанных = Элемент[ТекСвойство.Имя];
		
		Если ЗнДанных = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		// Разберем свойства Товара.
		Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
			РеквизитыНоменклатуры.Вставить("Ид", ЗнДанных);
			ИдТовара = РеквизитыНоменклатуры.Ид;
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
			РеквизитыНоменклатуры.Вставить("Наименование", ЗнДанных);
			НаимТовара = РеквизитыНоменклатуры.Наименование;
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
			РеквизитыНоменклатуры.Вставить("Артикул", ЗнДанных);
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
			Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
				РеквизитыЕдИзм = Новый Структура;
				РеквизитыЕдИзм.Вставить("Код", ЗнДанных.Код);
				НаимЕдИзм = "";
				Если ЗнДанных.Свойства().Получить("Наименование") <> Неопределено Тогда
					РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
					НаимЕдИзм = ЗнДанных.Наименование;
				КонецЕсли;
				Если ЗнДанных.Свойства().Получить("НаименованиеКраткое") <> Неопределено Тогда
					РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.НаименованиеКраткое);
					НаимЕдИзм = ЗнДанных.НаименованиеКраткое;
				КонецЕсли;
				Если ЗнДанных.Свойства().Получить("НаименованиеПолное") <> Неопределено Тогда
					РеквизитыЕдИзм.Вставить("НаименованиеПолное", ЗнДанных.НаименованиеПолное);
				КонецЕсли;
				Если ЗнДанных.Свойства().Получить("МеждународноеСокращение") <> Неопределено Тогда
					РеквизитыЕдИзм.Вставить("МеждународноеСокращение", ЗнДанных.МеждународноеСокращение);
				КонецЕсли;
				ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных.Код, РеквизитыЕдИзм);
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных.Код, НаимЕдИзм,
					ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
				Если ЗначениеЗаполнено(НайденнаяСтрока) Тогда
					РеквизитыНоменклатуры.Вставить("БазоваяЕдиница", НайденнаяСтрока.ИндексСтроки);
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЕдиницаИзмерения") Тогда
			Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
				РеквизитыЕдИзм = Новый Структура;
				РеквизитыЕдИзм.Вставить("Код", Строка(ЗнДанных.Код));
				Если НЕ ЗнДанных.Свойства().Получить("Наименование") = Неопределено Тогда
					РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
				КонецЕсли;
				Если НЕ ЗнДанных.Свойства().Получить("Коэффициент") = Неопределено Тогда
					РеквизитыЕдИзм.Вставить("Коэффициент", ЗнДанных.Коэффициент);
				КонецЕсли;
				ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(ЗнДанных.Код), РеквизитыЕдИзм);
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
				НайденнаяСтрока     = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Строка(ЗнДанных.Код),
					ЗнДанных.Наименование, ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
				Если ЗначениеЗаполнено(НайденнаяСтрока) Тогда
					РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Налог") Тогда
			Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
				Если ВРег(ЗнДанных.ТипНалога) = "НДС" Тогда
					СписокТЧ.Добавить(ЗнДанных.ВеличинаСтавкиНалога, "СтавкаНДС");
					СписокТЧ.Добавить(ЗнДанных.Сумма, "СуммаНДС");
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("СуммаБезНДС") Тогда
			СписокТЧ.Добавить(ЗнДанных, "Сумма");
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("СуммаСУчетомНДС") Тогда
			СписокТЧ.Добавить(ЗнДанных, "СуммаСНДС");
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДатаПоДаннымКлиента") ИЛИ ВРег(ТекСвойство.Имя) = ВРег("СрокГодности") Тогда
			СписокТЧ.Добавить(ПолучитьДатуВремяИзСтроки(ЗнДанных), ТекСвойство.Имя);
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеРеквизиты") Тогда
			ЕстьДопРеквизиты = Истина;
			СтруктураДопРеквизитов = Новый Структура;
			Для Каждого ЭлементДанных Из ЗнДанных Цикл
				МассивЗначений = Новый Массив;
				Для Каждого ЭлементЗначения Из ЭлементДанных.Значение Цикл
					МассивЗначений.Добавить(ЭлементЗначения)
				КонецЦикла;
				СтруктураДопРеквизитов.Вставить(ЭлементДанных.Наименование, МассивЗначений);
			КонецЦикла;
			
		// Схема 2:
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Единица") Тогда
			РеквизитыЕдИзм = Новый Структура;
			Если ЗначениеЗаполнено(ЗнДанных) Тогда
				РеквизитыЕдИзм.Вставить("Код", ЗнДанных);
				ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(ЗнДанных), РеквизитыЕдИзм);
				НаименованиеЕИ = ?(ЗначениеЗаполнено(ЕдИзм), ЕдИзм.Наименование, Неопределено);
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
				НайденнаяСтрока     = НайтиСоздатьСтрокуВДеревеРазбора( НайденныйТипВДереве, Строка(ЗнДанных), НаименованиеЕИ,
					ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
				Если ЗначениеЗаполнено(НайденнаяСтрока) Тогда
					РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Налоги") Тогда
			Если ТипЗнч(ЗнДанных.Налог) = Тип("СписокXDTO") Тогда
				МассивСтруктур = Новый Массив;
				Для Каждого Налог Из ЗнДанных.Налог Цикл
					СтруктураНалога = Новый Структура;
					Для Каждого СвойствоНалога Из Налог.Свойства() Цикл
						ЗначениеНалога = Налог.Получить(СвойствоНалога);
						Если НЕ ЗначениеЗаполнено(ЗначениеНалога) Тогда
							Продолжить;
						КонецЕсли;
						СтруктураНалога.Вставить(СвойствоНалога.Имя, ЗначениеНалога);
					КонецЦикла;
					МассивСтруктур.Добавить(СтруктураНалога);
				КонецЦикла;
				Если МассивСтруктур.Количество() > 0 Тогда
					СтруктураНалога = МассивСтруктур[0];
					СтавкаНДС = "";
					НДСУчтеноВСумме = "";
					СуммаНДС = 0;
					Если НЕ СтруктураНалога.Свойство("Ставка", СтавкаНДС) Тогда
						СтавкаНДС = НСтр("ru = 'без НДС'");
					КонецЕсли;
					Если НЕ СтруктураНалога.Свойство("УчтеноВСумме", НДСУчтеноВСумме) Тогда
						НДСУчтеноВСумме = Ложь;
					КонецЕсли;
					Если НЕ СтруктураНалога.Свойство("Сумма", СуммаНДС) Тогда
						СуммаНДС = 0;
					КонецЕсли;
					СписокТЧ.Добавить(СтавкаНДС, "СтавкаНДС");
					СписокТЧ.Добавить(СуммаНДС, "СуммаНДС");
					СписокТЧ.Добавить(НДСУчтеноВСумме, "НДСУчтеноВСумме");
				КонецЕсли;
				Если МассивСтруктур.Количество() > 1 Тогда
					СписокТЧ.Добавить(МассивСтруктур, "Налоги");
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Скидки")
			ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ДопРасходы") Тогда
			
			МассивСтруктур = Новый Массив;
			Для Каждого ЭлСписка Из ЗнДанных[ТекСвойство.Имя] Цикл
				СтруктураДанных = Новый Структура;
				Для Каждого СвойствоДопСписка Из ЭлСписка.Свойства() Цикл
					ЗначениеДопСписка = Налог.Получить(СвойствоДопСписка);
					Если НЕ ЗначениеЗаполнено(ЗначениеДопСписка) Тогда
						Продолжить;
					КонецЕсли;
					СтруктураНалога.Вставить(СвойствоДопСписка.Имя, ЗначениеДопСписка);
				КонецЦикла;
				МассивСтруктур.Добавить(СтруктураДанных);
			КонецЦикла;
			СписокТЧ.Добавить(МассивСтруктур, ТекСвойство.Имя);
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеЗначенияРеквизитов")
			ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ЗначенияРеквизитов") Тогда
			
			ДопРеквизиты = Новый Структура;
			Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
			Если ЗначениеЗаполнено(Организация) Тогда
				ДопРеквизиты.Вставить("Организация", Организация);
			КонецЕсли;
			
			ПрочитатьСписокЗначенийРеквизитовCML(ЗнДанных.ЗначениеРеквизита, СписокТЧ, Ошибка, ДопРеквизиты);
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Сумма") Тогда
			СписокТЧ.Добавить(ЗнДанных, "Сумма");
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЦенаЗаЕдиницу") Тогда
			СписокТЧ.Добавить(ЗнДанных, "Цена");
			
		Иначе
			СписокТЧ.Добавить(ЗнДанных, ТекСвойство.Имя);
			
		КонецЕсли;
	КонецЦикла;
	
	// Идентификация по номенклатуре компании, когда сторона разбора ЭД - сама компания
	Если ИдентификацияПоНоменклатуреКомпании Тогда
		СтруктураИд = РазобратьИДТовара(ИдТовара);
		Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
		Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
			ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры", СтруктураИд.ИДХарактеристики);
			СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
			УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры", СтруктураИд.ИДУпаковки);
			СписокТЧ.Добавить(УпаковкаНоменклатуры, "Упаковка");
		КонецЕсли;
	Иначе
		// Номенклатура поставщиков.
		РеквизитыНоменклатурыПоставщика = Новый Структура;
		ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
		ВладелецНоменклатуры  = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
		
		РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
		РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ИдТовара);
		Если РеквизитыНоменклатуры.Свойство("Артикул") Тогда
			РеквизитыНоменклатурыПоставщика.Вставить("Артикул", РеквизитыНоменклатуры.Артикул);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(НаимТовара) Тогда
			РеквизитыНоменклатурыПоставщика.Вставить("Наименование", НаимТовара);
		КонецЕсли;
		
		Если ЕстьДопРеквизиты Тогда
			РеквизитыНоменклатурыПоставщика.Вставить("ДополнительныеРеквизиты", СтруктураДопРеквизитов);
		КонецЕсли;
		
		НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
			РеквизитыНоменклатурыПоставщика);
		
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
		НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, НоменклатураПоставщика,
			РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
		СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки,"НоменклатураПоставщика");
		
		Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
			РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
			РеквизитыНоменклатурыПоставщика.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
		КонецЕсли;
		СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
		ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(РеквизитыНоменклатурыПоставщика, СтруктураРеквизитовТовара, ИдЭД);
		
		Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
		Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Характеристика) Тогда
			СписокТЧ.Добавить(СтруктураРеквизитовТовара.Характеристика, "Характеристика");
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Упаковка) Тогда
			СписокТЧ.Добавить(СтруктураРеквизитовТовара.Упаковка, "Упаковка");
		КонецЕсли;
	КонецЕсли;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
		РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
	СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки,"Номенклатура");
	
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
	ДопПараметры = Новый Структура;
	ДопПараметры.Вставить("Организация", Организация);
	
	Если ТипЗНЧ(НомерСтроки) = Тип("Число") Тогда
		НомерСтроки = НомерСтроки + 1;
	КонецЕсли;
	ПрочитатьДопДанныеСтрокиТЧ(Элемент, НовыйЭД, "Товары", НомерСтроки, СписокТЧ, ДопПараметры);
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоТЧНакладной(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			РазобратьСтрокуТЧCML(Элемент, СписокТЧ, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Элемент.НомерПП);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Функция ЗначениеВидаОплаты(ВидОплаты, Роль)
	
	ВозвращаемоеЗначение = "";
	
	Если ВидОплаты = "Аванс" Тогда
		Если Роль = "Продавец" Тогда 
			ВозвращаемоеЗначение = ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыКлиентом",
			НСтр("ru = 'Аванс (до обеспечения)'"));
		ИначеЕсли Роль = "Покупатель"  Тогда 
			ВозвращаемоеЗначение = ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыПоставщику",
			НСтр("ru = 'Аванс (до подтверждения)'"));
		КонецЕсли;
	ИначеЕсли ВидОплаты = "Предоплата" Тогда
		Если Роль = "Продавец" Тогда 
			ВозвращаемоеЗначение = ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыКлиентом",
			НСтр("ru = 'Предоплата (до отгрузки)'"));
		ИначеЕсли Роль = "Покупатель" Тогда 
			ВозвращаемоеЗначение = ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыПоставщику",
			НСтр("ru = 'Предоплата (до поступления)'"));
		КонецЕсли;
	ИначеЕсли ВидОплаты = "Кредит" Тогда
		Если Роль = "Продавец" Тогда 
			ВозвращаемоеЗначение = ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыКлиентом",
			НСтр("ru = 'Кредит (после отгрузки)'"));
		ИначеЕсли Роль = "Покупатель" Тогда 
			ВозвращаемоеЗначение = ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыПоставщику",
			НСтр("ru = 'Кредит (после поступления)'"));
		КонецЕсли;
	Иначе
		ВозвращаемоеЗначение = ВидОплаты;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Процедура ПрочитатьДанныеПоГрафикуОплаты(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	Если НЕ ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Возврат;
	КонецЕсли;
	
	СписокТЧ = Новый СписокЗначений;
	НомерСтрокиСтар = 1;
	
	Для Каждого Элемент Из НаборДанных Цикл
		СписокТЧ = Новый СписокЗначений;
		ЗаполнитьСписокРеквизитов(СписокТЧ, Элемент, ЭД);
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "ЭтапыГрафикаОплаты", СписокТЧ);
		
	КонецЦикла;
		
КонецПроцедуры

Процедура ЗаполнитьСписокРеквизитов(СписокТЧ, Знач Элемент, ЭД)
	
	Пока СтрДлина(Элемент) > 0 Цикл
		
		ПозицияРазделителя = СтрНайти(Элемент, "#");
		РеквизитЗначение = Лев(Элемент, ПозицияРазделителя );
		Элемент = СтрЗаменить(Элемент, РеквизитЗначение, "");
		
		Позиция = СтрНайти(РеквизитЗначение, "&");
		
		Реквизит = Лев(РеквизитЗначение, Позиция - 1);
		
		РеквизитЗначение = СтрЗаменить(РеквизитЗначение, Реквизит, "");
		РеквизитЗначение = СтрЗаменить(РеквизитЗначение,"&","");
		РеквизитЗначение = СтрЗаменить(РеквизитЗначение,"#","");
		
		Если ВРег(Реквизит) = ВРег("ВариантОплаты") Тогда
			РеквизитЗначение = ЗначениеВидаОплаты(РеквизитЗначение, ЗначениеСвойстваXDTO(ЭД, "Роль"));
		КонецЕсли;
		
		СписокТЧ.Добавить(РеквизитЗначение, Реквизит);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура УдалитьПрочитатьДанныеПоГрафикуОплаты(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			РеквизитыНоменклатуры = Новый Структура;
			Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
				ЗнДанных = Элемент[ТекСвойство.Имя];
				
				Если ЗнДанных <> Неопределено
					И НЕ ВРег(ТекСвойство.Имя) = ВРег("Налоги") 
					И Не ВРег(ТекСвойство.Имя) = ВРег("ПроцентПлатежа") Тогда
					
					Продолжить;
					
				КонецЕсли;
				
				Если ВРег(ТекСвойство.Имя) = ВРег("ДатаПлатежа") Тогда
					СписокТЧ.Добавить(ЗнДанных, "ДатаПлатежа");	
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ПроцентПлатежа") Тогда
					СписокТЧ.Добавить(ЗнДанных, "ПроцентПлатежа");	
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("СуммаПлатежа") Тогда
					СписокТЧ.Добавить(ЗнДанных, "СуммаПлатежа");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ВидОплаты") Тогда
					Если ЗнДанных = "Аванс" Тогда
						Если ЭД.Роль = "Продавец" Тогда 
							СписокТЧ.Добавить(ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыКлиентом",
								НСтр("ru = 'Аванс (до обеспечения)'")), "ВариантОплаты");
						ИначеЕсли ЭД.Роль = "Покупатель"  Тогда 
							СписокТЧ.Добавить(ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыПоставщику",
								НСтр("ru = 'Аванс (до подтверждения)'")), "ВариантОплаты");
						КонецЕсли;
					ИначеЕсли ЗнДанных = "Предоплата" Тогда
						Если ЭД.Роль = "Продавец" Тогда 
							СписокТЧ.Добавить(ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыКлиентом",
								НСтр("ru = 'Предоплата (до отгрузки)'")), "ВариантОплаты");
						ИначеЕсли ЭД.Роль = "Покупатель" Тогда 
							СписокТЧ.Добавить(ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыПоставщику",
								НСтр("ru = 'Предоплата (до поступления)'")), "ВариантОплаты");
						КонецЕсли;
					ИначеЕсли ЗнДанных = "Кредит" Тогда
						Если ЭД.Роль = "Продавец" Тогда 
							СписокТЧ.Добавить(ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыКлиентом",
								НСтр("ru = 'Кредит (после отгрузки)'")), "ВариантОплаты");
						ИначеЕсли ЭД.Роль = "Покупатель" Тогда 
							СписокТЧ.Добавить(ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ВариантыОплатыПоставщику",
								НСтр("ru = 'Кредит (после поступления)'")), "ВариантОплаты");
						КонецЕсли;
					КонецЕсли;
				Иначе
					СписокТЧ.Добавить(ЗнДанных, ТекСвойство.Имя);
				КонецЕсли;
			КонецЦикла;
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "ЭтапыГрафикаОплаты", СписокТЧ);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеТЧКаталогТоваров(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	Если НаборДанных = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НомерСтроки = 0;
	
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");
	Владелец    = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Контрагент");
	
	Для Каждого Элемент Из НаборДанных Цикл
		
		НомерСтроки = НомерСтроки + 1;
		
		СписокТЧ = Новый СписокЗначений;
		
		ПоляПоискаТовара = Новый Структура;
		ПоляПоискаТовара.Вставить("Ид", "");
		ПоляПоискаТовара.Вставить("Наименование", "");
		ПоляПоискаТовара.Вставить("Артикул", "");
		ПоляПоискаТовара.Вставить("ЕдиницаИзмерения", "");
		ПоляПоискаТовара.Вставить("Организация", Организация);
		ПоляПоискаТовара.Вставить("Владелец", Владелец);
		ПоляПоискаТовара.Вставить("НомерСтроки", НомерСтроки);
		
		ПрочитатьСтрокуТоваровCML(Элемент, НовыйЭД, СписокТЧ, ПоляПоискаТовара, ДеревоРазбора, Ошибка);
		
		НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
			ПоляПоискаТовара);
		
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
		
		ИдТовара   = ПоляПоискаТовара.Ид;
		НаимТовара = ПоляПоискаТовара.Наименование;
		
		НайденнаяСтрока     = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, НоменклатураПоставщика,
			ПоляПоискаТовара, ДеревоРазбора, Ошибка);
			
		СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "НоменклатураПоставщика");
		
		Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
			ПоляПоискаТовара.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
		КонецЕсли;
		
		Номенклатура = ЭлектронноеВзаимодействие.НайтиСсылку("Номенклатура", "", ПоляПоискаТовара);
		
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
		НайденнаяСтрока     = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
			ПоляПоискаТовара, ДеревоРазбора, Ошибка);
			
		СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
	
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоТоваруКаталога(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, ИдентификацияПоНоменклатуреКомпании = Истина)
	
	Если НаборДанных = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НомерСтроки = 0;
	
	Организация = СсылкаРеквизитаДерева(ДеревоРазбора, НовыйЭД, "Организация");

	Для Каждого Элемент Из НаборДанных Цикл
		
		НомерСтроки = НомерСтроки + 1;
		
		СписокТЧ = Новый СписокЗначений;
		
		ПоляПоискаТовара = Новый Структура;
		ПоляПоискаТовара.Вставить("Ид", "");
		ПоляПоискаТовара.Вставить("Наименование", "");
		ПоляПоискаТовара.Вставить("Артикул", "");
		ПоляПоискаТовара.Вставить("ЕдиницаИзмерения", "");
		ПоляПоискаТовара.Вставить("Организация", Организация);
		ПоляПоискаТовара.Вставить("НомерСтроки", НомерСтроки);
		
		ПрочитатьСтрокуТоваровCML(Элемент, НовыйЭД, СписокТЧ, ПоляПоискаТовара, ДеревоРазбора, Ошибка);
		
		Если ИдентификацияПоНоменклатуреКомпании Тогда
			
			НайтиНоменклатуруТЧ(ПоляПоискаТовара, СписокТЧ);
			
		Иначе
			
			НайтиНоменклатуруПоставщикаТЧ(ПоляПоискаТовара, СписокТЧ, НовыйЭД, ДеревоРазбора, ЭД, Ошибка);
			
		КонецЕсли;
		
		ДобавитьСтрокуТабличнойЧасти(ДеревоРазбора, НовыйЭД, ПоляПоискаТовара, СписокТЧ, Ошибка);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоРасчетномуСчетуТорг12(
					НовыйЭД,
					РасчетныйСчетXDTO,
					ДеревоРазбора,
					ВидБанковскогоСчета,
					Роль,
					Контрагент,
					Ошибка)
	
	// Обработка банка счета
	
	БанкXDTO = РасчетныйСчетXDTO.СвБанк;
	
	РеквизитыБанка = Новый Структура;
	РеквизитыБанка.Вставить("Код",			БанкXDTO.БИК);
	РеквизитыБанка.Вставить("Наименование", БанкXDTO.НаимБанк);
	
	БанкСсылка = ЭлектронноеВзаимодействие.НайтиСсылку("Банки", РеквизитыБанка.Код, РеквизитыБанка);
	
	// Создаем объект банка в дереве разбора
	ТипБанкиВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Банки");
	
	СтрокаБанка = НайтиСоздатьСтрокуВДеревеРазбора(ТипБанкиВДереве, РеквизитыБанка.Код, "БИК: " + РеквизитыБанка.Код,
	БанкСсылка, РеквизитыБанка, ДеревоРазбора, Ошибка);
	
	// Обработка самого счета
	РеквизитыБанковскогоСчета = Новый Структура;
	РеквизитыБанковскогоСчета.Вставить("НомерСчета", РасчетныйСчетXDTO.НомерСчета);
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		РеквизитыБанковскогоСчета.Вставить("Владелец", Контрагент);
	КонецЕсли;
	
	БанковскийСчетСсылка = ЭлектронноеВзаимодействие.НайтиСсылку(ВидБанковскогоСчета, РеквизитыБанковскогоСчета.НомерСчета, РеквизитыБанковскогоСчета);
	
	// Создаем объект расчетного счета в дереве разбора
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ВидБанковскогоСчета);
	
	СтрокаСчета = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, РеквизитыБанковскогоСчета.НомерСчета, НСтр("ru = 'Номер счета:'") + " " + РеквизитыБанковскогоСчета.НомерСчета,
	БанковскийСчетСсылка, РеквизитыБанковскогоСчета, ДеревоРазбора, Ошибка);
	
	// Заполняем реквизиты банковского счета
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СтрокаСчета, "Банк", СтрокаБанка.ИндексСтроки);
	Если ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов" Тогда
		Если Роль = "Грузоотправитель" Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузоотправителя", СтрокаСчета.ИндексСтроки);
		ИначеЕсли Роль = "Грузополучатель" Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузополучателя", СтрокаСчета.ИндексСтроки);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетКонтрагента", СтрокаСчета.ИндексСтроки);
		КонецЕсли
	ИначеЕсли ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций" Тогда
		Если Роль = "Грузоотправитель" Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузоотправителя", СтрокаСчета.ИндексСтроки);
		ИначеЕсли Роль = "Грузополучатель" Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузополучателя", СтрокаСчета.ИндексСтроки);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетОрганизации", СтрокаСчета.ИндексСтроки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоРасчетномуСчету(
					НовыйЭД,
					РасчетныйСчетXDTO,
					ДеревоРазбора,
					ВидБанковскогоСчета,
					Роль,
					Контрагент,
					Ошибка)
					
	Если ТипЗнч(РасчетныйСчетXDTO) = Тип("ОбъектXDTO") Тогда
		
		РеквизитыБанка = Новый Структура;
		РеквизитыБанка.Вставить("Код",          ЗначениеСвойстваXDTO(РасчетныйСчетXDTO, "Банк.БИК"));
		РеквизитыБанка.Вставить("Наименование", ЗначениеСвойстваXDTO(РасчетныйСчетXDTO, "Банк.Наименование"));
		РеквизитыБанка.Вставить("КоррСчет",     ЗначениеСвойстваXDTO(РасчетныйСчетXDTO, "Банк.СчетКорреспондентский"));
		
	Иначе
		
		РеквизитыБанка = Новый Структура;
		
		РеквизитыБанка.Вставить("Код",
			?(РасчетныйСчетXDTO.Свойство("БИК"), РасчетныйСчетXDTO.БИК, ""));
			
		РеквизитыБанка.Вставить("Наименование",
			?(РасчетныйСчетXDTO.Свойство("НаименованиеБанка"), РасчетныйСчетXDTO.НаименованиеБанка, ""));
			
		РеквизитыБанка.Вставить("КоррСчет",
			?(РасчетныйСчетXDTO.Свойство("СчетКорреспондентский"), РасчетныйСчетXDTO.СчетКорреспондентский, ""));
		
	КонецЕсли;
	
	БанкСсылка = ЭлектронноеВзаимодействие.НайтиСсылку("Банки", РеквизитыБанка.Код, РеквизитыБанка);
	
	// Создаем объект банка в дереве разбора.
	ТипБанкиВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Банки");
	
	СтрокаБанка = НайтиСоздатьСтрокуВДеревеРазбора(ТипБанкиВДереве, РеквизитыБанка.Код, "БИК: " + РеквизитыБанка.Код,
		БанкСсылка, РеквизитыБанка, ДеревоРазбора, Ошибка);
	
	// Обработка банка корреспондента
	ЕстьБанкКорреспондент = Ложь;
	
	Если ТипЗнч(РасчетныйСчетXDTO) = Тип("ОбъектXDTO") Тогда
		СвойствоЭД = РасчетныйСчетXDTO.Свойства().Получить("БанкКорреспондент");
		Если СвойствоЭД <> Неопределено И РасчетныйСчетXDTO.БанкКорреспондент <> Неопределено Тогда
			
			ЕстьБанкКорреспондент = Истина;
			
			РеквизитыБанкаКорреспондента = Новый Структура;
			РеквизитыБанкаКорреспондента.Вставить("Код",          ЗначениеСвойстваXDTO(РасчетныйСчетXDTO, "БанкКорреспондент.БИК", "Строка"));
			РеквизитыБанкаКорреспондента.Вставить("Наименование", ЗначениеСвойстваXDTO(РасчетныйСчетXDTO, "БанкКорреспондент.Наименование", "Строка"));
			РеквизитыБанкаКорреспондента.Вставить("КоррСчет",     ЗначениеСвойстваXDTO(РасчетныйСчетXDTO, "БанкКорреспондент.СчетКорреспондентский", "Строка"));
			
		КонецЕсли;
	ИначеЕсли РасчетныйСчетXDTO.Свойство("БИККорр") И ЗначениеЗаполнено(РасчетныйСчетXDTO.БИККорр) Тогда
		
		ЕстьБанкКорреспондент = Истина;
		
		РеквизитыБанкаКорреспондента = Новый Структура;
		РеквизитыБанкаКорреспондента.Вставить("Код",          ?(РасчетныйСчетXDTO.Свойство("БИККорр"),          РасчетныйСчетXDTO.БИККорр,          ""));
		РеквизитыБанкаКорреспондента.Вставить("Наименование", ?(РасчетныйСчетXDTO.Свойство("НаименованиеКорр"), РасчетныйСчетXDTO.НаименованиеКорр, ""));
		РеквизитыБанкаКорреспондента.Вставить("КоррСчет",     ?(РасчетныйСчетXDTO.Свойство("СчетКорр"),         РасчетныйСчетXDTO.СчетКорр,         ""));
		
	КонецЕсли;
	
	Если ЕстьБанкКорреспондент Тогда
		
		БанкКорреспондентСсылка = ЭлектронноеВзаимодействие.НайтиСсылку("Банки",
			РеквизитыБанкаКорреспондента.Код, РеквизитыБанкаКорреспондента);
		
		// Создаем объект банка в дереве разбора
		ТипБанкиКоррВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Банки");
		
		СтрокаБанкаКорреспондента = НайтиСоздатьСтрокуВДеревеРазбора(ТипБанкиКоррВДереве, РеквизитыБанкаКорреспондента.Код,
			"БИК: " + РеквизитыБанкаКорреспондента.Код, БанкКорреспондентСсылка, РеквизитыБанкаКорреспондента, ДеревоРазбора,
			Ошибка);
		
	КонецЕсли;
	
	// Обработка самого счета
	РеквизитыБанковскогоСчета = Новый Структура;
	РеквизитыБанковскогоСчета.Вставить("НомерСчета",
		?(ТипЗнч(РасчетныйСчетXDTO) = Тип("ОбъектXDTO"),
			ЗначениеСвойстваXDTO(РасчетныйСчетXDTO, "НомерСчета"),
			РасчетныйСчетXDTO.НомерСчета));
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		РеквизитыБанковскогоСчета.Вставить("Владелец", Контрагент);
	КонецЕсли;
	
	БанковскийСчетСсылка = ЭлектронноеВзаимодействие.НайтиСсылку(ВидБанковскогоСчета,
		РеквизитыБанковскогоСчета.НомерСчета, РеквизитыБанковскогоСчета);
	
	// Создаем объект расчетного счета в дереве разбора.
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ВидБанковскогоСчета);
	
	СтрокаСчета = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, РеквизитыБанковскогоСчета.НомерСчета,
		НСтр("ru = 'Номер счета:'") + " " + РеквизитыБанковскогоСчета.НомерСчета,
		БанковскийСчетСсылка, РеквизитыБанковскогоСчета, ДеревоРазбора, Ошибка);
	
	// Заполняем реквизиты банковского счета
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СтрокаСчета, "Банк", СтрокаБанка.ИндексСтроки);
	Если ЕстьБанкКорреспондент Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СтрокаСчета, "БанкКорреспондент", СтрокаБанкаКорреспондента.ИндексСтроки);
	КонецЕсли;
	
	Если ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов" Тогда
		Если Роль = "Грузоотправитель" Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузоотправителя", СтрокаСчета.ИндексСтроки);
		ИначеЕсли Роль = "Грузополучатель" Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузополучателя", СтрокаСчета.ИндексСтроки);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетКонтрагента", СтрокаСчета.ИндексСтроки);
		КонецЕсли
	ИначеЕсли ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций" Тогда
		Если Роль = "Грузоотправитель" Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузоотправителя", СтрокаСчета.ИндексСтроки);
		Иначе
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетОрганизации", СтрокаСчета.ИндексСтроки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоРасчетнымСчетамКонтрагентаCML(
					НовыйЭД,
					РасчетныеСчетаXDTO,
					ДеревоРазбора,
					ВидБанковскогоСчета,
					Роль,
					Контрагент,
					Ошибка)
					
	НаборДанных = РасчетныеСчетаXDTO.РасчетныйСчет;
	Если Не ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого РасчетныйСчетXDTO Из НаборДанных Цикл
		
		СписокТЧ = Новый СписокЗначений;
		
		БанкXDTO = РасчетныйСчетXDTO.Банк;
		
		РеквизитыБанка = Новый Структура;
		РеквизитыБанка.Вставить("Код",          БанкXDTO.БИК);
		РеквизитыБанка.Вставить("Наименование", БанкXDTO.Наименование);
		РеквизитыБанка.Вставить("КоррСчет",     БанкXDTO.СчетКорреспондентский);
		РеквизитыБанка.Вставить("SWIFT",     	БанкXDTO.SWIFT);

		БанкСсылка = ЭлектронноеВзаимодействие.НайтиСсылку("Банки", РеквизитыБанка.Код, РеквизитыБанка);
		
		СписокТЧ.Добавить(БанкXDTO.БИК,						"БанкБИК");
		СписокТЧ.Добавить(БанкXDTO.Наименование,			"БанкНаименование");
		СписокТЧ.Добавить(БанкXDTO.СчетКорреспондентский,	"БанкСчетКорр");
		СписокТЧ.Добавить(БанкXDTO.SWIFT,					"БанкSWIFT");
		
		// Создаем объект банка в дереве разбора.
		ТипБанкиВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Банки");
		
		СтрокаБанка = НайтиСоздатьСтрокуВДеревеРазбора(ТипБанкиВДереве, РеквизитыБанка.Код, "БИК: " + РеквизитыБанка.Код,
																		БанкСсылка, РеквизитыБанка, ДеревоРазбора, Ошибка);
		
		// Обработка банка корреспондента
		ЕстьБанкКорреспондент = Ложь;
		СвойствоЭД = РасчетныйСчетXDTO.Свойства().Получить("БанкКорреспондент");
		Если СвойствоЭД <> Неопределено И РасчетныйСчетXDTO.БанкКорреспондент <> Неопределено Тогда
			
			ЕстьБанкКорреспондент = Истина;
			БанкКорреспондентXDTO = РасчетныйСчетXDTO.БанкКорреспондент;
			
			РеквизитыБанкаКорреспондента = Новый Структура;
			РеквизитыБанкаКорреспондента.Вставить("Код",			БанкКорреспондентXDTO.БИК);
			РеквизитыБанкаКорреспондента.Вставить("Наименование",	БанкКорреспондентXDTO.Наименование);
			РеквизитыБанкаКорреспондента.Вставить("КоррСчет",		БанкКорреспондентXDTO.СчетКорреспондентский);
			РеквизитыБанкаКорреспондента.Вставить("SWIFT",			БанкКорреспондентXDTO.SWIFT);
			
			СписокТЧ.Добавить(БанкКорреспондентXDTO.БИК,					"БанкКоррБИК");
			СписокТЧ.Добавить(БанкКорреспондентXDTO.Наименование,			"БанкКоррНаименование");
			СписокТЧ.Добавить(БанкКорреспондентXDTO.СчетКорреспондентский,	"БанкКоррСчетКорр");
			СписокТЧ.Добавить(БанкКорреспондентXDTO.SWIFT,					"БанкКоррSWIFT");
			
			БанкКорреспондентСсылка = ЭлектронноеВзаимодействие.НайтиСсылку("Банки",
				РеквизитыБанкаКорреспондента.Код, РеквизитыБанкаКорреспондента);
			
			// Создаем объект банка в дереве разбора
			ТипБанкиКоррВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Банки");
			
			СтрокаБанкаКорреспондента = НайтиСоздатьСтрокуВДеревеРазбора(ТипБанкиКоррВДереве, РеквизитыБанкаКорреспондента.Код,
				"БИК: " + РеквизитыБанкаКорреспондента.Код, БанкКорреспондентСсылка, РеквизитыБанкаКорреспондента, ДеревоРазбора,
				Ошибка);
			
		КонецЕсли;	
		
		// Обработка самого счета	
		РеквизитыБанковскогоСчета = Новый Структура;
		РеквизитыБанковскогоСчета.Вставить("НомерСчета", РасчетныйСчетXDTO.НомерСчета);
		
		СписокТЧ.Добавить(РасчетныйСчетXDTO.НомерСчета,		"НомерСчета");
		СписокТЧ.Добавить(РасчетныйСчетXDTO.Комментарий,	"Комментарий");
		
		
		Если ЗначениеЗаполнено(Контрагент) Тогда
			РеквизитыБанковскогоСчета.Вставить("Владелец", Контрагент);
		КонецЕсли;
		
		БанковскийСчетСсылка = ЭлектронноеВзаимодействие.НайтиСсылку(ВидБанковскогоСчета,
			РеквизитыБанковскогоСчета.НомерСчета, РеквизитыБанковскогоСчета);
		
		// Создаем объект расчетного счета в дереве разбора.
		НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ВидБанковскогоСчета);
		
		СтрокаСчета = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве,
					РеквизитыБанковскогоСчета.НомерСчета, НСтр("ru = 'Номер счета:'") + " " + РеквизитыБанковскогоСчета.НомерСчета,
					БанковскийСчетСсылка, РеквизитыБанковскогоСчета, ДеревоРазбора, Ошибка);
		
		// Заполняем реквизиты банковского счета
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СтрокаСчета, "Банк", СтрокаБанка.ИндексСтроки);
		Если ЕстьБанкКорреспондент Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(СтрокаСчета, "БанкКорреспондент", СтрокаБанкаКорреспондента.ИндексСтроки);
		КонецЕсли;	
		
		Если ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов" Тогда
			Если Роль = "Грузоотправитель" Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузоотправителя", СтрокаСчета.ИндексСтроки);
			ИначеЕсли Роль = "Грузополучатель" Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузополучателя", СтрокаСчета.ИндексСтроки);
			Иначе
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетКонтрагента", СтрокаСчета.ИндексСтроки);
			КонецЕсли	
		ИначеЕсли ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций" Тогда
			Если Роль = "Грузоотправитель" Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетГрузоотправителя", СтрокаСчета.ИндексСтроки);
			Иначе	
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "БанковскийСчетОрганизации", СтрокаСчета.ИндексСтроки);
			КонецЕсли;
		КонецЕсли;	
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧРасчетныйСчет", СписокТЧ);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоТЧСчетаНаОплату(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий);
	
	ПрочитатьДанныеПоТоваруКаталога(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, ИдентификацияПоНоменклатуреКомпании);
	
КонецПроцедуры

Процедура УдалитьПрочитатьДанныеПоТЧСчетаНаОплату(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	// Определяем вариант ЭД для выбора алгоритма заполнения номенклатуры.
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий);
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			НаимТовара = "";
			ИдТовара = "";
			ЕстьДопРеквизиты = Ложь;
			
			// Номенклатура
			РеквизитыНоменклатуры = Новый Структура;
			Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
				ЗначениеСвойства = Элемент[ТекСвойство.Имя];
				Если ТипЗнч(ЗначениеСвойства) = Тип("ЗначениеXDTO") ИЛИ ТипЗнч(ЗначениеСвойства) = Тип("ОбъектXDTO") Тогда
				ИначеЕсли НЕ ЗначениеЗаполнено(ЗначениеСвойства) Тогда
					Продолжить;
				КонецЕсли;
				
				// Разберем свойства Товара.
				Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
					РеквизитыНоменклатуры.Вставить("Ид", ЗначениеСвойства);
					ИдТовара = РеквизитыНоменклатуры.Ид;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
					РеквизитыНоменклатуры.Вставить("Наименование", ЗначениеСвойства);
					НаимТовара = РеквизитыНоменклатуры.Наименование;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
					РеквизитыНоменклатуры.Вставить("Артикул", ЗначениеСвойства);
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
					Если ТипЗнч(ЗначениеСвойства) = Тип("ОбъектXDTO") Тогда
						СвойстваЕдиницы = Новый Структура;
						СвойстваЕдиницы.Вставить("Код", ЗначениеСвойства.Код);
						СвойстваЕдиницы.Вставить("Наименование", ЗначениеСвойства.Наименование);
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗначениеСвойства.Код,
							СвойстваЕдиницы);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(	НайденныйТипВДереве, ЗначениеСвойства.Код, ЗначениеСвойства.Наименование,
							ЕдИзм, СвойстваЕдиницы, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							РеквизитыНоменклатуры.Вставить("БазоваяЕдиница", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЕдиницаИзмерения") Тогда
					Если ТипЗнч(ЗначениеСвойства) = Тип("ОбъектXDTO") Тогда
						
						СвойстваЕдиницы = Новый Структура;
						СвойстваЕдиницы.Вставить("Код", Строка(ЗначениеСвойства.Код));
						СвойстваЕдиницы.Вставить("Наименование", ЗначениеСвойства.Наименование);
						
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(ЗначениеСвойства.Код),
							СвойстваЕдиницы);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Строка(ЗначениеСвойства.Код), ЗначениеСвойства.Наименование,
							ЕдИзм, СвойстваЕдиницы, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("СуммыПоТовару") Тогда
					Если ТипЗнч(ЗначениеСвойства) = Тип("ОбъектXDTO") Тогда
						Для Каждого ТекСв Из ЗначениеСвойства.Свойства() Цикл
							Если ВРег(ТекСв.Имя) = ВРег("Налог") Тогда
								Налоги = ЗначениеСвойства.ПолучитьСписок(ТекСв);
								Для Каждого Налог Из Налоги Цикл
									Если ВРег(Налог.ТипНалога) = "НДС" Тогда
										СписокТЧ.Добавить(Налог.ВеличинаСтавкиНалога, "СтавкаНДС");
										СписокТЧ.Добавить(Налог.Сумма, "СуммаНДС");
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
							Если ВРег(ТекСв.Имя) = ВРег("СуммаБезНалога") Тогда
								СписокТЧ.Добавить(ЗначениеСвойства.СуммаБезНалога, "Сумма");
							КонецЕсли;
							
							Если ВРег(ТекСв.Имя) = ВРег("СуммаОбщая") Тогда
								СписокТЧ.Добавить(ЗначениеСвойства.СуммаОбщая, "СуммаСНДС");
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Скидки") Тогда
					Если ТипЗнч(ЗначениеСвойства) = Тип("ОбъектXDTO") Тогда
						Для Каждого ТекСв Из ЗначениеСвойства.Свойства() Цикл
							Если ВРег(ТекСв.Имя) = ВРег("Скидка") Тогда
								Скидки = ЗначениеСвойства.ПолучитьСписок(ТекСв);
								Для Каждого Скидка Из Скидки Цикл
									Если ВРег(Скидка.Наименование) = "ОБЩАЯСКИДКА" Тогда
										СписокТЧ.Добавить(Скидка.Сумма,"СуммаСкидки");
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Количество") Тогда
					// Запомним кол-во упаковок, в которых отгружали.
					СписокТЧ.Добавить(Число(ЗначениеСвойства), "КоличествоУпаковок");
					// Пересчитаем с учетом коэффициента,
					// если есть свойство ЕдиницаИзмерения, получим значение.
					Коэф = "";
					Если Элемент.ЕдиницаИзмерения <> Неопределено Тогда
						Коэф = Элемент.ЕдиницаИзмерения.Коэффициент;
					КонецЕсли;
					Если НЕ ЗначениеЗаполнено(Коэф) Тогда
						Коэф = 1;
					КонецЕсли;
					СписокТЧ.Добавить(Коэф, "Коэффициент");
					СписокТЧ.Добавить(Число(ЗначениеСвойства) * Коэф, "Количество");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДатаПоДаннымКлиента") Тогда
					СписокТЧ.Добавить(ПолучитьДатуВремяИзСтроки(ЗначениеСвойства), ТекСвойство.Имя);
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеРеквизиты") Тогда
					ЕстьДопРеквизиты = Истина;
					СтруктураДопРеквизитов = Новый Структура;
					Для Каждого ЭлементДанных Из ЗначениеСвойства Цикл
						МассивЗначений = Новый Массив;
						Для каждого ЭлементЗначения Из ЭлементДанных.Значение Цикл
							МассивЗначений.Добавить(ЭлементЗначения)
						КонецЦикла;
						СтруктураДопРеквизитов.Вставить(ЭлементДанных.Наименование,МассивЗначений);
					КонецЦикла;
				Иначе
					СписокТЧ.Добавить(ЗначениеСвойства, ТекСвойство.Имя);
				КонецЕсли;
				
			КонецЦикла;
			
			// Идентификация по номенклатуре компании, когда сторона разбора ЭД - сама компания.
			Если ИдентификацияПоНоменклатуреКомпании Тогда
				СтруктураИд = РазобратьИДТовара(ИдТовара);
				Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
				Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
					ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры", СтруктураИд.ИДХарактеристики);
					СписокТЧ.Добавить(ХарактеристикаНоменклатуры,"Характеристика");
				КонецЕсли;
				Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
					УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры",СтруктураИд.ИДУпаковки);
					СписокТЧ.Добавить(УпаковкаНоменклатуры,"Упаковка");
				КонецЕсли;
				
			Иначе // Все остальные случаи - ищем по номенклатуре поставщика.
				// Номенклатура поставщиков.
				РеквизитыНоменклатурыПоставщика = Новый Структура;
				ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
				ВладелецНоменклатуры = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
				РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
				РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ИдТовара);
				Если РеквизитыНоменклатуры.Свойство("Артикул") Тогда
					РеквизитыНоменклатурыПоставщика.Вставить("Артикул", РеквизитыНоменклатуры.Артикул);
				КонецЕсли;
				Если ЗначениеЗаполнено(НаимТовара) Тогда
					РеквизитыНоменклатурыПоставщика.Вставить("Наименование", НаимТовара);
				КонецЕсли;
				Если ЕстьДопРеквизиты Тогда
					РеквизитыНоменклатурыПоставщика.Вставить("ДополнительныеРеквизиты", СтруктураДопРеквизитов);
				КонецЕсли;
				НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
					РеквизитыНоменклатурыПоставщика);
				
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, НоменклатураПоставщика,
				РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
				СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки,"НоменклатураПоставщика");
				
				Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
					РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
				КонецЕсли;
				Номенклатура = ЭлектронноеВзаимодействие.НайтиСсылку("Номенклатура", "", РеквизитыНоменклатурыПоставщика);
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
				РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
			СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
			
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоТЧЗаказаКлиента(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		И НовыйЭД.ВидЭД=Перечисления.ВидыЭД.ОтветНаЗаказ) ИЛИ (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
		И НовыйЭД.ВидЭД=Перечисления.ВидыЭД.ЗаказТовара);
		
	ПрочитатьДанныеПоТоваруКаталога(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, ИдентификацияПоНоменклатуреКомпании);
	
КонецПроцедуры

Процедура УдалитьПрочитатьДанныеПоТЧЗаказаКлиента(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ИдентификацияПоНоменклатуреКомпании = (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		И НовыйЭД.ВидЭД=Перечисления.ВидыЭД.ОтветНаЗаказ) ИЛИ (НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
		И НовыйЭД.ВидЭД=Перечисления.ВидыЭД.ЗаказТовара);
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			НаимТовара = "";
			ИдТовара = "";
			ЕстьДопРеквизиты = Ложь;
			
			// Номенклатура
			РеквизитыНоменклатуры = Новый Структура;
			Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
				ЗнДанных = Элемент[ТекСвойство.Имя];
				
				Если ЗнДанных = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				// Разберем свойства Товара
				Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
					РеквизитыНоменклатуры.Вставить("Ид", ЗнДанных);
					ИдТовара = РеквизитыНоменклатуры.Ид;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
					РеквизитыНоменклатуры.Вставить("Артикул", ЗнДанных);
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
					РеквизитыНоменклатуры.Вставить("Наименование", ЗнДанных);
					НаимТовара = РеквизитыНоменклатуры.Наименование;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						РеквизитыЕдИзм = Новый Структура;
						РеквизитыЕдИзм.Вставить("Код",          ЗнДанных.Код);
						РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
						
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных.Код,
							РеквизитыЕдИзм);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных.Код, ЗнДанных.Наименование,
							ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							РеквизитыНоменклатуры.Вставить("БазоваяЕдиница", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЕдиницаИзмерения") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						РеквизитыЕдИзм = Новый Структура;
						РеквизитыЕдИзм.Вставить("Код",          Строка(ЗнДанных.Код));
						РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(ЗнДанных.Код),
							РеквизитыЕдИзм);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(	НайденныйТипВДереве, Строка(ЗнДанных.Код), ЗнДанных.Наименование,
							ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "ЕдиницаИзмерения");
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("СуммыПоТовару") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						Для Каждого ТекСв Из ЗнДанных.Свойства() Цикл
							Если ВРег(ТекСв.Имя) = ВРег("Налог") Тогда
								Налоги = ЗнДанных.ПолучитьСписок(ТекСв);
								Для Каждого Налог Из Налоги Цикл
									Если ВРег(Налог.ТипНалога) = "НДС" Тогда
										СписокТЧ.Добавить(Налог.ВеличинаСтавкиНалога,"СтавкаНДС");
										СписокТЧ.Добавить(Налог.Сумма, "СуммаНДС");
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
							Если ВРег(ТекСв.Имя) = ВРег("СуммаБезНалога") Тогда
								СписокТЧ.Добавить(ЗнДанных.СуммаБезНалога, "Сумма");
							КонецЕсли;	
							Если ВРег(ТекСв.Имя) = ВРег("СуммаОбщая") Тогда
								СписокТЧ.Добавить(ЗнДанных.СуммаОбщая, "СуммаСНДС");
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Скидки") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						Для Каждого ТекСв Из ЗнДанных.Свойства() Цикл
							Если ВРег(ТекСв.Имя) = ВРег("Скидка") Тогда
								Скидки = ЗнДанных.ПолучитьСписок(ТекСв);
								Для Каждого Скидка Из Скидки Цикл
									Если ВРег(Скидка.Наименование) = "ОБЩАЯСКИДКА" Тогда
										СписокТЧ.Добавить(Скидка.Сумма,"СуммаСкидки");
										СписокТЧ.Добавить(Скидка.Процент,"ПроцентРучнойСкидки");
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Количество") Тогда
					// Запомним кол-во упаковок, в которых отгружали
					СписокТЧ.Добавить(Число(ЗнДанных), "КоличествоУпаковок");
					// Пересчитаем с учетом коэффициента,
					// если есть свойство ЕдиницаИзмерения, получим значение.
					Коэф = "";
					Если Элемент.ЕдиницаИзмерения <> Неопределено Тогда
						Коэф = Элемент.ЕдиницаИзмерения.Коэффициент;
					КонецЕсли;
					Если НЕ ЗначениеЗаполнено(Коэф) Тогда
						Коэф = 1;
					КонецЕсли;
					СписокТЧ.Добавить(Коэф, "Коэффициент");
					СписокТЧ.Добавить(Число(ЗнДанных) * Коэф, "Количество");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеРеквизиты") Тогда
					ЕстьДопРеквизиты = Истина;
					СтруктураДопРеквизитов = Новый Структура;
					Для Каждого ЭлементДанных Из ЗнДанных Цикл
						МассивЗначений = Новый Массив;
						Для каждого ЭлементЗначения Из ЭлементДанных.Значение Цикл
							МассивЗначений.Добавить(ЭлементЗначения)
						КонецЦикла;
						СтруктураДопРеквизитов.Вставить(ЭлементДанных.Наименование, МассивЗначений);
					КонецЦикла;
				Иначе
					СписокТЧ.Добавить(ЗнДанных, ТекСвойство.Имя);
				КонецЕсли;
				
			КонецЦикла;
			
			// Идентификация по номенклатуре компании, когда сторона разбора ЭД - сама компания.
			Если ИдентификацияПоНоменклатуреКомпании Тогда 
				СтруктураИд = РазобратьИДТовара(ИдТовара);
				Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
				Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
					ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры", СтруктураИд.ИДХарактеристики);
					СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
				КонецЕсли;
				Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
					УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры", СтруктураИд.ИДУпаковки);
					СписокТЧ.Добавить(УпаковкаНоменклатуры, "Упаковка");
				КонецЕсли;
			Иначе
				// Номенклатура поставщиков.
				РеквизитыНоменклатурыПоставщика = Новый Структура;
				ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
				ВладелецНоменклатуры = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
				
				РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
				РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", ИдТовара);
				Если РеквизитыНоменклатуры.Свойство("Артикул") Тогда
					РеквизитыНоменклатурыПоставщика.Вставить("Артикул", РеквизитыНоменклатуры.Артикул);
				КонецЕсли;
				Если ЗначениеЗаполнено(НаимТовара) Тогда
					РеквизитыНоменклатурыПоставщика.Вставить("Наименование", НаимТовара);
				КонецЕсли;
				Если ЕстьДопРеквизиты Тогда
					РеквизитыНоменклатурыПоставщика.Вставить("ДополнительныеРеквизиты", СтруктураДопРеквизитов);
				КонецЕсли;
				НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
					РеквизитыНоменклатурыПоставщика);
				
				НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, НоменклатураПоставщика,
					РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
				СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "НоменклатураПоставщика");
				
				Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
					РеквизитыНоменклатуры.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
				КонецЕсли;
				
				СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
				ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(РеквизитыНоменклатуры, СтруктураРеквизитовТовара, ЭД.Ид);
		
				Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
				Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Характеристика) Тогда
					СписокТЧ.Добавить(СтруктураРеквизитовТовара.Характеристика, "Характеристика");
				КонецЕсли;
				Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Упаковка) Тогда
					СписокТЧ.Добавить(СтруктураРеквизитовТовара.Упаковка, "Упаковка");
				КонецЕсли;
				
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
				РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
			СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоТЧОтчетаОСписанииКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ПрочитатьДанныеПоТоваруКаталога(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
КонецПроцедуры

Процедура УдалитьПрочитатьДанныеПоТЧОтчетаОСписанииКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			НаимТовара = "";
			ИдТовара = "";
			ЕстьДопРеквизиты = Ложь;
			
			// Номенклатура
			РеквизитыНоменклатуры = Новый Структура;
			Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
				ЗнДанных = Элемент[ТекСвойство.Имя];
				
				Если ЗнДанных = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				// Разберем свойства Товара.
				Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
					РеквизитыНоменклатуры.Вставить("Ид", ЗнДанных);
					ИдТовара = РеквизитыНоменклатуры.Ид;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
					РеквизитыНоменклатуры.Вставить("Артикул", ЗнДанных)
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
					РеквизитыНоменклатуры.Вставить("Наименование", ЗнДанных);
					НаимТовара = РеквизитыНоменклатуры.Наименование;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						РеквизитыЕдИзм = Новый Структура;
						РеквизитыЕдИзм.Вставить("Код",          ЗнДанных.Код);
						РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
						
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных.Код, РеквизитыЕдИзм);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДанных.Код, ЗнДанных.Наименование,
							ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							РеквизитыНоменклатуры.Вставить("БазоваяЕдиница", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЕдиницаИзмерения") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						РеквизитыЕдИзм = Новый Структура;
						РеквизитыЕдИзм.Вставить("Код",          Строка(ЗнДанных.Код));
						РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
						
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(ЗнДанных.Код), РеквизитыЕдИзм);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(	НайденныйТипВДереве, Строка(ЗнДанных.Код), ЗнДанных.Наименование,
							ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Количество") Тогда
					// Запомним кол-во упаковок, в которых отгружали.
					СписокТЧ.Добавить(Число(ЗнДанных), "КоличествоУпаковок");
					// Пересчитаем с учетом коэффициента,
					// если есть свойство ЕдиницаИзмерения, получим значение.
					Коэф = "";
					Если Элемент.ЕдиницаИзмерения <> Неопределено Тогда
						Коэф = Элемент.ЕдиницаИзмерения.Коэффициент;
					КонецЕсли;
					Если НЕ ЗначениеЗаполнено(Коэф) Тогда
						Коэф = 1;
					КонецЕсли;
					СписокТЧ.Добавить(Коэф, "Коэффициент");
					СписокТЧ.Добавить(Число(ЗнДанных) * Коэф, "Количество");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеРеквизиты") Тогда
					ЕстьДопРеквизиты = Истина;
					СтруктураДопРеквизитов = Новый Структура;
					Для Каждого ЭлементДанных Из ЗнДанных Цикл
						МассивЗначений = Новый Массив;
						Для каждого ЭлементЗначения Из ЭлементДанных.Значение Цикл
							МассивЗначений.Добавить(ЭлементЗначения)
						КонецЦикла;
						СтруктураДопРеквизитов.Вставить(ЭлементДанных.Наименование, МассивЗначений);
					КонецЦикла;
				Иначе
					СписокТЧ.Добавить(ЗнДанных, ТекСвойство.Имя);
				КонецЕсли;
				
			КонецЦикла;
			
			СтруктураИд = РазобратьИДТовара(ИдТовара);
			Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
			Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
				ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры", СтруктураИд.ИДХарактеристики);
				СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
			КонецЕсли;
			Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
				УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры", СтруктураИд.ИДУпаковки);
				СписокТЧ.Добавить(УпаковкаНоменклатуры, "Упаковка");
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
				РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
			СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеПоТЧОтчетаОПродажахКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	ПрочитатьДанныеПоТоваруКаталога(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
КонецПроцедуры

Процедура УдалитьПрочитатьДанныеПоТЧОтчетаОПродажахКомиссионногоТовара(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	Если ТипЗнч(НаборДанных) = Тип("СписокXDTO") Тогда
		Для Каждого Элемент Из НаборДанных Цикл
			СписокТЧ = Новый СписокЗначений;
			НаимТовара = "";
			ИдТовара = "";
			ЕстьДопРеквизиты = Ложь;
			
			// Номенклатура.
			РеквизитыНоменклатуры = Новый Структура;
			Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
				ЗнДанных = Элемент[ТекСвойство.Имя];
				
				Если ЗнДанных = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				// Разберем свойства Товара.
				Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
					РеквизитыНоменклатуры.Вставить("Ид", ЗнДанных);
					ИдТовара = РеквизитыНоменклатуры.Ид;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
					РеквизитыНоменклатуры.Вставить("Наименование", ЗнДанных);
					НаимТовара = РеквизитыНоменклатуры.Наименование;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
					РеквизитыНоменклатуры.Вставить("Артикул", ЗнДанных);
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						РеквизитыЕдИзм = Новый Структура;
						РеквизитыЕдИзм.Вставить("Код",          ЗнДанных.Код);
						РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
						
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", ЗнДанных.Код, РеквизитыЕдИзм);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(	НайденныйТипВДереве, ЗнДанных.Код, ЗнДанных.Наименование, 
							ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							РеквизитыНоменклатуры.Вставить("БазоваяЕдиница", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЕдиницаИзмерения") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						РеквизитыЕдИзм = Новый Структура;
						РеквизитыЕдИзм.Вставить("Код",          Строка(ЗнДанных.Код));
						РеквизитыЕдИзм.Вставить("Наименование", ЗнДанных.Наименование);
						ЕдИзм = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(ЗнДанных.Код),
							РеквизитыЕдИзм);
						НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
						НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Строка(ЗнДанных.Код), ЗнДанных.Наименование,
							ЕдИзм, РеквизитыЕдИзм, ДеревоРазбора, Ошибка);
						Если ЗначениеЗаполнено(ЕдИзм) Тогда
							РеквизитыНоменклатуры.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Количество") Тогда
					// Запомним кол-во упаковок, в которых отгружали
					СписокТЧ.Добавить(Число(ЗнДанных), "КоличествоУпаковок");
					// Пересчитаем с учетом коэффициента
					// если есть свойство ЕдиницаИзмерения, получим значение.
					Коэф = "";
					Если Элемент.ЕдиницаИзмерения <> Неопределено Тогда
						Коэф = Элемент.ЕдиницаИзмерения.Коэффициент;
					КонецЕсли;
					Если НЕ ЗначениеЗаполнено(Коэф) Тогда
						Коэф = 1;
					КонецЕсли;
					СписокТЧ.Добавить(Коэф, "Коэффициент");
					СписокТЧ.Добавить(Число(ЗнДанных) * Коэф, "Количество");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("СуммыПоТовару") Тогда
					Если ТипЗнч(ЗнДанных) = Тип("ОбъектXDTO") Тогда
						Для Каждого ТекСв Из ЗнДанных.Свойства() Цикл
							Если ВРег(ТекСв.Имя) = ВРег("Налог") Тогда
								Налоги = ЗнДанных.ПолучитьСписок(ТекСв);
								Для Каждого Налог Из Налоги Цикл
									Если ВРег(Налог.ТипНалога) = "НДС" Тогда
										СписокТЧ.Добавить(Налог.ВеличинаСтавкиНалога,"СтавкаНДС");
										СписокТЧ.Добавить(Налог.Сумма, "СуммаНДС");
									КонецЕсли;
								КонецЦикла;
							ИначеЕсли ВРег(ТекСв.Имя) = ВРег("СуммаОбщая") Тогда
								СписокТЧ.Добавить(ЗнДанных.СуммаОбщая, "СуммаПродажи");
							ИначеЕсли ВРег(ТекСв.Имя) = ВРег("СуммаБезНалога") Тогда
								СписокТЧ.Добавить(ЗнДанных.СуммаБезНалога, "СуммаБезНДС");
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Цена") Тогда
					СписокТЧ.Добавить(ЗнДанных, "ЦенаПродажи");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЦенаКомитента") Тогда
					СписокТЧ.Добавить(ЗнДанных, "Цена");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("СуммаКомитента") Тогда
					СписокТЧ.Добавить(ЗнДанных, "Сумма");
				ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеРеквизиты") Тогда
					ЕстьДопРеквизиты = Истина;
					СтруктураДопРеквизитов = Новый Структура;
					Для Каждого ЭлементДанных Из ЗнДанных Цикл
						
						Если ЭлементДанных.Значение.Количество() > 1 Тогда
							МассивЗначений = Новый Массив;
							Для Каждого ЭлементЗначения Из ЭлементДанных.Значение Цикл
							// Для адресов покупателя разберем строку адреса в структуру адреса ФНС
							Если ЭлементДанных.Наименование = "ПокупательФактАдрес" ИЛИ ЭлементДанных.Наименование = "ПокупательЮрАдрес" Тогда
								ЭлементЗначения = РазложитьАдрес(ЭлементЗначения);
							ИначеЕсли ЭлементДанных.Наименование = "ДатаПродажи" Тогда
								ЭлементЗначения = ПолучитьДатуВремяИзСтроки(ЭлементЗначения);
							КонецЕсли;
							МассивЗначений.Добавить(ЭлементЗначения)
						КонецЦикла;
							СтруктураДопРеквизитов.Вставить(ЭлементДанных.Наименование, МассивЗначений);
						Иначе
						
							ЭлементЗначения = ЭлементДанных.Значение[0];
							// Для адресов покупателя разберем строку адреса в структуру адреса ФНС
							Если ЭлементДанных.Наименование = "ПокупательФактАдрес" ИЛИ ЭлементДанных.Наименование = "ПокупательЮрАдрес" Тогда
								ЭлементЗначения = РазложитьАдрес(ЭлементЗначения);
							ИначеЕсли ЭлементДанных.Наименование = "ДатаПродажи" Тогда
								ЭлементЗначения = ПолучитьДатуВремяИзСтроки(ЭлементЗначения);
							КонецЕсли;
							СтруктураДопРеквизитов.Вставить(ЭлементДанных.Наименование, ЭлементЗначения);
						КонецЕсли;
					КонецЦикла;
				Иначе
					СписокТЧ.Добавить(ЗнДанных, ТекСвойство.Имя);
				КонецЕсли;
			КонецЦикла;
			
			Если ЕстьДопРеквизиты Тогда
				СписокТЧ.Добавить(СтруктураДопРеквизитов, "ДополнительныеРеквизиты");
			КонецЕсли;
			
			СтруктураИд = РазобратьИДТовара(ИдТовара);
			Номенклатура = ЭлементСправочникаПоИД("Номенклатура", СтруктураИд.ИдТовара);
			Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
				ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры",
					СтруктураИд.ИДХарактеристики);
				СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
			КонецЕсли;
			Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
				УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры",
					СтруктураИд.ИДУпаковки);
				СписокТЧ.Добавить(УпаковкаНоменклатуры, "Упаковка");
			КонецЕсли;
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
				РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
			СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");
			
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);
			
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Функция НайтиСоздатьСтрокуВДеревеРазбора(СтрокаТипаВДереве, ИдОбъекта, ОписаниеОбъекта, СсылкаНаОбъект, ДопРеквизиты, ДеревоРазбора, Ошибка)
	
	Если ЗначениеЗаполнено(СсылкаНаОбъект) Тогда
		НайденнаяСтрока = СтрокаТипаВДереве.Строки.Найти(СсылкаНаОбъект, "СсылкаНаОбъект");
		Если НайденнаяСтрока = Неопределено Тогда
			НайденнаяСтрока = СтрокаТипаВДереве.Строки.Добавить();
			НайденнаяСтрока.СсылкаНаОбъект = СсылкаНаОбъект;
			НайденнаяСтрока.ИД = ИдОбъекта;
			НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
			НайденнаяСтрока.ОписаниеТипа = ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта(СтрокаТипаВДереве.ТипОбъекта);
			НайденнаяСтрока.ИндексСтроки = СтрокаТипаВДереве.ИндексСтроки + "_"
				+ Строка(СтрокаТипаВДереве.Строки.Индекс(НайденнаяСтрока));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
		Иначе
			Если НЕ ЭтоНоменклатура(СсылкаНаОбъект) Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
				// Проверим, что Описания совпадают по одной ссылке
				Если НайденнаяСтрока.ОписаниеОбъекта <> ОписаниеОбъекта Тогда
					// Ошибка: по ссылке существуют в ЭД разные по Описанию объекты
					Ошибка = Истина;
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Ошибка в данных эл.документа: на один Объект <%1>, два Описания <%2> и <%3>'"), СсылкаНаОбъект,
						НайденнаяСтрока.ОписаниеОбъекта, ОписаниеОбъекта);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
					НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
				КонецЕсли;
			Иначе
				// У номенклатуры может быть такое, в случае когда несколько элементов вход.данных
				// имеют ссылку на один элемент справочника.
				ПараметрыОтбора = Новый Структура;
				ПараметрыОтбора.Вставить("СсылкаНаОбъект",  СсылкаНаОбъект);
				ПараметрыОтбора.Вставить("ОписаниеОбъекта", ОписаниеОбъекта);
				ПараметрыОтбора.Вставить("ИД",              ИдОбъекта);
				НайденныеСтроки = СтрокаТипаВДереве.Строки.НайтиСтроки(ПараметрыОтбора);
				Если НайденныеСтроки.Количество() = 0 Тогда
					НайденнаяСтрока = СтрокаТипаВДереве.Строки.Добавить();
					НайденнаяСтрока.СсылкаНаОбъект  = СсылкаНаОбъект;
					НайденнаяСтрока.ИД              = ИдОбъекта;
					НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
					НайденнаяСтрока.ОписаниеТипа    = ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта(
						СтрокаТипаВДереве.ТипОбъекта);
					НайденнаяСтрока.ИндексСтроки    = СтрокаТипаВДереве.ИндексСтроки + "_" + Строка(СтрокаТипаВДереве.Строки.Индекс(
						НайденнаяСтрока));
					ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
				ИначеЕсли НайденныеСтроки.Количество() = 1 Тогда
					НайденнаяСтрока = НайденныеСтроки[0];
				Иначе // Непредвиденная ситуация
					// Ошибка: по ссылке существуют в ЭД разные по Описанию объекты
					Ошибка = Истина;
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = 'Ошибка в данных эл.документа: неуникальное описание для ИД <%1>, Описание <%2>'"),
						ИдОбъекта, ОписаниеОбъекта);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ЗначениеЗаполнено(ИдОбъекта) Тогда
		
		НайденнаяСтрока = СтрокаТипаВДереве.Строки.Найти(ИдОбъекта, "ИД");
		Если НайденнаяСтрока = Неопределено Тогда
			НайденнаяСтрока = СтрокаТипаВДереве.Строки.Добавить();
			НайденнаяСтрока.ИД              = ИдОбъекта;
			НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
			Если ЭтоСсылочныйОбъект(СтрокаТипаВДереве.ТипОбъекта) Тогда
				НайденнаяСтрока.ОписаниеТипа = ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта(
					СтрокаТипаВДереве.ТипОбъекта);
			КонецЕсли;
			НайденнаяСтрока.ИндексСтроки    = СтрокаТипаВДереве.ИндексСтроки + "_" + Строка(СтрокаТипаВДереве.Строки.Индекс(
				НайденнаяСтрока));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
		Иначе
			Возврат НайденнаяСтрока;
		КонецЕсли;
	Иначе
		НайденнаяСтрока = СтрокаТипаВДереве.Строки.Найти(ОписаниеОбъекта, "ОписаниеОбъекта");
		Если НайденнаяСтрока = Неопределено Тогда
			НайденнаяСтрока = СтрокаТипаВДереве.Строки.Добавить();
			НайденнаяСтрока.ОписаниеОбъекта = ОписаниеОбъекта;
			НайденнаяСтрока.ОписаниеТипа    = ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта(
				СтрокаТипаВДереве.ТипОбъекта);
			НайденнаяСтрока.ИндексСтроки    = СтрокаТипаВДереве.ИндексСтроки + "_" + Строка(СтрокаТипаВДереве.Строки.Индекс(
				НайденнаяСтрока));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьДопРеквизиты(НайденнаяСтрока, ДопРеквизиты, ДеревоРазбора);
		КонецЕсли;
	КонецЕсли;
	
	Возврат НайденнаяСтрока;
	
КонецФункции

Функция ЭтоСсылочныйОбъект(ТипОбъекта)
	
	Если ТипОбъекта = "Штамп" Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция РазобратьИДТовара(знач ИД)
	
	СтруктураВозврата = Новый Структура("ИДТовара, ИДХарактеристики, ИДУпаковки");
	Если Не ЗначениеЗаполнено(ИД) Тогда
		Возврат СтруктураВозврата;
	КонецЕсли;
	
	Поз = СтрНайти(ИД, "#");
	Если Поз > 0 Тогда
		
		СтруктураВозврата.ИДТовара = Сред(ИД, 1 , Поз - 1);
		Если СтрДлина(ИД) > Поз Тогда
			
			Ид = Сред(ИД, Поз + 1);
			Поз = СтрНайти(ИД, "#");
			Если Поз > 0 Тогда
				СтруктураВозврата.ИДХарактеристики = Сред(ИД, 1 ,Поз - 1);
			КонецЕсли;
			
			Ид = Сред(ИД, Поз + 1);
			Если СтрДлина(ИД) > Поз Тогда
				СтруктураВозврата.ИДУпаковки = Сред(ИД, Поз);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

Функция СформироватьСтруктуруТовара()
	
	СтруктураВозврата = Новый Структура("Номенклатура, Характеристика, Упаковка");
	Возврат СтруктураВозврата;
	
КонецФункции

Функция ДанныеЗаказчикаИзДопДанных(ДеревоДопДанных)
	
	Заказчик = Неопределено;
	СтрокаШапка = ДеревоДопДанных.Строки.Найти("Шапка");
	Если НЕ СтрокаШапка = Неопределено Тогда
		СтруктураДанныхЗаказчика = Новый Структура;
		СформироватьСтруктуруПоДопДанным(СтрокаШапка, СтруктураДанныхЗаказчика);
		Заказчик = Новый Структура;
		НаименованиеЗаказчика = "";
		Если СтруктураДанныхЗаказчика.Свойство("Заказчик", НаименованиеЗаказчика) Тогда //ЮрЛицо
			Заказчик.Вставить("ПолноеНаименование", НаименованиеЗаказчика);
			ИННЗаказчика = "";
			Если СтруктураДанныхЗаказчика.Свойство("ЗаказчикИНН", ИННЗаказчика) Тогда
				Заказчик.Вставить("ИНН", ИННЗаказчика);
			КонецЕсли;
			КППЗаказчика = "";
			Если СтруктураДанныхЗаказчика.Свойство("ЗаказчикКПП", КППЗаказчика) Тогда
				Заказчик.Вставить("КПП", КППЗаказчика);
			КонецЕсли;
			Заказчик.Вставить("ЮрФизЛицо", ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ЮрФизЛицо", "ЮрЛицо"));
			
			// Банковский счет заказчика
			НаимБанк = "";
			Если СтруктураДанныхЗаказчика.Свойство("НаимБанк", НаимБанк) Тогда
				Заказчик.Вставить("НаимБанк", НаимБанк);
			КонецЕсли;
			НомерСчета = "";
			Если СтруктураДанныхЗаказчика.Свойство("НомерСчета", НомерСчета) Тогда
				Заказчик.Вставить("НомерСчета", НомерСчета);
			КонецЕсли;
			БИК = "";
			Если СтруктураДанныхЗаказчика.Свойство("БИК", БИК) Тогда
				Заказчик.Вставить("БИК", БИК);
			КонецЕсли;
			
		Иначе // ФизЛицо
			ФамилияЗаказчика = "";
			Если СтруктураДанныхЗаказчика.Свойство("ЗаказчикФамилия", ФамилияЗаказчика) Тогда
				НаименованиеЗаказчика = ФамилияЗаказчика;
			КонецЕсли;
			ИмяЗаказчика = "";
			Если СтруктураДанныхЗаказчика.Свойство("ЗаказчикИмя", ИмяЗаказчика) Тогда
				НаименованиеЗаказчика = НаименованиеЗаказчика + " " + ИмяЗаказчика;
			КонецЕсли;
			ОтчествоЗаказчика = "";
			Если СтруктураДанныхЗаказчика.Свойство("ЗаказчикОтчество", ОтчествоЗаказчика) Тогда
				НаименованиеЗаказчика = НаименованиеЗаказчика + " " + ОтчествоЗаказчика;
			КонецЕсли;
			Заказчик.Вставить("ПолноеНаименование", НаименованиеЗаказчика);
			ИННЗаказчика = "";
			Если СтруктураДанныхЗаказчика.Свойство("ЗаказчикИНН", ИННЗаказчика) Тогда
				Заказчик.Вставить("ИНН", ИННЗаказчика);
			КонецЕсли;
			Заказчик.Вставить("ЮрФизЛицо", ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ЮрФизЛицо", "ФизЛицо"));
		КонецЕсли;
		
		ЗаказчикАдрес_Представление = "";
		Если СтруктураДанныхЗаказчика.Свойство("ЗаказчикАдрес_Представление", ЗаказчикАдрес_Представление) Тогда
			Заказчик.Вставить("ЮридическийАдрес_Представление", ЗаказчикАдрес_Представление);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Заказчик;

КонецФункции

// Возвращает ссылка на элемент справочника.
//
// Параметры:
//  Наименование - Строка, название справочника в метаданных.
//  ИД - Уникальный идентификатор элемента.
//
// Возвращаемое значение:
//  Ссылка на элемент справочника.
//
Функция ЭлементСправочникаПоИД(Наименование, ИД)
	
	Результат = Неопределено;
	
	ИмяПрикладногоСправочника = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяПрикладногоСправочника(Наименование);
	Если ЗначениеЗаполнено(ИмяПрикладногоСправочника) Тогда
		Если ЗначениеЗаполнено(ИД) И СтроковыеФункцииКлиентСервер.ЭтоУникальныйИдентификатор(ИД) Тогда
			UID = Новый УникальныйИдентификатор(ИД);
			Результат = Справочники[ИмяПрикладногоСправочника].ПолучитьСсылку(UID);
			
			Если Не ОбщегоНазначения.СсылкаСуществует(Результат) Тогда
				Результат = Неопределено;
			КонецЕсли;
		Иначе
			Результат = ОбменСКонтрагентамиПовтИсп.ПолучитьПустуюСсылку(Наименование);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ЗначениеДопРеквизитаЭД(ЭД, ИмяРеквизита)
	
	ЗначениеРеквизита = Неопределено;
	
	ДополнительныеРеквизиты = ЭД.ДополнительныеРеквизиты.Получить();
	Если ДополнительныеРеквизиты = Неопределено Тогда
		Возврат ЗначениеРеквизита;
	КонецЕсли;
	
	ДополнительныеРеквизиты.Свойство(ИмяРеквизита, ЗначениеРеквизита);
	
	Возврат ЗначениеРеквизита;
	
КонецФункции

Функция ПространствоИменОтветногоТитула(ПространствоИменТитула)
	
	ИменаТитулов = Новый Соответствие;
	ИменаТитулов.Вставить("OTORG12","PTORG12");
	ИменаТитулов.Вставить("OTORG_5_01_02","PTORG_5_01_02");
	ИменаТитулов.Вставить("IAKTPRM","ZAKTPRM");
	ИменаТитулов.Вставить("IAKTPRM2","ZAKTPRM2");
	ИменаТитулов.Вставить("IAKTPRM_5_01_02","ZAKTPRM_5_01_02");
	
	ПространствоОтветногоТитула = ИменаТитулов.Получить(ПространствоИменТитула);
	
	Возврат ПространствоОтветногоТитула;
	
КонецФункции

Процедура ДобавитьКонтрагентаВДеревоРазбора(ДеревоРазбора, НовыйЭД, ВидКонтрагента, РеквизитыКонтрагента, Ошибка)
	
	Контрагент = Неопределено; 
	ОбменСКонтрагентамиПереопределяемый.СсылкаНаОбъектПоИННКПП("Контрагенты", РеквизитыКонтрагента.ИНН, РеквизитыКонтрагента.КПП, Контрагент);
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ВидКонтрагента);
	ИдКонтрагента = РеквизитыКонтрагента.ИНН + РеквизитыКонтрагента.КПП;
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдКонтрагента, "ИНН+КПП: "+ИдКонтрагента,
		Контрагент, РеквизитыКонтрагента, ДеревоРазбора, Ошибка);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Контрагент", НайденнаяСтрока.ИндексСтроки);
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// Чтение xml по схеме версии CML2

Функция ЗначениеДопРеквизитаДокумента(ИмяРеквизита, ЭД)
	
	ЗначениеРеквизита = Неопределено;
	
	Если ЭД.Свойства().Получить("ЗначенияРеквизитов") = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ТипЗнч(ЗначениеСвойстваXDTO(ЭД, "ЗначенияРеквизитов")) <> Тип("ОбъектXDTO") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Реквизиты = ЗначениеСвойстваXDTO(ЭД, "ЗначенияРеквизитов.ЗначениеРеквизита",, Истина);
	
	Для Каждого ТекРеквизит Из Реквизиты Цикл
		
		Наименование = ЗначениеСвойстваXDTO(ТекРеквизит, "Наименование");
		Значение     = ЗначениеСвойстваXDTO(ТекРеквизит, "Значение");
		
		Если ВРег(Наименование) = ВРег(ИмяРеквизита) Тогда
			ЗначениеРеквизита = Значение;
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ТипЗнч(ЗначениеРеквизита) = Тип("СписокXDTO") Тогда
		Если ЗначениеРеквизита.Количество() = 1 Тогда
			ЗначениеРеквизита = ЗначениеРеквизита[0];
		КонецЕсли;
	КонецЕсли;
	
	Возврат ЗначениеРеквизита;
	
КонецФункции

Функция ЭтоПростойТипЭлементаXDTO(Элемент)
	
	ЭтоПростойТип = Истина;
	ТипЭлемента = ТипЗнч(Элемент);
	Если ТипЭлемента = Тип("СписокXDTO")
		ИЛИ ТипЭлемента = Тип("ОбъектXDTO")
		ИЛИ ТипЭлемента = Тип("ЗначениеXDTO") Тогда
		ЭтоПростойТип = Ложь;
	КонецЕсли;
	
	Возврат ЭтоПростойТип;
	
КонецФункции

Функция ЭтоДопРеквизит(НаименованиеРеквизита)
	
	НомерСимвола = СтрНайти(НаименованиеРеквизита, "Доп_");
	
	Возврат НомерСимвола > 0;
	
КонецФункции

// Процедура выполняет чтение универсальной структуры данных схемы 2 (разработанной
// для передачи произвольных данных в шапке и в табличных частях: список из набора пар:
// наименование реквизита и список значений реквизитов.
//
// Параметры:
//  ЗначенияРеквизитов - СписокXDTO, Массив - список реквизитов и значений.
//    *Элементы массива - ОбъектXDTO - единичный элемент списка реквизитов и значений.
//  Приемник - строка дерева данных, список значений - строка дерева, в которую помещаются извлеченные из xml-файла данные,
//    либо список значений (при разборе таблицы товаров).
//  Ошибка - Булево - флаг ошибки.
//
Процедура ПрочитатьСписокЗначенийРеквизитовCML(ЗначенияРеквизитов, Приемник, Ошибка, ДопРеквизиты = Неопределено)
	
	Если ЗначенияРеквизитов = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	ДополнительныеРеквизиты = Новый Структура;
	ОбычныеРеквизиты        = Новый Структура;

	Если ТипЗнч(ЗначенияРеквизитов) = Тип("ОбъектXDTO") Тогда
		МассивЗначенийРеквизитов = Новый Массив;
		МассивЗначенийРеквизитов.Добавить(ЗначенияРеквизитов);
	Иначе
	    МассивЗначенийРеквизитов = ЗначенияРеквизитов;
	КонецЕсли;
	
	Для Каждого Реквизит Из МассивЗначенийРеквизитов Цикл
		
		НаименованиеРеквизита = ЗначениеСвойстваXDTO(Реквизит, "Наименование");
		ЗначениеРеквизита     = ЗначениеСвойстваXDTO(Реквизит, "Значение");
		
		Если ЗначениеРеквизита = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		ЗначениеРеквизитаКоллекция = Новый Массив;
		ЗначениеРеквизитаКоллекция.Добавить(ЗначениеРеквизита);
		
		Если ЭтоДопРеквизит(НаименованиеРеквизита) Тогда
			ЗапомнитьРеквизитыДерева(ДополнительныеРеквизиты,
				НаименованиеРеквизита, ЗначениеРеквизитаКоллекция, Приемник, ДопРеквизиты);
		Иначе
			ЗапомнитьРеквизитыДерева(ОбычныеРеквизиты,
				НаименованиеРеквизита, ЗначениеРеквизитаКоллекция, Приемник, ДопРеквизиты);
		КонецЕсли;
		
	КонецЦикла;
	
	Если ДополнительныеРеквизиты.Количество() Тогда
		ДобавитьРеквизитВПриемник("ДопДанныеПодписанные", ДополнительныеРеквизиты, Приемник)
	КонецЕсли;
	
	Для Каждого КлючЗначение Из ОбычныеРеквизиты Цикл
		ДобавитьРеквизитВПриемник(КлючЗначение.Ключ, КлючЗначение.Значение, Приемник);
	КонецЦикла;
	
КонецПроцедуры

Функция ЗначениеДополнительногоРеквизита(РеквизитЗначение)
	
	МассивЗначений = Новый Массив;
	Для Каждого Значение Из РеквизитЗначение Цикл
		МассивЗначений.Добавить(Значение);
	КонецЦикла;
	ЗначениеРеквизита = ?(МассивЗначений.Количество() > 1, МассивЗначений, МассивЗначений[0]);
	
	Возврат ЗначениеРеквизита;
	
КонецФункции

Процедура ЗапомнитьРеквизитыДерева(СтруктураРеквизитов, НаименованиеРеквизита, ЗначениеРеквизита, Приемник, ДопРеквизиты)
	
	ИмяРеквизита = СтрЗаменить(НаименованиеРеквизита, "Доп_", "");
	
	Если ДопРеквизиты = Неопределено Тогда
		ДопРеквизиты = Новый Структура;
	КонецЕсли;
	
	Если СтрНайти(ИмяРеквизита, "_Таблица") > 0 Тогда
		
		ИмяРеквизита = СтрЗаменить(ИмяРеквизита, "_Таблица", "");
		РеквизитЗначение = ТаблицаИзСтроки(ЗначениеРеквизита);
		
		Если ВРег(ИмяРеквизита) = ВРег("ДокументыОснования")
			Или ВРег(ИмяРеквизита) = ВРег("ДокументОснование") Тогда
			// В актуальных ЭД передаются идентификаторы документов ИБ, для поиска основания:
			ЕстьИДДокументаОснования = РеквизитЗначение.Колонки.Найти("ИдентификаторДокументаОснования") <> Неопределено;
			
			МассивДО = Новый Массив;
			
			Для Каждого ТекСтрока Из РеквизитЗначение Цикл
				Если ЕстьИДДокументаОснования Тогда
					ДокументОснование = ДокументОснованиеПоИдентификатору(ТекСтрока.ИдентификаторДокументаОснования, ДопРеквизиты);
				Иначе
					ДокументОснование = ПолучитьДокументОснование(ТекСтрока.Наименование, ДопРеквизиты);
				КонецЕсли;
				МассивДО.Добавить(ДокументОснование);
			КонецЦикла;
			
			Если МассивДО.Количество() = 1 Тогда
				РеквизитЗначение = МассивДО[0];
			Иначе
				РеквизитЗначение = МассивДО;
			КонецЕсли;
			
		КонецЕсли;
		
	ИначеЕсли ВРег(ИмяРеквизита) = ВРег("ДокументыСделки") Тогда
		
		РеквизитЗначение = ТаблицаИзСтроки(ЗначениеРеквизита);
		
	ИначеЕсли ВРег(ИмяРеквизита) = ВРег("ЦенаВключаетНДС") Тогда
		
		ЦенаВключаетНДС = ЗначениеДополнительногоРеквизита(ЗначениеРеквизита);
		
		Если ВРег(ЦенаВключаетНДС) = ВРег("false") Тогда
			РеквизитЗначение = Ложь;
		ИначеЕсли ВРег(ЦенаВключаетНДС) = ВРег("true") Тогда
			РеквизитЗначение = Истина;
		КонецЕсли;
		
	ИначеЕсли ВРег(ИмяРеквизита) = ВРег("ДатаИсправления") Тогда
		
		ДатаИсправленияЗначение = ЗначениеДополнительногоРеквизита(ЗначениеРеквизита);
		Попытка
			РеквизитЗначение = ДатаИзСтроки(ДатаИсправленияЗначение);
		Исключение
			РеквизитЗначение = ДатаДД_ММ_ГГГГ(ДатаИсправленияЗначение);
		КонецПопытки;
	Иначе
		РеквизитЗначение = ЗначениеДополнительногоРеквизита(ЗначениеРеквизита);
		
	КонецЕсли;
	
	СтруктураРеквизитов.Вставить(ИмяРеквизита, РеквизитЗначение);
	
КонецПроцедуры

Функция ТаблицаИзСтроки(Знач ЗначенияРеквизита)
	
	ПредставлениеТаблицы = ЗначенияРеквизита[0];
	
	Попытка
		ТаблицаРезультат = ЗначениеИзСтрокиВнутр(ПредставлениеТаблицы);
	Исключение
		Попытка
			ТаблицаРезультат = ТаблицаИзСтрокиСРазделителем(ПредставлениеТаблицы);
		Исключение
			Возврат Новый ТаблицаЗначений;
		КонецПопытки;
	КонецПопытки;
	
	Возврат ТаблицаРезультат;
	
КонецФункции

Процедура ДобавитьРеквизитВПриемник(НаименованиеРеквизита, ЗначениеРеквизита, Приемник)
	
	Если ТипЗнч(Приемник) = Тип("СписокЗначений") Тогда
		Приемник.Добавить(ЗначениеРеквизита, НаименованиеРеквизита);
	Иначе
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(Приемник, НаименованиеРеквизита, ЗначениеРеквизита);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДанныеКонтрагентаCML(Элемент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка, Роль = "", ДопПараметры = Неопределено)
	Перем МассивИдКонтрагентов;
	
	Если Элемент = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	РасчетныйСчетВДопДанных = Ложь;
	Если ТипЗнч(ДопПараметры) = Тип("Структура") Тогда
		Если ДопПараметры.Свойство("РасчетныйСчет") Тогда
			РасчетныйСчетВДопДанных = Истина;
		КонецЕсли;
		ДопПараметры.Свойство("МассивИдКонтрагентов", МассивИдКонтрагентов);
	КонецЕсли;
	
	
	ВидКонтрагента  = "";
	ВидДопАналитики = "";
	Если Роль = "Поставщик"
		ИЛИ (Роль = "Лицензиар" ИЛИ Роль = "Комиссионер") И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ (Роль = "Лицензиат" ИЛИ Роль = "Комитент") И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий
		ИЛИ Роль = "Продавец"
		ИЛИ Роль = "Исполнитель" Тогда
		ВидКонтрагента = "Организации";
		ИмяРеквизита = "Организация";
		ВидБанковскогоСчета = "БанковскиеСчетаОрганизаций";
	ИначеЕсли Роль = "Покупатель"
		ИЛИ (Роль = "Лицензиат" ИЛИ Роль = "Комитент") И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ (Роль = "Лицензиар" ИЛИ Роль = "Комиссионер") И НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		
		ВидКонтрагента = "Контрагенты";
		ИмяРеквизита = "Контрагент";
		ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		ДопАналитика = "Партнер";
		ВидДопАналитики = "Партнеры";
		
	ИначеЕсли Роль = "Плательщик" Или Роль = "Получатель" Тогда
		ВидКонтрагента = "Контрагенты";
		ИмяРеквизита = Роль;
		ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		ДопАналитика = "Партнер";
	ИначеЕсли Роль = "ПокупательКомиссионногоТовара" Тогда
		ВидКонтрагента = "Контрагенты";
		ИмяРеквизита = "Покупатель";
		ВидБанковскогоСчета = "БанковскиеСчетаКонтрагентов";
		ДопАналитика = "Партнер";
	КонецЕсли;
	
	РеквизитыКонтрагента = Новый Структура;
	Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
		
		ЗнДанных = Элемент[ТекСвойство.Имя];
		
		Если ЗнДанных = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
			
			ИдКонтрагента = ЗнДанных;
			// Разберем ИД на ИНН и КПП
			СтруктураПоиска = РазобратьИДКонтрагента(ИдКонтрагента);
			Если СтруктураПоиска.Свойство("ИНН") Тогда
				РеквизитыКонтрагента.Вставить("ИНН", СтруктураПоиска.ИНН);
			КонецЕсли;
			Если СтруктураПоиска.Свойство("КПП") Тогда
				РеквизитыКонтрагента.Вставить("КПП", СтруктураПоиска.КПП);
			КонецЕсли;
			
			// При комиссионной торговле в ЭД могут присутствовать несколько контрагентов,
			// у некоторых из них могут совпадать идентификаторы (Комитент/Комиссионер и Покупатель),
			// в этом случае надо в дерево разбора добавить только данные Комитента/Комиссионера.
			Если ВидКонтрагента = "Контрагенты"
				И ТипЗнч(МассивИдКонтрагентов) = Тип("Массив") Тогда
				Если МассивИдКонтрагентов.Найти(ИдКонтрагента) = Неопределено Тогда
					МассивИдКонтрагентов.Добавить(ИдКонтрагента);
				Иначе
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ОфициальноеНаименование")
			ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ПолноеНаименование") Тогда
			
			РеквизитыКонтрагента.Вставить("ПолноеНаименование", ЗнДанных);
			ЮрФизЛицо = ?(ВРег(ТекСвойство.Имя) = ВРег("ПолноеНаименование"), "ФизЛицо", "ЮрЛицо");
			РеквизитыКонтрагента.Вставить("ЮрФизЛицо", ОбменСКонтрагентамиПовтИсп.НайтиПеречисление("ЮрФизЛицо", ЮрФизЛицо));
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Адрес") ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ЮридическийАдрес") Тогда
			
			Если Роль = "Плательщик" ИЛИ Роль = "Поставщик" Тогда
				ПрефиксАдреса = "ЮридическийАдрес";
			Иначе
				ПрефиксАдреса = ?(ВРег(ТекСвойство.Имя) = ВРег("Адрес"), "ФактическийАдрес", "ЮридическийАдрес");
			КонецЕсли;
			
			Для Каждого Свойство Из ЗнДанных.Свойства() Цикл
				Реквизит = ЗнДанных[Свойство.Имя];
				Если Реквизит <> Неопределено Тогда
					Если ВРег(Свойство.Имя) = ВРег("Представление") Тогда
						РеквизитыКонтрагента.Вставить(ПрефиксАдреса + "_Представление", Реквизит);
					ИначеЕсли ВРег(Свойство.Имя) = ВРег("АдресноеПоле") Тогда
						СтруктураАдреса = Новый Структура;
						// Если реквизит не является списком (например, если один элемент, преобразование в массив).
						Если ТипЗнч(Реквизит) = Тип("ОбъектXDTO") Тогда
							Реквизит = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Реквизит);
						КонецЕсли;
						Для Каждого ЭлементАдреса Из Реквизит Цикл
							НормТип = ЗначениеСвойстваXDTO(ЭлементАдреса, "Тип");
							Если НормТип = НСтр("ru = 'Почтовый индекс'") Тогда
								НормТип = "Индекс";
							ИначеЕсли НормТип = "Регион" Тогда
								НормТип = "КодРегион";
							ИначеЕсли НормТип = НСтр("ru = 'Населенный пункт'") Тогда
								НормТип = "НаселПункт";
							ИначеЕсли НормТип = "Квартира" Тогда
								НормТип = "Кварт";
							КонецЕсли;
							СтруктураАдреса.Вставить(НормТип, ЗначениеСвойстваXDTO(ЭлементАдреса, "Значение"));
						КонецЦикла;
						Если ЗначениеЗаполнено(СтруктураАдреса) Тогда
							РеквизитыКонтрагента.Вставить("АдресСтруктурой", СтруктураАдреса);
						КонецЕсли;
					Иначе
						РеквизитыКонтрагента.Вставить(Свойство.Имя, Реквизит);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Руководитель") Тогда
			
			СтРеквизитов = Новый Структура;
			Для Каждого Свойство Из ЗнДанных.Свойства() Цикл
				Реквизит = ЗнДанных[Свойство.Имя];
				Если Реквизит <> Неопределено Тогда
					Если ЭтоПростойТипЭлементаXDTO(Реквизит) Тогда
						СтРеквизитов.Вставить(Свойство.Имя, Реквизит);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			РеквизитыКонтрагента.Вставить("Руководитель", СтРеквизитов);
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Контакты") Тогда
			ТаблицаКонтактов = Новый ТаблицаЗначений();
			ТаблицаКонтактов.Колонки.Добавить("Вид");
			ТаблицаКонтактов.Колонки.Добавить("Представление");
			ТаблицаКонтактов.Колонки.Добавить("ЗначенияПолей");
			
			Контакты = ЗначениеСвойстваXDTO(ЗнДанных, "Контакт",, Истина);
			Если Контакты <> Неопределено Тогда
				Для Каждого Контакт Из Контакты Цикл
					Вид = Неопределено;
					Тип = ЗначениеСвойстваXDTO(Контакт, "Тип");
					Если Тип = НСтр("ru = 'Почта'") Тогда
						Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации","EmailКонтрагента");
					ИначеЕсли Тип = НСтр("ru = 'Телефон рабочий'") Тогда
						Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации","ТелефонКонтрагента");
					ИначеЕсли Тип = НСтр("ru = 'Факс'") Тогда
						Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации","ФаксКонтрагента");
					КонецЕсли;
					Если ЗначениеЗаполнено(Вид) Тогда // добавляем только, если есть виды контактной информации в конфигурации-приемнике
						НовКонт = ТаблицаКонтактов.Добавить();
						НовКонт.Вид = Вид;
						НовКонт.Представление = ЗначениеСвойстваXDTO(Контакт, "Значение");
						НовКонт.ЗначенияПолей = ЗначениеСвойстваXDTO(Контакт, "Комментарий");
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			РеквизитыКонтрагента.Вставить(ТекСвойство.Имя, ТаблицаКонтактов);

		Иначе
			РеквизитыКонтрагента.Вставить(ТекСвойство.Имя, ЗнДанных);
		КонецЕсли;
		
	КонецЦикла;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, ВидКонтрагента);
	
	СтруктураПоиска = Новый Структура("ИНН,КПП");
	ЗаполнитьЗначенияСвойств(СтруктураПоиска, РеквизитыКонтрагента);
	Контрагент = ЭлектронноеВзаимодействие.НайтиСсылку(ВидКонтрагента, ИдКонтрагента, СтруктураПоиска);
	
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдКонтрагента, "ИНН+КПП: " + ИдКонтрагента,
		Контрагент, РеквизитыКонтрагента, ДеревоРазбора, Ошибка);
	Если Роль <> "ПокупательКомиссионногоТовара" Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, ИмяРеквизита, НайденнаяСтрока.ИндексСтроки);
	КонецЕсли;
	
	// Определяем расчетный счет контрагента
	Если НЕ ТипЗнч(Элемент) = Тип("Структура") Тогда
		Если Элемент.Свойства().Получить("РасчетныйСчет") <> Неопределено
			И ТипЗнч(Элемент.РасчетныйСчет) = Тип("ОбъектXDTO") Тогда
			
			ВладелецСчета = ?(НовыйЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий, "Продавец", "Покупатель");
			
			Если НовыйЭД.ВидЭД = Перечисления.ВидыЭД.СчетНаОплату Тогда
				Если ВРег(Роль) = ВРег(ВладелецСчета) И Не РасчетныйСчетВДопДанных Тогда
					ПрочитатьДанныеПоРасчетномуСчету(НовыйЭД, Элемент.РасчетныйСчет, ДеревоРазбора,
						"БанковскиеСчетаКонтрагентов", Роль, Контрагент, Ошибка);
				КонецЕсли;
			Иначе
				
				ПрочитатьДанныеПоРасчетномуСчету(НовыйЭД, Элемент.РасчетныйСчет, ДеревоРазбора,
					ВидБанковскогоСчета, Роль, Контрагент, Ошибка);
			КонецЕсли;
		КонецЕсли;
		
		Если Элемент.Свойства().Получить("РасчетныеСчета") <> Неопределено
			И ТипЗнч(Элемент.РасчетныеСчета) = Тип("ОбъектXDTO") Тогда
			
			Если ВРег(НовыйЭД.ВидЭД) = ВРег("РеквизитыОрганизации") Тогда
				
				// Эта процедура считывает расчетные счета контрагента и добавляет их как строки табличной части документа.
				// Используется при обмене реквизитами организации.
				ПрочитатьДанныеПоРасчетнымСчетамКонтрагентаCML(НовыйЭД, Элемент.РасчетныеСчета, ДеревоРазбора,
					ВидБанковскогоСчета, Роль, Контрагент, Ошибка);
			Иначе
				СписокРС = ЗначениеСвойстваXDTO(Элемент, "РасчетныеСчета.РасчетныйСчет",, Истина);
				Для Каждого РасчетныйСчет Из СписокРС Цикл
					ПрочитатьДанныеПоРасчетномуСчету(НайденнаяСтрока, РасчетныйСчет, ДеревоРазбора,
						ВидБанковскогоСчета, Роль, Контрагент, Ошибка);
				КонецЦикла;
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	// При чтении документа СчетНаОплату CML в ДопПараметрах передается структура с реквизитами РасчетногоСчета,
	// который находиться в шапке макета "СчетНаОплату" обработки "ОбменСКонтрагентами".
	Если РасчетныйСчетВДопДанных Тогда
		ПрочитатьДанныеПоРасчетномуСчету(НовыйЭД, ДопПараметры.РасчетныйСчет, ДеревоРазбора,
										 ВидБанковскогоСчета, Роль, Контрагент, Ошибка);
	КонецЕсли;
	
	// Доп.аналитику добавим, если заполнена
	Если ЗначениеЗаполнено(ВидДопАналитики) Тогда
		Если ОбменСКонтрагентамиПовтИсп.ИспользуетсяДополнительнаяАналитикаКонтрагентовСправочникПартнеры() Тогда
			РеквизитыПартнера = Новый Структура();
			РеквизитыПартнера.Вставить("Контрагент", Контрагент);
			ИмяПрикладногоСправочника = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ИмяПрикладногоСправочника("Партнеры");
			
			ЗнДопАналитики = ЭлектронноеВзаимодействие.НайтиСсылку(ИмяПрикладногоСправочника, , РеквизитыПартнера);
			Если Не ЗначениеЗаполнено(ЗнДопАналитики) Тогда
				ЗнДопАналитики = Справочники[ИмяПрикладногоСправочника].ПустаяСсылка();
			КонецЕсли;

			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Партнеры");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДопАналитики.Код, "Код: "
				+ ЗнДопАналитики.Код, ЗнДопАналитики, РеквизитыПартнера, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Партнер", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Процедура читает простой список содержащий элементы простых типов (строка, число, ...).
// Прочитанные данные элемента списка помещаются в структуру (ключ - наименование параметра, значение - значение),
// структуры параметров помещаются в массив, массив записывается в дерево значений с именем объекта XDTO, элементом
// которого является список.
//
// Параметры:
//  ОбъектXDTO - объект XDTO - объект, содержащий единственный элемент - читаемый список XDTO.
//  НовыйЭД - строка дерева значений - строка дерева данных, в которую помещается массив с прочитанными данными.
//  Ошибка - строка - текст ошибки, возникшей в процессе обработки списка XDTO.
//
Процедура ДанныеСпискаЗначенийCML(ОбъектXDTO, НовыйЭД, Ошибка)
	
	МассивСтруктур = Новый Массив;
	СвойстваОбъекта = ОбъектXDTO.Свойства();
	Если СвойстваОбъекта.Количество() > 0 Тогда
		Если СвойстваОбъекта[0].ВерхняяГраница = -1 Тогда
			ИмяСписка = СвойстваОбъекта[0].Имя;
			Для Каждого ЭлементСписка Из ОбъектXDTO[ИмяСписка] Цикл
				СтруктураДанных = Новый Структура;
				Для Каждого Элемент Из ЭлементСписка.Свойства() Цикл
					Значение = ЭлементСписка[Элемент.Имя];
					СтруктураДанных.Вставить(Элемент.Имя, Значение);
				КонецЦикла;
				МассивСтруктур.Добавить(СтруктураДанных);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Если МассивСтруктур.Количество() > 0 Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, ОбъектXDTO.ВладеющееСвойство().Имя, МассивСтруктур);
	КонецЕсли;
	
КонецПроцедуры

Функция ЗначениеГруппыВДереве(ДеревоДанных, ПолныйПуть) 
	
	НайденнаяСтрока = ДеревоДанных.Строки.Найти(ПолныйПуть, "ПолныйПуть", Истина);
	Если НайденнаяСтрока <> Неопределено Тогда
		Возврат НайденнаяСтрока.Строки;
	КонецЕсли;
	
КонецФункции

Функция СсылкаРеквизитаДерева(Дерево, СтрокаДерева, ИмяРеквизита)
	
	ИндексРеквизита = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(Дерево, СтрокаДерева, ИмяРеквизита);
	Если ИндексРеквизита = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Разделитель = СтрНайти(ИндексРеквизита,"_");
	ПоказательИндекса = Лев(ИндексРеквизита, Разделитель - 1);
	
	СтрокиСсылкаРеквизита = Дерево.Строки.Найти(ПоказательИндекса, "ИндексСтроки");
	Если СтрокиСсылкаРеквизита = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	СтрокаРеквизита = СтрокиСсылкаРеквизита.Строки[0];
	
	Возврат СтрокаРеквизита.СсылкаНаОбъект;
	
КонецФункции

Функция НачалоДействияПостановленияПравительства625()

	Возврат Дата(2017, 7, 1);

КонецФункции

Функция НачалоДействияПостановленияПравительства981()

	Возврат Дата(2017, 10, 1);

КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Работа с деревом разбора

Процедура ЗаполнениеТаблицыТоваровДеревоДанных(ДеревоДанных, ИмяТаблицыТоваров, ИдентификаторыДокументовИЭДОснований)
	
	// Заполняем таблицу товаров
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти(ИмяТаблицыТоваров, "ПолныйПуть");
	
	ЗаполнятьСтавкуНДС = Истина;
	
	ИДФайла = ЗначениеРеквизитаДерева(ДеревоДанных, "ИдФайл");
	Если СтрНачинаетсяС(ИДФайла, "DP_REZRUISP") Тогда
		ЗаполнятьСтавкуНДС = Ложь;
	КонецЕсли;
	
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		СтрокаДопДанных = Товар.Строки.Найти(ИмяТаблицыТоваров + ".НомерСтроки.ДопДанныеПодписанные", "ПолныйПуть", Истина);
		ДокументОснование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.ДокументОснование");
		Если ЗначениеЗаполнено(ДокументОснование) Тогда
			ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(ДокументОснование, ИдентификаторыДокументовИЭДОснований);
			Для Каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанныеПодписанные.ВидДокументаОснования", Строка.ВидЭД);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных,
										"ДопДанныеПодписанные.НомерДокументаОснования",
										Строка.НомерДокументаОтправителя);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных,
										"ДопДанныеПодписанные.ДатаДокументаОснования",
										Формат(Строка.ДатаДокументаОтправителя, "ДЛФ=Д"));
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанныеПодписанные.ИДЭДДокументаОснования", Строка.Наименование);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ИдентификаторДокументаОснования", Строка.ИдентификаторДокументаОснования);
			КонецЦикла;
		КонецЕсли;
		
		Характеристика = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.Характеристика", Ложь);
		Упаковка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.Упаковка", Ложь);
		
		// Формирование идентификатора товара.
		Ид = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.ИдТовараУКонтрагента");
		Номенклатура = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.Номенклатура");
		Если НЕ ЗначениеЗаполнено(ИД) И ЗначениеЗаполнено(Номенклатура) Тогда
			ИДТовара = Номенклатура.УникальныйИдентификатор();
			ИДХарактеристики = ?(ЗначениеЗаполнено(Характеристика), Характеристика.УникальныйИдентификатор(), "");
			ИДУпаковки = ?(ЗначениеЗаполнено(Упаковка), Упаковка.УникальныйИдентификатор(), "");
			ИД = Строка(ИДТовара) + "#" + Строка(ИДХарактеристики) + "#" + Строка(ИДУпаковки);
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, ИмяТаблицыТоваров + ".НомерСтроки.ДопДанныеПодписанные.ИД", ИД);
		
		// Упаковки.
		Если ЗначениеЗаполнено(Упаковка) Тогда
			НаименованиеНоменклатуры = 
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.НаименованиеНоменклатуры")
				+ " (" + Упаковка + ")";
			ВставитьЗначениеВДерево(Товар, ИмяТаблицыТоваров + ".НомерСтроки.НаименованиеНоменклатуры", НаименованиеНоменклатуры);
		КонецЕсли;
		
		// Для Акт501 ставка НДС передается в дополнительных данных.
		Если ИмяТаблицыТоваров = "ТаблицаУслуг" И ЗаполнятьСтавкуНДС Тогда
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.СтавкаНДС")) Тогда
				Ставка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров + ".НомерСтроки.СтавкаНДС");
				СтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия( , Ставка);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанныеПодписанные.СтавкаНДС", СтавкаНДС);
			КонецЕсли;
		КонецЕсли;
		
		НомерСерии = ЗначениеРеквизитаДерева(Товар, ИмяТаблицыТоваров + ".НомерСтроки.НомерСерии", Ложь);
		Если ЗначениеЗаполнено(НомерСерии) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанныеПодписанные.НомерСерии", НомерСерии);
		КонецЕсли;
		СрокГодностиСерии = ЗначениеРеквизитаДерева(Товар, ИмяТаблицыТоваров + ".НомерСтроки.СрокГодностиСерии", Ложь);
		Если ЗначениеЗаполнено(СрокГодностиСерии) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанныеПодписанные.СрокГодностиСерии", СрокГодностиСерии);
		КонецЕсли;
		
		// Наименование страны происхождения пойдет в доп. данных
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, ИмяТаблицыТоваров+".НомерСтроки.ТаможеннаяДекларация", Ложь);
		Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
			СтрокиТД = Товар.Строки.Найти("ТаблицаТоваров.НомерСтроки.ТаможеннаяДекларация", "ПолныйПуть", Истина);
			
			ДопДанныеТаможеннойДекларации = Новый ТаблицаЗначений;
			ДопДанныеТаможеннойДекларации.Колонки.Добавить("КодСтраныПроисхождения");
			ДопДанныеТаможеннойДекларации.Колонки.Добавить("НаименованиеСтраныПроисхождения");
			Для Каждого СтрокаТД Из СтрокиТД.Строки Цикл
				КодСтраны = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаТД, ИмяТаблицыТоваров+".НомерСтроки.ТаможеннаяДекларация.НомерСтроки.КодСтраныПроисхождения");
				НаименованиеСтраныПроисхождения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаТД, ИмяТаблицыТоваров+".НомерСтроки.ТаможеннаяДекларация.НомерСтроки.НаименованиеСтраныПроисхождения");
				
				Если ЗначениеЗаполнено(КодСтраны) И ЗначениеЗаполнено(НаименованиеСтраныПроисхождения) Тогда 
					СтрокаДДТД =ДопДанныеТаможеннойДекларации.Добавить();
					СтрокаДДТД.КодСтраныПроисхождения = КодСтраны;
					СтрокаДДТД.НаименованиеСтраныПроисхождения = НаименованиеСтраныПроисхождения;
				КонецЕсли;
			КонецЦикла;
			Если ДопДанныеТаможеннойДекларации.Количество() Тогда 
				ЗаписьXML = Новый ЗаписьXML;
				ЗаписьXML.УстановитьСтроку();
				СериализаторXDTO.ЗаписатьXML(ЗаписьXML, ДопДанныеТаможеннойДекларации);
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных,
					ИмяТаблицыТоваров + ".НомерСтроки.ДопДанныеНеПодписанные.ДопДанныеТаможеннойДекларации", ЗаписьXML.Закрыть());
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с Соглашение об изменение стоимости

Процедура ЗаполнитьРеквизитыШапкиКорректировкаСтоимости(ДанныеПечати, Макет, ТабличныйДокумент)

	ЧастьЗаголовка1 = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Соглашение об изменении стоимости № %1 от %2'"),
		ДанныеПечати.НомерДокумента, Формат(ДанныеПечати.ДатаДокумента, "ДЛФ=D"));
	ЧастьЗаголовка2 = ?(ЗначениеЗаполнено(ДанныеПечати.НомерИсправления), 
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru=', исправление № %1 от %2'"),
			ДанныеПечати.НомерИсправления, Формат(Дата(ДанныеПечати.ДатаИсправления), "ДЛФ=D")), "");
				
	ЧастьЗаголовка3 = ?(ЗначениеЗаполнено(ДанныеПечати.ПредставлениеИсходногоДокумента), ДанныеПечати.ПредставлениеИсходногоДокумента
		+ " " + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='№ %1 от %2'"),
			ДанныеПечати.НомерИсходногоДокумента, Формат(Дата(ДанныеПечати.ДатаИсходногоДокумента), "ДЛФ=D")), "");
						
	ЧастьЗаголовка4 = ?(ЗначениеЗаполнено(ДанныеПечати.НомерИсправленияИсходногоДокумента),
		" " + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='с учетом исправления № %1 от %2'"),
			ДанныеПечати.НомерИсправленияИсходногоДокумента, Формат(Дата(ДанныеПечати.ДатаИсправленияИсходногоДокумента),"ДЛФ=D")), "");
				
	ТекстЗаголовка = ЧастьЗаголовка1 + ЧастьЗаголовка2 + Символы.ВК + ЧастьЗаголовка3 + ЧастьЗаголовка4;
		
	ОбластьМакетаЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьМакетаЗаголовок.Параметры.Заголовок = ТекстЗаголовка;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакетаЗаголовок, "Заголовок");
		
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьМакета.Параметры.Заполнить(ДанныеПечати);
	
	ОбластьМакета.Параметры.Основание =
		?(ЗначениеЗаполнено(ДанныеПечати.НаименованиеОснования), ДанныеПечати.НаименованиеОснования + " ", "")
		+ ?(ЗначениеЗаполнено(ДанныеПечати.ОснованиеНомер), "№ " + ДанныеПечати.ОснованиеНомер + " ", "")
		+ ?(ЗначениеЗаполнено(ДанныеПечати.ОснованиеДата), НСтр("ru='от'")
			+ " " + Формат(ДанныеПечати.ОснованиеДата, "ДЛФ=Д"), "");
		
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.СведенияОПоставщике,
		ОбластьМакета.Параметры.ПредставлениеПоставщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.СведенияОПокупателе,
		ОбластьМакета.Параметры.ПредставлениеПлательщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК");
		
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");

КонецПроцедуры

Функция ПолучитьДанныеИнформацияПродавцаДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	ДеревоДанных = СтрокаОбъекта.ЗначениеРеквизита;
	
	// Общие сведения по документу.
	СтатусУПД = "1";
	Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция") = "ДОП" Тогда
		СтатусУПД = "2";
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция") = "СЧФ" Тогда
		СтатусУПД = "3";
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("СтатусУПД", СтатусУПД);
	
	ДанныеЗаполненияШапки.Вставить("Номер", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "НомерДокумента"));
	ДанныеЗаполненияШапки.Вставить("Дата", Формат(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "ДатаДокумента"), "ДЛФ='ДД'"));
	
	НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
	ДатаИсправления = Формат(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления"), "ДЛФ='ДД'");
	ДанныеЗаполненияШапки.Вставить("НомерИсправления", ?(ЗначениеЗаполнено(НомерИсправления), НомерИсправления, "--"));
	ДанныеЗаполненияШапки.Вставить("ДатаИсправления", ?(ЗначениеЗаполнено(ДатаИсправления), ДатаИсправления, "--"));
	
	ШаблонВалюта = НСтр("ru ='%1, %2'");
	Валюта = СтрШаблон(ШаблонВалюта,
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаНаименование"),
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеЗаполненияШапки.Вставить("Валюта", Валюта);
	
	// Сведения о поставщике.
	СвойстваПродавца = ДанныеУчастникаСделкиУПД_УКД("СведенияОПродавце", ДеревоДанных);
	ДанныеЗаполненияШапки.Вставить("АдресПоставщика", СвойстваПродавца.Адрес);
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПоставщика", СвойстваПродавца.Представление);
	ДанныеЗаполненияШапки.Вставить("ИННПоставщика", СвойстваПродавца.ИНН_КПП);

	// Сведения о покупателе.
	СвойстваПокупателя = ДанныеУчастникаСделкиУПД_УКД("СведенияОПокупателе", ДеревоДанных);
	ДанныеЗаполненияШапки.Вставить("АдресПокупателя", СвойстваПокупателя.Адрес);
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПокупателя", СвойстваПокупателя.Представление);
	ДанныеЗаполненияШапки.Вставить("ИННПокупателя", СвойстваПокупателя.ИНН_КПП);

	// Сведения о грузоотправителе.
	ПредставлениеГрузоотправителя = "--";
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОГрузоотправителе")) Тогда
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОГрузоотправителе") = "ОнЖе" Тогда
			ПредставлениеГрузоотправителя = НСтр("ru = 'он же'");
		Иначе
			СвойстваГрузоотправителя = ДанныеУчастникаСделкиУПД_УКД("СведенияОГрузоотправителе.Грузоотправитель", ДеревоДанных, "Представление, Адрес");
			ПредставлениеГрузоотправителя = СтрШаблон("%1, %2", СвойстваГрузоотправителя.Представление, СвойстваГрузоотправителя.Адрес);
		КонецЕсли;
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("ПредставлениеГрузоотправителя", ПредставлениеГрузоотправителя);
	
	// Сведения о грузополучателе.
	ПредставлениеГрузополучателя = "--";
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОГрузополучателе")) Тогда
		СвойстваГрузополучателя = ДанныеУчастникаСделкиУПД_УКД("СведенияОГрузополучателе", ДеревоДанных, "Представление, Адрес");
		ПредставлениеГрузополучателя = СтрШаблон("%1, %2", СвойстваГрузополучателя.Представление, СвойстваГрузополучателя.Адрес);
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("ПредставлениеГрузополучателя", ПредставлениеГрузополучателя);
	
	// Сведения по платежным документам.
	ПоДокументу = "--";
	СтрокаТаблицы = ДеревоДанных.Строки.Найти("ПлатежноРасчетныеДокументы", "ПолныйПуть");
	Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
		ПоДокументу = "";
		ШаблонПоДокументу = НСтр("ru ='%1 от %2'");
		Для Каждого ПРД Из СтрокаТаблицы.Строки Цикл
			НомерПРД = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ПРД,
				"ПлатежноРасчетныеДокументы.НомерСтроки.НомерПРД");
			ДатаПРД = Формат(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ПРД,
				"ПлатежноРасчетныеДокументы.НомерСтроки.ДатаПРД"), "ДЛФ='ДД'");
			
			ПоДокументу = СтрШаблон(ШаблонПоДокументу, НомерПРД, ДатаПРД)
				+ ?(ЗначениеЗаполнено(ПоДокументу), ", " + ПоДокументу, "");
		КонецЦикла;
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("ПоДокументу", ПоДокументу);
	
	// Дополнительные сведения об участниках.
	СтрокаГосКонтракта = "--";
	ИдентификаторГосКонтракта = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта");
	Если ЗначениеЗаполнено(ИдентификаторГосКонтракта) Тогда
		СтрокаГосКонтракта = ИдентификаторГосКонтракта;
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("ИдентификаторГосКонтракта", СтрокаГосКонтракта);
	
	// Сведения таблицы счета-фактуры.
	ТаблицаЗначений = Новый ТаблицаЗначений;
	ТаблицаЗначений.Колонки.Добавить("НомерСтроки");
	ТаблицаЗначений.Колонки.Добавить("ТоварНаименование");
	ТаблицаЗначений.Колонки.Добавить("ТоварКод");
	ТаблицаЗначений.Колонки.Добавить("ЕдиницаИзмерения");
	ТаблицаЗначений.Колонки.Добавить("ЕдиницаИзмеренияКод");
	ТаблицаЗначений.Колонки.Добавить("Количество");
	ТаблицаЗначений.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровБезНалога");
	ТаблицаЗначений.Колонки.Добавить("СуммаАкциза");
	ТаблицаЗначений.Колонки.Добавить("НалоговаяСтавка");
	ТаблицаЗначений.Колонки.Добавить("СуммаНалога");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровСНалогом");
	ТаблицаЗначений.Колонки.Добавить("СтранаПроисхожденияКод");
	ТаблицаЗначений.Колонки.Добавить("ПредставлениеСтраны");
	ТаблицаЗначений.Колонки.Добавить("ПредставлениеГТД");
	ТаблицаЗначений.Колонки.Добавить("ДополнительныеДанные");
	
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		
		НоваяСтрока = ТаблицаЗначений.Добавить();
		НоваяСтрока.НомерСтроки = Товар.Значение;
		
		// Обязательные реквизиты:
		НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ТоварНаименование");
		НоваяСтрока.НалоговаяСтавка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
		НоваяСтрока.СтоимостьТоваровСНалогом = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		НоваяСтрока.СуммаАкциза = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаАкциза");
		НоваяСтрока.СуммаНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		
		// Необязательные реквизиты:
		НоваяСтрока.ТоварКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ТоварКод");
		НоваяСтрока.ЕдиницаИзмеренияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКод");
		НоваяСтрока.ЕдиницаИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияНаименование");

		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.ЦенаЗаЕдиницуИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
		НоваяСтрока.СтоимостьТоваровБезНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		
		СтранаПроисхожденияКод = "";
		ПредставлениеГТД = "";
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации");
		Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
			СтрокиТД = Товар.Строки.Найти("СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации", "ПолныйПуть", Истина);
			Для Каждого СтрокаТД Из СтрокиТД.Строки Цикл
				СтранаПроисхожденияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаТД, "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.СтранаПроисхожденияКод");
				НомерТД = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаТД, "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.ТаможеннаяДекларацияНомер");
				ПредставлениеГТД = НомерТД + ?(ЗначениеЗаполнено(ПредставлениеГТД), ", " + ПредставлениеГТД, "");
			КонецЦикла;
		КонецЕсли;

		НоваяСтрока.ПредставлениеГТД = ПредставлениеГТД;
		НоваяСтрока.СтранаПроисхожденияКод = СтранаПроисхожденияКод;
		НоваяСтрока.ПредставлениеСтраны = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтранаПроисхожденияНаименование");
		
		ДополнительныеДанные = Новый Соответствие;
		СтрокаТаблицы = Товар.Строки.Найти("СведенияОТоварах.НомерСтроки.ТекстоваяИнформация", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
				
				ДополнительныеДанные.Вставить(
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Идентификатор"),
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
					"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Значение"));
			КонецЦикла;
		КонецЕсли;
		НоваяСтрока.ДополнительныеДанные = ДополнительныеДанные;
	КонецЦикла;
	
	ВсегоСтоимостьТоваровБезНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровБезНалога");
	ДанныеЗаполненияШапки.Вставить("ВсегоСтоимостьТоваровБезНалога", ВсегоСтоимостьТоваровБезНалога);
	ВсегоСтоимостьТоваровСНалогом = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "ВсегоКОплате.ВсегоСтоимостьТоваровСНалогом");
	ДанныеЗаполненияШапки.Вставить("ВсегоСтоимостьТоваровСНалогом", ВсегоСтоимостьТоваровСНалогом);
	ВсегоСуммаНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "ВсегоКОплате.ВсегоСуммаНалога");
	ДанныеЗаполненияШапки.Вставить("ВсегоСуммаНалога", ВсегоСуммаНалога);
	ВсегоКоличество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "ВсегоКОплате.ВсегоКоличество");
	ДанныеЗаполненияШапки.Вставить("ВсегоКоличество", ВсегоКоличество);
	
	ДополнительныеДанные = Новый Соответствие;
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеСчетаФактуры")) Тогда
		
		СтрокиДопДанныеСчетаФактуры = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
		СтрокаТаблицы = СтрокиДопДанныеСчетаФактуры.Строки.Найти("ДопДанныеСчетаФактуры.ТекстоваяИнформация", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
				ДополнительныеДанные.Вставить(
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Идентификатор"),
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Значение"));
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	// Сведения о подписантах СФ.
	ДанныеЗаполненияПодвала = Новый Структура();
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОРуководителя") Тогда
		ДанныеЗаполненияПодвала.Вставить("ФИОРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОПБОЮЛ") Тогда
		ДанныеЗаполненияПодвала.Вставить("ФИОПБОЮЛ",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОПБОЮЛ"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "Свидетельство") Тогда
		ДанныеЗаполненияПодвала.Вставить("Свидетельство",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Свидетельство"));
	КонецЕсли;
	
	// Общие сведения по накладной.
	ДанныеЗаполненияПодвалаНакладной = Новый Структура();
	ДатаОтгрузкиТоваров = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаОтгрузкиТоваров");
	Если Не ЗначениеЗаполнено(ДатаОтгрузкиТоваров) Тогда
		ДатаОтгрузкиТоваров = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента");
	КонецЕсли;
	ДанныеЗаполненияПодвалаНакладной.Вставить("ДатаОтгрузкиТоваров", ДатаОтгрузкиТоваров);
	
	ИныеСведенияОбОтгрузке = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИныеСведенияОбОтгрузке");
	ДанныеЗаполненияПодвалаНакладной.Вставить("ИныеСведенияОбОтгрузке", ИныеСведенияОбОтгрузке);
	
	ПредставлениеОснования = "";
	Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОснованиеОтгрузкиТоваров");
	Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
		СтрокаТаблицы = ДеревоДанных.Строки.Найти("ОснованиеОтгрузкиТоваров", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого Основание Из СтрокаТаблицы.Строки Цикл
				
				ДокументНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНаименование");
				ДокументНомер = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументНомер");
				ДокументДата = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументДата");
				ДокументСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеОтгрузкиТоваров.НомерСтроки.ДокументДопСведения");
				
				ПредставлениеОснования = ДокументНаименование
					+ ?(ЗначениеЗаполнено(ДокументНомер), " " + СтрШаблон(НСтр("ru ='№ %1'"), ДокументНомер), "")
					+ ?(ЗначениеЗаполнено(ДокументДата), " " + СтрШаблон(НСтр("ru ='от %1'"), Формат(ДокументДата, "ДЛФ=D")), "")
					+ ?(ЗначениеЗаполнено(ДокументСведения), ", " + ДокументСведения, "")
					+ ?(ЗначениеЗаполнено(ПредставлениеОснования), ", " + ПредставлениеОснования, "");
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	ДанныеЗаполненияПодвалаНакладной.Вставить("ПредставлениеОснования", ПредставлениеОснования);
	
	// Сведения о транспортировке и грузе.
	СвойстваПеревозчика = ДанныеУчастникаСделкиУПД_УКД("СведенияОПеревозчике", ДеревоДанных, "Представление, ИНН_КПП");
	ПредставлениеПеревозчика = СвойстваПеревозчика.Представление;
	ИННПеревозчика = СвойстваПеревозчика.ИНН_КПП;
	
	ПредставлениеТранспортнойНакладной = "";
	Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
		СтрокаТаблицы = ДеревоДанных.Строки.Найти("ТранспортнаяНакладная", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			
			ШаблонТН = НСтр("ru ='ТН №%1 от %2'");
			Для Каждого Накладная Из СтрокаТаблицы.Строки Цикл
				ТранспортнаяНакладнаяНомер = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Накладная,
					"ТранспортнаяНакладная.НомерСтроки.ТранспортнаяНакладнаяНомер");
				ТранспортнаяНакладнаяДата = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Накладная,
					"ТранспортнаяНакладная.НомерСтроки.ТранспортнаяНакладнаяДата"));
				
				ПредставлениеТранспортнойНакладной = СтрШаблон(ШаблонТН, ТранспортнаяНакладнаяНомер, ТранспортнаяНакладнаяДата)
					+ ?(ЗначениеЗаполнено(ПредставлениеТранспортнойНакладной), ", " + ПредставлениеТранспортнойНакладной, "");
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	СведенияОТранспортировке = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОТранспортировке");
	
	ДанныеЗаполненияПодвалаНакладной.Вставить("ПредставлениеДанныхОТранспортировкеИГрузе",
		?(ЗначениеЗаполнено(ПредставлениеПеревозчика), ПредставлениеПеревозчика + ", ", "")
		+ ?(ЗначениеЗаполнено(ИННПеревозчика), ИННПеревозчика + ", ", "")
		+ ?(ЗначениеЗаполнено(ПредставлениеТранспортнойНакладной), ПредставлениеТранспортнойНакладной + ", ", "")
		+ ?(ЗначениеЗаполнено(СведенияОТранспортировке), СведенияОТранспортировке, ""));
	
	// Иные сведения о грузе.
	ИныеСведенияОбОтгрузке = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИныеСведенияОбОтгрузке");
	ДанныеЗаполненияПодвалаНакладной.Вставить("ИныеСведенияОбОтгрузке", ИныеСведенияОбОтгрузке);
	
	// Сведения о подписантах накладной.
	ДолжностьКладовщика = "";
	ФИОКладовщика = "";
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары")) Тогда
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары") = "РаботникОрганизацииПродавца" Тогда
			ДолжностьКладовщика = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Должность");
				
			ФИО = Новый Структура();
			ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Фамилия"));
			ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Имя"));
			ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Отчество"));
			ФИОКладовщика = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			
		ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары") = "ИноеЛицо" Тогда
			
			Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ПредставительОрганизации" Тогда
				ДолжностьКладовщика = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Должность");
					
				ФИО = Новый Структура();
				ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия"));
				ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Имя"));
				ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество"));
				ФИОКладовщика = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
				
			ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ФЛ" Тогда
				

				ФИО = Новый Структура();
				ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия"));
				ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя"));
				ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество"));
				ФИОКладовщика = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ФИОКладовщика) Тогда
		ДанныеЗаполненияПодвалаНакладной.Вставить("ДолжностьКладовщика", ДолжностьКладовщика);
		ДанныеЗаполненияПодвалаНакладной.Вставить("ФИОКладовщика", ФИОКладовщика);
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ДолжностьРуководителя") Тогда
		ДанныеЗаполненияПодвалаНакладной.Вставить("ДолжностьРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДолжностьРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОРуководителя")
		И ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя")) Тогда
		ДанныеЗаполненияПодвалаНакладной.Вставить("ФИОРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОПБОЮЛ")
		И ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОПБОЮЛ")) Тогда
		ДанныеЗаполненияПодвалаНакладной.Вставить("ФИОРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОПБОЮЛ"));
	КонецЕсли;
	
	ПредставлениеОрганизации = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		"СоставительДокументаНаименование");
	ДанныеЗаполненияПодвалаНакладной.Вставить("ПредставлениеОрганизации", ПредставлениеОрганизации);
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеДокументаОтгрузки")) Тогда
		СтрокиДопДанныеДокументаОтгрузки = ДеревоДанных.Строки.Найти("ДопДанныеДокументаОтгрузки", "ПолныйПуть");
		СтрокаТаблицы = СтрокиДопДанныеДокументаОтгрузки.Строки.Найти("ДопДанныеДокументаОтгрузки.ТекстоваяИнформация", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
				ДополнительныеДанные.Вставить(
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеДокументаОтгрузки.ТекстоваяИнформация.НомерСтроки.Идентификатор"),
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеДокументаОтгрузки.ТекстоваяИнформация.НомерСтроки.Значение"));
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("ДополнительныеДанные", ДополнительныеДанные);
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",           ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Подвал",          ДанныеЗаполненияПодвала);
	Если СтатусУПД <> "3" Тогда
		ДанныеДляОбъекта.Вставить("ПодвалНакладной", ДанныеЗаполненияПодвалаНакладной);
	КонецЕсли;
	ДанныеДляОбъекта.Вставить("Товары",          ТаблицаЗначений);
	ДанныеДляОбъекта.Вставить("ДатаДокумента",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "ДатаДокумента"));
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Процедура ЗаполнитьДанныеИнформацииПокупателя(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя)
	
	Результат = СформироватьДеревоРазбора(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя);
	
	Если Результат <> Неопределено Тогда
		ИнформацияПокупателя = ДанныеИнформацииПокупателя(Результат.СтрокаОбъекта.ЗначениеРеквизита);
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполняет данные, выводимые на печать
Функция ДанныеИнформацииПокупателя(ДеревоДанных)
	
	// Общие сведения по документу.
	ИнформацияПокупателя = Новый Структура;
	
	ДатаПолученияТоваров = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаПолученияТоваров");
	ИнформацияПокупателя.Вставить("ДатаПолученияТоваров", ДатаПолученияТоваров);
	
	ИныеСведенияОПолучении = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СодержаниеОперации");
	ИнформацияПокупателя.Вставить("ИныеСведенияОПолучении", ИныеСведенияОПолучении);
	
	// Сведения о подписантах накладной.
	ДолжностьКладовщикаПолучателя = "";
	ФИОКладовщикаПолучателя = "";
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары")) Тогда
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары") = "РаботникОрганизацииПокупателя" Тогда
			ДолжностьКладовщикаПолучателя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Должность");
				
			ФИО = Новый Структура();
			ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Фамилия"));
			ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Имя"));
			ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПринявшемТовары.РаботникОрганизацииПокупателя.Отчество"));
			ФИОКладовщикаПолучателя = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			
		ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары") = "ИноеЛицо" Тогда
			
			Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары.ИноеЛицо") = "ПредставительОрганизации" Тогда
				ДолжностьКладовщикаПолучателя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Должность");
					
				ФИО = Новый Структура();
				ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия"));
				ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Имя"));
				ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество"));
				ФИОКладовщикаПолучателя = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
				
			ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПринявшемТовары.ИноеЛицо") = "ФЛ" Тогда
				
				ФИО = Новый Структура();
				ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Фамилия"));
				ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Имя"));
				ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
					"СведенияОЛицеПринявшемТовары.ИноеЛицо.ФЛ.Отчество"));
				ФИОКладовщикаПолучателя = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ФИОКладовщикаПолучателя) Тогда
		ИнформацияПокупателя.Вставить("ДолжностьКладовщикаПолучателя", ДолжностьКладовщикаПолучателя);
		ИнформацияПокупателя.Вставить("ФИОКладовщикаПолучателя", ФИОКладовщикаПолучателя);
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ДолжностьРуководителя") Тогда
		ИнформацияПокупателя.Вставить("ДолжностьРуководителяПолучателя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДолжностьРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОРуководителя") Тогда
		ИнформацияПокупателя.Вставить("ФИОРуководителяПолучателя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя"));
	КонецЕсли;
	
	ПредставлениеКонтрагента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СоставительДокументаНаименование");
	ИнформацияПокупателя.Вставить("ПредставлениеКонтрагента", ПредставлениеКонтрагента);
	
	Возврат ИнформацияПокупателя;
	
КонецФункции

// Процедура заполняет табличный документ "УПД".
//
Процедура ЗаполнитьТабличныйДокументИнформацияПродавца(ТабличныйДокумент, ДанныеПечати, ИнформацияПокупателя, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_УПД_ИнформацияПродавца_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
		
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ИмяОбластиЗаголовокШапки = "ЗаголовокШапка";
	ИмяОбластиШапка = "Шапка";
	ИмяОбластиЗаголовокТаблицы = "ЗаголовокТаблицы";
	ИмяОбластиСтрока = "Строка";
	ИмяОбластиПодвал = "Подвал";
	Если ДанныеПечати.ДатаДокумента >= НачалоДействияПостановленияПравительства981() Тогда
		ИмяОбластиЗаголовокШапки = "ЗаголовокШапка981";
		ИмяОбластиШапка = "Шапка981";
		ИмяОбластиЗаголовокТаблицы = "ЗаголовокТаблицы981";
		ИмяОбластиСтрока = "Строка981";
		ИмяОбластиПодвал = "Подвал981";
	ИначеЕсли ДанныеПечати.ДатаДокумента >= НачалоДействияПостановленияПравительства625() Тогда
		ИмяОбластиЗаголовокШапки = "ЗаголовокШапка625";
		ИмяОбластиШапка = "Шапка625";
	КонецЕсли;
	
	ЗаголовокШапка = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокШапки);
	Если ДанныеПечати.Шапка.СтатусУПД = "3" Тогда
		ЗаголовокШапка = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокШапки + "|ЗаголовокШапкаОсновныеДанные");
	КонецЕсли;
	ЗаголовокШапка.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокШапка, "ЗаголовокШапка");
	
	Шапка = Макет.ПолучитьОбласть(ИмяОбластиШапка);
	Если ДанныеПечати.Шапка.СтатусУПД = "3" Тогда
		Шапка = Макет.ПолучитьОбласть(ИмяОбластиШапка + "|ШапкаОсновныеДанные");
	КонецЕсли;
	Шапка.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, Шапка, "Шапка");
	
	// Выводим заголовок таблицы.
	ЗаголовокТаблицы = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокТаблицы + "|ОсновныеДанныеТаблицы");
	Если ДанныеПечати.Шапка.СтатусУПД = "3" Тогда
		ЗаголовокТаблицы = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокТаблицы + "|ТаблицаОсновныеДанные");
	КонецЕсли;
	
	НомерЗаголовка = 1;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы,
		"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
	
	ДанныеСтроки = СтруктураДанныеСтроки(1);
	
	// Создаем массив для проверки вывода.
	МассивВыводимыхОбластей = Новый Массив;
	
	// Выводим многострочную часть документа.
	ОбластьМакета  = Макет.ПолучитьОбласть(ИмяОбластиСтрока + "|ОсновныеДанныеТаблицы");
	Если ДанныеПечати.Шапка.СтатусУПД = "3" Тогда
		ОбластьМакета = Макет.ПолучитьОбласть(ИмяОбластиСтрока + "|ТаблицаОсновныеДанные");
	КонецЕсли;
	ОбластьИтого   = Макет.ПолучитьОбласть("Итого|ОсновныеДанныеТаблицы");
	Если ДанныеПечати.Шапка.СтатусУПД = "3" Тогда
		ОбластьИтого = Макет.ПолучитьОбласть("Итого|ТаблицаОсновныеДанные");
	КонецЕсли;
	ОбластьПодвала = Макет.ПолучитьОбласть(ИмяОбластиПодвал);
	Если ДанныеПечати.Шапка.СтатусУПД = "3" Тогда
		ОбластьПодвала = Макет.ПолучитьОбласть(ИмяОбластиПодвал + "|ПодвалОсновныеДанные");
	КонецЕсли;
	
	ОбластьПодвалаНакладной = Макет.ПолучитьОбласть("ПодвалНакладной");
	
	Если Не СкрыватьДопДанные Тогда
		ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокТаблицы + "|ДопДанныеТаблицыСЭЦП");
		ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть(ИмяОбластиСтрока + "|ДопДанныеТаблицыСЭЦП");
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
			"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
	КонецЕсли;
	НомерЗаголовка = НомерЗаголовка + 1;
	
	Товары = ДанныеПечати.Товары;
	КоличествоСтрок = Товары.Количество();
	Для Каждого СтрокаТовары Из Товары Цикл
		
		ДанныеСтроки.Номер = ДанныеСтроки.Номер + 1;
		
		МассивВыводимыхОбластей.Очистить();
		МассивВыводимыхОбластей.Добавить(ОбластьМакета);
		
		Если ДанныеСтроки.Номер = КоличествоСтрок Тогда
			МассивВыводимыхОбластей.Добавить(ОбластьИтого);
			МассивВыводимыхОбластей.Добавить(ОбластьПодвала);
		КонецЕсли;
		
		Если НЕ ПроверитьВыводТабличногоДокумента(ТабличныйДокумент, МассивВыводимыхОбластей) Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы, 
				"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
			
			Если Не СкрыватьДопДанные Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
					"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
			КонецЕсли;
			
			НомерЗаголовка = НомерЗаголовка + 1;
		КонецЕсли;
		
		Если СтрокаТовары.СтранаПроисхожденияКод = "643" Тогда
			СтрокаТовары.СтранаПроисхожденияКод = "";
		КонецЕсли;
		
		Если ТолькоСимволыВСтроке(СтрокаТовары.ЕдиницаИзмеренияКод, "0") Тогда
			СтрокаТовары.ЕдиницаИзмеренияКод = "";
		КонецЕсли;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		
		Если СтрокаТовары.ЦенаЗаЕдиницуИзмерения <> Неопределено
			И СтрокаТовары.ЦенаЗаЕдиницуИзмерения = Окр(СтрокаТовары.ЦенаЗаЕдиницуИзмерения, 2) Тогда
			ОбластьМакета.Параметры.ЦенаЗаЕдиницуИзмерения = Формат(СтрокаТовары.ЦенаЗаЕдиницуИзмерения, "ЧДЦ=2");
		КонецЕсли;
		
		// В статусе 2 вместо "Без акциза" и "Без НДС" проставляются прочерки.
		Если ДанныеПечати.Шапка.СтатусУПД = "2" Тогда
			Если НРег(СтрокаТовары.СуммаАкциза) = НСтр("ru = 'без акциза'") Тогда
				ОбластьМакета.Параметры.СуммаАкциза = "";
			КонецЕсли;
			
			Если СтрокаТовары.НалоговаяСтавка = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия(НСтр("ru = 'без НДС'")) Тогда
				ОбластьМакета.Параметры.НалоговаяСтавка = "";
			КонецЕсли;
		Иначе
			Если СтрокаТовары.НалоговаяСтавка = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия(НСтр("ru = 'без НДС'")) Тогда
				ОбластьМакета.Параметры.СуммаНалога = НСтр("ru = 'Без НДС'");
			КонецЕсли; 
		КонецЕсли;
		
		ПроставитьПрочеркиВПустыеПоляСтрокиСчетФактура(ОбластьМакета);
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
			"СтрокаТоваровОсновныеДанные", ДанныеСтроки.Номер);
		
		Если Не СкрыватьДопДанные Тогда
			ДополнительныеДанные = СтрокаТовары.ДополнительныеДанные;
			Если ЗначениеЗаполнено(ДополнительныеДанные) Тогда
				
				ПодписанныеДанные = "";
				Для каждого Данные Из ДополнительныеДанные Цикл
					ПодписанныеДанные = ?(ЗначениеЗаполнено(ПодписанныеДанные),
						ПодписанныеДанные + Символы.ПС, "") + Данные.Ключ + " = " + Данные.Значение;
				КонецЦикла;
				ОбластьМакетаДДСЭП.Параметры.Подписанные = ПодписанныеДанные;
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП,
					"СтрокаТоваровДопДанные", ДанныеСтроки.Номер);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	ОбластьИтого.Параметры.Заполнить(ДанныеПечати.Шапка);
	
	Если ДанныеПечати.Шапка.СтатусУПД = "2" Тогда
		Если Не ЗначениеЗаполнено(ОбластьИтого.Параметры.ВсегоСуммаНалога) Тогда
			ОбластьИтого.Параметры.ВсегоСуммаНалога = "--";
		КонецЕсли;
	Иначе
		Если Не ЗначениеЗаполнено(ОбластьИтого.Параметры.ВсегоСуммаНалога) Тогда
			ОбластьИтого.Параметры.ВсегоСуммаНалога = НСтр("ru = 'Без НДС'");
		КонецЕсли; 
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтого,
			"ИтогоОсновныеДанные");
	
	ОбластьПодвала.Параметры.Заполнить(ДанныеПечати.Подвал);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвала,
			"ПодвалОсновныеДанные");
	
	Если ДанныеПечати.Свойство("ПодвалНакладной") Тогда
		ОбластьПодвалаНакладной.Параметры.Заполнить(ДанныеПечати.ПодвалНакладной);
		ОбластьПодвалаНакладной.Параметры.Заполнить(ИнформацияПокупателя);
		ОбластьПодвалаНакладной.Параметры.ДатаОтгрузкиТоваров = Формат(ДанныеПечати.ПодвалНакладной.ДатаОтгрузкиТоваров, "ДЛФ=DD");
		Если ИнформацияПокупателя.Свойство("ДатаПолученияТоваров") Тогда
			ОбластьПодвалаНакладной.Параметры.ДатаПолученияТоваров = Формат(ИнформацияПокупателя.ДатаПолученияТоваров, "ДЛФ=DD");
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвалаНакладной,
			"ПодвалНакладной");
	КонецЕсли;
	
	Если Не СкрыватьДопДанные Тогда
		ДополнительныеДанные = ДанныеПечати.Шапка.ДополнительныеДанные;
		Если ЗначениеЗаполнено(ДополнительныеДанные) Тогда
			МакетДД = ПолучитьОбщийМакет(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ИдентификаторДокумента_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
			
			НомСтр = 1;
			ОбластьМакета = МакетДД.ПолучитьОбласть("ДопДанныеШапки_Шапка");
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ДопДанныеШапкиШапка");
			Для каждого Данные Из ДополнительныеДанные Цикл
				
				ОбластьМакетаСЭП = МакетДД.ПолучитьОбласть("ДопДанныеШапки_Строка");
				ОбластьМакетаСЭП.Параметры.Нпп               = НомСтр;
				ОбластьМакетаСЭП.Параметры.ИмяРеквизита      = Данные.Ключ;
				ОбластьМакетаСЭП.Параметры.ЗначениеРеквизита = Данные.Значение;
				ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакетаСЭП, 
					"ДопДанныеШапкиСтрока", НомСтр);
				НомСтр = НомСтр + 1;
				
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьТабличныйДокумент_ИнформацияПокупателя(ТабличныйДокумент, ИнформацияПокупателя)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_УПД_ИнформацияПокупателя_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Заполнить(ИнформацияПокупателя);
	ОбластьМакета.Параметры.ДатаПолученияТоваров = Формат(ИнформацияПокупателя.ДатаПолученияТоваров, "ДЛФ=DD");
	ОбластьМакета.Параметры.ДатаДокументаОтправителя = Формат(ИнформацияПокупателя.ДатаДокументаОтправителя, "ДЛФ=DD");
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подписи");
	
КонецПроцедуры

Функция ПолучитьДанныеИнформацияПродавцаУКДДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	ДеревоДанных = СтрокаОбъекта.ЗначениеРеквизита;
	
	// Общие сведения по документу.
	СтатусУКД = "1";
	Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция") = "ДИС" Тогда
		СтатусУКД = "2";
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Функция") = "КСЧФ" Тогда
		СтатусУКД = "3";
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("СтатусУКД", СтатусУКД);
	
	ДанныеЗаполненияШапки.Вставить("Номер", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента"));
	ДанныеЗаполненияШапки.Вставить("Дата", Формат(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаДокумента"), "ДЛФ='ДД'"));
	
	НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления");
	ДатаИсправления = Формат(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления"), "ДЛФ='ДД'");
	ДанныеЗаполненияШапки.Вставить("НомерИсправления", ?(ЗначениеЗаполнено(НомерИсправления), НомерИсправления, "--"));
	ДанныеЗаполненияШапки.Вставить("ДатаИсправления", ?(ЗначениеЗаполнено(ДатаИсправления), ДатаИсправления, "--"));
	
	НомерИсходногоДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсходногоДокумента");
	ДатаИсходногоДокумента = Формат(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсходногоДокумента"), "ДЛФ='ДД'");
	ДанныеЗаполненияШапки.Вставить("НомерИсходногоДокумента", ?(ЗначениеЗаполнено(НомерИсходногоДокумента), НомерИсходногоДокумента, "--"));
	ДанныеЗаполненияШапки.Вставить("ДатаИсходногоДокумента", ?(ЗначениеЗаполнено(ДатаИсходногоДокумента), ДатаИсходногоДокумента, "--"));
	
	НомерИсправленияИсходногоДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправленияИсходногоДокумента");
	ДатаИсправленияИсходногоДокумента = Формат(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправленияИсходногоДокумента"), "ДЛФ='ДД'");
	ДанныеЗаполненияШапки.Вставить("НомерИсправленияИсходногоДокумента",
		?(ЗначениеЗаполнено(НомерИсправленияИсходногоДокумента), НомерИсправленияИсходногоДокумента, "--"));
	ДанныеЗаполненияШапки.Вставить("ДатаИсправленияИсходногоДокумента",
		?(ЗначениеЗаполнено(ДатаИсправленияИсходногоДокумента), ДатаИсправленияИсходногоДокумента, "--"));
	
	ШаблонВалюта = НСтр("ru ='%1, %2'");
	Валюта = СтрШаблон(ШаблонВалюта,
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДополнительныеСведенияОбУчастниках.ВалютаНаименование"),
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод"));
	ДанныеЗаполненияШапки.Вставить("Валюта", Валюта);
	
	// Сведения о поставщике.
	СвойстваПродавца = ДанныеУчастникаСделкиУПД_УКД("СведенияОПродавце", ДеревоДанных);
	ДанныеЗаполненияШапки.Вставить("АдресПоставщика", СвойстваПродавца.Адрес);
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПоставщика", СвойстваПродавца.Представление);
	ДанныеЗаполненияШапки.Вставить("ИННПоставщика", СвойстваПродавца.ИНН_КПП);
	
	// Сведения о покупателе.
	СвойстваПокупателя = ДанныеУчастникаСделкиУПД_УКД("СведенияОПокупателе", ДеревоДанных);
	ДанныеЗаполненияШапки.Вставить("АдресПокупателя", СвойстваПокупателя.Адрес);
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПокупателя", СвойстваПокупателя.Представление);
	ДанныеЗаполненияШапки.Вставить("ИННПокупателя", СвойстваПокупателя.ИНН_КПП);
	
	// Дополнительные сведения об участниках.
	СтрокаГосКонтракта = "--";
	ИдентификаторГосКонтракта = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		"ДополнительныеСведенияОбУчастниках.ИдентификаторГосКонтракта");
	Если ЗначениеЗаполнено(ИдентификаторГосКонтракта) Тогда
		СтрокаГосКонтракта = ИдентификаторГосКонтракта;
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("ИдентификаторГосКонтракта", СтрокаГосКонтракта);
	
	// Сведения таблицы счета-фактуры.
	ТаблицаЗначений = Новый ТаблицаЗначений;
	ТаблицаЗначений.Колонки.Добавить("НомерСтроки");
	ТаблицаЗначений.Колонки.Добавить("ТоварНаименование");
	ТаблицаЗначений.Колонки.Добавить("ТоварКод");
	ТаблицаЗначений.Колонки.Добавить("ЕдиницаИзмеренияДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("ЕдиницаИзмерения");
	ТаблицаЗначений.Колонки.Добавить("ЕдиницаИзмеренияКодДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("ЕдиницаИзмеренияКод");
	ТаблицаЗначений.Колонки.Добавить("КоличествоДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("Количество");
	ТаблицаЗначений.Колонки.Добавить("ЦенаЗаЕдиницуИзмеренияДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровБезНалогаДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровБезНалога");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровБезНалогаУвеличение");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровБезНалогаУменьшение");
	ТаблицаЗначений.Колонки.Добавить("СуммаАкцизаДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("СуммаАкциза");
	ТаблицаЗначений.Колонки.Добавить("СуммаАкцизаУвеличение");
	ТаблицаЗначений.Колонки.Добавить("СуммаАкцизаУменьшение");
	ТаблицаЗначений.Колонки.Добавить("НалоговаяСтавкаДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("НалоговаяСтавка");
	ТаблицаЗначений.Колонки.Добавить("СуммаНалогаДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("СуммаНалога");
	ТаблицаЗначений.Колонки.Добавить("СуммаНалогаУвеличение");
	ТаблицаЗначений.Колонки.Добавить("СуммаНалогаУменьшение");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровСНалогомДоКорректировки");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровСНалогом");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровСНалогомУвеличение");
	ТаблицаЗначений.Колонки.Добавить("СтоимостьТоваровСНалогомУменьшение");
	ТаблицаЗначений.Колонки.Добавить("ДополнительныеДанные");
	
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		
		НоваяСтрока = ТаблицаЗначений.Добавить();
		НоваяСтрока.НомерСтроки = Товар.Значение;
		
		НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ТоварНаименование");
			
		НоваяСтрока.ЕдиницаИзмеренияКодДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКодДоКорректировки");
		НоваяСтрока.ЕдиницаИзмеренияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКод");
		
		НоваяСтрока.ЕдиницаИзмеренияДоКорректировки = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКодДоКорректировки"));
		НоваяСтрока.ЕдиницаИзмерения = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКод"));
			
		НоваяСтрока.КоличествоДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.КоличествоДоКорректировки");
		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.Количество");
		НоваяСтрока.ЦенаЗаЕдиницуИзмеренияДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмеренияДоКорректировки");
		НоваяСтрока.ЦенаЗаЕдиницуИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.ЦенаЗаЕдиницуИзмерения");
			
		НоваяСтрока.СтоимостьТоваровБезНалогаДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалогаДоКорректировки");
		НоваяСтрока.СтоимостьТоваровБезНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
		НоваяСтрока.СтоимостьТоваровБезНалогаУвеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалогаУвеличение");
		НоваяСтрока.СтоимостьТоваровБезНалогаУменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалогаУменьшение");
			
			
		НоваяСтрока.НалоговаяСтавкаДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.НалоговаяСтавкаДоКорректировки");
		НоваяСтрока.НалоговаяСтавка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка");
			
		НоваяСтрока.СуммаНалогаДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаНалогаДоКорректировки");
		НоваяСтрока.СуммаНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаНалога");
		НоваяСтрока.СуммаНалогаУвеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаНалогаУвеличение");
		НоваяСтрока.СуммаНалогаУменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаНалогаУменьшение");
			
		НоваяСтрока.СуммаАкцизаДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаАкцизаДоКорректировки");
		НоваяСтрока.СуммаАкциза = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаАкциза");
		НоваяСтрока.СуммаАкцизаУвеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаАкцизаУвеличение");
		НоваяСтрока.СуммаАкцизаУменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СуммаАкцизаУменьшение");
			
		НоваяСтрока.СтоимостьТоваровСНалогомДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомДоКорректировки");
		НоваяСтрока.СтоимостьТоваровСНалогом = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
		НоваяСтрока.СтоимостьТоваровСНалогомУвеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомУвеличение");
		НоваяСтрока.СтоимостьТоваровСНалогомУменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогомУменьшение");
		
		ДополнительныеДанные = Новый Соответствие;
		СтрокаТаблицы = Товар.Строки.Найти("СведенияОТоварах.НомерСтроки.ТекстоваяИнформация", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
				
				ДополнительныеДанные.Вставить(
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Идентификатор"),
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
					"СведенияОТоварах.НомерСтроки.ТекстоваяИнформация.НомерСтроки.Значение"));
			КонецЦикла;
		КонецЕсли;
		НоваяСтрока.ДополнительныеДанные = ДополнительныеДанные;
	КонецЦикла;
	
	ДанныеЗаполненияШапки.Вставить("ВсегоСтоимостьТоваровБезНалогаУвеличение",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУвеличение"));
	ДанныеЗаполненияШапки.Вставить("ВсегоСтоимостьТоваровСНалогомУвеличение",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУвеличение"));
	ДанныеЗаполненияШапки.Вставить("ВсегоСуммаНалогаУвеличение",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУвеличение"));
	ДанныеЗаполненияШапки.Вставить("ВсегоСтоимостьТоваровБезНалогаУменьшение",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУменьшение"));
	ДанныеЗаполненияШапки.Вставить("ВсегоСтоимостьТоваровСНалогомУменьшение",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровСНалогомУменьшение"));
	ДанныеЗаполненияШапки.Вставить("ВсегоСуммаНалогаУменьшение",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоИзмененияСтоимости.ВсегоСуммаНалогаУменьшение"));
	
	ДополнительныеДанные = Новый Соответствие;
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДопДанныеСчетаФактуры")) Тогда
		
		СтрокиДопДанныеСчетаФактуры = ДеревоДанных.Строки.Найти("ДопДанныеСчетаФактуры", "ПолныйПуть");
		СтрокаТаблицы = СтрокиДопДанныеСчетаФактуры.Строки.Найти("ДопДанныеСчетаФактуры.ТекстоваяИнформация", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого Информация Из СтрокаТаблицы.Строки Цикл
				ДополнительныеДанные.Вставить(
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Идентификатор"),
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Информация,
						"ДопДанныеСчетаФактуры.ТекстоваяИнформация.НомерСтроки.Значение"));
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	ДанныеЗаполненияШапки.Вставить("ДополнительныеДанные", ДополнительныеДанные);
	
	// Сведения о подписантах КСФ.
	ДанныеЗаполненияПодвала = Новый Структура();
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОРуководителя") Тогда
		ДанныеЗаполненияПодвала.Вставить("ФИОРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОПБОЮЛ") Тогда
		ДанныеЗаполненияПодвала.Вставить("ФИОПБОЮЛ",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОПБОЮЛ"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "Свидетельство") Тогда
		ДанныеЗаполненияПодвала.Вставить("Свидетельство",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Свидетельство"));
	КонецЕсли;
	
	// Общие сведения по изменению стоимости.
	ДанныеЗаполненияПодвалаНакладной = Новый Структура();
	
	ДанныеЗаполненияПодвалаНакладной.Вставить("ИныеСведенияОбИзмененииСтоимости",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИныеСведенияОбИзмененииСтоимости"));
	ДанныеЗаполненияПодвалаНакладной.Вставить("РеквизитыПередаточныхДокументов",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РеквизитыПередаточныхДокументов"));
	
	ПредставлениеОснования = "";
	Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОснованиеКорректировки");
	Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
		СтрокаТаблицы = ДеревоДанных.Строки.Найти("ОснованиеКорректировки", "ПолныйПуть");
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			ШаблонПоДокументу = НСтр("ru ='№%1 от %2'");
			Для Каждого Основание Из СтрокаТаблицы.Строки Цикл
				
				ДокументНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеКорректировки.НомерСтроки.ДокументНаименование");
				ДокументНомер = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеКорректировки.НомерСтроки.ДокументНомер");
				ДокументДата = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеКорректировки.НомерСтроки.ДокументДата");
				ДокументСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					"ОснованиеКорректировки.НомерСтроки.ДокументДопСведения");
				
				ПредставлениеОснования = ДокументНаименование
					+ ?(ЗначениеЗаполнено(ДокументНомер), " " + СтрШаблон(НСтр("ru ='№ %1'"), ДокументНомер), "")
					+ ?(ЗначениеЗаполнено(ДокументДата), " " + СтрШаблон(НСтр("ru ='от %1'"), Формат(ДокументДата, "ДЛФ=D")), "")
					+ ?(ЗначениеЗаполнено(ДокументСведения), ", " + ДокументСведения, "")
					+ ?(ЗначениеЗаполнено(ПредставлениеОснования), ", " + ПредставлениеОснования, "");
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	ДанныеЗаполненияПодвалаНакладной.Вставить("ПредставлениеОснования", ПредставлениеОснования);
	
	// Сведения о подписантах накладной.
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ДолжностьРуководителя") Тогда
		ДанныеЗаполненияПодвалаНакладной.Вставить("ДолжностьРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДолжностьРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОРуководителя")
		И ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя")) Тогда
		ДанныеЗаполненияПодвалаНакладной.Вставить("ФИОРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОПБОЮЛ")
		И ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОПБОЮЛ")) Тогда
		ДанныеЗаполненияПодвалаНакладной.Вставить("ФИОРуководителя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОПБОЮЛ"));
	КонецЕсли;
	
	ПредставлениеОрганизации = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		"СоставительДокументаНаименование");
	ДанныеЗаполненияПодвалаНакладной.Вставить("ПредставлениеОрганизации", ПредставлениеОрганизации);
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",           ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Подвал",          ДанныеЗаполненияПодвала);
	Если СтатусУКД <> "3" Тогда
		ДанныеДляОбъекта.Вставить("ПодвалНакладной", ДанныеЗаполненияПодвалаНакладной);
	КонецЕсли;
	ДанныеДляОбъекта.Вставить("Товары",          ТаблицаЗначений);
	ДанныеДляОбъекта.Вставить("ДатаДокумента",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
		ДеревоДанных, "ДатаДокумента"));
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Процедура ЗаполнитьДанныеИнформацииПокупателяУКД(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя, ИнформацияПокупателя)
	
	Результат = СформироватьДеревоРазбора(ИмяФайлаПодчиненногоЭД, НаправлениеЭДПокупателя);
	
	Если Результат <> Неопределено Тогда
		ИнформацияПокупателя = ДанныеИнформацииПокупателяУКД(Результат.СтрокаОбъекта.ЗначениеРеквизита);
	КонецЕсли;
	
КонецПроцедуры

Функция ДанныеИнформацииПокупателяУКД(ДеревоДанных)
	
	// Общие сведения по документу.
	ИнформацияПокупателя = Новый Структура;
	
	ИнформацияПокупателя.Вставить("ДатаСогласования",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаСогласования"));
	
	// Сведения о подписантах накладной.
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ДолжностьРуководителя") Тогда
		ИнформацияПокупателя.Вставить("ДолжностьРуководителяПолучателя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДолжностьРуководителя"));
	КонецЕсли;
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ФИОРуководителя") Тогда
		ИнформацияПокупателя.Вставить("ФИОРуководителяПолучателя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ФИОРуководителя"));
	КонецЕсли;
	
	ПредставлениеКонтрагента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве
		(ДеревоДанных, "СоставительДокументаНаименование");
	ИнформацияПокупателя.Вставить("ПредставлениеКонтрагента", ПредставлениеКонтрагента);
	
	Возврат ИнформацияПокупателя;
	
КонецФункции

Процедура ЗаполнитьТабличныйДокументИнформацияПродавцаУКД(ТабличныйДокумент, ДанныеПечати, ИнформацияПокупателя, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_УКД_ИнформацияПродавца_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ИмяОбластиЗаголовокДокумента = "ЗаголовокДокумента";
	ИмяОбластиШапка = "Шапка";
	ИмяОбластиЗаголовокТаблицы = "ЗаголовокТаблицы";
	ИмяОбластиСтрока = "Строка";
	ИмяОбластиПодвал = "Подвал";
	Если ДанныеПечати.ДатаДокумента >= НачалоДействияПостановленияПравительства981() Тогда
		ИмяОбластиЗаголовокДокумента = "ЗаголовокДокумента981";
		ИмяОбластиШапка = "Шапка981";
		ИмяОбластиЗаголовокТаблицы = "ЗаголовокТаблицы981";
		ИмяОбластиСтрока = "Строка981";
		ИмяОбластиПодвал = "Подвал981";
	ИначеЕсли ДанныеПечати.ДатаДокумента >= НачалоДействияПостановленияПравительства625() Тогда
		ИмяОбластиЗаголовокДокумента = "ЗаголовокДокумента625";
		ИмяОбластиШапка = "Шапка625";
	КонецЕсли;
	
	ЗаголовокДокумента = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокДокумента);
	Если ДанныеПечати.Шапка.СтатусУКД = "3" Тогда
		ЗаголовокДокумента = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокДокумента + "|ЗаголовокДокументаОсновныеДанные");
	КонецЕсли;
	ЗаголовокДокумента.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокДокумента, 
		"ЗаголовокДокумента");
	
	ОбластьОснования = Макет.ПолучитьОбласть("ОбластьОснования");
	Если ДанныеПечати.Шапка.СтатусУКД = "3" Тогда
		ОбластьОснования = Макет.ПолучитьОбласть("ОбластьОснования|ОбластьОснованияОсновныеДанные");
	КонецЕсли;
	ОбластьОснования.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьОснования, 
		"ОбластьОснования");
	
	ШапкаДокумента = Макет.ПолучитьОбласть(ИмяОбластиШапка);
	Если ДанныеПечати.Шапка.СтатусУКД = "3" Тогда
		ШапкаДокумента = Макет.ПолучитьОбласть(ИмяОбластиШапка + "|ШапкаОсновныеДанные");
	КонецЕсли;
	ШапкаДокумента.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ШапкаДокумента, "Шапка");
	
	// Выводим заголовок таблицы.
	ЗаголовокТаблицы = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокТаблицы + "|ОсновныеДанныеТаблицы");
	Если ДанныеПечати.Шапка.СтатусУКД = "3" Тогда
		ЗаголовокТаблицы = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокТаблицы + "|ТаблицаОсновныеДанные");
	КонецЕсли;
	
	НомерЗаголовка = 1;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы,
		"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
	ДанныеСтроки = СтруктураДанныеСтроки(1);
	
	// Создаем массив для проверки вывода.
	МассивВыводимыхОбластей = Новый Массив;
	
	// Выводим многострочную часть документа.
	ОбластьМакета  = Макет.ПолучитьОбласть(ИмяОбластиСтрока + "|ОсновныеДанныеТаблицы");
	Если ДанныеПечати.Шапка.СтатусУКД = "3" Тогда
		ОбластьМакета = Макет.ПолучитьОбласть(ИмяОбластиСтрока + "|ТаблицаОсновныеДанные");
	КонецЕсли;
	ОбластьИтого   = Макет.ПолучитьОбласть("Итого|ОсновныеДанныеТаблицы");
	Если ДанныеПечати.Шапка.СтатусУКД = "3" Тогда
		ОбластьИтого = Макет.ПолучитьОбласть("Итого|ТаблицаОсновныеДанные");
	КонецЕсли;
	ОбластьПодвала = Макет.ПолучитьОбласть(ИмяОбластиПодвал);
	Если ДанныеПечати.Шапка.СтатусУКД = "3" Тогда
		ОбластьПодвала = Макет.ПолучитьОбласть(ИмяОбластиПодвал + "|ПодвалОсновныеДанные");
	КонецЕсли;
	
	ОбластьПодвалаНакладной = Макет.ПолучитьОбласть("ПодвалНакладной");
	
	Если Не СкрыватьДопДанные Тогда
		ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть(ИмяОбластиЗаголовокТаблицы + "|ДопДанныеТаблицыСЭЦП");
		ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть(ИмяОбластиСтрока + "|ДопДанныеТаблицыСЭЦП");
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
			"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
	КонецЕсли;
	НомерЗаголовка = НомерЗаголовка + 1;
	
	Товары = ДанныеПечати.Товары;
	КоличествоСтрок = Товары.Количество();
	Для Каждого СтрокаТовары Из Товары Цикл
		
		ДанныеСтроки.Номер = ДанныеСтроки.Номер + 1;
		
		МассивВыводимыхОбластей.Очистить();
		МассивВыводимыхОбластей.Добавить(ОбластьМакета);
		
		Если ДанныеСтроки.Номер = КоличествоСтрок Тогда
			МассивВыводимыхОбластей.Добавить(ОбластьИтого);
			МассивВыводимыхОбластей.Добавить(ОбластьПодвала);
		КонецЕсли;
		
		Если НЕ ПроверитьВыводТабличногоДокумента(ТабличныйДокумент, МассивВыводимыхОбластей) Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы,
				"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
			
			Если Не СкрыватьДопДанные Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
					"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
			КонецЕсли;
			НомерЗаголовка = НомерЗаголовка + 1;
		КонецЕсли;
		
		Если ТолькоСимволыВСтроке(СтрокаТовары.ЕдиницаИзмеренияКод, "0") Тогда
			СтрокаТовары.ЕдиницаИзмеренияКод = "";
		КонецЕсли;
		
		Если ТолькоСимволыВСтроке(СтрокаТовары.ЕдиницаИзмеренияКодДоКорректировки, "0") Тогда
			СтрокаТовары.ЕдиницаИзмеренияКодДоКорректировки = "";
		КонецЕсли;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		
		Если СтрокаТовары.ЦенаЗаЕдиницуИзмерения <> Неопределено
			И СтрокаТовары.ЦенаЗаЕдиницуИзмерения = Окр(СтрокаТовары.ЦенаЗаЕдиницуИзмерения, 2) Тогда
			ОбластьМакета.Параметры.ЦенаЗаЕдиницуИзмерения = Формат(СтрокаТовары.ЦенаЗаЕдиницуИзмерения, "ЧДЦ=2");
		КонецЕсли;
		
		Если СтрокаТовары.ЦенаЗаЕдиницуИзмеренияДоКорректировки <> Неопределено
			И СтрокаТовары.ЦенаЗаЕдиницуИзмеренияДоКорректировки = Окр(СтрокаТовары.ЦенаЗаЕдиницуИзмеренияДоКорректировки, 2) Тогда
			ОбластьМакета.Параметры.ЦенаЗаЕдиницуИзмеренияДоКорректировки =
				Формат(СтрокаТовары.ЦенаЗаЕдиницуИзмеренияДоКорректировки, "ЧДЦ=2");
		КонецЕсли;
		
		ПроставитьПрочеркиВПустыеПоляСтрокиСчетФактура(ОбластьМакета);
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
			"СтрокаОсновныеДанные", ДанныеСтроки.Номер);
		
		Если Не СкрыватьДопДанные Тогда
			ДополнительныеДанные = СтрокаТовары.ДополнительныеДанные;
			Если ЗначениеЗаполнено(ДополнительныеДанные) Тогда
				
				ПодписанныеДанные = "";
				Для каждого Данные Из ДополнительныеДанные Цикл
					ПодписанныеДанные = ?(ЗначениеЗаполнено(ПодписанныеДанные),
						ПодписанныеДанные + Символы.ПС, "") + Данные.Ключ + " = " + Данные.Значение;
				КонецЦикла;
				ОбластьМакетаДДСЭП.Параметры.Подписанные = ПодписанныеДанные;
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП,
					"СтрокаДопДанные", ДанныеСтроки.Номер);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	ОбластьИтого.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтого, "ИтогоОсновныеДанные");
	
	ОбластьПодвала.Параметры.Заполнить(ДанныеПечати.Подвал);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвала, "ПодвалОсновныеДанные");
	
	Если ДанныеПечати.Свойство("ПодвалНакладной") Тогда
		ОбластьПодвалаНакладной.Параметры.Заполнить(ДанныеПечати.ПодвалНакладной);
		ОбластьПодвалаНакладной.Параметры.Заполнить(ИнформацияПокупателя);
		Если ИнформацияПокупателя.Свойство("ДатаСогласования") Тогда
			ОбластьПодвалаНакладной.Параметры.ДатаСогласования = Формат(ИнформацияПокупателя.ДатаСогласования, "ДЛФ=DD");
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвалаНакладной, "ПодвалНакладной");
	КонецЕсли;
	
	Если Не СкрыватьДопДанные Тогда
		ДополнительныеДанные = ДанныеПечати.Шапка.ДополнительныеДанные;
		Если ЗначениеЗаполнено(ДополнительныеДанные) Тогда
			МакетДД = ПолучитьОбщийМакет(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ИдентификаторДокумента_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
			
			НомСтр = 1;
			ОбластьМакета = МакетДД.ПолучитьОбласть("ДопДанныеШапки_Шапка");
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ДопДанныеШапкиШапка");
			Для каждого Данные Из ДополнительныеДанные Цикл
				
				ОбластьМакетаСЭП = МакетДД.ПолучитьОбласть("ДопДанныеШапки_Строка");
				ОбластьМакетаСЭП.Параметры.Нпп               = НомСтр;
				ОбластьМакетаСЭП.Параметры.ИмяРеквизита      = Данные.Ключ;
				ОбластьМакетаСЭП.Параметры.ЗначениеРеквизита = Данные.Значение;
				ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакетаСЭП, "ДопДанныеШапкиСтрока", НомСтр);
				НомСтр = НомСтр + 1;
				
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьТабличныйДокумент_ИнформацияПокупателяУКД(ТабличныйДокумент, ИнформацияПокупателя)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_УКД_ИнформацияПокупателя_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Заполнить(ИнформацияПокупателя);
	ОбластьМакета.Параметры.ДатаСогласования = Формат(ИнформацияПокупателя.ДатаСогласования, "ДЛФ=DD");
	ОбластьМакета.Параметры.ДатаДокументаОтправителя = Формат(ИнформацияПокупателя.ДатаДокументаОтправителя, "ДЛФ=DD");
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подписи");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с ТОРГ-12

Функция ПолучитьДанныеНакладнойДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("ИНН", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКонтрагенте.Вставить("КПП", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКонтрагенте.Вставить("КодПоОКПО",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.НомерСчета"));
	СведенияОКонтрагенте.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Наименование"));
	СведенияОКонтрагенте.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Код"));
	СведенияОКонтрагенте.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.КоррСчет"));
	СведенияОКонтрагенте.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Телефоны"));
	
	СведенияООрганизации = Новый Структура;
	СведенияООрганизации.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ПолноеНаименование"));
	СведенияООрганизации.Вставить("ИНН",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ИНН"));
	СведенияООрганизации.Вставить("КПП",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.КПП"));
	СведенияООрганизации.Вставить("КодПоОКПО",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ОКПО"));
	СведенияООрганизации.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ЮридическийАдрес_Представление"));
	СведенияООрганизации.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ФактическийАдрес_Представление"));
	СведенияООрганизации.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.НомерСчета"));
	СведенияООрганизации.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.Банк.Наименование"));
	СведенияООрганизации.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.Банк.Код"));
	СведенияООрганизации.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.Банк.КоррСчет"));
	СведенияООрганизации.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.Телефоны"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКонтрагенте);
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
		
		ДанныеЗаполненияШапки.Вставить("ОрганизацияПоОКПО",       ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ОКПО"));
		ДанныеЗаполненияШапки.Вставить("ПредставлениеПоставщика", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.Наименование"));
		ДанныеЗаполненияШапки.Вставить("ПоставщикПоОКПО",         ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ОКПО"));
		ДанныеЗаполненияШапки.Вставить("ПредставлениеПлательщика",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Наименование"));
		ДанныеЗаполненияШапки.Вставить("ПлательщикПоОКПО",        ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ОКПО"));
		ДанныеЗаполненияШапки.Вставить("ГрузополучательПоОКПО",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ОКПО"));
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияООрганизации);
		
		ДанныеЗаполненияШапки.Вставить("ОрганизацияПоОКПО",       ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ОКПО"));
		ДанныеЗаполненияШапки.Вставить("ПредставлениеПоставщика", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Наименование"));
		ДанныеЗаполненияШапки.Вставить("ПоставщикПоОКПО",         ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ОКПО"));
		ДанныеЗаполненияШапки.Вставить("ПредставлениеПлательщика",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.Наименование"));
		ДанныеЗаполненияШапки.Вставить("ПлательщикПоОКПО",        ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ОКПО"));
		ДанныеЗаполненияШапки.Вставить("ГрузополучательПоОКПО",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ОКПО"));
	КонецЕсли;
	
	СведенияОГрузоотправителе = Новый Структура;
	СведенияОГрузоотправителе.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ПолноеНаименование"));
	СведенияОГрузоотправителе.Вставить("ИНН", 				 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ИНН"));
	СведенияОГрузоотправителе.Вставить("КПП", 				 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.КПП"));
	СведенияОГрузоотправителе.Вставить("КодПоОКПО", 		 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ОКПО"));
	СведенияОГрузоотправителе.Вставить("ЮридическийАдрес",	 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ЮридическийАдрес_Представление"));
	СведенияОГрузоотправителе.Вставить("ФактическийАдрес",	 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ФактическийАдрес_Представление"));
	СведенияОГрузоотправителе.Вставить("НомерСчета",		 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.НомерСчета"));
	СведенияОГрузоотправителе.Вставить("Банк",				 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.Банк.Наименование"));
	СведенияОГрузоотправителе.Вставить("БИК",				 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.Банк.Код"));
	СведенияОГрузоотправителе.Вставить("КоррСчет",			 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.Банк.КоррСчет"));
	СведенияОГрузоотправителе.Вставить("Телефоны",			 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.Телефоны"));
	
	ДанныеЗаполненияШапки.Вставить("СведенияОГрузоотправителе", СведенияОГрузоотправителе);
	
	СведенияОГрузополучателе = Новый Структура;
	СведенияОГрузополучателе.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ПолноеНаименование"));
	СведенияОГрузополучателе.Вставить("ИНН", 			   	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ИНН"));
	СведенияОГрузополучателе.Вставить("КПП", 			   	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.КПП"));
	СведенияОГрузополучателе.Вставить("КодПоОКПО", 		 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ОКПО"));
	СведенияОГрузополучателе.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ЮридическийАдрес_Представление"));
	СведенияОГрузополучателе.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ФактическийАдрес_Представление"));
	СведенияОГрузополучателе.Вставить("НомерСчета",		 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.НомерСчета"));
	СведенияОГрузополучателе.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.Банк.Наименование"));
	СведенияОГрузополучателе.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.Банк.Код"));
	СведенияОГрузополучателе.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.Банк.КоррСчет"));
	СведенияОГрузополучателе.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.Телефоны"));
	
	ДанныеЗаполненияШапки.Вставить("СведенияОГрузополучателе", СведенияОГрузополучателе);
	
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПодразделения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.СтруктурноеПодразделение"));
	
	ДанныеЗаполненияШапки.Вставить("ОснованиеНомер",    ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерПоДаннымКлиента"));
	ДанныеЗаполненияШапки.Вставить("ОснованиеДата",     ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаПоДаннымКлиента"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеОснования", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НаименованиеОснования"));
	ДанныеЗаполненияШапки.Вставить("НомерДокумента",    ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Номер"));
	ДанныеЗаполненияШапки.Вставить("ДатаДокумента",     ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Дата"));
	ДанныеЗаполненияШапки.Вставить("Курс", 	            ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Курс"));
	ДанныеЗаполненияШапки.Вставить("КодВалюты",         ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Валюта.Код"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеВалюты",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Валюта.Наименование"));
	ДанныеЗаполненияШапки.Вставить("ЦенаВключаетНДС", 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ЦенаВключаетНДС"));
	ДанныеЗаполненияШапки.Вставить("АдресДоставки", 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "АдресДоставки"));
	
	ДатаИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаИсправления");
	Если ЗначениеЗаполнено(ДатаИсправления) Тогда
		ДанныеЗаполненияШапки.Вставить("ДатаИсправления", Дата(ДатаИсправления));
		ДанныеЗаполненияШапки.Вставить("НомерИсправления", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерИсправления"));
	КонецЕсли;
	
	ДанныеЗаполненияПодвала = Новый Структура;
	
	ДанныеЗаполненияПодвала.Вставить("КоличествоЛистовВПриложении", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "КоличествоЛистовВПрилПрописью"));
	ДанныеЗаполненияПодвала.Вставить("КоличествоПорядковыхНомеровЗаписейПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "КоличествоЗаписейПрописью"));
	ДанныеЗаполненияПодвала.Вставить("ВсегоМестПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "КоличествоМестПрописью"));
	ДанныеЗаполненияПодвала.Вставить("МассаГрузаПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "МассаГрузаПрописью"));
	ДанныеЗаполненияПодвала.Вставить("МассаГрузаНеттоПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "МассаГрузаНеттоПрописью"));

	ДанныеЗаполненияПодвала.Вставить("СуммаПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СуммаВсегоПрописью"));
	ДанныеЗаполненияПодвала.Вставить("ДатаОтпуска", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДатаОтпуска"));
		
	ДолжностьРуководителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ДолжностьРуководителя");
	Если Не ДолжностьРуководителя = "---" Тогда
		ДанныеЗаполненияПодвала.Вставить("ДолжностьРуководителя", ДолжностьРуководителя);
	КонецЕсли;
	ДанныеЗаполненияПодвала.Вставить("ДолжностьГлавБухгалтера", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ДолжностьГлавБухгалтера"));
	ДанныеЗаполненияПодвала.Вставить("ДолжностьКладовщика", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ДолжностьКладовщика"));
	ДанныеЗаполненияПодвала.Вставить("ФИОРуководителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ФИОРуководителя"));
	ДанныеЗаполненияПодвала.Вставить("ФИОГлавБухгалтера", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ФИОГлавБухгалтера"));
	ДанныеЗаполненияПодвала.Вставить("ФИОКладовщика", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ФИОКладовщика"));
	
	ТЗ = Новый ТаблицаЗначений;
	
	ТЗ.Колонки.Добавить("ТоварКод");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("ВидУпаковки");
	ТЗ.Колонки.Добавить("ТоварНаименование");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаКодПоОКЕИ");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаНаименование");
	ТЗ.Колонки.Добавить("Цена", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаСНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("МассаНетто", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("МассаБрутто", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("КоличествоМест", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("КоличествоВОдномМесте", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	
	ИмяНоменклатуры = "Номенклатура";
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		
		Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			
			НоваяСтрока.ТоварКод          = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
				ДеревоРазбора, СтрокаТЧ, "Номенклатура.Артикул");
			НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
				ДеревоРазбора, СтрокаТЧ, "Номенклатура.Наименование");
				
			Характеристика = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
				ДеревоРазбора, СтрокаТЧ, "Характеристика");
			Если ЗначениеЗаполнено(Характеристика) И ОбщегоНазначения.ЗначениеСсылочногоТипа(Характеристика) Тогда
				НаименованиеХарактеристики = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Характеристика, "Наименование");
			КонецЕсли;
			
			Артикул = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
				ДеревоРазбора, СтрокаТЧ, "Номенклатура.Артикул");
			
			НоваяСтрока.БазоваяЕдиницаКодПоОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
				ДеревоРазбора, СтрокаТЧ, "Номенклатура.ЕдиницаИзмерения.Код");
			НоваяСтрока.БазоваяЕдиницаНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
				ДеревоРазбора, СтрокаТЧ, "Номенклатура.ЕдиницаИзмерения.Наименование");
			
		Иначе
			
			НоваяСтрока.ТоварКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ТоварКод");
			НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Наименование");
			
			НаименованиеХарактеристики = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НаименованиеХарактеристики");
			
			Артикул = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Артикул");
			
			НоваяСтрока.БазоваяЕдиницаНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЕдиницаИзмеренияНаименование");
			НоваяСтрока.БазоваяЕдиницаКодПоОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЕдиницаИзмеренияКод");
			
		КонецЕсли;
		
		Сорт = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сорт");
		Если ЗначениеЗаполнено(Сорт) Тогда
			НоваяСтрока.ТоварНаименование = НоваяСтрока.ТоварНаименование + ", " + Сорт;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Артикул) Тогда
			НоваяСтрока.ТоварНаименование = НоваяСтрока.ТоварНаименование + ", " + Артикул;
		КонецЕсли;
		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Количество");
		НоваяСтрока.КоличествоВОдномМесте = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КоличествоВОдномМесте");
		
		НоваяСтрока.КоличествоМест = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Мест");
		
		НоваяСтрока.МассаБрутто = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "МассаБрутто");
		НоваяСтрока.МассаНетто = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "МассаНетто");
		
		НоваяСтрока.ВидУпаковки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Упаковка");
		
		НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДС");
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтавкаНДС");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСНДС");
		НоваяСтрока.СуммаНДС = ?(ЗначениеЗаполнено(НоваяСтрока.СуммаНДС),НоваяСтрока.СуммаНДС,0);
		Если Не ЗначениеЗаполнено(НоваяСтрока.СтавкаНДС) Тогда
			НоваяСтрока.СтавкаНДС = НСтр("ru = 'без НДС'");
		Иначе
			НоваяСтрока.СтавкаНДС = Строка(НоваяСтрока.СтавкаНДС);
		КонецЕсли;
		
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка", ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Подвал", ДанныеЗаполненияПодвала);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	СтрокаДереваДопДанных = ДеревоРазбора.Строки.Найти("ДеревоДопДанных", "Реквизит", Истина);
	Если СтрокаДереваДопДанных <> Неопределено И ТипЗнч(СтрокаДереваДопДанных.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДереваДопДанных.ЗначениеРеквизита;
		ДанныеДляОбъекта.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ ТОРГ-12.
//
Процедура ЗаполнитьТабличныйДокументТОРГ12_ЭД(ТабличныйДокумент, ДанныеПечати, ДанныеПокупателя, ПараметрыПечати)
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ТабличныйДокумент.ПолеСлева = 5;
	ТабличныйДокумент.ПолеСправа = 5;
	ТабличныйДокумент.РазмерКолонтитулаСверху = 0;
	ТабличныйДокумент.РазмерКолонтитулаСнизу = 0;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ТОРГ12_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ЭД_ТОРГ12";
	
	ЗаполнитьРеквизитыШапкиТОРГ12(ДанныеПечати.Шапка, Макет, ТабличныйДокумент);
	
	НомерСтраницы = 1;
	ИтоговыеСуммы = СтруктураИтоговыеСуммы();
	
	КоэффициентПересчета = 1;
	ДанныеСтроки = СтруктураДанныеСтроки(КоэффициентПересчета);
	
	// Создаем массив для проверки вывода
	МассивВыводимыхОбластей = Новый Массив;
	
	// Выводим многострочную часть документа
	ОбластьЗаголовокТаблицы = Макет.ПолучитьОбласть("ЗаголовокТаб|ОсновныеДанныеТаблицы");
	ОбластьМакета           = Макет.ПолучитьОбласть("Строка|ОсновныеДанныеТаблицы");
	ОбластьИтоговПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице|ОсновныеДанныеТаблицы");
	ОбластьВсего            = Макет.ПолучитьОбласть("Всего|ОсновныеДанныеТаблицы");
	ОбластьПодвала          = Макет.ПолучитьОбласть("Подвал");
	
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицы");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицы");
			ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
			ОбластьЗаголовокТаблицыДДБезЭП = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицыБезЭЦП");
			ОбластьМакетаДДБезЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыБезЭЦП");
		КонецЕсли;
	КонецЕсли;
	
	// Выводим табличную часть документа
	ТЧТовары = ДанныеПечати.Товары;
	
	КоличествоСтрок = ТЧТовары.Количество();
	
	Для Каждого СтрокаТовары Из ТЧТовары Цикл
		
		ДанныеСтроки.Номер = ДанныеСтроки.Номер + 1;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		
		ДанныеСтроки.Мест = СтрокаТовары.КоличествоМест;
		
		ДанныеСтроки.КоэффициентПересчета  = ?(ЗначениеЗаполнено(СтрокаТовары.КоличествоВОдномМесте),СтрокаТовары.КоличествоВОдномМесте,1);
		ДанныеСтроки.Количество  = СтрокаТовары.Количество;
		ДанныеСтроки.МассаБрутто = СтрокаТовары.МассаБрутто;
		
		ДанныеСтроки.Сумма     = СтрокаТовары.Сумма;
		ДанныеСтроки.СуммаНДС  = СтрокаТовары.СуммаНДС;
		ДанныеСтроки.СуммаСНДС = СтрокаТовары.СуммаСНДС;
		
		ДанныеСтроки.Цена = СтрокаТовары.Цена;
		
		ОбластьМакета.Параметры.Заполнить(ДанныеСтроки);
		
		
		Если ДанныеСтроки.Номер = 1 Тогда // первая строка
			
			ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница " + НомерСтраницы;
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьЗаголовокТаблицы, 
				"ЗаголовокТабОсновныеДанные", НомерСтраницы);
			
			Если Не СкрыватьДопДанные Тогда
				Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД, 
						"ЗаголовокТабДопДанные", НомерСтраницы);
				Иначе
					Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП, 
							"ЗаголовокТабДопДанныеСЭП", НомерСтраницы);
					КонецЕсли;
					Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП, 
							"ЗаголовокТабДопДанныеБезЭП", НомерСтраницы);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		Иначе
			
			МассивВыводимыхОбластей.Очистить();
			МассивВыводимыхОбластей.Добавить(ОбластьМакета);
			МассивВыводимыхОбластей.Добавить(ОбластьИтоговПоСтранице);
			
			Если ДанныеСтроки.Номер = КоличествоСтрок Тогда
				
				МассивВыводимыхОбластей.Добавить(ОбластьВсего);
				МассивВыводимыхОбластей.Добавить(ОбластьПодвала);
				
			КонецЕсли;
			
			Если ДанныеСтроки.Номер <> 1 И Не ПроверитьВыводТабличногоДокумента(ТабличныйДокумент,МассивВыводимыхОбластей) Тогда
				
				ОбластьИтоговПоСтранице.Параметры.Заполнить(ИтоговыеСуммы);
				ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтоговПоСтранице, 
					"ИтогоПоСтраницеОсновныеДанные", НомерСтраницы);
				
				// Очистим итоги по странице.
				ОбнулитьИтогиПоСтранице(ИтоговыеСуммы);
				
				НомерСтраницы = НомерСтраницы + 1;
				ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
				ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница " + НомерСтраницы;
				ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьЗаголовокТаблицы, 
					"ЗаголовокТабОсновныеДанные", НомерСтраницы);
				
				Если Не СкрыватьДопДанные Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД, 
							"ЗаголовокТабДопДанные", НомерСтраницы);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП, 
								"ЗаголовокТабДопДанныеСЭП", НомерСтраницы);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП, 
								"ЗаголовокТабДопДанныеБезЭП", НомерСтраницы);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
			"СтрокаТоваровОсновныеДанные", ДанныеСтроки.Номер);
		РассчитатьИтоговыеСуммы(ИтоговыеСуммы, ДанныеСтроки);
		
		Если Не СкрыватьДопДанные Тогда
			Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
				СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(ДанныеСтроки.Номер), "НомерСтр");
				Если СтрокаТаблицыДД <> Неопределено Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ОбластьМакетаДД.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
						ОбластьМакетаДД.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДД,
							"СтрокаТоваровДопДанные", ДанныеСтроки.Номер);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ОбластьМакетаДДСЭП.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП,
								"СтрокаТоваровДопДанныеСЭП", ДанныеСтроки.Номер);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ОбластьМакетаДДБезЭП.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДБезЭП,
								"СтрокаТоваровДопДанныеБезЭП", ДанныеСтроки.Номер);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// Выводим итоги по последней странице
	ОбластьИтоговПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице|ОсновныеДанныеТаблицы");
	ОбластьИтоговПоСтранице.Параметры.Заполнить(ИтоговыеСуммы);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтоговПоСтранице,
		"ИтогоПоСтраницеОсновныеДанные", НомерСтраницы);
	
	// Выводим итоги по документу в целом
	ОбластьМакета = Макет.ПолучитьОбласть("Всего|ОсновныеДанныеТаблицы");
	ОбластьМакета.Параметры.Заполнить(ИтоговыеСуммы);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
		"ВсегоОсновныеДанные");
	
	// Выводим подвал документа
	ЗаполнитьРеквизитыПодвалаТОРГ12(ДанныеПечати.Подвал, Макет, ТабличныйДокумент, ДанныеПокупателя);
	
	Если Не СкрыватьДопДанные Тогда
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения реквизитов шапки ТОРГ-12.
//
// Параметры:
//  ДанныеПечати - ВыборкаИзРезультатаЗапроса - Данные шапки документа
//  Макет - Макет ТОРГ-12
//  ТабличныйДокумент - Табличный документ.
//
Процедура ЗаполнитьРеквизитыШапкиТОРГ12(ДанныеПечати, Макет, ТабличныйДокумент)
	
	// Выводим общие реквизиты шапки
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьМакета.Параметры.Заполнить(ДанныеПечати);
	
	ОбластьМакета.Параметры.Основание = 
		?(ЗначениеЗаполнено(ДанныеПечати.НаименованиеОснования), ДанныеПечати.НаименованиеОснования, "")
		+ ?(ЗначениеЗаполнено(ДанныеПечати.ОснованиеНомер), " № " + ДанныеПечати.ОснованиеНомер, "")
		+ ?(ЗначениеЗаполнено(ДанныеПечати.ОснованиеДата), " от " + Формат(ДанныеПечати.ОснованиеДата, "ДЛФ=Д"), "");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.СведенияОГрузоотправителе,
		ОбластьМакета.Параметры.ПредставлениеОрганизации,
		"ПолноеНаименование,ИНН,КПП,ФактическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.СведенияОГрузополучателе,
		ОбластьМакета.Параметры.ПредставлениеГрузополучателя,
		"ПолноеНаименование,ИНН,КПП,ФактическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет");
		
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.СведенияОПоставщике,
		ОбластьМакета.Параметры.ПредставлениеПоставщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.СведенияОПокупателе,
		ОбластьМакета.Параметры.ПредставлениеПлательщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК");
		
	ОбластьМакета.Параметры.АдресДоставки = ДанныеПечати.АдресДоставки;
	
	НомерИсправления = Неопределено;
	ДатаИсправления = Неопределено;
	
	ДанныеПечати.Свойство("НомерИсправления", НомерИсправления);
	ДанныеПечати.Свойство("ДатаИсправления", ДатаИсправления);
	
	ЗаполнитьДатуНомерИсправления(ОбластьМакета, ДатаИсправления, НомерИсправления);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
КонецПроцедуры

Процедура ЗаполнитьДатуНомерИсправления(ОбластьМакета, ДатаИсправления, НомерИсправления)
	
	Если НЕ( ЗначениеЗаполнено(НомерИсправления) И ЗначениеЗаполнено(ДатаИсправления)) Тогда
		Возврат;
	КонецЕсли;
	
	ОбластьМакета.Параметры.ТекстИсправления = НСтр("ru='Исправление'")+ "   ";
	ОбластьМакета.Параметры.НомерИсправления = НомерИсправления;
	ОбластьМакета.Параметры.ДатаИсправления  = Формат(ДатаИсправления, "ДЛФ=D");
	
	ЛинияГраницыРеквизитовИсправления = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная, 1);
	ОбластьНомерИсправления = ОбластьМакета.Области.НомерИсправления;
	ОбластьНомерИсправления.ГраницаСнизу 	= ЛинияГраницыРеквизитовИсправления;
	ОбластьНомерИсправления.ГраницаСлева 	= ЛинияГраницыРеквизитовИсправления;
	ОбластьНомерИсправления.ГраницаСправа 	= ЛинияГраницыРеквизитовИсправления;
	
	ОбластьДатаИсправления = ОбластьМакета.Области.ДатаИсправления;
	ОбластьДатаИсправления.ГраницаСнизу 	= ЛинияГраницыРеквизитовИсправления;
	ОбластьДатаИсправления.ГраницаСлева 	= ЛинияГраницыРеквизитовИсправления;
	ОбластьДатаИсправления.ГраницаСправа 	= ЛинияГраницыРеквизитовИсправления;
	
КонецПроцедуры

// Процедура заполнения реквизитов подвала ТОРГ-12.
//
// Параметры:
//  ДанныеПечати - ВыборкаИзРезультатаЗапроса - Данные шапки документа
//  ИтоговыеСуммы - Структура - Структура итоговых сумм документа
//  Макет - Макет ТОРГ-12
//  ТабличныйДокумент - Табличный документ.
//
Процедура ЗаполнитьРеквизитыПодвалаТОРГ12(ДанныеПечати, Макет, ТабличныйДокумент, ДанныеПокупателя, КорректировкаСтоимости = Ложь)
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
	
	ОбластьМакета.Параметры.Заполнить(ДанныеПечати);
	ОбластьМакета.Параметры.Заполнить(ДанныеПокупателя);
	
	ПолнаяДатаДокумента = Формат(ДанныеПечати.ДатаОтпуска, "ДЛФ=DD");
	ДлинаСтроки = СтрДлина(ПолнаяДатаДокумента);
	ПервыйРазделитель = СтрНайти(ПолнаяДатаДокумента, " ");
	ВторойРазделитель = СтрНайти(Прав(ПолнаяДатаДокумента, ДлинаСтроки - ПервыйРазделитель), " ") + ПервыйРазделитель;
	ОбластьМакета.Параметры.ДатаДокументаДень = """" + Лев(ПолнаяДатаДокумента, ПервыйРазделитель -1 ) + """";
	ОбластьМакета.Параметры.ДатаДокументаМесяц = Сред(ПолнаяДатаДокумента, ПервыйРазделитель + 1, ВторойРазделитель - ПервыйРазделитель - 1);
	ОбластьМакета.Параметры.ДатаДокументаГод = Прав(ПолнаяДатаДокумента, ДлинаСтроки - ВторойРазделитель);
	
	Если ДанныеПокупателя.Свойство("ДатаПолучения") Тогда
		ПолнаяДатаПринял = Формат(ДанныеПокупателя.ДатаПолучения, "ДЛФ=DD");
		ДлинаСтроки = СтрДлина(ПолнаяДатаПринял);
		ПервыйРазделитель = СтрНайти(ПолнаяДатаПринял, " ");
		ВторойРазделитель = СтрНайти(Прав(ПолнаяДатаПринял, ДлинаСтроки - ПервыйРазделитель), " ") + ПервыйРазделитель;
		ОбластьМакета.Параметры.ДатаПринялДень = """" + Лев(ПолнаяДатаПринял, ПервыйРазделитель -1 ) + """";
		ОбластьМакета.Параметры.ДатаПринялМесяц = Сред(ПолнаяДатаПринял, ПервыйРазделитель + 1, ВторойРазделитель - ПервыйРазделитель - 1);
		ОбластьМакета.Параметры.ДатаПринялГод = Прав(ПолнаяДатаПринял, ДлинаСтроки - ВторойРазделитель);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подвал");
	
КонецПроцедуры

// Процедура заполняет данные, выводимые на печать
Функция ДанныеВторогоТитула(СтрокаОбъекта, ДеревоРазбора)
	
	СвойстваТитула = Новый Структура;
	
	ДатаПолучения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
		ДеревоРазбора, СтрокаОбъекта, "ДатаПолучения");
	СвойстваТитула.Вставить("ДатаПолучения", ДатаПолучения);
	
	ГрузПринялДолжность = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
		ДеревоРазбора, СтрокаОбъекта, "ГрузПринялДолжность");
	СвойстваТитула.Вставить("ГрузПринялДолжность", ГрузПринялДолжность);
	
	ГрузПринялФИО = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
		ДеревоРазбора, СтрокаОбъекта, "ГрузПринялФИО");
	СвойстваТитула.Вставить("ГрузПринялФИО", ГрузПринялФИО);
	
	ГрузПолучилДолжность = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
		ДеревоРазбора, СтрокаОбъекта, "ГрузПолучилДолжность");
	СвойстваТитула.Вставить("ГрузПолучилДолжность", ГрузПолучилДолжность);
	
	ГрузПолучилФИО = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
		ДеревоРазбора, СтрокаОбъекта, "ГрузПолучилФИО");
	СвойстваТитула.Вставить("ГрузПолучилФИО", ГрузПолучилФИО);
	
	Возврат СвойстваТитула;
	
КонецФункции

// Заполняет табличный документ ТОРГ12Покупателя
Процедура ЗаполнитьТабличныйДокумент_ТОРГ12Покупателя(ТабличныйДокумент, ДанныеПокупателя)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ТОРГ12Покупателя_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Заполнить(ДанныеПокупателя);
	Если ДанныеПокупателя.Свойство("ДатаДокументаОтправителя") Тогда
		ОбластьМакета.Параметры.ДатаДокументаОтправителя = Формат(ДанныеПокупателя.ДатаДокументаОтправителя, "ДЛФ=DD");
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подписи");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Передача товаров

Функция ДанныеДляПечатиПередачаТоваров(СтрокаОбъекта, ДеревоРазбора)
	
	ДеревоЭД = СтрокаОбъекта.ЗначениеРеквизита;
	
	ДанныеШапки = Новый Структура;
	
	ДанныеШапки.Вставить("НомерДокумента", ЗначениеРеквизитаДерева(ДеревоЭД, "НомерТоварнойНакладной"));
	ДанныеШапки.Вставить("ДатаДокумента", ЗначениеРеквизитаДерева(ДеревоЭД, "ДатаТоварнойНакладной"));
	
	ДанныеШапки.Вставить("НомерИсправления", ЗначениеРеквизитаДерева(ДеревоЭД, "НомерИсправления"));
	ДанныеШапки.Вставить("ДатаИсправления", ЗначениеРеквизитаДерева(ДеревоЭД, "ДатаИсправления"));

	ДанныеПоставщика = ДанныеУчастникаСделки(ДеревоЭД, "Поставщик");
	ДанныеШапки.Вставить("ПредставлениеПоставщика",ДанныеПоставщика.Представление);
	ДанныеШапки.Вставить("АдресПоставщика", ДанныеПоставщика.Адрес);
	ДанныеШапки.Вставить("ИННПоставщика", ДанныеПоставщика.ИННКПП);
	
	ДанныеГрузополучателя = ДанныеУчастникаСделки(ДеревоЭД, "Грузополучатель");
	ПредставлениеГрузополучателя = ДанныеГрузополучателя.Представление
		+ ?(ЗначениеЗаполнено(ДанныеГрузополучателя.Адрес), "," + " " + ДанныеГрузополучателя.Адрес, "");
	ДанныеШапки.Вставить("ПредставлениеГрузополучателя", ПредставлениеГрузополучателя);
	
	ДанныеГрузоотправителя = ДанныеУчастникаСделки(ДеревоЭД, "Грузоотправитель");
	ПредставлениеГрузоотправителя = ДанныеГрузоотправителя.Представление
		+ ?(ЗначениеЗаполнено(ДанныеГрузоотправителя.Адрес), "," + " " + ДанныеГрузоотправителя.Адрес, "");
	ДанныеШапки.Вставить("ПредставлениеГрузоотправителя", ПредставлениеГрузоотправителя);
	
	ДанныеПокупателя = ДанныеУчастникаСделки(ДеревоЭД, "Плательщик");
	ДанныеШапки.Вставить("ПредставлениеПокупателя", ДанныеПокупателя.Представление);
	ДанныеШапки.Вставить("АдресПокупателя", ДанныеПокупателя.Адрес);
	ДанныеШапки.Вставить("ИННПокупателя", ДанныеПокупателя.ИННКПП);
	
	ВалютаКод = ЗначениеРеквизитаДерева(ДеревоЭД, "ВалютаКод");
	ВалютаНаименование = ЗначениеРеквизитаДерева(ДеревоЭД, "ВалютаНаименование");
	ВалютаПредставление = ?(ЗначениеЗаполнено(ВалютаНаименование),
		ВалютаНаименование + "," + " " + ВалютаКод, ВалютаКод);
	ДанныеШапки.Вставить("Валюта", ВалютаПредставление);
	
	ДанныеШапки.Вставить("ВсегоСтоимостьТоваровБезНалога", ЗначениеРеквизитаДерева(ДеревоЭД, "ВсегоПоНакладной.СуммаБезНДС"));
	ДанныеШапки.Вставить("ВсегоСуммаНалога", ЗначениеРеквизитаДерева(ДеревоЭД, "ВсегоПоНакладной.СуммаНДС"));
	ДанныеШапки.Вставить("ВсегоСтоимостьТоваровСНалогом", ЗначениеРеквизитаДерева(ДеревоЭД, "ВсегоПоНакладной.СуммаСНДС"));
	
	ДанныеШапки.Вставить("ПредставлениеОснования", ПредставлениеОснования(ДеревоЭД, "Основание"));
	ДанныеШапки.Вставить("ПредставлениеДанныхОТранспортировкеИГрузе", ПредставлениеТранспортнойНакладной(ДеревоЭД, "ТранспортнаяНакладная"));
	
	ДанныеКладовщика = ДанныеЛицаОтпустившегоТовар(ДеревоЭД);
	
	ДанныеОПередаче = Новый Структура;
	
	ДанныеОПередаче.Вставить("ДолжностьКладовщика", ДанныеКладовщика.Должность);
	ДанныеОПередаче.Вставить("ФИОКладовщика",ДанныеКладовщика.ФИО);
	
	ДанныеОПередаче.Вставить("ДатаОтгрузкиТоваров", Формат(ЗначениеРеквизитаДерева(ДеревоЭД, "СведенияПоОтпускуГруза.ДатаОтпуска"), "ДЛФ=D"));
	
	СтрокаДанныеПодписанта = СтрокаОбъекта.Строки.Найти("Подписант","Реквизит");
	Если Не СтрокаДанныеПодписанта = Неопределено Тогда
		ДанныеПодписанта = СтрокаДанныеПодписанта.ЗначениеРеквизита;
		ДолжностьРуководителя = ДанныеПодписанта.Должность;
		
		ФИОРуководителя = ДанныеПодписанта.ФИО;
		ФИОПБОЮЛ = ДанныеПодписанта.ФИОПБОЮЛ;
	КонецЕсли;
	
	ПоставщикТипУчастника = ЗначениеРеквизитаДерева(ДеревоЭД, "Поставщик.ТипУчастника");
	ДолжностьРуководителяПоУмолчанию = ?(ПоставщикТипУчастника = "ИП", НСтр("ru = 'ИП'"), "");
	
	ПредставлениеОрганизации = ЗначениеРеквизитаДерева(ДеревоЭД, "НаименованиеСоставителяДокумента");
	
	ДанныеОПередаче.Вставить("ФИОРуководителя", 
		?(ЗначениеЗаполнено(ФИОРуководителя), ФИОРуководителя, ФИОПБОЮЛ));
	ДанныеОПередаче.Вставить("ДолжностьРуководителя",
		?(ЗначениеЗаполнено(ДолжностьРуководителя), ДолжностьРуководителя, ДолжностьРуководителяПоУмолчанию));
	ДанныеОПередаче.Вставить("ПредставлениеОрганизации", ПредставлениеОрганизации);
	
	Подвал = Новый Структура;
	Подвал.Вставить("ДолжностьРуководителя", ДолжностьРуководителя);
	Подвал.Вставить("ФИОРуководителя", ФИОРуководителя);
	Подвал.Вставить("ФИОПБОЮЛ", ФИОПБОЮЛ);
	Подвал.Вставить("ПредставлениеОрганизации", ПредставлениеОрганизации);
	
	Товары = ШаблонТабличнойЧастиДокумента();
	
	СтрокаТаблицаТоваров = ДеревоЭД.Строки.Найти("ТаблицаТоваров", "ПолныйПуть");
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		
		НоваяСтрока = Товары.Добавить();
		
		НоваяСтрока.НомерСтроки = Товар.Значение;
		
		НоваяСтрока.ТоварКод = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.КодТовара");
		НоваяСтрока.ТоварНаименование = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.НаименованиеНоменклатуры");
		
		// Характеристика
		Характеристика = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.НаименованиеХарактеристики");
		Если ЗначениеЗаполнено(Характеристика) Тогда
			НоваяСтрока.ТоварНаименование = НоваяСтрока.ТоварНаименование + " (" + Характеристика + ")";
		КонецЕсли;
		
		НоваяСтрока.ЕдиницаИзмеренияКод = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.БазоваяЕдиницаКод");
		НоваяСтрока.ЕдиницаИзмеренияНаименование = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.ЕдиницаИзмеренияНаименование");
		
		Количество = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.МассаНетто");
		Если Не ЗначениеЗаполнено(Количество) Тогда
			Количество = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.КоличествоМест");
		КонецЕсли;
		
		НоваяСтрока.Количество = Количество;
		НоваяСтрока.ЦенаЗаЕдиницуИзмерения = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.Цена");
		НоваяСтрока.СтоимостьТоваровБезНалога = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СуммаБезНДС");
		
		НоваяСтрока.НалоговаяСтавка = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СтавкаНДС");
		НоваяСтрока.СуммаНалога = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СуммаНДС");
		НоваяСтрока.СтоимостьТоваровСНалогом = ЗначениеРеквизитаДерева(Товар, "ТаблицаТоваров.НомерСтроки.СуммаСНДС");
		
		ПутьКДанным = "ТаблицаТоваров.НомерСтроки.ДопДанныеПодписанные";
		Подписанные = ЗначениеГруппыВДереве(Товар, ПутьКДанным);
		Если Не Подписанные = Неопределено Тогда
			ДопДанныеПодписанные = Новый Структура;
			Для Каждого ТекСтрока Из Подписанные Цикл
				Ключ = ИмяПоляДопДанных(ТекСтрока, ПутьКДанным);
				Значение = ТекСтрока.Значение;
				ДопДанныеПодписанные.Вставить(Ключ, Значение);
				
			КонецЦикла;
		НоваяСтрока.Подписанные = ДопДанныеПодписанные;
		КонецЕсли;
		
	КонецЦикла;
	
	ДанныеПередачаТоваров = Новый Структура;
	ДанныеПередачаТоваров.Вставить("Шапка", ДанныеШапки);
	ДанныеПередачаТоваров.Вставить("Подвал", Подвал);
	ДанныеПередачаТоваров.Вставить("Товары", Товары);
	ДанныеПередачаТоваров.Вставить("ДанныеОПередаче", ДанныеОПередаче);
	
	СтрокаДопДанных = СтрокаОбъекта.Строки.Найти("ДеревоДопДанных");
	Если Не СтрокаДопДанных = Неопределено Тогда
		ДопДанные = СтрокаДопДанных.ЗначениеРеквизита;
		ДанныеПередачаТоваров.Вставить("ДеревоДопДанных", ДопДанные);
	КонецЕсли;

	
	Возврат ДанныеПередачаТоваров;
	
КонецФункции

Функция ШаблонТабличнойЧастиДокумента()
	
	Шаблон = Новый ТаблицаЗначений;
	Шаблон.Колонки.Добавить("НомерСтроки");
	Шаблон.Колонки.Добавить("ТоварКод");
	Шаблон.Колонки.Добавить("ТоварНаименование");
	Шаблон.Колонки.Добавить("ЕдиницаИзмеренияКод");
	Шаблон.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
	Шаблон.Колонки.Добавить("Количество");
	Шаблон.Колонки.Добавить("ЦенаЗаЕдиницуИзмерения");
	Шаблон.Колонки.Добавить("СтоимостьТоваровБезНалога");
	Шаблон.Колонки.Добавить("НалоговаяСтавка");
	Шаблон.Колонки.Добавить("СуммаНалога");
	Шаблон.Колонки.Добавить("СтоимостьТоваровСНалогом");
	Шаблон.Колонки.Добавить("Подписанные");
	Шаблон.Колонки.Добавить("Неподписанные");
	Возврат Шаблон;
	
КонецФункции

Функция ИмяПоляДопДанных(ТекСтрока, Префикс)
	
	ИмяПоля = ТекСтрока.ПолныйПуть;
	ИмяПоля = СтрЗаменить(ИмяПоля, Префикс+".", "");
	Возврат ИмяПоля;
	
КонецФункции

// Возвращает данные лица, отпустившего товар.
// Параметры:
//  ДеревоЭд - Дерево значений - данные электронного документа.
// Возвращаемое значение:
//  - Структура с полями ФИО, Должность.
//
Функция ДанныеЛицаОтпустившегоТовар(ДеревоЭд)
	
	Должность = "";
	ФИО = Новый Структура;
	ДанныеЛица = Новый Структура;
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд, "СведенияОЛицеПередавшемТовары")) Тогда
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд, "СведенияОЛицеПередавшемТовары") = "РаботникОрганизацииПродавца" Тогда
			Должность = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Должность");
				
			ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Фамилия"));
			ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Имя"));
			ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
				"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Отчество"));
			ФИООтветственного = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			
		ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд, "СведенияОЛицеПередавшемТовары") = "ИноеЛицо" Тогда
			
			Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ПредставительОрганизации" Тогда
				Должность = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Должность");
					
				ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия"));
				ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Имя"));
				ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество"));
				ФИООтветственного = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
				
			ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ФЛ" Тогда
				
				
				ФИО.Вставить("Фамилия", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия"));
				ФИО.Вставить("Имя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя"));
				ФИО.Вставить("Отчество", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоЭд,
					"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество"));
				ФИООтветственного = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ДанныеЛица.Вставить("ФИО", ФИООтветственного);
	ДанныеЛица.Вставить("Должность", Должность);
	
	Возврат ДанныеЛица;
	
КонецФункции

// Возвращает данные контрагента документа
// Параметры:
//  ДеревоЭД - деревоЗначений - данные электронного документа.
//  ВидУчастника - строка - наименование участника сделки.
//  ЗаполнятьАдрес - булево - флаг, определяющий нужно ли искать в дереве значение адреса участника сделки.
//
// Возвращаемое значение:
//  - Структура с полями ПредставлениеУчастника, ИННКППУчастника, ИННУчастника, КППУчастника, АдресУчастника.
//
Функция ДанныеУчастникаСделки(ДеревоЭД, ВидУчастника, ЗаполнятьАдрес = Истина)
	
	ИННУчастника           = "";
	КППУчастника           = "";
	ИННКППУчастника        = "";
	ПредставлениеУчастника = "";
	АдресУчастника         = "";
	
	ДанныеУчастникаСделки  = Новый Структура;
	
	Если ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
		
		ПредставлениеУчастника = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
		ИННУчастника           = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
		КППУчастника           = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
		
		ИННКППУчастника = "" + ИННУчастника + ?(ЗначениеЗаполнено(КППУчастника), "/" + КППУчастника, "");
		
	ИначеЕсли ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		Фамилия      = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ИП.Фамилия");
		Имя          = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ИП.Имя");
		Отчество     = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ИП.Отчество");
		ИННУчастника = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		
		ИННКППУчастника = ИННУчастника;
		
		ПредставлениеУчастника = 
			"ИП " + Фамилия + ?(ЗначениеЗаполнено(Имя), " " + Имя, "") + ?(ЗначениеЗаполнено(Отчество), " " + Отчество, "");
		
	ИначеЕсли ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника") = "ИЛ" Тогда
		
		ПредставлениеУчастника = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации");
		
	ИначеЕсли ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника") = "ИностраннаяОрганизация" Тогда
		
		ПредставлениеУчастника = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.НаименованиеОрганизации");
		
	ИначеЕсли ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		
		Фамилия      = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия");
		Имя          = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ФЛ.Имя");
		Отчество     = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ФЛ.Отчество");
		ИННУчастника = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
		
		ИННКППУчастника = ИННУчастника;
		
		ПредставлениеУчастника = 
			"" + Фамилия + ?(ЗначениеЗаполнено(Имя), " " + Имя, "") + ?(ЗначениеЗаполнено(Отчество), " " + Отчество, "");
		
	КонецЕсли;
	
	ДанныеУчастникаСделки.Вставить("Представление", ПредставлениеУчастника);
	ДанныеУчастникаСделки.Вставить("ИННКПП",        ИННКППУчастника);
	ДанныеУчастникаСделки.Вставить("ИНН",           ИННУчастника);
	ДанныеУчастникаСделки.Вставить("КПП",           КППУчастника);
	
	Если Не ЗаполнятьАдрес Тогда
		
		ДанныеУчастникаСделки.Вставить("АдресПоставщика", АдресУчастника);
		Возврат ДанныеУчастникаСделки;
		
	КонецЕсли;
	
	Если ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес") = "Структурированный" Тогда
		СтруктураАдресаПоставщика = Новый Структура();
		
		Индекс = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.Индекс", Ложь);
		Если ЗначениеЗаполнено(Индекс) Тогда
			СтруктураАдресаПоставщика.Вставить("Индекс", Индекс);
		КонецЕсли;
		
		КодРегиона = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.КодРегион", Ложь);
		Если ЗначениеЗаполнено(КодРегиона) Тогда
			СтруктураАдресаПоставщика.Вставить("КодРегион", КодРегиона);
		КонецЕсли;
		
		Район = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.Район", Ложь);
		Если ЗначениеЗаполнено(Район) Тогда
			СтруктураАдресаПоставщика.Вставить("Район", Район);
		КонецЕсли;
		
		Город = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.Город", Ложь);
		Если ЗначениеЗаполнено(Город) Тогда
			СтруктураАдресаПоставщика.Вставить("Город", Город);
		КонецЕсли;
		
		НаселенныйПункт = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.НаселПункт", Ложь);
		Если ЗначениеЗаполнено(НаселенныйПункт) Тогда
			СтруктураАдресаПоставщика.Вставить("НаселПункт", НаселенныйПункт);
		КонецЕсли;
		
		Улица = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.Улица", Ложь);
		Если ЗначениеЗаполнено(Улица) Тогда
			СтруктураАдресаПоставщика.Вставить("Улица", Улица);
		КонецЕсли;
			
		Дом = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.Дом", Ложь);
		Если ЗначениеЗаполнено(Дом) Тогда
			СтруктураАдресаПоставщика.Вставить("Дом", Дом);
		КонецЕсли;
		
		Корпус = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.Корпус", Ложь);
		Если ЗначениеЗаполнено(Корпус) Тогда
			СтруктураАдресаПоставщика.Вставить("Корпус", Корпус);
		КонецЕсли;
	
		Квартира = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Структурированный.Кварт", Ложь);
		Если ЗначениеЗаполнено(Квартира) Тогда
			СтруктураАдресаПоставщика.Вставить("Кварт", Квартира);
		КонецЕсли;
		
		АдресУчастника = СобратьАдрес(СтруктураАдресаПоставщика);
		
	ИначеЕсли ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес") = "Произвольный" Тогда
		
		КодСтр = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.АдресИнформация.КодСтраны", Ложь);
		АдрТекст = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.АдресИнформация.АдресТекст", Ложь);
		
		Если ЗначениеЗаполнено(КодСтр) И ЗначениеЗаполнено(АдрТекст) Тогда
			АдресУчастника = КодСтр + ", " + АдрТекст;
		Иначе
			// Совместимость со старым представлением адреса в макете э.д.
			АдресУчастника = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Произвольный", Ложь);
		КонецЕсли;
		
	ИначеЕсли ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес") = "Иностранный" Тогда
		
		КодСтраны  = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Иностранный.КодСтраны", Ложь);
		АдресТекст = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".Адрес.Иностранный.АдресТекст", Ложь);
		
		АдресУчастника = КодСтраны + "," + " " + АдресТекст;
		
	КонецЕсли;
	
	ДанныеУчастникаСделки.Вставить("Адрес", АдресУчастника);
	
	БанковскийСчет = ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".БанковскийСчет");
	РеквизитыСчета = Новый Структура;
	
	Если ЗначениеЗаполнено(БанковскийСчет) Тогда
		РеквизитыСчета.Вставить("НомерСчета",        ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".БанковскийСчет.НомерСчета"));
		РеквизитыСчета.Вставить("НаименованиеБанка", ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".БанковскийСчет.НаимБанк"));
		РеквизитыСчета.Вставить("БИК",               ЗначениеРеквизитаДерева(ДеревоЭД, ВидУчастника + ".БанковскийСчет.БИК"));
		
	Иначе
		РеквизитыСчета.Вставить("НомерСчета",        "");
		РеквизитыСчета.Вставить("НаименованиеБанка", "");
		РеквизитыСчета.Вставить("БИК",               "");
		
	КонецЕсли;
	
	ДанныеУчастникаСделки.Вставить("БанковскийСчет", РеквизитыСчета);
	
	Возврат ДанныеУчастникаСделки;
	
КонецФункции

// Возвращает строкое представление документов основания
// Параметры:
//  ДеревоЭД - деревоЗначений - данные электронного документа.
//  ИмяТаблицыОснования - строка - имя таблицы документов основания.
//
// Возвращаемое значение:
//  - Строка - <Наименование документа> <номер документа> <дата документа>.
//
Функция ПредставлениеОснования(ДеревоЭД, ИмяТаблицыОснования)
	
	ПредставлениеОснования = "";
	СтрокаТаблицы = ДеревоЭД.Строки.Найти(ИмяТаблицыОснования, "ПолныйПуть");
	Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
		ШаблонПоДокументу = НСтр("ru ='№ %1 от %2'");
		Для Каждого Основание Из СтрокаТаблицы.Строки Цикл
			
			ДокументНаименование = ЗначениеРеквизитаДерева(Основание,
			ИмяТаблицыОснования+".НомерСтроки.ДокОснованиеНаименование");
			
			Если Не ЗначениеЗаполнено(ДокументНаименование) Тогда
				Продолжить;
			КонецЕсли;
			
			ДокументНомер = ЗначениеРеквизитаДерева(Основание,
				ИмяТаблицыОснования+".НомерСтроки.ДокОснованиеНомер");
			ДокументДата = ЗначениеРеквизитаДерева(Основание,
				ИмяТаблицыОснования+".НомерСтроки.ДокОснованиеДата");
			
			ПредставлениеОснования = ДокументНаименование
				+ ?(ЗначениеЗаполнено(ДокументНомер), " " + СтрШаблон(ШаблонПоДокументу, ДокументНомер, Формат(ДокументДата, "ДЛФ=D")), "")
				+ ?(ЗначениеЗаполнено(ПредставлениеОснования), ", " + ПредставлениеОснования, "");
			
		КонецЦикла;
	КонецЕсли;
	
	Возврат ПредставлениеОснования;
	
КонецФункции

// Возвращает строкое представление документов транспортной накладной
// Параметры:
//  ДеревоЭД - деревоЗначений - данные электронного документа.
//  ИмяТаблицыТранспортнойНакладной - строка - имя таблицы документов транспортной накладной.
//
// Возвращаемое значение:
//  - Строка - <Наименование документа> <номер документа> <дата документа>.
//
Функция ПредставлениеТранспортнойНакладной(ДеревоЭД, ИмяТаблицыТранспортнойНакладной)
	
	ПредставлениеТранспортнойНакладной = "";
	СтрокаТаблицы = ДеревоЭД.Строки.Найти(ИмяТаблицыТранспортнойНакладной, "ПолныйПуть");
	Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
		
		ШаблонТН = НСтр("ru ='ТН №%1 от %2'");
		Для Каждого Накладная Из СтрокаТаблицы.Строки Цикл
			
			ТранспортнаяНакладнаяНомер = ЗначениеРеквизитаДерева(Накладная,
				ИмяТаблицыТранспортнойНакладной+".НомерСтроки.ТранспортнаяНакладнаяНомер");
				
			Если Не ЗначениеЗаполнено(ТранспортнаяНакладнаяНомер) Тогда
				Продолжить;
			КонецЕсли;
			
			ТранспортнаяНакладнаяДата = ДатаДД_ММ_ГГГГ(ЗначениеРеквизитаДерева(Накладная,
				ИмяТаблицыТранспортнойНакладной+".НомерСтроки.ТранспортнаяНакладнаяДата"));
			
			ПредставлениеТранспортнойНакладной = СтрШаблон(ШаблонТН, ТранспортнаяНакладнаяНомер, ТранспортнаяНакладнаяДата)
			+ ?(ЗначениеЗаполнено(ПредставлениеТранспортнойНакладной), ", " + ПредставлениеТранспортнойНакладной, "");
		КонецЦикла;
	КонецЕсли;
	
	Возврат ПредставлениеТранспортнойНакладной;
	
КонецФункции

Процедура ЗаполнитьТабличныйДокументПередачаТоваров(ТабличныйДокумент, ДанныеПечати, ДанныеПокупателя, ПараметрыПечати)
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ТабличныйДокумент.ПолеСлева = 5;
	ТабличныйДокумент.ПолеСправа = 5;
	ТабличныйДокумент.РазмерКолонтитулаСверху = 0;
	ТабличныйДокумент.РазмерКолонтитулаСнизу = 0;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ПередачаТоваров_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ЭД_ПередачаТоваров";
	
	ЗаполнитьРеквизитыШапкиПередачаТоваров(ДанныеПечати.Шапка, Макет, ТабличныйДокумент);
	
	ДеревоДопДанных = Неопределено;
	Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = Неопределено;
	КонецЕсли;
	
	Если Не СкрыватьДопДанные Тогда
		ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицы");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицы");
			ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
			ОбластьЗаголовокТаблицыДДБезЭП = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицыБезЭЦП");
			ОбластьМакетаДДБезЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыБезЭЦП");
		КонецЕсли;
	КонецЕсли;
	
	// Вывод табличной части
	ЗаголовокТаблицы = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ОсновныеДанныеТаблицы");
	НомерЗаголовка = 1;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы,
		"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
	НомерЗаголовка = НомерЗаголовка + 1;
	
	Если Не СкрыватьДопДанные Тогда
		Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
			ОбластьЗаголовокДД = ОбластьЗаголовокТаблицыДД;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокДД,
				"ЗаголовокТаблицыДопДанные");
		Иначе
			Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
				ОбластьЗаголовокДД = ОбластьЗаголовокТаблицыДДСЭП;
			КонецЕсли;
			Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
				ОбластьЗаголовокДД = ОбластьЗаголовокТаблицыДДБезЭП;
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокДД,
				"ЗаголовокТаблицыДопДанные");
		КонецЕсли;
	КонецЕсли;
	
	// Массив для проверки вывода последней строки табличной части и подвала.
	МассивВыводимыхОбластей = Новый Массив;
	
	Строка = Макет.ПолучитьОбласть("Строка|ОсновныеДанныеТаблицы");
	Подвал = Макет.ПолучитьОбласть("Подвал");
	Итоги = Макет.ПолучитьОбласть("Итоги");
	
	ДанныеТовары = ДанныеПечати.Товары;
	КоличествоСтрок = ДанныеТовары.Количество();
	
	НомерСтроки = 1;
	Для Каждого ТекСтрока Из ДанныеТовары Цикл
		
		МассивВыводимыхОбластей.Очистить();
		МассивВыводимыхОбластей.Добавить(Строка);
		
		Если ТекСтрока.НомерСтроки = КоличествоСтрок Тогда
			МассивВыводимыхОбластей.Добавить(Итоги);
			МассивВыводимыхОбластей.Добавить(Подвал);
		КонецЕсли;
		
		Если НЕ ПроверитьВыводТабличногоДокумента(ТабличныйДокумент, МассивВыводимыхОбластей) Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
			
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы,
				"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
			
			Если Не СкрыватьДопДанные Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокДД,
					"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
			КонецЕсли;
			НомерЗаголовка = НомерЗаголовка + 1;
		КонецЕсли;
		
		Строка.Параметры.Заполнить(ТекСтрока);
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, Строка, 
			"СтрокаТоваровОсновныеДанные", НомерСтроки);
		
		Если Не СкрыватьДопДанные Тогда
			Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
				СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(ТекСтрока.НомерСтроки), "НомерСтр");
				Если СтрокаТаблицыДД <> Неопределено Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ОбластьМакетаДД.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
						ОбластьМакетаДД.Параметры.Неподписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДД, 
							"СтрокаТоваровДопДанные", НомерСтроки);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ОбластьМакетаДДСЭП.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП, 
								"СтрокаТоваровДопДанныеСЭП", НомерСтроки);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ОбластьМакетаДДБезЭП.Параметры.Неподписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДБезЭП, 
								"СтрокаТоваровДопДанныеБезЭП", НомерСтроки);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;;
			КонецЕсли;
		КонецЕсли;
		
		НомерСтроки = НомерСтроки + 1;
		
	КонецЦикла;
	
	// Итоги
	Итоги.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, Итоги, "Итоги");
	
	// Подвал
	Подвал.Параметры.Заполнить(ДанныеПечати.Подвал);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, Подвал, "Подвал");
	
	// Данные о передаче груза
	ДанныеОПередачеГруза = Макет.ПолучитьОбласть("ДанныеОПередачеГруза");
	ДанныеОПередачеГруза.Параметры.Заполнить(ДанныеПечати.Шапка);
	ДанныеОПередачеГруза.Параметры.Заполнить(ДанныеПечати.ДанныеОПередаче);
	ДанныеОПередачеГруза.Параметры.Заполнить(ДанныеПокупателя);

	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ДанныеОПередачеГруза, "ДанныеОПередачеГруза");
	
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьРеквизитыШапкиПередачаТоваров(Шапка, Макет, ТабличныйДокумент)
	
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьШапка.Параметры.Заполнить(Шапка);
	
	НомерИсправления = Неопределено;
	ДатаИсправления = Неопределено;
	
	Шапка.Свойство("НомерИсправления", НомерИсправления);
	Шапка.Свойство("ДатаИсправления", ДатаИсправления);
	
	ЗаполнитьДатуНомерИсправления(ОбластьШапка, ДатаИсправления, НомерИсправления);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьШапка, "Шапка");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа со СЧЕТ (ЗАКАЗ КЛИЕНТА)

Функция ПолучитьДанныеСчетаЗаказаДляПечати(СтрокаОбъекта, ДеревоРазбора, Тип = "Счет")
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКонтрагенте.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКонтрагенте.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	Если Не ЗначениеЗаполнено(СведенияОКонтрагенте.ЮридическийАдрес) Тогда
		СведенияОКонтрагенте.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
			СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	КонецЕсли;
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПолучателе", СведенияОКонтрагенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
	КонецЕсли;
	
	СведенияООрганизации = Новый Структура;
	СведенияООрганизации.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ПолноеНаименование"));
	СведенияООрганизации.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ИНН"));
	СведенияООрганизации.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.КПП"));
	СведенияООрганизации.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ОКПО"));
	СведенияООрганизации.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ЮридическийАдрес_Представление"));
	Если Не ЗначениеЗаполнено(СведенияООрганизации.ЮридическийАдрес) Тогда
		СведенияООрганизации.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
			СтрокаОбъекта, "Организация.ФактическийАдрес_Представление"));
	КонецЕсли;
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПолучателе", СведенияООрганизации);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("БИКБанкаПолучателя",               ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Код"));
	ДанныеЗаполненияШапки.Вставить("БанкПолучателяПредставление",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Наименование"));
	ДанныеЗаполненияШапки.Вставить("СчетБанкаПолучателяПредставление", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.КоррСчет"));
	ДанныеЗаполненияШапки.Вставить("СчетПолучателяПредставление",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.НомерСчета"));
	ДанныеЗаполненияШапки.Вставить("БИКБанкаКорреспондента",           ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.БанкКорреспондент.Код"));
	ДанныеЗаполненияШапки.Вставить("БанкКорреспондент",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.БанкКорреспондент.Наименование"));
	ДанныеЗаполненияШапки.Вставить("СчетБанкаКорреспондента",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.БанкКорреспондент.КоррСчет"));
	
	ДанныеЗаполненияШапки.Вставить("Номер",             ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Номер"));
	ДанныеЗаполненияШапки.Вставить("Дата",              ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Дата"));
	ДанныеЗаполненияШапки.Вставить("КодВалюты",         ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Валюта.Код"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеВалюты",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Наименование"));
	ДанныеЗаполненияШапки.Вставить("ДатаПлатежа",       ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"СрокПлатежа"));
	ДанныеЗаполненияШапки.Вставить("ДатаПлатежа",       ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ДатаОкончанияДействияСчета"));
	ДанныеЗаполненияШапки.Вставить("ИтогиПрописью",     ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ИтогиПрописью"));
	ДанныеЗаполненияШапки.Вставить("Руководитель",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Руководитель"));
	ДанныеЗаполненияШапки.Вставить("Бухгалтер",         ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Бухгалтер"));
	ДанныеЗаполненияШапки.Вставить("НазначениеПлатежа", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"НазначениеПлатежа"));
	ДанныеЗаполненияШапки.Вставить("Сумма",             ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"СуммаИтог"));
	ДанныеЗаполненияШапки.Вставить("СуммаНДС",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"СуммаНалогаИтог"));
	ДанныеЗаполненияШапки.Вставить("ЦенаВключаетНДС",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ЦенаВключаетНДС"));
	ДанныеЗаполненияШапки.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДополнительнаяИнформация"));
	ДанныеЗаполненияШапки.Вставить("АдресДоставки",     ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"АдресДоставки"));
	
	ТЗ = Новый ТаблицаЗначений;
	
	ТЗ.Колонки.Добавить("Товар");
	ТЗ.Колонки.Добавить("Код");
	ТЗ.Колонки.Добавить("Артикул");
	ТЗ.Колонки.Добавить("ЕдиницаИзмерения");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("Цена");
	ТЗ.Колонки.Добавить("Сумма");
	ТЗ.Колонки.Добавить("СуммаНДС");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("СуммаСкидки");
	ТЗ.Колонки.Добавить("Описание");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			Если Тип = "Счет" Тогда
				НоваяСтрока.Товар = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Наименование");
				ИДТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Код");
			Иначе
				НоваяСтрока.Товар = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НоменклатураПоставщика.Наименование");
				ИДТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НоменклатураПоставщика.Код");
			КонецЕсли; 
			Поз = СтрНайти(ИДТовара, "#");
			Если Поз > 0 Тогда
				ИдТовара = Сред(ИДТовара, 1, Поз - 1);
			КонецЕсли;
			НоваяСтрока.Код = ИДТовара;
		ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
			НоваяСтрока.Товар = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Наименование");
			НоваяСтрока.Код   = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Код");
		КонецЕсли;
		
		НоваяСтрока.Описание = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Описание");
		НоваяСтрока.Артикул          = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.Артикул");
		Упаковка                     = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"ЕдиницаИзмерения.Наименование");
		БазоваяЕдиницаИзмерения      = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.ЕдиницаИзмерения.Наименование");
		НоваяСтрока.ЕдиницаИзмерения = ?(ЗначениеЗаполнено(Упаковка), Упаковка, БазоваяЕдиницаИзмерения);
		НоваяСтрока.Количество       = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"КоличествоУпаковок");
		НоваяСтрока.Цена             = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.Сумма            = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		
		СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДС");
		Если Не ЗначениеЗаполнено(СуммаНДС) Тогда
			НоваяСтрока.СуммаНДС         = 0;
		Иначе
			НоваяСтрока.СуммаНДС         = СуммаНДС;
		КонецЕсли;
		НоваяСтрока.СтавкаНДС        = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтавкаНДС");
		НоваяСтрока.СуммаСкидки      = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСкидки");
		
	КонецЦикла;
	
	// ЭтапыОплаты
	ТЗЭтапыОплаты = Новый ТаблицаЗначений;
	
	Если Тип = "Заказ" Тогда
		ТЗЭтапыОплаты.Колонки.Добавить("ВариантОплаты");
	КонецЕсли;
	ТЗЭтапыОплаты.Колонки.Добавить("ДатаПлатежа");
	ТЗЭтапыОплаты.Колонки.Добавить("ПроцентПлатежа");
	ТЗЭтапыОплаты.Колонки.Добавить("СуммаПлатежа");
	ТЗЭтапыОплаты.Колонки.Добавить("НомерСтроки");
	НомерСтроки = 1;
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "ЭтапыГрафикаОплаты"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗЭтапыОплаты.Добавить();
		Если Тип = "Заказ" Тогда
			НоваяСтрока.ВариантОплаты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ВариантОплаты");
		КонецЕсли;
		НоваяСтрока.ДатаПлатежа    = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ДатаПлатежа");
		НоваяСтрока.ПроцентПлатежа = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ПроцентПлатежа");
		НоваяСтрока.СуммаПлатежа   = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаПлатежа");
		НоваяСтрока.НомерСтроки    = НомерСтроки;
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",       ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары",      ТЗ);
	ДанныеДляОбъекта.Вставить("ЭтапыОплаты", ТЗЭтапыОплаты);
	
	ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ Счет-заказ.
//
Процедура ЗаполнитьТабличныйДокументСчетЗаказ_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати, Тип = "Счет")
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ИспользоватьРучныеСкидки         = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ЗначениеФункциональнойОпции("ИспользоватьРучныеСкидкиВПродажах");
	ИспользоватьАвтоматическиеСкидки = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ЗначениеФункциональнойОпции("ИспользоватьАвтоматическиеСкидкиВПродажах");
	
	КолонкаКодов = "";
	ОбменСКонтрагентамиПереопределяемый.ИмяДополнительнойКолонки(КолонкаКодов);
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_СчетЗаказ_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ЭД_СчетЗаказ";
	
	ТаблицаТовары = ДанныеПечати.Товары;
	
	Если ТаблицаТовары.Количество() > 0 Тогда
		ЧастичнаяОплата = Ложь;
	Иначе
		ЧастичнаяОплата = Истина;
	КонецЕсли;
	
	ЕстьСкидки = Ложь; 
	ОбменСКонтрагентамиПереопределяемый.НужноВыводитьСкидки(ТаблицаТовары, ИспользоватьРучныеСкидки
		ИЛИ ИспользоватьАвтоматическиеСкидки, ЕстьСкидки);
	
	ВыводитьКоды  = ЗначениеЗаполнено(КолонкаКодов);
	ДанныеПечати.Вставить("УчитыватьНДС", ТаблицаТовары.Колонки.Найти("СуммаНДС") <> Неопределено
		И ТаблицаТовары.Итог("СуммаНДС") > 0);
	
	Если ДанныеПечати.УчитыватьНДС И ЕстьСкидки Тогда
		ОбластьКолонкаТовар = Макет.Область("ТоварСНДССоСкидкой");
	ИначеЕсли ДанныеПечати.УчитыватьНДС Тогда
		ОбластьКолонкаТовар = Макет.Область("ТоварСНДСИлиСоСкидкой");
	Иначе
		ОбластьКолонкаТовар = Макет.Область("Товар");
	КонецЕсли;
	
	Если НЕ ВыводитьКоды Тогда
		
		// Если коды не выводятся, то увеличим ширину первой колонки области товаров
		// на величину равную сумме ширины колонок области кодов.
		ОбластьПервойКолонкиТоваров = Макет.Область("ПерваяКолонкаТовара");
		ОбластьКолонкиКодов = Макет.Область("КолонкаКодов");
		ШиринаОбластиКодов = 0;
		Для Индекс = 0 По ОбластьКолонкиКодов.Право - ОбластьКолонкиКодов.Лево Цикл
			
			НомерКолонки = ОбластьКолонкиКодов.Лево + Индекс;
			ОбластьКолонки = Макет.Область(ОбластьКолонкиКодов.Верх, НомерКолонки, ОбластьКолонкиКодов.Низ, НомерКолонки);
			ШиринаОбластиКодов = ШиринаОбластиКодов + ОбластьКолонки.ШиринаКолонки;
			
		КонецЦикла;
		ОбластьПервойКолонкиТоваров.ШиринаКолонки = ОбластьПервойКолонкиТоваров.ШиринаКолонки + ШиринаОбластиКодов;
		
	КонецЕсли;
	
	Если ЕстьСкидки Тогда
		
		ОбластьНомера = Макет.ПолучитьОбласть("ШапкаТаблицыСНДССоСкидкой|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ШапкаТаблицыСНДССоСкидкой|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ШапкаТаблицыСНДССоСкидкой|ТоварСНДССоСкидкой");
		ОбластьДанных = Макет.ПолучитьОбласть("ШапкаТаблицыСНДССоСкидкой|ДанныеСНДССоСкидкой");
		
	ИначеЕсли ДанныеПечати.УчитыватьНДС Тогда
		
		ОбластьНомера = Макет.ПолучитьОбласть("ШапкаТаблицыСНДС|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ШапкаТаблицыСНДС|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ШапкаТаблицыСНДС|ТоварСНДСИлиСоСкидкой");
		ОбластьДанных = Макет.ПолучитьОбласть("ШапкаТаблицыСНДС|ДанныеСНДСИлиСоСкидкой");
		
	Иначе
		
		ОбластьНомера = Макет.ПолучитьОбласть("ШапкаТаблицы|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ШапкаТаблицы|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ШапкаТаблицы|Товар");
		ОбластьДанных = Макет.ПолучитьОбласть("ШапкаТаблицы|Данные");
		
	КонецЕсли;
	
	ТаблицаЭтапыОплаты = Новый ТаблицаЗначений;
	ТаблицаЭтапыОплаты.Колонки.Добавить("ДатаПлатежа");
	Если ДанныеПечати.Свойство("ДатаПлатежа") Тогда
		НовСтрока = ТаблицаЭтапыОплаты.Добавить();
		НовСтрока.ДатаПлатежа = ДанныеПечати.ДатаПлатежа;
	КонецЕсли; 
	
	
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		ТаблицаДопДанныхСтрок = ТаблицаДопДанных();
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		ЕстьДопДанные = Ложь;
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			
			ЕстьДопДанные = Истина;
			
			Если ЕстьСкидки Тогда
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицыСНДССоСкидкой|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаТаблицыСНДССоСкидкой|ДопДанныеТаблицыСЭЦП");
				
			ИначеЕсли ДанныеПечати.УчитыватьНДС Тогда
				
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицыСНДС|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаТаблицыСНДС|ДопДанныеТаблицыСЭЦП");
				
			Иначе
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицы|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаТаблицы|ДопДанныеТаблицыСЭЦП");
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ЗаполнитьРеквизитыШапкиСчетЗаказ(ДанныеПечати, Макет, ТабличныйДокумент, ТаблицаЭтапыОплаты, Тип);
	СоответствиеСтавокНДС = Новый Соответствие;
	Если ЧастичнаяОплата Тогда
		
		ОбластьВывода = Макет.ПолучитьОбласть("ШапкаТаблицыЧастичнаяОплата");
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьВывода,
			"ШапкаТаблицыЧастичнаяОплата");
		
		ОбластьСтрокаТаблицы = Макет.ПолучитьОбласть("СтрокаТаблицыЧастичнаяОплата");
		
		ОбластьСтрокаТаблицы.Параметры.Товар = ДанныеПечати.Шапка.НазначениеПлатежа;
		ОбластьСтрокаТаблицы.Параметры.Сумма = ДанныеПечати.Шапка.Сумма;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьСтрокаТаблицы,
			"СтрокаТаблицыЧастичнаяОплата");
		
		ОбластьИтого = Макет.ПолучитьОбласть("ИтогоЧастичнаяОплата");
		ОбластьИтого.Параметры.Всего = ДанныеПечати.Шапка.Сумма;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтого,
			"ИтогоЧастичнаяОплата");
		
		Если ЗначениеЗаполнено(ДанныеПечати.Шапка.СуммаНДС) Тогда
			
			ОбластьНДС = Макет.ПолучитьОбласть("ИтогоНДСЧастичнаяОплата");
			ОбластьНДС.Параметры.НДС = НСтр("ru = 'В т.ч. НДС:'");
			ОбластьНДС.Параметры.ВсегоНДС = ДанныеПечати.Шапка.СуммаНДС;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьНДС,
				"ИтогоНДСЧастичнаяОплата");
		КонецЕсли;
		
	Иначе
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, "ШапкаТаблицы");
		
		Если ВыводитьКоды Тогда
			
			ОбластьКодов.Параметры.ИмяКолонкиКодов = КолонкаКодов;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
				"ШапкаТаблицыКолонкаКодов");
			
		КонецЕсли;
		
		ОбластьТовар.Параметры.Товар = НСтр("ru='Товары (работы, услуги)'");
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
				"ШапкаТаблицыТовар");
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
				"ШапкаТаблицыДанные");
		
		Если Не СкрыватьДопДанные Тогда
			Если ЕстьДопДанные Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
					"ШапкаТаблицыДопДанные");
			КонецЕсли;
		КонецЕсли;
		
		
		Если ЕстьСкидки Тогда
			
			ОбластьНомера = Макет.ПолучитьОбласть("СтрокаТаблицыСНДССоСкидкой|НомерСтроки");
			ОбластьКодов  = Макет.ПолучитьОбласть("СтрокаТаблицыСНДССоСкидкой|КолонкаКодов");
			ОбластьТовар  = Макет.ПолучитьОбласть("СтрокаТаблицыСНДССоСкидкой|ТоварСНДССоСкидкой");
			ОбластьДанных = Макет.ПолучитьОбласть("СтрокаТаблицыСНДССоСкидкой|ДанныеСНДССоСкидкой");
			
			
		ИначеЕсли ДанныеПечати.УчитыватьНДС Тогда
			
			ОбластьНомера = Макет.ПолучитьОбласть("СтрокаТаблицыСНДС|НомерСтроки");
			ОбластьКодов  = Макет.ПолучитьОбласть("СтрокаТаблицыСНДС|КолонкаКодов");
			ОбластьТовар  = Макет.ПолучитьОбласть("СтрокаТаблицыСНДС|ТоварСНДСИлиСоСкидкой");
			ОбластьДанных = Макет.ПолучитьОбласть("СтрокаТаблицыСНДС|ДанныеСНДСИлиСоСкидкой");
			
		Иначе
			
			ОбластьНомера = Макет.ПолучитьОбласть("СтрокаТаблицы|НомерСтроки");
			ОбластьКодов  = Макет.ПолучитьОбласть("СтрокаТаблицы|КолонкаКодов");
			ОбластьТовар  = Макет.ПолучитьОбласть("СтрокаТаблицы|Товар");
			ОбластьДанных = Макет.ПолучитьОбласть("СтрокаТаблицы|Данные");
			
		КонецЕсли;
		
		Сумма          = 0;
		СуммаНДС       = 0;
		ВсегоСкидок	   = 0;
		ВсегоБезСкидок = 0;
		
		НомерСтроки = 0;
		
		Для Каждого СтрокаТовары Из ТаблицаТовары Цикл
			
			НомерСтроки = НомерСтроки + 1;
			
			ОбластьНомера.Параметры.НомерСтроки = НомерСтроки;
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, 
				"СтрокаТаблицы", НомерСтроки);
			
			Если ВыводитьКоды Тогда
				
				ОбластьКодов.Параметры.Артикул = СтрокаТовары.Артикул;
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
					"СтрокаТаблицыКолонкаКодов", НомерСтроки);
				
			КонецЕсли;
			
			ТоварПредставление = ?(ЗначениеЗаполнено(СтрокаТовары.Описание), СтрокаТовары.Описание, СтрокаТовары.Товар);
			ОбластьТовар.Параметры.Товар = ТоварПредставление;
			
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
					"СтрокаТаблицыТовар", НомерСтроки);
			
			ОбластьДанных.Параметры.Заполнить(СтрокаТовары);
			
			Если ДанныеПечати.Шапка.ЦенаВключаетНДС Тогда
				СуммаПоСтроке = СтрокаТовары.Сумма + СтрокаТовары.СуммаНДС;
			Иначе
				СуммаПоСтроке = СтрокаТовары.Сумма;
			КонецЕсли;
			
			ОбластьДанных.Параметры.Сумма = СуммаПоСтроке;
			
			Если ЕстьСкидки Тогда
				СуммаСкидки = ?(ЗначениеЗаполнено(СтрокаТовары.СуммаСкидки), СтрокаТовары.СуммаСкидки, 0);
				ОбластьДанных.Параметры.СуммаБезСкидки = СуммаПоСтроке + СуммаСкидки;
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
				"СтрокаТаблицыДанные", НомерСтроки);
			
			Если Не СкрыватьДопДанные Тогда
				ВывестиДопДанныеСтрокиНаПечать(ТаблицаДопДанныхСтрок, СтруктураНаличияДопДанных, НомерСтроки,ТабличныйДокумент,
					ОбластьМакетаДД, "СтрокаТаблицыДопДанные");
			КонецЕсли;
			
			Если ЕстьСкидки Тогда
				ВсегоСкидок = ВсегоСкидок + СуммаСкидки;
				ВсегоБезСкидок = ВсегоБезСкидок + СуммаПоСтроке + СуммаСкидки;
			КонецЕсли;
			
			Сумма = Сумма + СуммаПоСтроке;
			СуммаНДС = СуммаНДС + СтрокаТовары.СуммаНДС;
			
		КонецЦикла;
		
		Если ЕстьСкидки Тогда
			
			ОбластьНомера = Макет.ПолучитьОбласть("ПодвалТаблицыСНДССоСкидкой|НомерСтроки");
			ОбластьКодов  = Макет.ПолучитьОбласть("ПодвалТаблицыСНДССоСкидкой|КолонкаКодов");
			ОбластьТовар  = Макет.ПолучитьОбласть("ПодвалТаблицыСНДССоСкидкой|ТоварСНДССоСкидкой");
			ОбластьДанных = Макет.ПолучитьОбласть("ПодвалТаблицыСНДССоСкидкой|ДанныеСНДССоСкидкой");
		ИначеЕсли ДанныеПечати.УчитыватьНДС Тогда
			
			ОбластьНомера = Макет.ПолучитьОбласть("ПодвалТаблицыСНДС|НомерСтроки");
			ОбластьКодов  = Макет.ПолучитьОбласть("ПодвалТаблицыСНДС|КолонкаКодов");
			ОбластьТовар  = Макет.ПолучитьОбласть("ПодвалТаблицыСНДС|ТоварСНДСИлиСоСкидкой");
			ОбластьДанных = Макет.ПолучитьОбласть("ПодвалТаблицыСНДС|ДанныеСНДСИлиСоСкидкой");
		Иначе
			
			ОбластьНомера = Макет.ПолучитьОбласть("ПодвалТаблицы|НомерСтроки");
			ОбластьКодов  = Макет.ПолучитьОбласть("ПодвалТаблицы|КолонкаКодов");
			ОбластьТовар  = Макет.ПолучитьОбласть("ПодвалТаблицы|Товар");
			ОбластьДанных = Макет.ПолучитьОбласть("ПодвалТаблицы|Данные");
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, "ПодвалТаблицы");
		
		Если ВыводитьКоды Тогда
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
				"ПодвалТаблицыКолонкаКодов");
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
				"ПодвалТаблицыТовар");
		
		ОбменСКонтрагентамиПереопределяемый.ФорматСумм(Сумма, ОбластьДанных.Параметры.Всего);
		
		Если ДанныеПечати.УчитыватьНДС И ЕстьСкидки Тогда
			ОбменСКонтрагентамиПереопределяемый.ФорматСумм(СуммаНДС, ОбластьДанных.Параметры.ВсегоСуммаНДС);
		КонецЕсли;
		
		Если ЕстьСкидки Тогда
			ОбменСКонтрагентамиПереопределяемый.ФорматСумм(ВсегоСкидок,    ОбластьДанных.Параметры.ВсегоСкидок);
			ОбменСКонтрагентамиПереопределяемый.ФорматСумм(ВсегоБезСкидок, ОбластьДанных.Параметры.ВсегоБезСкидок);
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
			"ПодвалТаблицыДанные");
		
		// Вывести ИтогоНДС
		ОбластьНомера = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|Товар");
		ОбластьДанных = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|Данные");
			
		ТаблицаТоварыНДС = ТаблицаТовары.Скопировать( , "СтавкаНДС, СуммаНДС");
		ТаблицаТоварыНДС.Свернуть("СтавкаНДС", "СуммаНДС");
		Для Каждого ТекСтавкаНДС Из ТаблицаТоварыНДС Цикл
			СоответствиеСтавокНДС.Вставить(ТекСтавкаНДС.СтавкаНДС, ТекСтавкаНДС.СуммаНДС);
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, "ПодвалТаблицыНДС");
			Если ВыводитьКоды Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
					"ПодвалТаблицыНДС");
			КонецЕсли;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
					"ПодвалТаблицыНДС");
			ОбменСКонтрагентамиПереопределяемый.ТекстНДСПоСтавке(ТекСтавкаНДС.СтавкаНДС,
				ДанныеПечати.Шапка.ЦенаВключаетНДС, ОбластьДанных.Параметры.НДС);
				
			Если ТекСтавкаНДС.СуммаНДС = 0 Тогда
				ОбластьДанных.Параметры.ВсегоНДС = "-";
			Иначе 
				ОбменСКонтрагентамиПереопределяемый.ФорматСумм(ТекСтавкаНДС.СуммаНДС, ОбластьДанных.Параметры.ВсегоНДС);
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
					"ПодвалТаблицыНДС");
		КонецЦикла;
			
		ОбластьИтогоСНДС = Макет.ПолучитьОбласть("ИтогоСНДС");
		
		Если ДанныеПечати.Шапка.ЦенаВключаетНДС Тогда
			ОбменСКонтрагентамиПереопределяемый.ФорматСумм(Сумма, ОбластьИтогоСНДС.Параметры.ВсегоСНДС);
		Иначе
			ОбменСКонтрагентамиПереопределяемый.ФорматСумм(Сумма + СуммаНДС, ОбластьИтогоСНДС.Параметры.ВсегоСНДС);
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтогоСНДС, "ИтогоСНДС");
		
	КонецЕсли;
	
	// Вывести Сумму прописью
	ОбластьМакета = Макет.ПолучитьОбласть("СуммаПрописью");
	
	ОбластьМакета.Параметры.ИтоговаяСтрока = ДанныеПечати.Шапка.ИтогиПрописью;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "СуммаПрописью");
	
	ТаблицаЭтапыОплаты = ДанныеПечати.ЭтапыОплаты;
	Если ТаблицаЭтапыОплаты.Количество() > 1 Тогда
		ОбластьВывода = Макет.ПолучитьОбласть("ШапкаТаблицыЭтапыОплаты");
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьВывода, "ШапкаТаблицыЭтапыОплаты");
		Область = Макет.ПолучитьОбласть("СтрокаТаблицыЭтапыОплаты");
		НомерСтроки = 1;
		Для Каждого ТекЭтап Из ТаблицаЭтапыОплаты Цикл
			Область.Параметры.Заполнить(ТекЭтап);
			ОбменСКонтрагентамиПереопределяемый.СформироватьТекстНДСЭтапаОплаты(
				СоответствиеСтавокНДС, ТекЭтап.ПроцентПлатежа, Область.Параметры.ТекстНДС);
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, Область, "СтрокаТаблицыЭтапыОплаты", НомерСтроки);
			
			НомерСтроки = НомерСтроки + 1;
		КонецЦикла;
		ОбластьВывода = Макет.ПолучитьОбласть("ИтогоЭтапыОплаты");
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьВывода, "ИтогоЭтапыОплаты");
	КонецЕсли;
	
	ЗаполнитьРеквизитыПодвалаСчетЗаказ(ДанныеПечати, Макет, ТабличныйДокумент, Тип);
	
	Если Не СкрыватьДопДанные Тогда
		ВывестиДопДанныеШапкиНаПечать(ДанныеПечати, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения реквизитов шапки счета, заказа.
//
// Параметры:
//  ДанныеПечати - ВыборкаИзРезультатаЗапроса - Данные шапки документа
//  Макет - Макет СчетЗаказ
//  ТабличныйДокумент - Табличный документ.
//
Процедура ЗаполнитьРеквизитыШапкиСчетЗаказ(ДанныеПечати, Макет, ТабличныйДокумент, ТаблицаЭтапыОплаты, Тип)
	
	СведенияОПоставщике = ДанныеПечати.Шапка.СведенияОПоставщике;
	СведенияОПолучателе = ДанныеПечати.Шапка.СведенияОПолучателе;
	
	Если Тип = "Счет" Тогда
		
		ОбластьМакета = Макет.ПолучитьОбласть("ЗаголовокСчета");
		
		Если ЗначениеЗаполнено(ДанныеПечати.Шапка.ДатаПлатежа) Тогда
			
			НадписьСрокДействия = НСтр("ru='Счет действителен до %СрокДействия%.'");
			НадписьСрокДействия = СтрЗаменить(НадписьСрокДействия, "%СрокДействия%",
				Формат(ДанныеПечати.Шапка.ДатаПлатежа, "ДЛФ=D"));
			ОбластьМакета.Параметры.СрокДействия = НадписьСрокДействия;
			
		КонецЕсли;
		
		ОбластьМакета.Параметры.ИНН = СведенияОПоставщике.ИНН;
		ОбластьМакета.Параметры.КПП = СведенияОПоставщике.КПП;
		
		Если ЗначениеЗаполнено(ДанныеПечати.Шапка.БанкКорреспондент) Тогда
			ОбластьМакета.Параметры.БИКБанкаПолучателя               = ДанныеПечати.Шапка.БИКБанкаКорреспондента;
			ОбластьМакета.Параметры.БанкПолучателяПредставление      = ДанныеПечати.Шапка.БанкКорреспондент;
			ОбластьМакета.Параметры.СчетБанкаПолучателяПредставление = ДанныеПечати.Шапка.СчетБанкаКорреспондента;
			ОбластьМакета.Параметры.СчетПолучателяПредставление      = ДанныеПечати.Шапка.СчетБанкаПолучателяПредставление;
		Иначе	
			ОбластьМакета.Параметры.БИКБанкаПолучателя               = ДанныеПечати.Шапка.БИКБанкаПолучателя;
			ОбластьМакета.Параметры.БанкПолучателяПредставление      = ДанныеПечати.Шапка.БанкПолучателяПредставление;
			ОбластьМакета.Параметры.СчетБанкаПолучателяПредставление = ДанныеПечати.Шапка.СчетБанкаПолучателяПредставление;
			ОбластьМакета.Параметры.СчетПолучателяПредставление      = ДанныеПечати.Шапка.СчетПолучателяПредставление;
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
			СведенияОПоставщике,
			ОбластьМакета.Параметры.ПредставлениеПоставщикаДляПлатПоручения,
			"ПолноеНаименование,");
			
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ЗаголовокСчета");
	КонецЕсли;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	
	Если Тип = "Счет" Тогда
		ТекстЗаголовка = НСтр("ru='Счет на оплату № %НомерДокумента% от %ДатаДокумента%'");
	ИначеЕсли Тип = "Заказ" Тогда
		ТекстЗаголовка = НСтр("ru='Заказ клиента № %НомерДокумента% от %ДатаДокумента%'");
	КонецЕсли;
	
	ТекстЗаголовка = СтрЗаменить(ТекстЗаголовка, "%НомерДокумента%", ДанныеПечати.Шапка.Номер);
	ТекстЗаголовка = СтрЗаменить(ТекстЗаголовка, "%ДатаДокумента%",  Формат(ДанныеПечати.Шапка.Дата, "ДЛФ=DD"));
	
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Заголовок");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Поставщик");
	
	ОбластьМакета.Параметры.ТекстПоставщик = ?(Тип = "Счет", НСтр("ru='Поставщик:'"), НСтр("ru='Исполнитель:'"));
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		СведенияОПоставщике,
		ОбластьМакета.Параметры.ПредставлениеПоставщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,ФактическийАдрес,Телефоны,");
		
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Поставщик");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Покупатель");
	ОбластьМакета.Параметры.ТекстПокупатель         = ?(Тип = "Счет", НСтр("ru='Покупатель:'"), НСтр("ru='Заказчик:'"));
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		СведенияОПолучателе,
		ОбластьМакета.Параметры.ПредставлениеПолучателя,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,ФактическийАдрес,Телефоны,");
		
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Покупатель");
	
	Если Тип = "Счет" Тогда
		ОбластьМакета = Макет.ПолучитьОбласть("НазначениеПлатежа");
		ОбластьМакета.Параметры.НазначениеПлатежа = ДанныеПечати.Шапка.НазначениеПлатежа;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "НазначениеПлатежа");
	Иначе
		ОбластьМакета = Макет.ПолучитьОбласть("АдресДоставки");
		ОбластьМакета.Параметры.АдресДоставки = ДанныеПечати.Шапка.АдресДоставки;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "АдресДоставки");
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения реквизитов подвала счета, заказа.
//
// Параметры:
//  ДанныеПечати - ВыборкаИзРезультатаЗапроса - Данные шапки документа
//  ИтоговыеСуммы - Структура - Структура итоговых сумм документа
//  Макет - Макет СчетЗаказ
//  ТабличныйДокумент - Табличный документ.
//
Процедура ЗаполнитьРеквизитыПодвалаСчетЗаказ(ДанныеПечати, Макет, ТабличныйДокумент, Тип)
	
	Если ЗначениеЗаполнено(ДанныеПечати.Шапка.ДополнительнаяИнформация) Тогда
		Область = Макет.ПолучитьОбласть("ДополнительнаяИнформация");
		Область.Параметры.ДополнительнаяИнформация = ДанныеПечати.Шапка.ДополнительнаяИнформация;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, Область, "ДополнительнаяИнформация");
	КонецЕсли;
	
	Если Тип = "Счет" Тогда
		ОбластьМакета = Макет.ПолучитьОбласть("ПодвалСчета");
		ОбластьМакета.Параметры.ФИОРуководителя    = ДанныеПечати.Шапка.Руководитель;
		ОбластьМакета.Параметры.ФИОБухгалтера      = ДанныеПечати.Шапка.Бухгалтер;
		
		Если ЗначениеЗаполнено(ДанныеПечати.Шапка.Руководитель) Тогда
			ОбластьМакета.Параметры.ЭлектроннаяПодписьРуководителя = ДанныеПечати.Шапка.ЭлектроннаяПодпись;
		ИначеЕсли ЗначениеЗаполнено(ДанныеПечати.Шапка.Бухгалтер) Тогда
			ОбластьМакета.Параметры.ЭлектроннаяПодписьБухгалтера = ДанныеПечати.Шапка.ЭлектроннаяПодпись;
		КонецЕсли;
	Иначе
		ОбластьМакета = Макет.ПолучитьОбласть("ПодвалЗаказа");
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подвал");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с ЗАКАЗОМ ПОСТАВЩИКУ

Функция ПолучитьДанныеЗаказаПоставщикуДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияООрганизации = Новый Структура;
	СведенияООрганизации.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ПолноеНаименование"));
	СведенияООрганизации.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ИНН"));
	СведенияООрганизации.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.КПП"));
	СведенияООрганизации.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ЮридическийАдрес_Представление"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияООрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
	КонецЕсли;
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКонтрагенте.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКонтрагенте);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("Номер",                    ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Номер"));
	ДанныеЗаполненияШапки.Вставить("Дата",                     ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Дата"));
	ДанныеЗаполненияШапки.Вставить("КодВалюты",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Валюта.Код"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеВалюты",       ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Валюта.Наименование"));
	ДанныеЗаполненияШапки.Вставить("СуммаНДС",                 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СуммаНалогаИтог"));
	ДанныеЗаполненияШапки.Вставить("ИтогиПрописью",            ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИтогиПрописью"));
	ДанныеЗаполненияШапки.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДополнительнаяИнформация"));
	ДанныеЗаполненияШапки.Вставить("ЦенаВключаетНДС",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ЦенаВключаетНДС"));
	ДанныеЗаполненияШапки.Вставить("АдресДоставки",            ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "АдресДоставки"));
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Товар");
	ТЗ.Колонки.Добавить("НаименованиеНоменклатурыПоставщика");
	ТЗ.Колонки.Добавить("Код");
	ТЗ.Колонки.Добавить("Артикул");
	ТЗ.Колонки.Добавить("ЕдиницаИзмерения");
	ТЗ.Колонки.Добавить("Количество",  Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("Цена",        Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("Сумма",       Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("СуммаНДС",    Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("СуммаСНДС",   Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("СуммаСкидки", Новый ОписаниеТипов("Число"));
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий 
			Или СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
			НоваяСтрока.Товар = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Наименование");
			НоваяСтрока.НаименованиеНоменклатурыПоставщика = НоваяСтрока.Товар;
			НоваяСтрока.Код = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Код");
			НоваяСтрока.Артикул = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Артикул");
		ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
			НоваяСтрока.Товар = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
				"НоменклатураПоставщика.Наименование");
			НоваяСтрока.НаименованиеНоменклатурыПоставщика = НоваяСтрока.Товар;
			ИДТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НоменклатураПоставщика.Код");
			Поз = СтрНайти(ИДТовара, "#");
			Если Поз > 0 Тогда
				ИдТовара = Сред(ИДТовара, 1, Поз - 1);
			КонецЕсли;
			НоваяСтрока.Код = ИДТовара;
			НоваяСтрока.Артикул = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
				"НоменклатураПоставщика.Артикул");
		КонецЕсли;
		Упаковка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЕдиницаИзмерения.Наименование");
		БазоваяЕдиницаИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.БазоваяЕдиница.Наименование");
					
		НоваяСтрока.ЕдиницаИзмерения = ?(ЗначениеЗаполнено(Упаковка), Упаковка, БазоваяЕдиницаИзмерения);
		НоваяСтрока.Количество       = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КоличествоУпаковок");
		НоваяСтрока.Цена             = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.Сумма            = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		НоваяСтрока.СуммаНДС         = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДС");
		НоваяСтрока.СтавкаНДС        = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтавкаНДС");
		НоваяСтрока.СуммаСкидки      = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСкидки");
		НоваяСтрока.СуммаСНДС        = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСНДС");
		
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ "Заказ поставщику".
//
Процедура ЗаполнитьТабличныйДокументЗаказПоставщику_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ИспользоватьРучныеСкидки = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ЗначениеФункциональнойОпции(
		"ИспользоватьРучныеСкидкиВЗакупках");
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ЗаказПоставщику_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ЭД_ЗаказПоставщику";
	
	ТаблицаТовары = ДанныеПечати.Товары;
	
	КолонкаКодов = "";
	ОбменСКонтрагентамиПереопределяемый.ИмяДополнительнойКолонки(КолонкаКодов);
	
	ВыводитьКоды  = ЗначениеЗаполнено(КолонкаКодов);
	ДанныеПечати.Вставить("УчитыватьНДС", ТаблицаТовары.Колонки.Найти("СуммаНДС") <> Неопределено
		И ТаблицаТовары.Итог("СуммаНДС") > 0);
	
	ЕстьСкидки = Ложь; 
	ОбменСКонтрагентамиПереопределяемый.НужноВыводитьСкидки(ТаблицаТовары, ИспользоватьРучныеСкидки, ЕстьСкидки);
	
	Если ЕстьСкидки Тогда
		ОбластьКолонкаТовар = Макет.Область("ТоварСУсловиемИлиСоСкидкой");
	Иначе
		ОбластьКолонкаТовар = Макет.Область("Товар");
	КонецЕсли;
	
	Если Не ВыводитьКоды Тогда
		ОбластьКолонкаТовар.ШиринаКолонки = ОбластьКолонкаТовар.ШиринаКолонки * 1.14;
	КонецЕсли;
	
	Если ЕстьСкидки Тогда
		
		ОбластьНомера = Макет.ПолучитьОбласть("ШапкаТаблицыСоСкидкой|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ШапкаТаблицыСоСкидкой|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ШапкаТаблицыСоСкидкой|ТоварСУсловиемИлиСоСкидкой");
		ОбластьДанных = Макет.ПолучитьОбласть("ШапкаТаблицыСоСкидкой|ДанныеСУсловиемИлиСоСкидкой");
	Иначе
		
		ОбластьНомера = Макет.ПолучитьОбласть("ШапкаТаблицы|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ШапкаТаблицы|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ШапкаТаблицы|Товар");
		ОбластьДанных = Макет.ПолучитьОбласть("ШапкаТаблицы|Данные");
	КонецЕсли;
	
	// Заполнить реквизиты шапки
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	
	ТекстЗаголовка = НСтр("ru='Заказ поставщику № %НомерДокумента% от %ДатаДокумента%'");
	ТекстЗаголовка = СтрЗаменить(ТекстЗаголовка, "%НомерДокумента%", ДанныеПечати.Шапка.Номер);
	ТекстЗаголовка = СтрЗаменить(ТекстЗаголовка, "%ДатаДокумента%",  Формат(ДанныеПечати.Шапка.Дата, "ДЛФ=DD"));
	
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Заголовок");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Поставщик");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.Шапка.СведенияОПоставщике,
		ОбластьМакета.Параметры.ПредставлениеПоставщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,");
		
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Поставщик");
	ОбластьМакета = Макет.ПолучитьОбласть("Покупатель");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		ДанныеПечати.Шапка.СведенияОПокупателе,
		ОбластьМакета.Параметры.ПредставлениеПолучателя,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,");
		
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Покупатель");
	
	Если ЗначениеЗаполнено(ДанныеПечати.Шапка.АдресДоставки) Тогда
		ОбластьАдресДоставки = Макет.ПолучитьОбласть("АдресДоставки");
		ОбластьАдресДоставки.Параметры.АдресДоставки = ДанныеПечати.Шапка.АдресДоставки;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьАдресДоставки, "АдресДоставки");
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, "ШапкаТаблицы");
	
	Если ВыводитьКоды Тогда
		
		ОбластьКодов.Параметры.ИмяКолонкиКодов = КолонкаКодов;
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
			"ШапкаТаблицыКолонкаКодов");
	КонецЕсли;
	
	ОбластьТовар.Параметры.Товар = НСтр("ru='Товары (работы, услуги)'");
	ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
			"ШапкаТаблицыТовар");
	ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
			"ШапкаТаблицыДанные");
	
	ТаблицаДопДанныхСтрок = ТаблицаДопДанных();
	
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			
			Если ЕстьСкидки Тогда
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицыСоСкидкой|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаТаблицыСоСкидкой|ДопДанныеТаблицыСЭЦП");
				
			Иначе
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицы|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаТаблицы|ДопДанныеТаблицыСЭЦП");
				
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
				"ШапкаТаблицыДопДанные");
		КонецЕсли;
	КонецЕсли;
	
	Если ЕстьСкидки Тогда
		ОбластьНомера = Макет.ПолучитьОбласть("СтрокаТаблицыСоСкидкой|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("СтрокаТаблицыСоСкидкой|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("СтрокаТаблицыСоСкидкой|ТоварСУсловиемИлиСоСкидкой");
		ОбластьДанных = Макет.ПолучитьОбласть("СтрокаТаблицыСоСкидкой|ДанныеСУсловиемИлиСоСкидкой");
	Иначе
		ОбластьНомера = Макет.ПолучитьОбласть("СтрокаТаблицы|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("СтрокаТаблицы|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("СтрокаТаблицы|Товар");
		ОбластьДанных = Макет.ПолучитьОбласть("СтрокаТаблицы|Данные");
	КонецЕсли;
	
	Сумма          = 0;
	СуммаНДС       = 0;
	ВсегоСкидок    = 0;
	ВсегоБезСкидок = 0;
	НомерСтроки    = 0;
	
	Для Каждого СтрокаТовары Из ТаблицаТовары Цикл
		
		НомерСтроки = НомерСтроки + 1;
		
		ОбластьНомера.Параметры.НомерСтроки = НомерСтроки;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, "СтрокаТаблицы", НомерСтроки);
		
		Если ВыводитьКоды Тогда
			
			ОбластьКодов.Параметры.Артикул = СтрокаТовары.Артикул;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
				"СтрокаТаблицыКолонкаКодов", НомерСтроки);
		КонецЕсли;
		
		ОбластьТовар.Параметры.Товар = СтрокаТовары.НаименованиеНоменклатурыПоставщика;
		
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
				"СтрокаТаблицыТовар", НомерСтроки);
		ОбластьДанных.Параметры.Заполнить(СтрокаТовары);
		СуммаСкидки = ?(ЗначениеЗаполнено(СтрокаТовары.СуммаСкидки), СтрокаТовары.СуммаСкидки, 0);
		СуммаНДСТовара = ?(ТипЗнч(СтрокаТовары.СуммаНДС) = Тип("Число"), СтрокаТовары.СуммаНДС, 0);
		Если ДанныеПечати.Шапка.ЦенаВключаетНДС Тогда
			СуммаПоСтроке = СтрокаТовары.Сумма + СуммаНДСТовара;
		Иначе
			СуммаПоСтроке = СтрокаТовары.Сумма;
		КонецЕсли;
		
		Если ЕстьСкидки Тогда
			ОбластьДанных.Параметры.СуммаБезСкидки = СуммаПоСтроке + СуммаСкидки;
		КонецЕсли;
		
		ОбластьДанных.Параметры.Сумма = СуммаПоСтроке;
		
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
			"СтрокаТаблицыДанные", НомерСтроки);
		
		Сумма     = Сумма + СуммаПоСтроке;
		СуммаНДС  = СуммаНДС + СуммаНДСТовара;
		
		Если ЕстьСкидки Тогда
			ВсегоСкидок    = ВсегоСкидок    + СуммаСкидки;
			ВсегоБезСкидок = ВсегоБезСкидок + СуммаПоСтроке + СуммаСкидки;
		КонецЕсли;
		
		Если Не СкрыватьДопДанные Тогда
			ВывестиДопДанныеСтрокиНаПечать(ТаблицаДопДанныхСтрок, СтруктураНаличияДопДанных, НомерСтроки, ТабличныйДокумент,
				ОбластьМакетаДД, "СтрокаТаблицыДопДанные");
		КонецЕсли;
		
	КонецЦикла;
	
	Если ЕстьСкидки Тогда
		
		ОбластьНомера = Макет.ПолучитьОбласть("ПодвалТаблицыСоСкидкой|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ПодвалТаблицыСоСкидкой|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ПодвалТаблицыСоСкидкой|ТоварСУсловиемИлиСоСкидкой");
		ОбластьДанных = Макет.ПолучитьОбласть("ПодвалТаблицыСоСкидкой|ДанныеСУсловиемИлиСоСкидкой");
	Иначе
		
		ОбластьНомера = Макет.ПолучитьОбласть("ПодвалТаблицы|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ПодвалТаблицы|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ПодвалТаблицы|Товар");
		ОбластьДанных = Макет.ПолучитьОбласть("ПодвалТаблицы|Данные");
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, "ПодвалТаблицы");
	
	Если ВыводитьКоды Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
			"ПодвалТаблицыКолонкаКодов");
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
			"ПодвалТаблицыТовар");
	
	Если ЕстьСкидки Тогда
		
		ОбластьДанных.Параметры.ВсегоСкидок    = ВсегоСкидок;
		ОбластьДанных.Параметры.ВсегоБезСкидок = ВсегоБезСкидок;
	КонецЕсли;
	
	ОбменСКонтрагентамиПереопределяемый.ФорматСумм(Сумма, ОбластьДанных.Параметры.Всего);
	ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
			"ПодвалТаблицыДанные");
	
	// Вывести ИтогоНДС
	Если ДанныеПечати.УчитыватьНДС Тогда
		
		ОбластьНомера = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|НомерСтроки");
		ОбластьКодов  = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|КолонкаКодов");
		ОбластьТовар  = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|Товар");
		ОбластьДанных = Макет.ПолучитьОбласть("ПодвалТаблицыНДС|Данные");
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьНомера, "ПодвалТаблицыНДС");
		
		Если ВыводитьКоды Тогда
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКодов,
				"ПодвалТаблицыНДСКолонкаКодов");
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьТовар,
			"ПодвалТаблицыНДСТовар");
		
		Если ДанныеПечати.Шапка.ЦенаВключаетНДС Тогда
			ОбластьДанных.Параметры.НДС = НСтр("ru='В том числе НДС:'");
		Иначе
			ОбластьДанных.Параметры.НДС = НСтр("ru='Сумма НДС:'");
		КонецЕсли;
		ОбластьДанных.Параметры.ВсегоНДС = ДанныеПечати.Шапка.СуммаНДС;
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьДанных,
			"ПодвалТаблицыНДСДанные");
		
	КонецЕсли;
	
	// Вывести Сумму прописью
	ОбластьМакета = Макет.ПолучитьОбласть("СуммаПрописью");
	ИтоговаяСтрока = ДанныеПечати.Шапка.ИтогиПрописью
		+ ?(ЗначениеЗаполнено(ДанныеПечати.Шапка.ИтогиПрописью) И ЗначениеЗаполнено(ДанныеПечати.Шапка.НаименованиеВалюты),
			" " +ДанныеПечати.Шапка.НаименованиеВалюты, "");
	
	ОбластьМакета.Параметры.ИтоговаяСтрока = ИтоговаяСтрока;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "СуммаПрописью");
	
	Если ЗначениеЗаполнено(ДанныеПечати.Шапка.ДополнительнаяИнформация) Тогда
		Область = Макет.ПолучитьОбласть("ДополнительнаяИнформация");
		Область.Параметры.ДополнительнаяИнформация = ДанныеПечати.Шапка.ДополнительнаяИнформация;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, Область, "ДополнительнаяИнформация");
	КонецЕсли;
	
	// Вывести подписи
	ОбластьМакета = Макет.ПолучитьОбласть("ПодвалЗаказа");
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ПодвалЗаказа");
	
	// Выводим доп данные документа
	Если Не СкрыватьДопДанные Тогда
		ВывестиДопДанныеШапкиНаПечать(ДанныеПечати, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа со СЧЕТ-ФАКТУРА

Функция ПолучитьДанныеСчетаФактурыДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	ДатаДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Дата");
	НомерДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Номер");
	
	ШаблонНомераСФ = НСтр("ru = 'Счет-фактура № %1 от %2'");
	ДанныеЗаполненияШапки.Вставить("Номер", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонНомераСФ, НомерДокумента,
		Формат(ДатаДокумента,"ДЛФ=DD")));
	
	ДатаИспрСтрокой = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаИсправления");
	НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерИсправления");
	
	ШаблонНомераИсправленияСФ = НСтр("ru = 'Исправление № %1 от %2'");
	ДанныеЗаполненияШапки.Вставить("НомерИсправления", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ШаблонНомераИсправленияСФ,
		?(ЗначениеЗаполнено(НомерИсправления), НомерИсправления, "--"),
		?(ЗначениеЗаполнено(ДатаИспрСтрокой), Формат(ДатаИспрСтрокой, "ДЛФ=DD"), "--")));
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("ИНН", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКонтрагенте.Вставить("КПП", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКонтрагенте.Вставить("КодПоОКПО",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.НомерСчета"));
	СведенияОКонтрагенте.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Наименование"));
	СведенияОКонтрагенте.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Код"));
	СведенияОКонтрагенте.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.КоррСчет"));
	СведенияОКонтрагенте.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Телефоны"));
	
	ВыставленныйКомитентом = (ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ВыставленныйКомитентом") = Истина);
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКонтрагенте);
		ИмяРеквОрганизации = "Организация";
		ИмяБанкСчета = "БанковскийСчетОрганизации";
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
		ИмяРеквОрганизации = ?(ВыставленныйКомитентом, "Покупатель", "Организация");
		ИмяБанкСчета = ?(ВыставленныйКомитентом, "БанковскийСчетПокупателя", "БанковскийСчетОрганизации");
	КонецЕсли;
	
	СведенияООрганизации = Новый Структура;
	СведенияООрганизации.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ПолноеНаименование"));
	СведенияООрганизации.Вставить("ИНН", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ИНН"));
	СведенияООрганизации.Вставить("КПП", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".КПП"));
	СведенияООрганизации.Вставить("КодПоОКПО", 			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ОКПО"));
	СведенияООрганизации.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ЮридическийАдрес_Представление"));
	СведенияООрганизации.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ФактическийАдрес_Представление"));
	СведенияООрганизации.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета + ".НомерСчета"));
	СведенияООрганизации.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета + ".Банк.Наименование"));
	СведенияООрганизации.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета + ".Банк.Код"));
	СведенияООрганизации.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета + ".Банк.КоррСчет"));
	СведенияООрганизации.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".Телефоны"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияООрганизации);
	КонецЕсли;
	
	СведенияОГрузоотправителе = Новый Структура;
	СведенияОГрузоотправителе.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель"));
	СведенияОГрузоотправителе.Вставить("ФактическийАдрес", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ГрузоотправительАдрес"));
	
	ДанныеЗаполненияШапки.Вставить("СведенияОГрузоотправителе", СведенияОГрузоотправителе);
	
	СведенияОГрузополучателе = Новый Структура;
	СведенияОГрузополучателе.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузополучатель"));
	СведенияОГрузополучателе.Вставить("ФактическийАдрес", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ГрузополучательАдрес"));
	
	ДанныеЗаполненияШапки.Вставить("СведенияОГрузополучателе", СведенияОГрузополучателе);
	
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПоставщика", НСтр("ru ='Продавец:'") + " " + ДанныеЗаполненияШапки.СведенияОПоставщике.ПолноеНаименование);
	ДанныеЗаполненияШапки.Вставить("АдресПоставщика", "Адрес: " + ДанныеЗаполненияШапки.СведенияОПоставщике.ЮридическийАдрес);
	
	ИНН = ДанныеЗаполненияШапки.СведенияОПоставщике.ИНН;
	КПП = ДанныеЗаполненияШапки.СведенияОПоставщике.КПП;
	ДанныеЗаполненияШапки.Вставить("ИННПоставщика", НСтр("ru ='ИНН/КПП продавца:'") + " " + ИНН + ?(ЗначениеЗаполнено(КПП), "/" + КПП, ""));
	
	Если ЗначениеЗаполнено(СведенияОГрузоотправителе.ПолноеНаименование) Тогда
		ДанныеЗаполненияШапки.Вставить("ПредставлениеГрузоотправителя", НСтр("ru ='Грузоотправитель и его адрес:'") + " "
			+ СведенияОГрузоотправителе.ПолноеНаименование + ?(ЗначениеЗаполнено(СведенияОГрузоотправителе.ФактическийАдрес), ", "
			+ СведенияОГрузоотправителе.ФактическийАдрес, ""));
	Иначе
		ДанныеЗаполненияШапки.Вставить("ПредставлениеГрузоотправителя", НСтр("ru ='Грузоотправитель и его адрес: --'")); 
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СведенияОГрузополучателе.ПолноеНаименование) Тогда
		ДанныеЗаполненияШапки.Вставить("ПредставлениеГрузополучателя", НСтр("ru ='Грузополучатель и его адрес:'") + " "
			+ СведенияОГрузополучателе.ПолноеНаименование + ?(ЗначениеЗаполнено(СведенияОГрузополучателе.ФактическийАдрес), ", "
			+ СведенияОГрузополучателе.ФактическийАдрес, ""));
	Иначе
		ДанныеЗаполненияШапки.Вставить("ПредставлениеГрузополучателя", НСтр("ru ='Грузополучатель и его адрес: --'")); 
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("ПоДокументу", НСтр("ru ='К платежно-расчетному документу №'") + " "
		+ ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ПлатежныйДокумент"));
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПокупателя",НСтр("ru ='Покупатель:'") + " " + ДанныеЗаполненияШапки.СведенияОПокупателе.ПолноеНаименование);
	ДанныеЗаполненияШапки.Вставить("АдресПокупателя", НСтр("ru ='Адрес:'") + " "+ ДанныеЗаполненияШапки.СведенияОПокупателе.ЮридическийАдрес);
	
	ИНН = ДанныеЗаполненияШапки.СведенияОПокупателе.ИНН;
	КПП = ДанныеЗаполненияШапки.СведенияОПокупателе.КПП;
	ДанныеЗаполненияШапки.Вставить("ИННПокупателя", НСтр("ru ='ИНН/КПП покупателя:'") + " "  + ИНН + ?(ЗначениеЗаполнено(КПП), "/" + КПП, ""));
	
	КодВалюты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ВалКод");
	ТекстВалюта = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru ='Валюта: код %1'"), КодВалюты);
	ДанныеЗаполненияШапки.Вставить("Валюта", ТекстВалюта);
	
	ДанныеЗаполненияШапки.Вставить("ИтогоСуммаБезНДС", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СтТовБезНДС"));
	ДанныеЗаполненияШапки.Вставить("ИтогоСуммаНДС", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СумНДС"));
	ДанныеЗаполненияШапки.Вставить("ИтогоВсего", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СтТовУчНал"));
	ДанныеЗаполненияШапки.Вставить("ФИОРуководителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ПодписантЮЛ"));
	ДанныеЗаполненияШапки.Вставить("ФИОПБОЮЛ", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ПодписантИП"));
	ДанныеЗаполненияШапки.Вставить("Свидетельство", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ПодписантСвГосРегИП"));
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("ТоварНаименование");
	ТЗ.Колонки.Добавить("ЕдиницаИзмерения");
	ТЗ.Колонки.Добавить("ЕдиницаИзмеренияКод");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("Цена");
	ТЗ.Колонки.Добавить("СуммаБезНДС");
	ТЗ.Колонки.Добавить("Акциз");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("СуммаНДС");
	ТЗ.Колонки.Добавить("СуммаСНДС");
	ТЗ.Колонки.Добавить("СтранаПроисхожденияКод");
	ТЗ.Колонки.Добавить("ПредставлениеСтраны");
	ТЗ.Колонки.Добавить("ПредставлениеГТД");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НаимТов");
		ОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ОКЕИ_Тов");
		НоваяСтрока.ЕдиницаИзмеренияКод = ОКЕИ;
		НоваяСтрока.ЕдиницаИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЕдиницаИзмерения");

		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КолТов");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЦенаТов");
		НоваяСтрока.СуммаБезНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовБезНДС");
		НоваяСтрока.Акциз = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СумАкциз");
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НалСтВел");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СумНДС");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовУчНал");
		СтранаПроисхожденияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КодПроисх");
		НоваяСтрока.СтранаПроисхожденияКод = СтранаПроисхожденияКод;

		НоваяСтрока.ПредставлениеГТД = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НомерТД");
		ПредставлениеСтраны = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НаименованиеСтраныПроисхождения"); 
		НоваяСтрока.ПредставлениеСтраны = ПредставлениеСтраны;
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	СтрокаДереваДопДанных = ДеревоРазбора.Строки.Найти("ДеревоДопДанных", "Реквизит", Истина);
	Если СтрокаДереваДопДанных <> Неопределено И ТипЗнч(СтрокаДереваДопДанных.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДереваДопДанных.ЗначениеРеквизита;
		ДанныеДляОбъекта.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ "Счет-фактура".
//
Процедура ЗаполнитьТабличныйДокументСчетФактура_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_СчетФактура1137_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ШапкаТаблицы = Макет.ПолучитьОбласть("Шапка");
	ШапкаТаблицы.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ШапкаТаблицы, "Шапка");
	
	// Выводим заголовок таблицы.
	ЗаголовокТаблицы = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ОсновныеДанныеТаблицы");
	НомерЗаголовка = 1;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы, 
		"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
	НомерЗаголовка = НомерЗаголовка + 1;
	ДанныеСтроки = СтруктураДанныеСтроки(1);
	
	// Создаем массив для проверки вывода.
	МассивВыводимыхОбластей = Новый Массив;
	
	// Выводим многострочную часть документа.
	ОбластьМакета  = Макет.ПолучитьОбласть("Строка|ОсновныеДанныеТаблицы");
	ОбластьИтого   = Макет.ПолучитьОбласть("Итого|ОсновныеДанныеТаблицы");
	ОбластьПодвала = Макет.ПолучитьОбласть("Подвал|ПодвалТаблицы");
	
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицы");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицы");
			ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
			ОбластьЗаголовокТаблицыДДБезЭП = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицыБезЭЦП");
			ОбластьМакетаДДБезЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыБезЭЦП");
			Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД, 
					"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
			Иначе
				Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП, 
						"ЗаголовокТаблицыДопДанныеСЭП", НомерЗаголовка);
				КонецЕсли;
				Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП, 
						"ЗаголовокТаблицыДопДанныеБезЭП", НомерЗаголовка);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Товары = ДанныеПечати.Товары;
	КоличествоСтрок = Товары.Количество();
	Для Каждого СтрокаТовары Из Товары Цикл
		
		ДанныеСтроки.Номер = ДанныеСтроки.Номер + 1;
		
		МассивВыводимыхОбластей.Очистить();
		МассивВыводимыхОбластей.Добавить(ОбластьМакета);
		
		Если ДанныеСтроки.Номер = КоличествоСтрок Тогда
			МассивВыводимыхОбластей.Добавить(ОбластьИтого);
			МассивВыводимыхОбластей.Добавить(ОбластьПодвала);
		КонецЕсли;
		
		Если НЕ ПроверитьВыводТабличногоДокумента(ТабличныйДокумент, МассивВыводимыхОбластей) Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы, 
				"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
			НомерЗаголовка = НомерЗаголовка + 1;
			
			Если Не СкрыватьДопДанные Тогда
				Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД, 
						"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
				Иначе
					Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП, 
							"ЗаголовокТаблицыДопДанныеСЭП", НомерЗаголовка);
					КонецЕсли;
					Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП, 
							"ЗаголовокТаблицыДопДанныеБезЭП", НомерЗаголовка);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если СтрокаТовары.СтранаПроисхожденияКод = "643" Тогда
			СтрокаТовары.СтранаПроисхожденияКод = "--";
		КонецЕсли;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		
		Если СтрокаТовары.Цена <> Неопределено И СтрокаТовары.Цена = Окр(СтрокаТовары.Цена, 2) Тогда
			ОбластьМакета.Параметры.Цена = Формат(СтрокаТовары.Цена, "ЧДЦ=2");
		КонецЕсли;
		
		ПроставитьПрочеркиВПустыеПоляСтрокиСчетФактура(ОбластьМакета);
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, 
			"СтрокаОсновныеДанные", ДанныеСтроки.Номер);
		
		Если Не СкрыватьДопДанные Тогда
			Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
				СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(ДанныеСтроки.Номер), "НомерСтр");
				Если СтрокаТаблицыДД <> Неопределено Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ОбластьМакетаДД.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
						ОбластьМакетаДД.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДД, 
							"СтрокаДопДанные", ДанныеСтроки.Номер);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ОбластьМакетаДДСЭП.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП, 
								"СтрокаДопДанныеСЭП", ДанныеСтроки.Номер);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ОбластьМакетаДДБезЭП.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДБезЭП, 
								"СтрокаДопДанныеБезЭП", ДанныеСтроки.Номер);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ОбластьИтого.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтого, "Итого");
	ОбластьПодвала.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвала, "Подвал");
	
	Если Не СкрыватьДопДанные Тогда
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с КОРРЕКТИРОВОЧНЫЙ СЧЕТ-ФАКТУРА

Функция ПолучитьДанныеКорректировочногоСчетаФактурыДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	НомерСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Номер");
	ДанныеЗаполненияШапки.Вставить("Номер", ?(ЗначениеЗаполнено(НомерСтр), НомерСтр, "--"));
	ДатаСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Дата");
	ДанныеЗаполненияШапки.Вставить("Дата", ?(ЗначениеЗаполнено(ДатаСтр), Формат(ДатаСтр,"ДЛФ = DD"), "--"));
	
	НомерСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерИсправления");
	ДанныеЗаполненияШапки.Вставить("НомерИсправления", ?(ЗначениеЗаполнено(НомерСтр), НомерСтр, "--"));
	ДатаСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаИсправления");
	ДанныеЗаполненияШапки.Вставить("ДатаИсправления", ?(ЗначениеЗаполнено(ДатаСтр), Формат(ДатаСтр,"ДЛФ = DD"), "--"));
	
	НомерСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерСчетаФактуры");
	ДанныеЗаполненияШапки.Вставить("НомерСчетаФактуры", ?(ЗначениеЗаполнено(НомерСтр), НомерСтр, "--"));
	ДатаСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаСчетаФактуры");
	ДанныеЗаполненияШапки.Вставить("ДатаСчетаФактуры", ?(ЗначениеЗаполнено(ДатаСтр), Формат(ДатаСтр,"ДЛФ = DD"), "--"));
	
	НомерСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерИсправленияСчетаФактуры");
	ДанныеЗаполненияШапки.Вставить("НомерИсправленияСчетаФактуры", ?(ЗначениеЗаполнено(НомерСтр), НомерСтр, "--"));
	ДатаСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаИсправленияСчетаФактуры");
	ДанныеЗаполненияШапки.Вставить("ДатаИсправленияСчетаФактуры", ?(ЗначениеЗаполнено(ДатаСтр), Формат(ДатаСтр,"ДЛФ = DD"), "--"));
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("ИНН", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКонтрагенте.Вставить("КПП", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКонтрагенте.Вставить("КодПоОКПО",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.НомерСчета"));
	СведенияОКонтрагенте.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Наименование"));
	СведенияОКонтрагенте.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Код"));
	СведенияОКонтрагенте.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.КоррСчет"));
	СведенияОКонтрагенте.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Телефоны"));
	
	ВыставленныйКомитентом = (ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ВыставленныйКомитентом") = Истина);
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКонтрагенте);
		ИмяРеквОрганизации = "Организация";
		ИмяБанкСчета = "БанковскийСчетОрганизации";
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
		ИмяРеквОрганизации = ?(ВыставленныйКомитентом, "Покупатель", "Организация");
		ИмяБанкСчета = ?(ВыставленныйКомитентом, "БанковскийСчетПокупателя", "БанковскийСчетОрганизации");
	КонецЕсли;
	
	СведенияООрганизации = Новый Структура;
	СведенияООрганизации.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ПолноеНаименование"));
	СведенияООрганизации.Вставить("ИНН", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ИНН"));
	СведенияООрганизации.Вставить("КПП", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".КПП"));
	СведенияООрганизации.Вставить("КодПоОКПО", 			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ОКПО"));
	СведенияООрганизации.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ЮридическийАдрес_Представление"));
	СведенияООрганизации.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".ФактическийАдрес_Представление"));
	СведенияООрганизации.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета +".НомерСчета"));
	СведенияООрганизации.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета +".Банк.Наименование"));
	СведенияООрганизации.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета +".Банк.Код"));
	СведенияООрганизации.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяБанкСчета +".Банк.КоррСчет"));
	СведенияООрганизации.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ИмяРеквОрганизации + ".Телефоны"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияООрганизации);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПоставщика", "Продавец: " + ДанныеЗаполненияШапки.СведенияОПоставщике.ПолноеНаименование);
	ДанныеЗаполненияШапки.Вставить("АдресПоставщика", "Адрес: " + ДанныеЗаполненияШапки.СведенияОПоставщике.ЮридическийАдрес);
		
	ИНН = ДанныеЗаполненияШапки.СведенияОПоставщике.ИНН;
	КПП = ДанныеЗаполненияШапки.СведенияОПоставщике.КПП;
	ДанныеЗаполненияШапки.Вставить("ИННПоставщика", НСтр("ru ='ИНН/КПП продавца:'") + " " + ИНН + ?(ЗначениеЗаполнено(КПП), "/" + КПП, ""));
	
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПокупателя","Покупатель: " + ДанныеЗаполненияШапки.СведенияОПокупателе.ПолноеНаименование);
	ДанныеЗаполненияШапки.Вставить("АдресПокупателя", "Адрес: " + ДанныеЗаполненияШапки.СведенияОПокупателе.ЮридическийАдрес);
		
	ИНН = ДанныеЗаполненияШапки.СведенияОПокупателе.ИНН;
	КПП = ДанныеЗаполненияШапки.СведенияОПокупателе.КПП;
	ДанныеЗаполненияШапки.Вставить("ИННПокупателя", НСтр("ru ='ИНН/КПП покупателя:'") + " " + ИНН + ?(ЗначениеЗаполнено(КПП), "/" + КПП, ""));
	
	КодВалюты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ВалКод");
	ТекстВалюта = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru ='Валюта: код %1'"), КодВалюты);
	ДанныеЗаполненияШапки.Вставить("Валюта", ТекстВалюта);
	
	ДанныеЗаполненияШапки.Вставить("ИтогоРазницаБезНДСУвеличение", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
		ДеревоРазбора, СтрокаОбъекта, "СтТовБезНДСВсегоУвел"));
	ДанныеЗаполненияШапки.Вставить("ИтогоРазницаНДСУвеличение", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СумНДСУвел"));
	ДанныеЗаполненияШапки.Вставить("ИтогоРазницаСНДСУвеличение", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СтТовУчНалВсегоУвел"));
	ДанныеЗаполненияШапки.Вставить("ИтогоРазницаБезНДСУменьшение", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
		ДеревоРазбора, СтрокаОбъекта, "СтТовБезНДСВсегоУм"));
	ДанныеЗаполненияШапки.Вставить("ИтогоРазницаНДСУменьшение", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СумНДСУм"));
	ДанныеЗаполненияШапки.Вставить("ИтогоРазницаСНДСУменьшение", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СтТовУчНалВсегоУм"));
	ДанныеЗаполненияШапки.Вставить("ФИОРуководителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ПодписантЮЛ"));
	ДанныеЗаполненияШапки.Вставить("ФИОПБОЮЛ", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ПодписантИП"));
	ДанныеЗаполненияШапки.Вставить("Свидетельство", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ПодписантСвГосРегИП"));
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("ТоварНаименование");
	ТЗ.Колонки.Добавить("ЕдиницаИзмерения");
	ТЗ.Колонки.Добавить("ЕдиницаИзмеренияДо");
	ТЗ.Колонки.Добавить("ЕдиницаИзмеренияКод");
	ТЗ.Колонки.Добавить("ЕдиницаИзмеренияКодДо");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("КоличествоДо");
	ТЗ.Колонки.Добавить("Цена");
	ТЗ.Колонки.Добавить("ЦенаДо");
	ТЗ.Колонки.Добавить("СуммаБезНДС");
	ТЗ.Колонки.Добавить("СуммаБезНДСДо");
	ТЗ.Колонки.Добавить("Акциз");
	ТЗ.Колонки.Добавить("АкцизДо");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("СтавкаНДСДо");
	ТЗ.Колонки.Добавить("СуммаНДС");
	ТЗ.Колонки.Добавить("СуммаНДСДо");
	ТЗ.Колонки.Добавить("СуммаСНДС");
	ТЗ.Колонки.Добавить("СуммаСНДСДо");
	ТЗ.Колонки.Добавить("РазницаБезНДСУвеличение");
	ТЗ.Колонки.Добавить("РазницаБезНДСУменьшение");
	ТЗ.Колонки.Добавить("РазницаНДСУвеличение");
	ТЗ.Колонки.Добавить("РазницаНДСУменьшение");
	ТЗ.Колонки.Добавить("РазницаСНДСУвеличение");
	ТЗ.Колонки.Добавить("РазницаСНДСУменьшение");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НаимТов");
		
		ОКЕИДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ОКЕИ_ТовДо");
		ОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ОКЕИ_ТовПосле");
		НоваяСтрока.ЕдиницаИзмеренияКод = ОКЕИ;
		НоваяСтрока.ЕдиницаИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЕдиницаИзмерения");
		НоваяСтрока.ЕдиницаИзмеренияКодДо = ОКЕИДо;
		НоваяСтрока.ЕдиницаИзмеренияДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЕдиницаИзмеренияДо");
		
		НоваяСтрока.КоличествоДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КолТовДо");
		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КолТовПосле");
		НоваяСтрока.ЦенаДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЦенаТовДо");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЦенаТовПосле");
		НоваяСтрока.СуммаБезНДСДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовБезНДСДоИзм");
		НоваяСтрока.СуммаБезНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовБезНДСПослеИзм");
		НоваяСтрока.АкцизДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "АкцизДо");
		НоваяСтрока.Акциз = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "АкцизПосле");
		НоваяСтрока.СтавкаНДСДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НалСтВелДо");
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НалСтВелПосле");
		НоваяСтрока.СуммаНДСДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СумНДСДо");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СумНДСПосле");
		НоваяСтрока.СуммаСНДСДо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовУчНалДоИзм");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовУчНалПослеИзм");
		НоваяСтрока.РазницаБезНДСУвеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"СтТовБезНДСУвел");
		НоваяСтрока.РазницаНДСУвеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СумНДСУвел");
		НоваяСтрока.РазницаСНДСУвеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовУчНалУвел");
		НоваяСтрока.РазницаБезНДСУменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовБезНДСУм");
		НоваяСтрока.РазницаНДСУменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СумНДСУм");
		НоваяСтрока.РазницаСНДСУменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтТовУчНалУм");
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	СтрокаДереваДопДанных = ДеревоРазбора.Строки.Найти("ДеревоДопДанных", "Реквизит", Истина);
	Если СтрокаДереваДопДанных <> Неопределено И ТипЗнч(СтрокаДереваДопДанных.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДереваДопДанных.ЗначениеРеквизита;
		ДанныеДляОбъекта.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ "Корректировочный Счет-фактура".
//
Процедура ЗаполнитьТабличныйДокументКорректировочныйСчетФактура_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_СчетФактураКорректировочный1137_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ШапкаТаблицы = Макет.ПолучитьОбласть("Шапка");
	ШапкаТаблицы.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ШапкаТаблицы, "Шапка");
	
	// Выводим заголовок таблицы
	ЗаголовокТаблицы = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ОсновныеДанныеТаблицы");
	НомерЗаголовка = 1;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы,
		"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
	НомерЗаголовка = НомерЗаголовка + 1;
	ДанныеСтроки = СтруктураДанныеСтроки(1);
	
	// Создаем массив для проверки вывода
	МассивВыводимыхОбластей = Новый Массив;
	
	// Выводим многострочную часть документа
	ОбластьМакета  = Макет.ПолучитьОбласть("Строка|ОсновныеДанныеТаблицы");
	ОбластьИтого   = Макет.ПолучитьОбласть("Итого|ОсновныеДанныеТаблицы");
	ОбластьПодвала = Макет.ПолучитьОбласть("Подвал");
	
	ДеревоДопДанных = Неопределено;
	Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = Неопределено;
	КонецЕсли;
	
	Если Не СкрыватьДопДанные Тогда
		ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицы");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицы");
			ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
			ОбластьЗаголовокТаблицыДДБезЭП = Макет.ПолучитьОбласть("ЗаголовокТаблицы|ДопДанныеТаблицыБезЭЦП");
			ОбластьМакетаДДБезЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыБезЭЦП");
			Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
					"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
			Иначе
				Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
						"ЗаголовокТаблицыДопДанныеСЭП", НомерЗаголовка);
				КонецЕсли;
				Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП,
						"ЗаголовокТаблицыДопДанныеБезЭП", НомерЗаголовка);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Товары = ДанныеПечати.Товары;
	КоличествоСтрок = Товары.Количество();
	Для Каждого СтрокаТовары Из Товары Цикл
		
		ДанныеСтроки.Номер = ДанныеСтроки.Номер + 1;
		
		МассивВыводимыхОбластей.Очистить();
		МассивВыводимыхОбластей.Добавить(ОбластьМакета);
		
		Если ДанныеСтроки.Номер = КоличествоСтрок Тогда
			МассивВыводимыхОбластей.Добавить(ОбластьИтого);
			МассивВыводимыхОбластей.Добавить(ОбластьПодвала);
		КонецЕсли;
		
		Если НЕ ПроверитьВыводТабличногоДокумента(ТабличныйДокумент,МассивВыводимыхОбластей) Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы,
				"ЗаголовокТаблицыОсновныеДанные", НомерЗаголовка);
			НомерЗаголовка = НомерЗаголовка + 1;
			
			Если Не СкрыватьДопДанные Тогда
				Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
						"ЗаголовокТаблицыДопДанные", НомерЗаголовка);
				Иначе
					Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
							"ЗаголовокТаблицыДопДанныеСЭП", НомерЗаголовка);
					КонецЕсли;
					Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП,
							"ЗаголовокТаблицыДопДанныеБезЭП", НомерЗаголовка);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		
		Если СтрокаТовары.Цена <> Неопределено И СтрокаТовары.Цена = Окр(СтрокаТовары.Цена, 2) Тогда
			ОбластьМакета.Параметры.Цена = Формат(СтрокаТовары.Цена, "ЧДЦ=2");
		КонецЕсли;
		
		Если СтрокаТовары.ЦенаДо <> Неопределено И СтрокаТовары.ЦенаДо = Окр(СтрокаТовары.ЦенаДо, 2) Тогда
			ОбластьМакета.Параметры.ЦенаДо = Формат(СтрокаТовары.ЦенаДо, "ЧДЦ=2");
		КонецЕсли;
		
		ПроставитьПрочеркиВПустыеПоляСтрокиСчетФактура(ОбластьМакета);
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
			"СтрокаОсновныеДанные", ДанныеСтроки.Номер);
		
		Если Не СкрыватьДопДанные Тогда
			Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
				СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(ДанныеСтроки.Номер), "НомерСтр");
				Если СтрокаТаблицыДД <> Неопределено Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ОбластьМакетаДД.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
						ОбластьМакетаДД.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДД,
							"СтрокаДопДанные", ДанныеСтроки.Номер);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ОбластьМакетаДДСЭП.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП,
								"СтрокаДопДанныеСЭП", ДанныеСтроки.Номер);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ОбластьМакетаДДБезЭП.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДБезЭП,
								"СтрокаДопДанныеБезЭП", ДанныеСтроки.Номер);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ОбластьИтого.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтого, "Итого");
	ОбластьПодвала.Параметры.Заполнить(ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвала, "Подвал");
	
	Если Не СкрыватьДопДанные Тогда
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с КОРРЕКТИРОВОЧНЫМ ДОКУМЕНТОМ

Функция ПолучитьДанныеКорректировочногоДокументаДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("ИНН", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКонтрагенте.Вставить("КодПоОКПО",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.НомерСчета"));
	СведенияОКонтрагенте.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Наименование"));
	СведенияОКонтрагенте.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Код"));
	СведенияОКонтрагенте.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.КоррСчет"));
	СведенияОКонтрагенте.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Телефоны"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий 
		ИЛИ СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКонтрагенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
	КонецЕсли;
	
	СведенияООрганизации = Новый Структура;
	СведенияООрганизации.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ПолноеНаименование"));
	СведенияООрганизации.Вставить("ИНН", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ИНН"));
	СведенияООрганизации.Вставить("КодПоОКПО", 			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ОКПО"));
	СведенияООрганизации.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ЮридическийАдрес_Представление"));
	СведенияООрганизации.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ФактическийАдрес_Представление"));
	СведенияООрганизации.Вставить("НомерСчета",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.НомерСчета"));
	СведенияООрганизации.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.Банк.Наименование"));
	СведенияООрганизации.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.Банк.Код"));
	СведенияООрганизации.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетОрганизации.Банк.КоррСчет"));
	СведенияООрганизации.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.Телефоны"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий
		ИЛИ СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Интеркампани Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияООрганизации);
	КонецЕсли;
	
	СведенияОГрузоотправителе = Новый Структура;
	СведенияОГрузоотправителе.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ПолноеНаименование"));
	СведенияОГрузоотправителе.Вставить("ИНН", 				 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ИНН"));
	СведенияОГрузоотправителе.Вставить("КодПоОКПО", 		 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ОКПО"));
	СведенияОГрузоотправителе.Вставить("ЮридическийАдрес",	 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ЮридическийАдрес_Представление"));
	СведенияОГрузоотправителе.Вставить("ФактическийАдрес",	 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.ФактическийАдрес_Представление"));
	СведенияОГрузоотправителе.Вставить("НомерСчета",		 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.НомерСчета"));
	СведенияОГрузоотправителе.Вставить("Банк",				 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.Банк.Наименование"));
	СведенияОГрузоотправителе.Вставить("БИК",				 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.Банк.Код"));
	СведенияОГрузоотправителе.Вставить("КоррСчет",			 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузоотправителя.Банк.КоррСчет"));
	СведенияОГрузоотправителе.Вставить("Телефоны",			 ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.Телефоны"));
	
	ДанныеЗаполненияШапки.Вставить("СведенияОГрузоотправителе", СведенияОГрузоотправителе);
	
	СведенияОГрузополучателе = Новый Структура;
	СведенияОГрузополучателе.Вставить("ПолноеНаименование",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ПолноеНаименование"));
	СведенияОГрузополучателе.Вставить("ИНН", 			   	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ИНН"));
	СведенияОГрузополучателе.Вставить("КодПоОКПО", 		 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ОКПО"));
	СведенияОГрузополучателе.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ЮридическийАдрес_Представление"));
	СведенияОГрузополучателе.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.ФактическийАдрес_Представление"));
	СведенияОГрузополучателе.Вставить("НомерСчета",		 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.НомерСчета"));
	СведенияОГрузополучателе.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.Банк.Наименование"));
	СведенияОГрузополучателе.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.Банк.Код"));
	СведенияОГрузополучателе.Вставить("КоррСчет",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "БанковскийСчетГрузополучателя.Банк.КоррСчет"));
	СведенияОГрузополучателе.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузополучатель.Телефоны"));
	
	ДанныеЗаполненияШапки.Вставить("СведенияОГрузополучателе", СведенияОГрузополучателе);
	
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПодразделения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Грузоотправитель.СтруктурноеПодразделение"));
	ДанныеЗаполненияШапки.Вставить("ОрганизацияПоОКПО", 		 ДанныеЗаполненияШапки.СведенияОПоставщике.КодПоОКПО);
	
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПоставщика",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Наименование"));
	ДанныеЗаполненияШапки.Вставить("ПоставщикПоОКПО",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ОКПО"));
	ДанныеЗаполненияШапки.Вставить("ПредставлениеПлательщика",	"");
	ДанныеЗаполненияШапки.Вставить("ПлательщикПоОКПО",			ДанныеЗаполненияШапки.СведенияОПокупателе.КодПоОКПО);

	ДанныеЗаполненияШапки.Вставить("ОснованиеНомер", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерПоДаннымКлиента"));
	ДанныеЗаполненияШапки.Вставить("ОснованиеДата", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаПоДаннымКлиента"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеОснования", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НаименованиеОснования"));
	
	ДанныеЗаполненияШапки.Вставить("НомерДокумента",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Номер"));
	ДанныеЗаполненияШапки.Вставить("ДатаДокумента",		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Дата"));
	ДанныеЗаполненияШапки.Вставить("НомерОснования",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерДокументаОснования"));
	ДанныеЗаполненияШапки.Вставить("ДатаОснования",		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаДокументаОснования"));
	
	
	ДанныеЗаполненияШапки.Вставить("ПредставлениеИсходногоДокумента",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																					СтрокаОбъекта,	"ПредставлениеИсходногоДокумента"));
	
	ДанныеЗаполненияШапки.Вставить("НомерИсправления",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, 
																					СтрокаОбъекта,	"НомерИсправления"));
	
	ДанныеЗаполненияШапки.Вставить("ДатаИсправления",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																					СтрокаОбъекта,	"ДатаИсправления"));
	
	ДанныеЗаполненияШапки.Вставить("НомерИсправленияИсходногоДокумента",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																					СтрокаОбъекта, "НомерИсправленияИсходногоДокумента"));
																					
	ДанныеЗаполненияШапки.Вставить("ДатаИсправленияИсходногоДокумента",		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																					СтрокаОбъекта, "ДатаИсправленияИсходногоДокумента"));
																					
	ДанныеЗаполненияШапки.Вставить("НомерИсходногоДокумента",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																					СтрокаОбъекта, "НомерИсходногоДокумента"));
																					
	ДанныеЗаполненияШапки.Вставить("ДатаИсходногоДокумента",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																					СтрокаОбъекта, "ДатаИсходногоДокумента"));


	
	ДанныеЗаполненияШапки.Вставить("Курс", 				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Курс"));
	ДанныеЗаполненияШапки.Вставить("КодВалюты",         ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Код"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеВалюты",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Наименование"));
	ДанныеЗаполненияШапки.Вставить("ЦенаВключаетНДС", 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ЦенаВключаетНДС"));
	ДанныеЗаполненияШапки.Вставить("АдресДоставки", 	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "АдресДоставки"));
	
	ДанныеЗаполненияПодвала = Новый Структура;
	ДанныеЗаполненияПодвала.Вставить("ДатаОтпуска", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДатаОтпуска"));
	ДанныеЗаполненияПодвала.Вставить("ДолжностьРуководителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ДолжностьРуководителя"));
	ДанныеЗаполненияПодвала.Вставить("ФИОРуководителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Грузоотправитель.ФИОРуководителя"));
	
	ТЗ = Новый ТаблицаЗначений;
	
	ТЗ.Колонки.Добавить("ТоварКод");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("ВидУпаковки");
	ТЗ.Колонки.Добавить("ТоварНаименование");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаКодПоОКЕИ");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаНаименование");
	ТЗ.Колонки.Добавить("ЦенаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("Цена", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаНДСДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаСНДСДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаСНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("КоличествоДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("МассаНеттоДоКорректировки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("МассаНетто", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("МассаБрутто", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("КоличествоМест", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	ТЗ.Колонки.Добавить("КоличествоВОдномМесте", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	
	
	ИмяНоменклатуры = "Номенклатура";
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		
		НоваяСтрока.ТоварКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ТоварКод");
		НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Наименование");
		
		НоваяСтрока.БазоваяЕдиницаНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.ЕдиницаИзмерения.Наименование");
		НоваяСтрока.БазоваяЕдиницаКодПоОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.ЕдиницаИзмерения.Код");
		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Количество");
		НоваяСтрока.КоличествоДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КоличествоДоКорректировки");
		НоваяСтрока.КоличествоВОдномМесте = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "КоличествоВОдномМесте");
		
		НоваяСтрока.КоличествоМест = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Мест");
		НоваяСтрока.МассаБрутто = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "МассаБрутто");
		
		НоваяСтрока.МассаНеттоДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "МассаНеттоДоКорректировки");
		НоваяСтрока.МассаНетто = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "МассаНетто");
		
		НоваяСтрока.ВидУпаковки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Упаковка");
		
		НоваяСтрока.ЦенаДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЦенаДоКорректировки");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.СуммаДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаДоКорректировки");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		НоваяСтрока.СуммаНДСДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДСДоКорректировки");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДС");
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтавкаНДС");
		НоваяСтрока.СуммаСНДСДоКорректировки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСНДСДоКорректировки");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСНДС");
		НоваяСтрока.СуммаНДС = ?(ЗначениеЗаполнено(НоваяСтрока.СуммаНДС), НоваяСтрока.СуммаНДС, 0);
		Если Не ЗначениеЗаполнено (НоваяСтрока.СтавкаНДС) Тогда
			НоваяСтрока.СтавкаНДС = НСтр("ru ='без НДС'");
		Иначе
			НоваяСтрока.СтавкаНДС = Строка(НоваяСтрока.СтавкаНДС);
		КонецЕсли;
		
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Подвал", ДанныеЗаполненияПодвала);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	СтрокаДереваДопДанных = ДеревоРазбора.Строки.Найти("ДеревоДопДанных", "Реквизит", Истина);
	Если СтрокаДереваДопДанных <> Неопределено И ТипЗнч(СтрокаДереваДопДанных.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДереваДопДанных.ЗначениеРеквизита;
		ДанныеДляОбъекта.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ "Корректировочный Торг-12".
//
Процедура ЗаполнитьТабличныйДокументКорректировочныйДокумент_ЭД(ТабличныйДокумент, ДанныеПечати, ДанныеПокупателя, ПараметрыПечати)
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ТабличныйДокумент.ПолеСлева = 5;
	ТабличныйДокумент.ПолеСправа = 5;
	ТабличныйДокумент.РазмерКолонтитулаСверху = 0;
	ТабличныйДокумент.РазмерКолонтитулаСнизу = 0;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_СоглашениеОбИзмененииСтоимостиОтправитель_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
		
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ЭД_СогласованиеСторон";
	
	ЗаполнитьРеквизитыШапкиКорректировкаСтоимости(ДанныеПечати.Шапка, Макет, ТабличныйДокумент);
	
	НомерСтраницы = 1;
	ИтоговыеСуммы = СтруктураИтоговыеСуммы();
	
	КоэффициентПересчета = 1;
	ДанныеСтроки = СтруктураДанныеСтроки(КоэффициентПересчета);
	
	// Создаем массив для проверки вывода
	МассивВыводимыхОбластей = Новый Массив;
	
	// Выводим многострочную часть документа
	ОбластьЗаголовокТаблицы = Макет.ПолучитьОбласть("ЗаголовокТаб|ОсновныеДанныеТаблицы");
	ОбластьМакета           = Макет.ПолучитьОбласть("Строка|ОсновныеДанныеТаблицы");
	ОбластьИтоговПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице|ОсновныеДанныеТаблицы");
	ОбластьВсего            = Макет.ПолучитьОбласть("Всего|ОсновныеДанныеТаблицы");
	ОбластьПодвала          = Макет.ПолучитьОбласть("Подвал");
	
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
	
		ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицы");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицы");
			ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
			ОбластьЗаголовокТаблицыДДБезЭП = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицыБезЭЦП");
			ОбластьМакетаДДБезЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыБезЭЦП");
		КонецЕсли;
	КонецЕсли;
	
	// Выводим табличную часть документа
	ТЧТовары = ДанныеПечати.Товары;
	
	КоличествоСтрок = ТЧТовары.Количество();
	
	Для Каждого СтрокаТовары Из ТЧТовары Цикл
		
		ДанныеСтроки.Номер = ДанныеСтроки.Номер + 1;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		
		ДанныеСтроки.Мест = СтрокаТовары.КоличествоМест;
		
		ДанныеСтроки.КоэффициентПересчета  = ?(ЗначениеЗаполнено(СтрокаТовары.КоличествоВОдномМесте), СтрокаТовары.КоличествоВОдномМесте, 1);
		
		ДанныеСтроки.КоличествоДоКорректировки  = СтрокаТовары.КоличествоДоКорректировки;
		ДанныеСтроки.Количество  = СтрокаТовары.Количество;
		ДанныеСтроки.МассаНеттоДоКорректировки = СтрокаТовары.МассаНеттоДоКорректировки;
		ДанныеСтроки.МассаНетто = СтрокаТовары.МассаНетто;
		
		ДанныеСтроки.СуммаДоКорректировки     = СтрокаТовары.СуммаДоКорректировки;
		ДанныеСтроки.Сумма                    = СтрокаТовары.Сумма;
		ДанныеСтроки.СуммаНДСДоКорректировки  = СтрокаТовары.СуммаНДСДоКорректировки;
		ДанныеСтроки.СуммаНДС                 = СтрокаТовары.СуммаНДС;
		ДанныеСтроки.СуммаСНДСДоКорректировки = СтрокаТовары.СуммаСНДСДоКорректировки;
		ДанныеСтроки.СуммаСНДС                = СтрокаТовары.СуммаСНДС;
		
		ДанныеСтроки.ЦенаДоКорректировки = СтрокаТовары.ЦенаДоКорректировки;
		ДанныеСтроки.Цена = СтрокаТовары.Цена;
		
		ОбластьМакета.Параметры.Заполнить(ДанныеСтроки);
		
		
		Если ДанныеСтроки.Номер = 1 Тогда // первая строка
			
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьЗаголовокТаблицы,
				"ЗаголовокТаблицыОсновныеДанные");
			Если Не СкрыватьДопДанные Тогда
				Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
						"ЗаголовокТаблицыДопДанные");
				Иначе
					Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
							"ЗаголовокТаблицыДопДанныеСЭП");
					КонецЕсли;
					Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП,
							"ЗаголовокТаблицыДопДанныеБезЭП");
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		Иначе
			
			МассивВыводимыхОбластей.Очистить();
			МассивВыводимыхОбластей.Добавить(ОбластьМакета);
			МассивВыводимыхОбластей.Добавить(ОбластьИтоговПоСтранице);
			
			Если ДанныеСтроки.Номер = КоличествоСтрок Тогда
				
				МассивВыводимыхОбластей.Добавить(ОбластьВсего);
				МассивВыводимыхОбластей.Добавить(ОбластьПодвала);
				
			КонецЕсли;
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
			"СтрокаОсновныеДанные", ДанныеСтроки.Номер);
		
		РассчитатьИтоговыеСуммы(ИтоговыеСуммы, ДанныеСтроки);
		
		Если Не СкрыватьДопДанные Тогда
			Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
				СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(ДанныеСтроки.Номер), "НомерСтр");
				Если СтрокаТаблицыДД <> Неопределено Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ОбластьМакетаДД.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
						ОбластьМакетаДД.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДД,
							"СтрокаДопДанные", ДанныеСтроки.Номер);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ОбластьМакетаДДСЭП.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП,
								"СтрокаДопДанныеСЭП", ДанныеСтроки.Номер);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ОбластьМакетаДДБезЭП.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДБезЭП,
								"СтрокаДопДанныеБезЭП", ДанныеСтроки.Номер);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	// Выводим итоги по последней странице
	ОбластьИтоговПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице");
	ОбластьИтоговПоСтранице.Параметры.Заполнить(ИтоговыеСуммы);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтоговПоСтранице, "ИтогоПоСтранице");
		
	// Выводим итоги по документу в целом
	ОбластьМакета = Макет.ПолучитьОбласть("Всего");
	ОбластьМакета.Параметры.Заполнить(ИтоговыеСуммы);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Всего");
	
	// Выводим подвал документа
	ЗаполнитьРеквизитыПодвалаТОРГ12(ДанныеПечати.Подвал, Макет, ТабличныйДокумент, ДанныеПокупателя, Истина);
	
	Если Не СкрыватьДопДанные Тогда
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

Функция ДанныеСоглашенияПолучатель(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеПокупателя = Новый Структура;
	
	ДанныеПокупателя.Вставить("ГрузПолучилДолжность", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ГрузПолучилДолжность"));
	ДанныеПокупателя.Вставить("ГрузПолучилФИО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ГрузПолучилФИО"));
	ДанныеПокупателя.Вставить("ДатаПолучения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаПолучения"));
	
	Возврат ДанныеПокупателя;
	
КонецФункции

Процедура ЗаполнитьТабличныйДокумент_СоглашениеПолучателя(ТабличныйДокумент, ДанныеПолучателя, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_СоглашениеОбИзмененииСтоимостиПолучатель_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Заполнить(ДанныеПолучателя);
	Если ДанныеПолучателя.Свойство("ДатаДокументаОтправителя") Тогда
		ОбластьМакета.Параметры.ДатаДокументаОтправителя = Формат(ДанныеПолучателя.ДатаДокументаОтправителя, "ДЛФ=DD");
	КонецЕсли;
	
	ПолнаяДатаПринял = Формат(ДанныеПолучателя.ДатаПолучения, "ДЛФ=DD");
	ДлинаСтроки = СтрДлина(ПолнаяДатаПринял);
	ПервыйРазделитель = СтрНайти(ПолнаяДатаПринял, " ");
	ВторойРазделитель = СтрНайти(Прав(ПолнаяДатаПринял, ДлинаСтроки - ПервыйРазделитель), " ") + ПервыйРазделитель;
	ОбластьМакета.Параметры.ДатаПринялДень = """" + Лев(ПолнаяДатаПринял, ПервыйРазделитель -1 ) + """";
	ОбластьМакета.Параметры.ДатаПринялМесяц = Сред(ПолнаяДатаПринял, ПервыйРазделитель + 1, ВторойРазделитель - ПервыйРазделитель - 1);
	ОбластьМакета.Параметры.ДатаПринялГод = Прав(ПолнаяДатаПринял, ДлинаСтроки - ВторойРазделитель);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подписи");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с ПРАЙС-ЛИСТ

Функция ПолучитьДанныеПрайсЛистаДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОПоставщике = Новый Структура;
	СведенияОПоставщике.Вставить("Представление",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.Наименование"));
	СведенияОПоставщике.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОПоставщике);
	ДанныеЗаполненияШапки.Вставить("ДатаФормирования", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДатаФормирования"));
	СведенияОПоставщике.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОПоставщике.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.КПП"));
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Артикул");
	ТЗ.Колонки.Добавить("Товар");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("ЕдиницаИзмерения");
	ТЗ.Колонки.Добавить("Цена");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.Артикул          = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.Артикул");
		НоваяСтрока.Товар            = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"НоменклатураПоставщика.Наименование");
		НоваяСтрока.ЕдиницаИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"ЕдиницаИзмерения.Наименование");
		НоваяСтрока.Цена             = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.Количество       = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Количество");
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Процедура ЗаполнитьТабличныйДокументПрайсЛист_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ПрайсЛист_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок|Данные");
	ОбластьШапка     = Макет.ПолучитьОбласть("ШапкаТаблицы|Данные");
	ОбластьСтрока    = Макет.ПолучитьОбласть("СтрокаТаблицы|Данные");
	ОбластьПодвал    = Макет.ПолучитьОбласть("ПодвалТаблицы|Данные");
	
	Если Не СкрыватьДопДанные Тогда
		ТаблицаДопДанныхСтрок = ТаблицаДопДанных();
		
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		ЕстьДопДанные = Ложь;
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ЕстьДопДанные = Истина;
			
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицы|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаТаблицы|ДопДанныеТаблицыСЭЦП");
			
		КонецЕсли;
	КонецЕсли;
	
	ОбластьЗаголовок.Параметры.ДатаФормирования = Формат(ДанныеПечати.Шапка.ДатаФормирования, "ДЛФ=DD");
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьЗаголовок, "Заголовок");
	
	ОбластьШапка.Параметры.Заполнить(ДанныеПечати.Шапка);
	
	СведенияОПоставщике = ДанныеПечати.Шапка.СведенияОПоставщике;
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		СведенияОПоставщике,
		ОбластьШапка.Параметры.ПредставлениеПоставщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,");
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьШапка, "ШапкаТаблицы");
	
	Если Не СкрыватьДопДанные Тогда
		Если ЕстьДопДанные Тогда
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД, 
				"ШапкаТаблицыДопДанные");
		КонецЕсли;
	КонецЕсли;
	
	ТаблицаТовары = ДанныеПечати.Товары;
	НомерСтроки = 1;
	Для Каждого Строка Из ТаблицаТовары Цикл
		
		ОбластьСтрока.Параметры.Заполнить(Строка);
		ОбластьСтрока.Параметры.НомерСтроки = НомерСтроки;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьСтрока, "СтрокаОсновныеДанные", НомерСтроки);
		
		Если Не СкрыватьДопДанные Тогда
			ВывестиДопДанныеСтрокиНаПечать(ТаблицаДопДанныхСтрок, СтруктураНаличияДопДанных,
				НомерСтроки, ТабличныйДокумент, ОбластьМакетаДД, "СтрокаДопДанные");
		КонецЕсли;
		
		НомерСтроки = НомерСтроки + 1;

	КонецЦикла;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвал, "ПодвалТаблицы");
	
	Если Не СкрыватьДопДанные Тогда
		ВывестиДопДанныеШапкиНаПечать(ДанныеПечати, Макет,ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с ЭД прочитанными по схеме CML2

Функция СтруктураДанныхКонтрагента(СтрокаОбъекта, ДеревоРазбора, ТипУчастника, ТипБанковскогоСчета)
	
	Структура = Новый Структура;
	Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + ".Наименование");
	ПолнНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + ".ПолноеНаименование");
	Структура.Вставить("Представление", 	?(ЗначениеЗаполнено(Наименование), Наименование, ПолнНаименование));
	Структура.Вставить("ПолноеНаименование",?(ЗначениеЗаполнено(ПолнНаименование), ПолнНаименование, Наименование));
	Структура.Вставить("ИНН",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + ".ИНН"));
	Структура.Вставить("КПП",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + ".КПП"));
	Структура.Вставить("ЮридическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + ".ЮридическийАдрес_Представление"));
	Структура.Вставить("ФактическийАдрес",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + ".ФактическийАдрес_Представление"));
	Вид = ЭлектронноеВзаимодействие.НайтиСсылку("ВидыКонтактнойИнформации","ТелефонКонтрагента");
	Если ЗначениеЗаполнено(Вид) Тогда
		Структура.Вставить("Телефоны",			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + "." + Вид));
	КонецЕсли;
	Структура.Вставить("НомерСчета",		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + "." + ТипБанковскогоСчета + ".НомерСчета"));
	Структура.Вставить("Банк",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + "." + ТипБанковскогоСчета + ".Банк.Наименование"));
	Структура.Вставить("БИК",				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, ТипУчастника + "." + ТипБанковскогоСчета + ".Банк.Код"));
	
	Возврат Структура;
	
КонецФункции

Функция ТаблицаТоваров(ДанныеШапки, СтрокаОбъекта, ДеревоРазбора, ИмяТаблицы)
	
	ТЗ = Новый ТаблицаЗначений;
	
	ТЗ.Колонки.Добавить("Артикул");
	ТЗ.Колонки.Добавить("ТоварКод");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("ВидУпаковки");
	ТЗ.Колонки.Добавить("НДСУчтеноВСумме");
	ТЗ.Колонки.Добавить("ТоварНаименование");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаКодПоОКЕИ");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаНаименование");
	ТЗ.Колонки.Добавить("Цена", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("СуммаСНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТЗ.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	
	ТЗ.Колонки.Добавить("СерийныеНомера");
	
	ДопДанныеПодписанные = Новый Структура;
	
	ТаблицаСерийныеНомера = Новый ТаблицаЗначений;
	ТаблицаСерийныеНомера.Колонки.Добавить("КлючСтроки");
	ТаблицаСерийныеНомера.Колонки.Добавить("ЗначениеРеквизита");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", ИмяТаблицы));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.Артикул = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Артикул");
		НоваяСтрока.ТоварКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Артикул");
		НаименованиеТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Описание");
		Если Не ЗначениеЗаполнено(НаименованиеТовара) Тогда
			НаименованиеТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Наименование");
		КонецЕсли;
		НоваяСтрока.ТоварНаименование =НаименованиеТовара;
		
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтавкаНДС");
		НоваяСтрока.НДСУчтеноВСумме = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НДСУчтеноВСумме");
		НоваяСтрока.ВидУпаковки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ВидУпаковки");
		
		НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДС");
		НДСВСумме = ?(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НДСУчтеноВСумме") = Истина, Истина, Ложь);
		Сумма = ?(ТипЗнч(Сумма) = Тип("Число"), Сумма, 0);
		СуммаНДС = ?(ТипЗнч(СуммаНДС) = Тип("Число"), СуммаНДС, 0);
		
		НоваяСтрока.Сумма = Сумма - ?(НДСВСумме, СуммаНДС, 0);
		НоваяСтрока.СуммаНДС = СуммаНДС;
		НоваяСтрока.СуммаСНДС = Сумма + ?(НДСВСумме, 0, СуммаНДС);
		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Количество");
		
		ЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.БазоваяЕдиница");
		Если ЗначениеЗаполнено(ЕИ) Тогда
			НоваяСтрока.БазоваяЕдиницаНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.БазоваяЕдиница.Наименование");
			НоваяСтрока.БазоваяЕдиницаКодПоОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.БазоваяЕдиница.Код");
		Иначе
			НоваяСтрока.БазоваяЕдиницаНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.ЕдиницаИзмерения.Наименование");
			НоваяСтрока.БазоваяЕдиницаКодПоОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.ЕдиницаИзмерения.Код");
		КонецЕсли;
		
		СерийныеНомера = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СерийныеНомера");
		Если ЗначениеЗаполнено(СерийныеНомера) Тогда
			
			Если ТипЗнч(СерийныеНомера) = Тип("Строка") Тогда
				МассивНомера = Новый Массив;
				МассивНомера.Добавить(СерийныеНомера);
			Иначе
				МассивНомера = СерийныеНомера;
			КонецЕсли;
			
			СерийныеНомера = СтрСоединить(МассивНомера, ";");
			
			ЗначенияРеквизитовНоваяСтрока = ТаблицаСерийныеНомера.Добавить();
			ЗначенияРеквизитовНоваяСтрока.КлючСтроки = ТЗ.Индекс(НоваяСтрока);
			ЗначенияРеквизитовНоваяСтрока.ЗначениеРеквизита = НСтр("ru ='Серийные номера:'") + " "+ СерийныеНомера;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если ТаблицаСерийныеНомера.Количество() Тогда
		ДанныеШапки.Вставить("ЗначенияРеквизитов", ТаблицаСерийныеНомера);
	КонецЕсли;
	
	Возврат ТЗ;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Работа с Актом на передачу прав (CML2)

Функция ПолучитьДанныеАктаНаПередачуПравДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКонтрагенте = СтруктураДанныхКонтрагента(СтрокаОбъекта, ДеревоРазбора, "Контрагент", "БанковскийСчетКонтрагента");
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОЛицензиате", СведенияОКонтрагенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОЛицензиаре", СведенияОКонтрагенте);
	КонецЕсли;
	
	СведенияОбОрганизации = СтруктураДанныхКонтрагента(СтрокаОбъекта, ДеревоРазбора, "Организация", "БанковскийСчетОрганизации");
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОЛицензиаре", СведенияОбОрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОЛицензиате", СведенияОбОрганизации);
	КонецЕсли;
	
	// В строке Основание выводится на просмотр содержимое таблицы "ДокументыСделки".
	ДокументыСделки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДокументыСделки");
	Если ЗначениеЗаполнено(ДокументыСделки) Тогда
		Основание = "";
		Если ТипЗнч(ДокументыСделки) = Тип("ТаблицаЗначений") Тогда
			Для Каждого ТекущаяСтрока Из ДокументыСделки Цикл
				Основание = ?(ЗначениеЗаполнено(Основание), "; ", "") + ТекущаяСтрока.Представление;
			КонецЦикла;
		КонецЕсли;
		ДанныеЗаполненияШапки.Вставить("Основание", Основание);
	КонецЕсли;
	
	СведенияОПлательщике = СтруктураДанныхКонтрагента(СтрокаОбъекта, ДеревоРазбора, "Плательщик", "БанковскийСчетКонтрагента");
	ДанныеЗаполненияШапки.Вставить("СведенияОПлательщике", СведенияОПлательщике);
	
	ДанныеЗаполненияШапки.Вставить("НомерДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Номер"));
	ДанныеЗаполненияШапки.Вставить("ДатаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Дата"));
	
	ДанныеЗаполненияШапки.Вставить("НомерИсправления", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерИсправления"));
	ДанныеЗаполненияШапки.Вставить("ДатаИсправления", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаИсправления"));
	
	ДанныеЗаполненияШапки.Вставить("УсловияПередачи", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "УсловияПередачи"));
	ДанныеЗаполненияШапки.Вставить("КодПартнера", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "КодПартнера"));
	
	ОсобыеУсловия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ОсобыеУсловия");
	ДанныеЗаполненияШапки.Вставить("ОсобыеУсловия", ОсобыеУсловия);
	
	ДанныеЗаполненияШапки.Вставить("ДатаФормирования", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаФормирования"));
	
	СуммаДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "СуммаДокумента");
	КодВалюты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Валюта.Код");
	
	СуммаПрописью = "";
	ОбменСКонтрагентамиПереопределяемый.СуммаПрописью(СуммаДокумента, КодВалюты, СуммаПрописью);
	ДанныеЗаполненияШапки.Вставить("СуммаПрописью", СуммаПрописью);
	
	Подписанты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Подписанты");
	Если ТипЗнч(Подписанты) = Тип("Массив") И Подписанты.Количество() > 0 Тогда
		ДанныеЗаполненияШапки.Вставить("ДолжностьРуководителя", Подписанты[0].Должность);
		ДанныеЗаполненияШапки.Вставить("ФИОРуководителя", ФизическиеЛицаКлиентСервер.ФамилияИнициалы(Подписанты[0]));
	КонецЕсли;
	
	Товары = ТаблицаТоваров(ДанныеЗаполненияШапки, СтрокаОбъекта, ДеревоРазбора, "СтрокаТЧ");
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", Товары);
	
	ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ Акт выполненных работ.
//
Процедура ЗаполнитьТабличныйДокументАктНаПередачуПрав(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ТабличныйДокумент.ПолеСлева = 5;
	ТабличныйДокумент.ПолеСправа = 5;
	ТабличныйДокумент.РазмерКолонтитулаСверху = 0;
	ТабличныйДокумент.РазмерКолонтитулаСнизу = 0;
	ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	ДеревоДопДанных = Неопределено;
	Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = Неопределено;
	КонецЕсли;

	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_АктВыполненныхРабот_Акт";
	
	Шапка = ДанныеПечати.Шапка;
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_АктНаПередачуПрав_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	// Выводим шапку акта
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьМакета.Параметры.Заполнить(Шапка);
	
	ЗаполнитьДатуНомерИсправления(ОбластьМакета, Шапка.ДатаИсправления, Шапка.НомерИсправления);
	
	Если НЕ ЗначениеЗаполнено(Шапка.КодПартнера) Тогда
		ОбластьМакета.Области.Найти("ОбластьКодПартнера").Очистить();
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		Шапка.СведенияОЛицензиаре,
		ОбластьМакета.Параметры.ПредставлениеЛицензиара,
		"ПолноеНаименование,ИНН,КПП,ФактическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		Шапка.СведенияОЛицензиате,
		ОбластьМакета.Параметры.ПредставлениеЛицензиата,
		"ПолноеНаименование,ИНН,КПП,ФактическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет");
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		Шапка.СведенияОПлательщике,
		ОбластьМакета.Параметры.ПредставлениеПлательщика,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК");
		
	Если ЗначениеЗаполнено(Шапка.УсловияПередачи) Тогда
		ОбластьМакета.Области.ОбластьУсловияПередачи.Текст = Шапка.УсловияПередачи;
	Иначе
		ОбластьМакета.Параметры.ЛицензиарНаименование = ?(ЗначениеЗаполнено(Шапка.СведенияОЛицензиаре.Представление),
			Шапка.СведенияОЛицензиаре.Представление, Шапка.СведенияОЛицензиаре.ПолноеНаименование);
		ОбластьМакета.Параметры.ЛицензиатНаименование = ?(ЗначениеЗаполнено(Шапка.СведенияОЛицензиате.Представление),
			Шапка.СведенияОЛицензиате.Представление, Шапка.СведенияОЛицензиате.ПолноеНаименование);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
	НомерСтраницы = 1;
	ИтоговыеСуммы = СтруктураИтоговыеСуммы();
	
	КоэффициентПересчета = 1;
	ДанныеСтроки = СтруктураДанныеСтроки(КоэффициентПересчета);
	
	// Создаем массив для проверки вывода
	МассивВыводимыхОбластей = Новый Массив;
	
	// Выводим многострочную часть документа
	ОбластьЗаголовокТаблицы = Макет.ПолучитьОбласть("ЗаголовокТаб|ОсновныеДанныеТаблицы");
	ОбластьМакета           = Макет.ПолучитьОбласть("Строка|ОсновныеДанныеТаблицы");
	ОбластьИтоговПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице|ОсновныеДанныеТаблицы");
	ОбластьВсего            = Макет.ПолучитьОбласть("Всего|ОсновныеДанныеТаблицы");
	ОбластьПодвала          = Макет.ПолучитьОбласть("Подвал");
		
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицы");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицы");
			ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДДСЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
			ОбластьЗаголовокТаблицыДДБезЭП = Макет.ПолучитьОбласть("ЗаголовокТаб|ДопДанныеТаблицыБезЭЦП");
			ОбластьМакетаДДБезЭП           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыБезЭЦП");
		КонецЕсли;
	КонецЕсли;

	// Выводим табличную часть документа
	ТЧТовары = ДанныеПечати.Товары;
	Если ТЧТовары.Колонки.Найти("СуммаНДС") <> Неопределено И ТЧТовары.Итог("СуммаНДС") > 0 Тогда
		ЕстьНДС = Истина;
	Иначе
		ЕстьНДС = Ложь;
	КонецЕсли;
	
	КоличествоСтрок = ТЧТовары.Количество();
	
	Для Каждого СтрокаТовары Из ТЧТовары Цикл
		
		ДанныеСтроки.Номер = ДанныеСтроки.Номер + 1;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		ЗаполнитьЗначенияСвойств(ДанныеСтроки, СтрокаТовары);
		ОбластьМакета.Параметры.Заполнить(ДанныеСтроки);
		
		Если ДанныеСтроки.Номер = 1 Тогда // первая строка
			
			ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница " + НомерСтраницы;
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьЗаголовокТаблицы,
				"ЗаголовокТаблицыОсновныеДанные", НомерСтраницы);
			
			Если Не СкрыватьДопДанные Тогда
				Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
						"ЗаголовокТаблицыДопДанные", НомерСтраницы);
				Иначе
					Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
							"ЗаголовокТаблицыДопДанныеСЭП", НомерСтраницы);
					КонецЕсли;
					Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП,
							"ЗаголовокТаблицыДопДанныеБезЭП", НомерСтраницы);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		Иначе
			
			МассивВыводимыхОбластей.Очистить();
			МассивВыводимыхОбластей.Добавить(ОбластьМакета);
			МассивВыводимыхОбластей.Добавить(ОбластьИтоговПоСтранице);
			
			Если ДанныеСтроки.Номер = КоличествоСтрок Тогда
				
				МассивВыводимыхОбластей.Добавить(ОбластьВсего);
				МассивВыводимыхОбластей.Добавить(ОбластьПодвала);
				
			КонецЕсли;
			
			Если ДанныеСтроки.Номер <> 1 И Не ПроверитьВыводТабличногоДокумента(ТабличныйДокумент,МассивВыводимыхОбластей) Тогда
				
				ОбластьИтоговПоСтранице.Параметры.Заполнить(ИтоговыеСуммы);
				ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтоговПоСтранице,
					"ИтогоПоСтранице", НомерСтраницы);
				
				// Очистим итоги по странице.
				ОбнулитьИтогиПоСтранице(ИтоговыеСуммы);
				
				НомерСтраницы = НомерСтраницы + 1;
				ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
				ОбластьЗаголовокТаблицы.Параметры.НомерСтраницы = "Страница " + НомерСтраницы;
				
				ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьЗаголовокТаблицы,
					"ЗаголовокТаблицыОсновныеДанные", НомерСтраницы);
				
				Если Не СкрыватьДопДанные Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
							"ЗаголовокТаблицыДопДанные", НомерСтраницы);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
								"ЗаголовокТаблицыДопДанныеСЭП", НомерСтраницы);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП,
								"ЗаголовокТаблицыДопДанныеБезЭП", НомерСтраницы);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
			"СтрокаОсновныеДанные", ДанныеСтроки.Номер);
		РассчитатьИтоговыеСуммы(ИтоговыеСуммы, ДанныеСтроки);
		
		Если Не СкрыватьДопДанные Тогда
			Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
				СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(ДанныеСтроки.Номер), "НомерСтр");
				Если СтрокаТаблицыДД <> Неопределено Тогда
					Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
						ОбластьМакетаДД.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
						ОбластьМакетаДД.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
						ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДД,
							"СтрокаДопДанные", ДанныеСтроки.Номер);
					Иначе
						Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
							ОбластьМакетаДДСЭП.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП,
								"СтрокаДопДанныеСЭП", ДанныеСтроки.Номер);
						КонецЕсли;
						Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ОбластьМакетаДДБезЭП.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДБезЭП,
								"СтрокаДопДанныеБезЭП", ДанныеСтроки.Номер);
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	// Выводим итоги по последней странице
	ОбластьИтоговПоСтранице = Макет.ПолучитьОбласть("ИтогоПоСтранице");
	ОбластьИтоговПоСтранице.Параметры.Заполнить(ИтоговыеСуммы);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьИтоговПоСтранице,
		"ИтогоПоСтранице", НомерСтраницы);
	
	// Выводим итоги по документу в целом
	ОбластьМакета = Макет.ПолучитьОбласть("Всего");
	ОбластьМакета.Параметры.Заполнить(ИтоговыеСуммы);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Всего");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
	
	ОбластьМакета.Параметры.Заполнить(Шапка);
	
	ПолнаяДатаДокумента = Формат(Шапка.ДатаФормирования, "ДЛФ=DD");
	ДлинаСтроки = СтрДлина(ПолнаяДатаДокумента);
	ПервыйРазделитель = СтрНайти(ПолнаяДатаДокумента, " ");
	ВторойРазделитель = СтрНайти(Прав(ПолнаяДатаДокумента, ДлинаСтроки - ПервыйРазделитель), " ") + ПервыйРазделитель;
	ОбластьМакета.Параметры.ДатаДокументаДень = """" + Лев(ПолнаяДатаДокумента, ПервыйРазделитель -1 ) + """";
	ОбластьМакета.Параметры.ДатаДокументаМесяц = Сред(ПолнаяДатаДокумента, ПервыйРазделитель + 1, ВторойРазделитель - ПервыйРазделитель - 1);
	ОбластьМакета.Параметры.ДатаДокументаГод = Прав(ПолнаяДатаДокумента, ДлинаСтроки - ВторойРазделитель);
	
	Если ДанныеПечати.Шапка.Свойство("ДатаПодписанияПолучателя") Тогда
		ДатаПодписанияПолучателя = Формат(ДанныеПечати.Шапка.ДатаПодписанияПолучателя, "ДЛФ=DD");
		ДлинаСтроки = СтрДлина(ДатаПодписанияПолучателя);
		ПервыйРазделитель = СтрНайти(ДатаПодписанияПолучателя, " ");
		ВторойРазделитель = СтрНайти(Прав(ДатаПодписанияПолучателя, ДлинаСтроки - ПервыйРазделитель), " ") + ПервыйРазделитель;
		ОбластьМакета.Параметры.ДатаПодписанияПолучателяДень = """" + Лев(ДатаПодписанияПолучателя, ПервыйРазделитель -1 ) + """";
		ОбластьМакета.Параметры.ДатаПодписанияПолучателяМесяц = Сред(ДатаПодписанияПолучателя, ПервыйРазделитель + 1, ВторойРазделитель - ПервыйРазделитель - 1);
		ОбластьМакета.Параметры.ДатаПодписанияПолучателяГод = Прав(ДатаПодписанияПолучателя, ДлинаСтроки - ВторойРазделитель);
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подвал");
	
	Если Не СкрыватьДопДанные Тогда
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с каталогом файлов

Функция ПолучитьДанныеКаталогаТоваровДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОПоставщике = Новый Структура;
	СведенияОПоставщике.Вставить("Представление",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.Наименование"));
	СведенияОПоставщике.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОПоставщике.Вставить("ОфициальноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ОфициальноеНаименование"));
	СведенияОПоставщике.Вставить("ИНН", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Контрагент.ИНН"));
	СведенияОПоставщике.Вставить("КПП", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Контрагент.КПП"));
	
	ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОПоставщике);
	ДанныеЗаполненияШапки.Вставить("ДатаФормирования", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДатаФормирования"));
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Артикул");
	ТЗ.Колонки.Добавить("Код");
	ТЗ.Колонки.Добавить("Товар");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("ЕдиницаИзмерения");
	ТЗ.Колонки.Добавить("ЗначенияСвойств");
	ТЗ.Колонки.Добавить("Картинки");
	ЕстьСвойства = Ложь;
	ЕстьКартинки = Ложь;
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.Артикул = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"НоменклатураПоставщика.Артикул");
		НоваяСтрока.Код     = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"НоменклатураПоставщика.Код");
		НоваяСтрока.Товар   = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"НоменклатураПоставщика.Наименование");
			
		ЗначенияСвойств = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
								ДеревоРазбора,
								СтрокаТЧ,
								"НоменклатураПоставщика.ЗначенияСвойств");
		Если Не ЗначенияСвойств = Неопределено Тогда
			НоваяСтрока.ЗначенияСвойств = ЗначенияСвойств;
			ЕстьСвойства = Истина;
		КонецЕсли;
		
		Картинки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
								ДеревоРазбора,
								СтрокаТЧ,
								"НоменклатураПоставщика.Картинки");
		Если Не Картинки = Неопределено Тогда
			НоваяСтрока.Картинки = Картинки;
			ЕстьКартинки = Истина;
		КонецЕсли;
		
		Упаковка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЕдиницаИзмерения.Наименование");
		ЕдиницаИзмеренияНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"НоменклатураПоставщика.ЕдиницаИзмерения.Наименование");
		Если Не ЗначениеЗаполнено(ЕдиницаИзмеренияНаименование) Тогда
			ЕдиницаИзмеренияНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
				"НоменклатураПоставщика.ЕдиницаИзмерения.НаименованиеПолное");
		КонецЕсли;
		
		НоваяСтрока.ЕдиницаИзмерения = ЕдиницаИзмеренияНаименование;
		
	КонецЦикла;
	
	ДанныеЗаполненияШапки.Вставить("ЕстьСвойства", ЕстьСвойства);
	ДанныеЗаполненияШапки.Вставить("ЕстьКартинки", ЕстьКартинки);
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Процедура ЗаполнитьТабличныйДокументКаталогаТоваров_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_КаталогТоваров_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ОбластьЗаголовок     = Макет.ПолучитьОбласть("Заголовок|ОсновныеДанныеТаблицы");
	ОбластьШапка         = Макет.ПолучитьОбласть("ШапкаТаблицы|ОсновныеДанныеТаблицы");
	ОбластьШапкаСвойства = Макет.ПолучитьОбласть("ШапкаТаблицы|Свойства");
	ОбластьШапкаКартинки = Макет.ПолучитьОбласть("ШапкаТаблицы|Картинки");
	ОбластьСтрока        = Макет.ПолучитьОбласть("СтрокаТаблицы|ОсновныеДанныеТаблицы");
	ОбластьПодвал        = Макет.ПолучитьОбласть("ПодвалТаблицы|ОсновныеДанныеТаблицы");
	ОбластьСвойства      = Макет.ПолучитьОбласть("СтрокаТаблицы|Свойства");
	ОбластьКартинки      = Макет.ПолучитьОбласть("СтрокаТаблицы|Картинки");
	
	ОбластьЗаголовок.Параметры.ДатаФормирования = Формат(ДанныеПечати.Шапка.ДатаФормирования, "ДЛФ=Д");
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьЗаголовок, "Заголовок");
	
	ОбластьШапка.Параметры.Заполнить(ДанныеПечати.Шапка);
	
	СведенияОПоставщике = ДанныеПечати.Шапка.СведенияОПоставщике;
	ОбластьШапка.Параметры.ПредставлениеПоставщика = ?(ЗначениеЗаполнено(СведенияОПоставщике.ПолноеНаименование),
		СведенияОПоставщике.ПолноеНаименование, ?(ЗначениеЗаполнено(СведенияОПоставщике.ОфициальноеНаименование),
		СведенияОПоставщике.ОфициальноеНаименование, СведенияОПоставщике.Представление));
	ОбластьШапка.Параметры.Заполнить(СведенияОПоставщике);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьШапка, "ШапкаТаблицы");
	
	Если ДанныеПечати.Шапка.ЕстьСвойства Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьШапкаСвойства,
			"ШапкаТаблицыСвойства");
	КонецЕсли;
	
	Если ДанныеПечати.Шапка.ЕстьКартинки Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьШапкаКартинки,
			"ШапкаТаблицыКартинки");
	КонецЕсли;
	
	Если Не СкрыватьДопДанные Тогда
		ТаблицаДопДанныхСтрок = ТаблицаДопДанных();
		
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда

			
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицы|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаТаблицы|ДопДанныеТаблицыСЭЦП");
			
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
				"ШапкаТаблицыДопДанные");
			
		КонецЕсли;
	КонецЕсли;
	
	
	ТаблицаТовары = ДанныеПечати.Товары;
	НомерСтроки = 1;
	Для Каждого Строка Из ТаблицаТовары Цикл
		ОбластьСтрока.Параметры.Заполнить(Строка);
		ОбластьСтрока.Параметры.НомерСтроки = НомерСтроки;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьСтрока, "СтрокаОсновныеДанные", НомерСтроки);
		Если ДанныеПечати.Шапка.ЕстьСвойства Тогда
			СтрокаСвойства = "";
			Если Строка.ЗначенияСвойств <> Неопределено Тогда
				Для Каждого Свойство Из Строка.ЗначенияСвойств Цикл
					СтрокаСвойства = СтрокаСвойства + "(" + Свойство.ИД + ", " + Свойство.Наименование + ", [";
					Для Каждого Значение Из Свойство.Значение Цикл
						СтрокаСвойства = СтрокаСвойства + Значение + ",";
					КонецЦикла;
					СтрокаСвойства = Сред(СтрокаСвойства, 1, СтрДлина(СтрокаСвойства) - 1);
					СтрокаСвойства = СтрокаСвойства + "]);" + Символы.ПС;
				КонецЦикла;
			КонецЕсли;
			ОбластьСвойства.Параметры.Свойства = СтрокаСвойства;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьСвойства,
				"СтрокаСвойства", НомерСтроки);
		КонецЕсли;
		Если ДанныеПечати.Шапка.ЕстьКартинки Тогда
			СтрокаКартинок = "";
			Если Строка.Картинки <> Неопределено Тогда
				Для Каждого Картинка Из Строка.Картинки Цикл
					СтрокаКартинок = СтрокаКартинок + Картинка + Символы.ПС;
				КонецЦикла;
				СтрокаКартинок = Сред(СтрокаКартинок, 1, СтрДлина(СтрокаКартинок) - 1);
			КонецЕсли;
			ОбластьКартинки.Параметры.Картинки = СтрокаКартинок;
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьКартинки,
				"СтрокаКартинки", НомерСтроки);
		КонецЕсли;
		
		Если Не СкрыватьДопДанные Тогда
			ВывестиДопДанныеСтрокиНаПечать(ТаблицаДопДанныхСтрок, СтруктураНаличияДопДанных,
				НомерСтроки, ТабличныйДокумент, ОбластьМакетаДД, "СтрокаДопДанные");
		КонецЕсли;
		
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьПодвал, "ПодвалТаблицы");
	
	Если Не СкрыватьДопДанные Тогда
		ВывестиДопДанныеШапкиНаПечать(ДанныеПечати, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с АКТОМ ВЫПОЛНЕННЫХ РАБОТ

Функция ПолучитьДанныеАктовВыполненныхРаботДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКонтрагенте.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКонтрагенте.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	СведенияОКонтрагенте.Вставить("РасчетныйСчет",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.НомерСчета"));
	СведенияОКонтрагенте.Вставить("КорСчет",            ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.КоррСчет"));
	СведенияОКонтрагенте.Вставить("Банк",               ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Наименование"));
	СведенияОКонтрагенте.Вставить("БИК",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "БанковскийСчетКонтрагента.Банк.Код"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКонтрагенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
	КонецЕсли;
	
	СведенияООрганизации = Новый Структура;
	СведенияООрганизации.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ПолноеНаименование"));
	СведенияООрганизации.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ИНН"));
	СведенияООрганизации.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.КПП"));
	СведенияООрганизации.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ОКПО"));
	СведенияООрганизации.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ЮридическийАдрес_Представление"));
	СведенияООрганизации.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ФактическийАдрес_Представление"));
	СведенияООрганизации.Вставить("РасчетныйСчет",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"БанковскийСчетОрганизации.НомерСчета"));
	СведенияООрганизации.Вставить("КорСчет",            ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"БанковскийСчетОрганизации.Банк.КоррСчет"));
	СведенияООрганизации.Вставить("Банк",               ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"БанковскийСчетОрганизации.Банк.Наименование"));
	СведенияООрганизации.Вставить("БИК",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"БанковскийСчетОрганизации.Банк.Код"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияООрганизации);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("Номер", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Номер"));
	ДанныеЗаполненияШапки.Вставить("Дата", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Дата"));
	ДанныеЗаполненияШапки.Вставить("Курс", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Курс"));
	ДанныеЗаполненияШапки.Вставить("КодВалюты", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Код"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеВалюты",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Наименование"));
	ДанныеЗаполненияШапки.Вставить("ТекстШапки", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Заголовок"));
	ДанныеЗаполненияШапки.Вставить("ОписаниеВыполненныхРабот", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ОписаниеВыполненныхРабот"));
	ДанныеЗаполненияШапки.Вставить("Претензии", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Претензии"));
	ДанныеЗаполненияШапки.Вставить("ИтогиПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИтогиПрописью"));
	ДанныеЗаполненияШапки.Вставить("ЦенаВключаетНДС", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ЦенаВключаетНДС"));
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("ТоварКод");
	ТЗ.Колонки.Добавить("ТоварНаименование");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаНаименование");
	ТЗ.Колонки.Добавить("БазоваяЕдиницаКодПоОКЕИ");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("Цена");
	ТЗ.Колонки.Добавить("Сумма");
	ТЗ.Колонки.Добавить("СуммаНДС");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("СуммаСкидки");
	ТЗ.Колонки.Добавить("Содержание");
	ТЗ.Колонки.Добавить("СуммаСНДС");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.ТоварКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"НоменклатураПоставщика.Код");
		НоваяСтрока.ТоварНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"НоменклатураПоставщика.Наименование");
		НоваяСтрока.Содержание = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Содержание");
		НоваяСтрока.БазоваяЕдиницаНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.ЕдиницаИзмерения.Наименование");
		НоваяСтрока.БазоваяЕдиницаКодПоОКЕИ = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.ЕдиницаИзмерения.Код");
		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Количество");
		НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДС");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСНДС");
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтавкаНДС");
		НоваяСтрока.СуммаСкидки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСкидки");
		НоваяСтрока.СуммаСкидки = ?(НоваяСтрока.СуммаСкидки = Неопределено, 0, НоваяСтрока.СуммаСкидки);
		
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ Акт выполненных работ.
//
Процедура ЗаполнитьТабличныйДокументАктВыполненныхРабот_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	КолонкаКодов = ""; 
	ОбменСКонтрагентамиПереопределяемый.ИмяДополнительнойКолонки(КолонкаКодов);
	
	ВыводитьКоды = ЗначениеЗаполнено(КолонкаКодов);
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_АктВыполненныхРабот_Акт";
	
	ТаблицаУслуг = ДанныеПечати.Товары;
	ЕстьСкидки = Ложь; 
	ОбменСКонтрагентамиПереопределяемый.НужноВыводитьСкидки(ТаблицаУслуг, Истина, ЕстьСкидки);
	Если ТаблицаУслуг.Итог("СуммаНДС") > 0 Тогда
		ЕстьНДС = истина;
	Иначе	
		ЕстьНДС = Ложь;
	КонецЕсли;
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_Акт_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	// Выводим шапку акта
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	
	ТекстЗаголовка = НСтр("ru='Акт № %НомерДокумента% от %ДатаДокумента% г.'");
	ТекстЗаголовка = СтрЗаменить(ТекстЗаголовка, "%НомерДокумента%", ДанныеПечати.Шапка.Номер);
	ТекстЗаголовка = СтрЗаменить(ТекстЗаголовка, "%ДатаДокумента%",  Формат(ДанныеПечати.Шапка.Дата, "ДЛФ=DD"));
	
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Заголовок");
	
	ОбластьМакета  = Макет.ПолучитьОбласть("ТекстШапки");
	ОбластьМакета.Параметры.ТекстШапки = ДанныеПечати.Шапка.ТекстШапки;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ТекстШапки");
	
	// Выводим заголовок таблицы Услуги
	СуффиксОбласти = ?(ЕстьСкидки, "СоСкидкой", "") + ?(ЕстьНДС, "СНДС", "");
	ОбластьМакета = Макет.ПолучитьОбласть("ШапкаТаблицы" + СуффиксОбласти);
	ОбластьСтроки = Макет.ПолучитьОбласть("Строка" + СуффиксОбласти);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ШапкаТаблицы");
	
	Сумма       = 0;
	СуммаНДС    = 0;
	НомерСтроки = 0;
	
	// Выводим строки таблицы Услуги
	Для Каждого СтрокаУслуги Из ТаблицаУслуг Цикл
		
		НомерСтроки = НомерСтроки + 1;
		ОбластьСтроки.Параметры.НомерСтроки = НомерСтроки;
		
		ОбластьСтроки.Параметры.Заполнить(СтрокаУслуги);
		ОбластьСтроки.Параметры.ЕдиницаИзмерения = СтрокаУслуги.БазоваяЕдиницаНаименование;
		
		Если ЗначениеЗаполнено(СтрокаУслуги.Содержание) Тогда
			ОбластьСтроки.Параметры.Товар = СтрокаУслуги.Содержание;
		Иначе
			ОбластьСтроки.Параметры.Товар = СтрокаУслуги.ТоварНаименование;
		КонецЕсли;
		
		Если ДанныеПечати.Шапка.ЦенаВключаетНДС Тогда
			СуммаПоСтроке = СтрокаУслуги.Сумма + СтрокаУслуги.СуммаНДС;
		Иначе
			СуммаПоСтроке = СтрокаУслуги.Сумма;
		КонецЕсли;
		
		ОбластьСтроки.Параметры.Сумма = СуммаПоСтроке;
		
		Если ЕстьСкидки Тогда
			
			ОбластьСтроки.Параметры.Скидка         = СтрокаУслуги.СуммаСкидки;
			ОбластьСтроки.Параметры.СуммаБезСкидки = ФорматСумм(СуммаПоСтроке + СтрокаУслуги.СуммаСкидки);
			
		КонецЕсли;
		
		Сумма    = Сумма    + СуммаПоСтроке;
		СуммаНДС = СуммаНДС + СтрокаУслуги.СуммаНДС;
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьСтроки, "СтрокаОсновныеДанные", НомерСтроки);
		
	КонецЦикла;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Итого");
	ОбменСКонтрагентамиПереопределяемый.ФорматСумм(Сумма, ОбластьМакета.Параметры.Всего);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Итого");
	
	ОбластьМакета = Макет.ПолучитьОбласть("ИтогоНДС");
	ОбластьМакета.Параметры.ВсегоНДС = СуммаНДС;
	Если ЕстьНДС Тогда
		Если ДанныеПечати.Шапка.ЦенаВключаетНДС Тогда
			ОбластьМакета.Параметры.НДС = НСтр("ru = 'В том числе НДС:'");
		Иначе
			ОбластьМакета.Параметры.НДС = НСтр("ru = 'Сумма НДС'");
		КонецЕсли;
	Иначе
		ОбластьМакета.Параметры.НДС = НСтр("ru='Без налога (НДС)'");
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ИтогоНДС");
	
	ОбластьМакета = Макет.ПолучитьОбласть("СуммаПрописью");
	ОбластьМакета.Параметры.ИтоговаяСтрока = ДанныеПечати.Шапка.ИтогиПрописью;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "СуммаПрописью");
	
	ОбластьМакета = Макет.ПолучитьОбласть("ДополнительнаяИнформация");
	ОбластьМакета.Параметры.ДополнительнаяИнформация = ДанныеПечати.Шапка.ОписаниеВыполненныхРабот;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ДополнительнаяИнформация");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Претензии                = ДанныеПечати.Шапка.Претензии;
	ОбластьМакета.Параметры.ПредставлениеИсполнителя = ДанныеПечати.Шапка.СведенияОПоставщике.ПолноеНаименование;
	ОбластьМакета.Параметры.ЮрАдресИсполнителя       = ДанныеПечати.Шапка.СведенияОПоставщике.ЮридическийАдрес;
	ОбластьМакета.Параметры.ИННИсполнителя           = ДанныеПечати.Шапка.СведенияОПоставщике.ИНН;
	Если ЗначениеЗаполнено(ДанныеПечати.Шапка.СведенияОПоставщике.КПП) Тогда
		ОбластьМакета.Параметры.КППИсполнителя       = "КПП:  " + ДанныеПечати.Шапка.СведенияОПоставщике.КПП;
	КонецЕсли;
	ОбластьМакета.Параметры.РасчетныйСчетИсполнителя = ДанныеПечати.Шапка.СведенияОПоставщике.РасчетныйСчет;
	ОбластьМакета.Параметры.КорСчетИсполнителя       = ДанныеПечати.Шапка.СведенияОПоставщике.КорСчет;
	ОбластьМакета.Параметры.БанкИсполнителя          = ДанныеПечати.Шапка.СведенияОПоставщике.Банк;
	ОбластьМакета.Параметры.БИКИсполнителя           = ДанныеПечати.Шапка.СведенияОПоставщике.БИК;
	ОбластьМакета.Параметры.ПредставлениеЗаказчика   = ДанныеПечати.Шапка.СведенияОПокупателе.ПолноеНаименование;
	ОбластьМакета.Параметры.ЮрАдресЗаказчика         = ДанныеПечати.Шапка.СведенияОПокупателе.ЮридическийАдрес;
	ОбластьМакета.Параметры.ИННЗаказчика             = ДанныеПечати.Шапка.СведенияОПокупателе.ИНН;
	Если ЗначениеЗаполнено(ДанныеПечати.Шапка.СведенияОПокупателе.КПП) Тогда
		ОбластьМакета.Параметры.КППЗаказчика         = "КПП:  " + ДанныеПечати.Шапка.СведенияОПокупателе.КПП;
	КонецЕсли;
	ОбластьМакета.Параметры.РасчетныйСчетЗаказчика   = ДанныеПечати.Шапка.СведенияОПокупателе.РасчетныйСчет;
	ОбластьМакета.Параметры.КорСчетЗаказчика         = ДанныеПечати.Шапка.СведенияОПокупателе.КорСчет;
	ОбластьМакета.Параметры.БанкЗаказчика            = ДанныеПечати.Шапка.СведенияОПокупателе.Банк;
	ОбластьМакета.Параметры.БИКЗаказчика             = ДанныеПечати.Шапка.СведенияОПокупателе.БИК;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подписи");
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
КонецПроцедуры

Функция ПолучитьДанныеАкта501ДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКонтрагенте = Новый Структура;
	СведенияОКонтрагенте.Вставить("ПолноеНаименование", 
								  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКонтрагенте.Вставить("КПП",
								  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКонтрагенте.Вставить("ИНН",
								  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ИНН"));
	ЮридическийАдрес = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"Контрагент.ЮридическийАдрес_Представление");
	СведенияОКонтрагенте.Вставить("ЮридическийАдрес", ЮридическийАдрес);
	
	СведенияОКонтрагенте.Вставить("РасчетныйСчет", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"БанковскийСчетКонтрагента.НомерСчета"));
																	
	СведенияОКонтрагенте.Вставить("БИК", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"БанковскийСчетКонтрагента.Банк.Код"));
																	
	СведенияОКонтрагенте.Вставить("Банк", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"БанковскийСчетКонтрагента.Банк.Наименование"));

	// Заполнение Заказчика из доп. данных
	ЗаказчикНомерСчета = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ЗаказчикНомерСчета");
	ЗаказчикБИК = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ЗаказчикБИК");
	ЗаказчикБанк = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ЗаказчикНаимБанк");
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		Если ЗначениеЗаполнено(ЗаказчикНомерСчета) Тогда
			СведенияОКонтрагенте.Вставить("РасчетныйСчет", ЗаказчикНомерСчета);
			СведенияОКонтрагенте.Вставить("БИК", ЗаказчикБИК);
			СведенияОКонтрагенте.Вставить("Банк", ЗаказчикБанк);
		КонецЕсли; 
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКонтрагенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКонтрагенте);
	КонецЕсли;
	
	СведенияООрганизации = Новый Структура;
	ПолноеНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	  СтрокаОбъекта,
																	  "Организация.ПолноеНаименование");
	СведенияООрганизации.Вставить("ПолноеНаименование", ПолноеНаименование);
	СведенияООрганизации.Вставить("ИНН",
								  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.ИНН"));
	СведенияООрганизации.Вставить("КПП",
								  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Организация.КПП"));
	ЮридическийАдрес = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"Организация.ЮридическийАдрес_Представление");
	СведенияООрганизации.Вставить("ЮридическийАдрес", ЮридическийАдрес);
	
	СведенияООрганизации.Вставить("РасчетныйСчет", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"БанковскийСчетОрганизации.НомерСчета"));
																	
	СведенияООрганизации.Вставить("БИК", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"БанковскийСчетОрганизации.Банк.Код"));
																	
	СведенияООрганизации.Вставить("Банк", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																	СтрокаОбъекта,
																	"БанковскийСчетОрганизации.Банк.Наименование"));

	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияООрганизации);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		Если ЗначениеЗаполнено(ЗаказчикНомерСчета) Тогда
			СведенияООрганизации.Вставить("РасчетныйСчет", ЗаказчикНомерСчета);
			СведенияООрганизации.Вставить("БИК", ЗаказчикБИК);
			СведенияООрганизации.Вставить("Банк", ЗаказчикБанк);
		КонецЕсли;
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияООрганизации);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("Номер",
								   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Номер"));
	ДанныеЗаполненияШапки.Вставить("Дата",
								   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Дата"));
	ДанныеЗаполненияШапки.Вставить("ТекстШапки",
								   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Заголовок"));
	ДанныеЗаполненияШапки.Вставить("Претензии",
									ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Претензии"));
	ДанныеЗаполненияШапки.Вставить("ДатаИсполнения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДатаИсполнения"));
	ДанныеЗаполненияШапки.Вставить("СдалДолжность", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СдалДолжность"));
	ДанныеЗаполненияШапки.Вставить("СдалФИО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СдалФИО"));

	ДатаИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаИсправления");
	Если ЗначениеЗаполнено(ДатаИсправления) Тогда
		ДанныеЗаполненияШапки.Вставить("ДатаИсправления", Дата(ДатаИсправления));
		ДанныеЗаполненияШапки.Вставить("НомерИсправления", 
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "НомерИсправления"));
	КонецЕсли;
	
	ТЗОписанийРабот = Новый ТаблицаЗначений;
	ТЗОписанийРабот.Колонки.Добавить("НачалоРабот");
	ТЗОписанийРабот.Колонки.Добавить("КонецРабот");
	ТЗОписанийРабот.Колонки.Добавить("Сумма");
	ТЗОписанийРабот.Колонки.Добавить("СуммаНДС");
	ТЗОписанийРабот.Колонки.Добавить("СуммаСНДС");
	ТЗОписанийРабот.Колонки.Добавить("Работы");
	
	СтрокиТЧОписанийРабот = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СписокОписаний"));
	Для Каждого СтрокаТЧОписанийРабот Из СтрокиТЧОписанийРабот Цикл
		
		НоваяСтрокаОписанийРабот = ТЗОписанийРабот.Добавить();
		ОписаниеРабот = СтрокаТЧОписанийРабот.ЗначениеРеквизита;
		
		НоваяСтрокаОписанийРабот.НачалоРабот = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																							ОписаниеРабот,
																							"НачРабот");
		НоваяСтрокаОписанийРабот.КонецРабот = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																						   ОписаниеРабот,
																						   "КонРабот");
		НоваяСтрокаОписанийРабот.Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																						  ОписаниеРабот,
																						  "Сумма");
		НоваяСтрокаОписанийРабот.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
																						 ОписаниеРабот,
																						 "СуммаНДС");
		НоваяСтрокаОписанийРабот.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, ОписаниеРабот, "СуммаСНДС");
		
		ТЗРабот = Новый ТаблицаЗначений;
		ТЗРабот.Колонки.Добавить("НомерСтроки");
		ТЗРабот.Колонки.Добавить("НаименованиеРабот");
		ТЗРабот.Колонки.Добавить("ЕдиницаИзмерения");
		ТЗРабот.Колонки.Добавить("Количество");
		ТЗРабот.Колонки.Добавить("Цена");
		ТЗРабот.Колонки.Добавить("Сумма");
		ТЗРабот.Колонки.Добавить("СуммаНДС");
		ТЗРабот.Колонки.Добавить("СуммаСНДС");
		ТЗРабот.Колонки.Добавить("Описание");
		
		СтрокиТЧРабот = ОписаниеРабот.Строки.НайтиСтроки(Новый Структура("Реквизит", "Работа"));
		Для Каждого СтрокаТЧРабот Из СтрокиТЧРабот Цикл
			
			НоваяСтрока = ТЗРабот.Добавить();
			НоваяСтрока.НомерСтроки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот,
			"Номер");
			НоваяСтрока.НаименованиеРабот = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот,
			"Номенклатура.Наименование");
			НоваяСтрока.Описание = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот, "Описание");
			НоваяСтрока.ЕдиницаИзмерения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот,
			"ЕдиницаИзмеренияНаименование");
			НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот, "Количество");
			НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот, "Цена");
			НоваяСтрока.Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот, "Сумма");
			НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот, "СуммаНДС");
			НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧРабот, "СуммаСНДС");
			
		КонецЦикла;
		
		НоваяСтрокаОписанийРабот.Работы = ТЗРабот;
	КонецЦикла;
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("ОписанияРабот", ТЗОписанийРабот);
	
	СтрокаДереваДопДанных = ДеревоРазбора.Строки.Найти("ДеревоДопДанных", "Реквизит", Истина);
	Если СтрокаДереваДопДанных <> Неопределено И ТипЗнч(СтрокаДереваДопДанных.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДереваДопДанных.ЗначениеРеквизита;
		ДанныеДляОбъекта.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ Акт выполненных работ.
//
Процедура ЗаполнитьТабличныйДокументАкт501(ТабличныйДокумент, ДанныеПечати, ДанныеЗаказчика, ПараметрыПечати)
	
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	ТабличныйДокумент.ПолеСлева = 5;
	ТабличныйДокумент.ПолеСправа = 5;
	ТабличныйДокумент.РазмерКолонтитулаСверху = 0;
	ТабличныйДокумент.РазмерКолонтитулаСнизу = 0;
	ТабличныйДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	
	ДеревоДопДанных = Неопределено;
	Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = Неопределено;
	КонецЕсли;

	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_АктВыполненныхРабот_Акт";
	
	ТаблицаОписанийРабот = ДанныеПечати.ОписанияРабот;
	Если ТаблицаОписанийРабот.Итог("СуммаНДС") > 0 Тогда
		ЕстьНДС = Истина;
	Иначе
		ЕстьНДС = Ложь;
	КонецЕсли;
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_Акт501_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	// Выводим шапку акта
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	
	ШаблонЗаголовка = НСтр("ru='Акт № %1 от %2'");
	ТекстЗаголовка = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонЗаголовка, ДанныеПечати.Шапка.Номер,
		Формат(ДанныеПечати.Шапка.Дата, "ДЛФ=DD"));
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	
	Если ДанныеПечати.Шапка.Свойство("ДатаИсправления") Тогда
		
		ШаблонЗаголовка = НСтр("ru='Исправление № %1 от %2'");
		ТекстИсправления = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонЗаголовка, ДанныеПечати.Шапка.НомерИсправления,
																		Формат(ДанныеПечати.Шапка.ДатаИсправления, "ДЛФ=DD"));
		ОбластьМакета.Параметры.Исправление = ТекстИсправления;

	КонецЕсли;
	ОбластьМакета.Параметры.ТекстШапки = ДанныеПечати.Шапка.ТекстШапки;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
	Если Не СкрыватьДопДанные Тогда
		ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
		ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Услуги", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицыОписаниеРабот|ДопДанныеТаблицы");
			ОбластьМакетаДД = Макет.ПолучитьОбласть("СтрокаРабот|ДопДанныеТаблицы");
			ОбластьЗаголовокТаблицыДДСЭП = Макет.ПолучитьОбласть("ШапкаТаблицыОписаниеРабот|ДопДанныеТаблицыСЭЦП");
			ОбластьМакетаДДСЭП = Макет.ПолучитьОбласть("СтрокаРабот|ДопДанныеТаблицыСЭЦП");
			ОбластьЗаголовокТаблицыДДБезЭП = Макет.ПолучитьОбласть("ШапкаТаблицыОписаниеРабот|ДопДанныеТаблицыБезЭЦП");
			ОбластьМакетаДДБезЭП = Макет.ПолучитьОбласть("СтрокаРабот|ДопДанныеТаблицыБезЭЦП");
		КонецЕсли;
	КонецЕсли;
	
	// Выводим заголовок таблицы Услуги
	ОбластьМакета = Макет.ПолучитьОбласть("ШапкаТаблицыОписаниеРабот|ОсновныеДанныеТаблицы");
	
	НомерОписания = 0;
	Для Каждого СтрокаОписанийРабот Из ТаблицаОписанийРабот Цикл
		
		НомерОписания = НомерОписания + 1;
		ОбластьМакета.Параметры.Заполнить(СтрокаОписанийРабот);
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
			"ШапкаТаблицыОписаниеРабот", НомерОписания);
		
		Если Не СкрыватьДопДанные Тогда
			Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
					"ШапкаТаблицыДопДанные", НомерОписания);
			Иначе
				Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДСЭП,
						"ШапкаТаблицыДопДанныеСЭП", НомерОписания);
				КонецЕсли;
				Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
					ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДДБезЭП,
						"ШапкаТаблицыДопДанныеБезЭП", НомерОписания);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Выводим строки таблицы Услуги
		ОбластьСтрокиРабот = Макет.ПолучитьОбласть("СтрокаРабот|ОсновныеДанныеТаблицы");
		Для Каждого СтрокаРаботы Из СтрокаОписанийРабот.Работы Цикл
			
			ОбластьСтрокиРабот.Параметры.НомерСтроки = СтрокаРаботы.НомерСтроки;
			
			ОбластьСтрокиРабот.Параметры.Заполнить(СтрокаРаботы);
			
			Если СтрокаРаботы.Цена <> Неопределено И СтрокаРаботы.Цена = Окр(СтрокаРаботы.Цена, 2) Тогда
				ОбластьСтрокиРабот.Параметры.Цена = Формат(СтрокаРаботы.Цена, "ЧДЦ=2");
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СтрокаРаботы.Описание) Тогда
				ОбластьСтрокиРабот.Параметры.НаимРабот = СтрокаРаботы.Описание;
			Иначе
				ОбластьСтрокиРабот.Параметры.НаимРабот = СтрокаРаботы.НаименованиеРабот;
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьСтрокиРабот,
				"СтрокаРаботОсновныеДанные", СтрокаРаботы.НомерСтроки);
			
			Если Не СкрыватьДопДанные Тогда
				Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
					СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(НомерОписания) + "." + СтрокаРаботы.НомерСтроки, "НомерСтр");
					Если СтрокаТаблицыДД <> Неопределено Тогда
						Если СтруктураНаличияДопДанных.ЕстьПодписанные И СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
							ОбластьМакетаДД.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
							ОбластьМакетаДД.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
							ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДД,
								"СтрокаРаботДопДанные", СтрокаРаботы.НомерСтроки);
						Иначе
							Если СтруктураНаличияДопДанных.ЕстьПодписанные Тогда
								ОбластьМакетаДДСЭП.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
								ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДСЭП,
									"СтрокаРаботДопДанныеСЭП", СтрокаРаботы.НомерСтроки);
							КонецЕсли;
							Если СтруктураНаличияДопДанных.ЕстьНеПодписанные Тогда
								ОбластьМакетаДДБезЭП.Параметры.НеПодписанные = СтрокаТаблицыДД.НеПодписанныеДанные;
								ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакетаДДБезЭП,
									"СтрокаРаботДопДанныеБезЭП", СтрокаРаботы.НомерСтроки);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		ОбластьМакета = Макет.ПолучитьОбласть("Итого");
		Если СтрокаОписанийРабот.СуммаСНДС <> Неопределено Тогда
			ОбменСКонтрагентамиПереопределяемый.ФорматСумм(СтрокаОписанийРабот.СуммаСНДС, ОбластьМакета.Параметры.Всего);
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Итого",
			НомерОписания);
		
		ОбластьМакета = Макет.ПолучитьОбласть("ИтогоНДС");
		Если ЕстьНДС Тогда
			ОбластьМакета.Параметры.НДС = НСтр("ru = 'Сумма НДС'");
			ОбластьМакета.Параметры.ВсегоНДС = СтрокаОписанийРабот.СуммаНДС;
		Иначе
			ОбластьМакета.Параметры.НДС = НСтр("ru='Без налога (НДС)'");
		КонецЕсли;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ИтогоНДС",
			НомерОписания);
			
	КонецЦикла;
	
	ПредставлениеОснования = ?(ДанныеПечати.Шапка.Свойство("ПредставлениеОснования"),
		ДанныеПечати.Шапка.ПредставлениеОснования, Неопределено);
	Если ЗначениеЗаполнено(ПредставлениеОснования) И ПредставлениеОснования <> "-" Тогда
		ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
		ОбластьМакета.Параметры.Заполнить(ДанныеПечати.Шапка);
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подвал");
	КонецЕсли;
	
	Претензии = ?(ДанныеЗаказчика.Свойство("Претензии"), ДанныеЗаказчика.Претензии, Неопределено);
	Если ЗначениеЗаполнено(Претензии) Тогда
		ОбластьМакета = Макет.ПолучитьОбласть("Претензии");
		ОбластьМакета.Параметры.Претензии = Претензии;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Претензии");
	КонецЕсли;
	
	ВремТабДок = Новый ТабличныйДокумент;
	
	ОбластьМакетаИсполнитель = Макет.ПолучитьОбласть("Подписи|Исполнитель");
	ОбластьМакетаИсполнитель.Параметры.Заполнить(ДанныеПечати.Шапка);
	
	ОбластьМакетаИсполнитель.Параметры.ПредставлениеИсполнителя = ДанныеПечати.Шапка.СведенияОПоставщике.ПолноеНаименование;
	ОбластьМакетаИсполнитель.Параметры.ЮрАдресИсполнителя       = ДанныеПечати.Шапка.СведенияОПоставщике.ЮридическийАдрес;
	ОбластьМакетаИсполнитель.Параметры.ИННИсполнителя           = ДанныеПечати.Шапка.СведенияОПоставщике.ИНН;
	Если ЗначениеЗаполнено(ДанныеПечати.Шапка.СведенияОПоставщике.КПП) Тогда
		ОбластьМакетаИсполнитель.Параметры.КППИсполнителя       = ДанныеПечати.Шапка.СведенияОПоставщике.КПП;
	КонецЕсли;
	
	ОбластьМакетаИсполнитель.Параметры.РасчетныйСчетИсполнителя = ДанныеПечати.Шапка.СведенияОПоставщике.РасчетныйСчет;
	ОбластьМакетаИсполнитель.Параметры.БанкИсполнителя          = ДанныеПечати.Шапка.СведенияОПоставщике.Банк;
	ОбластьМакетаИсполнитель.Параметры.БИКИсполнителя           = ДанныеПечати.Шапка.СведенияОПоставщике.БИК;

	
	ДатаИсполнения = ДанныеПечати.Шапка.ДатаИсполнения;
	Если Не ЗначениеЗаполнено(ДатаИсполнения) Тогда
		ДатаИсполнения = ДанныеПечати.Шапка.Дата;
	КонецЕсли;
	ПолнаяДатаДокумента = Формат(ДатаИсполнения, "ДЛФ=DD");
	ДлинаСтроки = СтрДлина(ПолнаяДатаДокумента);
	ПервыйРазделитель = СтрНайти(ПолнаяДатаДокумента, " ");
	ВторойРазделитель = СтрНайти(Прав(ПолнаяДатаДокумента, ДлинаСтроки - ПервыйРазделитель), " ") + ПервыйРазделитель;
	ОбластьМакетаИсполнитель.Параметры.ДатаДокументаДень = """" + Лев(ПолнаяДатаДокумента, ПервыйРазделитель -1 ) + """";
	ОбластьМакетаИсполнитель.Параметры.ДатаДокументаМесяц = Сред(ПолнаяДатаДокумента, ПервыйРазделитель + 1, ВторойРазделитель - ПервыйРазделитель - 1);
	ОбластьМакетаИсполнитель.Параметры.ДатаДокументаГод = Прав(ПолнаяДатаДокумента, ДлинаСтроки - ВторойРазделитель);
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ВремТабДок, ОбластьМакетаИсполнитель, "ПодписиИсполнитель");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи|Заказчик");
	ОбластьМакета.Параметры.Заполнить(ДанныеЗаказчика);
	
	ДатаПолучения = Неопределено;
	Если ДанныеЗаказчика.Свойство("ДатаПолучения", ДатаПолучения) И ЗначениеЗаполнено(ДатаПолучения) Тогда
		ПолнаяДатаПолучения = Формат(ДатаПолучения, "ДЛФ=DD");
		ДлинаСтроки = СтрДлина(ПолнаяДатаПолучения);
		ПервыйРазделитель = СтрНайти(ПолнаяДатаПолучения, " ");
		ВторойРазделитель = СтрНайти(Прав(ПолнаяДатаПолучения, ДлинаСтроки - ПервыйРазделитель), " ") + ПервыйРазделитель;
		ОбластьМакета.Параметры.ДатаПолученияДень = """" + Лев(ПолнаяДатаПолучения, ПервыйРазделитель -1 ) + """";
		ОбластьМакета.Параметры.ДатаПолученияМесяц = Сред(ПолнаяДатаПолучения, ПервыйРазделитель + 1, ВторойРазделитель - ПервыйРазделитель - 1);
		ОбластьМакета.Параметры.ДатаПолученияГод = Прав(ПолнаяДатаПолучения, ДлинаСтроки - ВторойРазделитель);
	КонецЕсли;
	
	ОбластьМакета.Параметры.ПредставлениеЗаказчика   = ДанныеПечати.Шапка.СведенияОПокупателе.ПолноеНаименование;
	ОбластьМакета.Параметры.ИННЗаказчика             = ДанныеПечати.Шапка.СведенияОПокупателе.ИНН;
	Если ЗначениеЗаполнено(ДанныеПечати.Шапка.СведенияОПокупателе.КПП) Тогда
		ОбластьМакета.Параметры.КППЗаказчика         = ДанныеПечати.Шапка.СведенияОПокупателе.КПП;
	КонецЕсли;
	
	ОбластьМакета.Параметры.РасчетныйСчетЗаказчика = ДанныеПечати.Шапка.СведенияОПокупателе.РасчетныйСчет;
	ОбластьМакета.Параметры.БанкЗаказчика          = ДанныеПечати.Шапка.СведенияОПокупателе.Банк;
	ОбластьМакета.Параметры.БИКЗаказчика           = ДанныеПечати.Шапка.СведенияОПокупателе.БИК;
	ОбластьМакета.Параметры.ЮрАдресЗаказчика       = ДанныеПечати.Шапка.СведенияОПокупателе.ЮридическийАдрес;
	
	ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ВремТабДок, ОбластьМакета, "ПодписиЗаказчик");
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ВремТабДок, "");
		
	Если Не СкрыватьДопДанные Тогда
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
КонецПроцедуры

// Процедура заполняет данные, выводимые на печать
Функция ДанныеАктаЗаказчика(СтрокаОбъекта, ДеревоРазбора)
	
	СвойстваТитула = Новый Структура;
	
	ДатаПолучения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ДатаПолучения");
	СвойстваТитула.Вставить("ДатаПолучения", ДатаПолучения);
	
	ПринялДолжность = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ПринялДолжность");
	СвойстваТитула.Вставить("ПринялДолжность", ПринялДолжность);
	
	ПринялФИО = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ПринялФИО");
	СвойстваТитула.Вставить("ПринялФИО", ПринялФИО);
	
	Возврат СвойстваТитула;
	
КонецФункции

Процедура ЗаполнитьТабличныйДокумент_АктЗаказчик(ТабличныйДокумент, ДанныеПокупателя)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_АктЗаказчик_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Заполнить(ДанныеПокупателя);
	Если ДанныеПокупателя.Свойство("ДатаДокументаОтправителя") Тогда
		ОбластьМакета.Параметры.ДатаДокументаОтправителя = Формат(ДанныеПокупателя.ДатаДокументаОтправителя, "ДЛФ=DD");
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подписи");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Передача результатов работ

Функция ДанныеДляПечатиПередачаРезультатовРабот(СтрокаОбъекта, ДеревоРазбора)
	
	ДеревоЭД = СтрокаОбъекта.ЗначениеРеквизита;
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	ДанныеЗаполненияШапки.Вставить("Номер", ЗначениеРеквизитаДерева(ДеревоЭД, "НомерАкта"));
	ДанныеЗаполненияШапки.Вставить("Дата", ЗначениеРеквизитаДерева(ДеревоЭД, "ДатаАкта"));
	
	ДанныеЗаполненияШапки.Вставить("ТекстШапки", ЗначениеРеквизитаДерева(ДеревоЭД, "Заголовок"));
	ДанныеЗаполненияШапки.Вставить("Претензии", ЗначениеРеквизитаДерева(ДеревоЭД, "Претензии"));
	ДанныеЗаполненияШапки.Вставить("ПредставлениеОснования", ПредставлениеОснования(ДеревоЭД, "Основание"));
	ДанныеЗаполненияШапки.Вставить("ДатаИсполнения", ЗначениеРеквизитаДерева(ДеревоЭД, "ДатаИсполнения"));
	
	ДанныеЗаполненияШапки.Вставить("СдалДолжность", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СдалДолжность"));
	ДанныеЗаполненияШапки.Вставить("СдалФИО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СдалФИО"));

	
	// Данные Исполнителя
	ДанныеИсполнителя = ДанныеУчастникаСделки(ДеревоЭД, "Исполнитель");
	СведенияОбИсполнителе = Новый Структура;
	СведенияОбИсполнителе.Вставить("ПолноеНаименование", ДанныеИсполнителя.Представление);
	СведенияОбИсполнителе.Вставить("КПП", ДанныеИсполнителя.КПП);
	СведенияОбИсполнителе.Вставить("ИНН", ДанныеИсполнителя.ИНН);
	СведенияОбИсполнителе.Вставить("ЮридическийАдрес", ДанныеИсполнителя.Адрес);
	
	РасчетныйСчет = Неопределено;
	Если ДанныеИсполнителя.Свойство("БанковскийСчет", РасчетныйСчет) Тогда
		СведенияОбИсполнителе.Вставить("РасчетныйСчет", РасчетныйСчет.НомерСчета);
		СведенияОбИсполнителе.Вставить("БИК", РасчетныйСчет.БИК);
		СведенияОбИсполнителе.Вставить("Банк", РасчетныйСчет.НаименованиеБанка);
	КонецЕсли;
	
	// Данные Заказчика
	ДанныеЗаказчика = ДанныеУчастникаСделки(ДеревоЭД, "Заказчик");
	СведенияОЗаказчике = Новый Структура;
	СведенияОЗаказчике.Вставить("ПолноеНаименование", ДанныеЗаказчика.Представление);
	СведенияОЗаказчике.Вставить("КПП", ДанныеЗаказчика.КПП);
	СведенияОЗаказчике.Вставить("ИНН", ДанныеЗаказчика.ИНН);
	СведенияОЗаказчике.Вставить("ЮридическийАдрес", ДанныеЗаказчика.Адрес);
	
	РасчетныйСчет = Неопределено;
	Если ДанныеЗаказчика.Свойство("БанковскийСчет", РасчетныйСчет) Тогда
		СведенияОЗаказчике.Вставить("РасчетныйСчет", РасчетныйСчет.НомерСчета);
		СведенияОЗаказчике.Вставить("БИК", РасчетныйСчет.БИК);
		СведенияОЗаказчике.Вставить("Банк", РасчетныйСчет.НаименованиеБанка);
	КонецЕсли;
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОбИсполнителе);
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОЗаказчике);
		
	Иначе
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОбИсполнителе);
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОЗаказчике);
		
	КонецЕсли;
	
	ДатаИсправления = ЗначениеРеквизитаДерева(ДеревоЭД, "ДатаИсправления");
	Если ЗначениеЗаполнено(ДатаИсправления) Тогда
		ДанныеЗаполненияШапки.Вставить("ДатаИсправления", Дата(ДатаИсправления));
		ДанныеЗаполненияШапки.Вставить("НомерИсправления", ЗначениеРеквизитаДерева(ДеревоЭД, "НомерИсправления"));
	КонецЕсли;
	
	Работы = Новый ТаблицаЗначений;
	Работы.Колонки.Добавить("НомерСтроки");
	Работы.Колонки.Добавить("НаименованиеРабот");
	Работы.Колонки.Добавить("Описание");
	Работы.Колонки.Добавить("Количество");
	Работы.Колонки.Добавить("ЕдиницаИзмерения");
	Работы.Колонки.Добавить("Цена");
	Работы.Колонки.Добавить("Сумма");
	Работы.Колонки.Добавить("СуммаНДС");
	Работы.Колонки.Добавить("СуммаСНДС");
	Работы.Колонки.Добавить("Подписанные");

	
	СтрокаТаблицаРабот = ДеревоЭД.Строки.Найти("ТаблицаУслуг", "ПолныйПуть");
	Для Каждого Работа Из СтрокаТаблицаРабот.Строки Цикл
		
		НоваяСтрока = Работы.Добавить();
		
		НоваяСтрока.НомерСтроки = Работа.Значение;
		
		НоваяСтрока.НаименованиеРабот = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.НаименованиеНоменклатуры");
		НоваяСтрока.Описание = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.Описание");
		НоваяСтрока.Количество = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.Количество");
		
		НоваяСтрока.ЕдиницаИзмерения = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.ЕдиницаИзмеренияНаименование");
		
		НоваяСтрока.Цена = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.Цена");
		НоваяСтрока.Сумма = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.СуммаБезНДС");
		НоваяСтрока.СуммаНДС = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.СуммаНДС");
		
		НоваяСтрока.СуммаСНДС = ЗначениеРеквизитаДерева(Работа, "ТаблицаУслуг.НомерСтроки.СуммаСНДС");
		
		ПутьКДанным = "ТаблицаУслуг.НомерСтроки.ДопДанныеПодписанные";
		Подписанные = ЗначениеГруппыВДереве(Работа, ПутьКДанным);
		Если Не Подписанные = Неопределено Тогда
			ДопДанныеПодписанные = Новый Структура;
			Для Каждого ТекСтрока Из Подписанные Цикл
				Ключ = ИмяПоляДопДанных(ТекСтрока, ПутьКДанным);
				Значение = ТекСтрока.Значение;
				ДопДанныеПодписанные.Вставить(Ключ, Значение);
				
			КонецЦикла;
		НоваяСтрока.Подписанные = ДопДанныеПодписанные;
		КонецЕсли;
		
	КонецЦикла;
	
	ОписаниеРабот = Новый ТаблицаЗначений;
	ОписаниеРабот.Колонки.Добавить("НачалоРабот");
	ОписаниеРабот.Колонки.Добавить("КонецРабот");
	ОписаниеРабот.Колонки.Добавить("Сумма");
	ОписаниеРабот.Колонки.Добавить("СуммаНДС");
	ОписаниеРабот.Колонки.Добавить("СуммаСНДС");
	ОписаниеРабот.Колонки.Добавить("Работы");
	
	НоваяСтрока = ОписаниеРабот.Добавить();
	НоваяСтрока.Работы = Работы;
	НоваяСтрока.НачалоРабот = ЗначениеРеквизитаДерева(ДеревоЭД, "ОписаниеУслуги.НачалоРабот");
	НоваяСтрока.КонецРабот = ЗначениеРеквизитаДерева(ДеревоЭД, "ОписаниеУслуги.КонецРабот");
	НоваяСтрока.Сумма = ЗначениеРеквизитаДерева(ДеревоЭД, "ОписаниеУслуги.СуммаБезНДСИтого");
	НоваяСтрока.СуммаНДС = ЗначениеРеквизитаДерева(ДеревоЭД, "ОписаниеУслуги.СуммаНДСИтого");
	НоваяСтрока.СуммаСНДС = ЗначениеРеквизитаДерева(ДеревоЭД, "ОписаниеУслуги.СуммаСНДСИтого");
	
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("ОписанияРабот", ОписаниеРабот);
	
	СтрокаДереваДопДанных = ДеревоРазбора.Строки.Найти("ДеревоДопДанных", "Реквизит", Истина);
	Если СтрокаДереваДопДанных <> Неопределено И ТипЗнч(СтрокаДереваДопДанных.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДереваДопДанных.ЗначениеРеквизита;
		ДанныеДляОбъекта.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли;
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Работа с ОТЧЕТОМ О ПРОДАЖАХ КОМИССИОННОГО ТОВАРА

Функция ПолучитьДанныеОтчетаОПродажахКомиссионногоТовараДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКомитенте = Новый Структура;
	СведенияОКомитенте.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ПолноеНаименование"));
	СведенияОКомитенте.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ИНН"));
	СведенияОКомитенте.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.КПП"));
	СведенияОКомитенте.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ОКПО"));
	СведенияОКомитенте.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ЮридическийАдрес_Представление"));
	СведенияОКомитенте.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Организация.ФактическийАдрес_Представление"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКомитенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКомитенте);
	КонецЕсли;
	
	СведенияОКомиссионере = Новый Структура;
	СведенияОКомиссионере.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКомиссионере.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКомиссионере.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКомиссионере.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКомиссионере.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	СведенияОКомиссионере.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКомиссионере);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКомиссионере);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("Номер", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Номер"));
	ДанныеЗаполненияШапки.Вставить("Дата", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Дата"));
	ДанныеЗаполненияШапки.Вставить("Курс", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Курс"));
	ДанныеЗаполненияШапки.Вставить("КодВалюты", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.КодОКВ"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеВалюты", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Наименование"));
	ДанныеЗаполненияШапки.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СуммаДокумента"));
	ДанныеЗаполненияШапки.Вставить("СуммаКомитента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СуммаКомитента"));
	ДанныеЗаполненияШапки.Вставить("ИтогиПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИтогиПрописью"));
	ДанныеЗаполненияШапки.Вставить("СуммаВознаграждения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "СуммаВознаграждения"));
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Код");
	ТЗ.Колонки.Добавить("Артикул");
	ТЗ.Колонки.Добавить("Наименование");
	ТЗ.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("Цена");
	ТЗ.Колонки.Добавить("Сумма");
	ТЗ.Колонки.Добавить("СуммаНДС");
	ТЗ.Колонки.Добавить("СуммаСНДС");
	ТЗ.Колонки.Добавить("СуммаВознаграждения");
	ТЗ.Колонки.Добавить("СуммаПродажи");
	ТЗ.Колонки.Добавить("ЦенаПродажи");
	ТЗ.Колонки.Добавить("СтавкаНДС");
	ТЗ.Колонки.Добавить("ДополнительныеРеквизиты");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.Код             = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Код");
		НоваяСтрока.Артикул         = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.Артикул");
		НоваяСтрока.Наименование    = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.Наименование");
		
		НоваяСтрока.ЕдиницаИзмеренияНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.ЕдиницаИзмерения.Наименование");
		НоваяСтрока.Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Количество");
		
		НоваяСтрока.Цена = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.ЦенаПродажи = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ЦенаПродажи");
		НоваяСтрока.Сумма = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		НоваяСтрока.СуммаПродажи = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаПродажи");
		НоваяСтрока.СуммаВознаграждения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"СуммаВознаграждения");
		НоваяСтрока.СуммаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаНДС");
		НоваяСтрока.СуммаСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СуммаСНДС");
		НоваяСтрока.СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "СтавкаНДС");
		
		СтруктураДополнительныхРеквизитов = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "ДополнительныеРеквизиты");
		Если ЗначениеЗаполнено(СтруктураДополнительныхРеквизитов) Тогда
			ДополнительныеРеквизиты = ""; 
			Для Каждого Элемент Из СтруктураДополнительныхРеквизитов Цикл
				ДополнительныеРеквизиты = ДополнительныеРеквизиты + Элемент.Ключ + ":";
				ЗначенияРеквизита = "";
				Если ТипЗнч(Элемент.Значение) = Тип("Массив") Тогда
					Для Каждого ЭлементМассива Из Элемент.Значение Цикл
						// Для адресов покупателя разберем строку адреса в структуру адреса ФНС
						Если Элемент.Ключ = "ПокупательФактАдрес" ИЛИ Элемент.Ключ = "ПокупательЮрАдрес" Тогда
							ЭлементМассива = СобратьАдрес(ЭлементМассива);
						КонецЕсли;
						ЗначенияРеквизита = ЗначенияРеквизита + Строка(ЭлементМассива) + ", ";
					КонецЦикла;
				Иначе
					ЭлементМассива = Элемент.Значение;
					// Для адресов покупателя разберем строку адреса в структуру адреса ФНС
					Если Элемент.Ключ = "ПокупательФактАдрес" ИЛИ Элемент.Ключ = "ПокупательЮрАдрес" Тогда
						ЭлементМассива = СобратьАдрес(ЭлементМассива);
					КонецЕсли;
					ЗначенияРеквизита = ЗначенияРеквизита + Строка(ЭлементМассива) + ", ";
				КонецЕсли;
				ДополнительныеРеквизиты = ДополнительныеРеквизиты + ЗначенияРеквизита;
			КонецЦикла;
			НоваяСтрока.ДополнительныеРеквизиты = ДополнительныеРеквизиты;
		КонецЕсли;
		
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ отчет о продажах комиссионного товара
//
Процедура ЗаполнитьТабличныйДокументОтчетаОПродажахКомиссионногоТовара_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ОтчетПоКомиссии_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
		
	КолонкаКодов = "";
	ОбменСКонтрагентамиПереопределяемый.ИмяДополнительнойКолонки(КолонкаКодов);
	
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
	// Выводим общие реквизиты шапки.
	ЗаполнитьРеквизитыШапкиОтчетПоКомиссии(ДанныеПечати.Шапка, НСтр("ru = 'Отчет о продажах комиссионного товара'"), Макет,
		ТабличныйДокумент);
	
	// Выводим заголовок таблицы.
	Если ЗначениеЗаполнено(КолонкаКодов) Тогда
		ЗаголовокТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицыСКодами|Данные");
		ЗаголовокТаблицы.Параметры.ИмяКолонкиКодов = КолонкаКодов;
	Иначе
		ЗаголовокТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы|Данные");
	КонецЕсли;
	
	Если Не СкрыватьДопДанные Тогда
		ТаблицаДопДанныхСтрок = ТаблицаДопДанных();
		
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		ЕстьДопДанные = Ложь;
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			ЕстьДопДанные = Истина;
			
			Если ЗначениеЗаполнено(КолонкаКодов) Тогда
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицыСКодами|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаСКодами|ДопДанныеТаблицыСЭЦП");
				
			Иначе
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицы|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ЗаголовокТаблицы.Параметры.Валюта = ДанныеПечати.Шапка.НаименованиеВалюты;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы, "ШапкаТаблицы");
	
	Если Не СкрыватьДопДанные Тогда
		Если ЕстьДопДанные Тогда
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
				"ШапкаТаблицыДопДанные");
		КонецЕсли;
	КонецЕсли;
	
	// Выводим многострочную часть документа.
	Если ЗначениеЗаполнено(КолонкаКодов) Тогда
		ОбластьМакета = Макет.ПолучитьОбласть("СтрокаСКодами|Данные");

	Иначе
		ОбластьМакета = Макет.ПолучитьОбласть("Строка|Данные");

	КонецЕсли;
	
	НомерСтроки = 0;
	Товары = ДанныеПечати.Товары;
	Для Каждого СтрокаТовары Из Товары Цикл
		
		НомерСтроки = НомерСтроки + 1;
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		Если ЗначениеЗаполнено(КолонкаКодов) Тогда
			ОбластьМакета.Параметры.Артикул = СтрокаТовары[КолонкаКодов];
		КонецЕсли;
		
		ОбластьМакета.Параметры.НомерСтроки = НомерСтроки;
		ОбластьМакета.Параметры.ТоварНаименование = СтрокаТовары.Наименование;
		ОбластьМакета.Параметры.ЦенаКомитента     = СтрокаТовары.Цена;
		ОбластьМакета.Параметры.СуммаКомитента    = СтрокаТовары.Сумма;
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Строка", НомерСтроки);
		
		Если Не СкрыватьДопДанные Тогда
			ВывестиДопДанныеСтрокиНаПечать(ТаблицаДопДанныхСтрок, СтруктураНаличияДопДанных, НомерСтроки, ТабличныйДокумент,
				ОбластьМакетаДД, "СтрокаДопДанные");
		КонецЕсли;
		
	КонецЦикла;
	
	ЗаполнитьРеквизитыПодвалаОтчетаОПродажахКомиссионногоТовара(ДанныеПечати.Шапка, Товары, Макет, ТабличныйДокумент);
	
	// Выводим доп данные документа.
	Если Не СкрыватьДопДанные Тогда
		ВывестиДопДанныеШапкиНаПечать(ДанныеПечати, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения реквизитов подвала отчета о продажах комиссионного товара.
//
// Параметры:
//  ДанныеПечати -  Данные шапки документа
//  Товары - Данные табличной части документа
//  Макет - Макет ОтчетПоКомиссии
//  ТабличныйДокумент - Табличный документ.
//
Процедура ЗаполнитьРеквизитыПодвалаОтчетаОПродажахКомиссионногоТовара(ДанныеПечати, Товары, Макет, ТабличныйДокумент)
	
	СуммаПродажи = ДанныеПечати.СуммаДокумента;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал|Данные");
	
	Если Не ЗначениеЗаполнено(ДанныеПечати.СуммаКомитента) Тогда
		СуммаКомитентаВсего = Товары.Итог("Сумма");
	Иначе
		СуммаКомитентаВсего = ДанныеПечати.СуммаКомитента;
	КонецЕсли;
	
	ОбластьМакета.Параметры.СуммаКомитентаВсего      = СуммаКомитентаВсего;
	ОбластьМакета.Параметры.СуммаПродажиВсего        = СуммаПродажи;
	ОбластьМакета.Параметры.СуммаВознагражденияВсего = ДанныеПечати.СуммаВознаграждения;
	ОбластьМакета.Параметры.ИтоговаяСтрока           = ДанныеПечати.ИтогиПрописью;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подвал");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с ОТЧЕТОМ О СПИСАНИИ КОМИССИОННОГО ТОВАРА

Функция ПолучитьДанныеОтчетаОСписанииКомиссионногоТовараДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	СведенияОКомитенте = Новый Структура;
	СведенияОКомитенте.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ПолноеНаименование"));
	СведенияОКомитенте.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ИНН"));
	СведенияОКомитенте.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.КПП"));
	СведенияОКомитенте.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ОКПО"));
	СведенияОКомитенте.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ЮридическийАдрес_Представление"));
	СведенияОКомитенте.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Организация.ФактическийАдрес_Представление"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКомитенте);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКомитенте);
	КонецЕсли;
	
	СведенияОКомиссионере = Новый Структура;
	СведенияОКомиссионере.Вставить("ПолноеНаименование", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ПолноеНаименование"));
	СведенияОКомиссионере.Вставить("ИНН",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ИНН"));
	СведенияОКомиссионере.Вставить("КПП",                ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.КПП"));
	СведенияОКомиссионере.Вставить("КодПоОКПО",          ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ОКПО"));
	СведенияОКомиссионере.Вставить("ЮридическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ЮридическийАдрес_Представление"));
	СведенияОКомиссионере.Вставить("ФактическийАдрес",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление"));
	
	Если СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПоставщике", СведенияОКомиссионере);
	ИначеЕсли СтрокаОбъекта.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ДанныеЗаполненияШапки.Вставить("СведенияОПокупателе", СведенияОКомиссионере);
	КонецЕсли;
	
	ДанныеЗаполненияШапки.Вставить("Номер", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Номер"));
	ДанныеЗаполненияШапки.Вставить("Дата",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Дата"));
	ДанныеЗаполненияШапки.Вставить("Курс",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Курс"));
	ДанныеЗаполненияШапки.Вставить("КодВалюты", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Код"));
	ДанныеЗаполненияШапки.Вставить("НаименованиеВалюты",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Валюта.Наименование"));
	ДанныеЗаполненияШапки.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Сумма"));
	ДанныеЗаполненияШапки.Вставить("ИтогиПрописью", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ИтогиПрописью"));
	
	ТЗ = Новый ТаблицаЗначений;
	
	ТЗ.Колонки.Добавить("Код");
	ТЗ.Колонки.Добавить("Артикул");
	ТЗ.Колонки.Добавить("Наименование");
	ТЗ.Колонки.Добавить("ЕдиницаИзмеренияНаименование");
	ТЗ.Колонки.Добавить("Количество");
	ТЗ.Колонки.Добавить("Цена");
	ТЗ.Колонки.Добавить("Сумма");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧ"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.Код                          = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Номенклатура.Код");
		НоваяСтрока.Артикул                      = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.Артикул");
		НоваяСтрока.Наименование                 = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.Наименование");
		НоваяСтрока.ЕдиницаИзмеренияНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ,
			"Номенклатура.ЕдиницаИзмерения.Наименование");
		НоваяСтрока.Количество                   = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Количество");
		НоваяСтрока.Цена                         = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Цена");
		НоваяСтрока.Сумма                        = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "Сумма");
		
	КонецЦикла;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка",  ДанныеЗаполненияШапки);
	ДанныеДляОбъекта.Вставить("Товары", ТЗ);
	
	ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Процедура заполняет табличный документ отчет о списании комиссионного товара
//
Процедура ЗаполнитьТабличныйДокументОтчетОСписанииКомиссионногоТовара_ЭД(ТабличныйДокумент, ДанныеПечати, ПараметрыПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ОтчетПоКомиссииОСписании_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПечати, "СкрыватьДопДанные", Ложь);
	
	Заголовок = НСтр("ru = 'Отчет о списании комиссионного товара'");
	
	КолонкаКодов = ""; 
	ОбменСКонтрагентамиПереопределяемый.ИмяДополнительнойКолонки(КолонкаКодов);
	НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
	// Выводим общие реквизиты шапки
	ЗаполнитьРеквизитыШапкиОтчетПоКомиссии(ДанныеПечати.Шапка, Заголовок, Макет, ТабличныйДокумент);
	
	// Выводим заголовок таблицы
	Если ЗначениеЗаполнено(КолонкаКодов) Тогда
		ЗаголовокТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицыСКодами|Данные");
		ЗаголовокТаблицы.Параметры.ИмяКолонкиКодов = КолонкаКодов;
	Иначе
		ЗаголовокТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы|Данные");
	КонецЕсли;
	
	ЗаголовокТаблицы.Параметры.Валюта = ДанныеПечати.Шапка.НаименованиеВалюты;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ЗаголовокТаблицы, "ШапкаТаблицы");
	
	ТаблицаДопДанныхСтрок = ТаблицаДопДанных();
	
	Если Не СкрыватьДопДанные Тогда
		ДеревоДопДанных = Неопределено;
		Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = Неопределено;
		КонецЕсли;
		
		СтруктураНаличияДопДанных = СформироватьДопДанныеСтрок(ДеревоДопДанных, "Товары", ТаблицаДопДанныхСтрок);
		
		Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
			
			Если ЗначениеЗаполнено(КолонкаКодов) Тогда
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицыСКодами|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("СтрокаСКодами|ДопДанныеТаблицыСЭЦП");
				
			Иначе
				ОбластьЗаголовокТаблицыДД = Макет.ПолучитьОбласть("ШапкаТаблицы|ДопДанныеТаблицыСЭЦП");
				ОбластьМакетаДД           = Макет.ПолучитьОбласть("Строка|ДопДанныеТаблицыСЭЦП");
				
			КонецЕсли;
			
			ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьЗаголовокТаблицыДД,
				"ШапкаТаблицыДопДанные");
			
		КонецЕсли;
	КонецЕсли;
	
	// Выводим многострочную часть документа
	Если ЗначениеЗаполнено(КолонкаКодов) Тогда
		ОбластьМакета = Макет.ПолучитьОбласть("СтрокаСКодами|Данные");
	Иначе
		ОбластьМакета = Макет.ПолучитьОбласть("Строка|Данные");
	КонецЕсли;
	
	НомерСтроки = 0;
	
	Для Каждого СтрокаТовары Из ДанныеПечати.Товары Цикл
		
		НомерСтроки = НомерСтроки + 1;
		
		ОбластьМакета.Параметры.Заполнить(СтрокаТовары);
		
		Если ЗначениеЗаполнено(КолонкаКодов) Тогда
			ОбластьМакета.Параметры.Артикул = СтрокаТовары[КолонкаКодов];
		КонецЕсли;
		
		ОбластьМакета.Параметры.НомерСтроки = НомерСтроки;
		ОбластьМакета.Параметры.ТоварНаименование = СтрокаТовары.Наименование;
		
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "СтрокаОсновныеДанные", НомерСтроки);
		
		Если Не СкрыватьДопДанные Тогда
			ВывестиДопДанныеСтрокиНаПечать(ТаблицаДопДанныхСтрок, СтруктураНаличияДопДанных, НомерСтроки, ТабличныйДокумент,
				ОбластьМакетаДД, "СтрокаДопДанные");
		КонецЕсли;
		
	КонецЦикла;
	
	ЗаполнитьРеквизитыПодвалаОтчетПоКомиссииОСписании(ДанныеПечати.Шапка, ДанныеПечати.Товары, Макет, ТабличныйДокумент);
	
	// Выводим доп данные документа.
	Если Не СкрыватьДопДанные Тогда
		ВывестиДопДанныеШапкиНаПечать(ДанныеПечати, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполнения реквизитов шапки отчета по комиссии
//
// Параметры:
//  ДанныеПечати - ВыборкаИзРезультатаЗапроса - Данные шапки документа
//  Макет - Макет отчета
//  ТабличныйДокумент - Табличный документ.
//
Процедура ЗаполнитьРеквизитыШапкиОтчетПоКомиссии(ДанныеПечати, Заголовок, Макет, ТабличныйДокумент)
	
	// Выводим общие реквизиты шапки
	СведенияОКомитенте = ДанныеПечати.СведенияОПоставщике;
	СведенияОКомиссионере = ДанныеПечати.СведенияОПокупателе;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка|Данные");
	ТекстЗаголовка = НСтр("ru='%1 № %2 от %3'");
	ТекстЗаголовка = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстЗаголовка, Заголовок,
		ДанныеПечати.Номер, Формат(ДанныеПечати.Дата, "ДЛФ=DD"));

	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		СведенияОКомитенте,
		ОбластьМакета.Параметры.ПредставлениеКомитента,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,");
		
	ЭлектронноеВзаимодействиеПереопределяемый.ОписаниеОрганизации(
		СведенияОКомиссионере,
		ОбластьМакета.Параметры.ПредставлениеКомиссионера,
		"ПолноеНаименование,ИНН,КПП,ЮридическийАдрес,Телефоны,");
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
КонецПроцедуры

// Процедура заполнения реквизитов подвала отчета по комиссии о списании.
//
// Параметры:
//  ДанныеПечати - ВыборкаИзРезультатаЗапроса - Данные шапки документа
//  ВыборкаПоДокументам - ВыборкаИзРезультатаЗапроса - Данные табличной части документа
//  Макет - Макет ОтчетКомитенту
//  ТабличныйДокумент - Табличный документ.
//
Процедура ЗаполнитьРеквизитыПодвалаОтчетПоКомиссииОСписании(ДанныеПечати, Товары, Макет, ТабличныйДокумент)
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал|Данные");
	СуммаВсего = ДанныеПечати.СуммаДокумента;
	
	ОбластьМакета.Параметры.СуммаВсего = СуммаВсего;
	ОбластьМакета.Параметры.ИтоговаяСтрока = ДанныеПечати.ИтогиПрописью;
	
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Подвал");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с РЕКВИЗИТАМИ ОРГАНИЗАЦИИ

Функция ПолучитьРеквизитыОрганизацииДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	РеквизитыОрганизации = Новый Структура;
	
	ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ИНН");
	РеквизитыОрганизации.Вставить("ИНН", ИНН);

	КПП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "КПП");
	РеквизитыОрганизации.Вставить("КПП", КПП);
	
	ОфициальноеНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ПолноеНаименование");
	РеквизитыОрганизации.Вставить("ОфициальноеНаименование", ОфициальноеНаименование);
	
	ОКПО = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ОКПО");
	РеквизитыОрганизации.Вставить("ОКПО", ОКПО);
	
	ЮрФизЛицо = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ЮрФизЛицо");
		
	ЮридическийАдрес = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.ФактическийАдрес_Представление");
	РеквизитыОрганизации.Вставить("ЮридическийАдрес", ЮридическийАдрес);
	
	ФактическийАдрес = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ФактическийАдрес_Представление");
	РеквизитыОрганизации.Вставить("ФактическийАдрес", ФактическийАдрес);
	
	Руководитель = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Руководитель");
	
	Если ТипЗнч(Руководитель) = Тип("Структура") Тогда
		
		Должность = Неопределено;
		Если Руководитель.Свойство("Должность", Должность) Тогда
			РеквизитыОрганизации.Вставить("Должность", Должность);
		КонецЕсли;
		
		Фамилия = Неопределено;
		Руководитель.Свойство("Фамилия", Фамилия);
		
		Имя = Неопределено;
		Руководитель.Свойство("Имя", Имя);
		
		Отчество = Неопределено;
		Руководитель.Свойство("Отчество", Отчество);
		
		РуководительФИО = ?(Фамилия = Неопределено, "", Фамилия)
		+ " " + ?(Имя = Неопределено,"", Имя)
		+ " " + ?(Отчество = Неопределено, "", Отчество);
		
		РеквизитыОрганизации.Вставить("ФИО", РуководительФИО);
	КонецЕсли;
	
	ТаблицаКонтакты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "Контрагент.Контакты");
	Если ТипЗнч(ТаблицаКонтакты) = Тип("ТаблицаЗначений") Тогда
		Для Каждого ТекСтрока Из ТаблицаКонтакты Цикл
			Если ВРег(ТекСтрока.Вид) = ВРег("Телефон") Тогда
				РеквизитыОрганизации.Вставить("Телефон", ТекСтрока.Представление);
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
	ТЗ = Новый ТаблицаЗначений;
	
	ТЗ.Колонки.Добавить("НомерСчета");
	ТЗ.Колонки.Добавить("Банк");
	ТЗ.Колонки.Добавить("Бик");
	
	СтрокиТЧ = СтрокаОбъекта.Строки.НайтиСтроки(Новый Структура("Реквизит", "СтрокаТЧРасчетныйСчет"));
	Для Каждого СтрокаТЧ Из СтрокиТЧ Цикл
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.НомерСчета				= ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "НомерСчета");
		НоваяСтрока.Банк					= ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "БанкНаименование");
		НоваяСтрока.Бик						= ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаТЧ, "БанкБИК");
		
	КонецЦикла;
	
	
	ДанныеЗаполнения = Новый Структура;
	ДанныеЗаполнения.Вставить("РеквизитыОрганизации", РеквизитыОрганизации);
	ДанныеЗаполнения.Вставить("РасчетныеСчета", ТЗ);
	
	Возврат ДанныеЗаполнения;
	
КонецФункции

Процедура ЗаполнитьТабличныйДокументРеквизитыОрганизации_ЭД(ТабличныйДокумент, ДанныеЭДДляПечати)
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_РеквизитыКонтрагента_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
		
	Заголовок = НСтр("ru = 'Реквизиты организации'");
	
	РеквизитыОрганизации = ДанныеЭДДляПечати.РеквизитыОрганизации;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Реквизиты");
	ОбластьМакета.Параметры.Заполнить(РеквизитыОрганизации);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Реквизиты");
	
	Если РеквизитыОрганизации.Свойство("Должность") Тогда
		ОбластьМакета = Макет.ПолучитьОбласть("Руководитель");
		ОбластьМакета.Параметры.Заполнить(РеквизитыОрганизации);
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Должность");
	КонецЕсли;
	
	Если Не ДанныеЭДДляПечати.Свойство("РасчетныеСчета") Тогда
		Возврат;
	КонецЕсли;
	
	ОбластьМакета = Макет.ПолучитьОбласть("РасчетныйСчет");
	РасчетныеСчета = ДанныеЭДДляПечати.РасчетныеСчета;
	НомерСтроки = 1;
	Для Каждого Счет Из РасчетныеСчета Цикл
		
		ОбластьМакета.Параметры.Заполнить(Счет);
		ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "РасчетныйСчет",
			НомерСтроки);
		НомерСтроки = НомерСтроки + 1;
		
	КонецЦикла;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с печатными формами

// Функция формирования структуры хранения итоговых суммы.
//
// Возвращаемое значение:
//  Структура - Структура хранения итоговых сумм.
//
Функция СтруктураИтоговыеСуммы()
	
	Структура = Новый Структура;
	
	// Инициализация итогов по странице.
	Структура.Вставить("ИтогоМассаБруттоНаСтранице", 0);
	Структура.Вставить("ИтогоМестНаСтранице", 0);
	Структура.Вставить("ИтогоКоличествоНаСтранице", 0);
	Структура.Вставить("ИтогоСуммаНаСтранице", 0);
	Структура.Вставить("ИтогоСуммаНДСНаСтранице", 0);
	Структура.Вставить("ИтогоСуммаСНДСНаСтранице", 0);
	Структура.Вставить("ИтогоМассаБруттоНаСтранице", 0);
	Структура.Вставить("ИтогоМассаНеттоНаСтранице", 0);
	
	// Инициализация итогов по документу.
	Структура.Вставить("ИтогоМассаБрутто", 0);
	Структура.Вставить("ИтогоМест", 0);
	Структура.Вставить("ИтогоКоличество", 0);
	Структура.Вставить("ИтогоСумма", 0);
	Структура.Вставить("ИтогоСуммаНДС", 0);
	Структура.Вставить("ИтогоСуммаСНДС", 0);
	Структура.Вставить("ИтогоМассаБрутто", 0);
	Структура.Вставить("ИтогоМассаНетто", 0);
	Структура.Вставить("КоличествоПорядковыхНомеровЗаписейПрописью", 0);
	Структура.Вставить("СуммаПрописью", "");
	
	Структура.Вставить("ИтогоСуммаДоКорректировки", 0);
	Структура.Вставить("ИтогоСуммаНДСДоКорректировки", 0);
	Структура.Вставить("ИтогоСуммаСНДСДоКорректировки", 0);
	
	Возврат Структура;
	
КонецФункции

// Функция формирования структуры хранения данных строки.
//
// Параметры:
//  КоэффициентПересчета - Число - коэффициент пересчета в валюту регл. учета.
//
// Возвращаемое значение:
//  Структура - Структура данных строки товаров.
//
Функция СтруктураДанныеСтроки(КоэффициентПересчета)
	
	Структура = Новый Структура;
	Структура.Вставить("Номер", 0);
	Структура.Вставить("Мест", 0);
	Структура.Вставить("КоличествоДоКорректировки", 0);
	Структура.Вставить("Количество", 0);
	Структура.Вставить("ЦенаДоКорректировки", 0);
	Структура.Вставить("Цена", 0);
	Структура.Вставить("СуммаДоКорректировки", 0);
	Структура.Вставить("Сумма", 0);
	Структура.Вставить("СуммаНДСДоКорректировки", 0);
	Структура.Вставить("СуммаНДС", 0);
	Структура.Вставить("СуммаСНДСДоКорректировки", 0);
	Структура.Вставить("СуммаСНДС", 0);
	Структура.Вставить("КоэффициентПересчета", КоэффициентПересчета);
	Структура.Вставить("МассаБрутто", 0);
	Структура.Вставить("МассаНеттоДоКорректировки", 0);
	Структура.Вставить("МассаНетто", 0);
	
	Возврат Структура;
	
КонецФункции

// Процедура обнуления итоговых сумм по странице.
//
Процедура ОбнулитьИтогиПоСтранице(ИтоговыеСуммы)
	
	ИтоговыеСуммы.ИтогоМассаБруттоНаСтранице = 0;
	ИтоговыеСуммы.ИтогоМассаНеттоНаСтранице  = 0;
	ИтоговыеСуммы.ИтогоМестНаСтранице        = 0;
	ИтоговыеСуммы.ИтогоКоличествоНаСтранице  = 0;
	ИтоговыеСуммы.ИтогоСуммаНаСтранице       = 0;
	ИтоговыеСуммы.ИтогоСуммаНДСНаСтранице    = 0;
	ИтоговыеСуммы.ИтогоСуммаСНДСНаСтранице   = 0;
	
КонецПроцедуры

// Процедура рассчитывает итоговые суммы с учетом строки товаров.
//
// Параметры:
//  ИтоговыеСуммы - Структура - Структура итоговых сумм документа
//  ДанныеСтроки - Структура - Структура данных строки товаров.
//
Процедура РассчитатьИтоговыеСуммы(ИтоговыеСуммы, ДанныеСтроки)
	
	// Увеличим итоги по странице.
	ИтоговыеСуммы.ИтогоМестНаСтранице        = ИтоговыеСуммы.ИтогоМестНаСтранице + ДанныеСтроки.Мест;
	ИтоговыеСуммы.ИтогоКоличествоНаСтранице  = ИтоговыеСуммы.ИтогоКоличествоНаСтранице + ДанныеСтроки.Количество;
	ИтоговыеСуммы.ИтогоСуммаНаСтранице       = ИтоговыеСуммы.ИтогоСуммаНаСтранице + ДанныеСтроки.Сумма;
	ИтоговыеСуммы.ИтогоСуммаНДСНаСтранице    = ИтоговыеСуммы.ИтогоСуммаНДСНаСтранице + ДанныеСтроки.СуммаНДС;
	ИтоговыеСуммы.ИтогоСуммаСНДСНаСтранице   = ИтоговыеСуммы.ИтогоСуммаСНДСНаСтранице + ДанныеСтроки.СуммаСНДС;
	ИтоговыеСуммы.ИтогоМассаБруттоНаСтранице = ИтоговыеСуммы.ИтогоМассаБруттоНаСтранице + ДанныеСтроки.МассаБрутто;
	ИтоговыеСуммы.ИтогоМассаНеттоНаСтранице  = ИтоговыеСуммы.ИтогоМассаНеттоНаСтранице + ДанныеСтроки.МассаНетто;
	
	// Увеличим итоги по документу.
	ИтоговыеСуммы.ИтогоМест        = ИтоговыеСуммы.ИтогоМест + ДанныеСтроки.Мест;
	ИтоговыеСуммы.ИтогоКоличество  = ИтоговыеСуммы.ИтогоКоличество + ДанныеСтроки.Количество;
	ИтоговыеСуммы.ИтогоСумма       = ИтоговыеСуммы.ИтогоСумма + ДанныеСтроки.Сумма;
	ИтоговыеСуммы.ИтогоСуммаНДС    = ИтоговыеСуммы.ИтогоСуммаНДС + ДанныеСтроки.СуммаНДС;
	ИтоговыеСуммы.ИтогоСуммаСНДС   = ИтоговыеСуммы.ИтогоСуммаСНДС + ДанныеСтроки.СуммаСНДС;
	ИтоговыеСуммы.ИтогоМассаБрутто = ИтоговыеСуммы.ИтогоМассаБрутто + ДанныеСтроки.МассаБрутто;
	ИтоговыеСуммы.ИтогоМассаНетто  = ИтоговыеСуммы.ИтогоМассаНетто + ДанныеСтроки.МассаНетто;
	
	ИтоговыеСуммы.ИтогоСуммаДоКорректировки     = ИтоговыеСуммы.ИтогоСуммаДоКорректировки + ДанныеСтроки.СуммаДоКорректировки;
	ИтоговыеСуммы.ИтогоСуммаНДСДоКорректировки  = ИтоговыеСуммы.ИтогоСуммаНДСДоКорректировки + ДанныеСтроки.СуммаНДСДоКорректировки;
	ИтоговыеСуммы.ИтогоСуммаСНДСДоКорректировки = ИтоговыеСуммы.ИтогоСуммаСНДСДоКорректировки + ДанныеСтроки.СуммаСНДСДоКорректировки;
	
КонецПроцедуры

// Функция форматирования сумм.
//
// Параметры:
//  Сумма  - число, которое мы хотим форматировать. 
//  Валюта - ссылка на элемент справочника валют, если задан, то к в результирующую строку
//           будет добавлено представление валюты.
//  ЧН     - строка, представляющая нулевое значение числа.
//  ЧРГ    - символ-разделитель групп целой части числа.
//
// Возвращаемое значение:
//  Отформатированная должным образом строковое представление суммы.
//
Функция ФорматСумм(Знач Сумма, Валюта = Неопределено, ЧН = "", ЧРГ = "")
	
	Сумма = ?(Сумма < 0, -Сумма, Сумма);
	ФорматнаяСтрока = "ЧЦ=15;ЧДЦ=2" + ?(НЕ ЗначениеЗаполнено(ЧН), "", ";" + "ЧН=" + ЧН)
		+ ?(НЕ ЗначениеЗаполнено(ЧРГ),"", ";" + "ЧРГ=" + ЧРГ);
	РезультирующаяСтрока = СокрЛ(Формат(Сумма, ФорматнаяСтрока));
	
	Если ЗначениеЗаполнено(Валюта) Тогда
		РезультирующаяСтрока = РезультирующаяСтрока + " " + СокрП(Валюта);
	КонецЕсли;
	
	Возврат РезультирующаяСтрока;
	
КонецФункции

// Функция приводит к требуемому формату сумму НДС, если она имеет числовое представление.
//
// Параметры:
// СуммаНДС - строка, сумма НДС (без НДС, -, число).
//
// Возвращаемое значение:
// ВозвращаемаяСумма - если входящий параметр - представление числа, то возвращаемое значение - число.
//
Функция СуммаНДССФПривестиКТребуемомуФормату(СуммаНДС)
	
	Если СтрНайти(СуммаНДС, ".") > 0 ИЛИ СтрНайти(СуммаНДС, ",") > 0 ИЛИ СтрНайти(СуммаНДС, "-") > 0 Тогда
		ВозвращаемаяСумма = Число(СуммаНДС);
	Иначе
		ВозвращаемаяСумма = СуммаНДС;
	КонецЕсли;
	
	Возврат ВозвращаемаяСумма;
	
КонецФункции

// Проставляет прочерки в незаполненных полях печатной формы счета-фактуры
//
Процедура ПроставитьПрочеркиВПустыеПоляСтрокиСчетФактура(ОбластьМакета)
	
	Для ИндексПараметра = 0 По ОбластьМакета.Параметры.Количество() - 1 Цикл
		
		ТекПараметр = ОбластьМакета.Параметры.Получить(ИндексПараметра);
		
		Если НЕ ЗначениеЗаполнено(ТекПараметр) Тогда
			ОбластьМакета.Параметры.Установить(ИндексПараметра, "--");
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Подготовка к просмотру служебного ЭД

Функция ПолучитьДанныеУчастникаОбменаЭД(УчастникОбмена)
	
	Если УчастникОбмена = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ВозвращаемоеЗначение = Неопределено;
	
	Если УчастникОбмена.Свойства().Получить("ОтпрЮЛ") <> Неопределено Тогда
		
		ВозвращаемоеЗначение = 
			ЗначениеСвойстваXDTO(УчастникОбмена, "ОтпрЮЛ.НаимОрг", "Строка") + ", "
			+ ЗначениеСвойстваXDTO(УчастникОбмена, "ОтпрЮЛ.ИННЮЛ", "Строка") + "/"
			+ ЗначениеСвойстваXDTO(УчастникОбмена, "ОтпрЮЛ.КПП", "Строка");
			
	ИначеЕсли УчастникОбмена.Свойства().Получить("ПолЮЛ") <> Неопределено Тогда
		
		ВозвращаемоеЗначение = 
			ЗначениеСвойстваXDTO(УчастникОбмена, "ПолЮЛ.НаимОрг", "Строка") + ", "
			+ ЗначениеСвойстваXDTO(УчастникОбмена, "ПолЮЛ.ИННЮЛ", "Строка") + "/"
			+ ЗначениеСвойстваXDTO(УчастникОбмена, "ПолЮЛ.КПП", "Строка");
			
	ИначеЕсли УчастникОбмена.Свойства().Получить("ОтпрИП") <> Неопределено Тогда
		
		ДанныеФИО = ЗначениеСвойстваXDTO(УчастникОбмена, "ОтпрИП.ФИО");
		
		СоставляющиеФИО = Новый Массив;
		СоставляющиеФИО.Добавить(ЗначениеСвойстваXDTO(ДанныеФИО, "Фамилия", "Строка"));
		СоставляющиеФИО.Добавить(ЗначениеСвойстваXDTO(ДанныеФИО, "Имя", "Строка"));
		
		Отчество = ЗначениеСвойстваXDTO(ДанныеФИО, "Отчество");
		Если ЗначениеЗаполнено(Отчество) Тогда
			СоставляющиеФИО.Добавить(Отчество);
		КонецЕсли;
		
		ВозвращаемоеЗначение = СтрСоединить(СоставляющиеФИО, " ") + ", " + ЗначениеСвойстваXDTO(УчастникОбмена, "ОтпрИП.ИННФЛ", "Строка");
		
	ИначеЕсли ЗначениеСвойстваXDTO(УчастникОбмена, "ЮЛ") <> Неопределено Тогда
		
		ВозвращаемоеЗначение =
			ЗначениеСвойстваXDTO(УчастникОбмена, "ЮЛ.НаимОрг", "Строка") + ", "
			+ ЗначениеСвойстваXDTO(УчастникОбмена, "ЮЛ.ИННЮЛ", "Строка") + "/"
			+ ЗначениеСвойстваXDTO(УчастникОбмена, "ЮЛ.КПП", "Строка");
		
	ИначеЕсли ЗначениеСвойстваXDTO(УчастникОбмена, "ИП") <> Неопределено Тогда
		
		ДанныеФИО = ЗначениеСвойстваXDTO(УчастникОбмена, "ИП.ФИО");
		
		СоставляющиеФИО = Новый Массив;
		СоставляющиеФИО.Добавить(ЗначениеСвойстваXDTO(УчастникОбмена, "ИП.ФИО.Фамилия", "Строка"));
		СоставляющиеФИО.Добавить(ЗначениеСвойстваXDTO(УчастникОбмена, "ИП.ФИО.Имя",     "Строка"));
		
		Отчество = ЗначениеСвойстваXDTO(УчастникОбмена, "ИП.ФИО.Отчество");
		
		Если ЗначениеЗаполнено(Отчество) Тогда
			СоставляющиеФИО.Добавить(Отчество);
		КонецЕсли;
		
		ВозвращаемоеЗначение = СтрСоединить(СоставляющиеФИО, " ") + ", " + ЗначениеСвойстваXDTO(УчастникОбмена, "ИП.ИННФЛ", "Строка");
		
	ИначеЕсли ЗначениеСвойстваXDTO(УчастникОбмена, "ОперЭДО") <> Неопределено Тогда
		
		ВозвращаемоеЗначение =
			ЗначениеСвойстваXDTO(УчастникОбмена, "ОперЭДО.НаимОрг", "Строка") + ", " 
			+ ЗначениеСвойстваXDTO(УчастникОбмена, "ОперЭДО.ИННЮЛ", "Строка");
		
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Работа с подтверждением

// ПДПЭСФ, ПДОИПЭСФ
Процедура ПрочитатьПодтверждениеДатыПолученияXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.Подтверждение;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИмяФайла",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.СведОтпрФайл.ИмяПостФайла"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.ОтпрДок")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторОтправителя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.ОтпрДок.ИдУчастЭДО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.ПолДок")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторПолучателя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.ПолДок.ИдУчастЭДО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОтправки",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.ДатаОтпр"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВремяОтправки",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.ВремяОтпр"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КНДФормы",
		ЗначениеСвойстваXDTO(ЭД, "Документ.КНД"));
		
	Если ЭД.Документ.КНД = "1115112" Тогда
		ПараметрЗаголовка = "получения";
		ОтправленПолучен = "получен";
	Иначе
		ПараметрЗаголовка = "отправки";
		ОтправленПолучен = "отправлен";
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПараметрЗаголовка",  ПараметрЗаголовка);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправлен_Получен",  ОтправленПолучен);
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОператорЭДО",
		""""
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.НаимОрг", "Строка")
		+ """ (ИНН "
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.ИННЮЛ", "Строка")
		+ ", код "
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.ИдОперЭДО", "Строка")
		+ ")");
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
КонецПроцедуры

// ПДОЭСФ
Процедура ПрочитатьПодтверждениеДатыОтправкиXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.Подтверждение;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИмяФайла",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.СведОтпрФайл.ИмяПостФайла"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.СвОтпрДок")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторОтправителя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвОтпрДок.ИдУчастЭДО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.СвПолДок")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторПолучателя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвПолДок.ИдУчастЭДО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОтправки",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.ДатаОтпр"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВремяОтправки",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.ВремяОтпр"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КНДФормы",
		ЗначениеСвойстваXDTO(ЭД, ".Документ.КНД"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПараметрЗаголовка", "отправки");
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправлен_Получен", "отправлен");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОператорЭДО",
		""""
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.НаимОрг", "Строка")
		+ """ (ИНН "
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.ИННЮЛ", "Строка")
		+ ", код "
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.ИдОперЭДО", "Строка")
		+ ")");
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
КонецПроцедуры

// ПДО
Процедура ПрочитатьПодтверждениеXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.Подтверждение;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИмяФайла",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.ИмяПостФайла"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.СвОтпр")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.ПолДок")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаОтправки",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.ДатаДок"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВремяОтправки",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СведПодтв.ВремяДок"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "КНДФормы",
		ЗначениеСвойстваXDTO(ЭД, "Документ.КНД"));
	
	Если ЭД.Документ.КНД = "1167002" Тогда
		ПараметрЗаголовка = "получения";
		ОтправленПолучен = "получен";
	Иначе
		ПараметрЗаголовка = "отправки";
		ОтправленПолучен = "отправлен";
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПараметрЗаголовка",  ПараметрЗаголовка);
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправлен_Получен",  ОтправленПолучен);
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ОператорЭДО",
		""""
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.НаимОрг", "Строка")
		+ """ (ИНН "
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.ИННЮЛ", "Строка")
		+ ", код "
		+ ЗначениеСвойстваXDTO(ЭД, "Документ.ОперЭДО.ИдОперЭДО", "Строка")
		+ ")");
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
КонецПроцедуры

// Процедура заполняет табличный документ Подтверждение (ПДО, ПДП, ПДОИП).
//
Процедура ЗаполнитьТабличныйДокументПодтверждение(ТабличныйДокумент, ДанныеПечати)
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_Подтверждение";
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_Подтверждение_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
		
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ЗаполнитьЗначенияСвойств(ОбластьМакета.Параметры, ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
КонецПроцедуры

Функция ПолучитьДанныеПодтвержденияДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	ДанныеЗаполненияШапки.Вставить("ОператорЭДО", НСтр("ru = 'Оператор электронного документооборота'") + " "
		+ ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта, "ОператорЭДО"));
	
	ДанныеЗаполненияШапки.Вставить("Отправитель", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Отправитель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторОтправителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторОтправителя"));
	
	ДанныеЗаполненияШапки.Вставить("Получатель",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Получатель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторПолучателя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторПолучателя"));
	
	ДанныеЗаполненияШапки.Вставить("ДатаОтправки", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ДатаОтправки"));
	ДанныеЗаполненияШапки.Вставить("ВремяОтправки",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ВремяОтправки"));
	
	ДанныеЗаполненияШапки.Вставить("ИмяФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ИмяФайла"));
	ДанныеЗаполненияШапки.Вставить("ПараметрЗаголовка", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ПараметрЗаголовка"));
	ДанныеЗаполненияШапки.Вставить("КНДФормы", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"КНДФормы"));
	ДанныеЗаполненияШапки.Вставить("Отправлен_Получен", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "Отправлен_Получен"));
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Просмотр извещений

// Процедура заполняет табличный документ Извещение.
//
Процедура ЗаполнитьТабличныйДокументИзвещение(ТабличныйДокумент, ДанныеПечати)
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_Извещение";
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_Извещение_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
		
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ТекстЗаголовка = НСтр("ru='Извещение о получении электронного документа'");
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Заголовок");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ЗаполнитьЗначенияСвойств(ОбластьМакета.Параметры, ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
КонецПроцедуры

Процедура ПрочитатьИзвещениеXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИмяФайла",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвИзвПолуч.СведПолФайл.ИмяПостФайла"));
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.ОтпрДок")));
	
	ИдентификаторОтправителя = ЗначениеСвойстваXDTO(ЭД, "Документ.ОтпрДок.ИдУчастЭДО");
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.ОтпрДок.ОперЭДО.ИдОперЭДО") <> Неопределено Тогда
		ИдентификаторОтправителя = ЗначениеСвойстваXDTO(ЭД, "Документ.ОтпрДок.ОперЭДО.ИдОперЭДО");
	КонецЕсли;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторОтправителя",
		ИдентификаторОтправителя);
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.УчастЭДО")));
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторПолучателя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.УчастЭДО.ИдУчастЭДО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПолучения",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвИзвПолуч.ДатаПол"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВремяПолучения",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвИзвПолуч.ВремяПол"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПараметрЗаголовка", "");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
		
КонецПроцедуры

Функция ПолучитьДанныеИзвещенияДляПечати(СтрокаОбъекта, ДеревоРазбора)
	
	ДанныеЗаполненияШапки = Новый Структура;
	ДанныеЗаполненияШапки.Вставить("Отправитель", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Отправитель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторОтправителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторОтправителя"));
	
	ДанныеЗаполненияШапки.Вставить("Получатель",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Получатель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторПолучателя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторПолучателя"));
	
	ДанныеЗаполненияШапки.Вставить("ДатаПолучения",	ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДатаПолучения"));
	ДанныеЗаполненияШапки.Вставить("ВремяПолучения",ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ВремяПолучения"));
	
	ДанныеЗаполненияШапки.Вставить("ИмяФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ИмяФайла"));
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка", 	ДанныеЗаполненияШапки);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Формирование извещений

Процедура СформироватьДанныеПоУчастникуЭДО(УчастникЭДО, Дерево, ВидЭД, ВидУчастникаЭДО, Ошибки, ПространствоИмен, ВерсияФормата)
	
	Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО);
	Если Реквизит <> Истина Тогда
		Возврат;
	КонецЕсли;
	
	Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ИдУчастникаЭДО");
	ЗаполнитьСвойствоXDTO(УчастникЭДО, "ИдУчастЭДО", Реквизит, Истина, Ошибки);
	
	Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника");
	// Заполнение реквизитов
	Если ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
		Если Реквизит = "ОператорЭДО" Тогда
			ОператорЭДО = ПолучитьОбъектТипаCML("Файл.Документ.ОтпрДок.ОперЭДО", ПространствоИмен);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ОператорЭДО.НаименованиеОрганизации");
			ЗаполнитьСвойствоXDTO(ОператорЭДО, "НаимОрг", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ОператорЭДО.ИНН");
			ЗаполнитьСвойствоXDTO(ОператорЭДО, "ИННЮЛ", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ОператорЭДО.ИдентификаторОператора");
			ЗаполнитьСвойствоXDTO(ОператорЭДО, "ИдОперЭДО", Реквизит, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ОперЭДО", ОператорЭДО, Истина, Ошибки);
		ИначеЕсли Реквизит = "ИП" Тогда
			РеквизитыКонтрагента = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ФЛТип"), ВерсияФормата);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.ИНН");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ИННФЛ", Реквизит, Истина, Ошибки);
			
			РеквизитыФИО = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ФИОТип"), ВерсияФормата);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Фамилия");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Фамилия", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Имя");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Имя", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Отчество");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Отчество", Реквизит, , Ошибки);
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ФИО", РеквизитыФИО, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ИП", РеквизитыКонтрагента, Истина, Ошибки);
		Иначе
			РеквизитыКонтрагента = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ЮЛТип"), ВерсияФормата);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "НаимОрг", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.ИНН");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ИННЮЛ", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.КПП");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "КПП", Реквизит, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ЮЛ", РеквизитыКонтрагента, Истина, Ошибки);
		КонецЕсли;
		
	ИначеЕсли ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении Тогда
		Если Реквизит = "ИП" Тогда
			РеквизитыКонтрагента = ПолучитьОбъектТипаCML("Файл.Документ.УчастЭДО.ИП", ПространствоИмен);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.ИНН");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ИННФЛ", Реквизит, Истина, Ошибки);
			
			РеквизитыФИО = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ФИОТип"), ВерсияФормата);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Фамилия");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Фамилия", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Имя");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Имя", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Отчество");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Отчество", Реквизит, , Ошибки);
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ФИО", РеквизитыФИО, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ИП", РеквизитыКонтрагента, Истина, Ошибки);
		Иначе
			РеквизитыКонтрагента = ПолучитьОбъектТипаCML("Файл.Документ.УчастЭДО.ЮЛ", ПространствоИмен);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "НаимОрг", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.ИНН");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ИННЮЛ", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.КПП");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "КПП", Реквизит, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ЮЛ", РеквизитыКонтрагента, Истина, Ошибки);
		КонецЕсли;
		
	ИначеЕсли ВидЭД = Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
		Если Реквизит = "ИП" Тогда
			РеквизитыКонтрагента = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ФЛТип"), ВерсияФормата);
			РеквизитыФИО = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ФИОТип"), ВерсияФормата);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.ИНН");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ИННФЛ", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Фамилия");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Фамилия", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Имя");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Имя", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ИП.Отчество");
			ЗаполнитьСвойствоXDTO(РеквизитыФИО, "Отчество", Реквизит, , Ошибки);
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ФИО", РеквизитыФИО, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ИП", РеквизитыКонтрагента, Истина, Ошибки);
		Иначе
			РеквизитыКонтрагента = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ЮЛТип"), ВерсияФормата);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "НаимОрг", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.ИНН");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "ИННЮЛ", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ВидУчастникаЭДО + ".ТипУчастника.ЮЛ.КПП");
			ЗаполнитьСвойствоXDTO(РеквизитыКонтрагента, "КПП", Реквизит, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ЮЛ", РеквизитыКонтрагента, Истина, Ошибки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Функция ЭППолученногоФайла(ЭлектронныйДокумент)
	
	МассивЭП = Новый Массив;
	ЭлектронныеПодписиЭД = ЭлектроннаяПодпись.УстановленныеПодписи(ЭлектронныйДокумент);
	Для каждого ЭП Из ЭлектронныеПодписиЭД Цикл
		ДанныеПодписи = Base64Строка(ЭП.Подпись);
		МассивЭП.Добавить(СтрЗаменить(ДанныеПодписи, Символы.ВК + Символы.ПС, ""));
	КонецЦикла;
	
	Возврат МассивЭП;
	
КонецФункции

Функция ЗаполнитьФайлСлужебногоДокумента(Дерево, ВидЭД)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	
	Если ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
		ПространствоИмен      = "DP_IZVPOL";
		ЭлементОбщиеСведения  = "СвИзвПолуч";
		ЭлементСведенияОФайле = "СведПолФайл";
		АтрибутИмяФайла       = "ИмяПостФайла";
		СписокЭЦПФайла        = "ЭЦППолФайл";
		ЭлементПолучатель     = "ОтпрДок";
		НомерДокументаФайла   = "НомДок";
		ДатаДокументаФайла    = "ДатаДок";
	ИначеЕсли ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении Тогда
		ПространствоИмен      = "DP_UVUTOCH";
		ЭлементОбщиеСведения  = "СвУведУточ";
		ЭлементСведенияОФайле = "СведПолФайл";
		АтрибутИмяФайла       = "ИмяПостФайла";
		СписокЭЦПФайла        = "ЭЦППолФайл";
		ЭлементТекстУточнения = "ТекстУведУточ";
		ЭлементПолучатель     = "ОтпрДок";
		НомерДокументаФайла   = "НомСФ";
		ДатаДокументаФайла    = "ДатаСФ";
	Иначе
		ПространствоИмен      = "DP_PRANNUL";
		ЭлементОбщиеСведения  = "СвПредАн";
		ЭлементСведенияОФайле = "СведАнФайл";
		АтрибутИмяФайла       = "ИмяАнФайла";
		СписокЭЦПФайла        = "ЭЦПАнФайл";
		ЭлементТекстУточнения = "ТекстПредАн";
		ЭлементПолучатель     = "НапрПредАн";
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево,"ИдФайла"));
	
	Попытка
		Файл = ПолучитьОбъектТипаCML("Файл", ПространствоИмен);
		
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл", СтруктураПараметров.ИдФайла, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ВерсияПрограммы"), Истина, Ошибки);
		ВерсияФормата = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ВерсияФормата");
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ВерсияФормата, Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML("Файл.Документ", ПространствоИмен);
		Если ВидЭД <> Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
			ЗаполнитьСвойствоXDTO(Документ, "КНД", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево,"КодКНД"), Истина, Ошибки);
		КонецЕсли;
		
		// Отправитель
		Отправитель = ПолучитьОбъектТипаCML("Файл.Документ.УчастЭДО", ПространствоИмен);
		СформироватьДанныеПоУчастникуЭДО(Отправитель, Дерево, ВидЭД, "Отправитель", Ошибки, ПространствоИмен, ВерсияФормата);
		ЗаполнитьСвойствоXDTO(Документ, "УчастЭДО", Отправитель, Истина, Ошибки);
		
		// Общие сведения о документе
		ОбщиеСведения = ПолучитьОбъектТипаCML("Файл.Документ." + ЭлементОбщиеСведения, ПространствоИмен);
		Если ВидЭД <> Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
			Реквизит = ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.ДатаПолучения"));
			ЗаполнитьСвойствоXDTO(ОбщиеСведения, "ДатаПол", Реквизит, Истина, Ошибки);
			Реквизит = ВернутьВремяЭСФСтрокой(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.ДатаПолучения"));
			ЗаполнитьСвойствоXDTO(ОбщиеСведения, "ВремяПол", Реквизит, Истина, Ошибки);
		КонецЕсли;
		
		// Данные о полученном файле
		ПолученныйЭД = ПолучитьОбъектТипаCML("Файл.Документ." + ЭлементОбщиеСведения + "." + ЭлементСведенияОФайле,
			ПространствоИмен);
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ИмяПолученногоФайла");
		ЗаполнитьСвойствоXDTO(ПолученныйЭД, АтрибутИмяФайла, Реквизит, Истина, Ошибки);
		
		// ЭЦП полученного файла в кодировке Base64
		МассивЭП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ПолученныеЭП");
		Если ТипЗнч(МассивЭП) = Тип("Массив") И ЗначениеЗаполнено(МассивЭП) Тогда
			
			Если ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении Тогда
				ЗаполнитьСвойствоXDTO(ПолученныйЭД, СписокЭЦПФайла, МассивЭП[0], Истина, Ошибки);
			Иначе
				Для Каждого ЭП Из МассивЭП Цикл
					ПолученныйЭД[СписокЭЦПФайла].Добавить(ЭП);
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		Если ВидЭД <> Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.ТекстУточнения");
			ЗаполнитьСвойствоXDTO(ОбщиеСведения, ЭлементТекстУточнения, Реквизит, Истина, Ошибки);
		КонецЕсли;
		
		Если ВидЭД <> Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента");
			Если Реквизит = Истина Тогда
				ПутьКДаннымФайла = ЭлементОбщиеСведения;
				Если ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
					ПутьКДаннымФайла = ЭлементОбщиеСведения + ".СведПолФайл";
				КонецЕсли;
				
				ДанныеДок = ПолучитьОбъектТипаCML("Файл.Документ." + ПутьКДаннымФайла + ".ДанПолучДок", ПространствоИмен);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.НаимДокумента");
				ЗаполнитьСвойствоXDTO(ДанныеДок, "НаимДок", Реквизит, Истина, Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.НомерДокумента");
				ЗаполнитьСвойствоXDTO(ДанныеДок, НомерДокументаФайла, Реквизит, Истина, Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.ДатаДокумента");
				Реквизит = ДатаДД_ММ_ГГГГ(Реквизит);
				ЗаполнитьСвойствоXDTO(ДанныеДок, ДатаДокументаФайла, Реквизит, Истина, Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.НомИспрСФ");
				Если ЗначениеЗаполнено(Реквизит) Тогда
					ЗаполнитьСвойствоXDTO(ДанныеДок, "НомИспрСФ", Реквизит, , Ошибки);
				КонецЕсли;
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.ДатаИспрСФ");
				Если ЗначениеЗаполнено(Реквизит) Тогда
					Реквизит = ДатаДД_ММ_ГГГГ(Реквизит);
					ЗаполнитьСвойствоXDTO(ДанныеДок, "ДатаИспрСФ", Реквизит, , Ошибки);
				КонецЕсли;
				Если ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.НомКСФ");
					Если ЗначениеЗаполнено(Реквизит) Тогда
						ЗаполнитьСвойствоXDTO(ДанныеДок, "НомКСФ", Реквизит, , Ошибки);
					КонецЕсли;
					Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.ДатаКСФ");
					Если ЗначениеЗаполнено(Реквизит) Тогда
						Реквизит = ДатаДД_ММ_ГГГГ(Реквизит);
						ЗаполнитьСвойствоXDTO(ДанныеДок, "ДатаКСФ", Реквизит, , Ошибки);
					КонецЕсли;
				КонецЕсли;
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.НомИспрКСФ");
				Если ЗначениеЗаполнено(Реквизит) Тогда
					ЗаполнитьСвойствоXDTO(ДанныеДок, "НомИспрКСФ", Реквизит, , Ошибки);
				КонецЕсли;
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.СведПолФайл.ДанныеПолученногоДокумента.ДатаИспрКСФ");
				Если ЗначениеЗаполнено(Реквизит) Тогда
					Реквизит = ДатаДД_ММ_ГГГГ(Реквизит);
					ЗаполнитьСвойствоXDTO(ДанныеДок, "ДатаИспрКСФ", Реквизит, , Ошибки);
				КонецЕсли;
				
				Если ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
					ЗаполнитьСвойствоXDTO(ПолученныйЭД, "ДанПолучДок", ДанныеДок, , Ошибки);
				Иначе
					ЗаполнитьСвойствоXDTO(ОбщиеСведения, "ДанПолучДок", ДанныеДок, , Ошибки);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(ОбщиеСведения, ЭлементСведенияОФайле, ПолученныйЭД, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, ЭлементОбщиеСведения, ОбщиеСведения, Истина, Ошибки);
		
		// Получатель
		Получатель = ПолучитьОбъектТипаCML("Файл.Документ." + ЭлементПолучатель, ПространствоИмен);
		СформироватьДанныеПоУчастникуЭДО(Получатель, Дерево, ВидЭД, "Получатель", Ошибки, ПространствоИмен, ВерсияФормата);
		ЗаполнитьСвойствоXDTO(Документ, ЭлементПолучатель, Получатель, Истина, Ошибки);
		
		// Подписант
		Подписант = ПолучитьОбъектТипаCML("Файл.Документ.Подписант", ПространствоИмен);
		ЗаполнитьСвойствоXDTO(Подписант, "Должность", "---", Истина, Ошибки);
		
		ФИОПодписанта = ПолучитьОбъектТипаCML(ФабрикаXDTO.Тип(ПространствоИмен, "ФИОТип"));
		ЗаполнитьСвойствоXDTO(ФИОПодписанта, "Фамилия", "---", Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ФИОПодписанта, "Имя", "---", Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Подписант, "ФИО", ФИОПодписанта, Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "Подписант", Подписант, Истина, Ошибки);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, Истина, Ошибки);
		
		Файл.Проверить();
		Если ЗначениеЗаполнено(Ошибки) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			ФайлСформирован = Ложь;
		Иначе
			ВставитьЗначениеВДерево(Дерево, "ПолноеИмяФайла", ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml"));
			ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ПолноеИмяФайла"), Ложь, "windows-1251");
			УдалитьПространствоИмен(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ПолноеИмяФайла"), ПространствоИмен);
			ФайлСформирован = Истина;
		КонецЕсли;
		
	Исключение
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		ТекстСообщения = ?(ЗначениеЗаполнено(ТекстОшибки), ТекстОшибки, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование служебного ЭД'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), ТекстСообщения);
		ФайлСформирован = Ложь;
	КонецПопытки;
	
	Возврат ФайлСформирован;
	
КонецФункции

Функция ПодготовитьДанныеПоСлужебномуДокументу(СсылкаНаОбъект, СтруктураЭД, Дерево)
	
	ДеревоЗаполнено = Ложь;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	ПараметрыОбработкиОшибки = Неопределено; // служебная переменная для хранения параметров вывода ошибок
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "ИдФайла", СтруктураЭД.ИдФайла);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "ВерсияПрограммы", НСтр("ru = '1С:Предприятие 8'"));
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "Отправитель.ИдУчастникаЭДО", СтруктураЭД.ИДОтправителя);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "Получатель.ИдУчастникаЭДО", СтруктураЭД.ИДПолучателя);
	Если СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "ВерсияФормата", "1.01");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "КодКНД", "");
	Иначе
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "ВерсияФормата", "1.02");
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "КодКНД",
			?(СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении, "1115110", "1115113"));
	КонецЕсли;
	
	Попытка
		// Получатель
		Если СтруктураЭД.Свойство("ОператорЭДО") Тогда
			Путь = "Получатель.ТипУчастника.ОператорЭДО";
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".ИНН", СтруктураЭД.ОператорЭДО.ИНН);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево,
				Путь + ".НаименованиеОрганизации", СтруктураЭД.ОператорЭДО.Наименование);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево,
				Путь + ".ИдентификаторОператора", СтруктураЭД.ОператорЭДО.ИдентификаторОператора);
		Иначе
			
			Контрагент = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураЭД.ВладелецФайла,"Контрагент");
				
			ЭтоФизЛицо = Ложь;
			ОбменСКонтрагентамиПереопределяемый.ЭтоФизЛицо(Контрагент, ЭтоФизЛицо);
			ДанныеЮрФизЛица = Неопределено; 
			ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(Контрагент, ДанныеЮрФизЛица);
			ПолноеНаименованиеИмя = ?(ЭтоФизЛицо, "ПолноеНаименование", "ОфициальноеНаименование");
			ПолноеНаименование = "";
			Если НЕ ДанныеЮрФизЛица.Свойство(ПолноеНаименованиеИмя, ПолноеНаименование)
				ИЛИ ПустаяСтрока(ПолноеНаименование) Тогда
				ДанныеЮрФизЛица.Свойство("Представление", ПолноеНаименование);
			КонецЕсли;
			
			Если ЭтоФизЛицо Тогда
				Путь = "Получатель.ТипУчастника.ИП";
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".ИНН", ДанныеЮрФизЛица.ИНН);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".Фамилия", ДанныеЮрФизЛица.Фамилия);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".Имя", ДанныеЮрФизЛица.Имя);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".Отчество", ДанныеЮрФизЛица.Отчество);
			Иначе
				Путь = "Получатель.ТипУчастника.ЮЛ";
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".ИНН", ДанныеЮрФизЛица.ИНН);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".КПП", ДанныеЮрФизЛица.КПП);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".НаименованиеОрганизации", ПолноеНаименование);
			КонецЕсли;
		КонецЕсли;
		
		// Отправитель
		
		Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураЭД.ВладелецФайла,"Организация");

		ЭтоФизЛицо = Ложь; 
		ОбменСКонтрагентамиПереопределяемый.ЭтоФизЛицо(Организация, ЭтоФизЛицо);
		ДанныеЮрФизЛица = Неопределено; 
		ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(Организация, ДанныеЮрФизЛица);
		ПолноеНаименованиеИмя = ?(ЭтоФизЛицо, "ПолноеНаименование", "ОфициальноеНаименование");
		ПолноеНаименование = "";
		Если НЕ ДанныеЮрФизЛица.Свойство(ПолноеНаименованиеИмя, ПолноеНаименование)
			ИЛИ ПустаяСтрока(ПолноеНаименование) Тогда
			ДанныеЮрФизЛица.Свойство("Представление", ПолноеНаименование);
		КонецЕсли;
		
		Если ЭтоФизЛицо Тогда
			Путь = "Отправитель.ТипУчастника.ИП";
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".ИНН", ДанныеЮрФизЛица.ИНН);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".Фамилия", ДанныеЮрФизЛица.Фамилия);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".Имя", ДанныеЮрФизЛица.Имя);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".Отчество", ДанныеЮрФизЛица.Отчество);
		Иначе
			Путь = "Отправитель.ТипУчастника.ЮЛ";
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".ИНН", ДанныеЮрФизЛица.ИНН);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".КПП", ДанныеЮрФизЛица.КПП);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + ".НаименованиеОрганизации", ПолноеНаименование);
		КонецЕсли;
		
		// Документ
		Если НЕ СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.ДатаПолучения",
				СтруктураЭД.ДатаВремяПолучения);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.ВремяПолучения",
				ВремяИзДаты(СтруктураЭД.ДатаВремяПолучения));
		КонецЕсли;
		Путь = "ДанныеДокумента.СведПолФайл.";
		Реквизит = СтруктураЭД.ИмяПолученногоФайлаБезРасширения;
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + "ИмяПолученногоФайла", Реквизит);
		
		Если СтруктураЭД.Свойство("НаименованиеДокументаОтправителя") И ЗначениеЗаполнено(СтруктураЭД.НаименованиеДокументаОтправителя) Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево,
				Путь + "ДанныеПолученногоДокумента.НаимДокумента", СтруктураЭД.НаименованиеДокументаОтправителя);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево,
				Путь + "ДанныеПолученногоДокумента.НомерДокумента",
				?(ЗначениеЗаполнено(СтруктураЭД.НомерДокументаОтправителя), СтруктураЭД.НомерДокументаОтправителя, НСтр("ru = 'б/н'")));
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + "ДанныеПолученногоДокумента.ДатаДокумента",
				СтруктураЭД.ДатаДокументаОтправителя);
		КонецЕсли;
		
		Реквизит = ЭППолученногоФайла(СсылкаНаОбъект);
		Если Не ЗначениеЗаполнено(Реквизит) Тогда
			Реквизит.Добавить("---");
		КонецЕсли;
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Путь + "ПолученныеЭП", Реквизит);
		
		Если НЕ СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, "ДанныеДокумента.ТекстУточнения", СтруктураЭД.ТекстУточнения);
		КонецЕсли;
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ПараметрыОбработкиОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.НовыеПараметрыОшибки(СсылкаНаОбъект);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибку(Ошибки, ТекстСообщения, ПараметрыОбработкиОшибки);
	КонецПопытки;
	
	Если Не ЗначениеЗаполнено(Ошибки) Тогда
		// Выполним проверки корректности заполнения данных в дереве.
		Если Не ЗначениеЗаполнено(Ошибки) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(Дерево, Ошибки);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(Ошибки) Тогда
			ДеревоЗаполнено = Истина;
		КонецЕсли;
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ДеревоЗаполнено;
	
КонецФункции

Функция ОпределитьИдФайлаЭД(СтруктураЭД)
	
	ТекстИд = "";
	Если СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
		
		// Формат имени по ЭСФ: DP_IZVPOL_ИдПолучателя_ИдОтправителя_ГГГГММДД_GUID.
		ТекстИд = НСтр("ru = 'DP_IZVPOL_%1_%2_%3_%4'");
		Если СтруктураЭД.Свойство("ОператорЭДО") И СтруктураЭД.ОператорЭДО.Свойство("ИдентификаторОператора") Тогда
			ИдПолучателя = СтруктураЭД.ОператорЭДО.ИдентификаторОператора;
		Иначе
			ИдПолучателя = СтруктураЭД.ИдПолучателя;
		КонецЕсли;
		ТекстИд = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстИд, ИдПолучателя, СтруктураЭД.ИдОтправителя,
			ВернутьДатуСтрокойДляИД(ТекущаяДатаСеанса()), СтруктураЭД.НомерЭД);
	ИначеЕсли СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении Тогда
		
		// Формат имени по ЭСФ: DP_UVUTOCH_ИдПолучателя_ИдОтправителя_ГГГГММДД_GUID.
		ТекстИд = НСтр("ru = 'DP_UVUTOCH_%1_%2_%3_%4'");
		ТекстИд = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстИд, СтруктураЭД.ИдПолучателя,
			СтруктураЭД.ИдОтправителя, ВернутьДатуСтрокойДляИД(ТекущаяДатаСеанса()), СтруктураЭД.НомерЭД);
	ИначеЕсли СтруктураЭД.ВидЭД= Перечисления.ВидыЭД.ПредложениеОбАннулировании Тогда
		
		// Формат имени по ЭСФ: DP_PRANNUL_ИдПолучателя_ИдОтправителя_ГГГГММДД_GUID.
		ТекстИд = НСтр("ru = 'DP_PRANNUL_%1_%2_%3_%4'");
		ТекстИд = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстИд, СтруктураЭД.ИдПолучателя,
			СтруктураЭД.ИдОтправителя, ВернутьДатуСтрокойДляИД(ТекущаяДатаСеанса()), СтруктураЭД.НомерЭД);
	КонецЕсли;
	
	ИдФайлаЭД = ОбменСКонтрагентамиСлужебный.КорректноеИмяФайла(ТекстИд);
	
	Возврат ИдФайлаЭД;
	
КонецФункции

Функция ВернутьДатуСтрокойДляИД(ДатаВремя)
	
	Возврат Формат(ДатаВремя, "ДФ=yyyyMMdd");
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Просмотр уведомлений об уточнении

// Процедура заполняет табличный документ Уведомление об уточнении.
//
Процедура ЗаполнитьТабличныйДокументУточнение(ТабличныйДокумент, ДанныеПечати)
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_Уточнение";
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_Уточнение_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ТекстЗаголовка = НСтр("ru='Уведомление об уточнении'");
	ОбластьМакета.Параметры.ТекстЗаголовка = ТекстЗаголовка;
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Заголовок");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ЗаполнитьЗначенияСвойств(ОбластьМакета.Параметры, ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
КонецПроцедуры

Процедура ПрочитатьУточнениеXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИмяФайла",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвУведУточ.СведПолФайл.ИмяПостФайла"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.ОтпрДок")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.УчастЭДО")));
	
	Если ЗначениеСвойстваXDTO(ЭД, "Документ.СвУведУточ.ДатаВремяПол") <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПолучения",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СвУведУточ.ДатаВремяПол", "Дата"));
	Иначе
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаПолучения",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СвУведУточ.ДатаПол"));
			
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ВремяПолучения",
			ЗначениеСвойстваXDTO(ЭД, "Документ.СвУведУточ.ВремяПол"));
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТекстУточнения",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвУведУточ.ТекстУведУточ"));
		
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПараметрЗаголовка", "");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента",
		ЗначениеСвойстваXDTO(ЭД, "ИдФайл"));
	
КонецПроцедуры

Функция ПолучитьДанныеУточненияДляПечати(СтрокаОбъекта, ДеревоРазбора, ИД)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	ДанныеЗаполненияШапки.Вставить("Отправитель", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Отправитель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторОтправителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторОтправителя"));
	ДанныеЗаполненияШапки.Вставить("Получатель",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Получатель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторПолучателя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторПолучателя"));
	ДанныеЗаполненияШапки.Вставить("ДатаПолучения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ДатаПолучения"));
	ДанныеЗаполненияШапки.Вставить("ВремяПолучения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ВремяПолучения"));
	ДанныеЗаполненияШапки.Вставить("ТекстУточнения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ТекстУточнения"));
	ДанныеЗаполненияШапки.Вставить("ИмяФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ИмяФайла"));
	
	ЭДУточнение = Справочники.ЭДПрисоединенныеФайлы.ПолучитьСсылку(ИД);
	
	Если ЭДУточнение.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДПЭСФ;
	Иначе
		ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОЭСФ;
	КонецЕсли;
	
	СтруктураПараметровПоиска = Новый Структура;
	СтруктураПараметровПоиска.Вставить("УникальныйИД",        ЭДУточнение.УникальныйИД);
	СтруктураПараметровПоиска.Вставить("НаправлениеЭД",       Перечисления.НаправленияЭД.Входящий);
	СтруктураПараметровПоиска.Вставить("ТипЭлементаВерсииЭД", ТипЭлементаВерсииЭД);
	ЭДПодтверждениеДаты = ОбменСКонтрагентамиСлужебный.ОпределитьЭлектронныйДокумент(СтруктураПараметровПоиска);
	
	Если ЭДПодтверждениеДаты <> Неопределено Тогда
		ДопИнформацияПоЭД = ОбменСКонтрагентамиСлужебный.ПолучитьДанныеФайла(ЭДПодтверждениеДаты, , Истина);
		Если ДопИнформацияПоЭД.Свойство("СсылкаНаДвоичныеДанныеФайла")
			И ЗначениеЗаполнено(ДопИнформацияПоЭД.СсылкаНаДвоичныеДанныеФайла) Тогда
			
			ДанныеЭД = ПолучитьИзВременногоХранилища(ДопИнформацияПоЭД.СсылкаНаДвоичныеДанныеФайла);
			Если ЗначениеЗаполнено(ДопИнформацияПоЭД.Расширение) Тогда
				ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла(ДопИнформацияПоЭД.Расширение);
			Иначе
				ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
			КонецЕсли;
			
			Если ИмяФайла <> Неопределено Тогда
				
				ДанныеЭД.Записать(ИмяФайла);
				
				СтруктураПодтверждения = СформироватьДеревоРазбора(ИмяФайла, ЭДПодтверждениеДаты.НаправлениеЭД);
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
				Если СтруктураПодтверждения <> Неопределено И СтруктураПодтверждения.Количество() > 0 Тогда
					ДанныеЗаполненияШапки.Вставить("ДатаОтправления", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
						СтруктураПодтверждения.ДеревоРазбора, СтруктураПодтверждения.СтрокаОбъекта, "ДатаОтправки"));
					ДанныеЗаполненияШапки.Вставить("ВремяОтправления", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(
						СтруктураПодтверждения.ДеревоРазбора, СтруктураПодтверждения.СтрокаОбъекта, "ВремяОтправки"));
					ДанныеЗаполненияШапки.Вставить("ОператорЭДО", НСтр("ru = 'оператора электронного документооборота'") + " "
						+ ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(СтруктураПодтверждения.ДеревоРазбора,
						СтруктураПодтверждения.СтрокаОбъекта, "ОператорЭДО"));
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка", ДанныеЗаполненияШапки);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

// Для того, чтобы передать дополнительные данные в печатную форму, надо:
// 1. в функции подготовки данных (в переопределяемом модуле) создать структуру, где ключ - имя передаваемого
//  дополнительного параметра, а значение - соответственно, значение доп.параметра и передать в интерфейсную функцию
//  "ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных" (описание параметров в комментарии к ней).
// 2. в функции подготовки данных к печати "ПолучитьДанные...ДляПечати", прописать чтение передаваемых
//  доп.данных по имени (с которым доп параметр помещался в структуру на шаге 1) и присвоение требуемому реквизиту макета.
//
Функция ДеревоДопДанных()
	
	ДеревоДанных = Новый ДеревоЗначений;
	
	МассивТипов = Новый Массив;
	МассивТипов.Добавить(Тип("Структура"));
	МассивТипов.Добавить(Тип("Массив"));
	МассивТипов.Добавить(Тип("Строка"));
	ТипСтруктураМассивСтрока = Новый ОписаниеТипов(МассивТипов);
	
	ДеревоДанных.Колонки.Добавить("ИмяРеквизита", Новый ОписаниеТипов("Строка"));
	ДеревоДанных.Колонки.Добавить("ЗначениеРеквизита", ТипСтруктураМассивСтрока);
	ДеревоДанных.Колонки.Добавить("ЮридическиЗначимый", Новый ОписаниеТипов("Булево"));
	ДеревоДанных.Колонки.Добавить("ТЧ", Новый ОписаниеТипов("Булево"));
	
	Возврат ДеревоДанных;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Заполнение дерева объектов разбора и дерева соответствий объектам

Процедура СформироватьТЗПоНаборуДанныхXDTO(ТЗ, НаборДанных, СсылкаНаЭД, ДопПараметры = Неопределено) 
	
	ДеревоДопДанных = Неопределено;
	ЕстьСвойствоИдФайл = Ложь;
	ИмяТЧ = Неопределено;
	НомерСтроки = Неопределено;
	ИменаДопКолонок = "";
	
	Если ТипЗнч(ДопПараметры) = Тип("Структура") Тогда 
		
		ДопПараметры.Свойство("ДеревоДопДанных",	ДеревоДопДанных);
		ДопПараметры.Свойство("ИмяТЧ",				ИмяТЧ);
		ДопПараметры.Свойство("НомерСтроки",		НомерСтроки);
		
		Если ДопПараметры.Свойство("ЕстьСвойствоИдФайл") Тогда 
			ЕстьСвойствоИдФайл = ДопПараметры.ЕстьСвойствоИдФайл;
		КонецЕсли;
		Если ДопПараметры.Свойство("ИменаДопКолонок") Тогда 
			ИменаДопКолонок = ДопПараметры.ИменаДопКолонок;
		КонецЕсли;
		
	КонецЕсли;
	
	КС80 = Новый КвалификаторыСтроки(110);
	КС255 = Новый КвалификаторыСтроки(255);
	КС3000 = Новый КвалификаторыСтроки(3000);
	МассивСтрока = Новый Массив;
	МассивСтрока.Добавить(Тип("Строка"));
	ОписаниеТиповС80 = Новый ОписаниеТипов(МассивСтрока, , КС80);
	ОписаниеТиповС255 = Новый ОписаниеТипов(МассивСтрока, , КС255);
	ОписаниеТиповС3000 = Новый ОписаниеТипов(МассивСтрока, , КС3000);
	МассивТипЭД = Новый Массив;
	МассивТипЭД.Добавить(Тип("СправочникСсылка.ЭДПрисоединенныеФайлы"));
	МассивТипЭД.Добавить(Тип("Структура"));
	ОписаниеТиповЭД = Новый ОписаниеТипов(МассивТипЭД);
	
	ТЗ = Новый ТаблицаЗначений();
	ТЗ.Колонки.Добавить("ИД", ОписаниеТиповС80);
	ТЗ.Колонки.Добавить("Наименование", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("НаименованиеХарактеристики", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("КодТовара", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("Артикул", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("БазоваяЕдиницаКод", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("БазоваяЕдиницаНаименование", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("БазоваяЕдиницаНаименованиеПолное", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("БазоваяЕдиницаМеждународноеСокращение", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("Описание", ОписаниеТиповС3000);
	ТЗ.Колонки.Добавить("ЭД", ОписаниеТиповЭД);
	
	СвойстваНоменклатуры = Новый Структура;
	Для Каждого Колонка Из ТЗ.Колонки Цикл
		СвойстваНоменклатуры.Вставить(Колонка.Имя, Неопределено);
	КонецЦикла;
	
	Для Каждого ТекЭлемент Из НаборДанных Цикл
		
		Элемент = ТекЭлемент;
		НаименованиеРаботыДопДанные = "";
		Если ЕстьСвойствоИдФайл
			И ЕстьСвойствоXDTO(ТекЭлемент, "ИнфПолСтр")
			И (ЗначениеЗаполнено(ТекЭлемент.ИнфПолСтр) ИЛИ Не ДеревоДопДанных = Неопределено) Тогда
			
			Если СтрНайти(ТекЭлемент.ИнфПолСтр, "xml") = 0 Тогда
				СвойстваТекЭлемента = ТекЭлемент.Свойства();
				Если СвойстваТекЭлемента.Получить("НомТов") <> Неопределено Тогда
					НомСтр = Строка(ТекЭлемент.НомТов);
				ИначеЕсли СвойстваТекЭлемента.Получить("НомСтр") <> Неопределено Тогда
					НомСтр = Строка(ТекЭлемент.НомСтр);
				ИначеЕсли СвойстваТекЭлемента.Получить("Номер") <> Неопределено Тогда
					НомСтр = Строка(НомерСтроки) + "." + ТекЭлемент.Номер;
				Иначе
					Продолжить;
				КонецЕсли;
				
				// Зачитаем параметры строки ТЧ из доп. данных.
				ПрочитатьИнфПол(ТекЭлемент.ИнфПолСтр, ДеревоДопДанных, ИмяТЧ, НомСтр);
				Если ДеревоДопДанных <> Неопределено И ДеревоДопДанных.Строки.Количество() > 0 Тогда
					СтруктураПоиска = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Список", ИмяТЧ);
					СтрокиДерева = ДеревоДопДанных.Строки.НайтиСтроки(СтруктураПоиска, Истина);
					Если СтрокиДерева.Количество() > 0 Тогда
						СтруктураПоиска = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Нпп", НомСтр);
						СтрокиДерева = СтрокиДерева[0].Строки.НайтиСтроки(СтруктураПоиска);
						Если СтрокиДерева.Количество() > 0 Тогда
							СтрокаВладелец = СтрокиДерева[0];
							СтрокаИД = СтрокаВладелец.Строки.Найти("ИД", "ИмяРеквизита");
							СтрокаБЕНаименованиеПолное = СтрокаВладелец.Строки.Найти("БазоваяЕдиницаНаименованиеПолное", "ИмяРеквизита");
							СтрокаБЕМСокращение = СтрокаВладелец.Строки.Найти("БазоваяЕдиницаМеждународноеСокращение", "ИмяРеквизита");
							СтрокаБЕНаименование = СтрокаВладелец.Строки.Найти("БазоваяЕдиницаНаименование", "ИмяРеквизита");
							СтрокаБЕКод = СтрокаВладелец.Строки.Найти("БазоваяЕдиницаКод", "ИмяРеквизита");
							Если СтрокаИД <> Неопределено Тогда
								СвойстваНоменклатуры.ИД = СтрокаИД.ЗначениеРеквизита;
							КонецЕсли;
							Если СтрокаБЕНаименованиеПолное <> Неопределено Тогда
								СвойстваНоменклатуры.БазоваяЕдиницаНаименованиеПолное = СтрокаБЕНаименованиеПолное.ЗначениеРеквизита;
							КонецЕсли;
							Если СтрокаБЕМСокращение <> Неопределено Тогда
								СвойстваНоменклатуры.БазоваяЕдиницаМеждународноеСокращение = СтрокаБЕМСокращение.ЗначениеРеквизита;
							КонецЕсли;
							Если СтрокаБЕНаименование <> Неопределено Тогда
								СвойстваНоменклатуры.БазоваяЕдиницаНаименование = СтрокаБЕНаименование.ЗначениеРеквизита;
							КонецЕсли;
							Если СтрокаБЕКод <> Неопределено Тогда
								СвойстваНоменклатуры.БазоваяЕдиницаКод = СтрокаБЕКод.ЗначениеРеквизита;
							КонецЕсли;
							// В некоторых случаях наименование работы может передаваться через доп данные.
							СтрокаНаименованиеРаботы = СтрокаВладелец.Строки.Найти("Наименование", "ИмяРеквизита");
							Если Не СтрокаНаименованиеРаботы = Неопределено Тогда
								 НаименованиеРаботыДопДанные = СтрокаНаименованиеРаботы.ЗначениеРеквизита;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ Элемент.Свойства().Получить("Наименование") = Неопределено Тогда
			СвойстваНоменклатуры.Наименование = Элемент.Наименование;
		КонецЕсли;
		Если НЕ ТекЭлемент.Свойства().Получить("НаимРабот") = Неопределено Тогда
			СвойстваНоменклатуры.Наименование = ТекЭлемент.НаимРабот;
			
			Если Не ЗначениеЗаполнено(СвойстваНоменклатуры.Наименование)
				И НЕ ТекЭлемент.Свойства().Получить("Описание") = Неопределено Тогда
				СвойстваНоменклатуры.Наименование = ТекЭлемент.Описание;
			КонецЕсли;
		КонецЕсли;
		Если НЕ ТекЭлемент.Свойства().Получить("НаимТов") = Неопределено Тогда
			СвойстваНоменклатуры.Наименование = ТекЭлемент.НаимТов;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(СвойстваНоменклатуры.Наименование) Тогда
			СвойстваНоменклатуры.Наименование = НаименованиеРаботыДопДанные;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СвойстваНоменклатуры.Наименование) Тогда
			Продолжить;
		КонецЕсли;
		
		НовЗапись = ТЗ.Добавить();
		ЗаполнитьЗначенияСвойств(НовЗапись, СвойстваНоменклатуры);
		НовЗапись.ЭД = СсылкаНаЭД;
		
		Если НЕ Элемент.Свойства().Получить("ИД") = Неопределено Тогда
			НовЗапись.ИД = Элемент.ИД;
		КонецЕсли;
		
		Если ЕстьСвойствоXDTO(Элемент, "ИнфПолФХЖ2") Тогда
			 НовЗапись.ИД = ЗначениеДопРеквизита(Элемент.ИнфПолФХЖ2, "ИД");
		КонецЕсли;
		
		Если ЕстьСвойствоXDTO(Элемент, "ИнфПолеОписРабот") Тогда
			 НовЗапись.ИД = ЗначениеДопРеквизита(Элемент.ИнфПолеОписРабот, "ИД");
		КонецЕсли;
		
		// В CML документах Ид товара передается через доп данные, которые находятся в значении реквизитов.
		Если Не ЗначениеЗаполнено(НовЗапись.ИД) Тогда
			Ид = ЗначениеИДТовараДопДанныхСтроки(Элемент);
			НовЗапись.ИД = Ид;
		КонецЕсли;
		
		Если НЕ ТекЭлемент.Свойства().Получить("КодТов") = Неопределено Тогда
			НовЗапись.КодТовара = ТекЭлемент.КодТов;
		КонецЕсли;
		Если НЕ ТекЭлемент.Свойства().Получить("ХарактерТов") = Неопределено Тогда
			НовЗапись.НаименованиеХарактеристики = ТекЭлемент.ХарактерТов;
		КонецЕсли;
		Если НЕ ТекЭлемент.Свойства().Получить("ОКЕИ_Тов") = Неопределено Тогда
			НовЗапись.БазоваяЕдиницаКод = ТекЭлемент.ОКЕИ_Тов;
		КонецЕсли;
		Если НЕ ТекЭлемент.Свойства().Получить("ОКЕИ") = Неопределено Тогда
			НовЗапись.БазоваяЕдиницаКод = ТекЭлемент.ОКЕИ;
		КонецЕсли;
		Если НЕ ТекЭлемент.Свойства().Получить("НаимЕдИзм") = Неопределено Тогда
			НовЗапись.БазоваяЕдиницаНаименование = ТекЭлемент.НаимЕдИзм;
		КонецЕсли;
		Если НЕ Элемент.Свойства().Получить("БазоваяЕдиница") = Неопределено Тогда
			Если НЕ Элемент.БазоваяЕдиница.Свойства().Получить("Код") = Неопределено Тогда
				НовЗапись.БазоваяЕдиницаКод = Элемент.БазоваяЕдиница.Код;
			КонецЕсли;
			Если НЕ Элемент.БазоваяЕдиница.Свойства().Получить("Наименование") = Неопределено Тогда
				НовЗапись.БазоваяЕдиницаНаименование = Элемент.БазоваяЕдиница.Наименование;
			КонецЕсли;
			Если НЕ Элемент.БазоваяЕдиница.Свойства().Получить("НаименованиеПолное") = Неопределено Тогда
				НовЗапись.БазоваяЕдиницаНаименованиеПолное = Элемент.БазоваяЕдиница.НаименованиеПолное;
			КонецЕсли;
			Если НЕ Элемент.БазоваяЕдиница.Свойства().Получить("МеждународноеСокращение") = Неопределено Тогда
				НовЗапись.БазоваяЕдиницаМеждународноеСокращение = Элемент.БазоваяЕдиница.МеждународноеСокращение;
			КонецЕсли;
		КонецЕсли;
		Если НЕ Элемент.Свойства().Получить("Артикул") = Неопределено Тогда
			НовЗапись.Артикул = Элемент.Артикул;
		КонецЕсли;
		Если НЕ Элемент.Свойства().Получить("АртикулТов") = Неопределено Тогда
			НовЗапись.Артикул = Элемент.АртикулТов;
		КонецЕсли;
		Если НЕ Элемент.Свойства().Получить("Описание") = Неопределено Тогда
			НовЗапись.Описание = Элемент.Описание;
		КонецЕсли;
		Если НЕ Элемент.Свойства().Получить("ДополнительныеРеквизиты") = Неопределено Тогда
			Для Каждого ЭлементДанных Из Элемент.ДополнительныеРеквизиты Цикл
				Если ТЗ.Колонки.Найти("Доп_" + ЭлементДанных.Наименование) = Неопределено Тогда
					ТЗ.Колонки.Добавить("Доп_" + ЭлементДанных.Наименование, ОписаниеТиповС255);
					ИменаДопКолонок = ИменаДопКолонок + ", "+ "Доп_" + ЭлементДанных.Наименование;
				КонецЕсли;
				Для Каждого ЭлементЗначения Из ЭлементДанных.Значение Цикл
					НовЗапись["Доп_" + ЭлементДанных.Наименование] = ЭлементЗначения;
				КонецЦикла;
			КонецЦикла;
		КонецЕсли;
		
		// Если пришел пустой ИД, используем вместо него наименование товара.
		// Актуально для входящих ЭД из учетных систем отличных от 1С.
		Если Не ЗначениеЗаполнено(НовЗапись.ИД) Тогда
			НовЗапись.ИД = ИдентификаторТовараПоСтроке(ВРег(СтрЗаменить(НовЗапись.Наименование, " ", ""))
				+ "#" + ВРег(СтрЗаменить(НовЗапись.НаименованиеХарактеристики, " ", ""))
				+ "#" + ВРег(СтрЗаменить(НовЗапись.КодТовара, " ", ""))
				+ "#" + ВРег(СтрЗаменить(НовЗапись.Артикул, " ", "")));
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция ЗначениеИДТовараДопДанныхСтроки(СтрокаXDTO)
	
	СоставнойИД = ЗначениеСвойстваДопДанныхСтроки(СтрокаXDTO, "Ид");
	
	Возврат СоставнойИД;
	
КонецФункции

Функция ЗначениеДопРеквизита(КоллекцияЗначений, ИмяРеквизита)
	
	Результат = Неопределено;
	Для Каждого КлючЗначение Из КоллекцияЗначений Цикл
		
		Если ВРег(КлючЗначение.Идентиф) = ВРег(ИмяРеквизита) Тогда
			Результат = КлючЗначение.Значен;
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ЗначениеСвойстваДопДанныхСтроки(СтрокаXDTO, ИмяСвойства)
	
	ДопДанные = ЗначениеДопРеквизитаДокумента("ДопДанныеСтроки", СтрокаXDTO);
	
	ДопДерево = ДеревоДопДанных();
	
	ПрочитатьИнфПол(ДопДанные, ДопДерево, "СтрокаТЧ");
	
	СтрокаТЧ = ДопДерево.Строки.Найти("СтрокаТЧ", "ЗначениеРеквизита");
	Если СтрокаТЧ = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	СтрокаРеквизита = СтрокаТЧ.Строки.Найти(ИмяСвойства, "ИмяРеквизита");
	Если СтрокаРеквизита = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	Возврат СтрокаРеквизита.ЗначениеРеквизита;
	
КонецФункции

Процедура СформироватьСтруктуруПоДопДанным(Дерево, СтруктураДопДанных)
	
	Для Каждого СтрокаДерева Из Дерево.Строки Цикл
		Если СтрокаДерева.ИмяРеквизита = "Набор" Тогда
			Структура = Новый Структура;
			СформироватьСтруктуруПоДопДанным(СтрокаДерева, Структура);
			СтруктураДопДанных.Вставить(СтрокаДерева.ЗначениеРеквизита, Структура);
		ИначеЕсли СтрокаДерева.ИмяРеквизита = "Массив" Тогда
			СтруктураДопДанных.Вставить(СтрокаДерева.ЗначениеРеквизита, СтрокаДерева.Строки.ВыгрузитьКолонку("ЗначениеРеквизита"));
		Иначе
			СтруктураДопДанных.Вставить(СтрокаДерева.ИмяРеквизита, СтрокаДерева.ЗначениеРеквизита);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Процедура "восстанавливает" набор данных в таблицу значений. Если при формировании ЭД в доп.данные
// была помещена таблица значений, то при разборе ЭД набор данных (из доп.данных) преобразуется в таблицу значений.
//
// Параметры:
//   Дерево - ДеревоЗначений - набор доп.данных прочитанных из ЭД.
//   ТЗ - ТаблицаЗначений - таблица значений сформированная по данным из дерева значений.
//
Процедура СформироватьТаблицуЗначенийПоДопДанным(Дерево, ТЗ)
	
	Для Каждого СтрокаТЗвДереве Из Дерево.Строки Цикл
		СтрокаТЗ = Неопределено;
		Для Каждого ЗначениеЯчейкиТЗ Из СтрокаТЗвДереве.Строки Цикл
			Если СтрокаТЗвДереве.ЗначениеРеквизита = "0" Тогда // 0-я строка ТЗ в дереве
				ТЗ.Колонки.Добавить(ЗначениеЯчейкиТЗ.ИмяРеквизита);
			КонецЕсли;
			Если СтрокаТЗ = Неопределено Тогда
				СтрокаТЗ = ТЗ.Добавить();
			КонецЕсли;
			Если ТЗ.Колонки.Найти(ЗначениеЯчейкиТЗ.ИмяРеквизита) = Неопределено Тогда
				ТЗ.Колонки.Добавить(ЗначениеЯчейкиТЗ.ИмяРеквизита);
			КонецЕсли;
			СтрокаТЗ[ЗначениеЯчейкиТЗ.ИмяРеквизита] = ЗначениеЯчейкиТЗ.ЗначениеРеквизита;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Функция ЗаполнитьШапкуПоДопДанным(ДеревоДопДанных, НовыйЭД, Ошибка)
	
	ВозвращаемоеЗначение = Ложь;
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		СтруктураОтбора = Новый Структура("ИмяРеквизита", "Набор");
		СтрокиДопДанные = ДеревоДопДанных.Строки.НайтиСтроки(СтруктураОтбора);
		Для Каждого СтрокаДопДанных Из СтрокиДопДанные Цикл
			Для Каждого СтрокаДерева Из СтрокаДопДанных.Строки Цикл
				Если СтрокаДерева.ИмяРеквизита = "Набор" Тогда
					Структура = Новый Структура;
					СформироватьСтруктуруПоДопДанным(СтрокаДерева, Структура);
					ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, СтрокаДерева.ЗначениеРеквизита, Структура);
				ИначеЕсли СтрокаДерева.ИмяРеквизита = "Массив" Тогда
					НовСтрока = Неопределено;
					Для Каждого Строка Из СтрокаДерева.Строки Цикл
						Если Строка.ЗначениеРеквизита = "Структура" Тогда
							Если НовСтрока = Неопределено Тогда
								НовСтрока                   = НовыйЭД.Строки.Добавить();
								НовСтрока.Реквизит          = СтрокаДерева.ЗначениеРеквизита;
								НовСтрока.ЗначениеРеквизита = СтрокаДерева.ИмяРеквизита;
							КонецЕсли;
							Структура = Новый Структура;
							СформироватьСтруктуруПоДопДанным(Строка, Структура);
							ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовСтрока, Строка.ИмяРеквизита, Структура);
						Иначе
							ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, Строка.ЗначениеРеквизита, Строка.Строки.ВыгрузитьКолонку("ЗначениеРеквизита"));
							Прервать;
						КонецЕсли;
					КонецЦикла;
				ИначеЕсли СтрокаДопДанных.ЗначениеРеквизита = "Шапка" И СтрокаДерева.ИмяРеквизита = "Список" Тогда
					ТЗ = Новый ТаблицаЗначений;
					СформироватьТаблицуЗначенийПоДопДанным(СтрокаДерева, ТЗ);
					ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, СтрокаДерева.ЗначениеРеквизита, ТЗ);
				Иначе
					ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, СтрокаДерева.ИмяРеквизита, СтрокаДерева.ЗначениеРеквизита);
				КонецЕсли;
			КонецЦикла;
			ВозвращаемоеЗначение = Истина;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция ЗаполнитьСтрокуТЧПоДопДанным(ДеревоДопДанных, СписокТЧ, НомерСтроки, ИмяТЧ, Ошибка, ЮридическиЗначимый = Истина)
	
	ВозвращаемоеЗначение = Ложь;
	
	Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		СтруктураОтбора = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Список", ИмяТЧ);
		СтрокиШапкиДопДанные = ДеревоДопДанных.Строки.НайтиСтроки(СтруктураОтбора);
		Если СтрокиШапкиДопДанные.Количество() > 0 Тогда
			СтруктураОтбора = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Нпп", Строка(НомерСтроки));
			СтрокиТЧДопДанные = СтрокиШапкиДопДанные[0].Строки.НайтиСтроки(СтруктураОтбора);
			Если СтрокиТЧДопДанные.Количество() > 0 Тогда
				Для Каждого СтрокаДерева Из СтрокиТЧДопДанные[0].Строки Цикл
					
					Если Не СтрокаДерева.ЮридическиЗначимый = ЮридическиЗначимый Тогда
						Продолжить;
					КонецЕсли;
					
					Если СтрокаДерева.ИмяРеквизита = "Набор" Тогда
						Структура = Новый Структура;
						СформироватьСтруктуруПоДопДанным(СтрокаДерева, Структура);
						СписокТЧ.Добавить(Структура, СтрокаДерева.ЗначениеРеквизита);
					ИначеЕсли СтрокаДерева.ИмяРеквизита = "Массив" Тогда
						СписокТЧ.Добавить(СтрокаДерева.Строки.ВыгрузитьКолонку("ЗначениеРеквизита"), СтрокаДерева.ЗначениеРеквизита);
						
					ИначеЕсли СтрокаДерева.ИмяРеквизита = "Список" Тогда
						
						ТаблицаДопДанных = Новый ТаблицаЗначений;
						ТаблицаДопДанных.Колонки.Добавить("ИмяРеквизита");
						ТаблицаДопДанных.Колонки.Добавить("ЗначениеРеквизита");
						ТаблицаДопДанных.Колонки.Добавить("ЮридическиЗначимый");
						
						НаименованиеРеквизита = СтрокаДерева.ЗначениеРеквизита;
						ПрочитатьСтрокиДереваРекурсивно(СтрокаДерева.Строки, ТаблицаДопДанных, СтрокаДерева.ЗначениеРеквизита);
						СписокТЧ.Добавить(ТаблицаДопДанных, НаименованиеРеквизита);
						
					ИначеЕсли ВРег(СтрокаДерева.ИмяРеквизита) = ВРег("КодОКЕИ") Тогда
						СписокТЧ.Добавить(СтрокаДерева.ЗначениеРеквизита, "ОКЕИ_Тов");
					ИначеЕсли ВРег(СтрокаДерева.ИмяРеквизита) = ВРег("КодОКЕИДо") Тогда
						СписокТЧ.Добавить(СтрокаДерева.ЗначениеРеквизита, "ОКЕИ_ТовДо");
					ИначеЕсли ВРег(СтрокаДерева.ИмяРеквизита) = ВРег("КодОКЕИПосле") Тогда
						СписокТЧ.Добавить(СтрокаДерева.ЗначениеРеквизита, "ОКЕИ_ТовПосле");
					ИначеЕсли ВРег(СтрокаДерева.ИмяРеквизита) = ВРег("ДопДанныеТаможеннойДекларации") Тогда
						СписокТЧ.Добавить("ДопДанныеТаможеннойДекларации", СтрокаДерева.ЗначениеРеквизита);
					Иначе
						СписокТЧ.Добавить(СтрокаДерева.ЗначениеРеквизита, СтрокаДерева.ИмяРеквизита);
					КонецЕсли;
				КонецЦикла;
				ВозвращаемоеЗначение = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция ПространствоИменАкта(ДанныеФайлаЭД, ИдентификаторЭД)
	
	ФлагФНС =0;
	Если СтрДлина(ДанныеФайлаЭД.Документ.ВремДок) = 8 Тогда   // например 12.45.55
		ФлагФНС = 1;
	Иначе
		ФлагФНС = 2;
	КонецЕсли;
	Если ДанныеФайлаЭД.СвУчДокОбор.Свойства().Получить("СвОЭДОтпрСФ") <> Неопределено Тогда
		ФлагФНС = 3;
	КонецЕсли;
	
	ПространствоИмен = ИмяПространстваТитула(ФлагФНС, ИдентификаторЭД);
	
	Возврат ПространствоИмен;
	
КонецФункции

Функция ИмяПространстваТитула(ФлагФНС, ИдентификаторЭД)
	
	// Имена для Акта исполнителя
	АктыИсполнителя = Новый Соответствие;
	АктыИсполнителя.Вставить(1, "IAKTPRM");
	АктыИсполнителя.Вставить(2, "IAKTPRM2");
	АктыИсполнителя.Вставить(3, "IAKTPRM_5_01_02");
	
	// Имена для Акта заказчика
	АктыЗаказчика = Новый Соответствие;
	АктыЗаказчика.Вставить(1, "ZAKTPRM");
	АктыЗаказчика.Вставить(2, "ZAKTPRM2");
	АктыЗаказчика.Вставить(3, "ZAKTPRM_5_01_02");
	
	// Имена для Титула продавца
	ТитулыПокупателя = Новый Соответствие;
	ТитулыПокупателя.Вставить(1, "PTORG12");
	ТитулыПокупателя.Вставить(2, "PTORG12");
	ТитулыПокупателя.Вставить(3, "PTORG_5_01_02");
	
	// Имена для Титула покупателя
	ТитулыПродавца = Новый Соответствие;
	ТитулыПродавца.Вставить(1, "OTORG12");
	ТитулыПродавца.Вставить(2, "OTORG12");
	ТитулыПродавца.Вставить(3, "OTORG_5_01_02");

	
	ИменаВидовЭД = Новый Соответствие;
	ИменаВидовЭД.Вставить("IAKTPRM", АктыИсполнителя);
	ИменаВидовЭД.Вставить("ZAKTPRM", АктыЗаказчика);
	ИменаВидовЭД.Вставить("PTORG12", ТитулыПокупателя);
	ИменаВидовЭД.Вставить("OTORG12", ТитулыПродавца);
	
	ТаблицаИмен = ИменаВидовЭД.Получить(ИдентификаторЭД);
	
	ИмяПространства = ТаблицаИмен.Получить(ФлагФНС);
	
	Возврат ИмяПространства;
	
КонецФункции

// Разбор xml-файла/строки

Функция РекурсивноРазобратьДопФайл(ОбъектРазбора, ДеревоДопДанных, ЮридическиЗначимый = Ложь)
	
	Реквизиты = ЗначениеСвойстваXDTO(ОбъектРазбора, "Реквизит",, Истина);
	
	Для Каждого Реквизит Из Реквизиты Цикл
		
		РеквизитИмя      = ЗначениеСвойстваXDTO(Реквизит, "Имя");
		РеквизитЗначение = ЗначениеСвойстваXDTO(Реквизит, "Значение");
		
		Если Не ЗначениеЗаполнено(РеквизитИмя) Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураОтбора = Новый Структура(
			"ИмяРеквизита, ЗначениеРеквизита", РеквизитИмя, РеквизитЗначение);
			
		СтрокиДЗ = ДеревоДопДанных.Строки.НайтиСтроки(СтруктураОтбора);
		Если СтрокиДЗ.Количество() <> 0 Тогда
			СтрДЗ = СтрокиДЗ[0];
		Иначе
			СтрДЗ = ДеревоДопДанных.Строки.Добавить();
			СтрДЗ.ИмяРеквизита       = РеквизитИмя;
			СтрДЗ.ЗначениеРеквизита  = РеквизитЗначение;
			СтрДЗ.ЮридическиЗначимый = ЮридическиЗначимый;
		КонецЕсли;
		
		Если ЗначениеСвойстваXDTO(Реквизит, "Реквизит") <> Неопределено Тогда
			РекурсивноРазобратьДопФайл(Реквизит, СтрДЗ, ЮридическиЗначимый);
		КонецЕсли;
		
	КонецЦикла;
	
КонецФункции

// Универсальный доп. файл, представляет из себя дерево с неограниченным уровнем вложений. Каждый элемент дерева имеет
// реквизиты (Имя, Значение) и подчиненные элементы (ветки), с таким же составом, как и у текущего элемента.
//
// Параметры:
//  ДопФайл - строка - полный путь к файлу.
//
// Возвращаемое значение - Неопределено, либо ДеревоЗначений.
//
Функция РазобратьУниверсальныйДопФайл(ДопФайл)
	
	ДеревоДопДанных = ДеревоДопДанных();
	Если СтрНайти(ДопФайл, ".xml") = 0 Тогда
		Возврат ДеревоДопДанных;
	КонецЕсли;

	ОбъектXML = Новый ЧтениеXML;
		
	Попытка
		ОбъектXML.ОткрытьФайл(ДопФайл);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML, ПолучитьТипЗначенияCML("ДопФайл", "ДопФайлУниверсальный"));
		ОбъектXML.Закрыть();
		Если ЭД.Данные <> Неопределено Тогда
			РекурсивноРазобратьДопФайл(ЭД.Данные, ДеревоДопДанных);
		КонецЕсли;
	Исключение
		ДеревоДопДанных = Неопределено;
		ОбъектXML.Закрыть();
		ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из файла %1: %2.'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			ДопФайл, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
	КонецПопытки;
	
	Возврат ДеревоДопДанных;
	
КонецФункции

Процедура ПрочитатьИнфПол(Знач СтрокаXML, ДеревоДопДанных, ИмяНабораДанных, НомерСтроки = Неопределено)
	
	// Тег <Данные> - обязательный для xml-строки в формате универсального доп.файла.
	Если СтрНайти(СтрокаXML, "<Данные>") > 0 Тогда
		
		СтрокаXML = "<ДопФайл ИдФайла=""1"" ИдДопФайла=""1"" ВерсияФормата=""1"" ДатаФормирования=""2000-01-01T00:00:00"" xmlns=""ДопФайлУниверсальный"">"
			+ СтрокаXML + "</ДопФайл>";
			
		ДеревоСозданоРаньше = Истина;
		Если ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
			ДеревоДопДанных = ДеревоДопДанных();
			ДеревоСозданоРаньше = Ложь;
		КонецЕсли;
		
		ОбъектXML = Новый ЧтениеXML;
		Попытка
			ОбъектXML.УстановитьСтроку(СтрокаXML);
			ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
			ОбъектXML.Закрыть();
			Если ЗначениеСвойстваXDTO(ЭД, "Данные") <> Неопределено Тогда
				СтрокаДЗ = ДеревоДопДанных.Строки.Найти(ИмяНабораДанных, "ЗначениеРеквизита");
				Если СтрокаДЗ = Неопределено Тогда
					СтрокаДЗ = ДеревоДопДанных.Строки.Добавить();
					СтрокаДЗ.ЗначениеРеквизита = ИмяНабораДанных;
					Если НомерСтроки = Неопределено Тогда
						СтрокаДЗ.ИмяРеквизита = "Набор";
					Иначе
						СтрокаДЗ.ИмяРеквизита = "Список";
					КонецЕсли;
				КонецЕсли;
				Если НомерСтроки <> Неопределено Тогда
					СтрокиДЗ = СтрокаДЗ.Строки.НайтиСтроки(Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Нпп", Строка(НомерСтроки)));
					
					// Поиск подчиненных по разделителю "."
					ИндексРазделителяНомера = СтрНайти(Строка(НомерСтроки), ".");
					Если ИндексРазделителяНомера Тогда
						СтрокаПоискаРодителя = Лев(Строка(НомерСтроки), ИндексРазделителяНомера - 1);
						СтрокиДЗРодитель = СтрокаДЗ.Строки.НайтиСтроки(Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Нпп", СтрокаПоискаРодителя));
					КонецЕсли;
					
					Если СтрокиДЗ.Количество() > 0 Тогда
						СтрокаДЗ = СтрокиДЗ[0];
					ИначеЕсли ИндексРазделителяНомера И СтрокиДЗРодитель.Количество() Тогда
						СтрокаДЗ = СтрокаДЗ.Строки.Добавить();
						СтрокаДЗ.ИмяРеквизита = "Нпп";
						СтрокаДЗ.ЗначениеРеквизита = Строка(НомерСтроки);
						ЭлектронноеВзаимодействие.СкопироватьСтрокиДереваРекурсивно(СтрокаДЗ, СтрокиДЗРодитель[0]);
					Иначе
						СтрокаДЗ = СтрокаДЗ.Строки.Добавить();
						СтрокаДЗ.ИмяРеквизита = "Нпп";
						СтрокаДЗ.ЗначениеРеквизита = Строка(НомерСтроки);
					КонецЕсли;
				КонецЕсли;
				РекурсивноРазобратьДопФайл(ЭД.Данные, СтрокаДЗ, Истина);
			КонецЕсли;
		Исключение
			Если Не ДеревоСозданоРаньше Тогда
				ДеревоДопДанных = Неопределено;
			КонецЕсли;
			ОбъектXML.Закрыть();
			ТекстСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из строки доп.данных.
										|Подробнее см. в журнале регистрации.'");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "ОбменСКонтрагентами", 
				УровеньЖурналаРегистрации.Ошибка);
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДопДанныеФНС_502(ИнфПол, ДеревоДопДанных, ИмяНабораДанных)
	
	ДеревоСозданоРаньше = Истина;
	Если ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = ДеревоДопДанных();
		ДеревоСозданоРаньше = Ложь;
	КонецЕсли;
	
	СтрокаДЗ = ДеревоДопДанных.Строки.Найти(ИмяНабораДанных, "ЗначениеРеквизита");
	Если СтрокаДЗ = Неопределено Тогда
		СтрокаДЗ = ДеревоДопДанных.Строки.Добавить();
		СтрокаДЗ.ЗначениеРеквизита = ИмяНабораДанных;
		СтрокаДЗ.ИмяРеквизита = "Набор";
	КонецЕсли;
	
	Если ИнфПол <> Неопределено Тогда
		
		КоллекцияЗначений = ЗначениеСвойстваXDTO(ИнфПол, "ТекстИнф",, Истина);
		Если КоллекцияЗначений = Неопределено Тогда
			Если ТипЗнч(ИнфПол) = Тип("ОбъектXDTO") Тогда
				// При мягком чтении СписокXDTO конвертируется в ОбъектXDTO если в нем одна строка.
				КоллекцияЗначений = Новый Массив;
				КоллекцияЗначений.Добавить(ИнфПол);
			Иначе
				КоллекцияЗначений = ИнфПол;
			КонецЕсли;
		КонецЕсли;
		
		Для Каждого ИмяЗначениеРеквизита Из КоллекцияЗначений Цикл
			СтрДЗ                    = СтрокаДЗ.Строки.Добавить();
			СтрДЗ.ИмяРеквизита       = ЗначениеСвойстваXDTO(ИмяЗначениеРеквизита, "Идентиф");
			СтрДЗ.ЗначениеРеквизита  = ЗначениеСвойстваXDTO(ИмяЗначениеРеквизита, "Значен");
			СтрДЗ.ЮридическиЗначимый = Истина;
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьДопДанныеТЧ_ФНС502(ИнфПол, ДеревоДопДанных, ИмяНабораДанных, НомерСтроки)
	
	Если ТипЗнч(ДеревоДопДанных) <> Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = ДеревоДопДанных();
	КонецЕсли;
	
	СтрокаДЗ = ДеревоДопДанных.Строки.Найти(ИмяНабораДанных, "ЗначениеРеквизита");
	Если СтрокаДЗ = Неопределено Тогда
		СтрокаДЗ = ДеревоДопДанных.Строки.Добавить();
		СтрокаДЗ.ЗначениеРеквизита = ИмяНабораДанных;
		Если НомерСтроки = Неопределено Тогда
			СтрокаДЗ.ИмяРеквизита = "Набор";
		Иначе
			СтрокаДЗ.ИмяРеквизита = "Список";
		КонецЕсли;
	КонецЕсли;
	
	СтрокиДЗ = СтрокаДЗ.Строки.НайтиСтроки(Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Нпп", Строка(НомерСтроки)));
	
	// Поиск подчиненных по разделителю "."
	ИндексРазделителяНомера = СтрНайти(Строка(НомерСтроки), ".");
	Если ИндексРазделителяНомера Тогда
		СтрокаПоискаРодителя = Лев(Строка(НомерСтроки), ИндексРазделителяНомера - 1);
		СтрокиДЗРодитель = СтрокаДЗ.Строки.НайтиСтроки(Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Нпп", СтрокаПоискаРодителя));
	КонецЕсли;
	
	Если СтрокиДЗ.Количество() > 0 Тогда
		СтрокаДЗ = СтрокиДЗ[0];
	ИначеЕсли ИндексРазделителяНомера И СтрокиДЗРодитель.Количество() Тогда
		СтрокаДЗ = СтрокаДЗ.Строки.Добавить();
		СтрокаДЗ.ИмяРеквизита = "Нпп";
		СтрокаДЗ.ЗначениеРеквизита = Строка(НомерСтроки);
		СкопироватьСтрокиДереваРекурсивно(СтрокаДЗ, СтрокиДЗРодитель[0]);
	Иначе
		СтрокаДЗ = СтрокаДЗ.Строки.Добавить();
		СтрокаДЗ.ИмяРеквизита = "Нпп";
		СтрокаДЗ.ЗначениеРеквизита = Строка(НомерСтроки);
	КонецЕсли;

	Коллекция = ИнфПол;
	Если ТипЗнч(ИнфПол) = Тип("ОбъектXDTO") Тогда
		Коллекция = Новый Массив;
		Коллекция.Добавить(ИнфПол);
	КонецЕсли;
		
	Для Каждого ИмяЗначениеРеквизита Из Коллекция Цикл
		
		СтрДЗ = СтрокаДЗ.Строки.Добавить();
		
		Идентиф = ЗначениеСвойстваXDTO(ИмяЗначениеРеквизита, "Идентиф", "Строка");
		Значен  = ЗначениеСвойстваXDTO(ИмяЗначениеРеквизита, "Значен",  "Строка");
		Если Врег(Прав(Идентиф, 7)) = ВРег("_Массив") Тогда
			СтрДЗ.ИмяРеквизита      = Лев(Идентиф, СтрДлина(Идентиф) - 7);
			СтрДЗ.ЗначениеРеквизита = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивСлов(Значен);
		Иначе
			СтрДЗ.ИмяРеквизита      = Идентиф;
			СтрДЗ.ЗначениеРеквизита = Значен;
		КонецЕсли;
		
		СтрДЗ.ЮридическиЗначимый = Истина;
		
	КонецЦикла;
	
КонецПроцедуры

// Разбор дерева доп. данных для печатных форм

Функция СформироватьДопДанныеСтрок(ДеревоДопДанных, ИмяЧитаемойТаблицы, ТаблицаВозврата)
	
	СтруктураВозврата = Новый Структура("ЕстьПодписанные, ЕстьНеПодписанные", Ложь, Ложь);
	
	Если ДеревоДопДанных <> Неопределено Тогда
		СтруктураПоиска = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Список", ИмяЧитаемойТаблицы);
		СтрокиСписка = ДеревоДопДанных.Строки.НайтиСтроки(СтруктураПоиска, Истина);
		Если СтрокиСписка.Количество() > 0 Тогда
			
			ТаблицаДопДанных = Новый ТаблицаЗначений;
			ТаблицаДопДанных.Колонки.Добавить("Нпп");
			ТаблицаДопДанных.Колонки.Добавить("ИмяРеквизита");
			ТаблицаДопДанных.Колонки.Добавить("ЗначениеРеквизита");
			ТаблицаДопДанных.Колонки.Добавить("ЮридическиЗначимый");
			
			Для Каждого СтрокаСписка Из СтрокиСписка[0].Строки Цикл
				ТаблицаДопДанных.Очистить();
				ПрочитатьСтрокиДереваРекурсивно(СтрокаСписка.Строки, ТаблицаДопДанных);
				
				Если ТаблицаДопДанных.Количество() > 0 Тогда
					Для Каждого СтрокаТЗ Из ТаблицаДопДанных Цикл
						СтрокаТЗ.Нпп = ТаблицаДопДанных.Индекс(СтрокаТЗ) + 1;
					КонецЦикла;
					ТаблицаДопДанных.Сортировать("ЮридическиЗначимый, Нпп");
					СтрокаТЗВозврата = ТаблицаВозврата.Добавить();
					СтрокаТЗВозврата.НомерСтр = СтрокаСписка.ЗначениеРеквизита;
					Для Каждого СтрокаТЗ Из ТаблицаДопДанных Цикл
						Если СтрокаТЗ.ЮридическиЗначимый Тогда
							СтруктураВозврата.ЕстьПодписанные = Истина;
							
							ЗначениеРеквизита = СтрокаТЗ.ЗначениеРеквизита;
							Если ТипЗнч(СтрокаТЗ.ЗначениеРеквизита) = Тип("Массив") Тогда
								ЗначениеРеквизита = СтрСоединить(СтрокаТЗ.ЗначениеРеквизита, ",");
							КонецЕсли;
							
							СтрокаТЗВозврата.ПодписанныеДанные = ?(ЗначениеЗаполнено(СтрокаТЗВозврата.ПодписанныеДанные),
								СтрокаТЗВозврата.ПодписанныеДанные + Символы.ПС, "") + СтрокаТЗ.ИмяРеквизита + " = " + ЗначениеРеквизита;
						Иначе
							СтруктураВозврата.ЕстьНеПодписанные = Истина;
							СтрокаТЗВозврата.НеПодписанныеДанные = ?(ЗначениеЗаполнено(СтрокаТЗВозврата.НеПодписанныеДанные),
								СтрокаТЗВозврата.НеПодписанныеДанные + Символы.ПС, "") + СтрокаТЗ.ИмяРеквизита + " = " + СтрокаТЗ.ЗначениеРеквизита;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

Процедура ПрочитатьСтрокиДереваРекурсивно(СтрокиДерева, ТаблицаДопДанных, ИмяРодителя = "")
	
	Для Каждого СтрокаДерева Из СтрокиДерева Цикл
		Если СтрокаДерева.ИмяРеквизита = "Набор" ИЛИ СтрокаДерева.ИмяРеквизита = "Массив" 
			ИЛИ СтрокаДерева.ИмяРеквизита = "Список" ИЛИ СтрокаДерева.ИмяРеквизита = "Нпп"
			ИЛИ СтрокаДерева.ЗначениеРеквизита = "Структура" Тогда
			
			ИмяРодителя = ИмяРодителя + СтрокаДерева.ЗначениеРеквизита;
			ПрочитатьСтрокиДереваРекурсивно(СтрокаДерева.Строки, ТаблицаДопДанных, ИмяРодителя);
		Иначе
			СтрокаТЗ = ТаблицаДопДанных.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТЗ, СтрокаДерева);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Знач Макет, ТабличныйДокумент)
	
	Макет = ПолучитьОбщийМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_ИдентификаторДокумента_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	Если ДеревоДопДанных <> Неопределено Тогда
		СтруктураПоиска = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Набор", "Шапка");
		СтрокиШапки = ДеревоДопДанных.Строки.НайтиСтроки(СтруктураПоиска, Истина);
		Если СтрокиШапки.Количество() > 0 Тогда
			
			ТаблицаДопДанных = Новый ТаблицаЗначений;
			ТаблицаДопДанных.Колонки.Добавить("ИмяРеквизита");
			ТаблицаДопДанных.Колонки.Добавить("ЗначениеРеквизита");
			ТаблицаДопДанных.Колонки.Добавить("ЮридическиЗначимый");
			
			ПрочитатьСтрокиДереваРекурсивно(СтрокиШапки, ТаблицаДопДанных);
			
			Если ТаблицаДопДанных.Количество() > 0 Тогда
				ОбластьМакета = Макет.ПолучитьОбласть("ДопДанныеШапки_Шапка");
				ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "ДопДанныеШапкиШапка");
				
				ОбластьМакетаСЭП = Макет.ПолучитьОбласть("ДопДанныеШапки_Строка");
				ОбластьМакетаБезЭП = Макет.ПолучитьОбласть("ДопДанныеШапки_СтрокаБезЭП");
				ТаблицаДопДанных.Колонки.Добавить("Нпп");
				Для Каждого СтрокаТЗ Из ТаблицаДопДанных Цикл
					СтрокаТЗ.Нпп = ТаблицаДопДанных.Индекс(СтрокаТЗ) + 1;
				КонецЦикла;
				ТаблицаДопДанных.Сортировать("ЮридическиЗначимый, Нпп");
				Для Каждого СтрокаТЗ Из ТаблицаДопДанных Цикл
					ОбластьМакета = ?(СтрокаТЗ.ЮридическиЗначимый, ОбластьМакетаСЭП, ОбластьМакетаБезЭП);
					ОбластьМакета.Параметры.Заполнить(СтрокаТЗ);
					ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета,
						"ДопДанныеШапкиСтрока", СтрокаТЗ.Нпп);
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Работа с документами основаниями

#Область ПоискДокументовОснованийПоИдентификаторамДокументовИБ

// Актуальный алгоритм передачи связки с документами-основаниями.
// В качестве идентификатора документа-основания во входящем ЭД приходит
// идентификатор документа ИБ, в результате даже если ЭД для документа-потомка
// был сформирован и отправлен раньше, чем ЭД документа-основания, после получения
// ЭД документа-основания можно перезаполнить документ-потомок и ссылка на основание
// будет найдена.
Процедура ЗаполнитьСсылкиНаДокументыОснованияПоИдентификаторам(ДеревоРазбора, НовыйЭД, Организация, ЭтоСчетФактура = Ложь)
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("Организация",   Организация);
	СтруктураОтбора.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
	ИДДокументаОснования = НовыйЭД.Строки.Найти("ИдентификаторДокументаОснования", "Реквизит", Истина);
	ИДЭДДокументаОснования = НовыйЭД.Строки.Найти("ИДЭДДокументаОснования", "Реквизит", Истина);
	// Для счета-фактуры в переопределяемой части ожидается несколько иная структура данных по основаниям.
	Если ЭтоСчетФактура Тогда
		ДокументыОснования = НовыйЭД.Строки.Найти("ДокументыОснования", "Реквизит", Истина);
		Если ДокументыОснования <> Неопределено Тогда
			Для Каждого Строка Из ДокументыОснования.Строки Цикл
				ПараметрыДокументаОснования = Строка.ЗначениеРеквизита;
				ДокументОснование = Неопределено;
				Если ПараметрыДокументаОснования.Свойство("ИдентификаторДокументаОснования", ИДЭДДокументаОснования)
					И ЗначениеЗаполнено(ИДЭДДокументаОснования) Тогда
					
					ДокументОснование = ДокументОснованиеПоИдентификатору(ИДЭДДокументаОснования, СтруктураОтбора);
				ИначеЕсли ПараметрыДокументаОснования.Свойство("ИДЭДДокументаОснования", ИДЭДДокументаОснования)
					И ЗначениеЗаполнено(ИДЭДДокументаОснования) Тогда
					
					ДокументОснование = ПолучитьДокументОснование(ИДЭДДокументаОснования, СтруктураОтбора);
				КонецЕсли;
				Если ДокументОснование <> Неопределено Тогда
					Строка.СсылкаНаОбъект = ДокументОснование;
				КонецЕсли;
			КонецЦикла;
		Иначе
			Если ИДДокументаОснования <> Неопределено Тогда
				ДокументОснование = ДокументОснованиеПоИдентификатору(ИДДокументаОснования.ЗначениеРеквизита, СтруктураОтбора);
			ИначеЕсли ИДЭДДокументаОснования <> Неопределено Тогда
				ДокументОснование = ПолучитьДокументОснование(ИДЭДДокументаОснования.ЗначениеРеквизита, СтруктураОтбора);
			КонецЕсли;
			Если ДокументОснование <> Неопределено Тогда
				ПараметрыОснования = Новый Структура("ИдентификаторДокументаОснования, ИДЭДДокументаОснования,
					|ВидДокументаОснования, НомерДокументаОснования, ДатаДокументаОснования");
				Для Каждого Элемент Из ПараметрыОснования Цикл
					СтрокаРеквизита = НовыйЭД.Строки.Найти(Элемент.Ключ, "Реквизит", Истина);
					Если СтрокаРеквизита <> Неопределено Тогда	
						ПараметрыОснования[Элемент.Ключ] = СтрокаРеквизита.ЗначениеРеквизита;
					КонецЕсли;
				КонецЦикла;
				НовСтрока = НовыйЭД.Строки.Добавить();
				НовСтрока.Реквизит = "ДокументыОснования";
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовСтрока, "ДокументОснования", ПараметрыОснования, ДокументОснование);
			КонецЕсли;
		КонецЕсли;
	Иначе
		ДокументОснование = Неопределено;
		Если ИДДокументаОснования <> Неопределено Тогда
			ДокументОснование = ДокументОснованиеПоИдентификатору(ИДДокументаОснования.ЗначениеРеквизита, СтруктураОтбора);
		ИначеЕсли ИДЭДДокументаОснования <> Неопределено Тогда
			ДокументОснование = ПолучитьДокументОснование(ИДЭДДокументаОснования.ЗначениеРеквизита, СтруктураОтбора);
		КонецЕсли;
		Если ДокументОснование <> Неопределено Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ДокументыОснования");
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НайденныйТипВДереве, "ДокументОснования", ДокументОснование, ДокументОснование);
			НайденнаяСтрока = НайденныйТипВДереве.Строки.Найти(ДокументОснование, "СсылкаНаОбъект");
			НайденнаяСтрока.ИндексСтроки = НайденныйТипВДереве.ИндексСтроки + "_"
				+ Строка(НайденныйТипВДереве.Строки.Индекс(НайденнаяСтрока));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Основание", НайденнаяСтрока.ИндексСтроки, ДокументОснование);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Возвращает ссылку на документ-основание найденный по идентификатору, либо Неопределено.
Функция ДокументОснованиеПоИдентификатору(ИДДокументаОснования, СтруктураОтбора, ТипЭлементаВерсииЭД = Неопределено)
	
	ДокументОснование = Неопределено;
	
	МассивИД = Новый Массив;
	МассивИД.Добавить(ИДДокументаОснования);
	ТЗПолученныхОснований = ТаблицаЗначенийДокументовОснованийПоИдентификаторам(МассивИД, СтруктураОтбора);
	Если ТЗПолученныхОснований.Количество() > 0 Тогда
		
		ДокументОснование = ТЗПолученныхОснований[0].Ссылка;
		// Для УПД и УКД выберем нужный документ основание.
		Если ТипЭлементаВерсииЭД <> Неопределено
			И (ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД) Тогда
			
			Для каждого Строка Из ТЗПолученныхОснований Цикл
				Если ДокументЯвляетсяСчетомФактурой(Строка.Ссылка) Тогда
					ДокументОснование = Строка.Ссылка;
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ДокументОснование;
	
КонецФункции

#КонецОбласти

// Только для внутреннего использования
Функция ПолучитьПараметрыДокументовОснований(Знач ДокументыОснования, ТаблицаИдентификаторовОснований)
	
	ТаблицаПараметровДокументовОснований = Новый ТаблицаЗначений;
	
	Запрос = Новый Запрос;
	// В запрос передается временная таблица документов-оснований.
	// Затем для этих документов-оснований выбираются первичные ЭД (если есть).
	// Из отобранных ЭД отбираются актуальные версии (по регистру СостоянияЭД), у актуальных ЭД
	// получаются значения реквизитов.
	// В результате запроса обязательно должна присутствовать ссылка на ВладельцаЭД
	// и если найден ЭД, то реквизиты ЭД.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	МассивСсылок.ОбъектСсылка КАК ОбъектСсылка
	|ПОМЕСТИТЬ МассивСсылок
	|ИЗ
	|	&МассивСсылок КАК МассивСсылок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МассивСсылок.ОбъектСсылка КАК ОбъектСсылка,
	|	ВЫБОР
	|		КОГДА ЭлектронныйДокументИсходящийДокументыОснования.Ссылка ЕСТЬ NULL
	|			ТОГДА ЭлектронныйДокументВходящийДокументыОснования.Ссылка
	|		ИНАЧЕ ЭлектронныйДокументИсходящийДокументыОснования.Ссылка
	|	КОНЕЦ КАК ЭлектронныйДокумент
	|ПОМЕСТИТЬ ВР_ЭД
	|ИЗ
	|	МассивСсылок КАК МассивСсылок
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументИсходящий.ДокументыОснования КАК ЭлектронныйДокументИсходящийДокументыОснования
	|		ПО МассивСсылок.ОбъектСсылка = ЭлектронныйДокументИсходящийДокументыОснования.ДокументОснование
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументВходящий.ДокументыОснования КАК ЭлектронныйДокументВходящийДокументыОснования
	|		ПО МассивСсылок.ОбъектСсылка = ЭлектронныйДокументВходящийДокументыОснования.ДокументОснование
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ОбъектСсылка,
	|	ЭлектронныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЭДПрисоединенныеФайлы.НаименованиеФайла КАК Наименование,
	|	ВР_ЭД.ОбъектСсылка КАК ДокументСсылка,
	|	ВР_ЭД.ЭлектронныйДокумент.ДатаДокументаОтправителя КАК ДатаДокументаОтправителя,
	|	ВР_ЭД.ЭлектронныйДокумент.НомерДокументаОтправителя КАК НомерДокументаОтправителя,
	|	ВР_ЭД.ЭлектронныйДокумент.ВидЭД КАК ВидЭД
	|ИЗ
	|	ВР_ЭД КАК ВР_ЭД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭДПрисоединенныеФайлы КАК ЭДПрисоединенныеФайлы
	|		ПО (ЭДПрисоединенныеФайлы.ТипЭлементаВерсииЭД В (ЗНАЧЕНИЕ(Перечисление.ТипыЭлементовВерсииЭД.ПервичныйЭД), ЗНАЧЕНИЕ(Перечисление.ТипыЭлементовВерсииЭД.ЭСФ)))
	|			И ВР_ЭД.ЭлектронныйДокумент = ЭДПрисоединенныеФайлы.ВладелецФайла
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВР_ЭД.ОбъектСсылка КАК ДокументСсылка,
	|	ВР_ЭД.ЭлектронныйДокумент.УникальныйИД КАК ИдентификаторЭДДокументаОснования
	|ИЗ
	|	ВР_ЭД КАК ВР_ЭД";


	Если ТипЗнч(ДокументыОснования) = Тип("Массив") Тогда
		МассивСсылок = ДокументыОснования;
	Иначе // пришла единичная ссылка на объект
		МассивСсылок = Новый Массив;
		МассивСсылок.Добавить(ДокументыОснования);
	КонецЕсли;
	
	МассивТипов = Новый Массив;
	Для Каждого ЭлементСписка Из МассивСсылок Цикл
		Если МассивТипов.Найти(ТипЗнч(ЭлементСписка)) = Неопределено Тогда
			МассивТипов.Добавить(ТипЗнч(ЭлементСписка));
		КонецЕсли;
	КонецЦикла;
	
	ТипЗначенияКолонки = Новый ОписаниеТипов(МассивТипов);
	ТЗ_Ссылки = Новый ТаблицаЗначений;
	КолонкаТЗ = ТЗ_Ссылки.Колонки.Добавить("ОбъектСсылка", ТипЗначенияКолонки);
	
	Для Каждого ДокументОснование Из МассивСсылок Цикл
		НоваяСтрока = ТЗ_Ссылки.Добавить();
		НоваяСтрока.ОбъектСсылка = ДокументОснование;
	КонецЦикла;
	Запрос.УстановитьПараметр("МассивСсылок", ТЗ_Ссылки);
	Результат = Запрос.ВыполнитьПакет();
	
	ТаблицаПараметровДокументовОснований = Результат[2].Выгрузить();
	ТаблицаПараметровДокументовОснований.Колонки.Добавить("ИдентификаторДокументаОснования");
	Для Каждого СтрокаТЗ Из ТаблицаПараметровДокументовОснований Цикл
		СтрокаТЗ.ИдентификаторДокументаОснования = Строка(СтрокаТЗ.ДокументСсылка.УникальныйИдентификатор());
	КонецЦикла;
	ТаблицаПараметровДокументовОснований.Колонки.Удалить("ДокументСсылка");
	
	// Таблица идентификаторов помещается в табличную часть ЭД ИдентификаторыОснованийВладельцаФайла.
	ТаблицаЗначений = Результат[3].Выгрузить();
	ТаблицаЗначений.Колонки.Добавить("ИдентификаторДокументаОснования");
	Для Каждого СтрокаТЗ Из ТаблицаЗначений Цикл
		СтрокаИдентификаторов = ТаблицаИдентификаторовОснований.Добавить();
		СтрокаИдентификаторов.ИдентификаторДокументаОснования = Строка(СтрокаТЗ.ДокументСсылка.УникальныйИдентификатор());
		СтрокаИдентификаторов.ИдентификаторЭДДокументаОснования = СтрокаТЗ.ИдентификаторЭДДокументаОснования;
	КонецЦикла;
	ТаблицаИдентификаторовОснований.Свернуть("ИдентификаторДокументаОснования, ИдентификаторЭДДокументаОснования");
	
	Возврат ТаблицаПараметровДокументовОснований;
	
КонецФункции

// Только для внутреннего использования
Функция ПолучитьДокументОснование(НаименованиеФайла, ДопПараметрыПоиска)
	
	ДокументОснование = Неопределено;
	
	Если НЕ ЗначениеЗаполнено(НаименованиеФайла) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	ЭДПрисоединенныеФайлы.ВладелецФайла КАК Ссылка
	|ПОМЕСТИТЬ вт_ЭД
	|ИЗ
	|	Справочник.ЭДПрисоединенныеФайлы КАК ЭДПрисоединенныеФайлы
	|ГДЕ
	|	ЭДПрисоединенныеФайлы.НаименованиеФайла ПОДОБНО &Наименование";
	Запрос.УстановитьПараметр("Наименование", НаименованиеФайла + "%");
	Для Каждого Элемент Из ДопПараметрыПоиска Цикл
		ИмяРеквизита = Элемент.Ключ;
		Если ИмяРеквизита = "Организация" Тогда
			ИмяРеквизита = "ВладелецФайла.Организация";
		КонецЕсли;
		Текст = Текст + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("	И ЭДПрисоединенныеФайлы.%1 = &%2", ИмяРеквизита, Элемент.Ключ);
		Запрос.УстановитьПараметр(Элемент.Ключ,  Элемент.Значение);
	КонецЦикла;
	Текст = Текст + "
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЭлектронныйДокументВходящийДокументыОснования.ДокументОснование
	|ИЗ
	|	Документ.ЭлектронныйДокументВходящий.ДокументыОснования КАК ЭлектронныйДокументВходящийДокументыОснования
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ вт_ЭД КАК вт_ЭД
	|		ПО ЭлектронныйДокументВходящийДокументыОснования.Ссылка = вт_ЭД.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЭлектронныйДокументИсходящийДокументыОснования.ДокументОснование
	|ИЗ
	|	вт_ЭД КАК вт_ЭД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументИсходящий.ДокументыОснования КАК ЭлектронныйДокументИсходящийДокументыОснования
	|		ПО вт_ЭД.Ссылка = ЭлектронныйДокументИсходящийДокументыОснования.Ссылка";

	Запрос.Текст = Текст;
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		ДокументОснование = Выборка.ДокументОснование;
	КонецЕсли;
	
	Возврат ДокументОснование;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Типы объектов

// Получает имя владельца справочника НоменклатураПоставщика.
//
// Возвращаемое значение:
//  ИмяСправочника - строковое имя владельца.
//
Функция ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков()
	
	ИмяРеквизитаВладельца = Неопределено;
	ОбменСКонтрагентамиПереопределяемый.ОпределитьИмяРеквизитаВладельцаНоменклатурыПоставщиков(ИмяРеквизитаВладельца);
	
	Если ИмяРеквизитаВладельца = Неопределено Тогда // не задано соответствие
		ТекстСообщения = НСтр("ru = 'В коде прикладного решения необходимо указать имя реквизита для владельца номенклатуры поставщиков.'");
		ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ТекстСообщения,
			"ОбменСКонтрагентами", УровеньЖурналаРегистрации.Предупреждение);
		ИмяРеквизитаВладельца = "";
	КонецЕсли;
	
	Возврат ИмяРеквизитаВладельца;
	
КонецФункции

// Определяет, является ли параметр ссылкой на номенклатуру.
//
// Параметры:
//  СсылкаНаОбъект - любой объект.
//
// Возвращаемое значение:
//  Булево - Истина, если это ссылка на элемент справочника Номенклатура ИЛИ НоменклатураПоставщиков.
//
Функция ЭтоНоменклатура(СсылкаНаОбъект)
	
	Результат = Ложь;
	
	Результат = ТипЗнч(СсылкаНаОбъект) = Тип(ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта("Номенклатура"));
	Если НЕ Результат И ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта("НоменклатураПоставщиков") <> Неопределено Тогда
		Результат = ТипЗнч(СсылкаНаОбъект) = Тип(ЭлектронноеВзаимодействиеСлужебный.ТипОбъекта("НоменклатураПоставщиков"));
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Прочее

// Определяет имя файла электронного документа.
//
// Параметры:
//  ВидЭД - Вид электронного документа, перечисление.
//
Функция ОпределитьИмяФайлаЭД(ВидЭД, СсылкаНаОбъект, Знач ВерсияЭД = Неопределено)
	
	Если ВидЭД = Перечисления.ВидыЭД.СчетФактура
		ИЛИ ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ТОРГ12
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель
		ИЛИ ВидЭД = Перечисления.ВидыЭД.АктВыполненныхРабот
		ИЛИ ВидЭД = Перечисления.ВидыЭД.АктИсполнитель
		ИЛИ ВидЭД = Перечисления.ВидыЭД.АктЗаказчик
		ИЛИ ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав
		ИЛИ ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель
		ИЛИ ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель
		ИЛИ ВидЭД = Перечисления.ВидыЭД.СчетНаОплату
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ЗаказТовара
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ОтветНаЗаказ
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ПрайсЛист
		ИЛИ ВидЭД = Перечисления.ВидыЭД.КаталогТоваров
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ПередачаТоваровМеждуОрганизациями
		ИЛИ ВидЭД = Перечисления.ВидыЭД.ВозвратТоваровМеждуОрганизациями Тогда
		
		ШаблонПредставленияЭД = НСтр("ru = '%1 %2 %3%4.xml'");
		
		// Получим версию ЭД и ее строковое представление.
		ВерсияЭД = ?(ВерсияЭД = Неопределено, ОбменСКонтрагентамиСлужебный.НомерВерсииЭДПоВладельцу(СсылкаНаОбъект), ВерсияЭД);
		Если ТипЗнч(ВерсияЭД) = Тип("Дата") Тогда
			ВерсияЭД = Формат(ВерсияЭД, "ДЛФ=DT; ДП=-");
		КонецЕсли;
		
		ПредставлениеВерсии = "";
		Если ВидЭД <> Перечисления.ВидыЭД.СчетФактура И ВидЭД <> Перечисления.ВидыЭД.ИзвещениеОПолучении
			И ВидЭД <> Перечисления.ВидыЭД.Подтверждение И ВидЭД <> Перечисления.ВидыЭД.УведомлениеОбУточнении
			И ЗначениеЗаполнено(ВерсияЭД) Тогда
			
			ШаблонПредставлениеВерсии = " (ver. %1)";
			ПредставлениеВерсии = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонПредставлениеВерсии, ВерсияЭД);
		КонецЕсли;
		
		Если ВидЭД = Перечисления.ВидыЭД.КаталогТоваров Тогда
			СтрокаИмениФайла = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонПредставленияЭД,
				ВидЭД, СсылкаНаОбъект.Организация, СсылкаНаОбъект.Контрагент, ПредставлениеВерсии);
		Иначе
			СтрокаИмениФайла = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонПредставленияЭД,
				ВидЭД, СсылкаНаОбъект.Номер, Формат(СсылкаНаОбъект.Дата, "ДЛФ=D; ДЛФ=D"), ПредставлениеВерсии);
		КонецЕсли;
		
		СтрокаИмениФайла = СтроковыеФункцииКлиентСервер.СтрокаЛатиницей(СтрокаИмениФайла);
	Иначе
		СтрокаИмениФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
	КонецЕсли;
	СтрокаИмениФайла = ОбменСКонтрагентамиСлужебный.КорректноеИмяФайла(СтрокаИмениФайла, Истина);
	
	Возврат СтрокаИмениФайла;
	
КонецФункции

Процедура ДобавитьПараметрВЗаголовок(ЗаголовокЗапроса, Имя, Значение)

	ЗаголовокЗапроса = ЗаголовокЗапроса + Имя + ": "+ Значение + Символы.ВК + Символы.ПС;

КонецПроцедуры

Процедура ПрочитатьКонтакт(Контакт, ТаблицаКонтактов, ПрофильНастроекЭДО)
	
	Строка = ТаблицаКонтактов.Добавить();
	Строка.ПрофильНастроекЭДО  = ПрофильНастроекЭДО;
	Строка.ИНН                 = ?(ТипЗнч(Контакт.Inn) = Тип("ОбъектXDTO"), "", Контакт.Inn);
	
	Строка.Изменен             = Дата(СтрЗаменить(СтрЗаменить(СтрЗаменить(СтрЗаменить(Сред(Контакт.State.Changed, 0,
		СтрНайти(Контакт.State.Changed, ".") - 1), "-", ""), " ", ""), ":", ""),"T",""));
		
	Если Контакт.Свойства().Получить("Kpp") <> Неопределено И ТипЗнч(Контакт.Kpp) = Тип("Строка") Тогда
		Строка.КПП = Контакт.Kpp;
	КонецЕсли;
	
	Если Контакт.Свойства().Получить("ExternalContactId") <> Неопределено
		И ТипЗнч(Контакт.ExternalContactId) = Тип("Строка") Тогда
		
		Строка.ВнешнийИД = Контакт.ExternalContactId;
	КонецЕсли;
	
	Если Контакт.Свойства().Получить("Name") <> Неопределено И ТипЗнч(Контакт.Name) = Тип("Строка") Тогда
		Строка.Наименование    = Контакт.Name;
	КонецЕсли;
	
	Если Контакт.Свойства().Получить("Comment") <> Неопределено И ТипЗнч(Контакт.Comment) = Тип("Строка") Тогда
		Строка.ТекстПриглашения = Контакт.Comment;
	КонецЕсли;
	
	Строка.Состояние = ПреобразоватьТекстСтатуса(Контакт.State.Code);
	Если Контакт.State.Code = "Error" Тогда
		Строка.ОписаниеОшибки  = ПреобразоватьТекстСтатуса(Контакт.State.ErrorCode);
	КонецЕсли;
	
	Если Контакт.Свойства().Получить("EDXClientId") <> Неопределено Тогда
		Строка.Идентификатор  = Контакт.EDXClientId;
	КонецЕсли;
	
КонецПроцедуры

Функция ПреобразоватьТекстСтатуса(КодСтатуса)
	
	Если КодСтатуса = "Incoming" Тогда
		ВозвращаемоеЗначение = Перечисления.СтатусыУчастниковОбменаЭД.ТребуетсяСогласие; //"Входящий запрос";
	ИначеЕсли КодСтатуса = "Rejected" Тогда
		ВозвращаемоеЗначение = Перечисления.СтатусыУчастниковОбменаЭД.Отсоединен; //"Отсоединен"
	ИначеЕсли КодСтатуса = "Accepted" Тогда
		ВозвращаемоеЗначение = Перечисления.СтатусыУчастниковОбменаЭД.Присоединен; //"Присоединен"
	ИначеЕсли КодСтатуса = "Sent" Тогда
		ВозвращаемоеЗначение = Перечисления.СтатусыУчастниковОбменаЭД.ОжидаемСогласия; //"Ожидаем согласия"
	ИначеЕсли КодСтатуса = "Error" Тогда
		ВозвращаемоеЗначение = Перечисления.СтатусыУчастниковОбменаЭД.Ошибка; // "Ошибка"
	
	ИначеЕсли КодСтатуса = "InvalidINN" Тогда
		ВозвращаемоеЗначение = НСтр("ru ='Неправильный ИНН'");
	ИначеЕсли КодСтатуса = "InvalidEmail" Тогда
		ВозвращаемоеЗначение = НСтр("ru ='Неправильный адрес электронной почты'");
	Иначе
		ВозвращаемоеЗначение = КодСтатуса;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции


Функция ПолучитьКодТранзакции(ЭлектронныйДокумент, КодРегламента, ПризнакПодписи = Ложь)
	
	КодТранзакции = Неопределено;
	
	ПараметрыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЭлектронныйДокумент,
		"ТипЭлементаВерсииЭД, ЭлектронныйДокументВладелец, ВладелецФайла");
		
	Если ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПОА Тогда
		Если ПризнакПодписи Тогда
			КодТранзакции = "CancellationOfferResign";
		Иначе
			КодТранзакции = "CancellationOffer";
		КонецЕсли;
	ИначеЕсли ОбменСКонтрагентамиСлужебный.ЭтоУведомлениеОбУточнении(ПараметрыЭД.ТипЭлементаВерсииЭД) Тогда
		Если КодРегламента = "Invoice" Тогда
			КодТранзакции = "CorrectionNotice";
		Иначе
			ТипЭлементаВерсииЭДВладельца = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрыЭД.ЭлектронныйДокументВладелец, "ТипЭлементаВерсииЭД");
			Если ТипЭлементаВерсииЭДВладельца = Перечисления.ТипыЭлементовВерсииЭД.ПОА Тогда
				КодТранзакции = "CancellationOfferReject";
			Иначе
				КодТранзакции = "MainDocumentReject";
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли КодРегламента = "Invoice" Тогда
		
		КодТранзакции = "Invoice";
		Если ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДОЭСФ Тогда
			КодТранзакции = "SendConfirmationReceiveNotice";
		ИначеЕсли ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДПЭСФ Тогда
			КодТранзакции = "PostDateConfirmationReceiveNotice";
		ИначеЕсли ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИПЭСФ Тогда
			КодТранзакции = "ReceiveNotice";
		ИначеЕсли ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДОИПЭСФ Тогда
			КодТранзакции = "ReceiveNoticePostDateConfirmationReceiveNotice";
		ИначеЕсли ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИПУУЭСФ Тогда
			КодТранзакции = "CorrectionNoticeReceiveNotice";
		ИначеЕсли ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДОИПУПДУКД Тогда
			КодТранзакции = "CustomerInformationPostDateConfirmationReceiveNotice";
		ИначеЕсли ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД
			ИЛИ ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД Тогда
			КодТранзакции = "CustomerInformation";
		КонецЕсли;
		
	ИначеЕсли КодРегламента = "Formalized" Тогда
		
		ВидЭД = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрыЭД.ВладелецФайла,"ВидЭД");
		
		Если ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ТОРГ12Покупатель
			ИЛИ ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.АктЗаказчик
			ИЛИ ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СоглашениеОбИзмененииСтоимостиПолучатель Тогда
			
			КодТранзакции = "CustomerTitle";
			
		ИначеЕсли ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
			ИЛИ ВидЭД = Перечисления.ВидыЭД.АктИсполнитель
			ИЛИ ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель Тогда
			
			КодТранзакции = "VendorTitle";
		КонецЕсли;
		
		Если ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИОП Тогда
			КодТранзакции = "ReceiveNotice";
		КонецЕсли;
		
	ИначеЕсли КодРегламента = "Nonformalized" Тогда
		КодТранзакции = "MainDocument";
		Если ПараметрыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИОП Тогда
			КодТранзакции = "ReceiveNotice";
		КонецЕсли;
		
		Если ПризнакПодписи Тогда
			КодТранзакции = "MainDocumentResign";
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат КодТранзакции;
	
КонецФункции

Функция ПолучитьКодРегламента(ЭлектронныйДокумент, ПрисоединенныйФайл)
	
	ПараметрыФайла = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПрисоединенныйФайл,
		"ТипЭлементаВерсииЭД, ЭлектронныйДокументВладелец");
	
	ПараметрыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЭлектронныйДокумент,
		"ВерсияРегламентаЭДО, ВидЭД");
	
	// Изменим код регламента при использовании версии регламента 20.
	Если ОбменСКонтрагентамиСлужебный.ЭтоСлужебныйДокумент(ПрисоединенныйФайл)
		И НЕ ОбменСКонтрагентамиСлужебный.ЭтоОтветныйТитул(ПараметрыФайла.ТипЭлементаВерсииЭД)
		И ЗначениеЗаполнено(ПараметрыФайла.ЭлектронныйДокументВладелец) Тогда
		КодРегламента = ПолучитьКодРегламента(ЭлектронныйДокумент, ПараметрыФайла.ЭлектронныйДокументВладелец);
	ИначеЕсли ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ЭСФ
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД
		ИЛИ ПараметрыФайла.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД Тогда
		КодРегламента = "Invoice";
	ИначеЕсли ПараметрыЭД.ВерсияРегламентаЭДО = Перечисления.ВерсииРегламентаОбмена1С.Версия20
		И (ПараметрыЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
			ИЛИ ПараметрыЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель
			ИЛИ ПараметрыЭД.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель
			ИЛИ ОбменСКонтрагентамиСлужебный.ЭтоОтветныйТитул(ПараметрыФайла.ТипЭлементаВерсииЭД)) Тогда
			КодРегламента = "Formalized";
	Иначе
		КодРегламента = "Nonformalized";
	КонецЕсли;
	
	Возврат КодРегламента;
	
КонецФункции

// Вызывается при формировании карточки пакета ЭД.
//
// Параметры:
//   ТипЭД               - ПеречислениеСсылка.ТипыЭД
//   ВРасширенномСоставе - Булево - состав типов был расширен, для обратной совместимости требуется передавать
//                         только старые типы (после расширения состава типов они передаются в новом реквизите
//                         карточки, а старые в прежнем).
//
// Возвращаемое значение:
//   Строка.
//
Функция СтрокаТипаДокументаПоПеречислению(ТипЭД, ВРасширенномСоставе = Ложь)
	
	ВозвращаемоеЗначение = "Other";
	Если ТипЭД = Перечисления.ТипыЭД.СчетНаОплату Тогда
		ВозвращаемоеЗначение = "Account";
	ИначеЕсли ТипЭД = Перечисления.ТипыЭД.АктВыполненныхРабот Тогда
		ВозвращаемоеЗначение = "Statement";
	ИначеЕсли ТипЭД = Перечисления.ТипыЭД.ТоварнаяНакладная Тогда
		ВозвращаемоеЗначение = "Consignment";
	ИначеЕсли ТипЭД = Перечисления.ТипыЭД.ПлатежноеПоручение Тогда
		ВозвращаемоеЗначение = "PaymentOrder";
	ИначеЕсли ТипЭД = Перечисления.ТипыЭД.Договор Тогда
		ВозвращаемоеЗначение = "Contract";
	ИначеЕсли ТипЭД = Перечисления.ТипыЭД.ПриложениеКАкту Тогда
		ВозвращаемоеЗначение = "StatementAppendix";
	ИначеЕсли ТипЭД = Перечисления.ТипыЭД.ГарантийноеПисьмо Тогда
		ВозвращаемоеЗначение = "GuaranteeLetter";
	ИначеЕсли ТипЭД = Перечисления.ТипыЭД.Прочее Тогда
		ВозвращаемоеЗначение = "Other";
	ИначеЕсли ВРасширенномСоставе Тогда
		Если ТипЭД = Перечисления.ТипыЭД.АктСверки Тогда
			ВозвращаемоеЗначение = "ReconciliationStatement";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.АктВзаимозачета Тогда
			ВозвращаемоеЗначение = "OffsettingStatement";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.КС11 Тогда
			ВозвращаемоеЗначение = "KS11";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.КС2 Тогда
			ВозвращаемоеЗначение = "KS2";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.КС3 Тогда
			ВозвращаемоеЗначение = "KS3";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.Отчет Тогда
			ВозвращаемоеЗначение = "Report";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.Уведомление Тогда
			ВозвращаемоеЗначение = "Notification";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.Ведомость Тогда
			ВозвращаемоеЗначение = "Sheet";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.СоглашениеОбЭДО Тогда
			ВозвращаемоеЗначение = "EDOAgreement";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.Спецификация Тогда
			ВозвращаемоеЗначение = "Specification";
		ИначеЕсли ТипЭД = Перечисления.ТипыЭД.ДополнительноеСоглашение Тогда
			ВозвращаемоеЗначение = "AdditionalAgreement";
		КонецЕсли;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция РасшифроватьМаркер(ИмяФайлаРезультата, ПарольКСертификатуОператора, Программа = Неопределено)
	
	Отказ = Ложь;
	МенеджерКриптографии = ЭлектронноеВзаимодействиеСлужебный.МенеджерКриптографии(Отказ, Истина, Программа);
	Если Отказ Тогда
		ТекстСообщения = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ПолучитьСообщениеОбОшибке("110");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ПарольКСертификатуОператора) Тогда
		МенеджерКриптографии.ПарольДоступаКЗакрытомуКлючу = ПарольКСертификатуОператора;
	КонецЕсли;
	Попытка
		РасшифрованныеДвоичныеДанные = МенеджерКриптографии.Расшифровать(ИмяФайлаРезультата);
	Исключение
		ТекстСообщения = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ПолучитьСообщениеОбОшибке("113");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецПопытки;
		
	Возврат РасшифрованныеДвоичныеДанные;
	
КонецФункции

Функция ПередатьПакетЭДОператораЭДО(Файл, Маркер, Соединение, Знач АдресРесурса, ПрофильНастроекЭДО, ПовторнаяОтправка = Ложь)
	
	ПараметрВозврата = 0;
	Если ЗначениеЗаполнено(Маркер) Тогда
		
		Заголовки = "";
		ДобавитьПараметрВЗаголовок(Заголовки, "Assistant-Key", Маркер);
		ИмяФайлаРезультата = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("txt");
		
		АдресРесурса = АдресРесурса + ?(АдресРесурса = "SendMessage", "/" + СтрЗаменить(Файл.Имя, "-", ""), "");
		
		Попытка
			Соединение.ОтправитьДляОбработки(Файл.ПолноеИмя, АдресРесурса, ИмяФайлаРезультата, Заголовки);
			ПараметрВозврата = 1;
		Исключение
			ПараметрВозврата = 0;
			
			ТекстОшибкиПоУмолчанию = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			Ошибка = ПрочитатьОписаниеОшибкиОператораЭДОИзФайла(ИмяФайлаРезультата, ТекстОшибкиПоУмолчанию);
			
			КодОшибки = Ошибка.Данные["ApiErrorCode"];
			ДополнительныеДанныеОшибки = Ошибка.Данные["AdditionalData"];
			Если КодОшибки = 2301 И ЗначениеЗаполнено(ДополнительныеДанныеОшибки) Тогда
				// Если номер ЭД отправляемого документа равен зарегистрированному у оператора, то
				// считаем данную транзакцию уже выполненной ранее.
				ПакетЭД = ПакетЭДПоНаименованию(Файл.ИмяБезРасширения);
				НомераЭД = НомераЭДВПакетеЭД(ПакетЭД);
				НомерЗарегистрированногоЭД = ДополнительныеДанныеОшибки;
				Если НомераЭД.Найти(НомерЗарегистрированногоЭД) <> Неопределено Тогда
					ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
					Возврат 1;
				КонецЕсли;
				
			ИначеЕсли КодОшибки = 1201 Тогда
				// Истек срок действия маркера доступа.
				ПовторнаяОтправка = Истина;
				Возврат 0;
				
			КонецЕсли;
			
			ШаблонСообщения = НСтр("ru = 'Отправка пакета по профилю настроек ЭДО: %1'");
			ТекстЗаголовкаСообщения = СтрШаблон(ШаблонСообщения, ПрофильНастроекЭДО);
			ТекстСообщения = ТекстЗаголовкаСообщения + Символы.ПС + Ошибка.Детали;
			ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
				ТекстЗаголовкаСообщения, Ошибка.Текст, ТекстСообщения);
				
		КонецПопытки;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
	КонецЕсли;
	
	Возврат ПараметрВозврата;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Получение электронных документов

Функция ПолучитьЭлектронныеДокументыОператораЭДО(Маркер, Соединение, АдресРесурса, ПрофильНастроекЭДО, ПовторноеПолучение = Ложь)
	
	ИмяФайлаРезультата = Неопределено;
	Если ЗначениеЗаполнено(Маркер) Тогда
		Заголовки = "";
		ДобавитьПараметрВЗаголовок(Заголовки, "Assistant-Key", Маркер);
		ИмяФайлаРезультата = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		Попытка
			Соединение.Получить(АдресРесурса, ИмяФайлаРезультата, Заголовки);
		Исключение
			
			Если ПовторноеПолучение Тогда
				ТекстОшибкиПоУмолчанию = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				Ошибка = ПрочитатьОписаниеОшибкиОператораЭДОИзФайла(ИмяФайлаРезультата, ТекстОшибкиПоУмолчанию);
				ТекстЗаголовкаСообщения = НСтр("ru = 'Получение ЭД'");
				ТекстСообщения = ТекстЗаголовкаСообщения + Символы.ПС
					+ НСтр("ru = 'Ошибка получения входящих электронных документов на сервере оператора ЭДО.'") + Символы.ПС
					+ Ошибка.Детали;
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
					ТекстЗаголовкаСообщения, Ошибка.Текст, ТекстСообщения);
			КонецЕсли;
			
			// Если возникла ошибка по причине истечения времени действия маркера,
			// то пробуем получить новый маркер и повторить попытку получения ЭД.
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
			ИмяФайлаРезультата = Неопределено;
			
			// Повторное получение ЭД. Только одна попытка.
			ПовторноеПолучение = Не ПовторноеПолучение;
			
		КонецПопытки;
	КонецЕсли;
	
	Возврат ИмяФайлаРезультата;
	
КонецФункции

Функция РазобратьТекстСпискаЭД(СписокЭД_XML, ТЗ)
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("ИДДокументооборота", Новый ОписаниеТипов("Строка"));
	ТЗ.Колонки.Добавить("КодТранзакции", Новый ОписаниеТипов("Строка"));
	ТЗ.Колонки.Добавить("ИДДокумента", 	Новый ОписаниеТипов("Строка", ,
		Новый КвалификаторыСтроки(80, ДопустимаяДлина.Переменная)));
	ТЗ.Колонки.Добавить("Приоритет", Новый ОписаниеТипов("Число"));
	
	ДатаВремяЗапроса = Неопределено;
	
	Если ЗначениеЗаполнено(СписокЭД_XML) Тогда
		
		ЧтениеXML = Новый ЧтениеXML;
		ЧтениеXML.ОткрытьФайл(СписокЭД_XML);
		
		ИДДокументооборота = Неопределено;
		КодТранзакции      = Неопределено;
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "ContainerDescription" Тогда
				ДатаВремяЗапроса = ЧтениеXML.ПолучитьАтрибут("LastRecordDateTime");
				Продолжить;
			КонецЕсли;
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "DocFlow" Тогда
				ИДДокументооборота = ЧтениеXML.ПолучитьАтрибут("Id");
				Продолжить;
			КонецЕсли;
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "Document" Тогда
				КодТранзакции      = ЧтениеXML.ПолучитьАтрибут("TransactionCode");
				Продолжить;
			КонецЕсли;
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "Identifiers" Тогда
				
				СтрТЗ = ТЗ.Добавить();
				СтрТЗ.ИДДокументооборота = ИДДокументооборота;
				СтрТЗ.ИДДокумента        = ЧтениеXML.ПолучитьАтрибут("InternalId");
				СтрТЗ.КодТранзакции      = КодТранзакции;
				
				Если КодТранзакции = "MainDocument" Тогда
					
					СтрТЗ.Приоритет = 0;
				ИначеЕсли КодТранзакции = "VendorTitle" ИЛИ КодТранзакции = "CustomerTitle" Тогда
					
					СтрТЗ.Приоритет = 1;
				ИначеЕсли КодТранзакции = "Invoice" Тогда
					
					СтрТЗ.Приоритет = 2;
				ИначеЕсли КодТранзакции = "PostDateConfirmation"
					ИЛИ КодТранзакции = "SendConfirmation"
					ИЛИ КодТранзакции = "ReceiveNoticePostDateConfirmation" Тогда
					
					СтрТЗ.Приоритет = 3;
				ИначеЕсли КодТранзакции = "ReceiveNotice" Тогда
					
					СтрТЗ.Приоритет = 4;
				ИначеЕсли КодТранзакции = "MainDocumentReject" Тогда
					
					СтрТЗ.Приоритет = 5;
				Иначе
					
					СтрТЗ.Приоритет = 6;
				КонецЕсли;
				
				Продолжить;
			КонецЕсли;
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "Type" Тогда
				
				ТипДокумента = ЧтениеXML.ПолучитьАтрибут("Name");
				
				Если КодТранзакции = "Invoice"
					И (ТипДокумента = "PrimaryAccountingDocumentVendor"
						ИЛИ ТипДокумента = "PrimaryAccountingDocumentCustomer"
						ИЛИ ТипДокумента = "CorPrimaryAccountingDocumentVendor"
						ИЛИ ТипДокумента = "CorPrimaryAccountingDocumentCustomer") Тогда
					
					СтрТЗ.Приоритет = 1;
				КонецЕсли;
				Продолжить;
			КонецЕсли;
		КонецЦикла;
		
		ТЗ.Сортировать("Приоритет");
	КонецЕсли;
	
	Возврат ДатаВремяЗапроса;
	
КонецФункции

Функция ПолучитьЭДОператораЭДО(Маркер, Соединение, СтруктураПараметровЗапросаМаркера, ИДДокумента, ПрофильНастроекЭДО, ПовторноеПолучение = Ложь)
	
	ИмяФайлаРезультата = Неопределено;
	Если ЗначениеЗаполнено(Маркер) Тогда
		АдресРесурса = "GetMessage/" + ИДДокумента + "?status=deferred";
		Заголовки = "";
		
		ДобавитьПараметрВЗаголовок(Заголовки, "Assistant-Key", Маркер);
		ИмяФайлаРезультата = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		Попытка
			Соединение.Получить(АдресРесурса, ИмяФайлаРезультата, Заголовки);
		Исключение
			
			Если ПовторноеПолучение Тогда
				ТекстОшибкиПоУмолчанию = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				Ошибка = ПрочитатьОписаниеОшибкиОператораЭДОИзФайла(ИмяФайлаРезультата, ТекстОшибкиПоУмолчанию);
				ТекстЗаголовкаСообщения = СтрШаблон(НСтр("ru = 'Получение пакета по профилю настроек ЭДО: %1'"), ПрофильНастроекЭДО);
				ТекстСообщения = ТекстЗаголовкаСообщения + Символы.ПС + Ошибка.Детали;
				ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(
					ТекстЗаголовкаСообщения, Ошибка.Текст, ТекстСообщения);
			КонецЕсли;
			
			// Если возникла ошибка по причине истечения времени действия маркера,
			// то пробуем получить новый маркер и повторить попытку получения ЭД.
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайлаРезультата);
			ИмяФайлаРезультата = Неопределено;
			
			// Повторное получение ЭД. Только одна попытка.
			ПовторноеПолучение = Не ПовторноеПолучение;
			
		КонецПопытки;
	КонецЕсли;
	
	Возврат ИмяФайлаРезультата;
	
КонецФункции

Функция ПодтвердитьПолучениеЭДОператораЭДО(Маркер, Соединение, ИДДокумента)
	
	Результат = Истина;
	
	Если ЗначениеЗаполнено(Маркер) Тогда
		
		АдресРесурса = "GetMessageConfirm/" + ИДДокумента;
		Заголовки = Новый Соответствие;
		Заголовки.Вставить("Assistant-Key", Маркер);
		
		Запрос = Новый HTTPЗапрос(АдресРесурса, Заголовки);
		
		Попытка
			Соединение.Получить(Запрос);
		Исключение
			Результат = Ложь;
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьДанныеВходящегоЭД(ДвоичныеДанные, КодТранзакции, ИДДокументооборота, ИДДокумента)
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтруктураПараметров = Неопределено;
	НастройкиСоглашения = Неопределено;
	ЭДНайден = Ложь;
	
	Если КодТранзакции = "PostDateConfirmation"
		ИЛИ КодТранзакции = "SendConfirmation" 
		ИЛИ КодТранзакции = "ReceiveNoticePostDateConfirmation"
		ИЛИ КодТранзакции = "CustomerInformationPostDateConfirmation" Тогда
		
		Если КодТранзакции = "PostDateConfirmation" Тогда
			
			ЭДСсылка = Справочники.ЭДПрисоединенныеФайлы.ПолучитьСсылку(Новый УникальныйИдентификатор(ИДДокументооборота));
			ЭДНайден = (ЭДСсылка.ПолучитьОбъект() <> Неопределено);
			
		ИначеЕсли КодТранзакции = "CustomerInformationPostDateConfirmation" Тогда
			
			СтруктураПараметровПоиска = Новый Структура;
			СтруктураПараметровПоиска.Вставить("УникальныйИД",  ИДДокументооборота);
			СтруктураПараметровПоиска.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Входящий);
			
			ТипЭлементаВерсииЭД = Новый массив;
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ЭСФ);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД);
			СтруктураПараметровПоиска.Вставить("ТипЭлементаВерсииЭД", ТипЭлементаВерсииЭД);
			
			ЭлектронныйДокументВладелец = ОбменСКонтрагентамиСлужебный.ОпределитьЭлектронныйДокумент(СтруктураПараметровПоиска);
			
			ТипЭлементаВерсииЭД = Новый массив;
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД);
			СтруктураПараметровПоиска.Вставить("ТипЭлементаВерсииЭД", ТипЭлементаВерсииЭД);
			
			СтруктураПараметровПоиска.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Исходящий);
			СтруктураПараметровПоиска.Вставить("ЭлектронныйДокументВладелец", ЭлектронныйДокументВладелец);
			
			ЭДСсылка = ОбменСКонтрагентамиСлужебный.ОпределитьЭлектронныйДокумент(СтруктураПараметровПоиска);
			ЭДНайден = (ЭДСсылка <> Неопределено);
			
		Иначе
			
			СтруктураПараметровПоиска = Новый Структура;
			СтруктураПараметровПоиска.Вставить("УникальныйИД", ИДДокументооборота);
			СтруктураПараметровПоиска.Вставить("НаправлениеЭД",       Перечисления.НаправленияЭД.Входящий);
			
			ТипЭлементаВерсииЭД = Новый массив;
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ЭСФ);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД);
			ТипЭлементаВерсииЭД.Добавить(Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД);
			СтруктураПараметровПоиска.Вставить("ТипЭлементаВерсииЭД", ТипЭлементаВерсииЭД);
			
			ЭДСсылка = ОбменСКонтрагентамиСлужебный.ОпределитьЭлектронныйДокумент(СтруктураПараметровПоиска);
			ЭДНайден = (ЭДСсылка <> Неопределено);
			
		КонецЕсли;
		
		Если ЭДНайден Тогда

			ПараметрыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЭДСсылка, "ВладелецФайла, ОтправительЭД, ПолучательЭД");
			ПараметрыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПараметрыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО.СпособОбменаЭД, 
				|НастройкаЭДО, Организация, Контрагент, ПрофильНастроекЭДО");
			
			НастройкиСоглашения = Новый Структура;
			НастройкиСоглашения.Вставить("ПрофильНастроекЭДО", ПараметрыЭД.ПрофильНастроекЭДО);
			НастройкиСоглашения.Вставить("НастройкаЭДО",       ПараметрыЭД.НастройкаЭДО);
			НастройкиСоглашения.Вставить("СпособОбменаЭД",     ПараметрыЭД.ПрофильНастроекЭДОСпособОбменаЭД);
			НастройкиСоглашения.Вставить("Организация",        ПараметрыЭД.Организация);
			НастройкиСоглашения.Вставить("Контрагент",         ПараметрыЭД.Контрагент);
			НастройкиСоглашения.Вставить("АдресОтправителя",   "");
			НастройкиСоглашения.Вставить("АдресПолучателя",    "");
			ИДОтправителя = ПараметрыФайлаЭД.ОтправительЭД;
			ИДПолучателя  = ПараметрыФайлаЭД.ПолучательЭД;
		КонецЕсли;
		
	Иначе
		
		ИмяВременногоФайлаЗИП = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("zip");
		ДвоичныеДанные.Записать(ИмяВременногоФайлаЗИП);
		
		КлючУникальности = Новый УникальныйИдентификатор();
		ПапкаДляРаспаковки = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог("input", КлючУникальности);
		
		ОшибкаРаспаковки = Не РаспаковатьАрхив(ИмяВременногоФайлаЗИП, ПапкаДляРаспаковки,
			НСтр("ru = 'Распаковка пакета ЭД'"), РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
		
		Если НЕ ОшибкаРаспаковки Тогда
			
			МассФайлКарточки  = НайтиФайлы(ПапкаДляРаспаковки, "card*.xml", Истина);
			
			Если МассФайлКарточки.Количество() > 0 Тогда
				ФайлКарточки = МассФайлКарточки[0];
			Иначе
				ФайлКарточки = Неопределено;
			КонецЕсли;
			
			ИДПолучателя  = Неопределено;
			ИДОтправителя = Неопределено;
			Если ФайлКарточки <> Неопределено Тогда
				
				ОбъектXML = Новый ЧтениеXML;
				СтруктураЗначений = Новый Структура;
				
				Попытка
					ОбъектXML.ОткрытьФайл(ФайлКарточки.ПолноеИмя);
					ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
					ОбъектXML.Закрыть();
					Если Не ЭД.Sender.Свойства().Получить("Abonent") = Неопределено Тогда
						ИДОтправителя = ЭД.Sender.Abonent.ID;
					КонецЕсли;
					
					Если Не ЭД.Receiver.Свойства().Получить("Abonent") = Неопределено Тогда
						ИДПолучателя  = ЭД.Receiver.Abonent.ID;
					КонецЕсли;
					
					// В служебных транзакциях, например, ошибках отправителем является оператор. Поэтому единственный способ
					// корректно определить отправителя, а затем и настройку - это найти исходный документ по идентификатору документооборота.
					Если ИДОтправителя = Неопределено И ИДДокументооборота <> Неопределено И ИДПолучателя <> Неопределено Тогда
						ИДОтправителя = ПолучитьИДОтправителяПоДаннымДокументооборота(ИДДокументооборота, ИДПолучателя);
					КонецЕсли;
					
					НастройкиСоглашения = ОбменСКонтрагентамиСлужебный.ПолучитьНастройкиОбменаЭДПоИД(ИДПолучателя, ИДОтправителя);
					
				Исключение
					ОбъектXML.Закрыть();
					
					ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из файла %1: %2.'");
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
						ФайлКарточки.ПолноеИмя, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
					ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
																								ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																								ТекстСообщения);
					НастройкиСоглашения = Неопределено;
					
				КонецПопытки;
			КонецЕсли;
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяВременногоФайлаЗИП);
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
		
	КонецЕсли;
	
	Если НастройкиСоглашения <> Неопределено Тогда
		
		СтруктураПараметров = Новый Структура;
		СтруктураПараметров.Вставить("ПрофильНастроекЭДО",  НастройкиСоглашения.ПрофильНастроекЭДО);
		СтруктураПараметров.Вставить("СпособОбменаЭД",      НастройкиСоглашения.СпособОбменаЭД);
		СтруктураПараметров.Вставить("НастройкаЭДО",        НастройкиСоглашения.НастройкаЭДО);
		СтруктураПараметров.Вставить("Получатель",          ИДПолучателя);
		СтруктураПараметров.Вставить("Отправитель",         ИДОтправителя);
		СтруктураПараметров.Вставить("АдресОтправителя",    НастройкиСоглашения.АдресОтправителя);
		СтруктураПараметров.Вставить("АдресПолучателя",     НастройкиСоглашения.АдресПолучателя);
		СтруктураПараметров.Вставить("Организация",         НастройкиСоглашения.Организация);
		СтруктураПараметров.Вставить("Контрагент",          НастройкиСоглашения.Контрагент);
		СтруктураПараметров.Вставить("Зашифрован",          Ложь); // Шифрование данных через Оператора не поддерживается.
		СтруктураПараметров.Вставить("СертификатОрганизацииДляРасшифровки", Неопределено);
		СтруктураПараметров.Вставить("ВерсияФорматаПакета", Перечисления.ВерсииФорматаПакетаЭД.Версия30);
		СтруктураПараметров.Вставить("ВнешнийУИД",          ИДДокумента);
		СтруктураПараметров.Вставить("СтатусПакета",        Перечисления.СтатусыПакетовЭД.КРаспаковке);
		СтруктураПараметров.Вставить("НаправленияЭД",       Перечисления.НаправленияЭД.Входящий);
		
	КонецЕсли;
	
	Возврат СтруктураПараметров;
	
КонецФункции

Функция ПолучитьИДОтправителяПоДаннымДокументооборота(ИДДокументооборота, ИДПолучателя)

	Результат = Неопределено;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ИДПолучателя", ИДПолучателя);
	Запрос.УстановитьПараметр("ИДДокументооборота", ИДДокументооборота);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	ЭлектронныйДокументИсходящий.НастройкаЭДО.ИдентификаторКонтрагента КАК ИдОтправителя
	|ИЗ
	|	Документ.ЭлектронныйДокументИсходящий КАК ЭлектронныйДокументИсходящий
	|ГДЕ
	|	ЭлектронныйДокументИсходящий.УникальныйИД = &ИДДокументооборота
	|	И (ВЫРАЗИТЬ(ЭлектронныйДокументИсходящий.НастройкаЭДО.ИдентификаторОрганизации КАК СТРОКА(50))) = &ИДПолучателя
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЭлектронныйДокументВходящий.НастройкаЭДО.ИдентификаторКонтрагента
	|ИЗ
	|	Документ.ЭлектронныйДокументВходящий КАК ЭлектронныйДокументВходящий
	|ГДЕ
	|	ЭлектронныйДокументВходящий.УникальныйИД = &ИДДокументооборота
	|	И (ВЫРАЗИТЬ(ЭлектронныйДокументВходящий.НастройкаЭДО.ИдентификаторОрганизации КАК СТРОКА(50))) = &ИДПолучателя";
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.ИдОтправителя;
	КонецЕсли;
	
	Возврат Результат;

КонецФункции


////////////////////////////////////////////////////////////////////////////////
// Распаковка пакетов электронных документов

Функция ПолучитьИмяФайлаДанных(СтрокаПути)
	
	ПозицияСлэш = СтрНайти(СтрокаПути, "/");
	Пока ПозицияСлэш > 0 Цикл
		СтрокаПути = Сред(СтрокаПути, ПозицияСлэш + 1);
		ПозицияСлэш = СтрНайти(СтрокаПути, "/");
	КонецЦикла;
	Возврат СтрокаПути;
	
КонецФункции

Функция РазобратьСтрокуДаты(ПараметрРазбора)
	
	Возврат Сред(ПараметрРазбора, 7, 4) + Сред(ПараметрРазбора, 4, 2) + Сред(ПараметрРазбора, 1, 2);
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Формат обмена

Функция СформироватьКарточкуCML(ДеревоДанных, Ошибки)
	
	ПутьКОписанию = "{http://api-invoice.taxcom.ru/card}.Card";
	Попытка
		Карточка = ПолучитьОбъектТипаCML(ПутьКОписанию);
		
		АбонентОтправитель = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Sender.Abonent");
		ЗаполнитьСвойствоXDTO(АбонентОтправитель, "Id", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Отправитель.ИД"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АбонентОтправитель, "Name",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Отправитель.Наименование"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АбонентОтправитель, "Inn", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Отправитель.ИНН"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АбонентОтправитель, "Kpp", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Отправитель.КПП"), , Ошибки);
		ЗаполнитьСвойствоXDTO(АбонентОтправитель, "ContractNumber",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Отправитель.НомерДоговора"), , Ошибки);
		
		Отправитель = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Sender");
		ЗаполнитьСвойствоXDTO(Отправитель, "Abonent", АбонентОтправитель, , Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.Тип")) Тогда
			АбонентПолучатель  = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Receiver.Organization");
			
			ЗаполнитьСвойствоXDTO(АбонентПолучатель, "Name",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.Наименование"), , Ошибки);
			ЗаполнитьСвойствоXDTO(АбонентПолучатель, "Type",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.Тип"), , Ошибки);
			ИмяСвойства = "Organization";
		Иначе
			АбонентПолучатель  = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Receiver.Abonent");
			
			ЗаполнитьСвойствоXDTO(АбонентПолучатель, "Id", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.ИД"), , Ошибки);
			ЗаполнитьСвойствоXDTO(АбонентПолучатель, "Name",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.Наименование"), , Ошибки);
			ЗаполнитьСвойствоXDTO(АбонентПолучатель, "Inn", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.ИНН"), , Ошибки);
			ЗаполнитьСвойствоXDTO(АбонентПолучатель, "Kpp", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.КПП"), , Ошибки);
			ЗаполнитьСвойствоXDTO(АбонентПолучатель, "ContractNumber",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Получатель.НомерДоговора"), , Ошибки);
			ИмяСвойства = "Abonent";
		КонецЕсли;
		
		Получатель  = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Receiver");
		ЗаполнитьСвойствоXDTO(Получатель, ИмяСвойства, АбонентПолучатель, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(Карточка, "Sender", Отправитель, , Ошибки);
		ЗаполнитьСвойствоXDTO(Карточка, "Receiver", Получатель, , Ошибки);
		
		Идентификаторы = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Identifiers");
		ЗаполнитьСвойствоXDTO(Идентификаторы, "ExternalIdentifier",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Определение.ВнешнийИдентификатор"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Карточка, "Identifiers", Идентификаторы, , Ошибки);
		
		Тип = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Type");
		ЗаполнитьСвойствоXDTO(Тип, "Name", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Определение.Имя"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Тип, "ResignRequired",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Определение.ТребуетсяПовторнаяПодпись"), , Ошибки);
			
		Описание = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Description");
		ЗаполнитьСвойствоXDTO(Описание, "Title", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Описание.Заголовок"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Описание, "Date", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Описание.Дата"), , Ошибки);
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Описание.Комментарий")) Тогда
			ЗаполнитьСвойствоXDTO(Описание, "Comment", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Описание.Комментарий"), , Ошибки);
		КонецЕсли;
		
		СтрокаТаблицыДополнительныхДанных = ДеревоДанных.Строки.Найти("Описание.ДополнительныеДанные", "ПолныйПуть", Истина);
		Если ЗначениеЗаполнено(СтрокаТаблицыДополнительныхДанных.Значение) Тогда
			ОписаниеДопДанные = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Description.AdditionalData");
			Для Каждого СтрокаДопДанных Из СтрокаТаблицыДополнительныхДанных.Строки Цикл
				ДопДанные = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Description.AdditionalData.AdditionalParameter");
				
				ЗаполнитьСвойствоXDTO(ДопДанные, "Name",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДопДанных, "Описание.ДополнительныеДанные.НомерСтроки.Имя"), , Ошибки);
				ЗаполнитьСвойствоXDTO(ДопДанные, "Value",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДопДанных, "Описание.ДополнительныеДанные.НомерСтроки.Значение"), , Ошибки);
				ОписаниеДопДанные.AdditionalParameter.Добавить(ДопДанные);
			КонецЦикла;
			
			ЗаполнитьСвойствоXDTO(Описание, "AdditionalData", ОписаниеДопДанные, , Ошибки);
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(Карточка, "Type", Тип, , Ошибки);
		ЗаполнитьСвойствоXDTO(Карточка, "Description", Описание, , Ошибки);
		
		Карточка.Проверить();
		
		ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Карточка, ИмяФайла, Ложь);
		
		Возврат ИмяФайла;
	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование карточки CML'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		Возврат "";
	КонецПопытки;
	
КонецФункции

Функция СформироватьТранспортнуюИнформациюCML(ДеревоДанных, Ошибки)
	
	ПутьКОписанию = "{http://api-invoice.taxcom.ru/meta}.ContainerDescription";
	Попытка
		
		ОписаниеКонтейнера = ПолучитьОбъектТипаCML(ПутьКОписанию);
		
		Документооборот = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow");
		ЗаполнитьСвойствоXDTO(Документооборот, "ID", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИД"), , Ошибки);
		
		ДокументыСхемы  = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents");
		Документ     = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents.Document"); 
		
		ЗаполнитьСвойствоXDTO(Документ, "TransactionCode",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.КодТранзакции"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ReglamentCode",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.КодРегламента"), , Ошибки);
		
		Файлы = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents.Document.Files");
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ГлавныйФайл.Путь")) Тогда
			ФайлДанных = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents.Document.Files.MainImage");
			ИмяФайла = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ГлавныйФайл.Имя");
			Если ЗначениеЗаполнено(ИмяФайла) Тогда
				ЗаполнитьСвойствоXDTO(ФайлДанных, "Name", ИмяФайла, , Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(ФайлДанных, "Path", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ГлавныйФайл.Путь"),
				Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(Файлы, "MainImage", ФайлДанных, , Ошибки);
		КонецЕсли;
		
		СтрокаТаблицыПодписейГлавногоФайла = ДеревоДанных.Строки.Найти("Документ.ГлавныйФайлПодписи", "ПолныйПуть", Истина);
		Если ЗначениеЗаполнено(СтрокаТаблицыПодписейГлавногоФайла.Значение) Тогда
			Для Каждого СтрПодпись Из СтрокаТаблицыПодписейГлавногоФайла.Строки Цикл
				Подпись = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents.Document.Files.MainImageSignature");
				ИмяФайла = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрПодпись, "Документ.ГлавныйФайлПодписи.НомерСтроки.Имя");
				Если ЗначениеЗаполнено(ИмяФайла) Тогда
					ЗаполнитьСвойствоXDTO(Подпись, "Name", ИмяФайла, , Ошибки);
				КонецЕсли;
				Путь = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрПодпись, "Документ.ГлавныйФайлПодписи.НомерСтроки.Путь");
				ЗаполнитьСвойствоXDTO(Подпись, "Path", Путь, Истина, Ошибки);
				Файлы.MainImageSignature.Добавить(Подпись);
			КонецЦикла;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ДополнительныйФайл.Путь")) Тогда
			ФайлДанных = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents.Document.Files.DataImage");
			ИмяФайла = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ДополнительныйФайл.Имя");
			Если ЗначениеЗаполнено(ИмяФайла) Тогда
				ЗаполнитьСвойствоXDTO(ФайлДанных, "Name", ИмяФайла, , Ошибки);
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(ФайлДанных, "Path", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ДополнительныйФайл.Путь"),
				Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(Файлы, "DataImage", ФайлДанных, , Ошибки);
			
			СтрокаТаблицыПодписейДополнительногоФайла = ДеревоДанных.Строки.Найти("Документ.ДополнительныйФайлПодписи", "ПолныйПуть", Истина);
			Если ЗначениеЗаполнено(СтрокаТаблицыПодписейДополнительногоФайла.Значение) Тогда
				
				Для Каждого СтрПодпись Из СтрокаТаблицыПодписейДополнительногоФайла.Строки Цикл
					Подпись = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents.Document.Files.DataImageSignature");
					ИмяФайла = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ДополнительныйФайлПодписи.НомерСтроки.Имя");
					Если ЗначениеЗаполнено(ИмяФайла) Тогда
						ЗаполнитьСвойствоXDTO(Подпись, "Name", ИмяФайла, , Ошибки);
					КонецЕсли;
					ЗаполнитьСвойствоXDTO(Подпись, "Path", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Документ.ДополнительныйФайлПодписи.НомерСтроки.Путь"),
						Истина, Ошибки);
					Файлы.DataImageSignature.Добавить(Подпись);
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		ФайлКарточки = ПолучитьОбъектТипаCML(ПутьКОписанию + ".DocFlow.Documents.Document.Files.ExternalCard");
		ЗаполнитьСвойствоXDTO(ФайлКарточки, "Path", "card.xml", , Ошибки);
		ЗаполнитьСвойствоXDTO(Файлы, "ExternalCard", ФайлКарточки, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "Files", Файлы, , Ошибки);
		ДокументыСхемы.Document.Добавить(Документ);
		
		ЗаполнитьСвойствоXDTO(Документооборот, "Documents", ДокументыСхемы, , Ошибки);
		ОписаниеКонтейнера.DocFlow.Добавить(Документооборот);
		
		ОписаниеКонтейнера.Проверить();
		
		ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(ОписаниеКонтейнера, ИмяФайла, Ложь);
		
		Возврат ИмяФайла;
		
	Исключение
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		ТекстСообщения = ?(ЗначениеЗаполнено(ТекстОшибки), ТекстОшибки, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование транспортной информации'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		Возврат "";
	КонецПопытки;
	
КонецФункции


////////////////////////////////////////////////////////////////////////////////
// Приглашения к обмену

// Читает запрос приглашений от оператора ЭДО.
//
// Параметры:
//  ИмяФайла  - строка - имя файла
//  ТаблицаКонтрагентов  - таблица значений - список контрагентов.
//
Процедура ПрочитатьЗапросПриглашенияОператораЭДО(ИмяФайла, ТаблицаКонтрагентов, ДатаВремяЗапроса, ПрофильНастроекЭДО)
	
	ОбъектXML = Новый ЧтениеXML;
	ТекстСообщения = Неопределено;
	ДатаВремяЗапроса = Формат(Дата("20000101000000"), "ДФ='yyyy-MM-dd HH:mm:ss'");
	
	Попытка
		
		ОбъектXML.ОткрытьФайл(ИмяФайла);
		ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
		ОбъектXML.Закрыть();
		
		ДатаВремяЗапроса = ЭД.Asof;
		
		Если ЭД.Свойства().Получить("Contact") <> Неопределено Тогда
			
			Если ТипЗнч(ЭД.Contact) = Тип("СписокXDTO") Тогда
				Для Каждого Контакт Из ЭД.Contact Цикл
					ПрочитатьКонтакт(Контакт, ТаблицаКонтрагентов, ПрофильНастроекЭДО);
				КонецЦикла;
			ИначеЕсли ТипЗнч(ЭД.Contact) = Тип("ОбъектXDTO") Тогда
				ПрочитатьКонтакт(ЭД.Contact, ТаблицаКонтрагентов, ПрофильНастроекЭДО);
			КонецЕсли;
			
		КонецЕсли;
		
	Исключение
		
		ОбъектXML.Закрыть();
		ШаблонСообщения = НСтр("ru = 'Возникла ошибка при чтении данных из файла %1: %2.'");
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			ИмяФайла, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Чтение ЭД.'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
	КонецПопытки;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Обмен с оператором ЭДО

Функция ИдентификаторИнтеграционногоРешения()

	Возврат "1C_22BFE9D5-E77D-424A-BC6D-D8A3496C05FE";

КонецФункции 

// Работа с деревом

Процедура ВставитьЗначениеВДерево(ДеревоДанных, ИмяРеквизита, ЗначениеРеквизита)
	
	НовСтрока = ДеревоДанных.Строки.Найти(ИмяРеквизита, "ПолныйПуть", Истина);
	Если НовСтрока = Неопределено Тогда
		НовСтрока = ДеревоДанных.Строки.Добавить();
		НомерУровня = СтрЧислоВхождений(ИмяРеквизита, ".") + 1;
		НовСтрока.ПолныйПуть = ИмяРеквизита;
		НовСтрока["Уровень" + НомерУровня] = ЭлектронноеВзаимодействие.НазваниеКолонки(ИмяРеквизита);
	КонецЕсли;
	НовСтрока.Значение = ЗначениеРеквизита;

КонецПроцедуры

Процедура ДобавитьСлужебныеПоляФНС(ДеревоДанных, СтруктураЭД)
	
	ВставитьЗначениеВДерево(ДеревоДанных, "ВерсПрог", "1С:Предприятие 8");
	ВставитьЗначениеВДерево(ДеревоДанных, "ВерсФорм", "5.01");
	ВставитьЗначениеВДерево(ДеревоДанных, "ИдОтпр",   СтруктураЭД.Отправитель);
	ВставитьЗначениеВДерево(ДеревоДанных, "ИдПок",    СтруктураЭД.Получатель);
	
	Если СтруктураЭД.Свойство("ПространствоИмен") Тогда
		ВставитьЗначениеВДерево(ДеревоДанных, "ПространствоИмен", СтруктураЭД.ПространствоИмен);
	КонецЕсли;
	
	Если СтруктураЭД.ПрофильНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском
		ИЛИ СтруктураЭД.ПрофильНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
		ДобавитьРеквизитыОператораЭДО(ДеревоДанных);
	ИначеЕсли СтруктураЭД.ПрофильНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезСервис1СЭДО Тогда
		
		СтрокаРеквизитыОператора = ДеревоДанных.Строки.Добавить();
		СтрокаРеквизитыОператора.ПолныйПуть = "РеквизитыОператораЭДО";
		ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.НаимОрг", СтруктураЭД.ПрофильНастроекЭДО.ОператорЭДО);
		ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.ИННЮЛ",   СтруктураЭД.ПрофильНастроекЭДО.ОператорЭДОИНН);
		ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.ИдЭДО",   СтруктураЭД.ПрофильНастроекЭДО.ОператорЭДОИд);
	Иначе // заполним данными Организации или нулевыми значениями, т.к. поля обязательны к заполнению в формате ФНС.
		ДобавитьРеквизитыПустогоОператораЭДО(ДеревоДанных, СтруктураЭД.Организация);
	КонецЕсли;
	ТекДатаВремя = ТекущаяДатаСеанса();
	ВставитьЗначениеВДерево(ДеревоДанных, "ДатаДок", Формат(ТекДатаВремя, "ДЛФ=D"));
	ВставитьЗначениеВДерево(ДеревоДанных, "ВремДок", Формат(ТекДатаВремя, "ДФ=HH.mm.ss"));
	Если СтруктураЭД.Свойство("ВидЭД") Тогда
		ВставитьЗначениеВДерево(ДеревоДанных, "ВидЭД", СтруктураЭД.ВидЭД);
	КонецЕсли;
	ВставитьЗначениеВДерево(ДеревоДанных, "КНД", СтруктураЭД.КНД);
	ВставитьЗначениеВДерево(ДеревоДанных, "УникальныйИдентификатор", СтруктураЭД.УникальныйИдентификатор);
	
	Если СтруктураЭД.Свойство("ВидЭД") И СтруктураЭД.ВидЭД <> Перечисления.ВидыЭД.СчетФактура
		И СтруктураЭД.ВидЭД <> Перечисления.ВидыЭД.КорректировочныйСчетФактура Тогда
		Если СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель
			ИЛИ СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец Тогда
			ВставитьЗначениеВДерево(ДеревоДанных, "НаимПервДок", "Товарная накладная");
			ВставитьЗначениеВДерево(ДеревоДанных, "ОКУДПервДок", "0330212");
			ВставитьЗначениеВДерево(ДеревоДанных, "НомФорм",     "ТОРГ-12");
		ИначеЕсли СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.АктЗаказчик
			ИЛИ СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель Тогда
			
			ВставитьЗначениеВДерево(ДеревоДанных, "НаимПервДок", НСтр("ru ='Акт о выполнении работ (оказании услуг)'"));
		ИначеЕсли СтруктураЭД.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель Тогда
			
			ВставитьЗначениеВДерево(ДеревоДанных, "НомФорм", НСтр("ru ='Корректировочный документ получатель'"));
		КонецЕсли;
	КонецЕсли;
	ГГГГММДД = СтрЗаменить(Формат(ТекДатаВремя, "ДФ=yyyy-MM-dd"), "-", "");
	
	СтруктураФайла = Новый Структура();
	СтруктураФайла.Вставить("Префикс",                 СтруктураЭД.ПрефиксИдФайла);
	СтруктураФайла.Вставить("ИДПолучателя",            СтруктураЭД.Получатель);
	СтруктураФайла.Вставить("ИДОтправителя",           СтруктураЭД.Отправитель);
	СтруктураФайла.Вставить("ГГГГММДД",                ГГГГММДД);
	СтруктураФайла.Вставить("УникальныйИдентификатор", СтруктураЭД.УникальныйИдентификатор);
	
	ВставитьЗначениеВДерево(ДеревоДанных, "ИдФайл", ОбменСКонтрагентамиСлужебный.ФНСИмяФайла(СтруктураФайла));
	
КонецПроцедуры

Функция ЗаполнитьДанныеУчастникаФНС(УчастникXDTO, СтрокаДереваДанных, Ошибки, ПространствоИменСхемы, ВидУчастника)
	
	ДанныеЗаполнены = Ложь;
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника")) Тогда
		
		ИдСв = ПолучитьОбъектТипаCML("УчастникТип.ИдСв", ПространствоИменСхемы);
		
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
			
			СвФЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвФЛ", ПространствоИменСхемы);
			ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН");
			ЗаполнитьСвойствоXDTO(СвФЛ, "ИННФЛ", ИНН, , Ошибки);
			ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
			Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия");
			ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
			Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя");
			ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
			Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество");
			ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
			
			Если ПространствоИменСхемы = "TORGPR" Или ПространствоИменСхемы = "RUISP" Тогда
				ЗаполнитьСвойствоXDTO(СвФЛ, "ФИО", ФИО,  , Ошибки);
			Иначе
				ЗаполнитьСвойствоXDTO(СвФЛ, "ФИОИП", ФИО,  , Ошибки);
			КонецЕсли;
			
			ЗаполнитьСвойствоXDTO(ИдСв, "СвФЛ",  СвФЛ, , Ошибки);
			Если ПространствоИменСхемы = "IAKTPRM2" Тогда
				СвЮЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвЮЛ", ПространствоИменСхемы);
				ЗаполнитьСвойствоXDTO(СвЮЛ, "НаимОрг", "---", , Ошибки);
				ЗаполнитьСвойствоXDTO(ИдСв, "СвЮЛ",    СвЮЛ,  , Ошибки);
			КонецЕсли;
			Наименование = Фамилия + " " + Имя + " " + Отчество;
			
		ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
			
			Если ПространствоИменСхемы = ПространствоИменПередачаТоваровПродавец()
				Или ПространствоИменСхемы = ПространствоИменПередачаРаботИсполнитель() Тогда
				
				СвИПТип = ПолучитьОбъектТипаCML("СвИПТип", ПространствоИменСхемы);
				
				ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
				ЗаполнитьСвойствоXDTO(СвИПТип, "ИННФЛ", ИНН, Истина, Ошибки);
				
				СвидетельствоОГосРегистрации = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации");
				ЗаполнитьСвойствоXDTO(СвИПТип, "СвГосРегИП", СвидетельствоОГосРегистрации, , Ошибки);
				ИныеСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.ИныеСведения");
				ЗаполнитьСвойствоXDTO(СвИПТип, "ИныеСвед", ИныеСведения, , Ошибки);
				
				ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
				Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия");
				ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
				Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Имя");
				ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
				Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество");
				ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
				ЗаполнитьСвойствоXDTO(СвИПТип, "ФИО", ФИО,  , Ошибки);
				
				ЗаполнитьСвойствоXDTO(ИдСв, "СвИП",  СвИПТип, , Ошибки);
				
			Иначе
				СвФЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвФЛ", ПространствоИменСхемы);
				
				ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
				ЗаполнитьСвойствоXDTO(СвФЛ, "ИННФЛ", ИНН, , Ошибки);
				
				ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
				Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия");
				ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
				Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Имя");
				ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
				Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество");
				ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
				ЗаполнитьСвойствоXDTO(СвФЛ, "ФИОИП", ФИО,  , Ошибки);
				
				ЗаполнитьСвойствоXDTO(ИдСв, "СвФЛ",  СвФЛ, , Ошибки);
				Если ПространствоИменСхемы = "IAKTPRM2" Тогда
					СвЮЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвЮЛ", ПространствоИменСхемы);
					ЗаполнитьСвойствоXDTO(СвЮЛ, "НаимОрг", "---", , Ошибки);
					ЗаполнитьСвойствоXDTO(ИдСв, "СвЮЛ",    СвЮЛ,  , Ошибки);
				КонецЕсли;
				Наименование = Фамилия + " " + Имя + " " + Отчество;
			КонецЕсли;

		ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ЮЛ" Тогда
			
			СвЮЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвЮЛ", ПространствоИменСхемы);
			Если ПространствоИменСхемы = ПространствоИменПередачаТоваровПродавец()
				Или ПространствоИменСхемы = ПространствоИменПередачаРаботИсполнитель() Тогда
				СвЮЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвОрг.СвЮЛ", ПространствоИменСхемы);
			Иначе
				СвЮЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвЮЛ", ПространствоИменСхемы);
			КонецЕсли;
			
			Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
			ЗаполнитьСвойствоXDTO(СвЮЛ, "НаимОрг", Наименование, , Ошибки);
			ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
			ЗаполнитьСвойствоXDTO(СвЮЛ, "ИННЮЛ", ИНН, , Ошибки);
			КПП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
			ЗаполнитьСвойствоXDTO(СвЮЛ, "КПП", КПП, , Ошибки);
			
			Если ПространствоИменСхемы = ПространствоИменПередачаТоваровПродавец()
				Или ПространствоИменСхемы = ПространствоИменПередачаРаботИсполнитель() Тогда
				
				СведенияОрганизации = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвОрг", ПространствоИменСхемы);
				ЗаполнитьСвойствоXDTO(СведенияОрганизации, "СвЮЛ", СвЮЛ, , Ошибки);
				ЗаполнитьСвойствоXDTO(ИдСв, "СвОрг", СведенияОрганизации, , Ошибки);
			Иначе
				
				ЗаполнитьСвойствоXDTO(ИдСв, "СвЮЛ",  СвЮЛ, , Ошибки);
			КонецЕсли;
			
			Если ПространствоИменСхемы = "IAKTPRM2" Тогда
				СвФЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвФЛ", ПространствоИменСхемы);
				ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
				ЗаполнитьСвойствоXDTO(ФИО,  "Фамилия", "---", Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ФИО,  "Имя",     "---", Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(СвФЛ, "ФИОИП",   ФИО,         , Ошибки);
				ЗаполнитьСвойствоXDTO(ИдСв, "СвФЛ",    СвФЛ,        , Ошибки);
			КонецЕсли;
			
		Иначе
			
			Если ПространствоИменСхемы = "TORGPR" Тогда
				
				СведенияИностраннаяОрганизация = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвОрг.ИнОрг", ПространствоИменСхемы);
				
				Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.НаименованиеОрганизации");
				ЗаполнитьСвойствоXDTO(СведенияИностраннаяОрганизация, "НаимОрг", Наименование, , Ошибки);
				Страна = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.Страна");
				ЗаполнитьСвойствоXDTO(СведенияИностраннаяОрганизация, "Страна", Страна, , Ошибки);
				ИныеСведения = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.ИныеСведения");
				ЗаполнитьСвойствоXDTO(СведенияИностраннаяОрганизация, "ИныеСвед", ИныеСведения, , Ошибки);
				
				СведенияОрганизации = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвОрг", ПространствоИменСхемы);
				ЗаполнитьСвойствоXDTO(СведенияОрганизации, "ИнОрг", СведенияИностраннаяОрганизация, , Ошибки);
				ЗаполнитьСвойствоXDTO(ИдСв, "СвОрг", СведенияОрганизации, , Ошибки);
				
			Иначе
				
				СвЮЛ = ПолучитьОбъектТипаCML("УчастникТип.ИдСв.СвЮЛ", ПространствоИменСхемы);
				
				Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
				ЗаполнитьСвойствоXDTO(СвЮЛ, "НаимОрг", Наименование, , Ошибки);
				ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
				ЗаполнитьСвойствоXDTO(СвЮЛ, "ИННЮЛ", ИНН, , Ошибки);
				КПП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");
				ЗаполнитьСвойствоXDTO(СвЮЛ, "КПП", КПП, , Ошибки);
				
				ЗаполнитьСвойствоXDTO(ИдСв, "СвЮЛ",  СвЮЛ, , Ошибки);
				
			КонецЕсли;
		
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(УчастникXDTO, "ИдСв", ИдСв, , Ошибки);
		ДанныеЗаполнены = Истина;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".КодОКПО", Ложь)) Тогда
		ЗаполнитьСвойствоXDTO(
				УчастникXDTO,
				"ОКПО",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".КодОКПО"),
				,
				Ошибки);
		ДанныеЗаполнены = Истина;
	КонецЕсли;
	
	ЗначениеАдреса = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Адрес");
	Если ЗначениеЗаполнено(ЗначениеАдреса) И ЗначениеАдреса <> "АвтоматическиЗаполняемый" Тогда
		Адрес = СтрокаДереваДанных.Строки.Найти(ВидУчастника + ".Адрес", "ПолныйПуть", Истина);
		Если ЗначениеЗаполнено(Адрес.Значение) Тогда
			ЗаполнитьАдрес(УчастникXDTO, Адрес, Ошибки, ПространствоИменСхемы, ВидУчастника);
		КонецЕсли;
	КонецЕсли;
	
	ЕстьДанныеКЗаполнению = Ложь;
	Контакт = ПолучитьОбъектТипаCML("УчастникТип.Контакт", ПространствоИменСхемы);
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Контакт.Телефон")) Тогда
		Длина = Число(ПолучитьСвойствоПоляXDTOСхемы(ПространствоИменСхемы, "УчастникТип.Контакт", "Тлф", ВидФасетаXDTO.МаксДлина));
		Значение = СокрЛП(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".Контакт.Телефон"));
		Если Длина < СтрДлина(Значение) Тогда
			ШаблонСообщения = НСтр("ru = 'Выполнение операции: Заполнение XDTO.
				|Номер телефона превышает допустимую длину %1 симв. (%2 %3).'");
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, Длина, ВидУчастника, Наименование);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибку(Ошибки, ТекстСообщения);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ТекстСообщения, "ОбменСКонтрагентами");
		Иначе
			ЗаполнитьСвойствоXDTO(Контакт, "Тлф", Значение, , Ошибки);
			ЕстьДанныеКЗаполнению = Истина;
		КонецЕсли;
	КонецЕсли;
	
	ЭлектроннаяПочта = ЗначениеРеквизитаДерева(СтрокаДереваДанных, ВидУчастника + ".Контакт.ЭлектроннаяПочта", Ложь);
	Если ЗначениеЗаполнено(ЭлектроннаяПочта) Тогда
		Длина = Число(ПолучитьСвойствоПоляXDTOСхемы(ПространствоИменСхемы, "КонтактТип", "ЭлПочта", ВидФасетаXDTO.МаксДлина));
		Значение = СокрЛП(ЭлектроннаяПочта);
		Если Длина < СтрДлина(Значение) Тогда
			ШаблонСообщения = НСтр("ru = 'Выполнение операции: Заполнение XDTO.
				|Адрес электронной почты превышает допустимую длину %1 симв. (%2 %3).'");
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, Длина, ВидУчастника, Наименование);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибку(Ошибки, ТекстСообщения);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ТекстСообщения, "ОбменСКонтрагентами");
		Иначе
			ЗаполнитьСвойствоXDTO(Контакт, "ЭлПочта", ЭлектроннаяПочта, , Ошибки);
			ЕстьДанныеКЗаполнению = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Факс = ЗначениеРеквизитаДерева(СтрокаДереваДанных, ВидУчастника + ".Контакт.Факс", Ложь);
	Если ЗначениеЗаполнено(Факс) Тогда
		Длина = Число(ПолучитьСвойствоПоляXDTOСхемы(ПространствоИменСхемы, "КонтактТип", "Факс", ВидФасетаXDTO.МаксДлина));
		Значение = СокрЛП(Факс);
		Если Длина < СтрДлина(Значение) Тогда
			ШаблонСообщения = НСтр("ru = 'Выполнение операции: Заполнение XDTO.
				|Номер факса превышает допустимую длину %1 симв. (%2 %3).'");
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, Длина, ВидУчастника, Наименование);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибку(Ошибки, ТекстСообщения);
			ЭлектронноеВзаимодействиеСлужебный.ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ТекстСообщения, "ОбменСКонтрагентами");
		Иначе
			ЗаполнитьСвойствоXDTO(Контакт, "Факс", Факс, , Ошибки);
			ЕстьДанныеКЗаполнению = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ЕстьДанныеКЗаполнению Тогда
		ЗаполнитьСвойствоXDTO(УчастникXDTO, "Контакт", Контакт, , Ошибки);
		ДанныеЗаполнены = Истина;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".БанковскийСчет")) Тогда
		РеквизитыБанка = "НомерСчета, НаимБанк, БИК";
		БанковскиеРеквизиты = ПолучитьОбъектТипаCML("УчастникТип.БанкРекв", ПространствоИменСхемы);
		СвБанк = ПолучитьОбъектТипаCML("УчастникТип.БанкРекв.СвБанк", ПространствоИменСхемы);
		
		НомерСчета = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".БанковскийСчет.НомерСчета");
		Если ЗначениеЗаполнено(НомерСчета) Тогда
			ЗаполнитьСвойствоXDTO(БанковскиеРеквизиты, "НомерСчета", НомерСчета, ,Ошибки);
		КонецЕсли;
		
		НаимБанк = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".БанковскийСчет.НаимБанк");
		БИК = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".БанковскийСчет.БИК");
		Если ЗначениеЗаполнено(НаимБанк) ИЛИ ЗначениеЗаполнено(БИК) Тогда
			Если ЗначениеЗаполнено(НаимБанк) Тогда
				ЗаполнитьСвойствоXDTO(СвБанк, "НаимБанк", НаимБанк, ,Ошибки);
			КонецЕсли;
			Если ЗначениеЗаполнено(БИК) Тогда
				ЗаполнитьСвойствоXDTO(СвБанк, "БИК", БИК, ,Ошибки);
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(БанковскиеРеквизиты, "СвБанк",   СвБанк,              , Ошибки);
		ЗаполнитьСвойствоXDTO(УчастникXDTO,        "БанкРекв", БанковскиеРеквизиты, , Ошибки);
		ДанныеЗаполнены = Истина;
	КонецЕсли;

	Возврат ДанныеЗаполнены;
	
КонецФункции

Процедура ЗаполнитьДопДанныеШапкиДокумента(ЗаполняемыйXDTO, ДеревоДанных, ПространствоИмен, СтруктураПараметров, Ошибки)
	
	СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные.Подписанные", "ПолныйПуть", Истина);
	
	Если ВРег(ПространствоИмен) = ВРег("KORSFAKT_5_02") Тогда
		ПутьКДопДанным = "Файл.Документ.СвКСчФ.ИнфПол";
		
	Иначе
		ПутьКДопДанным = "Файл.Документ.СвСчФакт.ИнфПол";
	КонецЕсли;
	
	
	ИмяЭлементаВладельца = "Шапка";
	Если ВРег(ПространствоИмен) = ВРег("TORGPR") Или ВРег(ПространствоИмен) = ВРег("RUISP") Тогда
		
		ЗаполнитьПодписываемыеДопДанные_ПередачаТоваров(СтрокаДопДанных, ИмяЭлементаВладельца, ЗаполняемыйXDTO, ПространствоИмен,
			СтруктураПараметров, Ошибки);
			
	Иначе
		
		ДопДанныеXDTO = ПолучитьОбъектТипаCML(ПутьКДопДанным, ПространствоИмен);
		
		ЗаполнитьПодписываемыеДопДанные(СтрокаДопДанных, ИмяЭлементаВладельца, ДопДанныеXDTO, ПространствоИмен,
			СтруктураПараметров, Ошибки);
		ЗаполняемыйXDTO.ИнфПол = ДопДанныеXDTO;
	
	КонецЕсли;
	
	НеПодписанныеДанные = ДеревоДанных.Строки.Найти("ДопДанные.НеПодписанные", "ПолныйПуть", Истина);
	ПоместитьНеПодписанныеДанныеВДеревоДокумента(НеПодписанныеДанные, СтруктураПараметров, ИмяЭлементаВладельца);
	
	ДопФайлСформирован = СформироватьДопФайлCML(СтруктураПараметров, Ошибки, Ложь, ИмяЭлементаВладельца);
	
	Если ДопФайлСформирован Тогда
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяДопФайла",     СтруктураПараметров.ПолноеИмяДопФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "ИдентификаторДопФайла", СтруктураПараметров.ИдентификаторДопФайла);
		
	КонецЕсли;

	
КонецПроцедуры

Процедура ПоместитьНеПодписанныеДанныеВДеревоДокумента(НеПодписанныеДанные, СтруктураПараметров,
		ИмяРеквизита, НомерСтроки = Неопределено)
	
	НеПодписанные = Новый Структура;
	Для Каждого СтрокаДанных Из НеПодписанныеДанные.Строки Цикл
		
		ИмяПараметра = ЭлектронноеВзаимодействие.НазваниеКолонки(СтрокаДанных.ПолныйПуть);
		ЗначениеПараметра = СтрокаДанных.Значение;

		НеПодписанные.Вставить(ИмяПараметра, ЗначениеПараметра);
		
	КонецЦикла;
	
	Если НеПодписанные.Количество() > 0 Тогда
		ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров, НеПодписанные, ИмяРеквизита, Ложь,
			НомерСтроки);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьПодписываемыеДопДанные(СтрокаДопДанных, ИмяРеквизита, ЗаполняемыйXDTO, ПространствоИмен,
	СтруктураПараметров, Ошибки, НомерСтроки = Неопределено)
	
	// Перебираем все ветки подписанных доп. данных
	// Первые 20 строк у которых ключ не более 50 символов и значение реквизита не более 200 попадают в подписанные данные
	// Данные из ветки "НеПодписанные" и не прошедшие проверку данные из ветки "Подписанные" передаются как не подписанные данные.
	
	Если ИмяРеквизита = "Товары" Тогда
		
		Если ВРег(ПространствоИмен) = ВРег("KORSFAKT_5_02") Тогда
			ПутьКДопДанным = "Файл.Документ.ТаблКСчФ.СведТов.ИнфПолСтр";
		Иначе
			ПутьКДопДанным = "Файл.Документ.ТаблСчФакт.СведТов.ИнфПолСтр";
		КонецЕсли;
		
	Иначе
		Если ВРег(ПространствоИмен) = ВРег("KORSFAKT_5_02") Тогда
			ПутьКДопДанным = "Файл.Документ.СвКСчФ.ИнфПол.ТекстИнф";
		Иначе
			ПутьКДопДанным = "Файл.Документ.СвСчФакт.ИнфПол.ТекстИнф";
		КонецЕсли;
	КонецЕсли;
	
	
	МаксДлинаКлюча = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, ПутьКДопДанным, "Идентиф",ВидФасетаXDTO.МаксДлина);
	МаксДлинаЗначения = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, ПутьКДопДанным, "Значен",ВидФасетаXDTO.МаксДлина);
	МинДлинаЗначения = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, ПутьКДопДанным, "Значен",ВидФасетаXDTO.МинДлина);
	
	Если ИмяРеквизита = "Товары" Тогда
		РазмерСписка = ЗаполняемыйXDTO.ИнфПолСтр.ВладеющееСвойство.ВерхняяГраница;
	Иначе
		РазмерСписка = ЗаполняемыйXDTO.ТекстИнф.ВладеющееСвойство.ВерхняяГраница;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтрокаДопДанных) Тогда
		НеВалидныеПодписанные = Новый Структура;
		ВалидныеПодписанные = Новый Структура;
		
		НомерСтрокиДопДанных = 0;
		Для Каждого ПодписаннаяСтрока Из СтрокаДопДанных.Строки Цикл
			НомерСтрокиДопДанных = НомерСтрокиДопДанных +1;
			
			ИмяПараметра = ЭлектронноеВзаимодействие.НазваниеКолонки(ПодписаннаяСтрока.ПолныйПуть);
			ЗначениеПараметра = ПодписаннаяСтрока.Значение;
			
			Если СтрДлина(ИмяПараметра) > Число(МаксДлинаКлюча)
				Или СтрДлина(ЗначениеПараметра) > Число(МаксДлинаЗначения)
				Или СтрДлина(ЗначениеПараметра) < Число(МинДлинаЗначения)
				Или НомерСтрокиДопДанных > РазмерСписка Тогда
				
				НеВалидныеПодписанные.Вставить(ИмяПараметра, ЗначениеПараметра);
			Иначе
				ВалидныеПодписанные.Вставить(ИмяПараметра, ЗначениеПараметра);
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
	ЗаполнитьВалидныеДопДанные(ВалидныеПодписанные, ЗаполняемыйXDTO, ПутьКДопДанным, ПространствоИмен, ИмяРеквизита, Ошибки);
	
	Если НеВалидныеПодписанные.Количество() > 0 Тогда
		ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров, НеВалидныеПодписанные, ИмяРеквизита, Ложь, НомерСтроки);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьВалидныеДопДанные(ВалидныеПодписанные, ЗаполняемыйXDTO, ПутьКДопДанным, ПространствоИмен, ИмяРеквизита, Ошибки)
	
	Для Каждого КлючЗначение Из ВалидныеПодписанные Цикл
		
		ДопДанные = ПолучитьОбъектТипаCML(ПутьКДопДанным, ПространствоИмен);
		ЗаполнитьСвойствоXDTO(ДопДанные, "Идентиф", КлючЗначение.Ключ,, Ошибки);
		ЗаполнитьСвойствоXDTO(ДопДанные, "Значен", Строка(КлючЗначение.Значение),, Ошибки);
		
		Если ИмяРеквизита = "Шапка" Тогда
			
			Если ЕстьСвойствоXDTO(ЗаполняемыйXDTO, "ИнфПолФХЖ3") Тогда
				ЗаполняемыйXDTO.ИнфПолФХЖ3.Добавить(ДопДанные);
			ИначеЕсли ЕстьСвойствоXDTO(ЗаполняемыйXDTO, "ИнфПолФХЖ2") Тогда
				ЗаполняемыйXDTO.ИнфПолФХЖ2.Добавить(ДопДанные);
			Иначе
				ЗаполняемыйXDTO.ТекстИнф.Добавить(ДопДанные);
			КонецЕсли;
			
		Иначе
			
			Если ЕстьСвойствоXDTO(ЗаполняемыйXDTO, "ИнфПолСтр") Тогда
				ЗаполняемыйXDTO.ИнфПолСтр.Добавить(ДопДанные);
			ИначеЕсли ЕстьСвойствоXDTO(ЗаполняемыйXDTO, "ИнфПолеОписРабот") Тогда
				ЗаполняемыйXDTO.ИнфПолеОписРабот.Добавить(ДопДанные);
			ИначеЕсли ЕстьСвойствоXDTO(ЗаполняемыйXDTO, "ИнфПолФХЖ2") Тогда
				ЗаполняемыйXDTO.ИнфПолФХЖ2.Добавить(ДопДанные);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьПодписываемыеДопДанные_ПередачаТоваров(СтрокаДопДанных, ИмяРеквизита, ЗаполняемыйXDTO, ПространствоИмен,
		СтруктураПараметров, Ошибки, НомерСтроки = Неопределено)
	
	Если Не ЗначениеЗаполнено(СтрокаДопДанных) Тогда
		Возврат;
	КонецЕсли;
	
	ПутьКДопДанным = "ТекстИнфТип";
	МаксДлинаКлюча = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, ПутьКДопДанным, "Идентиф",ВидФасетаXDTO.МаксДлина);
	МаксДлинаЗначения = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, ПутьКДопДанным, "Значен",ВидФасетаXDTO.МаксДлина);
	МинДлинаЗначения = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, ПутьКДопДанным, "Значен",ВидФасетаXDTO.МинДлина);
	
	РазмерСписка = Неопределено;
	Если ЕстьСвойствоXDTO(ЗаполняемыйXDTO, "ИнфПолеОписРабот") Тогда
		РазмерСписка = ЗаполняемыйXDTO.ИнфПолеОписРабот.ВладеющееСвойство.ВерхняяГраница;
	КонецЕсли;
	
	НеВалидныеПодписанные = Новый Структура;
	ВалидныеПодписанные = Новый Структура;
	
	НомерСтрокиДопДанных = 0;
	Для Каждого ПодписаннаяСтрока Из СтрокаДопДанных.Строки Цикл
		НомерСтрокиДопДанных = НомерСтрокиДопДанных +1;
		
		ИмяПараметра = ЭлектронноеВзаимодействие.НазваниеКолонки(ПодписаннаяСтрока.ПолныйПуть);
		Если ТипЗнч(ПодписаннаяСтрока.Значение) = Тип("Массив") Тогда
			ЗначениеПараметра = СтрСоединить(ПодписаннаяСтрока.Значение, ",");
			ИмяПараметра = ИмяПараметра+ "_массив";
		Иначе
			ЗначениеПараметра = СокрЛП(ПодписаннаяСтрока.Значение);
		КонецЕсли;
		
		Если Не РазмерСписка = Неопределено Тогда
			Если НомерСтрокиДопДанных > РазмерСписка Тогда
				НеВалидныеПодписанные.Вставить(ИмяПараметра, ЗначениеПараметра);
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если СтрДлина(ИмяПараметра) > Число(МаксДлинаКлюча)
			Или СтрДлина(ЗначениеПараметра) > Число(МаксДлинаЗначения)
			Или СтрДлина(ЗначениеПараметра) < Число(МинДлинаЗначения) Тогда
			
			НеВалидныеПодписанные.Вставить(ИмяПараметра, ЗначениеПараметра);
		Иначе
			ВалидныеПодписанные.Вставить(ИмяПараметра, ЗначениеПараметра);
		КонецЕсли;
		
	КонецЦикла;
	
	ЗаполнитьВалидныеДопДанные(ВалидныеПодписанные, ЗаполняемыйXDTO, ПутьКДопДанным, ПространствоИмен, ИмяРеквизита, Ошибки);
	
	Если НеВалидныеПодписанные.Количество() > 0 Тогда
		ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров, НеВалидныеПодписанные, ИмяРеквизита, Ложь, НомерСтроки);
	КонецЕсли;

КонецПроцедуры

// Заполняем доп данные документа Передача товаров, Передача результатов работ
Процедура ЗаполнитьДопДанныеТаблицыПередачиТоваров(ЗаполняемыйXDTO, ДеревоДанных, СтруктураПараметров, ПространствоИмен, Ошибки)
	
	НомерСтроки = ДеревоДанных.Значение;
	
	ПутьДопДанные = ДеревоДанных.ПолныйПуть;
	СтрокаДопДанных = ДеревоДанных.Строки.Найти(ПутьДопДанные+ ".ДопДанныеПодписанные", "ПолныйПуть", Истина);
	
	Если ПространствоИмен = ПространствоИменПередачаТоваровПродавец() Тогда
		ИмяЭлементаВладельца = "Товары";
	Иначе
		ИмяЭлементаВладельца = "Услуги";
	КонецЕсли;
	
	ЗаполнитьПодписываемыеДопДанные_ПередачаТоваров(СтрокаДопДанных, ИмяЭлементаВладельца, ЗаполняемыйXDTO, ПространствоИмен,
		СтруктураПараметров, Ошибки, НомерСтроки);
	
	// Не подписанные данные помещаем реквизитов "ДопДанные" структуры параметров.
	НеПодписанныеДанные = ДеревоДанных.Строки.Найти(ПутьДопДанные+ ".ДопДанныеНеПодписанные", "ПолныйПуть", Истина);
	ПоместитьНеПодписанныеДанныеВДеревоДокумента(НеПодписанныеДанные, СтруктураПараметров, ИмяЭлементаВладельца, НомерСтроки);
	
КонецПроцедуры

Процедура ЗаполнитьДопДанныеИзДереваДанных(ЗаполняемыйXDTO,
											ДеревоДанных,
											Знач Префикс,
											СтруктураПараметров,
											ПространствоИменСхемы,
											ПутьКИнфПолю,
											ИмяАтрибутаИнфПоля,
											ИмяЭлементаВладельца,
											НомерСтроки,
											Ошибки)
	
		СтруктураДопДанных = Новый Структура;
		Префикс = Префикс + ?(ЗначениеЗаполнено(Префикс), ".", "");
		СтрокаДопДанных = ДеревоДанных.Строки.Найти(Префикс + "ДопДанные.НеПодписанные", "ПолныйПуть", Истина);
		Если СтрокаДопДанных = Неопределено Тогда
			СтрокаДопДанных = ДеревоДанных.Строки.Найти(Префикс + "ДопДанныеНеПодписанные", "ПолныйПуть", Истина);
		КонецЕсли;
		Для Каждого Элемент Из СтрокаДопДанных.Строки Цикл
			СтруктураДопДанных.Вставить(ЭлектронноеВзаимодействие.НазваниеКолонки(Элемент.ПолныйПуть), Элемент.Значение);
		КонецЦикла;
		Если СтруктураДопДанных.Количество() > 0 Тогда
			ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров, СтруктураДопДанных, ИмяЭлементаВладельца,
				Ложь, НомерСтроки);
		КонецЕсли;
		
		СтруктураДопДанных = Новый Структура;
		СтрокаДопДанных = ДеревоДанных.Строки.Найти(Префикс + "ДопДанные.Подписанные", "ПолныйПуть", Истина);
		Если СтрокаДопДанных = Неопределено Тогда
			СтрокаДопДанных = ДеревоДанных.Строки.Найти(Префикс + "ДопДанныеПодписанные", "ПолныйПуть", Истина);
		КонецЕсли;
		Для Каждого Элемент Из СтрокаДопДанных.Строки Цикл
			СтруктураДопДанных.Вставить(ЭлектронноеВзаимодействие.НазваниеКолонки(Элемент.ПолныйПуть), Элемент.Значение);
		КонецЦикла;
		
		Если СтруктураДопДанных.Количество() > 0 Тогда
			МаксДлина = ПолучитьСвойствоПоляXDTOСхемы(
									ПространствоИменСхемы,
									ПутьКИнфПолю,
									ИмяАтрибутаИнфПоля,
									ВидФасетаXDTO.МаксДлина);
									
			СтруктураПараметров.Вставить("ДопустимаяДлинаДопДанных" + ?(ИмяЭлементаВладельца = "Шапка", "Шапки", "Строки"),
				МаксДлина - 20); // 20 - служебные символы.
			ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров, СтруктураДопДанных, ИмяЭлементаВладельца,
				Истина, НомерСтроки);
		КонецЕсли;
		
		СтрокаИнфПол = "";
		ДопФайлСформирован = Ложь;
		Если ТипЗнч(СтруктураПараметров.ДеревоДопДанных) = Тип("ДеревоЗначений")
			И СтруктураПараметров.ДеревоДопДанных.Строки.Количество() > 0 Тогда
			
			// Сформируем xml-строку (ИнфПол):
			Если СформироватьДопФайлCML(СтруктураПараметров,
				Ошибки, Истина, ИмяЭлементаВладельца, НомерСтроки) Тогда
				
				СтрокаИнфПол = СтрЗаменить(СтруктураПараметров.ИнфПол, "	", "");
				
			КонецЕсли;
			
			// Сформируем доп. файл (для строк таб.части не формируется):
			ДопФайлСформирован = (ИмяЭлементаВладельца = "Шапка"
				И СформироватьДопФайлCML(СтруктураПараметров, Ошибки, Ложь, ИмяЭлементаВладельца));
					
			Если ДопФайлСформирован Тогда
				
				ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяДопФайла",     СтруктураПараметров.ПолноеИмяДопФайла);
				ВставитьЗначениеВДерево(ДеревоДанных, "ИдентификаторДопФайла", СтруктураПараметров.ИдентификаторДопФайла);
				
			КонецЕсли;
			
		КонецЕсли;
		Если ЗначениеЗаполнено(СтрокаИнфПол) ИЛИ ДопФайлСформирован Тогда
			Если ИмяЭлементаВладельца = "Шапка" Тогда
				ИнфПол = ПолучитьОбъектТипаCML(ПутьКИнфПолю, ПространствоИменСхемы);
				Если ЗначениеЗаполнено(СтрокаИнфПол) Тогда
					ЗаполнитьСвойствоXDTO(ИнфПол, ИмяАтрибутаИнфПоля, СтрокаИнфПол, , Ошибки);
				КонецЕсли;
				Если ДопФайлСформирован Тогда
					ЗаполнитьСвойствоXDTO(ИнфПол, "ИдФайлИнфПол", Строка(СтруктураПараметров.ИдентификаторДопФайла), , Ошибки);
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(ЗаполняемыйXDTO, "ИнфПол", ИнфПол, , Ошибки);
			ИначеЕсли ЗначениеЗаполнено(СтрокаИнфПол) Тогда
				ЗаполнитьСвойствоXDTO(ЗаполняемыйXDTO, ИмяАтрибутаИнфПоля, СтрокаИнфПол, , Ошибки);
			КонецЕсли;
		КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьАдрес(Контрагент, АдресМестонахождения, Ошибки, ПространствоИменСхемы, ВидУчастника)
		
	АдресТип = ПолучитьОбъектТипаCML("АдресТип", ПространствоИменСхемы);
	СхемаСчетаФактуры = (СтрНайти(ПространствоИменСхемы, "SFAKT") <> 0);
	СтрокаАдреса = АдресМестонахождения.Строки.Найти(
												ВидУчастника + ".Адрес." + АдресМестонахождения.Значение,
												"ПолныйПуть");
	Если АдресМестонахождения.Значение = "Структурированный" Тогда
		АдрРФ = ПолучитьОбъектТипаCML("АдресТип.АдрРФ", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(АдрРФ, "КодРегион", СтрокаАдреса.Строки[1].Значение, СхемаСчетаФактуры, Ошибки);
		
		РеквизитыАдреса = "Индекс, Район, Город, НаселПункт, Улица, Дом, Корпус, Кварт";
		
		Для Каждого Строка Из СтрокаАдреса.Строки Цикл
			ИмяРеквизита = ЭлектронноеВзаимодействие.НазваниеКолонки(Строка.ПолныйПуть);
			Если СтрНайти(РеквизитыАдреса, ИмяРеквизита) > 0 И ЗначениеЗаполнено(Строка.Значение) Тогда
				ЗаполнитьСвойствоXDTO(АдрРФ, ИмяРеквизита, Строка.Значение, , Ошибки);
			КонецЕсли;
		КонецЦикла;
		ЗаполнитьСвойствоXDTO(АдресТип, "АдрРФ", АдрРФ, СхемаСчетаФактуры, Ошибки);
	ИначеЕсли НЕ СхемаСчетаФактуры И АдресМестонахождения.Значение = "Произвольный" Тогда
		
		Если ПространствоИменСхемы = ПространствоИменПередачаТоваровПродавец()
			Или ПространствоИменСхемы = ПространствоИменПередачаРаботИсполнитель() Тогда
			
			АдресИнформация = ПолучитьОбъектТипаCML("АдрИнфТип", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(АдресИнформация, "АдрТекст", СтрокаАдреса.Значение, , Ошибки);
			ЗаполнитьСвойствоXDTO(АдресИнформация, "КодСтр", "643", , Ошибки);
			Если ЕстьСвойствоXDTO(АдресТип, "АдрИнф", Истина) Тогда
				ЗаполнитьСвойствоXDTO(АдресТип, "АдрИнф", АдресИнформация, , Ошибки);
			ИначеЕсли ЕстьСвойствоXDTO(АдресТип, "АдрИно", Истина) Тогда
				ЗаполнитьСвойствоXDTO(АдресТип, "АдрИно", АдресИнформация, , Ошибки);
			КонецЕсли;
			
		Иначе
			// В схеме ТОРГ-12 и Акт, адрес в виде строки передается в элементе схемы "АдрТекст".
			ЗаполнитьСвойствоXDTO(АдресТип, "АдрТекст", СтрокаАдреса.Значение, , Ошибки);
		КонецЕсли;
		
	Иначе
		
		Если ПространствоИменСхемы = ПространствоИменПередачаТоваровПродавец() Тогда
			ПолеАдресИностранный = "АдрИнф";
		Иначе
			// В схеме счета-фактуры, адрес в виде строки передается в элементе схемы "АдрИНО".
			ПолеАдресИностранный = "АдрИНО";
		КонецЕсли;
		АдресXDTO = ПолучитьОбъектТипаCML("АдресТип."+ПолеАдресИностранный, ПространствоИменСхемы);

		ПолеКодСтраны = "КодСтр";
		ПолеАдресТекст = "АдрТекст";
		РеквизитыАдреса = "АдресТекст, КодСтраны, АдрТекст, КодСтр";
		Для Каждого Строка Из СтрокаАдреса.Строки Цикл
			ИмяРеквизита = ЭлектронноеВзаимодействие.НазваниеКолонки(Строка.ПолныйПуть);
			Если СтрНайти(РеквизитыАдреса, ИмяРеквизита) > 0 И ЗначениеЗаполнено(Строка.Значение) Тогда
				
				Если ВРег(ИмяРеквизита) = ВРег("КодСтраны") ИЛИ ВРег(ИмяРеквизита) = ВРег("КодСтр") Тогда
					ЗаполнитьСвойствоXDTO(АдресXDTO, ПолеКодСтраны, Строка.Значение, , Ошибки);
					
				Иначе
					ЗаполнитьСвойствоXDTO(АдресXDTO, ПолеАдресТекст, Строка.Значение, , Ошибки);
					
				КонецЕсли;
				
			КонецЕсли;
		КонецЦикла;
		ЗаполнитьСвойствоXDTO(АдресТип, ПолеАдресИностранный, АдресXDTO, СхемаСчетаФактуры, Ошибки);
		
	КонецЕсли;
	
	ЗаполнитьСвойствоXDTO(Контрагент, "Адрес", АдресТип, СхемаСчетаФактуры, Ошибки);
	
КонецПроцедуры

Процедура ДобавитьРеквизитыОператораЭДО(ДеревоДанных)
	
	СтруктураРеквизитов = СтруктураНастроекТакском();
	Наименование = "";
	ИНН = "";
	ИдентификаторОператора = "";
	СтруктураРеквизитов.Свойство("Наименование", Наименование);
	СтруктураРеквизитов.Свойство("ИНН", ИНН);
	СтруктураРеквизитов.Свойство("ИдентификаторОператора", ИдентификаторОператора);
	СтрокаРеквизитыОператора = ДеревоДанных.Строки.Добавить();
	СтрокаРеквизитыОператора.ПолныйПуть = "РеквизитыОператораЭДО";
	ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.НаимОрг", Наименование);
	ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.ИННЮЛ",   ИНН);
	ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.ИдЭДО",   ИдентификаторОператора);
	
КонецПроцедуры

Процедура ДобавитьРеквизитыПустогоОператораЭДО(ДеревоДанных, ДанныеПоОрганизации)
	
	Наименование = НСтр("ru = 'Без оператора ЭДО'");
	ИНН = "1111111117"; // первый ИНН, отвечающий требованиям формата
	
	ДанныеЮрФизЛица = Неопределено; 
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеЮрФизЛица(ДанныеПоОрганизации, ДанныеЮрФизЛица);
	Если ЗначениеЗаполнено(ДанныеЮрФизЛица.ПолноеНаименование) Тогда
		Наименование = ДанныеЮрФизЛица.ПолноеНаименование;
	КонецЕсли;
	Если ЗначениеЗаполнено(ДанныеЮрФизЛица.ИНН) Тогда
		ИНН = ДанныеЮрФизЛица.ИНН;
	КонецЕсли;
	СтрокаРеквизитыОператора = ДеревоДанных.Строки.Добавить();
	СтрокаРеквизитыОператора.ПолныйПуть = "РеквизитыОператораЭДО";
	ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.НаимОрг", Наименование);
	ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.ИННЮЛ",   Лев(ИНН, 10));
	ВставитьЗначениеВДерево(СтрокаРеквизитыОператора, "РеквизитыОператораЭДО.ИдЭДО",   "---");
	
КонецПроцедуры

// Только для внутреннего использования
Функция ИнициализироватьТаблицуДанныхУчастниковОбмена()
	
	КС12 = Новый КвалификаторыСтроки(12);
	КС255 = Новый КвалификаторыСтроки(255);
	КС1024 = Новый КвалификаторыСтроки(1024);
	КД = Новый КвалификаторыДаты(ЧастиДаты.ДатаВремя);
	
	Массив = Новый Массив;
	Массив.Добавить(Тип("Строка"));
	
	ОписаниеТиповС12 = Новый ОписаниеТипов(Массив, , КС12);
	ОписаниеТиповС255 = Новый ОписаниеТипов("Строка", , КС255);
	ОписаниеТиповС1024 = Новый ОписаниеТипов("Строка", , КС1024);
	ОписаниеТиповДата = Новый ОписаниеТипов("Дата", , , КД);
	ОписаниеТиповПрофильНастроекЭДО = Новый ОписаниеТипов("СправочникСсылка.ПрофилиНастроекЭДО");
	ОписаниеТиповСтатусыУчастников = Новый ОписаниеТипов("ПеречислениеСсылка.СтатусыУчастниковОбменаЭД");
	
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("ПрофильНастроекЭДО", ОписаниеТиповПрофильНастроекЭДО);
	ТЗ.Колонки.Добавить("Наименование",  ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("ИНН",           ОписаниеТиповС12);
	ТЗ.Колонки.Добавить("КПП",           ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("Идентификатор", ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("ТекстПриглашения", ОписаниеТиповС1024);
	ТЗ.Колонки.Добавить("Состояние",     ОписаниеТиповСтатусыУчастников);
	ТЗ.Колонки.Добавить("ОписаниеОшибки",ОписаниеТиповС255);
	ТЗ.Колонки.Добавить("Изменен",       ОписаниеТиповДата);
	ТЗ.Колонки.Добавить("ВнешнийИД",     ОписаниеТиповС255);
	
	Возврат ТЗ;
	
КонецФункции

Функция ДатаПоследнегоПолученияПриглашений(ПрофильНастроекЭДО)
	
	ИскомаяДата = Дата("20000101000000");
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СостоянияОбменовЭДЧерезОператоровЭДО.ДатаПоследнегоПолученияПриглашений
	|ИЗ
	|	РегистрСведений.СостоянияОбменовЭДЧерезОператоровЭДО КАК СостоянияОбменовЭДЧерезОператоровЭДО
	|ГДЕ
	|	СостоянияОбменовЭДЧерезОператоровЭДО.ПрофильНастроекЭДО = &ПрофильНастроекЭДО
	|	И СостоянияОбменовЭДЧерезОператоровЭДО.УдалитьСоглашениеОбИспользованииЭД = ЗНАЧЕНИЕ(Справочник.СоглашенияОбИспользованииЭД.ПустаяСсылка)";
	Запрос.УстановитьПараметр("ПрофильНастроекЭДО", ПрофильНастроекЭДО);
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() Тогда
		ИскомаяДата = ?(Результат.ДатаПоследнегоПолученияПриглашений = Дата("00000000000000"),
			Дата("20000101000000"), Результат.ДатаПоследнегоПолученияПриглашений);
	КонецЕсли;
	
	Возврат ИскомаяДата;
	
КонецФункции

Процедура УдалитьПрочитатьКаталогXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ИД = ЭД.Ид;
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.КаталогТоваров;
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторДокумента", ЭД.Ид);
	
	// Заполняем данные о владельце каталога.
	// Контрагент.
	Элемент = ЭД.Владелец;
	РеквизитыКонтрагента = Новый Структура;
	Для Каждого ТекСвойство Из Элемент.Свойства() Цикл
		
		ЗнДанных = Элемент[ТекСвойство.Имя];
		
		Если ЗнДанных = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда 
			
			ИдКонтрагента = ЗнДанных;
			// Разберем ИД на ИНН и КПП
			СтруктураПоиска = РазобратьИДКонтрагента(ИдКонтрагента);
			Если СтруктураПоиска.Свойство("ИНН") Тогда
				РеквизитыКонтрагента.Вставить("ИНН", СтруктураПоиска.ИНН);
			КонецЕсли;
			Если СтруктураПоиска.Свойство("КПП") Тогда
				РеквизитыКонтрагента.Вставить("КПП", СтруктураПоиска.КПП);
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЮрЛицо") ИЛИ ВРег(ТекСвойство.Имя) = ВРег("ФизЛицо") Тогда
			РеквизитыУчастника = ЗнДанных;
			Для Каждого СвойствоУчастника Из РеквизитыУчастника.Свойства() Цикл
				РеквизитУчастника = РеквизитыУчастника[СвойствоУчастника.Имя];
				Если РеквизитУчастника <> Неопределено Тогда
					Если ВРег(СвойствоУчастника.Имя) = ВРег("ЮридическийАдрес")
						ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("АдресРегистрации") Тогда
						
						РеквизитыКонтрагента.Вставить(СвойствоУчастника.Имя + "_Представление", РеквизитУчастника.Представление);
					ИначеЕсли ВРег(СвойствоУчастника.Имя) = ВРег("ОфициальноеНаименование")
						ИЛИ ВРег(СвойствоУчастника.Имя) = ВРег("ПолноеНаименование") Тогда
						
						РеквизитыКонтрагента.Вставить("ПолноеНаименование", РеквизитУчастника);
					Иначе
						РеквизитыКонтрагента.Вставить(СвойствоУчастника.Имя, РеквизитУчастника);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		Иначе
			РеквизитыКонтрагента.Вставить(ТекСвойство.Имя, ЗнДанных);
		КонецЕсли;
		
	КонецЦикла;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Контрагенты");
	Контрагент = ЭлектронноеВзаимодействие.НайтиСсылку("Контрагенты", ИдКонтрагента,
		РеквизитыКонтрагента);
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдКонтрагента, "ИНН+КПП: " + ИдКонтрагента,
		Контрагент, РеквизитыКонтрагента, ДеревоРазбора, Ошибка);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Контрагент", НайденнаяСтрока.ИндексСтроки);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДатаФормирования", ЭД.ДатаФормирования);
	
	Если ОбменСКонтрагентамиПовтИсп.ИспользуетсяДополнительнаяАналитикаКонтрагентовСправочникПартнеры() Тогда
		РеквизитыПартнера = Новый Структура();
		РеквизитыПартнера.Вставить("Контрагент", Контрагент);
		ИмяПрикладногоСправочника = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ИмяПрикладногоСправочника("Партнеры");
		
		ЗнДопАналитики = ЭлектронноеВзаимодействие.НайтиСсылку(ИмяПрикладногоСправочника, , РеквизитыПартнера);
		Если ЗначениеЗаполнено(ЗнДопАналитики) Тогда
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Партнеры");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ЗнДопАналитики.Код, "Код: "
				+ ЗнДопАналитики.Код, ЗнДопАналитики, РеквизитыПартнера, ДеревоРазбора, Ошибка);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Партнер", НайденнаяСтрока.ИндексСтроки);
		КонецЕсли;
	КонецЕсли;
	
	// Заполняем данные о товарах каталога.
	НаборДанных = ЭД["Товары"].Товар;
	ПрочитатьДанныеТЧКаталогТоваров(НаборДанных, ЭД, ДеревоРазбора, НовыйЭД, Ошибка);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Заполнение веток схемы xsd версии CML2

Процедура СформироватьДанныеПоТоваруCML_206(Товар, СтрокаДереваДанных, ПространствоИменСхемы, Ошибки, МассивФайлов = Неопределено)
	
	Характеристика = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Характеристика", Ложь);
	Упаковка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Упаковка", Ложь);
	
	// Формируем ИД товара.
	ИдТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ИдТовараУКонтрагента", Ложь);
	Если Не ЗначениеЗаполнено(ИдТовара) Тогда
		Номенклатура = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Номенклатура");
		ИДНоменклатуры = Номенклатура.УникальныйИдентификатор();
		ИДХарактеристики = ?(ЗначениеЗаполнено(Характеристика), Характеристика.УникальныйИдентификатор(), "");
		ИДУпаковки = ?(ЗначениеЗаполнено(Упаковка), Упаковка.УникальныйИдентификатор(), "");
		
		ИДТовара = Строка(ИДНоменклатуры) + "#" + Строка(ИДХарактеристики) + "#" + Строка(ИДУпаковки);
	КонецЕсли;
	
	// Характеристики и упаковки.
	Если ЗначениеЗаполнено(Характеристика) ИЛИ ЗначениеЗаполнено(Упаковка) Тогда
		НаименованиеНоменклатуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Наименование")
			+ " (" + ?(ЗначениеЗаполнено(Характеристика), Характеристика , "")
			+ ?(ЗначениеЗаполнено(Характеристика) И ЗначениеЗаполнено(Упаковка), ", ", "")
			+ ?(ЗначениеЗаполнено(Упаковка), Упаковка , "") + ")";
		ВставитьЗначениеВДерево(СтрокаДереваДанных, "Товары.НомерСтроки.Наименование", НаименованиеНоменклатуры);
	КонецЕсли;
	
	ПоместитьВДопДанныеСтрокиТабличнойЧасти(СтрокаДереваДанных, "Ид", ИДТовара);
	
	ЗаполнитьСвойствоXDTO(Товар, "Наименование",
		ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Наименование"), , Ошибки);
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ШтрихКод") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ШтрихКод");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "ШтрихКод", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Артикул") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Артикул");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Артикул", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Страна") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Страна");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Страна", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ТорговаяМарка") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ТорговаяМарка");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "ТорговаяМарка", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Описание") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Описание");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Описание", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;

	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Картинка") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Картинка");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Картинка", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	// Заполним тег БазоваяЕдиница.
	БазоваяЕдиница = ПолучитьОбъектТипаCML("Товар.БазоваяЕдиница", ПространствоИменСхемы);
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаКод") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаКод");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "Код", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаНаименование") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаНаименование");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "НаименованиеКраткое", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;

	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаНаименованиеПолное") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаНаименованиеПолное");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "НаименованиеПолное", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаМеждународноеСокращение") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.БазоваяЕдиницаМеждународноеСокращение");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(БазоваяЕдиница, "МеждународноеСокращение", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаИзмеренияКодПоОКЕИ") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаИзмеренияКодПоОКЕИ");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			Пересчет = ПолучитьОбъектТипаCML("Товар.БазоваяЕдиница.Пересчет", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(Пересчет, "Единица", Реквизит, , Ошибки);
		
			Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаХраненияОстатковКоэффициент") Тогда
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаХраненияОстатковКоэффициент");
				Если ЗначениеЗаполнено(Реквизит) Тогда
					ЗаполнитьСвойствоXDTO(Пересчет, "Коэффициент", Реквизит, , Ошибки);
				КонецЕсли;
			КонецЕсли;
			БазоваяЕдиница.Пересчет.Добавить(Пересчет);
		КонецЕсли;
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(Товар, "БазоваяЕдиница", БазоваяЕдиница, Истина, Ошибки);
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаИзмеренияКодПоОКЕИ")
		И Товар.Свойства().Получить("Единица") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаИзмеренияКодПоОКЕИ");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Единица", Реквизит, , Ошибки);
			
			Коэффициент = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаИзмеренияКоэффициент");
			Если ЗначениеЗаполнено(Коэффициент) Тогда
				ЗаполнитьСвойствоXDTO(Товар, "Коэффициент", Коэффициент, , Ошибки);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ИдКаталога")
		И Товар.Свойства().Получить("ИдКаталога") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ИдКаталога");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "ИдКаталога", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ИдКлассификатора")
		И Товар.Свойства().Получить("ИдКлассификатора") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ИдКлассификатора");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "ИдКлассификатора", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Цена")
		И Товар.Свойства().Получить("ЦенаЗаЕдиницу") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Цена");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "ЦенаЗаЕдиницу", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Цена")
		И Товар.Свойства().Получить("Цена") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Цена");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Цена", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Количество")
		И Товар.Свойства().Получить("Количество") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Количество");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Количество", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Сумма")
		И Товар.Свойства().Получить("Сумма") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Сумма");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "Сумма", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если Товар.Свойства().Получить("Налоги") <> Неопределено И Товар.Свойства().Получить("Налоги") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СуммаНДС");
		
		Налоги = ПолучитьОбъектТипаCML("Документ.Товары.Товар.Налоги", ПространствоИменСхемы);
		Налог = ПолучитьОбъектТипаCML("Документ.Товары.Товар.Налоги.Налог", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Налог, "Наименование", "НДС", Истина, Ошибки);
		
		УчтеноВСумме = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.НДСУчтеноВСумме", Ложь);
		Если ЗначениеЗаполнено(УчтеноВСумме) Тогда
			ЗаполнитьСвойствоXDTO(Налог, "УчтеноВСумме", УчтеноВСумме, , Ошибки);
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(Налог, "Сумма", Реквизит, Истина, Ошибки);
		
		СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СтавкаНДС");
		Если ЗначениеЗаполнено(СтавкаНДС) Тогда
			СтрокаСтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия(, СтавкаНДС);
			ЗаполнитьСвойствоXDTO(Налог, "Ставка", СтрокаСтавкаНДС, , Ошибки);
		КонецЕсли;
		Налоги.Налог.Добавить(Налог);
		ЗаполнитьСвойствоXDTO(Товар, "Налоги", Налоги, , Ошибки);
		
	КонецЕсли;
	
	// Заполним скидку
	Скидка = ПолучитьОбъектТипаCML("Документ.Товары.Товар.Скидки.Скидка", ПространствоИменСхемы);
	ЗаполнятьСкидку = Ложь;
	
	НаименованиеСкидки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.НаименованиеСкидки", Ложь);
	Если Не ЗначениеЗаполнено(НаименованиеСкидки) Тогда
		НаименованиеСкидки = "ОбщаяСкидка";
	КонецЕсли;
	Скидка.Наименование = НаименованиеСкидки;
	
	СуммаСкидки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СуммаСкидки", Ложь);
	Если ЗначениеЗаполнено(СуммаСкидки) Тогда
		Скидка.Сумма = СуммаСкидки;
		ЗаполнятьСкидку = Истина;
	КонецЕсли;
	
	ПроцентСкидки = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ПроцентСкидки", Ложь);
	Если ЗначениеЗаполнено(ПроцентСкидки) Тогда
		Скидка.Процент = ПроцентСкидки;
	КонецЕсли;
	
	СкидкаУчтеноВСумме = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СкидкаУчтеноВСумме", Ложь);
	Если ЗначениеЗаполнено(СкидкаУчтеноВСумме) Тогда
		Скидка.УчтеноВСумме = СкидкаУчтеноВСумме;
	КонецЕсли;
	
	КомментарийКСкидке = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.КомментарийКСкидке", Ложь);
	Если ЗначениеЗаполнено(КомментарийКСкидке) Тогда
		Скидка.Комментарий = КомментарийКСкидке;
	КонецЕсли;
	
	Если ЗаполнятьСкидку Тогда
		Скидки = ПолучитьОбъектТипаCML("Документ.Товары.Товар.Скидки", ПространствоИменСхемы);
		Скидки.Скидка.Добавить(Скидка);
		
		Товар.Скидки = Скидки;
	КонецЕсли;

	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СтранаПроисхождения")
		И Товар.Свойства().Получить("СтранаПроисхождения") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СтранаПроисхождения");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "СтранаПроисхождения", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ГТД")
		И Товар.Свойства().Получить("ГТД") <> Неопределено Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ГТД");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЗаполнитьСвойствоXDTO(Товар, "ГТД", Реквизит, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	ЕстьСвойства = Ложь;
	ЗначенияСвойств = ПолучитьОбъектТипаCML("Документ.Товары.Товар.ЗначенияСвойств", ПространствоИменСхемы);
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Штрихкоды")
			И ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Штрихкоды")) Тогда
		ЕстьСвойства = Истина;
		СтрокаТаблицыШтрихкодов = СтрокаДереваДанных.Строки.Найти("Товары.НомерСтроки.Штрихкоды", "ПолныйПуть", Истина);
		Для Каждого СтрокаДанных Из СтрокаТаблицыШтрихкодов.Строки Цикл
			ЗначенияСвойства = ПолучитьОбъектТипаCML("ЗначенияСвойства", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ЗначенияСвойства, "Ид", "Штрихкод", Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ЗначенияСвойства, "Наименование", СтрокаДанных.Строки[1].Значение, , Ошибки);
			ЗначенияСвойства.Значение.Добавить(СтрокаДанных.Строки[0].Значение);
			ЗначенияСвойств.ЗначенияСвойства.Добавить(ЗначенияСвойства);
		КонецЦикла;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Свойства")
			И ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Свойства")) Тогда
		ЕстьСвойства = Истина;
		СтрокаТаблицыСвойств = СтрокаДереваДанных.Строки.Найти("Товары.НомерСтроки.Свойства", "ПолныйПуть", Истина);
		Индекс = 0;
		Для Каждого СтрокаДанных Из СтрокаТаблицыСвойств.Строки Цикл
			Индекс = Индекс + 1;
			ЗначенияСвойства = ПолучитьОбъектТипаCML("ЗначенияСвойства", ПространствоИменСхемы);
			ЗаполнитьСвойствоXDTO(ЗначенияСвойства, "Ид", "Свойство" + Индекс, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ЗначенияСвойства, "Наименование", Строка(СтрокаДанных.Строки[0].Значение), , Ошибки);
			ЗначенияСвойства.Значение.Добавить(Строка(СтрокаДанных.Строки[1].Значение));
			ЗначенияСвойств.ЗначенияСвойства.Добавить(ЗначенияСвойства);
		КонецЦикла;
	КонецЕсли;
	
	Если ЕстьСвойства Тогда
		ЗаполнитьСвойствоXDTO(Товар, "ЗначенияСвойств", ЗначенияСвойств, , Ошибки);
	КонецЕсли;
	
	// Заполняем значения реквизитов
	ПоместитьДопДанныеСтрокиТаблицы(СтрокаДереваДанных, ИДТовара, Ошибки, СтрокаДереваДанных.Значение, Товар);

	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЗначенияРеквизитов") Тогда
		ЗначенияРеквизитов = ПолучитьОбъектТипаCML("Документ.Товары.Товар.ЗначенияРеквизитов", ПространствоИменСхемы);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЗначенияРеквизитов")) Тогда
			СтрокаТаблицыСвойств = СтрокаДереваДанных.Строки.Найти("Товары.НомерСтроки.ЗначенияРеквизитов", "ПолныйПуть", Истина);
			Индекс = 0;
			Для Каждого СтрокаДанных Из СтрокаТаблицыСвойств.Строки Цикл
				Индекс = Индекс + 1;
				ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
				ЗаполнитьСвойствоXDTO(ЗначениеРеквизита, "Наименование", Строка(СтрокаДанных.Строки[0].Значение), Истина, Ошибки);
				ЗначениеРеквизита.Значение.Добавить(Строка(СтрокаДанных.Строки[1].Значение));
				ЗначенияРеквизитов.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
			КонецЦикла;
			ЗаполнитьСвойствоXDTO(Товар, "ЗначенияРеквизитов", ЗначенияРеквизитов, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ПрисоединенныеФайлы")
			И ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ПрисоединенныеФайлы")) Тогда
		
		СтрокаТаблицыФайлов = СтрокаДереваДанных.Строки.Найти(
														"Товары.НомерСтроки.ПрисоединенныеФайлы",
														"ПолныйПуть",
														Истина);
		Для Каждого СтрокаДанных Из СтрокаТаблицыФайлов.Строки Цикл
			Товар.Картинка.Добавить(СтрокаДанных.Строки[1].Значение);
			Если Не МассивФайлов = Неопределено Тогда
				СтруктураДанных = Новый Структура();
				СтруктураДанных.Вставить("АдресВременногоХранилища", СтрокаДанных.Строки[0].Значение);
				СтруктураДанных.Вставить("ИмяФайла",                 СтрокаДанных.Строки[1].Значение);
				СтруктураДанных.Вставить("ИдТовара",                 ИдТовара);
				МассивФайлов.Добавить(СтруктураДанных);
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьДанныеПоТабЧастиТоварыДокументаCML_206(Товар, СтрокаДереваДанных, ПространствоИменСхемы)
	
	ДополнительныеДанные = ПолучитьОбъектТипаCML("Документ.Товары.Товар.ДополнительныеДанные", ПространствоИменСхемы);
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЦенаПродажи") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЦенаПродажи");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			
			ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
			ЗначениеРеквизита.Наименование = "ЦенаПродажи";
			ЗначениеРеквизита.Значение.Добавить(Реквизит);
			
			ДополнительныеДанные.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СуммаПродажи") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СуммаПродажи");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			
			ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
			ЗначениеРеквизита.Наименование = "СуммаПродажи";
			ЗначениеРеквизита.Значение.Добавить(Реквизит);
			
			ДополнительныеДанные.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СуммаВознаграждения") Тогда
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.СуммаВознаграждения");
		Если ЗначениеЗаполнено(Реквизит) Тогда
			
			ЗначениеРеквизита = ПолучитьОбъектТипаCML("ЗначениеРеквизита", ПространствоИменСхемы);
			ЗначениеРеквизита.Наименование = "СуммаВознаграждения";
			ЗначениеРеквизита.Значение.Добавить(Реквизит);
			
			ДополнительныеДанные.ЗначениеРеквизита.Добавить(ЗначениеРеквизита);
		КонецЕсли;
	КонецЕсли;
	
	Если ДополнительныеДанные.ЗначениеРеквизита.Количество() > 0 Тогда
		Товар.ДополнительныеДанные = ДополнительныеДанные;
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьДанныеПоТоваруПредложенияCML_206(Товар, СтрокаДереваДанных, ПространствоИменСхемы, Ошибки)
	
	// заполняем реквизиты, которые есть в Предложении но нет в товаре
	
	Цены = ПолучитьОбъектТипаCML("ПакетПредложений.Предложения.Предложение.Цены", ПространствоИменСхемы);
	Цена = ПолучитьОбъектТипаCML("ПакетПредложений.Предложения.Предложение.Цены.Цена", ПространствоИменСхемы);
	
	ЗначениеЦены = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Цена");
	Если ЗначениеЗаполнено(ЗначениеЦены) Тогда
		ЗаполнитьСвойствоXDTO(Цена, "ЦенаЗаЕдиницу", ЗначениеЦены, , Ошибки);
	КонецЕсли;
	
	ТипЦены = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ТипЦены");
	Если Не ЗначениеЗаполнено(ТипЦены) Тогда
		ЗначениеИдТипаЦены = "---";
	Иначе
		ЗначениеИдТипаЦены = Строка(ТипЦены.УникальныйИдентификатор());
	КонецЕсли;
	ЗаполнитьСвойствоXDTO(Цена, "ИдТипаЦены", ЗначениеИдТипаЦены, , Ошибки);
	
	ЗначениеВалютаЦены = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ВалютаЦены");
	Если ЗначениеЗаполнено(ЗначениеВалютаЦены) Тогда
		ЗаполнитьСвойствоXDTO(Цена, "Валюта", ЗначениеВалютаЦены, , Ошибки);
	КонецЕсли;
	
	ЗначениеКоличествоЦены = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.Количество");
	Если ЗначениеЗаполнено(ЗначениеКоличествоЦены) Тогда
		ЗаполнитьСвойствоXDTO(Цена, "МинКоличество", ЗначениеКоличествоЦены, , Ошибки);
	КонецЕсли;
	
	ЗначениеЕдиницаЦены = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаИзмеренияКодПоОКЕИ");
	Если ЗначениеЗаполнено(ЗначениеЕдиницаЦены) Тогда
		ЗаполнитьСвойствоXDTO(Цена, "Единица", ЗначениеЕдиницаЦены, , Ошибки);
	КонецЕсли;
	
	КоэффициентЕдиницаЦены = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, "Товары.НомерСтроки.ЕдиницаИзмеренияКоэффициент");
	Если ЗначениеЗаполнено(КоэффициентЕдиницаЦены) Тогда
		ЗаполнитьСвойствоXDTO(Цена, "Коэффициент", КоэффициентЕдиницаЦены, , Ошибки);
	КонецЕсли;

	
	Цены.Цена.Добавить(Цена);
	Товар.Цены = Цены;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеУчастникаCML(Контрагент, СтрокаДереваДанных, ВидКонтрагента, Ошибки, ДопДанные = "")
	
	ЗаполнитьКонтрагентаCML(Контрагент, СтрокаДереваДанных, ВидКонтрагента, Ошибки, ДопДанные);
	
	ЗаполнитьСвойстваКонтрагентаВДокументеCML(Контрагент, ВидКонтрагента, Ошибки);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Формирование контейнера

Процедура ПодготовитьДанныеПоКарточке(ПрисоединенныйФайл, ДеревоКарточки, Зашифрован, ТребуетсяИзвещениеОПолучении)
	
	Если ТипЗнч(ПрисоединенныйФайл) = Тип("Структура") Тогда
		ЭлектронныйДокумент = ПрисоединенныйФайл;
	Иначе
		ЭлектронныйДокумент = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПрисоединенныйФайл,"ВладелецФайла");
	КонецЕсли;
	
	ВидЭД          = ЭлектронныйДокумент.ВидЭД;
	ПризнакПодписи = ПрисоединенныйФайл.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий;
	Комментарий    = "";
	Если ТипЗнч(ЭлектронныйДокумент) = Тип("Структура") Тогда
		Если ЭлектронныйДокумент.Свойство("ДополнительнаяИнформация") Тогда
			Комментарий = ЭлектронныйДокумент.ДополнительнаяИнформация;
		КонецЕсли;
	КонецЕсли;
	
	ТипЭлементаВерсииЭД = ПрисоединенныйФайл.ТипЭлементаВерсииЭД;
	
	Если ОбменСКонтрагентамиСлужебный.ЭтоИзвещениеОПолучении(ТипЭлементаВерсииЭД)
		ИЛИ ОбменСКонтрагентамиСлужебный.ЭтоУведомлениеОбУточнении(ТипЭлементаВерсииЭД)
		ИЛИ ПризнакПодписи Тогда
		
		ВнешнийИдентификатор = ПрисоединенныйФайл.НомерЭД;
		
		Если ОбменСКонтрагентамиСлужебный.ЭтоИзвещениеОПолучении(ТипЭлементаВерсииЭД)
			И (ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДОЭСФ
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДПЭСФ
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДОИПЭСФ
			ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИППДОИПУПДУКД) Тогда
			
			ИдентификаторОператораПолучателя = Лев(ПрисоединенныйФайл.ПолучательЭД, 3);
			
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.Тип", "SpecOperator");
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.Наименование", ИдентификаторОператораПолучателя);
		КонецЕсли;
		
	Иначе
		ВнешнийИдентификатор = ПрисоединенныйФайл.НомерЭД; 
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Определение.ВнешнийИдентификатор",
		ВнешнийИдентификатор);
	
	ВидДокумента = "Other";
	
	Если НЕ ОбменСКонтрагентамиСлужебный.ЭтоСлужебныйДокумент(ТипЭлементаВерсииЭД) Тогда
		
		Если ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.СчетФактура Тогда
			
			ВидДокумента = "Invoice";
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД Тогда
				
				ВидДокумента = "ExpInvoiceAndPrimaryAccountingDocumentVendor";
			ИначеЕсли ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД Тогда
				
				ВидДокумента = "ExpInvoice";
			КонецЕсли;
			
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура Тогда
			
			ВидДокумента = "CorrectiveInvoice";
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД Тогда
				
				ВидДокумента = "CorExpInvoiceAndPrimaryAccountingDocumentVendor";
			ИначеЕсли ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД Тогда
				
				ВидДокумента = "CorExpInvoice";
			КонецЕсли;
			
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав Тогда
			
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
				ВидДокумента = "PrimaryAccountingDocumentVendor";
			КонецЕсли;
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель Тогда
			
			ВидДокумента = "Statement";
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,
				"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
				
				ВидДокумента = "FormalizedStatementVendor";
			КонецЕсли;
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
				ВидДокумента = "PrimaryAccountingDocumentVendor";
			ИначеЕсли ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				ВидДокумента = "FormalizedWorkResultVendor";
			КонецЕсли;
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец Тогда
			
			ВидДокумента = "Consignment";
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,
				"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
				
				ВидДокумента = "FormalizedConsignmentVendor";
			КонецЕсли;
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
				ВидДокумента = "PrimaryAccountingDocumentVendor";
			ИначеЕсли ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				ВидДокумента = "FormalizedTradingVendor";
			КонецЕсли;
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель Тогда
			
			ВидДокумента = "Consignment";
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,
				"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
				
				ВидДокумента = "FormalizedConsignmentVendor";
			КонецЕсли;
			Если ТипЗнч(ЭлектронныйДокумент) <> Тип("Структура")
				И ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД Тогда
				ВидДокумента = "CorPrimaryAccountingDocumentVendor";
			КонецЕсли;
			
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.ТОРГ12
			ИЛИ ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.ПередачаТоваровМеждуОрганизациями Тогда
			
			ВидДокумента = "Consignment";
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.АктВыполненныхРабот Тогда
			
			ВидДокумента = "Statement";
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.СчетНаОплату Тогда
			
			ВидДокумента = "Account";
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.ПроизвольныйЭД Тогда
			
			ВидДокумента = СтрокаТипаДокументаПоПеречислению(ЭлектронныйДокумент.ТипДокумента);
			Комментарий = ПрисоединенныйФайл.ДополнительнаяИнформация;
		КонецЕсли;
		
	Иначе
		
		Если ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД Тогда
			Если ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.СчетФактура Тогда
				
				ВидДокумента = "ExpInvoiceAndPrimaryAccountingDocumentCustomer";
			ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
				ИЛИ ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Покупатель
				ИЛИ ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав
				ИЛИ ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель Тогда
			
				ВидДокумента = "PrimaryAccountingDocumentCustomer";
			КонецЕсли;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД Тогда
			
			Если ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура Тогда
				
				ВидДокумента = "CorExpInvoiceAndPrimaryAccountingDocumentCustomer";
			ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель
				ИЛИ ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель Тогда
			
				ВидДокумента = "CorPrimaryAccountingDocumentCustomer";
			КонецЕсли;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.АктЗаказчик Тогда
			
			ВидДокумента = "Statement";
			Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,
				"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
				
				ВидДокумента = "FormalizedStatementCustomer";
			КонецЕсли;
			Если ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				
				ВидДокумента = "FormalizedWorkResultCustomer";
			КонецЕсли;
			
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ТОРГ12Покупатель Тогда
			
			ВидДокумента = "Consignment";
			Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,
				"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
				
				ВидДокумента = "FormalizedConsignmentCustomer";
			КонецЕсли;
			Если ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП Тогда
				
				ВидДокумента = "FormalizedTradingCustomer";
			КонецЕсли;
			
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СоглашениеОбИзмененииСтоимостиПолучатель Тогда
			
			ВидДокумента = "Consignment";
			Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,
				"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
				
				ВидДокумента = "FormalizedConsignmentCustomer";
			КонецЕсли;
		ИначеЕсли ОбменСКонтрагентамиСлужебный.ЭтоИзвещениеОПолучении(ТипЭлементаВерсииЭД)
			И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,
			"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
			
			ВидДокумента = "ReceiveNotification";
		ИначеЕсли ОбменСКонтрагентамиСлужебный.ЭтоУведомлениеОбУточнении(ТипЭлементаВерсииЭД) Тогда
			Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент,	"ВерсияРегламентаЭДО") = Перечисления.ВерсииРегламентаОбмена1С.Версия20
				ИЛИ ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПрисоединенныйФайл.ЭлектронныйДокументВладелец, "ТипЭлементаВерсииЭД") = Перечисления.ТипыЭлементовВерсииЭД.ПОА Тогда
				ВидДокумента = "SpecificationNotice";
			КонецЕсли;
		ИначеЕсли ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПОА Тогда
			Если ПризнакПодписи Тогда
				ВидДокумента = "SpecificationNotice";
			Иначе
				ВидДокумента = "CancellationOffer";
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Определение.Имя", ВидДокумента);
	
	Если ЗначениеЗаполнено(Комментарий) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Описание.Комментарий", СокрЛП(Комментарий));
	КонецЕсли;
	
	Если ТипЗнч(ЭлектронныйДокумент.ПрофильНастроекЭДО) = Тип("Структура") Тогда
		СпособОбменаЭД = ЭлектронныйДокумент.ПрофильНастроекЭДО.СпособОбменаЭД;
	Иначе
		СпособОбменаЭД = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭлектронныйДокумент.ПрофильНастроекЭДО, "СпособОбменаЭД");
	КонецЕсли;
	
	
	Если НЕ СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
		ТребуетсяПовторнаяПодпись = Истина;
		Если ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПОА Тогда
			ТребуетсяПовторнаяПодпись = ЭлектронныйДокумент.ТребуетсяПодтверждение;
		ИначеЕсли ПризнакПодписи ИЛИ ОбменСКонтрагентамиСлужебный.ЭтоСлужебныйДокумент(ПрисоединенныйФайл) Тогда
			ТребуетсяПовторнаяПодпись = Ложь;
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.СчетНаОплату Тогда
			ТребуетсяПовторнаяПодпись = Ложь;
		ИначеЕсли ЭлектронныйДокумент.ВидЭД = Перечисления.ВидыЭД.ПроизвольныйЭД Тогда
			ТребуетсяПовторнаяПодпись = ЭлектронныйДокумент.ТребуетсяПодтверждение;
		Иначе
			ТребуетсяПовторнаяПодпись = ЭлектронныйДокумент.ТребуетсяПодтверждение;
		КонецЕсли;
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Определение.ТребуетсяПовторнаяПодпись",
			ТребуетсяПовторнаяПодпись);
		
		Если ПрисоединенныйФайл.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПервичныйЭД
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ЭСФ
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД
			ИЛИ ЭлектронныйДокумент.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД
			// Для ЭД вида "Уведомление об уточнении" и "Извещение о получении" необходимо сформировать
			// дополнительные данные, чтобы файл смог прочитаться на принимающей стороне.
			ИЛИ ПрисоединенныйФайл.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.УОУ
			ИЛИ ПрисоединенныйФайл.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИОП Тогда

			ДополнительныеДанные = Новый ТаблицаЗначений;
			ДополнительныеДанные.Колонки.Добавить("Имя");
			ДополнительныеДанные.Колонки.Добавить("Значение");
			
			НоваяСтрока = ДополнительныеДанные.Добавить();
			НоваяСтрока.Имя = "Номер";
			НоваяСтрока.Значение = ?(ЗначениеЗаполнено(ЭлектронныйДокумент.НомерДокументаОтправителя),
				ЭлектронныйДокумент.НомерДокументаОтправителя, НСтр("ru ='Без номера'"));
			
			НоваяСтрока = ДополнительныеДанные.Добавить();
			НоваяСтрока.Имя = "Зашифрован";
			НоваяСтрока.Значение = Зашифрован;
			
			НоваяСтрока = ДополнительныеДанные.Добавить();
			НоваяСтрока.Имя = "ВерсияБЭД";
			НоваяСтрока.Значение = ОбновлениеИнформационнойБазыБЭД.ВерсияБиблиотеки();
			
			НоваяСтрока = ДополнительныеДанные.Добавить();
			НоваяСтрока.Имя = "ПрикладноеРешение";
			НоваяСтрока.Значение = Метаданные.Имя;
			
			НоваяСтрока = ДополнительныеДанные.Добавить();
			НоваяСтрока.Имя = "ВерсияПрикладногоРешения";
			НоваяСтрока.Значение = Метаданные.Версия;
			
			Если ЗначениеЗаполнено(Комментарий) Тогда
				НоваяСтрока = ДополнительныеДанные.Добавить();
				НоваяСтрока.Имя = "Комментарий";
				НоваяСтрока.Значение = СокрЛП(Комментарий);
			КонецЕсли;
			
			Если Не ТребуетсяИзвещениеОПолучении Тогда
				НоваяСтрока = ДополнительныеДанные.Добавить();
				НоваяСтрока.Имя = "НеТребуетсяИзвещение";
				НоваяСтрока.Значение = Истина;
			КонецЕсли;
			
			// Добавим в карточку новую версию формата ЭД.
			Если ПрисоединенныйФайл.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ИОП Тогда
				
				АктуальнаяВерсияФормата = ОбменСКонтрагентамиСлужебный.АктуальнаяВерсияФорматаЭД(ПрисоединенныйФайл.ВладелецФайла.ВидЭД);
				Если ЗначениеЗаполнено(АктуальнаяВерсияФормата) Тогда
					НоваяСтрока = ДополнительныеДанные.Добавить();
					НоваяСтрока.Имя = "ВерсияФормата";
					НоваяСтрока.Значение = АктуальнаяВерсияФормата;
				КонецЕсли;
			КонецЕсли;
			
			// Для случая прямого обмена в доп. данные добавляем реквизит "ВерсияФорматаПакета".
			ВерсияФорматаПакета = ВерсияФорматаВСтроку(ОбменСКонтрагентамиСлужебный.ВерсияПакетаЭД(ПрисоединенныйФайл));
			Если ЗначениеЗаполнено(ВерсияФорматаПакета) Тогда
				НоваяСтрока = ДополнительныеДанные.Добавить();
				НоваяСтрока.Имя = "ВерсияФорматаПакета";
				НоваяСтрока.Значение = ВерсияФорматаПакета;
			КонецЕсли;
			
			// Получим актуальный тип документа (состав типов расширился, для обратной совместимости, старые типы передаются
			// по прежнему в поле тип, а для новых конфигураций - в доп.данных).
			Если ВидЭД = Перечисления.ВидыЭД.ПроизвольныйЭД Тогда
				ВидДокумента = СтрокаТипаДокументаПоПеречислению(ЭлектронныйДокумент.ТипДокумента, Истина);
			КонецЕсли;
			НоваяСтрока = ДополнительныеДанные.Добавить();
			НоваяСтрока.Имя = "DocumentType";
			НоваяСтрока.Значение = ВидДокумента;
			
			Если ВидЭД = Перечисления.ВидыЭД.ПроизвольныйЭД Тогда
				
				МассивДокументов = Новый Массив;
				Для Каждого СтрокаОснования Из ЭлектронныйДокумент.ДокументыОснования Цикл
					Если ТипЗнч(СтрокаОснования.ДокументОснование) = Тип("ДокументСсылка.ЭлектронныйДокументВходящий")
						ИЛИ ТипЗнч(СтрокаОснования.ДокументОснование) = Тип("ДокументСсылка.ЭлектронныйДокументИсходящий") Тогда
						МассивДокументов.Добавить(СтрокаОснования.ДокументОснование);
					КонецЕсли;
				КонецЦикла;
				
				Если МассивДокументов.Количество() > 0 Тогда
					
					Идентификаторы = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(МассивДокументов,"УникальныйИД");
					
					Для Каждого УникальныйИД Из Идентификаторы Цикл
						Если Не ПустаяСтрока(УникальныйИД.Значение) Тогда
							СтрокаТЗ = ДополнительныеДанные.Добавить();
							СтрокаТЗ.Имя = "УникальныйИДОснования";
							СтрокаТЗ.Значение = УникальныйИД.Значение;
						КонецЕсли;
					КонецЦикла;
					
				КонецЕсли;
				
			ИначеЕсли ЗначениеЗаполнено(ПрисоединенныйФайл.ДополнительнаяИнформация) Тогда
				СтрокаТЗ = ДополнительныеДанные.Добавить();
				СтрокаТЗ.Имя = "Комментарий";
				СтрокаТЗ.Значение = СокрЛП(ПрисоединенныйФайл.ДополнительнаяИнформация);
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки,
					"Описание.Комментарий", СокрЛП(ПрисоединенныйФайл.ДополнительнаяИнформация));
			КонецЕсли;
			
			Если ЭлектронныйДокумент.ИдентификаторыОснованийВладельцаФайла.Количество() > 0 Тогда
				// В LinkedDocument передаются идентификаторы (НомерЭД), используются на стороне Оператора ЭДО
				// для объединения связанных документов. Документы считаются взаимосвязанными, если выполняется
				// условие: ИД документооборота (DocFlow.ID в файле meta.xml) ЭД1 = ИД указанному в LinkedDocument ЭД2.
				// Поэтому в LinkedDocument помещаем реквизит УникальныйИД, указанный в ЭД, у которого ВладелецФайла -
				// - документ ИБ с УИД = Идентификатору из ИдентификаторыОснованийВладельцаФайла.
				ТаблицаИдентификаторов = ЭлектронныйДокумент.ИдентификаторыОснованийВладельцаФайла.Выгрузить();
				ТаблицаИдентификаторовЭД = ЭлектронныйДокумент.ИдентификаторыОснованийВладельцаФайла.Выгрузить();
				ТаблицаИдентификаторовЭД.Свернуть("ИдентификаторЭДДокументаОснования");
				ТаблицаИдентификаторов.Свернуть("ИдентификаторДокументаОснования");
				Для Каждого СтрокаИдентификатора Из ТаблицаИдентификаторовЭД Цикл
					Если ЗначениеЗаполнено(СтрокаИдентификатора.ИдентификаторЭДДокументаОснования) Тогда
						СтрокаТЗ = ДополнительныеДанные.Добавить();
						СтрокаТЗ.Имя = "LinkedDocument";
						СтрокаТЗ.Значение = СокрЛП(СтрокаИдентификатора.ИдентификаторЭДДокументаОснования); // для Такском
					КонецЕсли;
				КонецЦикла;
				Для Каждого СтрокаИдентификатора Из ТаблицаИдентификаторов Цикл
					Если ЗначениеЗаполнено(СтрокаИдентификатора.ИдентификаторДокументаОснования) Тогда
						СтрокаТЗ = ДополнительныеДанные.Добавить();
						СтрокаТЗ.Имя = "ParentDocument";
						СтрокаТЗ.Значение = СокрЛП(СтрокаИдентификатора.ИдентификаторДокументаОснования); // для 1С
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоКарточки, ДополнительныеДанные, "Описание.ДополнительныеДанные");
		КонецЕсли;
	КонецЕсли;
	
	СтруктураДанных = ОбменСКонтрагентамиСлужебный.ЗначенияРеквизитов(ЭлектронныйДокумент.Организация,
		"Наименование, ИНН, КПП");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Отправитель.Наименование",
		СтруктураДанных.Наименование);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Отправитель.ИНН",
		СтруктураДанных.ИНН);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Отправитель.КПП",
		СтруктураДанных.КПП);
		
	Договор = НСтр("ru ='Договор по-умолчанию'");
	Если СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском
		И ЭлектронныйДокумент.ДокументыОснования.Количество() Тогда
		ПараметрыЭД = ОбменСКонтрагентамиСлужебный.ЗаполнитьПараметрыЭДПоИсточнику(
			ЭлектронныйДокумент.ДокументыОснования[0].ДокументОснование,,ЭлектронныйДокумент.ВидЭД);
		Если ПараметрыЭД.Свойство("ДоговорКонтрагента") И ЗначениеЗаполнено(ПараметрыЭД.ДоговорКонтрагента) Тогда
			ИмяРеквизитаНомерДоговора = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении(
				"НомерДоговораКонтрагента");
			ИмяРеквизитаДатаДоговора = ЭлектронноеВзаимодействиеСлужебныйПовтИсп.ИмяНаличиеОбъектаРеквизитаВПрикладномРешении(
				"ДатаДоговораКонтрагента");
			Если ИмяРеквизитаНомерДоговора <> Неопределено И ИмяРеквизитаДатаДоговора <> Неопределено Тогда
				РеквизитыДоговора = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПараметрыЭД.ДоговорКонтрагента,
					ИмяРеквизитаНомерДоговора + "," + ИмяРеквизитаДатаДоговора);
				Если ЗначениеЗаполнено(РеквизитыДоговора[ИмяРеквизитаНомерДоговора]) Тогда
					Договор = ?(ЗначениеЗаполнено(РеквизитыДоговора[ИмяРеквизитаДатаДоговора]),
						СтрШаблон(НСтр("ru ='%1 от %2'"),
							РеквизитыДоговора[ИмяРеквизитаНомерДоговора], 
							Формат(РеквизитыДоговора[ИмяРеквизитаДатаДоговора], "ДЛФ=D")),
						РеквизитыДоговора[ИмяРеквизитаНомерДоговора]);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Отправитель.НомерДоговора", Договор);
		
	Если СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Отправитель.ИД",
			ПрисоединенныйФайл.Отправитель);
	Иначе
		Если ПрисоединенныйФайл.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Отправитель.ИД",
				ПрисоединенныйФайл.ПолучательЭД);
		Иначе
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Отправитель.ИД",
				ПрисоединенныйФайл.ОтправительЭД);
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.Тип")) Тогда
		Если СпособОбменаЭД <> Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда

			
			СтруктураДанных = ОбменСКонтрагентамиСлужебный.ЗначенияРеквизитов(ЭлектронныйДокумент.Контрагент,
				"Наименование, ИНН, КПП");
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.Наименование",
				СтруктураДанных.Наименование);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.ИНН",
				СтруктураДанных.ИНН);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.КПП",
				СтруктураДанных.КПП);
			ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.НомерДоговора", Договор);
			
			Если СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.ИД",
					ПрисоединенныйФайл.Получатель);
			Иначе
				Если ПрисоединенныйФайл.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.ИД",
						ПрисоединенныйФайл.ОтправительЭД);
				Иначе
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Получатель.ИД",
						ПрисоединенныйФайл.ПолучательЭД);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Описание.Заголовок", Строка(ВидЭД));
	
	Дата = "";
	Если СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
		Дата = ЭлектронныйДокумент.ДатаЭД;
	Иначе
		Дата = ?(ПризнакПодписи, ТекущаяДатаСеанса(), ПрисоединенныйФайл.ДатаСоздания);
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоКарточки, "Описание.Дата", Дата);
	
КонецПроцедуры

Процедура ПодготовитьДанныеПоТранспортнойИнформации(ПрисоединенныйФайл, СтруктураФайловЭД, ДеревоТранспортнойИнформации)
	
	Если ТипЗнч(ПрисоединенныйФайл) = Тип("Структура") Тогда
		ЭлектронныйДокумент = ПрисоединенныйФайл;
	Иначе
		ЭлектронныйДокумент = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПрисоединенныйФайл,"ВладелецФайла");
	КонецЕсли;
	
	ВидЭД          = ЭлектронныйДокумент.ВидЭД;
	ПризнакПодписи = ПрисоединенныйФайл.НаправлениеЭД = Перечисления.НаправленияЭД.Входящий;
	
	ТипЭлементаВерсииЭД = ПрисоединенныйФайл.ТипЭлементаВерсииЭД;
	
	Если ОбменСКонтрагентамиСлужебный.ЭтоИзвещениеОПолучении(ТипЭлементаВерсииЭД) //ВидЭД = Перечисления.ВидыЭД.ИзвещениеОПолучении
		ИЛИ ОбменСКонтрагентамиСлужебный.ЭтоУведомлениеОбУточнении(ТипЭлементаВерсииЭД) //ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении
		ИЛИ ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПОА
		ИЛИ ПризнакПодписи Тогда
		
		ИДДокументооборота     = ПрисоединенныйФайл.УникальныйИД;
	Иначе
		Если ЭлектронныйДокумент.ПрофильНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
			ИДДокументооборота = ЭлектронныйДокумент.НомерЭД;
		Иначе
			// Изменим заполнение уникального идентификатора для документооборота при использовании версии регламента 20.
			Если ЭлектронныйДокумент.ВерсияРегламентаЭДО = Перечисления.ВерсииРегламентаОбмена1С.Версия20 Тогда
				ИДДокументооборота = ПрисоединенныйФайл.УникальныйИД;
			Иначе
				ИДДокументооборота = Строка(ПрисоединенныйФайл.УникальныйИдентификатор());
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоТранспортнойИнформации, "ИД", ИДДокументооборота);
	
	Если ЭлектронныйДокумент.ПрофильНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
		КодРегламента = "Nonformalized";
		КодТранзакции = "MainDocument";
	Иначе
		КодРегламента = ПолучитьКодРегламента(ЭлектронныйДокумент, ПрисоединенныйФайл);
		КодТранзакции = ПолучитьКодТранзакции(ПрисоединенныйФайл, КодРегламента, ПризнакПодписи);
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоТранспортнойИнформации, "Документ.КодРегламента", КодРегламента);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоТранспортнойИнформации, "Документ.КодТранзакции", КодТранзакции);
	
	// Загрузим файл электронного документа.
	Если СтруктураФайловЭД.Свойство("ГлавныйФайл") И ЗначениеЗаполнено(СтруктураФайловЭД.ГлавныйФайл) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоТранспортнойИнформации, "Документ.ГлавныйФайл.Путь",
			СтруктураФайловЭД.ГлавныйФайл);
	КонецЕсли;
	
	// Загрузим подписи электронного документа в дерево транспортной информации.
	Если СтруктураФайловЭД.Свойство("ГлавныйФайлПодписи") И СтруктураФайловЭД.ГлавныйФайлПодписи.Количество() > 0 Тогда
		ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоТранспортнойИнформации, СтруктураФайловЭД.ГлавныйФайлПодписи,
			"Документ.ГлавныйФайлПодписи");
	КонецЕсли;
	
	// Загрузим файл дополнительной информации.
	Если СтруктураФайловЭД.Свойство("ДополнительныйФайл") И ЗначениеЗаполнено(СтруктураФайловЭД.ДополнительныйФайл) Тогда
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоТранспортнойИнформации, "Документ.ДополнительныйФайл.Путь",
			СтруктураФайловЭД.ДополнительныйФайл);
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД)
	
	ВставитьЗначениеВДерево(ДеревоДанных, "ДатаФормирования", СтруктураЭД.ДатаЭД);
	ВставитьЗначениеВДерево(ДеревоДанных, "ВерсияСхемы", СтруктураЭД.ВерсияСхемы);
	ВставитьЗначениеВДерево(ДеревоДанных, "Ид", СтруктураЭД.НомерЭД);
	ВставитьЗначениеВДерево(ДеревоДанных, "ВидЭД", СтруктураЭД.ВидЭД);
	ВставитьЗначениеВДерево(ДеревоДанных, "НаправлениеЭД", СтруктураЭД.НаправлениеЭД);
	ВставитьЗначениеВДерево(ДеревоДанных, "УникальныйИдентификатор", СтруктураЭД.УникальныйИдентификатор);
	
	ВставитьЗначениеВДерево(ДеревоДанных, "Исполнитель", СтруктураЭД.Отправитель);
	
КонецПроцедуры

Процедура СохранитьНеизвестныйПакет(ДвоичныеДанныеЭлемента, ПрофильНастроекЭДО, ВнешнийУИД)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Попытка
		ПакетЭД                    = Документы.ПакетЭД.СоздатьДокумент();
		ПакетЭД.Дата               = ТекущаяДатаСеанса();
		ПакетЭД.СтатусПакета       = Перечисления.СтатусыПакетовЭД.Неизвестный;
		ПакетЭД.Направление        = Перечисления.НаправленияЭД.Входящий;
		ПакетЭД.Организация        = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПрофильНастроекЭДО, "Организация");
		ПакетЭД.ПрофильНастроекЭДО = ПрофильНастроекЭДО;
		ПакетЭД.СпособОбменаЭД     = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПрофильНастроекЭДО, "СпособОбменаЭД");
		ПакетЭД.ВнешнийУИД         = ВнешнийУИД;
		ПакетЭД.Записать();
		
		Идентификатор = Строка(Новый УникальныйИдентификатор());
		
		ИмяФайла = "EDI_" + Идентификатор;
		АдресВХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеЭлемента);
		
		ПараметрыФайла = Новый Структура();
		ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
		ПараметрыФайла.Вставить("ВладелецФайлов", ПакетЭД.Ссылка);
		ПараметрыФайла.Вставить("ИмяБезРасширения", ИмяФайла);
		ПараметрыФайла.Вставить("РасширениеБезТочки", "zip");
		ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");
		
		ПрисоединенныйФайл = РаботаСФайлами.ДобавитьФайл(
			ПараметрыФайла, АдресВХранилище);

	Исключение
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ВидОперации = НСтр("ru = 'Создание нового ПакетаЭД'");
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации,
																					ТекстОшибки,
																					ТекстСообщения);
	КонецПопытки;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Формирование ЭД из документов БД

Функция ДеревоКартинок(ИмяФайлаКартинок)
	
	ДеревоКартинок = Новый ДеревоЗначений();
	ДеревоКартинок.Колонки.Добавить("ИдентификаторТовара");
	ДеревоКартинок.Колонки.Добавить("ИмяФайла");
	ДеревоКартинок.Колонки.Добавить("АдресВременногоХранилища");
	
	ВремКаталог = ПолучитьИмяВременногоФайла();
	
	Если РаспаковатьАрхив(ИмяФайлаКартинок, ВремКаталог, НСтр("ru='Формирование дерева картинок'")) Тогда
		
		Папки = НайтиФайлы(ВремКаталог, "*", Ложь);
		Для Каждого Папка Из Папки Цикл
			
			СтрокаТовара = ДеревоКартинок.Строки.Добавить();
			СтрокаТовара.ИдентификаторТовара = Папка.Имя;
			Файлы = НайтиФайлы(ВремКаталог + "\" + Папка.Имя + "\", "*");
			
			Для Каждого Файл Из Файлы Цикл
				СтрокаКартинки = СтрокаТовара.Строки.Добавить();
				СтрокаКартинки.ИмяФайла = Файл.Имя;
				ДвоичныеДанныеФайла = Новый ДвоичныеДанные(Файл.ПолноеИмя);
				СтрокаКартинки.АдресВременногоХранилища = ПоместитьВоВременноеХранилище(
				ДвоичныеДанныеФайла, Новый УникальныйИдентификатор);
			КонецЦикла
			
		КонецЦикла;
		
	КонецЕсли;
	
	ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремКаталог);
	
	Возврат ДеревоКартинок;
	
КонецФункции

Функция РеквизитыРасчетногоСчета(Знач Элемент, ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	РеквизитыСчета = Новый Структура;
	
	Пока СтрДлина(Элемент) > 0 Цикл
		
		ПозицияРазделителя = СтрНайти(Элемент, "#");
		РеквизитЗначение = Лев(Элемент, ПозицияРазделителя );
		Элемент = СтрЗаменить(Элемент, РеквизитЗначение, "");
		
		Позиция = СтрНайти(РеквизитЗначение, "&");
		
		Реквизит = Лев(РеквизитЗначение, Позиция - 1);
		
		РеквизитЗначение = СтрЗаменить(РеквизитЗначение, Реквизит, "");
		РеквизитЗначение = СтрЗаменить(РеквизитЗначение,"&","");
		РеквизитЗначение = СтрЗаменить(РеквизитЗначение,"#","");
		
		РеквизитыСчета.Вставить(Реквизит, РеквизитЗначение);
		
	КонецЦикла;
	
	Возврат РеквизитыСчета;
	
КонецФункции

Функция ВерсияФорматаВСтроку(ВерсияФормата)
	
	Если ВерсияФормата = Перечисления.ВерсииФорматаПакетаЭД.Версия20 Тогда
		Результат = "2";
	ИначеЕсли ВерсияФормата = Перечисления.ВерсииФорматаПакетаЭД.Версия30 Тогда
		Результат = "3";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Просмотр предложений об аннулировании

// Процедура заполняет табличный документ Уведомление об уточнении.
//
Процедура ЗаполнитьТабличныйДокументПредложениеОбАннулировании(ТабличныйДокумент, ДанныеПечати)
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_Аннулирование";
	
	Макет = Справочники.ЭДПрисоединенныеФайлы.ПолучитьМакет(
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("ЭД_Аннулирование_%1", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()));
	
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Заголовок");
	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ЗаполнитьЗначенияСвойств(ОбластьМакета.Параметры, ДанныеПечати.Шапка);
	ЭлектронноеВзаимодействиеСлужебный.ВывестиОбластьВТабличныйДокумент(ТабличныйДокумент, ОбластьМакета, "Шапка");
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
КонецПроцедуры

Процедура ПрочитатьПредложениеОбАннулированииXDTO(ЭД, ДеревоРазбора, НовыйЭД, Ошибка)
	
	НовыйЭД.ВидЭД = Перечисления.ВидыЭД.ПредложениеОбАннулировании;
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИмяФайла",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвПредАн.СведАнФайл.ИмяАнФайла"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Получатель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.УчастЭДО")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Отправитель",
		ПолучитьДанныеУчастникаОбменаЭД(ЗначениеСвойстваXDTO(ЭД, "Документ.НапрПредАн")));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ТекстУточнения",
		ЗначениеСвойстваXDTO(ЭД, "Документ.СвПредАн.ТекстПредАн"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ПараметрЗаголовка", "");
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторПолучателя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.УчастЭДО.ИдУчастЭДО"));
	
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ИдентификаторОтправителя",
		ЗначениеСвойстваXDTO(ЭД, "Документ.НапрПредАн.ИдУчастЭДО"));
	
КонецПроцедуры

Функция ПолучитьДанныеПредложенияОбАннулированииДляПечати(СтрокаОбъекта, ДеревоРазбора, ИД)
	
	ДанныеЗаполненияШапки = Новый Структура;
	
	ДанныеЗаполненияШапки.Вставить("Отправитель", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Отправитель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторОтправителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторОтправителя"));
	ДанныеЗаполненияШапки.Вставить("Получатель",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"Получатель"));
	ДанныеЗаполненияШапки.Вставить("ИдентификаторПолучателя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ИдентификаторПолучателя"));
	ДанныеЗаполненияШапки.Вставить("ТекстУточнения", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора,
		СтрокаОбъекта, "ТекстУточнения"));
	ДанныеЗаполненияШапки.Вставить("ИмяФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаСтрокиДереваРазбора(ДеревоРазбора, СтрокаОбъекта,
		"ИмяФайла"));
	
	ДанныеДляОбъекта = Новый Структура;
	ДанныеДляОбъекта.Вставить("Шапка", ДанныеЗаполненияШапки);
	
	Возврат ДанныеДляОбъекта;
	
КонецФункции

Функция ТаблицаИзСтрокиСРазделителем(Знач ЗначенияРеквизита)
	
	ТаблицаРезультат = Новый ТаблицаЗначений;
	ДанныеСтроки = Новый Структура;
	
	Для Каждого Элемент Из ЗначенияРеквизита Цикл
		
		ПозицияНомерСтроки = СтрНайти(Элемент, "_");
		НомерСтроки = Лев(Элемент, ПозицияНомерСтроки - 1);
		ДанныеСтроки.Вставить("НомСтр", НомерСтроки);

		Элемент = СтрЗаменить(Элемент, НомерСтроки + "_", "");
		
		Пока СтрДлина(Элемент) > 0 Цикл
			
			Позиция = СтрНайти(Элемент, "#");
			
			РеквизитИЗначение = Лев(Элемент, Позиция);
			Элемент = СтрЗаменить(Элемент, РеквизитИЗначение, "");
			
			Разделитель = СтрНайти(РеквизитИЗначение, "&");
			
			НаименованиеРеквизита = Лев(РеквизитИЗначение, Разделитель - 1);
			
			ЗначениеРеквизита = СтрЗаменить(РеквизитИЗначение, НаименованиеРеквизита, "");
			ЗначениеРеквизита = СтрЗаменить(ЗначениеРеквизита, "&", "");
			ЗначениеРеквизита = СтрЗаменить(ЗначениеРеквизита, "#", "");
			
			ДанныеСтроки.Вставить(НаименованиеРеквизита, ЗначениеРеквизита);
			
		КонецЦикла;
		
		СоздатьКолонкиТаблицы(ДанныеСтроки, ТаблицаРезультат);
		
		НоваяСтрока = ТаблицаРезультат.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеСтроки);
		
	КонецЦикла;
	
	ТаблицаРезультат.Сортировать("НомСтр");

	Возврат ТаблицаРезультат;
	
КонецФункции

Процедура СоздатьКолонкиТаблицы(СтруктураСКолонками, Таблица)
	
	Для Каждого КлючЗначение Из СтруктураСКолонками Цикл
		Если Не Таблица.Колонки.Найти(КлючЗначение.Ключ) = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Таблица.Колонки.Добавить(КлючЗначение.Ключ);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьСФПоДокументамОснования(МассивЭД, МассивОснований, НаправлениеЭД)
	
	МассивСФ = Новый Массив;
	МассивОснованийСФ = Новый Массив;
	
	Для Каждого Основание Из МассивОснований Цикл
		Если ДокументЯвляетсяСчетомФактурой(Основание) Тогда
			МассивСФ.Добавить(Основание);
		Иначе
			МассивОснованийСФ.Добавить(Основание);
		КонецЕсли;
	КонецЦикла;
	
	Если МассивОснованийСФ.Количество() Тогда
		МассивСФПоОснованиям = Новый Массив;
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьСчетаФактурыПоДокументамОснования(
			МассивОснованийСФ, МассивСФПоОснованиям, НаправлениеЭД);
		
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивСФ, МассивСФПоОснованиям, Истина);
	КонецЕсли;
	
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЭлектронныйДокументДокументыОснования.Ссылка
		|ИЗ
		|	&ЭлектронныйДокументДокументыОснования КАК ЭлектронныйДокументДокументыОснования
		|ГДЕ
		|	ЭлектронныйДокументДокументыОснования.ДокументОснование В (&ДокументыСФ)";
	
	Если НаправлениеЭД = Перечисления.НаправленияЭД.Входящий Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ЭлектронныйДокументДокументыОснования",
			"Документ.ЭлектронныйДокументВходящий.ДокументыОснования");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ЭлектронныйДокументДокументыОснования",
			"Документ.ЭлектронныйДокументИсходящий.ДокументыОснования");
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ДокументыСФ", МассивСФ);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		МассивЭД.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
КонецПроцедуры

Процедура НайтиЗначениеВСписке(ЗначениеЭлемента, ИмяЭлемента, СписокЭлементов)
	
	Для Каждого ЭлементСписка Из СписокЭлементов Цикл
		Если ВРег(ЭлементСписка.Представление) = ВРег(ИмяЭлемента) Тогда
			ЗначениеЭлемента = ЭлементСписка.Значение;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПрочитатьСтрокуТоваровCML(ТоварXDTO, НовыйЭД, СписокТЧ, ПоляПоискаТовара, ДеревоРазбора, Ошибка)
	
	Если ТоварXDTO = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	НаимТовара = "";
	ИдТовара   = "";
	
	ЕстьДопРеквизиты = Ложь;
	ЦенаВключаетНДС  = Неопределено;
	ЭлементСумма     = Неопределено;
	СуммаНДС         = 0;
	ЕстьСуммаПродажи = Ложь;
	
	Организация = ПоляПоискаТовара.Организация;
	
	ДопПараметры = Новый Структура;
	ДопПараметры.Вставить("Организация", Организация);

	НомерСтроки = ПоляПоискаТовара.НомерСтроки;
	ПрочитатьДопДанныеСтрокиТЧ(ТоварXDTO, НовыйЭД, "Товары", НомерСтроки, СписокТЧ, ДопПараметры);
	
	// Номенклатура
	Для Каждого ТекСвойство Из ТоварXDTO.Свойства() Цикл
		
		ЗначениеСвойства = ТоварXDTO[ТекСвойство.Имя];
		
		Если ТипЗнч(ЗначениеСвойства) = Тип("ЗначениеXDTO") ИЛИ ТипЗнч(ЗначениеСвойства) = Тип("ОбъектXDTO") Тогда
		ИначеЕсли НЕ ЗначениеЗаполнено(ЗначениеСвойства) Тогда
			Продолжить;
		КонецЕсли;
		
		//// Разберем свойства Товара
		Если ВРег(ТекСвойство.Имя) = ВРег("Ид") Тогда
			ИдТовара = ЗначениеСвойства;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Артикул") Тогда
			Артикул = ЗначениеСвойства;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Наименование") Тогда
			НаимТовара = ЗначениеСвойства;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("БазоваяЕдиница") Тогда
			
			СвойстваЕдиницы = Новый Структура;
			СвойстваЕдиницы.Вставить("Код", ЗначениеСвойстваXDTO(ЗначениеСвойства, "Код"));
			
			Если ЗначениеСвойства.Свойства().Получить("Наименование") <> Неопределено Тогда
				НаименованиеБазовойВеличины = ЗначениеСвойства.Наименование;
				СвойстваЕдиницы.Вставить("Наименование", ЗначениеСвойства.Наименование);
			КонецЕсли;
			
			Если ЗначениеСвойства.Свойства().Получить("НаименованиеКраткое") <> Неопределено Тогда
				НаименованиеБазовойВеличины = ЗначениеСвойства.НаименованиеКраткое;
				СвойстваЕдиницы.Вставить("Наименование", ЗначениеСвойства.НаименованиеКраткое);
			КонецЕсли;
			
			Если ЗначениеСвойства.Свойства().Получить("НаименованиеПолное") <> Неопределено Тогда
				СвойстваЕдиницы.Вставить("НаименованиеПолное", ЗначениеСвойства.НаименованиеПолное);
			КонецЕсли;
			
			Если ЗначениеСвойства.Свойства().Получить("МеждународноеСокращение") <> Неопределено Тогда
				СвойстваЕдиницы.Вставить("МеждународноеСокращение", ЗначениеСвойства.МеждународноеСокращение);
			КонецЕсли;
			
			ЕдиницаИзмерения = ЭлектронноеВзаимодействие.НайтиСсылку(
				"ЕдиницыИзмерения", СвойстваЕдиницы.Код, СвойстваЕдиницы);
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
			НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, СвойстваЕдиницы.Код, НаименованиеБазовойВеличины,
				ЕдиницаИзмерения, СвойстваЕдиницы, ДеревоРазбора, Ошибка);
			
			ПоляПоискаТовара.Вставить("ЕдиницаИзмерения", НайденнаяСтрока.ИндексСтроки);
				
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Единица") Тогда
			
			СвойстваЕдиницы = Новый Структура;
			СвойстваЕдиницы.Вставить("Код", Строка(ЗначениеСвойства));
			
			НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ЕдиницыИзмерения");
			НайденнаяСтрока = НайденныйТипВДереве.Строки.Найти(Строка(ЗначениеСвойства), "ИД");
			Если НайденнаяСтрока <> Неопределено
				И ЗначениеЗаполнено(НайденнаяСтрока.СсылкаНаОбъект) Тогда
				
				СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "ЕдиницаИзмерения");
			Иначе
				ЕдиницаИзмерения = ЭлектронноеВзаимодействие.НайтиСсылку("ЕдиницыИзмерения", Строка(ЗначениеСвойства),
					СвойстваЕдиницы);
				НаименованиеЕдиницы = Неопределено;
				Если ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
					НаименованиеЕдиницы = ЕдиницаИзмерения.Наименование;
					СвойстваЕдиницы.Вставить("Наименование", НаименованиеЕдиницы);
				КонецЕсли;
				
				НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(	НайденныйТипВДереве, Строка(ЗначениеСвойства), НаименованиеЕдиницы,
					ЕдиницаИзмерения, СвойстваЕдиницы, ДеревоРазбора, Ошибка);
				
				Если ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
					СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "ЕдиницаИзмерения");
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Налоги") Тогда
			
			Налоги = ЗначениеСвойстваXDTO(ЗначениеСвойства, "Налог",, Истина);
			Если Налоги <> Неопределено Тогда
				
				Для Каждого Налог Из Налоги Цикл
					
					СписокТЧ.Добавить(ЗначениеСвойстваXDTO(Налог, "Ставка"),"СтавкаНДС");
					
					СуммаНДС = ЗначениеСвойстваXDTO(Налог, "Сумма", "Число");
					СписокТЧ.Добавить(СуммаНДС, "СуммаНДС");
					
					УчтеноВСумме = ЗначениеСвойстваXDTO(Налог, "УчтеноВСумме", "Булево");
					ЦенаВключаетНДС = УчтеноВСумме;
					СписокТЧ.Добавить(ЦенаВключаетНДС, "ЦенаВключаетНДС");
					
				КонецЦикла;
				
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Скидки") Тогда
			
			Скидки = ЗначениеСвойстваXDTO(ЗначениеСвойства, "Скидка",, Истина);
			Если Скидки <> Неопределено Тогда
				Для Каждого Скидка Из Скидки Цикл
					
					НаименованиеСкидки = ЗначениеСвойстваXDTO(Скидка, "Наименование");
					СписокТЧ.Добавить(НаименованиеСкидки, "НаименованиеСкидки");
					СписокТЧ.Добавить(ЗначениеСвойстваXDTO(Скидка, "Сумма"),"СуммаСкидки");
					
					ПроцентСкидки = ЗначениеСвойстваXDTO(Скидка, "Процент");
					СписокТЧ.Добавить(ПроцентСкидки, "ПроцентСкидки");
					
					СкидкаУчтеноВСумме = ЗначениеСвойстваXDTO(Скидка, "УчтеноВСумме");
					СписокТЧ.Добавить(СкидкаУчтеноВСумме, "СкидкаУчтеноВСумме");
					
					КомментарийКСкидке = ЗначениеСвойстваXDTO(Скидка, "Комментарий");
					СписокТЧ.Добавить(КомментарийКСкидке, "КомментарийКСкидке");
					
				КонецЦикла;
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Количество") Тогда
			
			// Запомним кол-во упаковок, в которых отгружали
			ЗначениеСвойства = Число(ЗначениеСвойства);
			СписокТЧ.Добавить(ЗначениеСвойства, "КоличествоУпаковок");
			
			// Пересчитаем с учетом коэффициента,
			// если есть свойство ЕдиницаИзмерения, получим значение.
			Коэф = "";
			Если ЗначениеСвойстваXDTO(ТоварXDTO, "Единица") <> Неопределено Тогда
				Коэф = ЗначениеСвойстваXDTO(ТоварXDTO, "Коэффициент", "Число");
			КонецЕсли;
			Если НЕ ЗначениеЗаполнено(Коэф) Тогда
				Коэф = 1;
			КонецЕсли;
			
			СписокТЧ.Добавить(Коэф, "Коэффициент");
			СписокТЧ.Добавить(ЗначениеСвойства * Коэф, "Количество");
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеРеквизиты") Тогда
			
			ЕстьДопРеквизиты       = Истина;
			СтруктураДопРеквизитов = Новый Структура;
			
			ЗначениеСвойства = ЗначениеСвойстваXDTO(ТоварXDTO, "ДополнительныеРеквизиты",, Истина);
			Если ЗначениеСвойства <> Неопределено Тогда
				Для Каждого ЭлементДанных Из ЗначениеСвойства Цикл
					МассивЗначений = Новый Массив;
					Значения = ЗначениеСвойстваXDTO(ЭлементДанных, "Значение");
					Для каждого ЭлементЗначения Из Значения Цикл
						МассивЗначений.Добавить(ЭлементЗначения)
					КонецЦикла;
					СтруктураДопРеквизитов.Вставить(ЗначениеСвойстваXDTO(ЭлементДанных, "Наименование"), МассивЗначений);
				КонецЦикла;
			КонецЕсли;
			
			ПоляПоискаТовара.Вставить("ДопРеквизиты", СтруктураДопРеквизитов);
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЦенаЗаЕдиницу") Тогда
			СписокТЧ.Добавить(Число(ЗначениеСвойства), "Цена");
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("Сумма") Тогда
			ЭлементСумма = СписокТЧ.Добавить(Число(ЗначениеСвойства), "Сумма");
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ЗначенияРеквизитов") Тогда
			
			ЗначениеСвойства = ЗначениеСвойстваXDTO(ТоварXDTO, "ЗначенияРеквизитов.ЗначениеРеквизита",, Истина);
			ДопРеквизиты = Новый Структура;
			Если ЗначениеЗаполнено(Организация) Тогда
				ДопРеквизиты.Вставить("Организация", Организация);
			КонецЕсли;
			
			ПрочитатьСписокЗначенийРеквизитовCML(ЗначениеСвойства, СписокТЧ, Ошибка, ДопРеквизиты);
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеДанные") Тогда
			
			ЕстьДопРеквизиты       = Истина;
			СтруктураДопРеквизитов = Новый Структура;
			
			СписокДопДанные = ЗначениеСвойстваXDTO(ЗначениеСвойства, "ЗначениеРеквизита",, Истина);
			Если СписокДопДанные <> Неопределено Тогда
				Для Каждого ЭлементДанных Из СписокДопДанные Цикл
					
					ЭлементНаименование = ЗначениеСвойстваXDTO(ЭлементДанных, "Наименование");
					ЭлементЗначение     = ЗначениеСвойстваXDTO(ЭлементДанных, "Значение");
					Если ЗначениеЗаполнено(ЭлементНаименование) Тогда
						Если ЭлементНаименование = "ЦенаПродажи"
							ИЛИ ЭлементНаименование = "СуммаПродажи"
							ИЛИ ЭлементНаименование = "СуммаВознаграждения" Тогда
							
							СписокТЧ.Добавить(Число(ЭлементЗначение), ЭлементНаименование);
							
							Если ЭлементНаименование = "СуммаПродажи" Тогда
								ЕстьСуммаПродажи = Истина;
							КонецЕсли;
						Иначе
							СписокТЧ.Добавить(ЭлементЗначение, ЭлементНаименование);
						КонецЕсли;
					КонецЕсли;
					
				КонецЦикла;
			КонецЕсли;
			
		ИначеЕсли ВРег(ТекСвойство.Имя) = ВРег("ДополнительныеЗначенияРеквизитов") Тогда
			
			СписокЗначенийДопРеквизитов = ЗначениеСвойстваXDTO(ЗначениеСвойства, "ЗначениеРеквизита",, Истина);
			
			Для Каждого ЭлементДанных Из СписокЗначенийДопРеквизитов Цикл
				
				ЭлементНаименование = ЗначениеСвойстваXDTO(ЭлементДанных, "Наименование");
				ЭлементЗначение     = ЗначениеСвойстваXDTO(ЭлементДанных, "Значение");
				
				Если ЭлементНаименование = "ИдПокупателя" И ЗначениеЗаполнено(ЭлементЗначение) Тогда
					
					СтрокиКонтрагентов = ДеревоРазбора.Строки.Найти("Контрагенты", "ТипОбъекта", Истина);
					СтрокаПокупателя   = СтрокиКонтрагентов.Строки.Найти(ЭлементЗначение, "ИД", Истина);
					Если СтрокаПокупателя <> Неопределено Тогда
						СписокТЧ.Добавить(СтрокаПокупателя.ИндексСтроки, "Покупатель");
					Иначе
						СписокТЧ.Добавить(Неопределено, "Покупатель");
					КонецЕсли;
					СписокТЧ.Добавить(ЭлементЗначение, "ИдПокупателя");
				Иначе
					СписокТЧ.Добавить(ЭлементЗначение, ЭлементНаименование);
				КонецЕсли;
				
			КонецЦикла;
			
		Иначе
			СписокТЧ.Добавить(ЗначениеСвойства, ТекСвойство.Имя);
		КонецЕсли;
		
	КонецЦикла;
	
	// В CML Цена и Сумма необязательны, а в БЭД - обязательны, поэтому добавляем их, если они не были указаны.
	Если ТоварXDTO.Свойства().Получить("ЦенаЗаЕдиницу") = Неопределено Тогда
		СписокТЧ.Добавить(0, "Цена");
	КонецЕсли;
	Если ТоварXDTO.Свойства().Получить("Сумма") = Неопределено Тогда
		СписокТЧ.Добавить(0, "Сумма");
	КонецЕсли;
	
	Если ТипЗнч(ЭлементСумма) = Тип("ЭлементСпискаЗначений") Тогда
		
		Если Не ЕстьСуммаПродажи Тогда
			Сумма = ЭлементСумма.Значение;
			Если ЦенаВключаетНДС Тогда
				СписокТЧ.Добавить(Сумма, "СуммаСНДС");
				ЭлементСумма.Значение = Сумма - СуммаНДС;
			ИначеЕсли Не ЦенаВключаетНДС Тогда
				СписокТЧ.Добавить(Сумма + СуммаНДС, "СуммаСНДС");
			Иначе
				СписокТЧ.Добавить(Сумма, "СуммаСНДС");
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ИдТовара) Тогда
		НайтиЗначениеВСписке(ИдТовара, "Ид", СписокТЧ);
	КонецЕсли;
	
	ПоляПоискаТовара.Наименование = НаимТовара;
	ПоляПоискаТовара.Ид           = ИдТовара;
	ПоляПоискаТовара.Артикул      = Артикул;
	
КонецПроцедуры

Процедура НайтиНоменклатуруТЧ(ПоляПоискаТовара, СписокТЧ)
	
	ИдТовара = ПоляПоискаТовара.Ид;
	Если ЭтоСоставнойИД(ИдТовара) Тогда
		
		СтруктураИд = РазобратьИДТовара(ИдТовара);
		ИДДляПоиска = СтруктураИд.ИдТовара;
		
		Если ЗначениеЗаполнено(СтруктураИд.ИДХарактеристики) Тогда
			ХарактеристикаНоменклатуры = ЭлементСправочникаПоИД("ХарактеристикиНоменклатуры", СтруктураИд.ИДХарактеристики);
			СписокТЧ.Добавить(ХарактеристикаНоменклатуры, "Характеристика");
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураИд.ИДУпаковки) Тогда
			УпаковкаНоменклатуры = ЭлементСправочникаПоИД("УпаковкиНоменклатуры", СтруктураИд.ИДУпаковки);
			СписокТЧ.Добавить(УпаковкаНоменклатуры, "Упаковка");
		КонецЕсли;
		
	Иначе
		ИДДляПоиска = ИдТовара;
	КонецЕсли;
	
	Номенклатура = ЭлементСправочникаПоИД("Номенклатура", ИДДляПоиска);
	ПоляПоискаТовара.Вставить("Номенклатура", Номенклатура);
	
КонецПроцедуры

Процедура НайтиНоменклатуруПоставщикаТЧ(ПоляПоискаТовара, СписокТЧ, НовыйЭД, ДеревоРазбора, ЭД, Ошибка)
	
	// Номенклатура поставщиков.
	РеквизитыНоменклатурыПоставщика = Новый Структура;
	ИмяРеквизитаВладельца = ПолучитьИмяРеквизитаВладельцаНоменклатурыПоставщиков();
	ВладелецНоменклатуры = ПолучитьРеквизитШапкиЭД(НовыйЭД, ИмяРеквизитаВладельца, ДеревоРазбора);
	
	Ид = ПоляПоискаТовара.ИД;
	РеквизитыНоменклатурыПоставщика.Вставить("Владелец", ВладелецНоменклатуры);
	РеквизитыНоменклатурыПоставщика.Вставить("Идентификатор", Ид);
	
	Артикул = ПоляПоискаТовара.Артикул;
	Если ЗначениеЗаполнено(Артикул) Тогда
		РеквизитыНоменклатурыПоставщика.Вставить("Артикул", ПоляПоискаТовара.Артикул);
	КонецЕсли;
	
	Наименование = ПоляПоискаТовара.Наименование;
	Если ЗначениеЗаполнено(Наименование) Тогда
		РеквизитыНоменклатурыПоставщика.Вставить("Наименование", Наименование);
	КонецЕсли;
	
	ЕдиницаИзмерения = ПоляПоискаТовара.ЕдиницаИзмерения;
	Если ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
		РеквизитыНоменклатурыПоставщика.Вставить("ЕдиницаИзмерения", ЕдиницаИзмерения);
	КонецЕсли;
	
	ДопРеквизиты = Неопределено;
	Если ПоляПоискаТовара.Свойство("ДопРеквизиты", ДопРеквизиты) Тогда
		РеквизитыНоменклатурыПоставщика.Вставить("ДополнительныеРеквизиты", ДопРеквизиты);
	КонецЕсли;
	
	НоменклатураПоставщика = ЭлектронноеВзаимодействие.НайтиСсылку("НоменклатураПоставщиков", ,
		РеквизитыНоменклатурыПоставщика);
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "НоменклатураПоставщиков");
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, Ид, Наименование, НоменклатураПоставщика,
		РеквизитыНоменклатурыПоставщика, ДеревоРазбора, Ошибка);
	СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "НоменклатураПоставщика");
	
	Если ЗначениеЗаполнено(НоменклатураПоставщика) Тогда
		ПоляПоискаТовара.Вставить("НоменклатураПоставщика", НоменклатураПоставщика);
	КонецЕсли;
	
	СтруктураРеквизитовТовара = СформироватьСтруктуруТовара();
	ОбменСКонтрагентамиПереопределяемый.ПолучитьРеквизитыТовара(ПоляПоискаТовара, СтруктураРеквизитовТовара, ЭД.Ид);
	
	Номенклатура = СтруктураРеквизитовТовара.Номенклатура;
	
	ПоляПоискаТовара.Вставить("Номенклатура", Номенклатура);
	
	Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Характеристика) Тогда
		СписокТЧ.Добавить(СтруктураРеквизитовТовара.Характеристика, "Характеристика");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтруктураРеквизитовТовара.Упаковка) Тогда
		СписокТЧ.Добавить(СтруктураРеквизитовТовара.Упаковка, "Упаковка");
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьСтрокуТабличнойЧасти(ДеревоРазбора, НовыйЭД, РеквизитыНоменклатуры, СписокТЧ, Ошибка)

	НаимТовара = РеквизитыНоменклатуры.Наименование;
	ИдТовара = РеквизитыНоменклатуры.Ид;
	Номенклатура = РеквизитыНоменклатуры.Номенклатура;
	
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "Номенклатура");
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ИдТовара, НаимТовара, Номенклатура,
		РеквизитыНоменклатуры, ДеревоРазбора, Ошибка);
		
	СписокТЧ.Добавить(НайденнаяСтрока.ИндексСтроки, "Номенклатура");

	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитыТЧОбъекта(НовыйЭД, "СтрокаТЧ", СписокТЧ);

КонецПроцедуры

Процедура ЗаполнитьБанковскийСчет(Продавец, ДеревоДанных)
	
	НомерСчета = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.НомерСчета");
	
	Если ЗначениеЗаполнено(НомерСчета) Тогда
		
		ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
		
		РасчетныйСчет = ПолучитьОбъектТипаCML("РасчетныйСчет", ПространствоИменСхемы);
		
		// заполняем расчетный счет
		РасчетныйСчет.НомерСчета = НомерСчета;
		
		// заполняем банк
		Банк = ПолучитьОбъектТипаCML("Банк", ПространствоИменСхемы);
			
		БикБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.Банк.БИК", Ложь);
		БанкЗаполнен = Ложь;
		Если ЗначениеЗаполнено(БикБанка) Тогда
			БанкЗаполнен = Истина;
			Банк.БИК = БикБанка;
		КонецЕсли;
		
		СчетКорреспондентский = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.Банк.СчетКорреспондентский", Ложь);
		Если ЗначениеЗаполнено(СчетКорреспондентский) Тогда	
			Банк.СчетКорреспондентский = СчетКорреспондентский;
		КонецЕсли;
		
		НаименованиеБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.Банк.Наименование", Ложь);
		Если ЗначениеЗаполнено(НаименованиеБанка) Тогда
			Банк.Наименование = НаименованиеБанка;
		КонецЕсли;
		
		// заполняем банк корреспондент
		
		БикКорБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.БИК");
		
		БанкКорр = ПолучитьОбъектТипаCML("Банк", ПространствоИменСхемы);
		БанкКоррЗаполнен = Ложь;
		Если ЗначениеЗаполнено(БикКорБанка) Тогда
			БанкКоррЗаполнен = Истина;
			БанкКорр.БИК = БикКорБанка;
		КонецЕсли;
		
		КорСчетКорреспондентский = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.СчетКорреспондентский");
		Если ЗначениеЗаполнено(КорСчетКорреспондентский) Тогда
			БанкКорр.СчетКорреспондентский = КорСчетКорреспондентский;
		КонецЕсли;
		
		НаименованиеКорБанка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.Наименование");
		Если ЗначениеЗаполнено(НаименованиеКорБанка) Тогда
			БанкКорр.Наименование =  НаименованиеКорБанка;
		КонецЕсли;
		
		Если БанкЗаполнен Тогда
			РасчетныйСчет.Банк = Банк;
		КонецЕсли;
		
		Если БанкКоррЗаполнен Тогда
			РасчетныйСчет.БанкКорреспондент = БанкКорр;
		КонецЕсли;
		
		Продавец.РасчетныйСчет = РасчетныйСчет;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьКонтрагентаCML(Контрагент, СтрокаДереваДанных, ВидКонтрагента, Ошибки, ДопДанные = "")
	
	ЗаполнитьСвойстваКонтрагентаCML(Контрагент, СтрокаДереваДанных, ВидКонтрагента, Ошибки, ДопДанные);
	
	БанковскиеРеквизиты = Неопределено;
	ЗаполнитьРеквизитыСчетаКонтрагента(БанковскиеРеквизиты, СтрокаДереваДанных, ВидКонтрагента, Ошибки);
	
	Если ТипЗнч(БанковскиеРеквизиты) = Тип("ОбъектXDTO") Тогда
		
		ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
		РасчетныеСчета = ПолучитьОбъектТипаCML("Контрагент.РасчетныеСчета", ПространствоИменСхемы);
		
		РасчетныеСчета.РасчетныйСчет.Добавить(БанковскиеРеквизиты);

		ЗаполнитьСвойствоXDTO(Контрагент, "РасчетныеСчета", РасчетныеСчета, , Ошибки);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСвойстваКонтрагентаВДокументеCML(Контрагент, ВидКонтрагента, Ошибки)
	
	Если Контрагент.Свойства().Получить("Роль") <> Неопределено
		И СтрНайти(ВидКонтрагента, ".") = 0 Тогда
		ЗаполнитьСвойствоXDTO(Контрагент, "Роль", ВидКонтрагента, Истина, Ошибки);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьРеквизитыСчетаКонтрагента(БанковскиеРеквизиты, СтрокаДереваДанных, ВидКонтрагента, Ошибки)
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".БанковскийСчет")) Тогда
		
		ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
		
		БанковскиеРеквизиты = ПолучитьОбъектТипаCML("РасчетныйСчет", ПространствоИменСхемы);
		СвБанк = ПолучитьОбъектТипаCML("Банк", ПространствоИменСхемы);
		
		НомерСчета = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".БанковскийСчет.НомерСчета");
		Если ЗначениеЗаполнено(НомерСчета) Тогда
			ЗаполнитьСвойствоXDTO(БанковскиеРеквизиты, "НомерСчета", НомерСчета, Истина, Ошибки);
		КонецЕсли;
		
		НаимБанк = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".БанковскийСчет.НаимБанк");
		БИК = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".БанковскийСчет.БИК");
		Если ЗначениеЗаполнено(НаимБанк) Тогда
			ЗаполнитьСвойствоXDTO(СвБанк, "Наименование", НаимБанк, , Ошибки);
		КонецЕсли;
		Если ЗначениеЗаполнено(БИК) Тогда
			ЗаполнитьСвойствоXDTO(СвБанк, "БИК", БИК, , Ошибки);
		КонецЕсли;
			
		ЗаполнитьСвойствоXDTO(БанковскиеРеквизиты, "Банк", СвБанк, Истина, Ошибки);
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ЗаполнитьСвойстваКонтрагентаCML(Контрагент, СтрокаДереваДанных, ВидКонтрагента, Ошибки, ДопДанные = "");
	
	// Реквизиты используются для передачи данных конечного Покупателя из отчета Комиссионера о продажах:
	ИНН = "";
	КПП = "";
	Наименование = "";
	ДопДанные = Новый Структура;
	//
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника")) Тогда
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника") = "ФЛ" Тогда
			Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ФЛ.ПолноеНаименование");
			ЗаполнитьСвойствоXDTO(Контрагент, "ПолноеНаименование", Наименование, Истина, Ошибки);
			ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ФЛ.ИНН");
			ЗаполнитьСвойствоXDTO(Контрагент, "ИНН", ИНН, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(Контрагент, "Фамилия",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ФЛ.Фамилия"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(Контрагент, "Имя",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ФЛ.Имя"), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(Контрагент, "Отчество", 
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ФЛ.Отчество"), , Ошибки);
		Иначе
			Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
			ЗаполнитьСвойствоXDTO(Контрагент, "ОфициальноеНаименование", Наименование, Истина, Ошибки);
			ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ЮЛ.ИНН");
			ЗаполнитьСвойствоXDTO(Контрагент, "ИНН", ИНН, Истина, Ошибки);
			КПП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".ТипУчастника.ЮЛ.КПП");
			ЗаполнитьСвойствоXDTO(Контрагент, "КПП", КПП, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ИНН) Тогда
		ИдКонтрагента = ИНН + ?(ЗначениеЗаполнено(КПП), "_" + КПП, "");
		ЗаполнитьСвойствоXDTO(Контрагент, "Ид", ИдКонтрагента, , Ошибки);
		ДопДанные.Вставить("Наименование", Наименование);
		ДопДанные.Вставить("ИНН", ИНН);
		ДопДанные.Вставить("КПП", КПП);
		ДопДанные.Вставить("ИД", ИдКонтрагента);
	КонецЕсли;
	
	ПространствоИменСхемы = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Адрес")) Тогда
		Адрес = СтрокаДереваДанных.Строки.Найти(ВидКонтрагента + ".Адрес", "ПолныйПуть", Истина);
		Если ЗначениеЗаполнено(Адрес.Значение) Тогда
			АдресТип = ПолучитьОбъектТипаCML("Адрес", ПространствоИменСхемы);
			// Если адрес структурированный заполняем Адресное поле
			// если нет - только представление.
			Если Адрес.Значение = "Структурированный" Тогда
				Представление = "";
				СтрокиАдреса = Адрес.Строки.Найти("Структурированный").Строки;
				Для Каждого СтрокаСАдресом Из СтрокиАдреса Цикл
					
					Если Не ЗначениеЗаполнено(СтрокаСАдресом.Значение) Тогда
						Продолжить;
					КонецЕсли;
					
					АдресноеПоле = ПолучитьОбъектТипаCML("Адрес.АдресноеПоле", ПространствоИменСхемы);
					НормТип = СтрокаСАдресом["Уровень" + (СтрокаСАдресом.Уровень() + 1)];
					Если НормТип = "Индекс" Тогда
						НормТип = НСтр("ru ='Почтовый индекс'");
					ИначеЕсли НормТип = "КодРегион" Тогда
						НормТип = "Регион";
						ИмяРегиона = "";
						ОбменСКонтрагентамиПереопределяемый.НазваниеРегиона(СтрокаСАдресом.Значение, ИмяРегиона);
						Если ЗначениеЗаполнено(ИмяРегиона) Тогда
							СтрокаСАдресом.Значение = ИмяРегиона;
						КонецЕсли;					
					ИначеЕсли НормТип = "НаселПункт" Тогда
						НормТип = НСтр("ru ='Населенный пункт'");
					ИначеЕсли НормТип = "Кварт" Тогда
						НормТип = "Квартира";
					КонецЕсли;
					АдресноеПоле.Тип = НормТип;
					АдресноеПоле.Значение = СтрокаСАдресом.Значение;
					АдресТип.АдресноеПоле.Добавить(АдресноеПоле);
					
					Представление = Представление + ?(Представление = "","",", ") + СтрокаСАдресом.Значение;
					
				КонецЦикла;
				
				ЗаполнитьСвойствоXDTO(АдресТип, "Представление", Представление, Истина, Ошибки);
			Иначе
				Если Адрес.Значение = "Иностранный" Тогда
					СтрокаАдреса = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, Адрес.ПолныйПуть + "." + Адрес.Значение + ".АдрТекст");
				Иначе
					СтрокаАдреса = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, Адрес.ПолныйПуть + "." + Адрес.Значение);
				КонецЕсли;
				ЗаполнитьСвойствоXDTO(АдресТип, "Представление", СтрокаАдреса, Истина, Ошибки);
			КонецЕсли;
			
			ЗаполнитьСвойствоXDTO(Контрагент, "Адрес", АдресТип, , Ошибки);
		КонецЕсли;
	КонецЕсли;
	
	ЕстьДанныеКЗаполнению = Ложь;
	Контакты = ПолучитьОбъектТипаCML("КонтактнаяИнформация", ПространствоИменСхемы);
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Контакт.Телефон")) Тогда
		Контакт = ПолучитьОбъектТипаCML("КонтактнаяИнформация.Контакт", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(Контакт, "Тип", НСтр("ru = 'Телефон рабочий'"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Контакт, "Значение",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Контакт.Телефон"), Истина, Ошибки);
		ЕстьДанныеКЗаполнению = Истина;
		Контакты.Контакт.Добавить(Контакт);
	КонецЕсли;
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Контакт.Факс")) Тогда
		Контакт = ПолучитьОбъектТипаCML("КонтактнаяИнформация.Контакт", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(Контакт, "Тип", НСтр("ru = 'Факс'"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Контакт, "Значение",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Контакт.Факс"), Истина, Ошибки);
		ЕстьДанныеКЗаполнению = Истина;
		Контакты.Контакт.Добавить(Контакт);
	КонецЕсли;
	Если ЕстьДанныеКЗаполнению Тогда
		ЗаполнитьСвойствоXDTO(Контрагент, "Контакты", Контакты, , Ошибки);
	КонецЕсли;
	
	ФамилияРуководителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Руководитель.Фамилия");
	Если ЗначениеЗаполнено(ФамилияРуководителя) Тогда
		
		Руководитель = ПолучитьОбъектТипаCML("Руководитель", ПространствоИменСхемы);
		
		ЗаполнитьСвойствоXDTO(Руководитель, "Фамилия", ФамилияРуководителя, Истина, Ошибки);
		
		ИмяРуководителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Руководитель.Имя");
		ЗаполнитьСвойствоXDTO(Руководитель, "Имя", ИмяРуководителя, Истина, Ошибки);
		
		ОтчествоРуководителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Руководитель.Отчество");
		ЗаполнитьСвойствоXDTO(Руководитель, "Отчество", ОтчествоРуководителя, Истина, Ошибки);
		
		ДолжностьРуководителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидКонтрагента + ".Руководитель.Должность");
		ЗаполнитьСвойствоXDTO(Руководитель, "Должность", ДолжностьРуководителя, Истина, Ошибки);
		
		Контрагент.Руководитель = Руководитель;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоместитьРеквизитШапкиВДопДанные(ДеревоДокумента, ПутьКДанным)
	
	ЗначениеРеквизита = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, ПутьКДанным);
	
	Если Не ЗначениеЗаполнено(ЗначениеРеквизита) Тогда
		Возврат;
	КонецЕсли;
	
	ИмяРеквизита = СтрЗаменить(ПутьКДанным, ".", "");
	
	Если ВРег(ИмяРеквизита) = ВРег("ВидОперации") Тогда
		ЗначениеРеквизита = XMLСтрока(ЗначениеРеквизита);
	КонецЕсли;
	
	Если ВРег(ИмяРеквизита) = ВРег("ДатаИсправления") Тогда
		ЗначениеРеквизита = Формат(ЗначениеРеквизита, "ДЛФ=D");
	КонецЕсли;
	
	ДопДанные = Новый Структура(ИмяРеквизита, ЗначениеРеквизита);
	ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоДокумента, ДопДанные, Истина);
	
КонецПроцедуры

Процедура ПоместитьГруппуДереваВДопДанные(ДеревоДокумента, ПутьКДанным)
	
	ВеткаГруппы = ЗначениеГруппыВДереве(ДеревоДокумента, ПутьКДанным);
	Если ТипЗнч(ВеткаГруппы) = Тип("КоллекцияСтрокДереваЗначений") Тогда
		
		ДанныеГруппы = Новый Структура;
		Для Каждого СтрокаДерева Из ВеткаГруппы Цикл
			
			ЗначениеРеквизита = СтрокаДерева.Значение;
			Если Не ЗначениеЗаполнено(ЗначениеРеквизита) Тогда
				Продолжить;
			КонецЕсли;
			
			ИмяРеквизита = СтрЗаменить(СтрокаДерева.ПолныйПуть, ПутьКДанным+".", "");
			
			ДанныеГруппы.Вставить(ИмяРеквизита, ЗначениеРеквизита);
			
		КонецЦикла;
		
		Если ДанныеГруппы.Количество() > 0 Тогда
			ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоДокумента, ДанныеГруппы, Истина);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоместитьТаблицуДереваВДопДанные(ДеревоДокумента, ИмяТаблицы, Подписываемые = Истина)
	
	ЗначениеТаблицы = ЭлектронноеВзаимодействие.ДанныеДерева(ДеревоДокумента, ИмяТаблицы);
	
	Если Не ЗначениеЗаполнено(ЗначениеТаблицы) Тогда
		Возврат;
	КонецЕсли;
	
	ДопДанные = Новый Структура(ИмяТаблицы, ЗначениеТаблицы);
	ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоДокумента, ДопДанные, Подписываемые);
	
КонецПроцедуры

Процедура ПоместитьДокументыОснованияВДопДанныеШапкиФНС(СтрокаДопДанных, СтрокаДокументыОснования, ИдентификаторыДокументовИЭДОснований)
	
	// Разберем документы основания.
	Если ЗначениеЗаполнено(СтрокаДокументыОснования.Значение) Тогда
		ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(СтрокаДокументыОснования.Значение, ИдентификаторыДокументовИЭДОснований);
		
		Для каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ВидДокументаОснования", Строка.ВидЭД);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.НомерДокументаОснования",
				Строка.НомерДокументаОтправителя);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДатаДокументаОснования",
				Формат(Строка.ДатаДокументаОтправителя, "ДЛФ=Д"));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ИДЭДДокументаОснования", Строка.Наименование);
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ИдентификаторДокументаОснования", Строка.ИдентификаторДокументаОснования);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоместитьДокументыОснованияВДопДанные(ДеревоДанных, ИдентификаторыДокументовИЭДОснований)
	
	ОснованиеСсылка = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументыОснования");
	Если ЗначениеЗаполнено(ОснованиеСсылка) Тогда
		
		ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(ОснованиеСсылка, ИдентификаторыДокументовИЭДОснований);
		Если ТаблицаПараметровДокументовОснований.Количество() > 0 Тогда
			
			ПараметрыОснования = Новый Структура;
			ПараметрыОснования.Вставить("_ТЗ_ДокументыОснования", ТаблицаПараметровДокументовОснований);
			
			ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоДанных, ПараметрыОснования, Истина);
		КонецЕсли;
	КонецЕсли;
	
	// Помещаем в доп данные подписываемые реквизиты документа основания
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");

	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		СтрокаДопДанных = Товар.Строки.Найти("Товары.НомерСтроки.ДопДанныеПодписанные", "ПолныйПуть", Истина);
		ДокументОснование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "Товары.НомерСтроки.ДокументОснование");
		Если ЗначениеЗаполнено(ДокументОснование) Тогда
			ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(ДокументОснование, ИдентификаторыДокументовИЭДОснований);
			Для Каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ВидДокументаОснования", Строка.ВидЭД);
				
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных,
					"НомерДокументаОснования", Строка.НомерДокументаОтправителя);
					
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДатаДокументаОснования",
					Формат(Строка.ДатаДокументаОтправителя, "ДЛФ=Д"));
					
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ИДЭДДокументаОснования", Строка.Наименование);
				
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ИдентификаторДокументаОснования", Строка.ИдентификаторДокументаОснования);
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;

	
КонецПроцедуры

Процедура ПоместитьВДопДанныеСтрокиТабличнойЧасти(СтрокаТаблицыТоваров, ИмяРеквизита, ЗначениеРеквизита, ИмяТаблицы = "Товары")

	СтрокаДопДанных = СтрокаТаблицыТоваров.Строки.Найти(ИмяТаблицы +".НомерСтроки.ДопДанныеПодписанные", "ПолныйПуть", Истина);
	Если СтрокаДопДанных <> Неопределено Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, ИмяРеквизита, ЗначениеРеквизита);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоместитьДопДанныеШапки(ДеревоДанных, ДокументXDTO, Ошибки);
	
	ИмяЭлементаВладельца = "Шапка";
	ПространствоИмен = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	МаксДлина = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, "ЗначениеРеквизита", "Значение", ВидФасетаXDTO.МаксДлина);
	ИмяМаксДлина = "ДопустимаяДлинаДопДанныхШапки";

	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ДокументXDTO.Ид);
	СтруктураПараметров.Вставить(ИмяМаксДлина, МаксДлина - 20); // 20 - служебные символы.

	
	СтруктураДопДанных = Новый Структура;
	ДопДанныеНеПодписанные = ДеревоДанных.Строки.Найти("ДопДанные.НеПодписанные", "ПолныйПуть",Истина);
	Если Не ДопДанныеНеПодписанные = Неопределено Тогда
		
		Для Каждого СтрокаДерева Из ДопДанныеНеПодписанные.Строки Цикл
			
			ИмяРеквизита = СтрЗаменить(СтрокаДерева.ПолныйПуть, "ДопДанные.НеПодписанные.", "");
			ЗначениеРеквизита = СтрокаДерева.Значение;
			СтруктураДопДанных.Вставить(ИмяРеквизита, ЗначениеРеквизита);
			
		КонецЦикла;
	КонецЕсли;
		
	Если СтруктураДопДанных.Количество() > 0 Тогда
		ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров,
			СтруктураДопДанных,
			ИмяЭлементаВладельца,
			Ложь);
	КонецЕсли;
	
	СтруктураДопДанных = Новый Структура;
	ДопДанныеПодписанные = ДеревоДанных.Строки.Найти("ДопДанные.Подписанные", "ПолныйПуть",Истина);
	Если Не ДопДанныеПодписанные = Неопределено Тогда
		Для Каждого СтрокаДерева Из ДопДанныеПодписанные.Строки Цикл
			
			ИмяРеквизита = СтрЗаменить(СтрокаДерева.ПолныйПуть, "ДопДанные.Подписанные.", "");
			ЗначениеРеквизита = СтрокаДерева.Значение;
			СтруктураДопДанных.Вставить(ИмяРеквизита, ЗначениеРеквизита);
			
		КонецЦикла;
	КонецЕсли;
	
	Если СтруктураДопДанных.Количество() > 0 Тогда
		
		ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров,
			СтруктураДопДанных,
			ИмяЭлементаВладельца,
			Истина);
		
	КонецЕсли;
	
	СтрокаИнфПол = "";
	ДопДанные = СтруктураПараметров.ДеревоДопДанных;
	
	Если ТипЗнч(ДопДанные) = Тип("ДеревоЗначений")
		И ДопДанные.Строки.Количество() > 0 Тогда
		
		// Сформируем xml-строку (ИнфПол):
		СформировалиСтроку = СформироватьДопФайлCML(СтруктураПараметров,
			Ошибки, Истина, ИмяЭлементаВладельца);
		
		Если СформировалиСтроку Тогда
			
			СтрокаИнфПол = СтрЗаменить(СтруктураПараметров.ИнфПол, "	", "");
			ИмяРеквизитаДопДанные = "ДопДанные" + ИмяЭлементаВладельца;
			ДобавитьВЗначенияРеквизитовДокумента(ИмяРеквизитаДопДанные, СтрокаИнфПол, ДокументXDTO)
		
		КонецЕсли;
		
		// Сформируем доп. файл (для строк таб.части не формируется):
		ДопФайлСформирован = СформироватьДопФайлCML(СтруктураПараметров,
			Ошибки, Ложь, ИмяЭлементаВладельца);
		
		Если ДопФайлСформирован Тогда
			
			ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяДопФайла",     СтруктураПараметров.ПолноеИмяДопФайла);
			ВставитьЗначениеВДерево(ДеревоДанных, "ИдентификаторДопФайла",     СтруктураПараметров.ИдентификаторДопФайла);
			
		КонецЕсли;
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ЗаполнитьНеПодписанныеДанныеШапки(ДеревоДанных, ДокументXDTO, Ошибки)
	
	ИмяЭлементаВладельца = "Шапка";
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ДокументXDTO.Ид);
	
	ДопДанныеНеПодписанные = ДеревоДанных.Строки.Найти("ДопДанные.НеПодписанные", "ПолныйПуть",Истина);
	
	Если Не ДопДанныеНеПодписанные = Неопределено Тогда
		
		СтруктураДопДанных = Новый Структура;
		Для Каждого СтрокаДерева Из ДопДанныеНеПодписанные.Строки Цикл
			
			ИмяРеквизита = СтрЗаменить(СтрокаДерева.ПолныйПуть, "ДопДанные.НеПодписанные.", "");
			ЗначениеРеквизита = СтрокаДерева.Значение;
			СтруктураДопДанных.Вставить(ИмяРеквизита, ЗначениеРеквизита);
			
		КонецЦикла;
		
		
		Если СтруктураДопДанных.Количество() > 0 Тогда
			ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров,
			СтруктураДопДанных,
			ИмяЭлементаВладельца,
			Ложь);
		КонецЕсли;
		
	КонецЕсли;
	
	ДопДанные = СтруктураПараметров.ДеревоДопДанных;
	
	Если ТипЗнч(ДопДанные) = Тип("ДеревоЗначений")
		И ДопДанные.Строки.Количество() > 0 Тогда
		
		ДопФайлСформирован = СформироватьДопФайлCML(СтруктураПараметров,
			Ошибки, Ложь, ИмяЭлементаВладельца);
		
		Если ДопФайлСформирован Тогда
			
			ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяДопФайла",     СтруктураПараметров.ПолноеИмяДопФайла);
			ВставитьЗначениеВДерево(ДеревоДанных, "ИдентификаторДопФайла",     СтруктураПараметров.ИдентификаторДопФайла);
			
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоместитьДопДанныеСтрокиТаблицы(ДеревоДанных, ИдФайла, Ошибки, НомерСтроки, ДокументXDTO)
	
	ИмяЭлементаВладельца = "Строки";
	ПространствоИмен = ОбменСКонтрагентамиСлужебный.ПространствоИменCML();
	МаксДлина = ПолучитьСвойствоПоляXDTOСхемы(ПространствоИмен, "ЗначениеРеквизита", "Значение", ВидФасетаXDTO.МаксДлина);
	ИмяМаксДлина = "ДопустимаяДлинаДопДанныхСтроки";

	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("ДеревоДопДанных", ДеревоДопДанных());
	СтруктураПараметров.Вставить("ИдФайл", ИдФайла);
	СтруктураПараметров.Вставить(ИмяМаксДлина, МаксДлина - 20); // 20 - служебные символы.
	
	ДопДанныеПодписанные = ДеревоДанных.Строки.Найти("Товары.НомерСтроки.ДопДанныеПодписанные", "ПолныйПуть",Истина);
	Если Не ДопДанныеПодписанные = Неопределено Тогда
		СтруктураДопДанных = Новый Структура;
		Для Каждого СтрокаДерева Из ДопДанныеПодписанные.Строки Цикл
			
			ИмяРеквизита = СтрЗаменить(СтрокаДерева.ПолныйПуть, "Товары.НомерСтроки.ДопДанныеПодписанные.", "");
			ЗначениеРеквизита = СтрокаДерева.Значение;
			СтруктураДопДанных.Вставить(ИмяРеквизита, ЗначениеРеквизита);
			
		КонецЦикла;
		
		Если СтруктураДопДанных.Количество() > 0 Тогда
			
			ОбменСКонтрагентами.ДобавитьДанныеВДеревоДопДанных(СтруктураПараметров,
				СтруктураДопДанных,
				ИмяЭлементаВладельца,
				Истина,
				НомерСтроки);
			
		КонецЕсли;
	КонецЕсли;
	
	СтрокаИнфПол = "";
	ДопДанные = СтруктураПараметров.ДеревоДопДанных;
	
	Если ТипЗнч(ДопДанные) = Тип("ДеревоЗначений")
		И ДопДанные.Строки.Количество() > 0 Тогда
		
		// Сформируем xml-строку (ИнфПол):
		СформировалиСтроку = СформироватьДопФайлCML(СтруктураПараметров,
			Ошибки, Истина, ИмяЭлементаВладельца, Строка(НомерСтроки));
		
		Если СформировалиСтроку Тогда
			
			СтрокаИнфПол = СтрЗаменить(СтруктураПараметров.ИнфПол, "	", "");
			ИмяРеквизитаДопДанные = "ДопДанные" + ИмяЭлементаВладельца;
			ДобавитьВЗначенияРеквизитовДокумента(ИмяРеквизитаДопДанные, СтрокаИнфПол, ДокументXDTO)
		
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных)
	
	СтруктураПараметров.Вставить("УникальныйИдентификатор", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УникальныйИдентификатор"));
	Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ПолноеИмяДопФайла") Тогда
		СтруктураПараметров.Вставить("ПолноеИмяДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяДопФайла"));
		СтруктураПараметров.Вставить("ИдентификаторДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдентификаторДопФайла"));
	КонецЕсли;
	
КонецПроцедуры

Процедура СкопироватьСтрокиДереваРекурсивно(СтрокаПолучатель, СтрокаИсточник)
	
	Для Каждого Реквизит Из СтрокаИсточник.Строки Цикл
		НовСтрока = СтрокаПолучатель.Строки.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтрока, Реквизит);
		Если Реквизит.Строки.Количество() > 0 Тогда
			СкопироватьСтрокиДереваРекурсивно(НовСтрока, Реквизит);
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры

Процедура ПрочитатьДопДанныеШапкиДокумента(ДокументXDTO, ДеревоДокумента, Ошибка, ДопРеквизиты = Неопределено)
	
	ДеревоВШапку = Ложь;
	СтрокаДопДерева = ДеревоДокумента.Строки.Найти("ДеревоДопДанных", "Реквизит");
	Если Не СтрокаДопДерева = Неопределено Тогда
		ДопДерево = СтрокаДопДерева.ЗначениеРеквизита;
	Иначе
		ДопДерево = ДеревоДопДанных();
		ДеревоВШапку = Истина;
	КонецЕсли;
	
	ДопДанные = ЗначениеДопРеквизитаДокумента("ДопДанныеШапка", ДокументXDTO);
	Если ЗначениеЗаполнено(ДопДанные) Тогда
		
		ПрочитатьИнфПол(ДопДанные, ДопДерево, "Шапка");
	КонецЕсли;
		
	ДобавитьРеквизитыДопДанныеВШапку(ДопДерево, ДеревоДокумента, Ошибка, ДопРеквизиты);
	
	Если ДеревоВШапку Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(ДеревоДокумента, "ДеревоДопДанных", ДопДерево);
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьРеквизитыДопДанныеВШапку(ДопДерево, ДеревоДокумента, Ошибка, ДопРеквизиты)
	
	СтрокаШапки = ДопДерево.Строки.Найти("Шапка", "ЗначениеРеквизита");
	Если Не ЗначениеЗаполнено(СтрокаШапки) Тогда
		Возврат;
	КонецЕсли;
	
	РеквизитыШапки = Новый Структура;
	
	Если ДопРеквизиты = Неопределено Тогда
		ДопРеквизиты = Новый Структура;
	КонецЕсли;
	
	Если ТипЗнч(ДопРеквизиты) = Тип("Структура") 
		И Не ДопРеквизиты.Свойство("НаправлениеЭД") Тогда
		
		ДопРеквизиты.Вставить("НаправлениеЭД", ДеревоДокумента.НаправлениеЭД);
		
	КонецЕсли;
	
	Для Каждого ВеткаДерева Из СтрокаШапки.Строки Цикл
		
		ИмяРеквизита = ВеткаДерева.ИмяРеквизита;
		ЗначениеРеквизита = ВеткаДерева.ЗначениеРеквизита;
		
		Если СтрНайти(ЗначениеРеквизита, "_ТЗ_") > 0 Тогда
			
			ИмяРеквизита = СтрЗаменить(ЗначениеРеквизита, "_ТЗ_", "");
			
			РеквизитЗначение = ТаблицаВеткиДопДанных(ВеткаДерева);
			
			Если ВРег(ИмяРеквизита) = ВРег("ДокументыОснования")
				Или ВРег(ИмяРеквизита) = ВРег("ДокументОснование") Тогда
				// В актуальных ЭД передаются идентификаторы документов ИБ, для поиска основания:
				ЕстьИДДокументаОснования = РеквизитЗначение.Колонки.Найти("ИдентификаторДокументаОснования") <> Неопределено;
			
				МассивДО = Новый Массив;
				
				Для Каждого ТекСтрока Из РеквизитЗначение Цикл
					Если ЕстьИДДокументаОснования Тогда
						ДокументОснование = ДокументОснованиеПоИдентификатору(ТекСтрока.ИдентификаторДокументаОснования, ДопРеквизиты);
					Иначе
						ДокументОснование = ПолучитьДокументОснование(ТекСтрока.Наименование, ДопРеквизиты);
					КонецЕсли;
					МассивДО.Добавить(ДокументОснование);
				КонецЦикла;
				
				Если МассивДО.Количество() = 1 Тогда
					РеквизитЗначение = МассивДО[0];
				Иначе
					РеквизитЗначение = МассивДО;
				КонецЕсли;
				
			КонецЕсли;
			
		ИначеЕсли ВРег(ИмяРеквизита) = ВРег("Список")
			И ВРег(ЗначениеРеквизита) = ВРег("ДокументыСделки") Тогда
			
			ИмяРеквизита = "ДокументыСделки";
			РеквизитЗначение = ТаблицаВеткиДопДанных(ВеткаДерева);
			
		ИначеЕсли ВРег(ИмяРеквизита) = ВРег("Список")
			И ВРег(ЗначениеРеквизита) = ВРег("Серии") Тогда
			
			ИмяРеквизита = "Серии";
			РеквизитЗначение = ТаблицаВеткиДопДанных(ВеткаДерева);
			
		ИначеЕсли ВРег(ИмяРеквизита) = ВРег("ЦенаВключаетНДС") Тогда
			
			ЦенаВключаетНДС = ЗначениеРеквизита;
			
			Если ВРег(ЦенаВключаетНДС) = ВРег("True") ИЛИ ВРег(ЦенаВключаетНДС) = ВРег("Да") Тогда
				РеквизитЗначение = Истина;
			ИначеЕсли ВРег(ЦенаВключаетНДС) = ВРег("False") ИЛИ ВРег(ЦенаВключаетНДС) = ВРег("Нет") Тогда
				РеквизитЗначение = Ложь;
			КонецЕсли;
			
		ИначеЕсли ВРег(ИмяРеквизита) = ВРег("ДатаИсправления") Тогда
			
			ДатаИсправленияЗначение = ЗначениеРеквизита;
			
			Попытка
				РеквизитЗначение = ДатаИзСтроки(ДатаИсправленияЗначение);
			Исключение
				РеквизитЗначение = ДатаДД_ММ_ГГГГ(ДатаИсправленияЗначение);
			КонецПопытки;
			
		ИначеЕсли ВРег(ИмяРеквизита) = ВРег("СуммаДокумента")
			Или ВРег(ИмяРеквизита) = ВРег("СуммаВознаграждения") Тогда
			
			РеквизитЗначение = Число(ЗначениеРеквизита);
			
		Иначе
			РеквизитЗначение = ЗначениеРеквизита;
			
		КонецЕсли;
		
		РеквизитыШапки.Вставить(ИмяРеквизита, РеквизитЗначение);

	КонецЦикла;
	
	Для Каждого КлючЗначение Из РеквизитыШапки Цикл
		
		ДобавитьРеквизитВПриемник(КлючЗначение.Ключ, КлючЗначение.Значение, ДеревоДокумента);
		
	КонецЦикла;
	
КонецПроцедуры

Функция ТаблицаВеткиДопДанных(СтрокаДерева)
	
	Результат = Новый ТаблицаЗначений;
	СформироватьТаблицуЗначенийПоДопДанным(СтрокаДерева, Результат);
	
	Возврат Результат;
	
КонецФункции

Процедура ПрочитатьДопДанныеСтрокиТЧ(СтрокаXDTO, ДеревоДокумента, ИмяТаблицы, НомерСтроки, СвойстваТЧ, ДопПараметры = Неопределено)
	
	ДопДанные = ЗначениеДопРеквизитаДокумента("ДопДанныеСтроки", СтрокаXDTO);
	СтрокаДопДерево = ДеревоДокумента.Строки.Найти("ДеревоДопДанных", "Реквизит");
	
	НовоеДерево = Ложь;
	Если СтрокаДопДерево = Неопределено Тогда
		ДопДерево = ДеревоДопДанных();
		НовоеДерево = Истина;
		
	Иначе
		ДопДерево = СтрокаДопДерево.ЗначениеРеквизита;
	КонецЕсли;
		
	ПрочитатьИнфПол(ДопДанные, ДопДерево, ИмяТаблицы, Строка(НомерСтроки));
	
	Если НовоеДерево Тогда
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(ДеревоДокумента, "ДеревоДопДанных", ДопДерево);
	КонецЕсли;
	
	Если ДопПараметры = Неопределено Тогда
		ДопПараметры = Новый Структура;
	КонецЕсли;
	
	ДобавитьДопДанныеВСвойстваСтроки(ДопДерево, ИмяТаблицы, СвойстваТЧ, Строка(НомерСтроки), ДопПараметры);
	
КонецПроцедуры

Процедура ДобавитьДопДанныеВСвойстваСтроки(ДопДерево, ИмяТаблицы, СвойстваТЧ, НомерСтроки, ДопПараметры)
	
	СвойстваТаблицы = ДопДерево.Строки.Найти(ИмяТаблицы, "ЗначениеРеквизита");
	Если Не ЗначениеЗаполнено(СвойстваТаблицы) Тогда
		Возврат;
	КонецЕсли;
	
	
	Для Каждого НомерСтр Из СвойстваТаблицы.Строки Цикл
		
		Если ВРег(НомерСтр.ИмяРеквизита) = ВРег("Нпп") Тогда
			Если Не НомерСтр.ЗначениеРеквизита = НомерСтроки Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		ДокументОснованиеНайден = Ложь;
		
		Для Каждого ТекСвойство Из НомерСтр.Строки Цикл
			
			ИмяСвойства = ТекСвойство.ИмяРеквизита;
			ЗначениеСвойства = ТекСвойство.ЗначениеРеквизита;
			
			Если ВРег(ИмяСвойства) = ВРег("ВидДокументаОснования")
				Или ВРег(ИмяСвойства) = ВРег("НомерДокументаОснования")
				Или ВРег(ИмяСвойства) = ВРег("ДатаДокументаОснования") Тогда
				Продолжить;
			КонецЕсли;
			
			Если ВРег(ИмяСвойства) = ВРег("ИдентификаторДокументаОснования") И НЕ ДокументОснованиеНайден Тогда
				// Актуальный алгоритм передачи связки с документами-основаниями.
				// В качестве идентификатора документа-основания во входящем ЭД приходит
				// идентификатор документа ИБ, в результате даже если ЭД для документа-потомка
				// был сформирован и отправлен раньше, чем ЭД документа-основания, после получения
				// ЭД документа-основания можно перезаполнить документ-потомок и ссылка на основание
				// будет найдена.
				ЗначениеСвойства = ДокументОснованиеПоИдентификатору(ЗначениеСвойства, ДопПараметры);
				ИмяСвойства = "ДокументОснование";
				ДокументОснованиеНайден = ЗначениеЗаполнено(ЗначениеСвойства);
			ИначеЕсли ВРег(ИмяСвойства) = ВРег("ИДЭДДокументаОснования") И НЕ ДокументОснованиеНайден Тогда
				ЗначениеСвойства = ПолучитьДокументОснование(ЗначениеСвойства, ДопПараметры);
				ИмяСвойства = "ДокументОснование";
				ДокументОснованиеНайден = ЗначениеЗаполнено(ЗначениеСвойства);
			КонецЕсли;
				
			СвойстваТЧ.Добавить(ЗначениеСвойства, ИмяСвойства);
				
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ЭтоСоставнойИД(ПроверяемыйИД)
	
	Возврат Найти(ПроверяемыйИД,"#") > 0;
	
КонецФункции

Процедура ПоместитьНеПодписанныеДанныеВШапку(ДеревоДокумента)
	
	ДопДерево = Неопределено;
	ВеткаДопДерево = ДеревоДокумента.Строки.Найти("ДеревоДопДанных","Реквизит", Истина);
	Если ЗначениеЗаполнено(ВеткаДопДерево) Тогда
		ДопДерево = ВеткаДопДерево.ЗначениеРеквизита;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьКлючСерий(ДеревоДанных)
	
	СтрокаТаблицаСерии = ДеревоДанных.Строки.Найти("Серии", "ПолныйПуть");
	Если Не ЗначениеЗаполнено(СтрокаТаблицаСерии.Значение) Тогда
		Возврат;
	КонецЕсли;
	
	// Заполняем таблицу товаров
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("ТаблицаТоваров", "ПолныйПуть");
	
	Для Каждого СтрокаСерии Из СтрокаТаблицаСерии.Строки Цикл
		
		
		НоменклатураСерии = ЗначениеРеквизитаДерева(СтрокаСерии, "Серии.НомерСтроки.Номенклатура");
		ХарактеристикаСерии = ЗначениеРеквизитаДерева(СтрокаСерии,"Серии.НомерСтроки.Характеристика");
		
		Для Каждого СтрокаТовары Из СтрокаТаблицаТоваров.Строки Цикл
			НоменклатураТовары = ЗначениеРеквизитаДерева(СтрокаТовары, "ТаблицаТоваров.НомерСтроки.Номенклатура");
			ХарактеристикаТовары = ЗначениеРеквизитаДерева(СтрокаТовары, "ТаблицаТоваров.НомерСтроки.Характеристика");
			
			Если (НоменклатураСерии = НоменклатураТовары)
				И ((ХарактеристикаСерии = ХарактеристикаТовары)
					Или (Не ЗначениеЗаполнено(ХарактеристикаСерии) И Не ЗначениеЗаполнено(ХарактеристикаТовары))) Тогда
					
				КлючСтрокиСерии = ЗначениеРеквизитаДерева(СтрокаТовары, "ТаблицаТоваров.НомерСтроки.ДопДанныеПодписанные.ИД");
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаСерии, "Серии.НомерСтроки.ИдентификаторСтроки", КлючСтрокиСерии);
				Прервать;;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "Серии", Ложь);
	
КонецПроцедуры

Процедура ПрочитатьСерииНоменклатуры(ДеревоДанных, ИдентификаторыСтрокСерии)
	
	СтрокаТаблицаСерии = ДеревоДанных.Строки.Найти("Серии", "Реквизит");
	Если СтрокаТаблицаСерии = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЕстьХарактеристика =  Не СтрокаТаблицаСерии.ЗначениеРеквизита.Колонки.Найти("Характеристика") = Неопределено;
	
	Для Каждого СтрокаСерии Из СтрокаТаблицаСерии.ЗначениеРеквизита Цикл
		
		ИдентификаторСтроки = СтрокаСерии.ИдентификаторСтроки;
		
		НоменклатураХарактеристика = ИдентификаторыСтрокСерии.Найти(ИдентификаторСтроки, "Идентификатор");
		Если НоменклатураХарактеристика = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Номенклатура = НоменклатураХарактеристика.Номенклатура;
		СтрокаСерии.Номенклатура = Номенклатура;
		
		Если ЕстьХарактеристика Тогда
			Характеристика = НоменклатураХарактеристика.Характеристика;
			СтрокаСерии.Характеристика = Характеристика;
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

Процедура ПоместитьТабличнуюЧастьВШапкуДокумента(ДеревоЭД, ДеревоДопДанных, ИмяТаблицы)
	
	СтрокаТч = ДеревоДопДанных.Строки.Найти(ИмяТаблицы, "ЗначениеРеквизита", Истина);
	Если СтрокаТч = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТчДопДанные = Новый ТаблицаЗначений;
	СформироватьТаблицуЗначенийПоДопДанным(СтрокаТч, ТчДопДанные);
	ЭлектронноеВзаимодействие.ЗагрузитьТаблицуВДерево(ДеревоЭД, ТчДопДанные, ИмяТаблицы);

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Обработка дополнительных данных ЭД

// Формирование xml-файла/строки

Функция СформироватьДопСтроку(МассивСтрок, Рекв, ПространствоИменСхемы, ЮридическиЗначимый, ЕстьДанныеДляДопФайла, Ошибки, Знач УровеньВложенности)
	
	УровеньВложенности = УровеньВложенности + 1;
	Для Каждого СтрокаДЗ Из МассивСтрок Цикл
		Если Не ЮридическиЗначимый Тогда
			Если СтрокаДЗ.ЮридическиЗначимый Тогда 
				// Если ЮридическиЗначимый = Истина, то входящий МассивСтрок содержит только юридически значимые реквизиты.
				// В противном случае, МассивСтрок - смешанный, поэтому надо пропускать юридически значимые реквизиты (т.к. они
				// будут передаваться отдельно от не значимых, в разных файлах).
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		Реквизит = ПолучитьОбъектТипаCML("Реквизит.Реквизит", ПространствоИменСхемы);
		ЗаполнитьСвойствоXDTO(Реквизит, "Имя", СтрокаДЗ.ИмяРеквизита, , Ошибки);
		Если ЗначениеЗаполнено(СтрокаДЗ.ЗначениеРеквизита) Тогда
			ЗаполнитьСвойствоXDTO(Реквизит, "Значение", СтрокаДЗ.ЗначениеРеквизита, , Ошибки);
		КонецЕсли;
		МассивСтрокДЗ = СтрокаДЗ.Строки;
		Если МассивСтрокДЗ.Количество() > 0 Тогда // добавляем наборы и массивы данных:
			СформироватьДопСтроку(МассивСтрокДЗ, Реквизит, ПространствоИменСхемы, ЮридическиЗначимый,
				ЕстьДанныеДляДопФайла, Ошибки, УровеньВложенности);
			Рекв.Реквизит.Добавить(Реквизит);
		Иначе // добавляем конечные значения реквизитов:
			Рекв.Реквизит.Добавить(Реквизит);
			ЕстьДанныеДляДопФайла = Истина;
		КонецЕсли;
	КонецЦикла;
	
КонецФункции

Функция СформироватьДопФайлCML(СтруктураПараметров,
											Ошибки,
											Знач ЮридическиЗначимый = Ложь,
											ИмяТЧ = Неопределено,
											НомерСтроки = Неопределено)
	
	// ИмяТЧ и НомерСтроки заполняются только для юридически значимой информации (информация - которая будет помещена в
	// основном файле (ИнфПол, ИнфПолСтр) и подписана ЭЦП).
	Если НомерСтроки <> Неопределено Тогда //ЗначениеЗаполнено(ИмяТЧ) ИЛИ
		ЮридическиЗначимый = Истина;
	КонецЕсли;
	ДопФайлСформирован = Ложь;
	ПространствоИменСхемы = "ДопФайлУниверсальный";
	Попытка
		ДеревоДопДанных = СтруктураПараметров.ДеревоДопДанных;
		Если ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") И ДеревоДопДанных.Строки.Количество() > 0 Тогда
			
			ЕстьДанныеДляДопФайла = Ложь;
			ДопФайл = ПолучитьОбъектТипаCML("ДопФайл", ПространствоИменСхемы);
			Данные = ПолучитьОбъектТипаCML("ДопФайл.Данные", ПространствоИменСхемы);
			
			Если НомерСтроки <> Неопределено Тогда
				// Если НомерСтроки - заполнено, то формируется строка ИнфПолСтр по юридически значимой информации и конкретной строке ТЧ.
				СтОтбора = Новый Структура;
				СтОтбора.Вставить("ТЧ", Истина);
				СтОтбора.Вставить("ИмяРеквизита", "Список");
				СтОтбора.Вставить("ЗначениеРеквизита", ИмяТЧ);
				МассивСтрокДЗ = ДеревоДопДанных.Строки.НайтиСтроки(СтОтбора, Истина);
				Если МассивСтрокДЗ.Количество() > 0 Тогда
					// В нужной ТЧ найдем требующуюся строку (НомерСтроки):
					СтОтбора = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Нпп", НомерСтроки);
					МассивСтрокДЗ = МассивСтрокДЗ[0].Строки.НайтиСтроки(СтОтбора);
					Если МассивСтрокДЗ.Количество() > 0 Тогда
						// В подчиненных строках выберем юридически значимые реквизиты:
						МассивСтрокДЗ = МассивСтрокДЗ[0].Строки.НайтиСтроки(Новый Структура("ЮридическиЗначимый", Истина));
					КонецЕсли;
				КонецЕсли;
			Иначе
				// Если ЮридическиЗначимый=Истина, значит формируется строка ИнфПол(ИнфПолСтр).

				Если ЮридическиЗначимый Тогда
					СтОтбора = Новый Структура("ИмяРеквизита, ЗначениеРеквизита", "Набор", ИмяТЧ);
					МассивСтрокДЗ = ДеревоДопДанных.Строки.НайтиСтроки(СтОтбора);
					Если МассивСтрокДЗ.Количество() > 0 Тогда
						
						// В подчиненных строках выберем юридически значимые реквизиты:
						МассивСтрокДЗ = МассивСтрокДЗ[0].Строки.НайтиСтроки(Новый Структура("ЮридическиЗначимый", Истина));
									
					КонецЕсли;
					
				Иначе
					
					МассивСтрокДЗ = ДеревоДопДанных.Строки;
					
				КонецЕсли;
			КонецЕсли;
			
			Если МассивСтрокДЗ.Количество() > 0 Тогда
				СформироватьДопСтроку(МассивСтрокДЗ, Данные, ПространствоИменСхемы, ЮридическиЗначимый,
					ЕстьДанныеДляДопФайла, Ошибки, 0);
					
				ЗаполнитьСвойствоXDTO(ДопФайл, "Данные", Данные, Истина, Ошибки);
			КонецЕсли;
			
			ИдДопФайла = Новый УникальныйИдентификатор;
			ЗаполнитьСвойствоXDTO(ДопФайл, "ИдФайла", СтруктураПараметров.ИдФайл, Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ДопФайл, "ИдДопФайла", Строка(ИдДопФайла), Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ДопФайл, "ВерсияФормата", "1", Истина, Ошибки);
			ЗаполнитьСвойствоXDTO(ДопФайл, "ДатаФормирования", ТекущаяДатаСеанса(), Истина, Ошибки);
			ДопФайл.Проверить();
			
			Если ЕстьДанныеДляДопФайла И НЕ ЗначениеЗаполнено(Ошибки) Тогда
				Если ЮридическиЗначимый Тогда
					ЗаписьXML = Новый ЗаписьXML;
					ЗаписьXML.УстановитьСтроку();
					ФабрикаXDTO.ЗаписатьXML(ЗаписьXML, ДопФайл);
					СтрXML = ЗаписьXML.Закрыть();
					НачПоз = СтрНайти(СтрXML, "<Данные>");
					КолСимв = СтрНайти(СтрXML, "</Данные>") - НачПоз + СтрДлина("</Данные>");
					СтрXML = Сред(СтрXML, НачПоз, КолСимв);
					
					СтрXML = СтрЗаменить(СтрXML, Символы.Таб,"");
					СтрXML = СтрЗаменить(СтрXML, Символы.ПС,"");
					
					СтруктураПараметров.Вставить("ИнфПол", СтрXML);
				Иначе
					СтруктураПараметров.Вставить("ИдентификаторДопФайла", ИдДопФайла);
					
					ПолноеИмяФайла = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СтруктураПараметров.ИдФайл) + ИдДопФайла + ".xml";
					СтруктураПараметров.Вставить("ПолноеИмяДопФайла", ПолноеИмяФайла);
					ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДВФайл(ДопФайл, ПолноеИмяФайла, Ложь);
				КонецЕсли;
				ДопФайлСформирован = Истина;
			КонецЕсли;
		КонецЕсли;
	Исключение
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибку(Ошибки, ОписаниеОшибки());
	КонецПопытки;
	
	Возврат ДопФайлСформирован;
	
КонецФункции

Процедура ВывестиДопДанныеШапкиНаПечать(ДанныеПечати, Макет, ТабличныйДокумент)
	
	ДеревоДопДанных = Неопределено;
	Если ДанныеПечати.Свойство("ДеревоДопДанных", ДеревоДопДанных) И ТипЗнч(ДеревоДопДанных) = Тип("ДеревоЗначений") Тогда
		ЗаполнитьДопДанныеШапки(ДеревоДопДанных, Макет, ТабличныйДокумент);
	КонецЕсли;
	
КонецПроцедуры

Процедура ВывестиДопДанныеСтрокиНаПечать(ТаблицаДопДанныхСтрок, СтруктураДопДанных, НомерСтроки, ТабличныйДокумент, ОбластьМакета, ИмяОбласти)
	
	Если ТаблицаДопДанныхСтрок.Количество() > 0 Тогда
		СтрокаТаблицыДД = ТаблицаДопДанныхСтрок.Найти(Строка(НомерСтроки), "НомерСтр");
		Если СтрокаТаблицыДД <> Неопределено Тогда
			Если СтруктураДопДанных.ЕстьПодписанные Тогда
				ОбластьМакета.Параметры.Подписанные = СтрокаТаблицыДД.ПодписанныеДанные;
				ЭлектронноеВзаимодействиеСлужебный.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, ОбластьМакета,
					ИмяОбласти, НомерСтроки);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Функция ТаблицаДопДанных()
	
	ТаблицаДопДанныхСтрок = Новый ТаблицаЗначений;
	ТаблицаДопДанныхСтрок.Колонки.Добавить("НомерСтр");
	ТаблицаДопДанныхСтрок.Колонки.Добавить("ПодписанныеДанные");
	ТаблицаДопДанныхСтрок.Колонки.Добавить("НеПодписанныеДанные");
	
	Возврат ТаблицаДопДанныхСтрок;
	
КонецФункции

Процедура ДобавитьДопДанныеВДанныеДляОбъекта(ДанныеДляОбъекта, ДеревоРазбора)
	
	СтрокаДереваДопДанных = ДеревоРазбора.Строки.Найти("ДеревоДопДанных", "Реквизит", Истина);
	Если СтрокаДереваДопДанных <> Неопределено И ТипЗнч(СтрокаДереваДопДанных.ЗначениеРеквизита) = Тип("ДеревоЗначений") Тогда
		ДеревоДопДанных = СтрокаДереваДопДанных.ЗначениеРеквизита;
		ДанныеДляОбъекта.Вставить("ДеревоДопДанных", ДеревоДопДанных);
	КонецЕсли
	
КонецПроцедуры

// Только для внутреннего использования
Функция СформироватьРегистрационнуюИнформациюCML(ДеревоДанных)
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	ПутьКОписанию = "{http://www.1c.ru/edo/registration}.Файл";
	Попытка
		
		Файл = ПолучитьОбъектТипаCML(ПутьКОписанию);
		
		// Коммерческая информация
		ЗаполнитьСвойствоXDTO(Файл, "ИдФайл",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсПрог", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсПрог"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Файл, "ВерсФорм", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсФорм"), Истина, Ошибки);
		
		Документ = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ");
		ЗаполнитьСвойствоXDTO(Документ, "КНД",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "КНД"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "КодНО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "КодНО"), Истина, Ошибки);
		
		ОперЭДО = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.ОперЭДО");
		ЗаполнитьСвойствоXDTO(ОперЭДО, "НаимОрг",   ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОперЭДО.НаимОрг"),   Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ОперЭДО, "ИННЮЛ",     ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОперЭДО.ИННЮЛ"),     Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ОперЭДО, "КПП",       ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОперЭДО.КПП"),       Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ОперЭДО, "ОГРН",      ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОперЭДО.ОГРН"),      Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ОперЭДО, "ИдОперЭДО", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОперЭДО.ИдОперЭДО"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(Документ, "ОперЭДО", ОперЭДО, , Ошибки);
		
		УчастникЭДО = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО");
		ЗаполнитьСвойствоXDTO(УчастникЭДО, "ТипЗаявления",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипЗаявления"), Истина, Ошибки);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ИдУчастЭДО")) Тогда
			ЗаполнитьСвойствоXDTO(УчастникЭДО, "ИдУчастЭДО",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ИдУчастЭДО"), , Ошибки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника")) Тогда
			
			Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника") = "ЮЛ" Тогда
				
				СвЮЛ = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.ЮЛ");
				ЗаполнитьСвойствоXDTO(СвЮЛ, "НаимОрг",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.НаимОрг"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(СвЮЛ, "ИННЮЛ",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.ИННЮЛ"),   Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(СвЮЛ, "КПП",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.КПП"),     Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(СвЮЛ, "ОГРН",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.ОГРН"),    Истина, Ошибки);
				
				ЗаполнитьСвойствоXDTO(СвЮЛ, "ДатаПодклЭДО",
					ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.ДатаПодклЭДО")), Истина, Ошибки);
				
				АдрРФ = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.ЮЛ.АдрРФ");
				ЗаполнитьСвойствоXDTO(АдрРФ, "Индекс",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.Индекс"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "КодРегион",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.КодРегион"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Район",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.Район"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Город",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.Город"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "НаселПункт",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.НаселПункт"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Улица",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.Улица"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Дом",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.Дом"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Корпус",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.Корпус"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Кварт",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.АдрРФ.Кварт"), , Ошибки);
				ЗаполнитьСвойствоXDTO(СвЮЛ, "АдрРФ", АдрРФ, , Ошибки);
				
				ФИООтв = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.ЮЛ.ФИООтв");
				ЗаполнитьСвойствоXDTO(ФИООтв, "Фамилия",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.ФИООтв.Фамилия"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ФИООтв, "Имя",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.ФИООтв.Имя"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ФИООтв, "Отчество",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ЮЛ.ФИООтв.Отчество"), , Ошибки);
				ЗаполнитьСвойствоXDTO(СвЮЛ, "ФИООтв", ФИООтв, , Ошибки);
				
				ЗаполнитьСвойствоXDTO(УчастникЭДО, "ЮЛ", СвЮЛ, , Ошибки);
			Иначе
				
				СвИП = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.ИП");
				ЗаполнитьСвойствоXDTO(СвИП, "ИННФЛ",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.ИННФЛ"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(СвИП, "ОГРНИП",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.ОГРНИП"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(СвИП, "ДатаПодклЭДО",
					ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.ДатаПодклЭДО")), Истина, Ошибки);
				
				АдрРФ = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.ИП.АдрРФ");
				ЗаполнитьСвойствоXDTO(АдрРФ, "Индекс",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.Индекс"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "КодРегион",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.КодРегион"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Район",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.Район"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Город",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.Город"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "НаселПункт",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.НаселПункт"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Улица",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.Улица"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Дом",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.Дом"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Корпус",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.Корпус"), , Ошибки);
				ЗаполнитьСвойствоXDTO(АдрРФ, "Кварт",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.АдрРФ.Кварт"), , Ошибки);
				ЗаполнитьСвойствоXDTO(СвИП, "АдрРФ", АдрРФ, , Ошибки);
				
				ФИО = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.ИП.ФИО");
				ЗаполнитьСвойствоXDTO(ФИО, "Фамилия",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.ФИО.Фамилия"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ФИО, "Имя",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.ФИО.Имя"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ФИО, "Отчество",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УчастЭДО.ТипУчастника.ИП.ФИО.Отчество"), , Ошибки);
				ЗаполнитьСвойствоXDTO(СвИП, "ФИО", ФИО, Истина, Ошибки);
				
				ЗаполнитьСвойствоXDTO(УчастникЭДО, "ИП", СвИП, , Ошибки);
			КонецЕсли;
		КонецЕсли;
		
		СтрокаТаблицыСертификатов = ДеревоДанных.Строки.Найти("УчастЭДО.СертифДолжн", "ПолныйПуть", Истина);
		Если ЗначениеЗаполнено(СтрокаТаблицыСертификатов.Значение) Тогда
			Для Каждого СтрСертификат Из СтрокаТаблицыСертификатов.Строки Цикл
				Сертификат = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.СертифДолжн");
				ЗаполнитьСвойствоXDTO(Сертификат, "ДатаНачСертиф",
					ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрСертификат, "УчастЭДО.СертифДолжн.НомерСтроки.ДатаНачСертиф")), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(Сертификат, "ДатаКонСертиф",
					ДатаДД_ММ_ГГГГ(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрСертификат, "УчастЭДО.СертифДолжн.НомерСтроки.ДатаКонСертиф")), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(Сертификат, "ОтпСертиф",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрСертификат, "УчастЭДО.СертифДолжн.НомерСтроки.ОтпСертиф"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(Сертификат, "Сертификат",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрСертификат, "УчастЭДО.СертифДолжн.НомерСтроки.Сертификат"), Истина, Ошибки);
				
				ФИО = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.УчастЭДО.СертифДолжн.ФИО");
				ЗаполнитьСвойствоXDTO(ФИО, "Фамилия",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрСертификат, "УчастЭДО.СертифДолжн.НомерСтроки.Фамилия"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ФИО, "Имя",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрСертификат, "УчастЭДО.СертифДолжн.НомерСтроки.Имя"), Истина, Ошибки);
				ЗаполнитьСвойствоXDTO(ФИО, "Отчество",
					ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрСертификат, "УчастЭДО.СертифДолжн.НомерСтроки.Отчество"), , Ошибки);
				ЗаполнитьСвойствоXDTO(Сертификат, "ФИО", ФИО, Истина, Ошибки);
				
				УчастникЭДО.СертифДолжн.Добавить(Сертификат);
			КонецЦикла;
		КонецЕсли;
		ЗаполнитьСвойствоXDTO(Документ, "УчастЭДО", УчастникЭДО, , Ошибки);
		
		Подписант = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.Подписант");
		ЗаполнитьСвойствоXDTO(Подписант, "Должность", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Подписант.Должность"), Истина, Ошибки);
		
		ФИО = ПолучитьОбъектТипаCML(ПутьКОписанию + ".Документ.Подписант.ФИО");
		ЗаполнитьСвойствоXDTO(ФИО, "Фамилия",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Подписант.ФИО.Фамилия"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ФИО, "Имя",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Подписант.ФИО.Имя"), Истина, Ошибки);
		ЗаполнитьСвойствоXDTO(ФИО, "Отчество",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Подписант.ФИО.Отчество"), , Ошибки);
		ЗаполнитьСвойствоXDTO(Подписант, "ФИО", ФИО, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(Документ, "Подписант", Подписант, , Ошибки);
		
		ЗаполнитьСвойствоXDTO(Файл, "Документ", Документ, , Ошибки);
		
		Файл.Проверить();
		
		ИмяФайла = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		ЭлектронноеВзаимодействиеСлужебный.ВыгрузитьЭДвФайл(Файл, ИмяФайла, Ложь);
		
		Возврат ИмяФайла;
		
	Исключение
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		ТекстСообщения = ?(ЗначениеЗаполнено(ТекстОшибки), ТекстОшибки, КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(НСтр("ru = 'Формирование данных для оператора ЭДО'"),
																					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
																					ТекстСообщения);
		Возврат "";
	КонецПопытки;
	
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Сервис 1С ЭДО

// Только для внутреннего использования
Функция СтруктураНастроек1СЭДО()
	
	СтруктураНастроек = Новый Структура;
	СтруктураНастроек.Вставить("АдресВебСервиса", "https://1c-edo.ru/API/");
	
	Возврат СтруктураНастроек;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Получение ЭД

// Получить новые электронные документы от оператора ЭДО.
//
// Параметры:
//  АдресРесурса - Строка - адрес ресурса.
//  ДатаПоследнегоЗапроса - Дата - дата последнего запроса.
//  Маркер - ДвоичныеДанные, Строка - расшифрованный маркер.
//
// Возвращаемое значение:
//  СписокЭД_XML - список электронных документов.
//
Функция ПолучитьЧерезОператораЭДО(Знач АдресРесурса, ДатаПоследнегоЗапроса, Маркер, СтруктураПараметровЗапросаМаркера, ПрофильНастроекЭДО)
	
	Соединение = ПолучитьСоединение(СтруктураПараметровЗапросаМаркера.СпособОбменаЭД);
	Маркер = ЭлектронноеВзаимодействиеСлужебныйВызовСервера.СтрокаИзДвоичныхДанных(Маркер);
	
	АдресРесурса = АдресРесурса + ?(ЗначениеЗаполнено(ДатаПоследнегоЗапроса), "?date=" + ДатаПоследнегоЗапроса, "");
	
	СписокЭД_XML = ПолучитьЭлектронныеДокументыОператораЭДО(Маркер, Соединение, АдресРесурса, ПрофильНастроекЭДО);
	
	Возврат СписокЭД_XML;
	
КонецФункции

Функция ИдентификаторыСерийНоменклатуры()
	
	ИдентификаторыСерий = Новый ТаблицаЗначений;
	ИдентификаторыСерий.Колонки.Добавить("Идентификатор");
	ИдентификаторыСерий.Колонки.Добавить("Номенклатура");
	ИдентификаторыСерий.Колонки.Добавить("Характеристика");
	
	Возврат ИдентификаторыСерий;
	
КонецФункции

Процедура ЗаполнитьДокументыОснования(ДеревоДопДанных, ПараметрыПоиска, ДеревоЭД)
	
	ДокументОснование = Неопределено;
	СтрокаИдДокументаОснования = ДеревоДопДанных.Строки.Найти("ИдентификаторДокументаОснования","ИмяРеквизита", Истина);
	Если Не СтрокаИдДокументаОснования = Неопределено Тогда
		ИдДокументаОснования  = СтрокаИдДокументаОснования.ЗначениеРеквизита;
		ДокументОснование = ДокументОснованиеПоИдентификатору(ИдДокументаОснования, ПараметрыПоиска);
	КонецЕсли;
	
	Если ДокументОснование = Неопределено Тогда
		СтрокаИДЭДДокументаОснования = ДеревоДопДанных.Строки.Найти("ИДЭДДокументаОснования", "ИмяРеквизита", Истина);
		Если Не СтрокаИДЭДДокументаОснования = Неопределено Тогда
			ИДЭДДокументаОснования = СтрокаИДЭДДокументаОснования.ЗначениеРеквизита;
			ДокументОснование = ДокументОснованиеПоИдентификатору(ИДЭДДокументаОснования, ПараметрыПоиска);
		КонецЕсли;
	КонецЕсли;
	
	Если Не ДокументОснование = Неопределено Тогда
		
		ЗаполнитьРеквизитДерева(ДеревоЭД, "ДокументыОснования", ДокументОснование);
		
	КонецЕсли;
	
КонецПроцедуры

Функция ЗначениеРеквизитаДерева(Дерево, ИмяРеквизита, СообщатьОбОшибке = Истина)
	
	Возврат ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, ИмяРеквизита, СообщатьОбОшибке)
	
КонецФункции

Функция ПространствоИменПередачаТоваровПродавец()
	
	Возврат "TORGPR";
	
КонецФункции

Функция ПространствоИменПередачаРаботИсполнитель()
	
	Возврат "RUISP";
	
КонецФункции

Процедура СохранитьДопДанныеВФайл(ЭДСсылка, ИмяФайла)
	
	ВыборкаЭДДопДанных = ОбменСКонтрагентамиСлужебный.ВыборкаДопДанныеЭД(ЭДСсылка);
	Если ВыборкаЭДДопДанных.Следующий() Тогда
		
		ПараметрыФайла = СвойстваФайла();
		
		СохранитьЭДВФайл(ВыборкаЭДДопДанных.Ссылка, ПараметрыФайла);
		
		ИмяФайла = ПараметрыФайла.ИмяФайла;
		
	КонецЕсли;
	
КонецПроцедуры

Функция СвойстваФайла()
	
	Свойства = Новый Структура("ИмяФайла, Наименование, Расширение");
	
	Возврат Свойства;
	
КонецФункции

Функция ЗначениеПараметра(ЗначенияСвойств, ИмяСвойства, ЗначениеПоУмолчанию = Неопределено)
	
	ЗначениеСвойства = Неопределено;
	ЗначенияСвойств.Свойство(ИмяСвойства, ЗначениеСвойства);
	Если ЗначениеСвойства = Неопределено Тогда
		ЗначениеСвойства = ЗначениеПоУмолчанию;
	КонецЕсли;
	
	Возврат ЗначениеСвойства;
	
КонецФункции

Функция ЕстьСвойствоXDTO(ОбъектXDTO, ИмяСвойства, НеПроверятьЗаполнение = Ложь) Экспорт
	
	Если Не ТипЗнч(ОбъектXDTO) = Тип("ОбъектXDTO") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Результат = Истина;
	Если ОбъектXDTO.Свойства().Получить(ИмяСвойства) = Неопределено Тогда
		Результат = Ложь;
	КонецЕсли;
	
	ПроверятьЗаполнение = Не НеПроверятьЗаполнение;
	
	Если Результат И ПроверятьЗаполнение Тогда
		Если ОбъектXDTO[ИмяСвойства] = Неопределено Тогда
			Результат = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ЗначениеСвойстваXDTO(ОбъектXDTO, ИмяСвойства, Тип = Неопределено, ЭтоСписок = Ложь) Экспорт
	
	Значение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеСвойстваXDTO(ОбъектXDTO, ИмяСвойства);
	
	Если Тип <> Неопределено Тогда
		
		ЗначенияПоУмолчанию = Новый Структура;
		ЗначенияПоУмолчанию.Вставить("Число",  0);
		ЗначенияПоУмолчанию.Вставить("Дата",   '00010101');
		ЗначенияПоУмолчанию.Вставить("Булево", Ложь);
		ЗначенияПоУмолчанию.Вставить("Строка", "");
		
		Если Значение <> Неопределено Тогда
			Если Тип = "Число" Тогда
				Значение = Число(Значение);
			ИначеЕсли Тип = "Дата" Тогда
				Значение = ДатаИзСтроки(Значение);
			ИначеЕсли Тип = "XMLДата" Тогда
				Значение = XMLЗначение(Тип("Дата"),Значение);
			ИначеЕсли Тип = "Булево" Тогда
				Значение = Булево(Значение);
			КонецЕсли;
		Иначе
			Значение = ЗначенияПоУмолчанию[Тип];
		КонецЕсли;
		
	ИначеЕсли ЭтоСписок И ТипЗнч(Значение) = Тип("ОбъектXDTO") Тогда
		
		// При чтении xml файла фабрикой XDTO без указания типа, если в СпискеXDTO только 1 строка,
		// то список конвертируется в ОбъектXDTO. Вернем его в массиве, чтобы
		// всегда обходить в цикле, вне зависимости от количества строк.
		
		Коллекция = Новый Массив;
		Коллекция.Добавить(Значение);
		
		Значение = Коллекция;
		
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

Функция СодержаниеОперацииПередачаТоваров()
	Возврат "Перечисленные в документе ценности переданы";
КонецФункции

Функция НаименованиеДокументаПередачаТоваров()
	Возврат "Товарная накладная";
КонецФункции

Функция НаименованиеДокументаПередачаРабот()
	Возврат НСтр("ru ='Акт о передаче результатов работ (Акт об оказании услуг)'");
КонецФункции

Функция НаименованиеФактаПередачаРабот()
	Возврат "Документ о передаче результатов работ (Документ об оказании услуг)";
КонецФункции

Функция НаименованиеФактаПередачаТоваров()
	Возврат НСтр("ru ='Документ о передаче товара при торговых операциях'");
КонецФункции

Функция ДолжностныеОбязанности()
	Возврат НСтр("ru ='Должностные обязанности'");
КонецФункции

Процедура ДобавитьДоговорВДеревоДокумента(РеквизитыДоговора, НовыйЭД, ДеревоРазбора, Ошибка)

	ДоговорКонтрагента = ЭлектронноеВзаимодействие.НайтиСсылку("ДоговорыКонтрагентов", , РеквизитыДоговора);
	
	ДоговорНомер = РеквизитыДоговора.НомерДоговора;
	НайденныйТипВДереве = ЭлектронноеВзаимодействиеСлужебный.НайтиСоздатьТипОбъектаВДеревеРазбора(ДеревоРазбора, "ДоговорыКонтрагентов");
	НайденнаяСтрока = НайтиСоздатьСтрокуВДеревеРазбора(НайденныйТипВДереве, ДоговорНомер, НСтр("ru ='Номер договора:'") + " " + ДоговорНомер, ДоговорКонтрагента,
				РеквизитыДоговора, ДеревоРазбора, Ошибка);
	ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "ДоговорКонтрагента", НайденнаяСтрока.ИндексСтроки);
	
КонецПроцедуры

Процедура ПрочитатьДокументыСделки(ДеревоРазбора, НовыйЭД, Организация, ВладелецДоговора, Ошибка)
	
	ДокументыСделки = ПолучитьРеквизитШапкиЭД(НовыйЭД, "ДокументыСделки");
	Если ДокументыСделки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ДокументыСделки.Колонки.Найти("Идентификатор") = Неопределено
		ИЛИ ДокументыСделки.Колонки.Найти("Номер") = Неопределено
		ИЛИ ДокументыСделки.Колонки.Найти("Дата") = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого ТекСтрока Из ДокументыСделки Цикл
		
		// Если идентификатор "договор" - это договор контрагента.
		Если Не ТекСтрока.Идентификатор = "договор" Тогда
			Продолжить;
		КонецЕсли;
		
		РеквизитыДоговора = Новый Структура;
		РеквизитыДоговора.Вставить("НомерДоговора", ТекСтрока.Номер);
		РеквизитыДоговора.Вставить("ДатаДоговора", ДатаИзСтроки(ТекСтрока.Дата));
		РеквизитыДоговора.Вставить("Организация", Организация);
		РеквизитыДоговора.Вставить("Владелец", ВладелецДоговора);
		
		ДобавитьДоговорВДеревоДокумента(РеквизитыДоговора, НовыйЭД, ДеревоРазбора, Ошибка);
		
	КонецЦикла;
	
КонецПроцедуры

Функция ЗначениеТаблицыДереваЭД(ДеревоДанных, ИмяТаблицы)
	
	Возврат ДеревоДанных.Строки.Найти(ИмяТаблицы, "ПолныйПуть");
	
КонецФункции

Процедура ЗаполнитьРеквизитДерева(Дерево, Реквизит, Значение, ЗаполнятьПустые = Ложь)
	
	Если Не (ЗначениеЗаполнено(Значение) ИЛИ ЗаполнятьПустые) Тогда
		Возврат;
	КонецЕсли;
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(Дерево, Реквизит, Значение);
	
КонецПроцедуры

Функция ШаблонОснованияДокумента()
	
	Шаблон = Новый ТаблицаЗначений;
	Шаблон.Колонки.Добавить("ДокОснованиеНаименование");
	Шаблон.Колонки.Добавить("ДокОснованиеНомер");
	Шаблон.Колонки.Добавить("ДокОснованиеДата");
	Шаблон.Колонки.Добавить("ДокОснованиеДопСведения");
	
	Возврат Шаблон;
	
КонецФункции

Функция ШаблонТранспортнаяНакладная()
	
	Шаблон = Новый ТаблицаЗначений;
	Шаблон.Колонки.Добавить("ТранспортнаяНакладнаяНомер");
	Шаблон.Колонки.Добавить("ТранспортнаяНакладнаяДата");
	
	Возврат Шаблон;
	
КонецФункции

Процедура ЗаполнитьДанныеЛицаПередавшегоГруз(ДеревоДанных, ДанныеЛицаПередавшегоГруз)
	
	
	Если ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, "РабОргПрод") <> Неопределено Тогда
		
		Путь = "РабОргПрод";
		
		ЗаполнитьРеквизитДерева(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Должность",
			ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".Должность"));
			
		ЗаполнитьРеквизитДерева(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ИныеСведения",
			ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ИныеСвед"));
			
		ЗаполнитьРеквизитДерева(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ОснованиеПолномочий",
			ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ОснПолн"));
			
		ЗаполнитьРеквизитДерева(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Фамилия",
			ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Фамилия"));
			
		ЗаполнитьРеквизитДерева(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Имя",
			ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Имя"));
			
		ЗаполнитьРеквизитДерева(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Отчество",
			ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Отчество"));
		
	ИначеЕсли ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, "ИнЛицо") <> Неопределено Тогда
		
		Путь = "ИнЛицо";
		
		Если ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ПредОргПер") <> Неопределено Тогда
			
			Путь = Путь + ".ПредОргПер";
			
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Должность",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".Должность"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ИныеСведения",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ИныеСвед"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.НаименованиеОрганизации",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".НаимОргПер"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ДоверенностьНаОтгрузку",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ОснДоверОргПер"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ОснованиеПолномочий",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ОснПолнПредПер"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Фамилия"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Имя",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Имя"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Отчество"));
			
		ИначеЕсли ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФЛПер") <> Неопределено Тогда
			
			Путь = Путь + ".ФЛПер";
			
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ИныеСведения",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ИныеСвед"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ДоверенностьНаОтгрузку",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ОснДоверФЛ"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Фамилия"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Имя"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Отчество"));
				
		ИначеЕсли ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФЛ") <> Неопределено Тогда
			
			Путь = Путь + ".ФЛ";
			
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ИныеСведения",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ИныеСвед"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ДоверенностьНаОтгрузку",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ОснДоверФЛПер"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Фамилия"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Имя"));
				
			ЗаполнитьРеквизитДерева(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество",
				ЗначениеСвойстваXDTO(ДанныеЛицаПередавшегоГруз, Путь + ".ФИО.Отчество"));
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьДанныеУчастникаПередачаТоваров(ДеревоДанных, СведенияОбУчастнике, ВидУчастника)
	
	Если СведенияОбУчастнике = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвОрг") <> Неопределено Тогда
		
		СведенияЮЛ = ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвОрг.СвЮЛ");
		Если СведенияЮЛ <> Неопределено Тогда
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации",
				ЗначениеСвойстваXDTO(СведенияЮЛ, "НаимОрг"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН",
				ЗначениеСвойстваXDTO(СведенияЮЛ, "ИННЮЛ"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП",
				ЗначениеСвойстваXDTO(СведенияЮЛ, "КПП"));
			
		КонецЕсли;
			
		СведенияИностраннаяОрганизация = ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвОрг.ИнОрг");
		Если СведенияИностраннаяОрганизация <> Неопределено Тогда
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.НаименованиеОрганизации",
				ЗначениеСвойстваXDTO(СведенияИностраннаяОрганизация, "НаимОрг"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.Страна",
				ЗначениеСвойстваXDTO(СведенияИностраннаяОрганизация, "Страна"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИностраннаяОрганизация.ИныеСведения",
				ЗначениеСвойстваXDTO(СведенияИностраннаяОрганизация, "ИныеСвед"));
			
		КонецЕсли;
			
	ИначеЕсли ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП") <> Неопределено Тогда
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ИННФЛ"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.СвидетельствоОГосРегистрации",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.СвГосРегИП"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИныеСведения",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ИныеСвед"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ФИО.Фамилия"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Имя",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ФИО.Имя"));
		
		ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвИП.ФИО.Отчество"));
		
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ИдСв.СвФЛ") <> Неопределено Тогда
		
		СведенияФЛ = СведенияОбУчастнике.ИдСв.СвФЛ;
		ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.ИНН",
			ЗначениеСвойстваXDTO(СведенияФЛ, "ИННФЛ"));
		
		ЗаполнитьРеквизитДерева(ДеревоДанных,ВидУчастника + ".ТипУчастника.ФЛ.Фамилия",
			ЗначениеСвойстваXDTO(СведенияФЛ, "ФИО.Фамилия"));
		
		ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя",
			ЗначениеСвойстваXDTO(СведенияФЛ, "ФИО.Имя"));
		
		ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество",
			ЗначениеСвойстваXDTO(СведенияФЛ, "ФИО.Отчество"));
	
	КонецЕсли;
	
	АдресУчастника = ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Адрес");
	Если АдресУчастника <> Неопределено Тогда
		
		КодСтраны = "";
		
		АдресРФ  = ЗначениеСвойстваXDTO(АдресУчастника, "АдрРФ");
		
		Если АдресРФ <> Неопределено Тогда
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.Индекс",
				ЗначениеСвойстваXDTO(АдресРФ, "Индекс"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.КодРегион",
				ЗначениеСвойстваXDTO(АдресРФ, "КодРегион"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.Район",
				ЗначениеСвойстваXDTO(АдресРФ, "Район"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.Город",
				ЗначениеСвойстваXDTO(АдресРФ, "Город"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.НаселПункт",
				ЗначениеСвойстваXDTO(АдресРФ, "НаселПункт"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.Улица",
				ЗначениеСвойстваXDTO(АдресРФ, "Улица"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.Дом",
				ЗначениеСвойстваXDTO(АдресРФ, "Дом"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.Корпус",
				ЗначениеСвойстваXDTO(АдресРФ, "Корпус"));
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Структурированный.Кварт",
				ЗначениеСвойстваXDTO(АдресРФ, "Кварт"));
			
		ИначеЕсли ЕстьСвойствоXDTO(АдресУчастника, "АдрИнф") Тогда
			
			ИнформацияОбАдресе = АдресУчастника.АдрИнф;
			КодСтраны = ИнформацияОбАдресе.КодСтр;
			
		ИначеЕсли ЕстьСвойствоXDTO(АдресУчастника, "АдрИно") Тогда
			
			ИнформацияОбАдресе = АдресУчастника.АдрИно;
			КодСтраны = ИнформацияОбАдресе.КодСтр;
			
		КонецЕсли;
		
		Если КодСтраны = "643" Тогда
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Произвольный",
				ЗначениеСвойстваXDTO(ИнформацияОбАдресе, "АдрТекст"));
			
		Иначе
			Если ИнформацияОбАдресе <> Неопределено Тогда
				
				ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Иностранный.КодСтраны",
					ЗначениеСвойстваXDTO(ИнформацияОбАдресе, "КодСтр"));
					
				ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Адрес.Иностранный.АдресТекст",
					ЗначениеСвойстваXDTO(ИнформацияОбАдресе, "АдрТекст"));
				
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Контакт") <> Неопределено Тогда
		
		ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Контакт.Телефон",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Контакт.Тлф"));
			
		ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".Контакт.ЭлектроннаяПочта",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "Контакт.ЭлПочта"));
		
	КонецЕсли;
	
	Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв") <> Неопределено Тогда
		
		ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".БанковскийСчет.НомерСчета",
			ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.НомерСчета"));
		
		Если ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.СвБанк") <> Неопределено Тогда
			
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".БанковскийСчет.НаимБанк",
				ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.СвБанк.НаимБанк"));
		
			ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".БанковскийСчет.БИК",
				ЗначениеСвойстваXDTO(СведенияОбУчастнике, "БанкРекв.СвБанк.БИК"));
			
			КонецЕсли;
			
	КонецЕсли;
	
	ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".КодОКПО",
		ЗначениеСвойстваXDTO(СведенияОбУчастнике, "ОКПО"));
	
	ЗаполнитьРеквизитДерева(ДеревоДанных, ВидУчастника + ".СтруктурноеПодразделение",
		ЗначениеСвойстваXDTO(СведенияОбУчастнике, "СтруктПодр"));

КонецПроцедуры

Процедура ПоместитьДопДанныеВДеревоЭД(ДеревоЭД, ДеревоДопДанных)
	
	ДопДанныеШапки = ДеревоДопДанных.Строки.Найти("Шапка", "ЗначениеРеквизита");
	
	Если ДопДанныеШапки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого СтрокаДереваШапки Из ДопДанныеШапки.Строки Цикл
		Если СтрокаДереваШапки.ЮридическиЗначимый Тогда
		
			ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоЭД,
				Новый Структура(СтрокаВКлючСтруктуры(СтрокаДереваШапки.ИмяРеквизита), СтрокаДереваШапки.ЗначениеРеквизита), Истина);
			
		Иначе
				
			ЭлектронноеВзаимодействие.ДобавитьДопДанныеВДерево(ДеревоЭД,
				Новый Структура(СтрокаВКлючСтруктуры(СтрокаДереваШапки.ИмяРеквизита), СтрокаДереваШапки.ЗначениеРеквизита), Ложь);
			
		КонецЕсли;
		
		// Если в доп. данных есть реквизиты договора, они помещаются в дерево документа.
		Если ВРег(СтрокаДереваШапки.ИмяРеквизита) = ВРег("ДокументСделкиНаименование")
			Или ВРег(СтрокаДереваШапки.ИмяРеквизита) = ВРег("ДокументСделкиНомер")
			Или ВРег(СтрокаДереваШапки.ИмяРеквизита) = ВРег("ДокументСделкиДата") Тогда
			
			ЗаполнитьРеквизитДерева(ДеревоЭД, СтрокаДереваШапки.ИмяРеквизита, СтрокаДереваШапки.ЗначениеРеквизита);
			
		КонецЕсли;
		
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьСведенияОЛицеПередавшемТовар(ДеревоДанных, СведенияОПередаче, ПространствоИменСхемы, Ошибки)
	
	Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары")) Тогда
		
		СведенияГрузОтпустил = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3.СвЛицОтпГруз", ПространствоИменСхемы);
		Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары") = "РаботникОрганизацииПродавца" Тогда
			
			РаботникОрганизации = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3.СвЛицОтпГруз.РабОргПрод", ПространствоИменСхемы);
			
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Должность");
			ЗаполнитьСвойствоXDTO(РаботникОрганизации, "Должность", Реквизит, Истина, Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ИныеСведения");
			ЗаполнитьСвойствоXDTO(РаботникОрганизации, "ИныеСвед", Реквизит, , Ошибки);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.ОснованиеПолномочий");
			ЗаполнитьСвойствоXDTO(РаботникОрганизации, "ОснПолн", Реквизит, , Ошибки);
			
			ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
			Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Фамилия");
			ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
			Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Имя");
			ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
			Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СведенияОЛицеПередавшемТовары.РаботникОрганизацииПродавца.Отчество");
			ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
			ЗаполнитьСвойствоXDTO(РаботникОрганизации, "ФИО", ФИО,  , Ошибки);
			
			ЗаполнитьСвойствоXDTO(СведенияГрузОтпустил, "РабОргПрод", РаботникОрганизации, , Ошибки);
			
		ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары") = "ИноеЛицо" Тогда
			
			ИноеЛицо = ПолучитьОбъектТипаCML("Файл.Документ.СодФХЖ3.СвЛицОтпГруз.ИнЛицо", ПространствоИменСхемы);
			Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ПредставительОрганизации" Тогда
				ПредставительОрганизации = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ПредОргПер", ПространствоИменСхемы);
				
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Должность");
				ЗаполнитьСвойствоXDTO(ПредставительОрганизации, "Должность", Реквизит, Истина, Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ИныеСведения");
				ЗаполнитьСвойствоXDTO(ПредставительОрганизации, "ИныеСвед", Реквизит, , Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.НаименованиеОрганизации");
				ЗаполнитьСвойствоXDTO(ПредставительОрганизации, "НаимОргПер", Реквизит, Истина, Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ДоверенностьНаОтгрузку");
				ЗаполнитьСвойствоXDTO(ПредставительОрганизации, "ОснДоверОргПер", Реквизит, , Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.ОснованиеПолномочий");
				ЗаполнитьСвойствоXDTO(ПредставительОрганизации, "ОснПолнПредПер", Реквизит, , Ошибки);
				
				ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
				Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Фамилия");
				ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
				Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Имя");
				ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
				Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ПредставительОрганизации.Отчество");
				ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
				ЗаполнитьСвойствоXDTO(ПредставительОрганизации, "ФИО", ФИО,  , Ошибки);
				
				ЗаполнитьСвойствоXDTO(ИноеЛицо, "ПредОргПер", ПредставительОрганизации, , Ошибки);
			ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОЛицеПередавшемТовары.ИноеЛицо") = "ФЛ" Тогда
				
				ФизЛицоПередавшееГруз = ПолучитьОбъектТипаCML("Файл.Документ.СвПродПер.СвПер.СвЛицПер.ИнЛицо.ФЛПер", ПространствоИменСхемы);
				
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ИныеСведения");
				ЗаполнитьСвойствоXDTO(ФизЛицоПередавшееГруз, "ИныеСвед", Реквизит, , Ошибки);
				Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.ДоверенностьНаОтгрузку");
				ЗаполнитьСвойствоXDTO(ФизЛицоПередавшееГруз, "ОснДоверФЛ", Реквизит, , Ошибки);
				
				ФИО = ПолучитьОбъектТипаCML("ФИОТип", ПространствоИменСхемы);
				Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Фамилия");
				ЗаполнитьСвойствоXDTO(ФИО, "Фамилия", Фамилия, Истина, Ошибки);
				Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Имя");
				ЗаполнитьСвойствоXDTO(ФИО, "Имя", Имя, Истина, Ошибки);
				Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
				"СведенияОЛицеПередавшемТовары.ИноеЛицо.ФЛ.Отчество");
				ЗаполнитьСвойствоXDTO(ФИО, "Отчество", Отчество, , Ошибки);
				ЗаполнитьСвойствоXDTO(ФизЛицоПередавшееГруз, "ФИО", ФИО,  , Ошибки);
				
				ЗаполнитьСвойствоXDTO(ИноеЛицо, "ФЛПер", ФизЛицоПередавшееГруз, , Ошибки);
				
			КонецЕсли;
			ЗаполнитьСвойствоXDTO(СведенияГрузОтпустил, "ИнЛицо", ИноеЛицо, , Ошибки);
			
		КонецЕсли;
		
		ЗаполнитьСвойствоXDTO(СведенияОПередаче, "СвЛицОтпГруз", СведенияГрузОтпустил, , Ошибки);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПрочитатьПодписанта(НовыйЭД, Документ)
	
	Подписанты = ЗначениеСвойстваXDTO(Документ, "Подписант",, Истина);
	
	Если Подписанты = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеПодписанта = Новый Структура("Должность, ФИО, ФИОПБОЮЛ, НаименованиеОрганизации");
	ФИО              = Новый Структура("Фамилия, Имя, Отчество");
	
	Для Каждого ТекПодписант Из Подписанты Цикл
		
		НаименованиеОрганизации = "";
		
		Если ЗначениеСвойстваXDTO(ТекПодписант, "ЮЛ") <> Неопределено Тогда
			
			ФИО.Фамилия  = ЗначениеСвойстваXDTO(ТекПодписант, "ЮЛ.ФИО.Фамилия",  "Строка");
			ФИО.Имя      = ЗначениеСвойстваXDTO(ТекПодписант, "ЮЛ.ФИО.Имя",      "Строка");
			ФИО.Отчество = ЗначениеСвойстваXDTO(ТекПодписант, "ЮЛ.ФИО.Отчество", "Строка");
			Должность    = ЗначениеСвойстваXDTO(ТекПодписант, "ЮЛ.Должн",        "Строка");
			
			ФИОРуководителя = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			ФИОПБОЮЛ = "";

		ИначеЕсли ЗначениеСвойстваXDTO(ТекПодписант, "ФЛ") <> Неопределено Тогда
			
			ФИО.Фамилия  = ЗначениеСвойстваXDTO(ТекПодписант, "ФЛ.ФИО.Фамилия",  "Строка");
			ФИО.Имя      = ЗначениеСвойстваXDTO(ТекПодписант, "ФЛ.ФИО.Имя",      "Строка");
			ФИО.Отчество = ЗначениеСвойстваXDTO(ТекПодписант, "ФЛ.ФИО.Отчество", "Строка");
			
			ФИОПБОЮЛ = "";
			Если Не (ФИО.Фамилия = "-" И ФИО.Имя = "-") Тогда
				ФИОПБОЮЛ = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			КонецЕсли;
			
			Должность       = "";
			ФИОРуководителя = "";
			
		ИначеЕсли ЗначениеСвойстваXDTO(ТекПодписант, "ИП") <> Неопределено Тогда
			
			ФИО.Фамилия  = ЗначениеСвойстваXDTO(ТекПодписант, "ИП.ФИО.Фамилия",  "Строка");
			ФИО.Имя      = ЗначениеСвойстваXDTO(ТекПодписант, "ИП.ФИО.Имя",      "Строка");
			ФИО.Отчество = ЗначениеСвойстваXDTO(ТекПодписант, "ИП.ФИО.Отчество", "Строка");
			ФИОПБОЮЛ     = ФизическиеЛицаКлиентСервер.ФамилияИнициалы(ФИО);
			
			Должность       = "";
			ФИОРуководителя = "";
		
		КонецЕсли;
		
		ДанныеПодписанта.Должность = Должность;
		ДанныеПодписанта.ФИО       = ФИОРуководителя;
		ДанныеПодписанта.ФИОПБОЮЛ  = ФИОПБОЮЛ;
		ДанныеПодписанта.НаименованиеОрганизации = НаименованиеОрганизации;
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьРеквизитШапкиОбъекта(НовыйЭД, "Подписант", ДанныеПодписанта);
		
		Прервать;
		
	КонецЦикла;
	
КонецПроцедуры

// Возвращает свойства владельца сертификата криптографии с учетом их состава (ЮЛ,ИП,ФЛ).
// Часть функциональности служебного метода библиотеки стандартных подсистем.
//
// Параметры:
//   Сертификат - СертификатКриптографии - для которого нужно вернуть свойства субъекта.
//
// Возвращаемое значение:
//  Структура - возвращаемое значение, со свойствами:
//     * ОбщееИмя         - Строка(64) - извлекается из поля CN.
//                          ЮЛ: В зависимости от типа конечного владельца СКПЭП
//                              - наименование организации;
//                              - название автоматизированной системы;
//                              - другое отображаемое имя по требованиям информационной системы.
//                          ФЛ: ФИО.
//                        - Неопределено - нужное свойство сертификата не найдено.
//
//     * Должность        - Строка(64) - извлекается из поля T.
//                          ЮЛ: В случае выпуска СКПЭП на должностное лицо - его должность.
//                        - Неопределено - нужное свойство сертификата не найдено.
//
//     * ИНН              - Строка(12) - извлекается из поля INN.
//                          ФЛ: ИНН.
//                          ИП: ИНН.
//                          ЮЛ: Не обязательно, но может быть заполнен для целей взаимодействия с ФНС.
//                        - Неопределено - нужное свойство сертификата не найдено.
//
//     * Фамилия          - Строка(64) - извлекается из поля SN, если заполнено.
//                        - Неопределено - нужное свойство сертификата не найдено.
//
//     * Имя              - Строка(64) - извлекается из поля GN, если заполнено.
//                        - Неопределено - нужное свойство сертификата не найдено.
//
//     * Отчество         - Строка(64) - извлекается из поля GN, если заполнено.
//                        - Неопределено - нужное свойство сертификата не найдено.
//
Функция СвойстваВладельцаСертификата(Сертификат)
	
	Субъект = Сертификат.Субъект;
	
	Свойства = Новый Структура;
	Свойства.Вставить("ОбщееИмя");
	Свойства.Вставить("Организация");
	Свойства.Вставить("Должность");
	Свойства.Вставить("ИНН");
	Свойства.Вставить("Фамилия");
	Свойства.Вставить("Имя");
	Свойства.Вставить("Отчество");
	
	Если Субъект.Свойство("CN") Тогда
		Свойства.ОбщееИмя = ПодготовитьСтроку(Субъект.CN);
	КонецЕсли;
	
	Если Субъект.Свойство("O") Тогда
		Свойства.Организация = ПодготовитьСтроку(Субъект.O);
	КонецЕсли;
	
	Если Субъект.Свойство("INN") Тогда
		Свойства.ИНН = ПодготовитьСтроку(Субъект.INN);
		
	ИначеЕсли Субъект.Свойство("OID1_2_643_3_131_1_1")Тогда
		Свойства.ИНН = ПодготовитьСтроку(Субъект.OID1_2_643_3_131_1_1);
	КонецЕсли;
	
	Если Субъект.Свойство("SN") Тогда // Наличие фамилии (обычно для должностного лица).
		
		// Извлечение ФИО из поля SN и GN.
		Свойства.Фамилия = ПодготовитьСтроку(Субъект.SN);
		
		Если Субъект.Свойство("GN") Тогда
			GivenName = ПодготовитьСтроку(Субъект.GN);
			Позиция = СтрНайти(GivenName, " ");
			Если Позиция = 0 Тогда
				Свойства.Имя = GivenName;
			Иначе
				Свойства.Имя = Лев(GivenName, Позиция - 1);
				Свойства.Отчество = ПодготовитьСтроку(Сред(GivenName, Позиция + 1));
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли Субъект.Свойство("OGRNIP")            // Признак индивидуального предпринимателя.
	      Или Субъект.Свойство("OID1_2_643_100_5")  // Признак индивидуального предпринимателя.
	      Или Субъект.Свойство("T")                 // Признак должностного лица.
	      Или Субъект.Свойство("OID2_5_4_12")       // Признак должностного лица.
	      Или Субъект.Свойство("SNILS")                                     // Признак физического лица.
	      Или Субъект.Свойство("OID1_2_643_100_3")                          // Признак физического лица.
	      Или ЭтоИННФизЛица(Субъект.Свойство("INN"))                        // Признак физического лица.
	      Или ЭтоИННФизЛица(Субъект.Свойство("OID1_2_643_3_131_1_1")) Тогда // Признак физического лица.
		
		Если Свойства.ОбщееИмя <> Свойства.Организация
		   И Не (Субъект.Свойство("T")           И Свойства.ОбщееИмя = ПодготовитьСтроку(Субъект.T))
		   И Не (Субъект.Свойство("OID2_5_4_12") И Свойства.ОбщееИмя = ПодготовитьСтроку(Субъект.OID2_5_4_12)) Тогда
			
			// Извлечение ФИО из поля CN.
			Массив = СтрРазделить(Свойства.ОбщееИмя, " ", Ложь);
			
			Если Массив.Количество() < 4 Тогда
				Если Массив.Количество() > 0 Тогда
					Свойства.Фамилия = СокрЛП(Массив[0]);
				КонецЕсли;
				Если Массив.Количество() > 1 Тогда
					Свойства.Имя = СокрЛП(Массив[1]);
				КонецЕсли;
				Если Массив.Количество() > 2 Тогда
					Свойства.Отчество = СокрЛП(Массив[2]);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Свойства.Фамилия)
	 Или ЗначениеЗаполнено(Свойства.Имя) Тогда
		
		Если Субъект.Свойство("T") Тогда
			Свойства.Должность = ПодготовитьСтроку(Субъект.T);
			
		ИначеЕсли Субъект.Свойство("OID2_5_4_12") Тогда
			Свойства.Должность = ПодготовитьСтроку(Субъект.OID2_5_4_12);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Свойства;
	
КонецФункции

Функция ЭтоИННФизЛица(ИНН)
	
	Если СтрДлина(ИНН) <> 12 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Для НомерСимвола = 1 По 12 Цикл
		Если СтрНайти("0123456789", Сред(ИНН,НомерСимвола,1)) = 0 Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Если СтрНачинаетсяС(ИНН, "00") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция ПодготовитьСтроку(СтрокаИзСертификата)
	
	Возврат СокрЛП(ОбщегоНазначенияКлиентСервер.ЗаменитьНедопустимыеСимволыXML(СтрокаИзСертификата));
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Проверка дерева ЭД (для проверки выполнения определенных условий на заполненность реквизитов).

Процедура ПроверитьИнформациюПродавца(ДеревоДанных, СтруктураЭД, Ошибки)

	ФункцияУПД = "";
	СтруктураЭД.Свойство("Функция", ФункцияУПД);
	НайденнаяСтрокаРеквизита = Неопределено;
	
	// КодОКВ - код валюты должен быть в Общероссийском классификаторе валют.
	ПроверитьКодВалютыФНС(ДеревоДанных, СтруктураЭД, Ошибки);
	
	// НомИспрСчФ и ДатаИспрСчФ - данные исправительного счета-фактуры должны быть либо указаны оба, либо не указаны
	// вообще. Также НомИспрСчФ должен быть больше 0.
	ПроверитьДанныеИсправленияФНС(ДеревоДанных, Ошибки, СтруктураЭД, "НомерИсправления", "ДатаИсправления");
	
	// ДатаОсн - обязателен, если в НаимОсн, отличном от "Отсутствует".
	ПроверитьОснованиеФНС(ДеревоДанных, Ошибки, СтруктураЭД, "ОснованиеОтгрузкиТоваров");
	
	// Адрес - обязателен при функциях СЧФ и СЧФДОП.
	АдресОбязателен = (ФункцияУПД = "СЧФ" ИЛИ ФункцияУПД = "СЧФДОП");
	
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОПеревозчике", Ошибки, СтруктураЭД, АдресОбязателен);
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОПродавце", Ошибки, СтруктураЭД, АдресОбязателен);
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОГрузоотправителе.Грузоотправитель", Ошибки, СтруктураЭД, АдресОбязателен);
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОГрузополучателе", Ошибки, СтруктураЭД, АдресОбязателен);
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОПокупателе", Ошибки, СтруктураЭД, АдресОбязателен);
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОКомиссионере", Ошибки, СтруктураЭД, АдресОбязателен);
	
	// Сведения о товарах.
	НомерСтроки = 1;
	ПереченьПризнаковТовара = ВозможныеЗначенияПризнакаТовараУПД();
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		ЕдиницаИзмеренияКодСтрокаДерева = Неопределено;
		ЕдиницаИзмеренияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКод",, ЕдиницаИзмеренияКодСтрокаДерева);
			
		Если ЗначениеЗаполнено(ЕдиницаИзмеренияКод) Тогда
			КодЕдиницыИзмеренияНулевой = ТолькоСимволыВСтроке(ЕдиницаИзмеренияКод, "0");
		
			ПроверитьДанныеЕдиницыИзмеренияФНС(ЕдиницаИзмеренияКод, ЕдиницаИзмеренияКодСтрокаДерева, Ошибки, СтруктураЭД, НомерСтроки,
				КодЕдиницыИзмеренияНулевой);
			
			// КолТов - количество обязательно при Функция=СЧФДОП или Функция=ДОП и при наличии ОКЕИ_Тов.
			КоличествоСтрокаДерева = Неопределено;
			Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
				"СведенияОТоварах.НомерСтроки.Количество",, КоличествоСтрокаДерева);
			Если (ФункцияУПД = "СЧФДОП" ИЛИ ФункцияУПД = "ДОП") И НЕ КодЕдиницыИзмеренияНулевой
				И Не ЗначениеЗаполнено(Количество) Тогда
				
				ТекстОшибки = НСтр("ru = 'значение должно быть заполнено, если указана единица измерения и электронный документ содержит данные первичного документа.'");
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, КоличествоСтрокаДерева, ТекстОшибки,, НомерСтроки);
			КонецЕсли;
			
			// НаимЕдИзм - наименование единицы измерение обязательно, если указан ее код.
			ПроверитьНаименованиеЕдиницыИзмеренияФНС(Товар, Ошибки, СтруктураЭД, НомерСтроки, КодЕдиницыИзмеренияНулевой);
		КонецЕсли;
		
		// НалСт - ставка НДС должна содержать значение из определенного перечня.
		ПроверитьСтавкуНДС_УПДУКД(Товар, Ошибки, СтруктураЭД, НомерСтроки, "НалоговаяСтавка");
		
		// КодПроисх - код страны должен быть в классификаторе стран мира.
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации");
		Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
			СтрокиТД = Товар.Строки.Найти("СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации", "ПолныйПуть", Истина);
			Для Каждого СтрокаТД Из СтрокиТД.Строки Цикл
				ПроверитьКодСтраныФНС(СтрокаТД, Ошибки, СтруктураЭД, 
					"СведенияОТоварах.НомерСтроки.СведенияОТаможеннойДекларации.НомерСтроки.СтранаПроисхожденияКод", НомерСтроки);
			КонецЦикла;
		КонецЕсли;
		
		// ПрТовРаб - признак товара должен принадлежать определенному перечню
		ПризнакТовараСтрокаДерева = Неопределено;
		ПризнакТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"СведенияОТоварах.НомерСтроки.Признак",, ПризнакТовараСтрокаДерева);
		Если ЗначениеЗаполнено(ПризнакТовара) Тогда
			Если ПереченьПризнаковТовара.Найти(ПризнакТовара) = Неопределено Тогда
				ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеверноЗаполненногоЗначенияДерева();
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, ПризнакТовараСтрокаДерева,
					ТекстОшибки,, НомерСтроки);
			КонецЕсли;
		КонецЕсли;
		
		// СтТовБезНДС И СтТовБезНДСВсего - обязателен всегда, кроме авансовых счетов-фактур.
		Если ФункцияУПД = "СЧФ" ИЛИ ФункцияУПД = "СЧФДОП" Тогда
			СтоимостьБезНДССтрокаДерева = Неопределено;
			
			ВидСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидСчетаФактуры");
			СтоимостьБезНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
				"СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога",, СтоимостьБезНДССтрокаДерева);
			
			Если Не (ЗначениеЗаполнено(ВидСчетаФактуры) И ВидСчетаФактуры = "Авансовый") И Не ЗначениеЗаполнено(СтоимостьБезНДС) Тогда
				ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеверноЗаполненногоЗначенияДерева();
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, СтоимостьБезНДССтрокаДерева, ТекстОшибки,, НомерСтроки);
			КонецЕсли;
		КонецЕсли;
					
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;
	
	// Всего к оплате.
	// СтТовБезНДСВсего - обязателен всегда, кроме авансовых счетов-фактур.
	Если ФункцияУПД = "СЧФ" ИЛИ ФункцияУПД = "СЧФДОП" Тогда
		СтоимостьБезНДСВсегоСтрокаДерева = Неопределено;
		
		ВидСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидСчетаФактуры");
		СтоимостьБезНДСВсего = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"ВсегоКОплате.ВсегоСтоимостьТоваровБезНалога",, СтоимостьБезНДСВсегоСтрокаДерева);
		
		Если Не (ЗначениеЗаполнено(ВидСчетаФактуры) И ВидСчетаФактуры = "Авансовый") И Не ЗначениеЗаполнено(СтоимостьБезНДСВсего) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеверноЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, СтоимостьБезНДСВсегоСтрокаДерева, ТекстОшибки);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Функция ТолькоСимволыВСтроке(Знач ИсходнаяСтрока, СимволДляПроверки, УчитыватьПробелы = Ложь)

	ИсходнаяСтрока = СтрЗаменить(ИсходнаяСтрока, СимволДляПроверки, "");
	
	Возврат УчитыватьПробелы И ИсходнаяСтрока = "" ИЛИ НЕ УчитыватьПробелы И ПустаяСтрока(ИсходнаяСтрока);

КонецФункции 

Функция ИсключитьЗагруженныеПакетыЭД(ТаблицаИДДокументов)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаИДДокументов.ИДДокументооборота КАК ИДДокументооборота,
	|	ТаблицаИДДокументов.КодТранзакции КАК КодТранзакции,
	|	ТаблицаИДДокументов.ИДДокумента КАК ИДДокумента,
	|	ТаблицаИДДокументов.Приоритет КАК Приоритет
	|ПОМЕСТИТЬ ВТ_ТаблицаИДДокументов
	|ИЗ
	|	&ТаблицаИДДокументов КАК ТаблицаИДДокументов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ИДДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ТаблицаИДДокументов.ИДДокументооборота КАК ИДДокументооборота,
	|	ВТ_ТаблицаИДДокументов.КодТранзакции КАК КодТранзакции,
	|	ВТ_ТаблицаИДДокументов.ИДДокумента КАК ИДДокумента,
	|	ВТ_ТаблицаИДДокументов.Приоритет КАК Приоритет
	|ИЗ
	|	ВТ_ТаблицаИДДокументов КАК ВТ_ТаблицаИДДокументов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПакетЭД КАК ПакетЭД
	|		ПО ВТ_ТаблицаИДДокументов.ИДДокумента = ПакетЭД.ВнешнийУИД
	|			И (ПакетЭД.Направление = ЗНАЧЕНИЕ(Перечисление.НаправленияЭД.Входящий))
	|ГДЕ
	|	ПакетЭД.Ссылка ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("ТаблицаИДДокументов", ТаблицаИДДокументов);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция СодержаниеОперацииПередачаТоваровПокупатель()
	Возврат "Перечисленные в документе ценности приняты без претензий";
КонецФункции

Функция СодержаниеОперацииПередачаРабот()
	Возврат "Результаты работ переданы (услуги оказаны)";
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Прочее

Функция ИдентификаторТовараПоСтроке(Знач СтрокаТовара, Знач МаксимальнаяДлина = Неопределено)
	
	Если Не ЗначениеЗаполнено(МаксимальнаяДлина) Тогда
		МаксимальнаяДлина = 110;
	КонецЕсли;
	
	Идентификатор = СтрокаТовара;
	Идентификатор = ВРег(Идентификатор);
	Идентификатор = СтрЗаменить(Идентификатор, " ", "");
	
	Длина = СтрДлина(Идентификатор);
	
	Если Длина > МаксимальнаяДлина Тогда
		
		Хэширование = Новый ХешированиеДанных(ХешФункция.MD5);
		Хэширование.Добавить(Идентификатор);
		
		ХешСтрока = Строка(Хэширование.ХешСумма);
		ХешСтрока = СтрЗаменить(ХешСтрока, " ", "");
		
		ДлинаХешСтроки = СтрДлина(ХешСтрока);
		
		Идентификатор = Лев(Идентификатор, МаксимальнаяДлина - ДлинаХешСтроки) + ХешСтрока;
		
	КонецЕсли;
	
	Возврат Идентификатор;
	
КонецФункции

// Возвращает строку, которую можно использовать в качестве ключа структуры.
// Возвращаемое значение получается из исходной строки путем замены недопустимых символов на символ "_".
//
// Параметры:
//  Значение - Строка - строка, которую нужно преобразовать в ключ структуры.
//
// Возвращаемое значение:
//  Строка - строка для использования в качестве ключа структуры.
//
Функция СтрокаВКлючСтруктуры(Знач Значение) 
	
	Если ЭтоДопустимыйКлючСтруктуры(Значение) Тогда
		Возврат Значение;
	КонецЕсли;
	
	Результат = "";
	
	Для НомерСимвола = 1 По СтрДлина(Значение) Цикл
		
		ТекущийСимвол = Сред(Значение, НомерСимвола, 1);
		
		Если Не ЗначениеЗаполнено(ТекущийСимвол) Тогда
			Результат = Результат + "_";
		ИначеЕсли ЭтоДопустимыйКлючСтруктуры(ТекущийСимвол) Тогда
			Результат = Результат + ТекущийСимвол;
		ИначеЕсли ЭтоДопустимыйКлючСтруктуры("_" + ТекущийСимвол) Тогда
			Результат = Результат + ?(НомерСимвола = 1, "_", "") + ТекущийСимвол;
		Иначе
			Результат = Результат + "_";
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ЭтоДопустимыйКлючСтруктуры(Знач Ключ)
	
	Попытка
		НоваяСтруктура = Новый Структура(Ключ);
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	Возврат ЗначениеЗаполнено(НоваяСтруктура);
	
КонецФункции

Функция ДанныеУчастникаСделкиУПД_УКД(ВидУчастника, ДеревоДанных, Знач Свойства = "")
	
	// Если свойства не указаны, получим все возможные.
	Если Не ЗначениеЗаполнено(Свойства) Тогда
		Свойства = "Представление, ИНН_КПП, ИНН, КПП, Адрес";
	КонецЕсли;
	Результат = Новый Структура(Свойства);
	Для Каждого КлючИЗначение Из Результат Цикл
		Результат.Вставить(КлючИЗначение.Ключ, "");
	КонецЦикла;
	
	ТипУчастника = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника");
	
	// Получим представление.
	Если Результат.Свойство("Представление") Тогда
		Если ТипУчастника = "ЮЛ" Тогда
			
			Результат.Представление = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");			
		ИначеЕсли ТипУчастника = "ИП" Тогда
			
			Фамилия  = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия");
			Имя      = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Имя");
			Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество");
			
			Результат.Представление = НСтр("ru = 'ИП'") + " " + Фамилия + ?(ЗначениеЗаполнено(Имя), " " + Имя, "")
				+ ?(ЗначениеЗаполнено(Отчество), " " + Отчество, "");
		ИначеЕсли ТипУчастника = "ИЛ" Тогда
			
			Результат.Представление = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".ТипУчастника.ИЛ.НаименованиеОрганизации");
		КонецЕсли;
	КонецЕсли;
	
	// Получим ИНН/КПП.
	Если Результат.Свойство("ИНН_КПП") ИЛИ Результат.Свойство("ИНН") ИЛИ Результат.Свойство("КПП") Тогда
		ИНН = "";
		КПП = "";
		
		Если ТипУчастника = "ЮЛ" Тогда
			
			ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.ИНН");
			КПП = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ЮЛ.КПП");		
		ИначеЕсли ТипУчастника = "ИП" Тогда
			
			ИНН = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".ТипУчастника.ИП.ИНН");
		ИначеЕсли ТипУчастника = "ИЛ" Тогда
			
			// не используется.
		КонецЕсли;
		
		Если Результат.Свойство("ИНН_КПП") Тогда
			Результат.ИНН_КПП = "" + ИНН + ?(ЗначениеЗаполнено(КПП), "/" + КПП, "");
		КонецЕсли;
		
		Если Результат.Свойство("ИНН") Тогда
			Результат.ИНН = ИНН;
		КонецЕсли;
		
		Если Результат.Свойство("КПП") Тогда
			Результат.КПП = КПП;
		КонецЕсли;
	КонецЕсли;
	
	// Получим адрес.
	Если Результат.Свойство("Адрес") Тогда
		ТипАдреса = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес");
		
		Если ТипАдреса = "АдресРФ" Тогда
			СтруктураАдресаПоставщика = Новый Структура();
			
			СтруктураАдресаПоставщика.Вставить("Индекс",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.Индекс"));
			СтруктураАдресаПоставщика.Вставить("КодРегион",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.КодРегиона"));
			СтруктураАдресаПоставщика.Вставить("Район",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.Район"));
			СтруктураАдресаПоставщика.Вставить("Город",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.Город"));
			СтруктураАдресаПоставщика.Вставить("НаселПункт",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.НаселенныйПункт"));
			СтруктураАдресаПоставщика.Вставить("Улица",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.Улица"));
			СтруктураАдресаПоставщика.Вставить("Дом",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.Дом"));
			СтруктураАдресаПоставщика.Вставить("Корпус",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.Корпус"));
			СтруктураАдресаПоставщика.Вставить("Кварт",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес.АдресРФ.Квартира"));
			
			Результат.Адрес = СобратьАдрес(СтруктураАдресаПоставщика);
			
		ИначеЕсли ТипАдреса = "АдресИнформация" Тогда
			
			КодСтр = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".Адрес.АдресИнформация.КодСтраны");
			АдрТекст = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".Адрес.АдресИнформация.АдресТекст");
			
			Результат.Адрес = ?(КодСтр = "643", "", КодСтр + ", ") + АдрТекст;
			
		ИначеЕсли ТипАдреса = "КодГАР" Тогда
			
			Результат.Адрес = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				ДеревоДанных, ВидУчастника + ".Адрес.КодГАР");
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

Процедура ПроверитьНаименованиеЕдиницыИзмеренияФНС(ДанныеТовара, Ошибки, СтруктураЭД, НомерСтроки, 
	КодЕдиницыИзмеренияНулевой, ИмяЕдиницыИзмерения = "СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияНаименование")
	
	Если КодЕдиницыИзмеренияНулевой Тогда
		ЕдиницаИзмеренияНаименованиеСтрокаДерева = Неопределено;
		ЕдиницаИзмеренияНаименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДанныеТовара,
			ИмяЕдиницыИзмерения,, ЕдиницаИзмеренияНаименованиеСтрокаДерева);
		Если Не ЗначениеЗаполнено(ЕдиницаИзмеренияНаименование) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки,
				ЕдиницаИзмеренияНаименованиеСтрокаДерева, ТекстОшибки,, НомерСтроки);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Функция ВозможныеЗначенияПризнакаТовараУПД()

	Результат = Новый Массив;
	Результат.Добавить("1");
	Результат.Добавить("2");
	Результат.Добавить("3");
	Результат.Добавить("4");
	Результат.Добавить("5");
	
	Возврат Новый ФиксированныйМассив(Результат);

КонецФункции

Функция КодыСтранДопустимыеКромеКлассификатора()

	Результат = Новый Массив;
	Результат.Добавить("980");
	Результат.Добавить("981");
	
	Возврат Новый ФиксированныйМассив(Результат);

КонецФункции

Процедура ПроверитьИнформациюПродавцаУКД(ДеревоДанных, СтруктураЭД, Ошибки)

	ФункцияУПД = "";
	СтруктураЭД.Свойство("Функция", ФункцияУПД);
	НайденнаяСтрокаРеквизита = Неопределено;
	
	// КодОКВ - код валюты должен быть в Общероссийском классификаторе валют.
	ПроверитьКодВалютыФНС(ДеревоДанных, СтруктураЭД, Ошибки);

	// НомИспрСчФ и ДатаИспрКСчФ - данные исправительного счета-фактуры должны быть либо указаны оба, либо не указаны
	// вообще. Также НомИспрСчФ должен быть больше 0.
	ПроверитьДанныеИсправленияФНС(ДеревоДанных, Ошибки, СтруктураЭД, "НомерИсправления", "ДатаИсправления");
	
	// НомИспрКСчФ и ДатаИспрСчФ - данные исправительного счета-фактуры должны быть либо указаны оба, либо не указаны
	// вообще. Также НомИспрСчФ должен быть больше 0.
	ПроверитьДанныеИсправленияФНС(ДеревоДанных, Ошибки, СтруктураЭД, "НомерИсправленияИсходногоДокумента",
		"ДатаИсправленияИсходногоДокумента");
	
	// ДатаОсн - обязателен, если в НаимОсн, отличном от "Отсутствует".
	ПроверитьОснованиеФНС(ДеревоДанных, Ошибки, СтруктураЭД, "ОснованиеКорректировки");
	
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОПродавце", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОПокупателе", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, "СведенияОКомиссионере", Ошибки, СтруктураЭД);
	
	// Сведения о товарах.
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
	НомерСтроки = 1;
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		// ОКЕИ_ТовПосле - проверка кода единицы измерения.
		ЕдиницаИзмеренияКодСтрокаДерева = Неопределено;
		ЕдиницаИзмеренияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКод",, ЕдиницаИзмеренияКодСтрокаДерева);
			
		Если ЗначениеЗаполнено(ЕдиницаИзмеренияКод) Тогда
			КодЕдиницыИзмеренияНулевой = ТолькоСимволыВСтроке(ЕдиницаИзмеренияКод, "0");
			ПроверитьДанныеЕдиницыИзмеренияФНС(ЕдиницаИзмеренияКод, ЕдиницаИзмеренияКодСтрокаДерева, Ошибки, СтруктураЭД, НомерСтроки,
				КодЕдиницыИзмеренияНулевой);
		КонецЕсли;
		
		// ОКЕИ_ТовДо - проверка кода единицы измерения до корректировки.
		ЕдиницаИзмеренияКодСтрокаДерева = Неопределено;
		ЕдиницаИзмеренияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"СведенияОТоварах.НомерСтроки.ЕдиницаИзмеренияКодДоКорректировки",, ЕдиницаИзмеренияКодСтрокаДерева);
			
		Если ЗначениеЗаполнено(ЕдиницаИзмеренияКод) Тогда
			КодЕдиницыИзмеренияНулевой = ТолькоСимволыВСтроке(ЕдиницаИзмеренияКод, "0");
			ПроверитьДанныеЕдиницыИзмеренияФНС(ЕдиницаИзмеренияКод, ЕдиницаИзмеренияКодСтрокаДерева, Ошибки, СтруктураЭД, НомерСтроки,
				КодЕдиницыИзмеренияНулевой);
		КонецЕсли;
		
		// НалСтДо - ставка НДС должна содержать значение из определенного перечня
		ПроверитьСтавкуНДС_УПДУКД(Товар, Ошибки, СтруктураЭД, НомерСтроки, "НалоговаяСтавкаДоКорректировки");
		
		// НалСтПосле - ставка НДС должна содержать значение из определенного перечня
		ПроверитьСтавкуНДС_УПДУКД(Товар, Ошибки, СтруктураЭД, НомерСтроки, "НалоговаяСтавка");
					
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;
	
	// СтоимУвел, СтоимУм - должна быть указана хотя бы одна.
	ПроверитьНаличиеУвеличенияУменьшенияВУКД(ДеревоДанных, Ошибки, СтруктураЭД, НомерСтроки,
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУвеличение",
		"ВсегоИзмененияСтоимости.ВсегоСтоимостьТоваровБезНалогаУменьшение",
		НСтр("ru = 'Всего сумма без НДС'"));
	
КонецПроцедуры

Процедура ПроверитьКодВалютыФНС(ДеревоДанных, СтруктураЭД, Ошибки)
	
	НайденнаяСтрокаРеквизита = Неопределено;
	
	// КодОКВ - код валюты должен быть в Общероссийском классификаторе валют.
	КодВалюты = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод",,
		НайденнаяСтрокаРеквизита);
	Если ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеВалютыПоКлассификатору(КодВалюты) = Неопределено Тогда
		
		ШаблонОшибки = НСтр("ru = 'указанный код (%1) не найден в классификаторе ОКВ'");
		ТекстОшибки = СтрШаблон(ШаблонОшибки, СокрЛП(КодВалюты));
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, НайденнаяСтрокаРеквизита,
			ТекстОшибки);
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьДанныеИсправленияФНС(ДеревоДанных, Ошибки, СтруктураЭД, ИмяРеквизитаНомер, ИмяРеквизитаДата)

	СтрокаНомера = Неопределено;
	НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ИмяРеквизитаНомер,,
		СтрокаНомера);
		
	СтрокаДаты = Неопределено;
	ДатаИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ИмяРеквизитаДата,,
		СтрокаДаты);
		
	Если ЗначениеЗаполнено(НомерИсправления) ИЛИ ЗначениеЗаполнено(ДатаИсправления) Тогда
		Если Не ЗначениеЗаполнено(НомерИсправления) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, СтрокаНомера, ТекстОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДатаИсправления) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, СтрокаДаты, ТекстОшибки);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьОснованиеФНС(ДеревоДанных, Ошибки, СтруктураЭД, ИмяРеквизитаОснования,
	ИмяРеквизитаНаименование = "ДокументНаименование", ИмяРеквизитаДата = "ДокументДата",
	ЗначениеНезаполненногоНаименования = "Отсутствует")
	
	// ДатаОсн - обязателен, если НаимОсн - отличное от "Отсутствует" (или "-").
	Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ИмяРеквизитаОснования);
	Если ТипЗнч(Реквизит) = Тип("Число") И Реквизит > 0 Тогда
		СтрокаТаблицы = ДеревоДанных.Строки.Найти(ИмяРеквизитаОснования, "ПолныйПуть", Истина);
		Если ТипЗнч(СтрокаТаблицы.Значение) = Тип("Число") И СтрокаТаблицы.Значение > 0 Тогда
			Для Каждого Основание Из СтрокаТаблицы.Строки Цикл
				НаименованиеОснования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					ИмяРеквизитаОснования + ".НомерСтроки." + ИмяРеквизитаНаименование);
				
				ДатаОснованияСтрокаДерева = Неопределено;
				ДатаОснования = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Основание,
					ИмяРеквизитаОснования + ".НомерСтроки." + ИмяРеквизитаДата,, ДатаОснованияСтрокаДерева);
				
				Если ЗначениеЗаполнено(НаименованиеОснования) И СокрЛП(НаименованиеОснования) <> ЗначениеНезаполненногоНаименования
					И Не ЗначениеЗаполнено(ДатаОснования) Тогда
					
					ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
					ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, ДатаОснованияСтрокаДерева,
						ТекстОшибки);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьСведенияОбУчастникеУПДУКД(ДеревоДанных, ВидУчастника, Ошибки, СтруктураЭД, АдресОбязателен = Ложь)

	// Если участник не указан в дереве, не проверяем.
	Участник = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника);
	Если Не ЗначениеЗаполнено(Участник) Тогда
		Возврат;
	КонецЕсли;
	
	// Адрес - обязателен в некоторых случаях.
	АдресУчастникаСтрокаДерева = Неопределено;
	АдресУчастника = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес",, АдресУчастникаСтрокаДерева);
	Если Не ЗначениеЗаполнено(АдресУчастника) Тогда
		Если АдресОбязателен Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеверноЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, АдресУчастникаСтрокаДерева,
				ТекстОшибки);
		КонецЕсли;
	Иначе
		Если АдресУчастника = "АдресИнформация" Тогда
			ПроверитьКодСтраныФНС(ДеревоДанных, Ошибки, СтруктураЭД, ВидУчастника + ".Адрес.АдресИнформация.КодСтраны");		
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьКодСтраныФНС(ДеревоДанных, Ошибки, СтруктураЭД, ИмяРеквизитаДерева, НомерСтроки = Неопределено)
	
	КодСтраныСтрокаДерева = Неопределено;
	КодСтраны = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		ИмяРеквизитаДерева,, КодСтраныСтрокаДерева);
	
	Если ЗначениеЗаполнено(КодСтраны) Тогда
		ДанныеСтраныПоКлассификатору = ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеКлассификатораСтранМираПоКоду(КодСтраны);
		КодыСтранДопустимыеКромеКлассификатора = КодыСтранДопустимыеКромеКлассификатора();
		Если ДанныеСтраныПоКлассификатору = Неопределено
			И КодыСтранДопустимыеКромеКлассификатора.Найти(КодСтраны) = Неопределено Тогда
			
			ШаблонОшибки = НСтр("ru = 'допускается указание кодов из классификатора ОКСМ, а также 980 (Евросоюз), 981 (ЕАЭС), указано %1'");
			ТекстОшибки = СтрШаблон(ШаблонОшибки, СокрЛП(КодСтраны));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, КодСтраныСтрокаДерева,
				ТекстОшибки,, НомерСтроки);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьДанныеЕдиницыИзмеренияФНС(ЕдиницаИзмеренияКод, ЕдиницаИзмеренияКодСтрокаДерева, Ошибки, СтруктураЭД,
	НомерСтроки, КодЕдиницыИзмеренияНулевой)
	
	// ОКЕИ_Тов - код единицы измерения не менее 3 символов.
	Если СтрДлина(СокрЛП(ЕдиницаИзмеренияКод)) < 3 Тогда
		ШаблонОшибки = НСтр("ru = 'значение должно содержать от 3 до 4 символов, указано %1'");
		ТекстОшибки = СтрШаблон(ШаблонОшибки, СокрЛП(ЕдиницаИзмеренияКод));
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, ЕдиницаИзмеренияКодСтрокаДерева,
			ТекстОшибки,, НомерСтроки);
	// ОКЕИ_Тов - код единицы измерения должен содержать только цифры.
	ИначеЕсли Не СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(ЕдиницаИзмеренияКод) Тогда
		ШаблонОшибки = НСтр("ru = 'значение должно содержать только цифры, указано %1'");
		ТекстОшибки = СтрШаблон(ШаблонОшибки, СокрЛП(ЕдиницаИзмеренияКод));
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, ЕдиницаИзмеренияКодСтрокаДерева,
			ТекстОшибки,, НомерСтроки);
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьСтавкуНДС_УПДУКД(Товар, Ошибки, СтруктураЭД, НомерСтроки, ИмяСтавкиНДС)
	
	// НалСт - ставка НДС должна содержать значение из определенного перечня.
	СтавкаНДССтрокаДерева = Неопределено;
	ЗначениеСтавкиНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
		"СведенияОТоварах.НомерСтроки." + ИмяСтавкиНДС,, СтавкаНДССтрокаДерева);
	Если ЗначениеЗаполнено(ЗначениеСтавкиНДС) Тогда
		СтавкаНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия( , ЗначениеСтавкиНДС);
		СтавкаXDTO = СтавкаНДСXDTO(СтавкаНДС);
		
		Если Не ЗначениеЗаполнено(СтавкаXDTO) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеверноЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, СтавкаНДССтрокаДерева, ТекстОшибки,,
				НомерСтроки);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьНаличиеУвеличенияУменьшенияВУКД(ДеревоДанных, Ошибки, СтруктураЭД, НомерСтроки, ИмяРеквизитаУвеличение,
	ИмяРеквизитаУменьшение, ПредставлениеРеквизита)

	УвеличениеСтрокаДерева = Неопределено;
	Увеличение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		ИмяРеквизитаУвеличение,, УвеличениеСтрокаДерева);
		
	УменьшениеСтрокаДерева = Неопределено;
	Уменьшение = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		ИмяРеквизитаУменьшение,, УменьшениеСтрокаДерева);
		
	// Строка должна содержать корректировку (либо в "+", либо в "-").
	Если Не ЗначениеЗаполнено(Увеличение) И Не ЗначениеЗаполнено(Уменьшение) Тогда
		ТекстОшибки = НСтр("ru = 'чтобы сформировать документ, необходимо скорректировать значение относительно документа-основания'");
		
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, УвеличениеСтрокаДерева, ТекстОшибки,,
			НомерСтроки, ПредставлениеРеквизита);
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьПередачуТоваров(ДеревоДанных, СтруктураЭД, Ошибки)

	НайденнаяСтрокаРеквизита = Неопределено;
	
	// НомИспрДокПТ и ДатаИспрДокПТ - данные исправительного документа должны быть либо указаны оба, либо не указаны
	// вообще. Также НомИспрДокПТ должен быть больше 0.
	ПроверитьДанныеИсправленияФНС(ДеревоДанных, Ошибки, СтруктураЭД, "НомерИсправления", "ДатаИсправления");
	
	// КодОКВ - код валюты должен быть в Общероссийском классификаторе валют.
	ПроверитьКодВалютыФНС(ДеревоДанных, СтруктураЭД, Ошибки);
	
	// ДатаОсн - обязателен, если в НаимОсн, отличном от "Отсутствует".
	ПроверитьОснованиеФНС(ДеревоДанных, Ошибки, СтруктураЭД, "Основание", "ДокОснованиеНаименование", "ДокОснованиеДата", "-");
	
	ПроверитьСведенияОбУчастникеПередачиТоваровРабот(ДеревоДанных, "Грузоотправитель", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеПередачиТоваровРабот(ДеревоДанных, "Грузополучатель", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеПередачиТоваровРабот(ДеревоДанных, "Поставщик", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеПередачиТоваровРабот(ДеревоДанных, "Плательщик", Ошибки, СтруктураЭД);
	
	// Сведения о товарах.
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("ТаблицаТоваров", "ПолныйПуть");
	НомерСтроки = 1;
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		// Должен быть указан хотя бы один из четырех параметров: НаимТов, ХарактерТов, АртикулТов, КодТов.
		НаименованиеТовараСтрокаДерева = Неопределено;
		НаименованиеТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"ТаблицаТоваров.НомерСтроки.НаименованиеНоменклатуры",, НаименованиеТовараСтрокаДерева);
		ХарактеристикаТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"ТаблицаТоваров.НомерСтроки.НаименованиеХарактеристики");
		АртикулТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"ТаблицаТоваров.НомерСтроки.Артикул");
		КодТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"ТаблицаТоваров.НомерСтроки.КодТовара");
		
		Если Не ЗначениеЗаполнено(НаименованиеТовара) И Не ЗначениеЗаполнено(НаименованиеТовара)
			И Не ЗначениеЗаполнено(АртикулТовара) И Не ЗначениеЗаполнено(КодТовара) Тогда
			
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, НаименованиеТовараСтрокаДерева,
				ТекстОшибки,, НомерСтроки);
		КонецЕсли;
		
		// Код единицы должен содержать от 3 до 4 символов и содержаться в ОКЕИ, если отличен от "0000".
		КодЕдиницыИзмеренияНулевой = Ложь;
		ЕдиницаИзмеренияКодСтрокаДерева = Неопределено;
		ЕдиницаИзмеренияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар,
			"ТаблицаТоваров.НомерСтроки.БазоваяЕдиницаКод",, ЕдиницаИзмеренияКодСтрокаДерева);
		Если ЗначениеЗаполнено(ЕдиницаИзмеренияКод) Тогда
			КодЕдиницыИзмеренияНулевой = ТолькоСимволыВСтроке(ЕдиницаИзмеренияКод, "0");
		
			ПроверитьДанныеЕдиницыИзмеренияФНС(ЕдиницаИзмеренияКод, ЕдиницаИзмеренияКодСтрокаДерева, Ошибки, СтруктураЭД, НомерСтроки,
				КодЕдиницыИзмеренияНулевой);
		КонецЕсли;
			
		// НаимЕдИзм - наименование единицы измерение обязательно, если указан ее код.
		ПроверитьНаименованиеЕдиницыИзмеренияФНС(Товар, Ошибки, СтруктураЭД, НомерСтроки, КодЕдиницыИзмеренияНулевой,
			"ТаблицаТоваров.НомерСтроки.ЕдиницаИзмеренияНаименование");
					
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;

КонецПроцедуры

Процедура ПроверитьСведенияОбУчастникеПередачиТоваровРабот(ДеревоДанных, ВидУчастника, Ошибки, СтруктураЭД)

	// Если участник не указан в дереве, не проверяем.
	Участник = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника);
	Если Не ЗначениеЗаполнено(Участник) Тогда
		Возврат;
	КонецЕсли;
	
	АдресУчастника = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ВидУчастника + ".Адрес");
	Если ЗначениеЗаполнено(АдресУчастника) Тогда
		Если АдресУчастника = "Иностранный" Тогда
			ПроверитьКодСтраныФНС(ДеревоДанных, Ошибки, СтруктураЭД, ВидУчастника + ".Адрес.Иностранный.КодСтраны");
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьПередачуРабот(ДеревоДанных, СтруктураЭД, Ошибки)

	НайденнаяСтрокаРеквизита = Неопределено;
	
	// НомИспрДокПРУ и ДатаИспрДокПРУ - данные исправительного документа должны быть либо указаны оба, либо не указаны
	// вообще. Также НомИспрДокПРУ должен быть больше 0.
	ПроверитьДанныеИсправленияФНС(ДеревоДанных, Ошибки, СтруктураЭД, "НомерИсправления", "ДатаИсправления");
	
	// КодОКВ - код валюты должен быть в Общероссийском классификаторе валют.
	ПроверитьКодВалютыФНС(ДеревоДанных, СтруктураЭД, Ошибки);
	
	// ДатаОсн - обязателен, если в НаимОсн, отличном от "-".
	ПроверитьОснованиеФНС(ДеревоДанных, Ошибки, СтруктураЭД, "Основание", "ДокОснованиеНаименование", "ДокОснованиеДата", "-");
	
	ПроверитьСведенияОбУчастникеПередачиТоваровРабот(ДеревоДанных, "Исполнитель", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеПередачиТоваровРабот(ДеревоДанных, "Заказчик", Ошибки, СтруктураЭД);
	
	// Сведения об услугах.
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("ТаблицаУслуг", "ПолныйПуть");
	НомерСтроки = 1;
	Для Каждого Услуга Из СтрокаТаблицаТоваров.Строки Цикл
		// Должен быть указан хотя бы один из двух параметров: НаимРабот, Описание.
		НаименованиеРаботСтрокаДерева = Неопределено;
		НаименованиеРабот = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Услуга,
			"ТаблицаУслуг.НомерСтроки.НаименованиеНоменклатуры",, НаименованиеРаботСтрокаДерева);
		ОписаниеРабот = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Услуга,
			"ТаблицаУслуг.НомерСтроки.Описание");
		
		Если Не ЗначениеЗаполнено(НаименованиеРабот) И Не ЗначениеЗаполнено(ОписаниеРабот) Тогда	
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, НаименованиеРаботСтрокаДерева,
				ТекстОшибки,, НомерСтроки);
		КонецЕсли;
		
		Количество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Услуга, 
			"ТаблицаУслуг.НомерСтроки.Количество",, НаименованиеРаботСтрокаДерева);
		Если ЗначениеЗаполнено(НаименованиеРабот) И Не ЗначениеЗаполнено(Количество) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, НаименованиеРаботСтрокаДерева,
				ТекстОшибки,, НомерСтроки);
		КонецЕсли;
		
		// Код единицы должен содержать от 3 до 4 символов и содержаться в ОКЕИ, если отличен от "0000".
		КодЕдиницыИзмеренияНулевой = Ложь;
		ЕдиницаИзмеренияКодСтрокаДерева = Неопределено;
		ЕдиницаИзмеренияКод = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Услуга,
			"ТаблицаУслуг.НомерСтроки.ЕдиницаИзмеренияКод",, ЕдиницаИзмеренияКодСтрокаДерева);
		Если ЗначениеЗаполнено(ЕдиницаИзмеренияКод) Тогда
			КодЕдиницыИзмеренияНулевой = ТолькоСимволыВСтроке(ЕдиницаИзмеренияКод, "0");
		
			ПроверитьДанныеЕдиницыИзмеренияФНС(ЕдиницаИзмеренияКод, ЕдиницаИзмеренияКодСтрокаДерева, Ошибки, СтруктураЭД, НомерСтроки,
				КодЕдиницыИзмеренияНулевой);
		КонецЕсли;
			
		// НаимЕдИзм - наименование единицы измерение обязательно, если указан ее код.
		ПроверитьНаименованиеЕдиницыИзмеренияФНС(Услуга, Ошибки, СтруктураЭД, НомерСтроки, КодЕдиницыИзмеренияНулевой,
			"ТаблицаУслуг.НомерСтроки.ЕдиницаИзмеренияНаименование");
		
		// СтоимУчНДС - обязательно, если указано наименование работ.
		СтоимостьСНДССтрокаДерева = Неопределено;
		СтоимостьСНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Услуга,
			"ТаблицаУслуг.НомерСтроки.СуммаСНДС",, СтоимостьСНДССтрокаДерева);
		Если ЗначениеЗаполнено(НаименованиеРабот) И Не ЗначениеЗаполнено(СтоимостьСНДССтрокаДерева) Тогда
			ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеЗаполненногоЗначенияДерева();
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, СтоимостьСНДССтрокаДерева,
				ТекстОшибки,, НомерСтроки);
		КонецЕсли;
					
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;

КонецПроцедуры

Процедура ПроверитьПрайсЛист(ДеревоДанных, СтруктураЭД, Ошибки)

	// НомерСчета - должен соответствовать шаблону.
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Владелец", Ошибки, СтруктураЭД);
	
	// Сведения о товарах.
	ПроверитьТаблицуТоваровCML(ДеревоДанных, Ошибки, СтруктураЭД);

КонецПроцедуры

Процедура ПроверитьКаталогТоваров(ДеревоДанных, СтруктураЭД, Ошибки)

	// НомерСчета - должен соответствовать шаблону.
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Владелец", Ошибки, СтруктураЭД);
	
	// Сведения о товарах.
	ПроверитьТаблицуТоваровCML(ДеревоДанных, Ошибки, СтруктураЭД);

КонецПроцедуры

Процедура ПроверитьСведенияОбУчастникеCML(ДеревоДанных, ВидУчастника, Ошибки, СтруктураЭД, НомерСтроки = Неопределено)
	
	ПроверитьНомерРасчетногоСчетаCML(ДеревоДанных, ВидУчастника + ".БанковскийСчет.НомерСчета", Ошибки, СтруктураЭД,
		НомерСтроки);

КонецПроцедуры

Процедура ПроверитьНомерРасчетногоСчетаCML(ДеревоДанных, ПутьКРеквизиту, Ошибки, СтруктураЭД, НомерСтроки = Неопределено)
	
	НомерСчетаСтрокаДерева = Неопределено;
	НомерСчета = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, ПутьКРеквизиту,,
		НомерСчетаСтрокаДерева);
		
	Если ЗначениеЗаполнено(НомерСчета) И СтрДлина(НомерСчета) = 20 И НЕ НомерСчетаКорректный(НомерСчета) Тогда
		ТекстОшибки = ЭлектронноеВзаимодействиеСлужебный.ТекстОшибкиНеверноЗаполненногоЗначенияДерева();
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, НомерСчетаСтрокаДерева, ТекстОшибки,,
			НомерСтроки);
	КонецЕсли;

КонецПроцедуры

Процедура ПроверитьДлинуСтроковогоЗначенияCML(ДеревоДанных, Ошибки, СтруктураЭД, ПолноеИмяРеквизита,
	МинимальнаяДлина, МаксимальнаяДлина, НомерСтроки = Неопределено)
	
	РеквизитСтрокаДерева = Неопределено;
	Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
		ПолноеИмяРеквизита, Ложь, РеквизитСтрокаДерева);
	
	Если ЗначениеЗаполнено(Реквизит) Тогда
		Если СтрДлина(Реквизит) < МинимальнаяДлина Тогда
			ШаблонОшибки = НСтр("ru = 'значение должно содержать от %1 до %2 символов, указано %3'");
			ТекстОшибки = СтрШаблон(ШаблонОшибки, МинимальнаяДлина, МаксимальнаяДлина, СокрЛП(Реквизит));
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, РеквизитСтрокаДерева,
				ТекстОшибки,, НомерСтроки);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Функция НомерСчетаКорректный(Знач НомерСчета)
	
	Цифры = "0123456789";
	ДопустимыеБуквы = "ABCEHKMPTX";
	Ошибка = Ложь;
	Для Индекс = 1 По 5 Цикл
		Символ = Сред(НомерСчета, Индекс, 1);
		
		Если СтрНайти(Цифры, Символ) = 0 Тогда
			Ошибка = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если Не Ошибка Тогда
		Символ = Сред(НомерСчета, 6, 1);
		
		Если СтрНайти(Цифры, Символ) = 0 И СтрНайти(ДопустимыеБуквы, Символ) = 0 Тогда
			Ошибка = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Для Индекс = 7 По 20 Цикл
		Символ = Сред(НомерСчета, Индекс, 1);
		
		Если СтрНайти(Цифры, Символ) = 0 Тогда
			Ошибка = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Не Ошибка;

КонецФункции

Процедура ПроверитьОтчетОПродажахКомиссионногоТовара(ДеревоДанных, СтруктураЭД, Ошибки)

	// НомерСчета - должен соответствовать шаблону.
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Комитент", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Комиссионер", Ошибки, СтруктураЭД);
	
	ПроверитьДлинуСтроковогоЗначенияCML(ДеревоДанных, Ошибки, СтруктураЭД, "Услуга.БазоваяЕдиницаКод", 3, 4);
	
	// Сведения о товарах.
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
	НомерСтроки = 1;
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		ПроверитьДлинуСтроковогоЗначенияCML(Товар, Ошибки, СтруктураЭД, "Товары.НомерСтроки.БазоваяЕдиницаКод", 3, 4, НомерСтроки);
		ПроверитьДлинуСтроковогоЗначенияCML(Товар, Ошибки, СтруктураЭД, "Товары.НомерСтроки.ЕдиницаИзмеренияКодПоОКЕИ", 3, 4, НомерСтроки);
		ПроверитьДлинуСтроковогоЗначенияCML(Товар, Ошибки, СтруктураЭД, "Товары.НомерСтроки.Штрихкод", 8, 14, НомерСтроки);
		
		ПроверитьТаблицуТоваровCML(ДеревоДанных, Ошибки, СтруктураЭД);

		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;

КонецПроцедуры

Процедура ПроверитьОтчетОСписанииКомиссионногоТовара(ДеревоДанных, СтруктураЭД, Ошибки)

	// НомерСчета - должен соответствовать шаблону.
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Комитент", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Комиссионер", Ошибки, СтруктураЭД);
	
	// Сведения о товарах.
	ПроверитьТаблицуТоваровCML(ДеревоДанных, Ошибки, СтруктураЭД);

КонецПроцедуры

Процедура ПроверитьЗаказТовара(ДеревоДанных, СтруктураЭД, Ошибки)

	// НомерСчета - должен соответствовать шаблону.
	ПроверитьНомерРасчетногоСчетаCML(ДеревоДанных, "РасчетныйСчет.Банк.СчетКорреспондентский", Ошибки, СтруктураЭД);
	ПроверитьНомерРасчетногоСчетаCML(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.СчетКорреспондентский", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Покупатель", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Продавец", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Получатель", Ошибки, СтруктураЭД);
	
	// Сведения о товарах.
	ПроверитьТаблицуТоваровCML(ДеревоДанных, Ошибки, СтруктураЭД);


КонецПроцедуры

Процедура ПроверитьТаблицуТоваровCML(ДеревоДанных, Ошибки, СтруктураЭД)
	
	СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("Товары", "ПолныйПуть");
	НомерСтроки = 1;
	Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
		ПроверитьДлинуСтроковогоЗначенияCML(Товар, Ошибки, СтруктураЭД, "Товары.НомерСтроки.БазоваяЕдиницаКод", 3, 4, НомерСтроки);
		ПроверитьДлинуСтроковогоЗначенияCML(Товар, Ошибки, СтруктураЭД, "Товары.НомерСтроки.ЕдиницаИзмеренияКодПоОКЕИ", 3, 4, НомерСтроки);
		ПроверитьДлинуСтроковогоЗначенияCML(Товар, Ошибки, СтруктураЭД, "Товары.НомерСтроки.Штрихкод", 8, 14, НомерСтроки);
		
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(Товар, "Товары.НомерСтроки.Покупатель") Тогда
			ПроверитьСведенияОбУчастникеCML(Товар, "Товары.НомерСтроки.Покупатель", Ошибки, СтруктураЭД, НомерСтроки);
		КонецЕсли;
		
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;

КонецПроцедуры

Процедура ПроверитьСчетНаОплату(ДеревоДанных, СтруктураЭД, Ошибки)

	// НомерСчета - должен соответствовать шаблону.
	ПроверитьНомерРасчетногоСчетаCML(ДеревоДанных, "РасчетныйСчет.Банк.СчетКорреспондентский", Ошибки, СтруктураЭД);
	ПроверитьНомерРасчетногоСчетаCML(ДеревоДанных, "РасчетныйСчет.БанкКорреспондент.СчетКорреспондентский", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Покупатель", Ошибки, СтруктураЭД);
	ПроверитьСведенияОбУчастникеCML(ДеревоДанных, "Продавец", Ошибки, СтруктураЭД);
	
	// Сведения о товарах.
	ПроверитьТаблицуТоваровCML(ДеревоДанных, Ошибки, СтруктураЭД);

КонецПроцедуры

Функция ПакетЭДПоНаименованию(Знач Наименование) 
	
	ПрисоединенныйФайл = Справочники.ПакетЭДПрисоединенныеФайлы.НайтиПоНаименованию(Наименование);
	
	Если Не ЗначениеЗаполнено(ПрисоединенныйФайл) Тогда
		Возврат Документы.ПакетЭД.ПустаяСсылка();
	КонецЕсли;
	
	ПакетЭД = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПрисоединенныйФайл, "ВладелецФайла");
	
	Возврат ПакетЭД;
	
КонецФункции

Функция НомераЭДВПакетеЭД(Знач ПакетЭД) 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокументыПакетаЭД.ЭлектронныйДокумент.НомерЭД КАК НомерЭД
	|ИЗ
	|	Документ.ПакетЭД.ЭлектронныеДокументы КАК ДокументыПакетаЭД
	|ГДЕ
	|	ДокументыПакетаЭД.Ссылка = &ПакетЭД";
	Запрос.УстановитьПараметр("ПакетЭД", ПакетЭД);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("НомерЭД");
	
КонецФункции

Функция ДокументБезНДС(ДеревоДанных, ИмяРеквизитаСтавкаНДС)
	
	ПозицияРазделителя  = СтрНайти(ИмяРеквизитаСтавкаНДС, ".");
	ИмяКоллекцииТоваров = Лев(ИмяРеквизитаСтавкаНДС, ПозицияРазделителя - 1);
	
	КоллекцияТоваров = ДеревоДанных.Строки.Найти(ИмяКоллекцииТоваров, "ПолныйПуть");
	Если КоллекцияТоваров = Неопределено 
		ИЛИ КоллекцияТоваров.Строки.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	СтавкаНДСБезНДС = ОбменСКонтрагентамиПовтИсп.СтавкаНДСИзСоответствия(НСтр("ru = 'без НДС'"));
	
	Для Каждого СтрокаКоллекции Из КоллекцияТоваров.Строки Цикл
		СтавкаНДС = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаКоллекции, ИмяРеквизитаСтавкаНДС, Ложь);
		Если НЕ ЗначениеЗаполнено(СтавкаНДС) ИЛИ СтавкаНДС <> СтавкаНДСБезНДС Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ЕстьАктуальныеЭД(СсылкиНаВладельцев)
	
	Если НЕ ЗначениеЗаполнено(СсылкиНаВладельцев) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СостоянияЭД.СсылкаНаОбъект КАК ВладелецЭД
		|ИЗ
		|	РегистрСведений.СостоянияЭД КАК СостоянияЭД
		|ГДЕ
		|	СостоянияЭД.СсылкаНаОбъект В(&СписокВладельцев)
		|	И СостоянияЭД.СостояниеВерсииЭД <> ЗНАЧЕНИЕ(Перечисление.СостоянияВерсийЭД.НеСформирован)
		|	И СостоянияЭД.СостояниеВерсииЭД <> ЗНАЧЕНИЕ(Перечисление.СостоянияВерсийЭД.ЗакрытПринудительно)";
	Запрос.УстановитьПараметр("СписокВладельцев", СсылкиНаВладельцев);
	РезультатЗапроса = Запрос.Выполнить();
	
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции

Функция ПрочитатьОписаниеОшибкиОператораЭДОИзФайла(Знач ИмяФайла, Знач ТекстОшибкиПоУмолчанию = "")
	
	Если Не ЗначениеЗаполнено(ТекстОшибкиПоУмолчанию) Тогда
		ТекстОшибкиПоУмолчанию = НСтр("ru = 'Неизвестная ошибка.'");
	КонецЕсли;
	
	Ошибка = Новый Структура("Текст,Данные,Детали");
	
	Попытка
		
		ФайлРезультата = Новый ТекстовыйДокумент;
		ФайлРезультата.Прочитать(ИмяФайла, КодировкаТекста.UTF8);
		Текст = ФайлРезультата.ПолучитьТекст();
		Ошибка.Текст = Текст;
		
		ЧтениеJSON = Новый ЧтениеJSON();
		ЧтениеJSON.УстановитьСтроку(Текст);
		Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
		Ошибка.Данные = Данные;
		
		Ошибка.Детали = Ошибка.Данные["Details"];
	
	Исключение
		
		Если Не ЗначениеЗаполнено(Ошибка.Текст) Тогда
			Ошибка.Текст = ТекстОшибкиПоУмолчанию;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(Ошибка.Данные) Тогда
			Ошибка.Данные = Новый Соответствие;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(Ошибка.Детали) Тогда
			Ошибка.Детали = Ошибка.Текст;
		КонецЕсли;
		
	КонецПопытки;
		
	Возврат Ошибка;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Формирование ЭД ФНС из документов БД

// Фиксирует накопленные ошибки (записывает в журнал регистрации, выводит пользователю и т.д.).
//
// Параметры:
//  Ошибки			 - Массив - ошибки, накопленные за время обработки. Элементами массива являются структуры.
//                              Состав структур см. в ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.НовыеПараметрыОшибки().
//  ВидЭД			 - ПеречислениеСсылка.ВидыЭД - ссылка на вид электронного документа.
//  СсылкаНаОбъект	 - ДокументСсылка - ссылка на учетный документ, по которому фиксируются ошибки.
//
Процедура ОбработатьОшибкиФормированияЭД(Ошибки, ВидЭД, СсылкаНаОбъект = Неопределено)

	Если ЗначениеЗаполнено(Ошибки) Тогда
		// Добавим маркер к каждой ошибке.
		Для Каждого ОписаниеОшибки Из Ошибки Цикл
			ОписаниеОшибки.ТекстОшибки = " - " + ОписаниеОшибки.ТекстОшибки;
		КонецЦикла;
		
		// Добавим заголовок.
		Если ЗначениеЗаполнено(СсылкаНаОбъект) Тогда
			ШаблонЗаголовка = НСтр("ru = 'Не удалось сформировать электронный документ ""%1"" на основании документа ""%2"" по следующим причинам:'");
		Иначе
			ШаблонЗаголовка = НСтр("ru = 'Не удалось сформировать электронный документ ""%1"" по следующим причинам:'");
		КонецЕсли;
		
		ТекстЗаголовка = СтрШаблон(ШаблонЗаголовка, ВидЭД, СсылкаНаОбъект);
		
		ДанныеОшибки = ЭлектронноеВзаимодействиеСлужебныйКлиентСервер.НовыеПараметрыОшибки(СсылкаНаОбъект);
		ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибку(Ошибки, ТекстЗаголовка, ДанныеОшибки, 0);
		
		ПодробноеОписаниеОшибки = ЭлектронноеВзаимодействиеСлужебный.СоединитьОшибки(Ошибки);
		
		ВидОперации = ВидОперацииФормированиеЭД();
		ЭлектронноеВзаимодействиеСлужебныйВызовСервера.ОбработатьОшибку(ВидОперации, ПодробноеОписаниеОшибки, Ошибки,,
			СсылкаНаОбъект);
	КонецЕсли;

КонецПроцедуры

// Возвращает текстовое представление вида операции формирования электронного документа.
// Используется для фиксации ошибок.
// 
// Возвращаемое значение:
//  Строка - представление ошибки.
//
Функция ВидОперацииФормированиеЭД()

	Возврат НСтр("ru = 'Формирование электронного документа'");

КонецФункции 

Процедура ЗаполнитьНаименованиеВалютыXML(ЭлементXDTO, КодВалюты, Ошибки)
	
	Если ЗначениеЗаполнено(КодВалюты) Тогда
		ДанныеПоКлассификатору = ОбменСКонтрагентамиСлужебныйПовтИсп.ДанныеВалютыПоКлассификатору(КодВалюты);
		Если ДанныеПоКлассификатору <> Неопределено Тогда
			ЗаполнитьСвойствоXDTO(ЭлементXDTO, "НаимОКВ", ДанныеПоКлассификатору.Наименование, , Ошибки);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Функция ВернутьВремяЭСФСтрокой(ДатаВремя)
	
	ВремяЭСФ = Формат(Час(ДатаВремя), "ЧЦ=2; ЧН=; ЧВН=") + ".";
	ВремяЭСФ = ВремяЭСФ+Формат(Минута(ДатаВремя), "ЧЦ=2; ЧН=; ЧВН=") + ".";
	ВремяЭСФ = ВремяЭСФ+Формат(Минута(ДатаВремя), "ЧЦ=2; ЧН=; ЧВН=");
	
	Возврат ВремяЭСФ;
	
КонецФункции

Функция ВремяИзДаты(ДатаВремя)

	Возврат Дата(1, 1, 1) + Час(ДатаВремя) * 3600 + Минута(ДатаВремя) * 60 + Секунда(ДатаВремя);

КонецФункции

Функция ДанныеУчастникаСделкиCML(СтрокаДереваДанных, ВидУчастника)
	
	Наименование = "";
	Если Не ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника")) Тогда
		Возврат Наименование;
	КонецЕсли;
	
	Если ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ФЛ" Тогда
		
		Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ФЛ.Фамилия");
		Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ФЛ.Имя");
		Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ФЛ.Отчество");
		
		Наименование = Фамилия + " " + Имя + " " + Отчество;
		
	ИначеЕсли ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника") = "ИП" Тогда
		
		Фамилия = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Фамилия");
		Имя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Имя");
		Отчество = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ИП.Отчество");
		
		Наименование = Фамилия + " " + Имя + " " + Отчество;
	Иначе
			
		Наименование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаДереваДанных, ВидУчастника + ".ТипУчастника.ЮЛ.НаименованиеОрганизации");
		
	КонецЕсли;
	
	Возврат Наименование;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Разбор файлов

Функция УточненныйВидЭДИнформацииПродавцаУПД(ДеревоДанных, ВидЭД)
	
	УточненныйВидЭД = ВидЭД;
	
	Если ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец Тогда
		
		ТолькоУслуги = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги");
		
		Если ТипЗнч(ТолькоУслуги) = Тип("Булево") И ТолькоУслуги Тогда
			
			УточненныйВидЭД = Перечисления.ВидыЭД.АктИсполнитель;
			
		Иначе
			
			ТолькоРаботыУслуги       = Истина;
			ТолькоИмущественныеПрава = Истина;
			
			СведенияОТоварах = ЭлектронноеВзаимодействие.ДанныеДерева(ДеревоДанных, "СведенияОТоварах");
			Для каждого Сведения Из СведенияОТоварах Цикл
				
				Если Сведения.Признак <> "4" Тогда
					ТолькоИмущественныеПрава = Ложь;
				КонецЕсли;
				
				Если Сведения.Признак <> "2" ИЛИ Сведения.Признак <> "3" Тогда
					ТолькоРаботыУслуги = Ложь;
				КонецЕсли;
				
				Если Не (ТолькоИмущественныеПрава ИЛИ ТолькоРаботыУслуги) Тогда
					Прервать;
				КонецЕсли;
				
			КонецЦикла;
			
			Если ТолькоИмущественныеПрава Тогда
				УточненныйВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав;
			ИначеЕсли ТолькоРаботыУслуги Тогда
				УточненныйВидЭД = Перечисления.ВидыЭД.АктИсполнитель;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат УточненныйВидЭД;
	
КонецФункции

// Проверяет адрес на соответствие формату КЛАДР. Если в сведении об адресе
// заполнены специфичные для ФИАС поля, то он не поместится в формат КЛАДР.
//
// Параметры:
//  Адрес - Структура - Структура адреса, возвращаемая методом РаботаСАдресами.СведенияОбАдресе.
//
// Возвращаемое значение - Булево - Истина, если адрес соответствует формату КЛАДР.
//
Функция АдресСоответствуетФорматуКЛАДР(СведенияОбАдресе)
	
	Соответствует = Истина;
	
	Если ЗначениеЗаполнено(СведенияОбАдресе.Округ)
		Или ЗначениеЗаполнено(СведенияОбАдресе.МуниципальныйРайон)
		Или ЗначениеЗаполнено(СведенияОбАдресе.Поселение)
		Или ЗначениеЗаполнено(СведенияОбАдресе.ВнутригородскойРайон)
		Или ЗначениеЗаполнено(СведенияОбАдресе.Территория)
		Или ЗначениеЗаполнено(СведенияОбАдресе.ДополнительнаяТерритория)
		Или ЗначениеЗаполнено(СведенияОбАдресе.ЭлементДополнительнойТерритории)
		Или НРег(СведенияОбАдресе.Здание.ТипЗдания) <> "дом"
		Или СведенияОбАдресе.Корпуса.Количество() > 1
		Или СведенияОбАдресе.Помещения.Количество() > 1 Тогда
		
		Соответствует = Ложь
	КонецЕсли;
	
	Возврат Соответствует;
	
КонецФункции

// Заполняет в дереве электронного документа поле "Адрес"
// по полям, заполняемым на стороне прикладного решения:
//  "Адрес.АвтоматическиЗаполняемый.ОбъектКонтактнойИнформации",
//  "Адрес.АвтоматическиЗаполняемый.ВидКонтактнойИнформации".
//
// Параметры:
//  Участники - Массив - участники сделки в дереве электронного документа.
//   *ЭлементМассива - Строка - Путь в дереве электронного документа до участника сделки.
//  ДеревоДанных - ДеревоЗначений - Дерево электронного документа.
//  ЭтоУПД - Булево - Признак заполнения адреса для УПД или УКД.
//
Процедура ЗаполнитьАдресаУчастниковСделки(Участники, ДеревоДанных, ЭтоУПД = Ложь)
	
	// Определение путей в дереве электронного документа в зависимости от формата.
	Если ЭтоУПД Тогда
		
		ПутьКСтруктурированномуАдресу = ".Адрес.АдресРФ";
		ПутьКПроизвольномуАдресу      = ".Адрес.АдресИнформация";
		
		ПолеКодРегиона = ".КодРегиона";
		ПолеНаселПункт = ".НаселенныйПункт";
		ПолеКвартира   = ".Квартира";
		
	Иначе
		
		ПутьКСтруктурированномуАдресу = ".Адрес.Структурированный";
		ПутьКПроизвольномуАдресу      = ".Адрес.Произвольный";
		
		ПолеКодРегиона = ".КодРегион";
		ПолеНаселПункт = ".НаселПункт";
		ПолеКвартира   = ".Кварт";
		
	КонецЕсли;
	
	Для Каждого Участник Из Участники Цикл
		
		ОбъектКонтактнойИнформации = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, Участник + ".Адрес.АвтоматическиЗаполняемый.ОбъектКонтактнойИнформации");
			
		ВидКонтактнойИнформации    = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, Участник + ".Адрес.АвтоматическиЗаполняемый.ВидКонтактнойИнформации");
		
		Если Не ЗначениеЗаполнено(ОбъектКонтактнойИнформации) Тогда
			Продолжить;
		КонецЕсли;
		
		ПараметрыОбработкиОшибок = ЭлектронноеВзаимодействиеКлиентСервер.НовыеПараметрыОбработкиОшибки();
		
		// Корневой элемент группы "АвтоматическиЗаполняемый" может содержать в себе
		// параметры обработки ошибки, которые могут быть добавлены в переопределяемой части.
		СтрокаДерева = ЭлектронноеВзаимодействие.СтрокаДерева(ДеревоДанных, Участник + ".Адрес.АвтоматическиЗаполняемый", Истина);
		ЗаполнитьЗначенияСвойств(ПараметрыОбработкиОшибок, СтрокаДерева);
		
		ТаблицаКонтактнаяИнформация = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(
			ОбъектКонтактнойИнформации, ВидКонтактнойИнформации, , Ложь);
			
		Если ТаблицаКонтактнаяИнформация.Количество() Тогда
			
			АдресСтрокойXML = ТаблицаКонтактнаяИнформация[0].ЗначенияПолей;
			АдресСтруктурой = РаботаСАдресами.СведенияОбАдресе(АдресСтрокойXML, Новый Структура("КодыАдреса", Ложь));
			СоответствуетФорматуКЛАДР = АдресСоответствуетФорматуКЛАДР(АдресСтруктурой);
			
			Если АдресСтруктурой.КодСтраны = "643" Тогда // Россия
				
				Если СоответствуетФорматуКЛАДР Тогда
					
					// Заполняем структурированный адрес.
					
					ПутьКАдресу = Участник + ПутьКСтруктурированномуАдресу;
					
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ".Индекс",       АдресСтруктурой.Индекс, ПараметрыОбработкиОшибок);
						
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ПолеКодРегиона,  АдресСтруктурой.КодРегиона, ПараметрыОбработкиОшибок);
						
					ПредставлениеЭлемента = ПредставлениеАдресногоЭлементаПоСоставляющим(АдресСтруктурой.Район, АдресСтруктурой.РайонСокращение);
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ".Район",        ПредставлениеЭлемента, ПараметрыОбработкиОшибок);
						
					ПредставлениеЭлемента = ПредставлениеАдресногоЭлементаПоСоставляющим(АдресСтруктурой.Город, АдресСтруктурой.ГородСокращение);
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ".Город",        ПредставлениеЭлемента, ПараметрыОбработкиОшибок);
						
					ПредставлениеЭлемента = ПредставлениеАдресногоЭлементаПоСоставляющим(АдресСтруктурой.НаселенныйПункт,
						АдресСтруктурой.НаселенныйПунктСокращение);
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ПолеНаселПункт,  ПредставлениеЭлемента, ПараметрыОбработкиОшибок);
						
					ПредставлениеЭлемента = ПредставлениеАдресногоЭлементаПоСоставляющим(АдресСтруктурой.Улица,
						АдресСтруктурой.УлицаСокращение);
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ".Улица",        ПредставлениеЭлемента, ПараметрыОбработкиОшибок);
						
					ПредставлениеЭлемента = ПредставлениеАдресногоЭлементаПоСоставляющим(НРег(АдресСтруктурой.Здание.ТипЗдания), "№",
						АдресСтруктурой.Здание.Номер);
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ".Дом",          ПредставлениеЭлемента, ПараметрыОбработкиОшибок);
						
					Если АдресСтруктурой.Корпуса.Количество() Тогда
						ПредставлениеЭлемента = ПредставлениеАдресногоЭлементаПоСоставляющим(НРег(АдресСтруктурой.Корпуса[0].ТипКорпуса),
							АдресСтруктурой.Корпуса[0].Номер);
					Иначе
						ПредставлениеЭлемента = "";
					КонецЕсли;
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ".Корпус",       ПредставлениеЭлемента, ПараметрыОбработкиОшибок);
						
					Если АдресСтруктурой.Помещения.Количество() Тогда
						ПредставлениеЭлемента = ПредставлениеАдресногоЭлементаПоСоставляющим(НРег(АдресСтруктурой.Помещения[0].ТипПомещения),
							АдресСтруктурой.Помещения[0].Номер);
					Иначе
						ПредставлениеЭлемента = "";
					КонецЕсли;
					ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
						ДеревоДанных, ПутьКАдресу + ПолеКвартира, ПредставлениеЭлемента, ПараметрыОбработкиОшибок);
						
				Иначе
					
					// Заполняем адрес в произвольной форме.
					
					ПутьКАдресу = Участник + ПутьКПроизвольномуАдресу;
					
					Если ЭтоУПД Тогда
						ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
							ДеревоДанных, ПутьКАдресу + ".КодСтраны", АдресСтруктурой.КодСтраны, ПараметрыОбработкиОшибок);
						
						ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
							ДеревоДанных, ПутьКАдресу + ".АдресТекст", АдресСтруктурой.Представление, ПараметрыОбработкиОшибок);
						
					Иначе
						ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
							ДеревоДанных, ПутьКАдресу, АдресСтруктурой.Представление, ПараметрыОбработкиОшибок);
						
					КонецЕсли;
					
				КонецЕсли;
				
			Иначе
				
				ПутьКАдресу = Участник + ".Адрес.Иностранный";
				
				ПолеКодСтраны  = ".КодСтраны";
				ПолеАдресТекст = ".АдресТекст";
				
				Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, ПутьКАдресу + ".КодСтр") Тогда
					ПолеКодСтраны  = ".КодСтр";
					ПолеАдресТекст = ".АдрТекст";
				КонецЕсли;
				
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДанных, ПутьКАдресу + ПолеКодСтраны,  АдресСтруктурой.КодСтраны, ПараметрыОбработкиОшибок);
				
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДанных, ПутьКАдресу + ПолеАдресТекст, АдресСтруктурой.Представление, ПараметрыОбработкиОшибок);
				
			КонецЕсли;
				
		Иначе
			
			// Не заполнена контактная информация.
			// Проставляем пустой произвольный адрес.
			
			ПутьКАдресу = Участник + ПутьКПроизвольномуАдресу;
			
			Если ЭтоУПД Тогда
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДанных, ПутьКАдресу + ".КодСтраны", "", ПараметрыОбработкиОшибок);
				
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДанных, ПутьКАдресу + ".АдресТекст", "", ПараметрыОбработкиОшибок);
				
			Иначе
				ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(
					ДеревоДанных, ПутьКАдресу, "", ПараметрыОбработкиОшибок);
				
			КонецЕсли;
			
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПредставлениеАдресногоЭлементаПоСоставляющим(ПервыйЭлемент = "", ВторойЭлемент = "", ТретийЭлемент = "")

	МассивСоставляющих = Новый Массив;
	Если ЗначениеЗаполнено(ПервыйЭлемент) Тогда
		МассивСоставляющих.Добавить(ПервыйЭлемент);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ВторойЭлемент) Тогда
		МассивСоставляющих.Добавить(ВторойЭлемент);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТретийЭлемент) Тогда
		МассивСоставляющих.Добавить(ТретийЭлемент);
	КонецЕсли;
	
	Возврат СтрСоединить(МассивСоставляющих, " ");

КонецФункции

#КонецОбласти

#Область ФормированиеТитуловДействующихФорматов

// Формирует электронный документ счет фактура по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - ссылка на объект ИБ, по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - параметры настроек обмена.
//  ПризнакЭД - Булево - признак того, что необходимо вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - реквизиты продавца.
//
Функция СформироватьИнформациюПродавца(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение  = Неопределено;
	СтруктураПараметров   = Новый Структура;
	РезультатФормирования = Ложь;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	// Сформируем и заполним структуру электронного документа.
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("КНД",            "1115125");
	СтруктураЭД.Вставить("ПрефиксИдФайла", "ON_SCHFDOPPR");
	СтруктураЭД.Вставить("ВидЭД",          НастройкиОбменаЭД.ВидЭД);
	
	// Сформируем структуру параметров для счет-фактуры и заполним ее.
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УПД_ИнформацияПродавца");
	
	Если НастройкиОбменаЭД.ВерсияФормата = "ФНС 5.01 (УПД:Счет-фактура и первичный документ)" Тогда
	
		СтруктураЭД.Вставить("Функция",                          "СЧФДОП");
		СтруктураЭД.Вставить("ПоФактХЖ",                         "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",              Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД);
		
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляУПДИнформацияПродавцаФНС(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
		
		ПодтверждениеОбязательно = Ложь;
		СтрокаСведенийОТоварах = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого СтрокаНомерСтроки Из СтрокаСведенийОТоварах.Строки Цикл
			ЗначениеПризнака = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(СтрокаНомерСтроки, "СведенияОТоварах.НомерСтроки.Признак", Ложь);
			Если Не ЗначениеЗаполнено(ЗначениеПризнака) Или ЗначениеПризнака <> "3" Тогда
				ПодтверждениеОбязательно = Истина; // это не услуга
				Прервать
			КонецЕсли;
		КонецЦикла;
		СтруктураЭД.Вставить("ПодтверждениеОбязательно", ПодтверждениеОбязательно);
		
		СтрокаСсылкиСчетаФактуры = Неопределено;
		СсылкаСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "СсылкаСчетаФактуры",, СтрокаСсылкиСчетаФактуры);
			
		МассивПервичныхДокументовУПД = Новый Массив;
		СтрокаДокументыОснования = ДеревоДанных.Строки.Найти("ДокументыОснованияСчетаФактуры", "ПолныйПуть");
		Если ЗначениеЗаполнено(СтрокаДокументыОснования.Значение) Тогда
			Если ТипЗнч(СтрокаДокументыОснования.Значение) = Тип("Массив") Тогда
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(
					МассивПервичныхДокументовУПД, СтрокаДокументыОснования.Значение, Истина);
			Иначе
				МассивПервичныхДокументовУПД.Добавить(СтрокаДокументыОснования.Значение);
			КонецЕсли;
			ОписаниеТиповОснованийЭД = Метаданные.ОпределяемыеТипы.ОснованияЭлектронныхДокументов.Тип;
			Индекс = МассивПервичныхДокументовУПД.Количество() - 1;
			Пока Индекс >=0 Цикл
				Документ = МассивПервичныхДокументовУПД.Получить(Индекс);
				ТипДокумента = ТипЗнч(Документ);
				Если ДокументЯвляетсяСчетомФактурой(Документ)
					ИЛИ НЕ ОписаниеТиповОснованийЭД.СодержитТип(ТипДокумента) Тогда
					
					МассивПервичныхДокументовУПД.Удалить(Индекс);
				КонецЕсли;
				Индекс = Индекс - 1;
			КонецЦикла;
		КонецЕсли;
		
		ОснованиеЭДПервичныйДокумент = НЕ ДокументЯвляетсяСчетомФактурой(СсылкаНаОбъект);
		ВидОперации = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидОперации");
		ВидСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидСчетаФактуры");
		Если СтруктураЭД.Функция = "СЧФ" ИЛИ СтруктураЭД.Функция = "ДОП" Тогда
			// Значение изменено в переопределяемой процедуре.
			
		ИначеЕсли ЗначениеЗаполнено(ВидСчетаФактуры) И ВидСчетаФактуры = "Авансовый" Тогда
			СтруктураЭД.Вставить("Функция", "СЧФ");
			
		ИначеЕсли ОснованиеЭДПервичныйДокумент
			И ЗначениеЗаполнено(ВидОперации) И ВидОперации = Перечисления.ВидыОперацийЭД.Комиссия Тогда
			СтруктураЭД.Вставить("Функция", "ДОП");
			
		ИначеЕсли ОснованиеЭДПервичныйДокумент
			И ДокументБезНДС(ДеревоДанных, "СведенияОТоварах.НомерСтроки.НалоговаяСтавка") Тогда
			СтруктураЭД.Вставить("Функция", "ДОП");
			
		ИначеЕсли ЗначениеЗаполнено(СсылкаСчетаФактуры)
			И СсылкаНаОбъект = СсылкаСчетаФактуры
			И ЕстьАктуальныеЭД(МассивПервичныхДокументовУПД) Тогда
			// Когда УПД формируется на основании счета-фактуры,
			// И у первичного документа уже существует электронный документ,
			// Тогда изменяем функцию на "СЧФ".
			СтруктураЭД.Вставить("Функция", "СЧФ");
			
		ИначеЕсли ОснованиеЭДПервичныйДокумент
			И ЗначениеЗаполнено(СсылкаСчетаФактуры)
			И ЕстьАктуальныеЭД(СсылкаСчетаФактуры) Тогда
			// Когда УПД формируется на основании первичного документа,
			// И у счета-фактуры уже существует электронный документ,
			// Тогда изменяем функцию на "ДОП".
			СтруктураЭД.Вставить("Функция", "ДОП");
			
		КонецЕсли;
		
		Если СтруктураЭД.Функция = "ДОП"
			И ОснованиеЭДПервичныйДокумент
			И ЗначениеЗаполнено(СсылкаСчетаФактуры) Тогда
			// Когда дерево заполнено по данным счета-фактуры,
			// И значение функции изменено на "ДОП",
			// Тогда необходимо перезаполнить дерево данными первичного документа.
			НастройкиОбменаЭД.ВерсияФормата = "ФНС 5.01 (УПД:Первичный документ)";
			ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УПД_ИнформацияПродавца");
		КонецЕсли;
		
		Если СтруктураЭД.Функция <> "ДОП"
			И НЕ ЗначениеЗаполнено(СсылкаСчетаФактуры) Тогда
			ТекстОшибки = НСтр("ru = 'не выписан счет-фактура'");
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки, СтрокаСсылкиСчетаФактуры, ТекстОшибки, Ложь);
		КонецЕсли;
		
		Если Ошибки = Неопределено Тогда
			
			Если ЗначениеЗаполнено(СсылкаСчетаФактуры)
				И ОснованиеЭДПервичныйДокумент Тогда
				// Передаем ссылку на счет-фактуру для исключения дублирования УПД.
				СтруктураПараметров.Вставить("СчетФактураБезФормированияЭД", СсылкаСчетаФактуры);
			КонецЕсли;
			
			Если СтруктураЭД.Функция = "СЧФ" Тогда
				СтруктураЭД.Вставить("ПоФактХЖ", "");
				СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", "");
				СтруктураЭД.Вставить("ТипЭлементаВерсииЭД", Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД);
				СтруктураЭД.Вставить("ПодтверждениеОбязательно", Ложь);
				
			ИначеЕсли СтруктураЭД.Функция = "ДОП" Тогда
				СтруктураЭД.Вставить("ПоФактХЖ",   "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
				СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (Документ об оказании услуг)");
				СтруктураЭД.Вставить("ТипЭлементаВерсииЭД", Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД);
				Если НЕ НастройкиОбменаЭД.Свойство("ВидПервичногоДокумента", СтруктураЭД.ВидЭД) Тогда
					СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.ТОРГ12Продавец);
				КонецЕсли;
				
			Иначе
				СтруктураЭД.Вставить("НомерЭД", ВернутьИдЭД(СсылкаСчетаФактуры));
				Если СсылкаНаОбъект <> СсылкаСчетаФактуры Тогда
					СтруктураЭД.ДокументыОснования.Добавить(СсылкаСчетаФактуры);
				КонецЕсли;
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(СтруктураЭД.ДокументыОснования, МассивПервичныхДокументовУПД, Истина);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если Ошибки = Неопределено И НастройкиОбменаЭД.ВерсияФормата = "ФНС 5.01 (УПД:Счет-фактура)" Тогда
		СтруктураЭД.Вставить("Функция",                         "СЧФ");
		СтруктураЭД.Вставить("ПоФактХЖ",                        "");
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя","");
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",             Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД);
		
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляСЧФИнформацияПродавцаФНС(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	КонецЕсли;
	
	Если Ошибки = Неопределено И НастройкиОбменаЭД.ВерсияФормата = "ФНС 5.01 (УПД:Первичный документ)" Тогда
		СтруктураЭД.Вставить("Функция",                          "ДОП");
		СтруктураЭД.Вставить("ПоФактХЖ",                         "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (Документ об оказании услуг)");
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",              Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД);
		
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляДОПИнформацияПродавцаФНС(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	КонецЕсли;
	
	// Заполнение адресов.
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("СведенияОПеревозчике");
	УчастникиСделки.Добавить("СведенияОПродавце");
	УчастникиСделки.Добавить("СведенияОГрузоотправителе.Грузоотправитель");
	УчастникиСделки.Добавить("СведенияОГрузополучателе");
	УчастникиСделки.Добавить("СведенияОПокупателе");
	УчастникиСделки.Добавить("СведенияОКомиссионере");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных, Истина);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки, Истина);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьИнформациюПродавца(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	// Если проверка прошла успешно, дополним дерево данных служебными данными и сформируем XML-файл.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		СтруктураЭД.Вставить("НомерДокументаОтправителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "НомерДокумента"));
		СтруктураЭД.Вставить("ДатаДокументаОтправителя",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ДатаДокумента"));
		НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления", Ложь);
		Если ЗначениеЗаполнено(НомерИсправления) Тогда
			ШаблонНомера = НСтр("ru = '%1 (испр. %2)'");
			НомерСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента");
			НомерДокументаОтправителя = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
											ШаблонНомера, НомерСчетаФактуры, НомерИсправления);
			СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
		КонецЕсли;
		
		ДобавитьСлужебныеПоляФНС(ДеревоДанных, СтруктураЭД);
		
		ВставитьЗначениеВДерево(ДеревоДанных, "Функция", СтруктураЭД.Функция);
		ВставитьЗначениеВДерево(ДеревоДанных, "НаименованиеДокументаОтправителя", СтруктураЭД.НаименованиеДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "ПоФактХЖ", СтруктураЭД.ПоФактХЖ);
		
		ТекстоваяИнформация = Новый ТаблицаЗначений;
		ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
		ТекстоваяИнформация.Колонки.Добавить("Значение");
		
		СтрокаДокументыОснования = ДеревоДанных.Строки.Найти("ДокументыОснованияСчетаФактуры", "ПолныйПуть");
		Если ЗначениеЗаполнено(СтрокаДокументыОснования.Значение) Тогда
			ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(СтрокаДокументыОснования.Значение, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
			
			Для каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
				Если ЗначениеЗаполнено(Строка.Наименование) Тогда
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "ИДЭДДокументаОснования";
					НоваяСтрока.Значение = Строка.Наименование;
					ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Строка.ИдентификаторДокументаОснования) Тогда
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "ИдентификаторДокументаОснования";
					НоваяСтрока.Значение = Строка.ИдентификаторДокументаОснования;
					ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		ВидСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВидСчетаФактуры");
		Если ЗначениеЗаполнено(ВидСчетаФактуры)Тогда
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ВидСчетаФактуры";
			НоваяСтрока.Значение = ВидСчетаФактуры;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		КонецЕсли;
		ТолькоУслуги = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги");
		Если ЗначениеЗаполнено(ТолькоУслуги)Тогда
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ТолькоУслуги";
			НоваяСтрока.Значение = ТолькоУслуги;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОКомиссионере")) Тогда
			СвКомиссионера = ПолучитьОбъектТипаCML("УчастникТип", "ON_SCHFDOPPR");
			ЗаполнитьСведенияОбУчастникеУПД(СвКомиссионера, ДеревоДанных, Ошибки, "ON_SCHFDOPPR", "СведенияОКомиссионере");
			
			ЗаписьXML = Новый ЗаписьXML;
			ЗаписьXML.УстановитьСтроку();
			ФабрикаXDTO.ЗаписатьXML(ЗаписьXML, СвКомиссионера);
			
			СтрXML = ЗаписьXML.Закрыть();
			НачПоз = СтрНайти(СтрXML, "<ИдСв>");
			КолСимв = СтрНайти(СтрXML, "</ИдСв>") - НачПоз + СтрДлина("</ИдСв>");
			СтрXML = Сред(СтрXML, НачПоз, КолСимв);
			
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ДанныеКомиссионера";
			НоваяСтрока.Значение = СтрXML;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		КонецЕсли;
		
		СтрокаДокументыОснования = ДеревоДанных.Строки.Найти("ДокументыОснованияДокументаОтгрузки", "ПолныйПуть");
		Если ЗначениеЗаполнено(СтрокаДокументыОснования.Значение) Тогда
			ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(СтрокаДокументыОснования.Значение, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
			
			Для каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
				Если ЗначениеЗаполнено(Строка.Наименование) Тогда
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "ИДЭДДокументаОснования";
					НоваяСтрока.Значение = Строка.Наименование;
					ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеДокументаОтгрузки.ТекстоваяИнформация");
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Строка.ИдентификаторДокументаОснования) Тогда
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "ИдентификаторДокументаОснования";
					НоваяСтрока.Значение = Строка.ИдентификаторДокументаОснования;
					ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеДокументаОтгрузки.ТекстоваяИнформация");
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		ИныеСведенияОбОтгрузке = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИныеСведенияОбОтгрузке");
		Если ЗначениеЗаполнено(ИныеСведенияОбОтгрузке) Тогда
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ИныеСведенияОбОтгрузке";
			НоваяСтрока.Значение = ИныеСведенияОбОтгрузке;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеДокументаОтгрузки.ТекстоваяИнформация");
		КонецЕсли;
		
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
			ДокументОснование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ДокументОснование");
			Если ЗначениеЗаполнено(ДокументОснование) Тогда
				ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(ДокументОснование, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
				Для Каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
					Если ЗначениеЗаполнено(Строка.Наименование) Тогда
						НоваяСтрока = ТекстоваяИнформация.Добавить();
						НоваяСтрока.Идентификатор = "ИДЭДДокументаОснования";
						НоваяСтрока.Значение = Строка.Наименование;
						ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(Товар, НоваяСтрока, "СведенияОТоварах.НомерСтроки.ТекстоваяИнформация");
					КонецЕсли;
						
					Если ЗначениеЗаполнено(Строка.ИдентификаторДокументаОснования) Тогда
						НоваяСтрока = ТекстоваяИнформация.Добавить();
						НоваяСтрока.Идентификатор = "ИдентификаторДокументаОснования";
						НоваяСтрока.Значение = Строка.ИдентификаторДокументаОснования;
						ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(Товар, НоваяСтрока, "СведенияОТоварах.НомерСтроки.ТекстоваяИнформация");
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			// Формирование идентификатора товара.
			ИД = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ИдТовараУКонтрагента");
			Если НЕ ЗначениеЗаполнено(ИД) Тогда
				ТоварИдентификатор = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ТоварИдентификатор");
				// Оставлено для совместимости.
				ИД = Строка(ТоварИдентификатор) + "##";
			КонецЕсли;
			
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ИД";
			НоваяСтрока.Значение = ИД;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(Товар, НоваяСтрока, "СведенияОТоварах.НомерСтроки.ТекстоваяИнформация");
			
		КонецЦикла;
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", АдресКаталога + ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл") + ".xml");
		
		РезультатФормирования = СформироватьИнформациюПродавцаXML(ДеревоДанных);
	КонецЕсли;
	
	// Если все предыдущие этапы пройдены успешно, сформируем возвращаемое значение.
	Если РезультатФормирования И ПризнакЭД Тогда
		СуммаДокумента = 0;
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
			СуммаТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
			Если Не ЗначениеЗаполнено(СуммаТовара) Тогда
				СуммаТовараБезНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
				Если СуммаТовараБезНалога = Неопределено Тогда
					СуммаТовараБезНалога = 0;
				КонецЕсли;
				СуммаНалогаПоТовару = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					Товар, "СведенияОТоварах.НомерСтроки.СуммаНалога");
				Если СуммаНалогаПоТовару = Неопределено Тогда
					СуммаНалогаПоТовару = 0;
				КонецЕсли;
				СуммаТовара = СуммаТовараБезНалога + СуммаНалогаПоТовару;
			КонецЕсли;
			СуммаДокумента = СуммаДокумента + СуммаТовара;
		КонецЦикла;
		СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
			СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
		КонецЕсли;
		СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
		СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
		СтруктураПараметров.Вставить("ПолноеИмяФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		СтруктураПараметров.Вставить("УникальныйИдентификатор", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УникальныйИдентификатор"));
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ПолноеИмяДопФайла") Тогда
			СтруктураПараметров.Вставить("ПолноеИмяДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяДопФайла"));
			СтруктураПараметров.Вставить("ИдентификаторДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдентификаторДопФайла"));
		КонецЕсли;
		ВозвращаемоеЗначение = СтруктураПараметров;
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирует электронный документ расходной накладной (титул покупателя) по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаФайлНаЭД - Ссылка - ссылка на ЭД, по которому необходимо сформировать электронный документ.
//
// Возвращаемое значение:
//  Структура - структура электронного документа.
//
Функция СформироватьИнформациюПокупателя(СсылкаФайлНаЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	РеквизитыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаФайлНаЭД, "НаименованиеФайла, ВладелецФайла,
		|ОтправительЭД, ПолучательЭД, ДатаФормированияЭДОтправителем");
		
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО, НастройкаЭДО, Контрагент,
		|НомерДокументаОтправителя, ДатаДокументаОтправителя, НаименованиеДокументаОтправителя, Организация, СуммаДокумента, ТипЭлементаВерсииЭД");
	
	СтруктураЭД = Новый Структура; // для создания ЭДПрисоединенныеФайлы
	СтруктураЭД.Вставить("НаправлениеЭД",                    Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("НомерЭД",                          Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("УникальныйИдентификатор",          Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("Получатель",                       РеквизитыФайлаЭД.ОтправительЭД);
	СтруктураЭД.Вставить("ДатаЭД",                           ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Отправитель",                      РеквизитыФайлаЭД.ПолучательЭД);
	СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыФайлаЭД.НаименованиеФайла);
	СтруктураЭД.Вставить("ВладелецЭД",                       РеквизитыФайлаЭД.ВладелецФайла);
	СтруктураЭД.Вставить("Организация",                      РеквизитыЭД.Организация);
	СтруктураЭД.Вставить("Контрагент",                       РеквизитыЭД.Контрагент);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",               РеквизитыЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",                     РеквизитыЭД.НастройкаЭДО);
	СтруктураЭД.Вставить("ПрефиксИдФайла",                   "ON_SCHFDOPPOK");
	СтруктураЭД.Вставить("КНД",                              "1115126");
	
	Если РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД Тогда
		СтруктураЭД.Вставить("ВидЭД",      Перечисления.ВидыЭД.СчетФактура);
		СтруктураЭД.Вставить("Функция",    "СЧФДОП");
		
	ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД Тогда
		СтруктураЭД.Вставить("ВидЭД",      Перечисления.ВидыЭД.СчетФактура);
		СтруктураЭД.Вставить("Функция",    "СЧФ");
	
	ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
		СтруктураЭД.Вставить("ВидЭД",      Перечисления.ВидыЭД.ТОРГ12Покупатель);
		СтруктураЭД.Вставить("Функция",    "ДОП");
	
	КонецЕсли;
	
	СтруктураЭД.Вставить("НомерДокументаОтправителя",        РеквизитыЭД.НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",         РеквизитыЭД.ДатаДокументаОтправителя);
	СтруктураЭД.Вставить("СуммаДокумента",                   РеквизитыЭД.СуммаДокумента);
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УПД_ИнформацияПокупателя");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляУПДИнформацииПокупателяФНС(СсылкаФайлНаЭД, СтруктураЭД, ДеревоДокумента, Отказ);
	
	// Заполним наименование первичного документа - такое же, как в титуле продавца.
	НаименованиеДокументаОтправителя = РеквизитыЭД.НаименованиеДокументаОтправителя;
	Если Не ЗначениеЗаполнено(НаименованиеДокументаОтправителя) Тогда
		Если РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД Тогда
			НаименованиеДокументаОтправителя = "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)";
		ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД Тогда
			НаименованиеДокументаОтправителя = "";
		ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД Тогда
			НаименованиеДокументаОтправителя = "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)";	
		КонецЕсли;
	КонецЕсли;
	СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", НаименованиеДокументаОтправителя);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки, Истина);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
		ДобавитьСлужебныеПоляФНС(ДеревоДокумента, СтруктураЭД);
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "Функция",                          СтруктураЭД.Функция);
		ВставитьЗначениеВДерево(ДеревоДокумента, "НаименованиеДокументаОтправителя", СтруктураЭД.НаименованиеДокументаОтправителя);
		
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ДатаФайлаИнфПр",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДЛФ=D"));
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ВремФайлаИнфПр",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДФ=HH.mm.ss"));
								
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИдФайлаИнфПр", РеквизитыФайлаЭД.НаименованиеФайла);
		ВставитьЗначениеВДерево(ДеревоДокумента, "НомерИнфПр", РеквизитыЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаИнфПр",  РеквизитыЭД.ДатаДокументаОтправителя);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаФайлНаЭД.УникальныйИдентификатор());
		ИдФайл = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, "ИдФайл");
		
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолученныеЭП", ЭППолученногоФайла(СсылкаФайлНаЭД));
		
		Если СформироватьИнформациюПокупателяXML(ДеревоДокумента) Тогда
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(СтруктураПараметров.ПолноеИмяФайла));
			СтруктураЭД.Вставить("ИдФайла", ИдФайл);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			ВозвращаемоеЗначение = СтруктураЭД;
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(АдресКаталога);
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаФайлНаЭД);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирует электронный документ расходной накладной (титул покупателя) по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаФайлНаЭД - Ссылка - ЭД, по которому необходимо сформировать электронный документ.
//
// Возвращаемое значение:
//  Структура - реквизиты покупателя УКД.
//
Функция СформироватьИнформациюПокупателяУКД(СсылкаФайлНаЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	РеквизитыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаФайлНаЭД, "НаименованиеФайла, ВладелецФайла,
		|ОтправительЭД, ПолучательЭД, ДатаФормированияЭДОтправителем");
		
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО, НастройкаЭДО, Контрагент,
		|НомерДокументаОтправителя, ДатаДокументаОтправителя, НаименованиеДокументаОтправителя, Организация, СуммаДокумента, ТипЭлементаВерсииЭД");
	
	СтруктураЭД = Новый Структура; // для создания ЭДПрисоединенныеФайлы
	СтруктураЭД.Вставить("НаправлениеЭД",                    Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("НомерЭД",                          Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("УникальныйИдентификатор",          Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("Получатель",                       РеквизитыФайлаЭД.ОтправительЭД);
	СтруктураЭД.Вставить("ДатаЭД",                           ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Отправитель",                      РеквизитыФайлаЭД.ПолучательЭД);
	СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыФайлаЭД.НаименованиеФайла);
	СтруктураЭД.Вставить("ВладелецЭД",                       РеквизитыФайлаЭД.ВладелецФайла);
	СтруктураЭД.Вставить("Организация",                      РеквизитыЭД.Организация);
	СтруктураЭД.Вставить("Контрагент",                       РеквизитыЭД.Контрагент);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",               РеквизитыЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",                     РеквизитыЭД.НастройкаЭДО);
	СтруктураЭД.Вставить("ПрефиксИдФайла",                   "ON_KORSCHFDOPPOK");
	СтруктураЭД.Вставить("КНД",                              "1115128");
	
	Если РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД Тогда
		СтруктураЭД.Вставить("ВидЭД",      Перечисления.ВидыЭД.КорректировочныйСчетФактура);
		СтруктураЭД.Вставить("Функция",    "КСЧФДИС");
		
	ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД Тогда
		СтруктураЭД.Вставить("ВидЭД",      Перечисления.ВидыЭД.КорректировочныйСчетФактура);
		СтруктураЭД.Вставить("Функция",    "КСЧФ");
	
	ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД Тогда
		СтруктураЭД.Вставить("ВидЭД",      Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель);
		СтруктураЭД.Вставить("Функция",    "ДИС");
	
	КонецЕсли;
	
	СтруктураЭД.Вставить("НомерДокументаОтправителя",        РеквизитыЭД.НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",         РеквизитыЭД.ДатаДокументаОтправителя);
	СтруктураЭД.Вставить("СуммаДокумента",                   РеквизитыЭД.СуммаДокумента);
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УКД_ИнформацияПокупателя");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляУКДИнформацииПокупателяФНС(СсылкаФайлНаЭД, СтруктураЭД, ДеревоДокумента, Отказ);

	НаименованиеДокументаОтправителя = РеквизитыЭД.НаименованиеДокументаОтправителя;
	Если Не ЗначениеЗаполнено(НаименованиеДокументаОтправителя) Тогда
		Если РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД Тогда
			НаименованиеДокументаОтправителя = "Корректировочный счет-фактура и документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав";
		ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД Тогда
			НаименованиеДокументаОтправителя = "";
		ИначеЕсли РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД Тогда
			НаименованиеДокументаОтправителя = "Документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав";
		КонецЕсли;
	КонецЕсли;
	СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", НаименованиеДокументаОтправителя);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки, Истина);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
		ДобавитьСлужебныеПоляФНС(ДеревоДокумента, СтруктураЭД);
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "Функция",                          СтруктураЭД.Функция);
		ВставитьЗначениеВДерево(ДеревоДокумента, "НаименованиеДокументаОтправителя", СтруктураЭД.НаименованиеДокументаОтправителя);
		
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ДатаФайлаИнфПр",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДЛФ=D"));
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ВремФайлаИнфПр",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДФ=HH.mm.ss"));
								
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИдФайлаИнфПр", РеквизитыФайлаЭД.НаименованиеФайла);
		ВставитьЗначениеВДерево(ДеревоДокумента, "НомерИнфПр", РеквизитыЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаИнфПр",  РеквизитыЭД.ДатаДокументаОтправителя);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаФайлНаЭД.УникальныйИдентификатор());
		ИдФайл = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, "ИдФайл");
		
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолученныеЭП", ЭППолученногоФайла(СсылкаФайлНаЭД));
		
		Если СформироватьИнформациюПокупателяУКДXML(ДеревоДокумента) Тогда
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(СтруктураПараметров.ПолноеИмяФайла));
			СтруктураЭД.Вставить("ИдФайла", ИдФайл);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			ВозвращаемоеЗначение = СтруктураЭД;
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(АдресКаталога);
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаФайлНаЭД);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирует элемент справочника ЭДПрисоединенныеФайлы для ТОРГ-12 покупатель.
//
// Параметры:
//  СсылкаНаЭД - СправочникСсылка - ссылка на новый элемент.
//
// Возвращаемое значение:
//  Ссылка - заполненный электронный документ.
//
Функция СформироватьЭДИнформацияПокупателя(СсылкаНаЭД) Экспорт
	
	ДобавленныйФайл = Неопределено;
	АдресВоВременномХранилище = "";
	
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
							СсылкаНаЭД,
							"ВладелецФайла, УникальныйИД, НаименованиеФайла");
	
	СтруктураЭД = СформироватьИнформациюПокупателя(СсылкаНаЭД);
	
	Если ТипЗнч(СтруктураЭД) = Тип("Структура") И СтруктураЭД.Свойство("АдресВоВременномХранилище", АдресВоВременномХранилище) Тогда
		ДатаСозданияФайла = ТекущаяДатаСеанса();
		
		ПараметрыФайла = Новый Структура();
		ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
		ПараметрыФайла.Вставить("ВладелецФайлов", РеквизитыЭД.ВладелецФайла);
		ПараметрыФайла.Вставить("ИмяБезРасширения", СтруктураЭД.ИдФайла);
		ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
		ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");
		
		ДобавленныйФайл = РаботаСФайлами.ДобавитьФайл(
			ПараметрыФайла, АдресВоВременномХранилище, , , Справочники.ЭДПрисоединенныеФайлы.ПолучитьСсылку());
	
		СтруктураЭД.Вставить("СтатусЭД",                       Перечисления.СтатусыЭД.Утвержден);
		СтруктураЭД.Вставить("УникальныйИД",                   РеквизитыЭД.УникальныйИД);
		СтруктураЭД.Вставить("ЭлектронныйДокументВладелец",    СсылкаНаЭД);
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",            Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУПД);
		СтруктураЭД.Вставить("ДатаФормированияЭДОтправителем", ДатаСозданияФайла);
		СтруктураЭД.Вставить("НаименованиеФайла",              СтруктураЭД.ИдФайла);
		
		ОбменСКонтрагентамиСлужебный.ИзменитьПоСсылкеПрисоединенныйФайл(ДобавленныйФайл, СтруктураЭД);
	КонецЕсли;
	
	Возврат ДобавленныйФайл;
	
КонецФункции

// Формирует электронный документ счет фактура по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - ссылка на объект ИБ, по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - параметры обмена.
//  ПризнакЭД - Булево - признак того, что необходимо вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - реквизиты продавца УКД.
//
Функция СформироватьИнформациюПродавцаУКД(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение  = Неопределено;
	СтруктураПараметров   = Новый Структура;
	РезультатФормирования = Ложь;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	// Сформируем и заполним структуру электронного документа.
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("КНД",            "1115127");
	СтруктураЭД.Вставить("ПрефиксИдФайла", "ON_KORSCHFDOPPR");
	СтруктураЭД.Вставить("ВидЭД",          НастройкиОбменаЭД.ВидЭД);
	
	// Сформируем структуру параметров для счет-фактуры и заполним ее.
	АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.УКД_ИнформацияПродавца");
	
	Если НастройкиОбменаЭД.ВерсияФормата = "ФНС 5.01 (УКД:Корректировочный счет-фактура и первичный документ)" Тогда
	
		СтруктураЭД.Вставить("Функция", "КСЧФДИС");
		СтруктураЭД.Вставить("ПоФактХЖ", "Документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав");
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", "Корректировочный счет-фактура и документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав");
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД", Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД);
		
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляУКДИнформацияПродавцаФНС(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
		
		СтрокаСсылкиКорректировочногоСчетаФактуры = Неопределено;
		СсылкаКорректировочногоСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных,
			"СсылкаКорректировочногоСчетаФактуры",, СтрокаСсылкиКорректировочногоСчетаФактуры);
		Если ЗначениеЗаполнено(СсылкаКорректировочногоСчетаФактуры) Тогда
			СтруктураЭД.Вставить("НомерЭД",    ВернутьИдЭД(СсылкаКорректировочногоСчетаФактуры));
			
			ДокументыОснования = Новый Массив;
			ДокументыОснования.Добавить(СсылкаКорректировочногоСчетаФактуры);
			СтруктураЭД.Вставить("ДокументыОснования", ДокументыОснования);
			
			МассивПервичныхДокументовУКД = Новый Массив;
			СтрокаДокументыОснования = ДеревоДанных.Строки.Найти("ДокументыОснованияСчетаФактуры", "ПолныйПуть");
			Если ЗначениеЗаполнено(СтрокаДокументыОснования.Значение) Тогда
				Если ТипЗнч(СтрокаДокументыОснования.Значение) = Тип("Массив") Тогда
					МассивПервичныхДокументовУКД = ОбщегоНазначенияКлиентСервер.СкопироватьМассив(СтрокаДокументыОснования.Значение);
				Иначе
					МассивПервичныхДокументовУКД.Добавить(СтрокаДокументыОснования.Значение);
				КонецЕсли;
				Индекс = МассивПервичныхДокументовУКД.Количество() - 1;
				Пока Индекс >=0 Цикл
					Документ = МассивПервичныхДокументовУКД.Получить(Индекс);
					Если НЕ ДокументЯвляетсяСчетомФактурой(Документ) Тогда
						СтруктураЭД.ДокументыОснования.Добавить(Документ);
					КонецЕсли;
					Индекс = Индекс - 1;
				КонецЦикла;
			КонецЕсли;
			
			Если НЕ ДокументЯвляетсяСчетомФактурой(СсылкаНаОбъект) Тогда
				СтруктураПараметров.Вставить("СчетФактураБезФормированияЭД", СсылкаКорректировочногоСчетаФактуры);
			КонецЕсли;
		Иначе
			ТекстОшибки = НСтр("ru = 'не выписан корректировочный счет-фактура'");
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьОшибкуПроверкиДереваДанных(Ошибки,
				СтрокаСсылкиКорректировочногоСчетаФактуры, ТекстОшибки, Ложь);
		КонецЕсли;
		
	ИначеЕсли НастройкиОбменаЭД.ВерсияФормата = "ФНС 5.01 (УКД:Корректировочный счет-фактура)" Тогда
		СтруктураЭД.Вставить("Функция", "КСЧФ");
		СтруктураЭД.Вставить("ПоФактХЖ", "");
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", "");
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД", Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД);
		
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляКСЧФИнформацияПродавцаФНС(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	ИначеЕсли НастройкиОбменаЭД.ВерсияФормата = "ФНС 5.01 (УКД:Первичный документ)" Тогда
		СтруктураЭД.Вставить("Функция", "ДИС");
		СтруктураЭД.Вставить("ПоФактХЖ", "Документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав");
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", "Документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав");
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД", Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД);
		
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеДляДИСИнформацияПродавцаФНС(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	КонецЕсли;
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("СведенияОПродавце");
	УчастникиСделки.Добавить("СведенияОПокупателе");
	УчастникиСделки.Добавить("СведенияОКомиссионере");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных, Истина);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки, Истина);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьИнформациюПродавцаУКД(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		СтруктураЭД.Вставить("НомерДокументаОтправителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "НомерДокумента"));
		СтруктураЭД.Вставить("ДатаДокументаОтправителя",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
			ДеревоДанных, "ДатаДокумента"));
		НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления", Ложь);
		Если ЗначениеЗаполнено(НомерИсправления) Тогда
			ШаблонНомера = НСтр("ru = '%1 (испр. %2)'");
			НомерСчетаФактуры = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерДокумента");
			НомерДокументаОтправителя = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
											ШаблонНомера, НомерСчетаФактуры, НомерИсправления);
			СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
		КонецЕсли;
		
		ДобавитьСлужебныеПоляФНС(ДеревоДанных, СтруктураЭД);
		
		ВставитьЗначениеВДерево(ДеревоДанных, "Функция",    СтруктураЭД.Функция);
		ВставитьЗначениеВДерево(ДеревоДанных, "НаименованиеДокументаОтправителя", СтруктураЭД.НаименованиеДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "ПоФактХЖ",   СтруктураЭД.ПоФактХЖ);
		
		ТекстоваяИнформация = Новый ТаблицаЗначений;
		ТекстоваяИнформация.Колонки.Добавить("Идентификатор");
		ТекстоваяИнформация.Колонки.Добавить("Значение");
		
		ТолькоУслуги = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ТолькоУслуги");
		Если ЗначениеЗаполнено(ТолькоУслуги)Тогда
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ТолькоУслуги";
			НоваяСтрока.Значение = ТолькоУслуги;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		КонецЕсли;
		
		СтрокаДокументыОснования = ДеревоДанных.Строки.Найти("ДокументыОснованияСчетаФактуры", "ПолныйПуть");
		Если ЗначениеЗаполнено(СтрокаДокументыОснования.Значение) Тогда
			ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(
				СтрокаДокументыОснования.Значение, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
			
			Для каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
				Если ЗначениеЗаполнено(Строка.Наименование) Тогда
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "ИДЭДДокументаОснования";
					НоваяСтрока.Значение = Строка.Наименование;
					ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(
						ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Строка.ИдентификаторДокументаОснования) Тогда
					НоваяСтрока = ТекстоваяИнформация.Добавить();
					НоваяСтрока.Идентификатор = "ИдентификаторДокументаОснования";
					НоваяСтрока.Значение = Строка.ИдентификаторДокументаОснования;
					ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(
						ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СведенияОКомиссионере")) Тогда
			СвКомиссионера = ПолучитьОбъектТипаCML("СвПродПокТип", "ON_KORSCHFDOPPR");
			ЗаполнитьСведенияОбУчастникеУКД(СвКомиссионера, ДеревоДанных, Ошибки, "ON_KORSCHFDOPPR", "СведенияОКомиссионере");
			
			ЗаписьXML = Новый ЗаписьXML;
			ЗаписьXML.УстановитьСтроку();
			ФабрикаXDTO.ЗаписатьXML(ЗаписьXML, СвКомиссионера);
			
			СтрXML = ЗаписьXML.Закрыть();
			НачПоз = СтрНайти(СтрXML, "<ИдСв>");
			КолСимв = СтрНайти(СтрXML, "</ИдСв>") - НачПоз + СтрДлина("</ИдСв>");
			СтрXML = Сред(СтрXML, НачПоз, КолСимв);
			
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ДанныеКомиссионера";
			НоваяСтрока.Значение = СтрXML;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(ДеревоДанных, НоваяСтрока, "ДопДанныеСчетаФактуры.ТекстоваяИнформация");
		КонецЕсли;
		
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
			ДокументОснование = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				Товар, "СведенияОТоварах.НомерСтроки.ДокументОснование");
			Если ЗначениеЗаполнено(ДокументОснование) Тогда
				ТаблицаПараметровДокументовОснований = ПолучитьПараметрыДокументовОснований(
					ДокументОснование, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
				Для Каждого Строка Из ТаблицаПараметровДокументовОснований Цикл
					Если ЗначениеЗаполнено(Строка.Наименование) Тогда
						НоваяСтрока = ТекстоваяИнформация.Добавить();
						НоваяСтрока.Идентификатор = "ИДЭДДокументаОснования";
						НоваяСтрока.Значение = Строка.Наименование;
						ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(
							Товар, НоваяСтрока, "СведенияОТоварах.НомерСтроки.ТекстоваяИнформация");
					КонецЕсли;
						
					Если ЗначениеЗаполнено(Строка.ИдентификаторДокументаОснования) Тогда
						НоваяСтрока = ТекстоваяИнформация.Добавить();
						НоваяСтрока.Идентификатор = "ИдентификаторДокументаОснования";
						НоваяСтрока.Значение = Строка.ИдентификаторДокументаОснования;
						ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(
							Товар, НоваяСтрока, "СведенияОТоварах.НомерСтроки.ТекстоваяИнформация");
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			// Формирование идентификатора товара.
			ИД = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ИдТовараУКонтрагента");
			Если НЕ ЗначениеЗаполнено(ИД) Тогда
				ТоварИдентификатор = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Товар, "СведенияОТоварах.НомерСтроки.ТоварИдентификатор");
				ИД = Строка(ТоварИдентификатор) + "##";
			КонецЕсли;
			
			НоваяСтрока = ТекстоваяИнформация.Добавить();
			НоваяСтрока.Идентификатор = "ИД";
			НоваяСтрока.Значение = ИД;
			ЭлектронноеВзаимодействие.ДобавитьЗаписьВТаблицуДерева(
				Товар, НоваяСтрока, "СведенияОТоварах.НомерСтроки.ТекстоваяИнформация");
			
		КонецЦикла;
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла",
			АдресКаталога + ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл") + ".xml");
		
		РезультатФормирования = СформироватьИнформациюПродавцаУКДXML(ДеревоДанных);
	КонецЕсли;
	
	Если РезультатФормирования И ПризнакЭД Тогда
		СуммаДокумента = 0;
		СтрокаТаблицаТоваров = ДеревоДанных.Строки.Найти("СведенияОТоварах", "ПолныйПуть");
		Для Каждого Товар Из СтрокаТаблицаТоваров.Строки Цикл
			СуммаТовара = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
				Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровСНалогом");
			Если Не ЗначениеЗаполнено(СуммаТовара) Тогда
				СуммаТовараБезНалога = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					Товар, "СведенияОТоварах.НомерСтроки.СтоимостьТоваровБезНалога");
				Если СуммаТовараБезНалога = Неопределено Тогда
					СуммаТовараБезНалога = 0;
				КонецЕсли;
				СуммаНалогаПоТовару = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(
					Товар, "СведенияОТоварах.НомерСтроки.СуммаНалога");
				Если СуммаНалогаПоТовару = Неопределено Тогда
					СуммаНалогаПоТовару = 0;
				КонецЕсли;
				СуммаТовара = СуммаТовараБезНалога + СуммаНалогаПоТовару;
			КонецЕсли;
			СуммаДокумента = СуммаДокумента + СуммаТовара;
		КонецЦикла;
		СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
		Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
			СтруктураЭД.Вставить("ДополнительнаяИнформация",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
		КонецЕсли;
		СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
		СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
		СтруктураПараметров.Вставить("ПолноеИмяФайла",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
		СтруктураПараметров.Вставить("УникальныйИдентификатор",
			ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УникальныйИдентификатор"));
		Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ПолноеИмяДопФайла") Тогда
			СтруктураПараметров.Вставить("ПолноеИмяДопФайла",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяДопФайла"));
			СтруктураПараметров.Вставить("ИдентификаторДопФайла",
				ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдентификаторДопФайла"));
		КонецЕсли;
		ВозвращаемоеЗначение = СтруктураПараметров;
	КонецЕсли;
		
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирует элемент справочника ЭДПрисоединенныеФайлы для ТОРГ-12 покупатель.
//
// Параметры:
//  СсылкаНаЭД - СправочникСсылка - ссылка на новый элемент.
//
// Возвращаемое значение:
//  СправочникСсылка.ЭДПрисоединенныеФайлы - заполненный электронный документ.
//
Функция СформироватьЭДИнформацияПокупателяУКД(СсылкаНаЭД) Экспорт
	
	ДобавленныйФайл = Неопределено;
	АдресВоВременномХранилище = "";
	
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
							СсылкаНаЭД,
							"ВладелецФайла, УникальныйИД, НаименованиеФайла");
	
	СтруктураЭД = СформироватьИнформациюПокупателяУКД(СсылкаНаЭД);
	
	Если ТипЗнч(СтруктураЭД) = Тип("Структура") И СтруктураЭД.Свойство("АдресВоВременномХранилище", АдресВоВременномХранилище) Тогда
		ДатаСозданияФайла = ТекущаяДатаСеанса();
		
		ПараметрыФайла = Новый Структура();
		ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
		ПараметрыФайла.Вставить("ВладелецФайлов", РеквизитыЭД.ВладелецФайла);
		ПараметрыФайла.Вставить("ИмяБезРасширения", СтруктураЭД.ИдФайла);
		ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
		ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");
		
		ДобавленныйФайл = РаботаСФайлами.ДобавитьФайл(
			ПараметрыФайла, АдресВоВременномХранилище, , , Справочники.ЭДПрисоединенныеФайлы.ПолучитьСсылку());
	
		СтруктураЭД.Вставить("СтатусЭД",                       Перечисления.СтатусыЭД.Утвержден);
		СтруктураЭД.Вставить("УникальныйИД",                   РеквизитыЭД.УникальныйИД);
		СтруктураЭД.Вставить("ЭлектронныйДокументВладелец",    СсылкаНаЭД);
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",            Перечисления.ТипыЭлементовВерсииЭД.ИнформацияПокупателяУКД);
		СтруктураЭД.Вставить("ДатаФормированияЭДОтправителем", ДатаСозданияФайла);
		СтруктураЭД.Вставить("НаименованиеФайла",              СтруктураЭД.ИдФайла);
		
		ОбменСКонтрагентамиСлужебный.ИзменитьПоСсылкеПрисоединенныйФайл(ДобавленныйФайл, СтруктураЭД);
	КонецЕсли;
	
	Возврат ДобавленныйФайл;
	
КонецФункции

// Формирование электронного документа Передача товаров по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьПередачаТоваровПродавец(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ПрефиксИдФайла", "DP_TOVTORGPR");
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.ТОРГ12Продавец);
	СтруктураЭД.Вставить("КНД", "1175010");
	СтруктураЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП;
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ТОРГ12_Продавец");
	ВставитьЗначениеВДерево(ДеревоДанных, "НаименованиеДокументаОтправителя", НаименованиеДокументаПередачаТоваров());
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПередачаТоваровПродавец(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Грузоотправитель");
	УчастникиСделки.Добавить("Грузополучатель");
	УчастникиСделки.Добавить("Поставщик");
	УчастникиСделки.Добавить("Плательщик");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки, Истина);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьПередачуТоваров(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляФНС(ДеревоДанных, СтруктураЭД);
		
		СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные.Подписанные", "ПолныйПуть", Истина);
		СтрокаДокументыОснования = ДеревоДанных.Строки.Найти("ДокументыОснования", "ПолныйПуть");
		ПоместитьДокументыОснованияВДопДанныеШапкиФНС(СтрокаДопДанных, СтрокаДокументыОснования, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		
		ЗаполнениеТаблицыТоваровДеревоДанных(ДеревоДанных, "ТаблицаТоваров", СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		
		// В "ДопДанные"помещается табличная часть "Серии номенклатуры".
		ЗаполнитьКлючСерий(ДеревоДанных);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", АдресКаталога + ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл") + ".xml");
		
		СтруктураЭД.Вставить("НомерДокументаОтправителя", ЗначениеРеквизитаДерева(ДеревоДанных, "НомерТоварнойНакладной"));
		СтруктураЭД.Вставить("ДатаДокументаОтправителя", ЗначениеРеквизитаДерева(ДеревоДанных, "ДатаТоварнойНакладной"));
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", ЗначениеРеквизитаДерева(ДеревоДанных, "НаименованиеДокументаОтправителя"));
		
		НомерИсправления = ЗначениеРеквизитаДерева(ДеревоДанных, "НомерИсправления");
		Если ЗначениеЗаполнено(НомерИсправления) Тогда
			ШаблонНомера = НСтр("ru = '%1 (испр. %2)'");
			НомерТоварнойНакладной = ЗначениеРеквизитаДерева(ДеревоДанных, "НомерТоварнойНакладной");
			НомерДокументаОтправителя = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
											ШаблонНомера, НомерТоварнойНакладной, НомерИсправления);
			СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
		КонецЕсли;
		
		// Добавляем в ДопДанные информацию о документе сделки
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументСделкиНаименование", Ложь);
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДокументСделкиНаименование", Реквизит);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументСделкиНомер", Ложь);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДокументСделкиНомер", Реквизит);
			КонецЕсли;
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументСделкиДата", Ложь);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДокументСделкиДата", Реквизит);
			КонецЕсли;
		КонецЕсли;
		
		Если СформироватьПередачаТоваровПродавецCML(ДеревоДанных) И ПризнакЭД Тогда
			СтруктураПараметров = Новый Структура;
			
			СуммаДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоПоНакладной.СуммаСНДС");
			Если Не ЗначениеЗаполнено(СуммаДокумента) Тогда
				СуммаДокумента = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоПоНакладной.СуммаБезНДС")
					+ ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВсегоПоНакладной.СуммаНДС");
			КонецЕсли;
			
			СтруктураЭД.Вставить("СуммаДокумента", СуммаДокумента);
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			СтруктураПараметров.Вставить("УникальныйИдентификатор", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УникальныйИдентификатор"));
			Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ПолноеИмяДопФайла") Тогда
				СтруктураПараметров.Вставить("ПолноеИмяДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяДопФайла"));
				СтруктураПараметров.Вставить("ИдентификаторДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдентификаторДопФайла"));
			КонецЕсли;
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование электронного документа передача товаров (данные покупателя) по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаЭД - Ссылка - объект по которому необходимо сформировать электронный документ.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьПередачаТоваровПокупатель(СсылкаНаЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
		
	РеквизитыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаЭД, "НаименованиеФайла,
		|ВладелецФайла, ОтправительЭД, ПолучательЭД, ДатаФормированияЭДОтправителем");
		
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО, НастройкаЭДО, Контрагент,
		| НомерДокументаОтправителя, ДатаДокументаОтправителя, НаименованиеДокументаОтправителя, Организация, СуммаДокумента");
	
	СтруктураЭД = Новый Структура; // для создания ЭДПрисоединенныеФайлы
	СтруктураЭД.Вставить("НаправлениеЭД",                    Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("НомерЭД",                          Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("УникальныйИдентификатор",          Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("Получатель",                       РеквизитыФайлаЭД.ОтправительЭД);
	СтруктураЭД.Вставить("ДатаЭД",                           ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Отправитель",                      РеквизитыФайлаЭД.ПолучательЭД);
	СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыФайлаЭД.НаименованиеФайла);
	СтруктураЭД.Вставить("ВладелецЭД",                       РеквизитыФайлаЭД.ВладелецФайла);
	СтруктураЭД.Вставить("Организация",                      РеквизитыЭД.Организация);
	СтруктураЭД.Вставить("Контрагент",                       РеквизитыЭД.Контрагент);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",               РеквизитыЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",                     РеквизитыЭД.НастройкаЭДО);
	СтруктураЭД.Вставить("ПрефиксИдФайла",                   "DP_TOVTORGPOK");
	СтруктураЭД.Вставить("ВидЭД",                            Перечисления.ВидыЭД.ТОРГ12Покупатель);
	СтруктураЭД.Вставить("КНД",                              "1175011");
	СтруктураЭД.Вставить("НомерДокументаОтправителя",        РеквизитыЭД.НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",         РеквизитыЭД.ДатаДокументаОтправителя);
	СтруктураЭД.Вставить("СуммаДокумента",                   РеквизитыЭД.СуммаДокумента);
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ТОРГ12_Покупатель");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоТОРГ12ПокупательФНС(СсылкаНаЭД, СтруктураЭД, ДеревоДокумента, Отказ);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки, Истина);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
		ДобавитьСлужебныеПоляФНС(ДеревоДокумента, СтруктураЭД);
		
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ВремДокТН",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДФ=HH.mm.ss"));
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ДатаДокТН",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДЛФ=D"));
		ВставитьЗначениеВДерево(ДеревоДокумента, "НомерТоварнойНакладной", РеквизитыЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаТоварнойНакладной",  РеквизитыЭД.ДатаДокументаОтправителя);
		
		НаименованиеДокументаОтправителя = РеквизитыЭД.НаименованиеДокументаОтправителя;
		Если Не ЗначениеЗаполнено(НаименованиеДокументаОтправителя) Тогда
			НаименованиеДокументаОтправителя = НаименованиеДокументаПередачаТоваров();
		КонецЕсли;
		ВставитьЗначениеВДерево(ДеревоДокумента, "НаименованиеДокументаОтправителя", НаименованиеДокументаОтправителя);
		
		НаименованиеОрганизации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РеквизитыЭД.Организация, "Наименование");
		ВставитьЗначениеВДерево(ДеревоДокумента, "НаименованиеОрганизации", НаименованиеОрганизации);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаЭД.УникальныйИдентификатор());
		ИдФайл = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, "ИдФайл");
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		
		СтруктураПараметров.Вставить("ПолученныеЭП", ЭППолученногоФайла(СсылкаНаЭД));
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИмяФайлаПродавца", РеквизитыФайлаЭД.НаименованиеФайла);
		
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ПолученныеЭП",
								ЭППолученногоФайла(СсылкаНаЭД));
								
		Если СформироватьПередачаТоваровПокупательCML(ДеревоДокумента) Тогда
			
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(СтруктураПараметров.ПолноеИмяФайла));
			СтруктураЭД.Вставить("ИдФайла", ИдФайл);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			
			ВозвращаемоеЗначение = СтруктураЭД;
			
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(АдресКаталога);
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаЭД);
	
	Возврат ВозвращаемоеЗначение;

	
КонецФункции

// Формирование электронного документа Передача работ исполнитель по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект, по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьПередачаРаботИсполнитель(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.АктИсполнитель);
	СтруктураЭД.Вставить("ПрефиксИдФайла", "DP_REZRUISP");
	СтруктураЭД.Вставить("КНД", "1175012");
	СтруктураЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП;
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.Акт501_Исполнитель");
	ВставитьЗначениеВДерево(ДеревоДанных, "НаименованиеДокументаОтправителя", НаименованиеДокументаПередачаРабот());
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПередачаРаботИсполнитель(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Исполнитель");
	УчастникиСделки.Добавить("Заказчик");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки, Истина);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьПередачуРабот(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляФНС(ДеревоДанных, СтруктураЭД);
		
		СтрокаДопДанных = ДеревоДанных.Строки.Найти("ДопДанные.Подписанные", "ПолныйПуть", Истина);
		СтрокаДокументыОснования = ДеревоДанных.Строки.Найти("ДокументыОснования", "ПолныйПуть");
		ПоместитьДокументыОснованияВДопДанныеШапкиФНС(СтрокаДопДанных, СтрокаДокументыОснования, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
			
		// Добавляем в ДопДанные информацию о документе сделки
		Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументСделкиНаименование", Ложь);
		Если ЗначениеЗаполнено(Реквизит) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДокументСделкиНаименование", Реквизит);
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументСделкиНомер", Ложь);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДокументСделкиНомер", Реквизит);
			КонецЕсли;
			Реквизит = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДокументСделкиДата", Ложь);
			Если ЗначениеЗаполнено(Реквизит) Тогда
				ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДокументСделкиДата", Реквизит);
			КонецЕсли;
		КонецЕсли;
		
		НомерДокументаОтправителя = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерАкта");
		Если НЕ ЗначениеЗаполнено(НомерДокументаОтправителя) Тогда
			НомерДокументаОтправителя = ""; 
			ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
		КонецЕсли;
		НомерИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НомерИсправления", Ложь);
		// Добавим в доп. данные номер и дату исправления.
		Если ЗначениеЗаполнено(НомерИсправления) Тогда
			ШаблонНомера = НСтр("ru = '%1 (испр. %2)'");
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.НомерИсправления", НомерИсправления);
			НомерДокументаОтправителя = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
											ШаблонНомера, НомерДокументаОтправителя, НомерИсправления);
			СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
		КонецЕсли;
		СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
		СтруктураЭД.Вставить("ДатаДокументаОтправителя",  ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаАкта"));
		СтруктураЭД.Вставить("НаименованиеДокументаОтправителя", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "НаименованиеДокументаОтправителя"));
		
		ДатаИсправления = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаИсправления", Ложь);
		Если ЗначениеЗаполнено(ДатаИсправления) Тогда
			ЭлектронноеВзаимодействиеСлужебный.ДобавитьЗначениеВДерево(СтрокаДопДанных, "ДопДанные.Подписанные.ДатаИсправления", ДатаИсправления);
		КонецЕсли;
		
		// Заполняем таблицу товаров.
		ЗаполнениеТаблицыТоваровДеревоДанных(ДеревоДанных, "ТаблицаУслуг", СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", АдресКаталога + ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдФайл") + ".xml");
		ВставитьЗначениеВДерево(ДеревоДанных, "ВерсияРегламентаЭДО", НастройкиОбменаЭД.ВерсияРегламентаЭДО);
		
		Если СформироватьПередачаРаботИсполнительCML(ДеревоДанных) И ПризнакЭД Тогда
			
			СтруктураПараметров = Новый Структура;
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ОписаниеУслуги.СуммаСНДСИтого"));
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД", СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяФайла"));
			СтруктураПараметров.Вставить("УникальныйИдентификатор", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "УникальныйИдентификатор"));
			Если ЭлектронноеВзаимодействие.СуществуетРеквизитВДереве(ДеревоДанных, "ПолноеИмяДопФайла") Тогда
				СтруктураПараметров.Вставить("ПолноеИмяДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ПолноеИмяДопФайла"));
			
				СтруктураПараметров.Вставить("ИдентификаторДопФайла", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "ИдентификаторДопФайла"));
			КонецЕсли;
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение
	
КонецФункции

// Формирует xml файл вида "Прайс лист" согласно механизму однократной сделки.
// От стандартного алгоритма отличается тем, что вызов команды может быть сделан без привязки к документу ИБ.
//
// Параметры:
//  СтруктураЭД - Структура - содержит следующие поля:
//   * ВидЭД - Перечисление видыЭД.
//   * АдресТаблицыЦен - Адрес во временном хранилище, по которому находится таблица значений, источник данных.
//   * ДатаФормирования - дата формирования ЭД.
//   * ВладелецЭД - организация которой принадлежит ЭД.
//   * Организация - организация от имени которой формируется ЭД.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция ФайлБыстрогоОбмена(СтруктураЭД) Экспорт
	
	Если СтруктураЭД.ВидЭД =  Перечисления.ВидыЭД.ПрайсЛист Тогда
		
		Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
		Отказ = Ложь;
		
		ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ПрайсЛист");
		ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоПрайсЛисту(Неопределено, СтруктураЭД, ДеревоДанных, Отказ);
		
		// Проверим корректность заполнения реквизитов дерева.
		Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
			СвойстваОбъекта = Новый Структура;
			СвойстваОбъекта.Вставить("Номер", "");
			СвойстваОбъекта.Вставить("Дата", СтруктураЭД.ДатаФормирования);
			
			АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, Новый УникальныйИдентификатор);
			ПолноеИмяФайла = АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СвойстваОбъекта, СтруктураЭД.ДатаФормирования);
			
			ВставитьЗначениеВДерево(ДеревоДанных, "ДатаФормирования", СтруктураЭД.ДатаФормирования);
			ВставитьЗначениеВДерево(ДеревоДанных, "ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
			ВставитьЗначениеВДерево(ДеревоДанных, "ВидЭД", СтруктураЭД.ВидЭД);
			ВставитьЗначениеВДерево(ДеревоДанных, "НаправлениеЭД", Перечисления.НаправленияЭД.Исходящий);
			ВставитьЗначениеВДерево(ДеревоДанных, "УникальныйИдентификатор", Новый УникальныйИдентификатор);
			ВставитьЗначениеВДерево(ДеревоДанных, "Ид", Строка(Новый УникальныйИдентификатор));
			
			ВставитьЗначениеВДерево(ДеревоДанных, "ИдКаталога", Новый УникальныйИдентификатор);
			ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
			
			Если СформироватьПрайсЛистCML(ДеревоДанных) Тогда
				
				СтруктураПараметров = Новый Структура;
				
				СтруктураЭД.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Исходящий);
				СтруктураЭД.Вставить("НомерЭД", Строка(Новый УникальныйИдентификатор));
				СтруктураЭД.Вставить("ДатаЭД", ТекущаяДатаСеанса());
				СтруктураЭД.Вставить("Отправитель", Строка(Новый УникальныйИдентификатор));
				
				
				НаименованиеФайла = НСтр("ru = 'Прайс лист от %1'");
				НаименованиеФайла = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НаименованиеФайла, Формат(СтруктураЭД.ДатаЭД, "ДЛФ=Д"));
				
				СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
				СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
				СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
				СтруктураПараметров.Вставить("Наименование",   НаименованиеФайла);
				СтруктураПараметров.Вставить("ВладелецЭД",   "Price list");
				
				ВозвращаемоеЗначение = СтруктураПараметров;
				
				Возврат ВозвращаемоеЗначение;
				
			КонецЕсли;
			
		Иначе
			
			ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД);
			
		КонецЕсли;
		
	КонецЕсли;

КонецФункции

// Формирование электронного документа в формате CML2 прайс-листа по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект  по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьПрайсПоДокументу(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.ПрайсЛист);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	
	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ПрайсЛист");
	
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоПрайсЛисту(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Владелец");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
	
	ВозвращаемоеЗначение = Неопределено;
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьПрайсЛист(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		// Служебные поля добавим пока в отдельную ветку, их возможно можно вынести в корень.
		
		ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ИмяФайла = ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД);
		ПолноеИмяФайла = АдресКаталога + ИмяФайла;
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ИдКаталога", Новый УникальныйИдентификатор);
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "Номер", СтруктураЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "Дата", СтруктураЭД.ДатаДокументаОтправителя);
		
		Если СформироватьПрайсЛистCML(ДеревоДанных) И ПризнакЭД Тогда
			СтруктураПараметров = Новый Структура;
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   ИмяФайла);
			
			ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных);
			
			ВозвращаемоеЗначение = СтруктураПараметров;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;

КонецФункции

// Формирование электронного документа Счет на оплату покупателю по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьСчетНаОплатуПоДокументу(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.СчетНаОплату);
	СтруктураЭД.Вставить("ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
	
	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
	
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.СчетНаОплату");
	
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоСчету(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Продавец");
	УчастникиСделки.Добавить("Покупатель");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
	
	// Проверим корректность заполнения реквизитов дерева.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьСчетНаОплату(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД);
		
			
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ПолноеИмяФайла = АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД);
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "ХозОперация", НСтр("ru = 'Счет на оплату'"));
		ВставитьЗначениеВДерево(ДеревоДанных, "Номер", СтруктураЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "Дата", СтруктураЭД.ДатаДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "Ид", СтруктураЭД.НомерЭД);
		
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "НалогообложениеНДС");
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "НазначениеПлатежа");
		
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "ИтогоПоДокументу.Сумма");
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "ИтогоПоДокументу.СуммаСкидки");
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "ИтогоПоДокументу.СуммаБезСкидки");
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "ИтогиПрописью");
		
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "УникальныйИдентификаторПлатежа");
		
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ДокументыСделки");
		ПоместитьДокументыОснованияВДопДанные(ДеревоДанных, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ГрафикОплаты");
		
		Если СформироватьСчетНаОплатуCML(ДеревоДанных) И ПризнакЭД Тогда
			
			СтруктураПараметров = Новый Структура;
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма"));
			
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   АдресКаталога);
			
			ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных);
			
			ВозвращаемоеЗначение = СтруктураПараметров;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование электронного документа заказа поставщику по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьЗаказПоставщикуПоДокументу(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.ЗаказТовара);
	СтруктураЭД.Вставить("ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
	
	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
		
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ЗаказТовара");

	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоЗаказуТоваров(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Покупатель");
	УчастникиСделки.Добавить("Продавец");
	УчастникиСделки.Добавить("Получатель");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьЗаказТовара(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	ВозвращаемоеЗначение = Неопределено;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД);
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог();
		ПолноеИмяФайла = АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД);
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "Номер",          СтруктураЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "Дата",           СтруктураЭД.ДатаДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "ХозОперация",    НСтр("ru = 'Заказ товара'"));
		ВставитьЗначениеВДерево(ДеревоДанных, "Роль",           "Покупатель");
		
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "НомерДокументаОснования");
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "ДатаДокументаОснования");
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "ИтогиПрописью");
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ДокументыСделки");
		ПоместитьДокументыОснованияВДопДанные(ДеревоДанных, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		ПоместитьГруппуДереваВДопДанные(ДеревоДанных, "ИтогоПоДокументу");
		
		Если СформироватьЗаказCML(ДеревоДанных) И ПризнакЭД Тогда
			СтруктураПараметров = Новый Структура;
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма"));
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   АдресКаталога);
			ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных);
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
		
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование электронного документа Заказа клиента по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьЗаказКлиентаПоДокументу(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.ОтветНаЗаказ);
	СтруктураЭД.Вставить("ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());

	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
	
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ОтветНаЗаказ");
	
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоОтветуНаЗаказ(СсылкаНаОбъект, СтруктураЭД, ДеревоДанных, Отказ);
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Покупатель");
	УчастникиСделки.Добавить("Продавец");
	УчастникиСделки.Добавить("Получатель");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьЗаказТовара(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	ВозвращаемоеЗначение = Неопределено;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ПолноеИмяФайла = АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД);
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "Номер", СтруктураЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "Дата", СтруктураЭД.ДатаДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "ХозОперация", НСтр("ru = 'Заказ товара'"));
		ВставитьЗначениеВДерево(ДеревоДанных, "Роль", "Продавец");
		
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "НомерДокументаОснования");
		ПоместитьРеквизитШапкиВДопДанные(ДеревоДанных, "ДатаДокументаОснования");
		
		ПоместитьГруппуДереваВДопДанные(ДеревоДанных, "ИтогоПоДокументу");
		
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ДокументыСделки");
		ПоместитьДокументыОснованияВДопДанные(ДеревоДанных, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		
		Если СформироватьЗаказCML(ДеревоДанных) И ПризнакЭД Тогда
			СтруктураПараметров = Новый Структура;
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма"));
			
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   АдресКаталога);
			
			ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных);
			
			ВозвращаемоеЗначение = СтруктураПараметров;
			
		КонецЕсли;
		
	КонецЕсли;

	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование электронного документа Каталог товаров по ссылке на документ ИБ.
//
// Параметры:
//  НастройкиОбменаЭД - Структура - настройки обмена.
//  ДополнительныеПараметры - Структура - дополнительные параметры.
//    * ТоварыКаталога - таблица значений - таблица содержащая перечень номенклатуры.
//  ПризнакЭД      - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьКаталогНоменклатуры(НастройкиОбменаЭД, ДополнительныеПараметры, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВерсияСхемы",          ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
	СтруктураЭД.Вставить("ВидЭД",                Перечисления.ВидыЭД.КаталогТоваров);
	СтруктураЭД.Вставить("НаправлениеЭД",        Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("НомерЭД",              ВернутьИдЭД(НастройкиОбменаЭД.Организация));
	СтруктураЭД.Вставить("ДатаЭД",               ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",  Перечисления.ТипыЭлементовВерсииЭД.ПервичныйЭД);
	
	СтруктураЭД.Вставить("Отправитель",   НастройкиОбменаЭД.ИдентификаторОрганизации);
	СтруктураЭД.Вставить("Организация",   НастройкиОбменаЭД.Организация);
	СтруктураЭД.Вставить("УникальныйИдентификатор", Новый УникальныйИдентификатор);
	
	Если НастройкиОбменаЭД.ПрофильНастроекЭДО.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.БыстрыйОбмен Тогда
		
		ШаблонСообщения = НСтр("ru = 'Каталог %1 от %2'");
		НаименованиеКаталога = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			НастройкиОбменаЭД.Организация, Формат(СтруктураЭД.ДатаЭД, "ДЛФ=Д"));
	Иначе
		СтруктураЭД.Вставить("Контрагент",    НастройкиОбменаЭД.Контрагент);
		СтруктураЭД.Вставить("Получатель",    НастройкиОбменаЭД.ИдентификаторКонтрагента);
		ДокументыОснования = Новый Массив;
		ДокументыОснования.Добавить(НастройкиОбменаЭД.СоглашениеЭД);
		СтруктураЭД.Вставить("ДокументыОснования",      ДокументыОснования);
		СтруктураЭД.Вставить("ПрофильНастроекЭДО", НастройкиОбменаЭД.ПрофильНастроекЭДО);
		СтруктураЭД.Вставить("СоглашениеЭД",  НастройкиОбменаЭД.СоглашениеЭД);
		СтруктураЭД.Вставить("НомерВерсииЭД", ОбменСКонтрагентамиСлужебный.НомерВерсииЭДПоВладельцу(
			НастройкиОбменаЭД.СоглашениеЭД));
		СтруктураЭД.Вставить("ДатаДокументаОтправителя", ТекущаяДатаСеанса());
		
		ШаблонСообщения = НСтр("ru = 'Каталог %1 для %2 от %3'");
		НаименованиеКаталога = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения,
			НастройкиОбменаЭД.Организация, НастройкиОбменаЭД.Контрагент, Формат(СтруктураЭД.ДатаЭД, "ДЛФ=Д"));
	КонецЕсли;
	
	// Получение таблицы товаров из временного хранилища.
	ТоварыКаталога = "";
	ДополнительныеПараметры.Свойство("ТоварыКаталога", ТоварыКаталога);
	ТоварыКаталога = ПолучитьИзВременногоХранилища(ТоварыКаталога);
	
	// Формирование и заполнение дерева по макету.
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.КаталогТоваров");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоКаталогуТоваровCML(НастройкиОбменаЭД.Организация, ТоварыКаталога,
		ДеревоДанных, Отказ);
		
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Владелец");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
		
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьКаталогТоваров(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД);
		
		НаименованиеКаталога = ОбщегоНазначенияКлиентСервер.ЗаменитьНедопустимыеСимволыВИмениФайла(
			НаименованиеКаталога);
		ВставитьЗначениеВДерево(ДеревоДанных, "Наименование", НаименованиеКаталога);
		
		НаименованиеКаталога = ОбменСКонтрагентамиСлужебный.КорректноеИмяФайла(НаименованиеКаталога, Истина);
		ПолноеИмяФайла = ОбщегоНазначенияКлиентСервер.ПолучитьПолноеИмяФайла(
			ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, НастройкиОбменаЭД.Организация.УникальныйИдентификатор()),
			СтроковыеФункцииКлиентСервер.СтрокаЛатиницей(НаименованиеКаталога));
		
		ШаблонИмениФайла = НСтр("ru = '%1.xml'");
		ПолноеИмяФайла = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонИмениФайла, ПолноеИмяФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
		
		МассивФайлов = Новый Массив;
		Если СформироватьКаталогCML(ДеревоДанных, МассивФайлов) И ПризнакЭД Тогда
			СтруктураПараметров = Новый Структура;
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   НаименованиеКаталога);
			СтруктураПараметров.Вставить("МассивФайлов",   МассивФайлов);
			
			ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных);
			
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
	Иначе
		// Если были ошибки, обработаем их.
		ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД);
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование электронного документа Отчета комитента по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект, по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры с данными документа.
//
Функция СформироватьОтчетОПродажахКомиссионногоТовараПоДокументу(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.ОтчетОПродажахКомиссионногоТовара);
	СтруктураЭД.Вставить("ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
	
	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
	
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	
	// Сформируем структуру параметров для ОтчетаОПродажахКомиссионногоТовара и заполним ее.
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ОтчетКомиссионераОПродажах");
	
	// заполняем дерево значений данными документа
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоОтчетуОПродажахКомиссионногоТовара(СсылкаНаОбъект, СтруктураЭД,
		ДеревоДанных, Отказ);
		
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Комитент");
	УчастникиСделки.Добавить("Комиссионер");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
		
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьОтчетОПродажахКомиссионногоТовара(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ПолноеИмяФайла = АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД);
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "Номер", СтруктураЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "Дата", СтруктураЭД.ДатаДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "ХозОперация", НСтр("ru = 'Отчет о продажах комиссионного товара'"));
		ВставитьЗначениеВДерево(ДеревоДанных, "Роль", "Комитент");
		
		ПоместитьГруппуДереваВДопДанные(ДеревоДанных, "ИтогоПоДокументу");
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ГрафикОплаты");
		ПоместитьГруппуДереваВДопДанные(ДеревоДанных, "Услуга");
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ДокументыСделки");
		
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ДокументыСделки");
		ПоместитьДокументыОснованияВДопДанные(ДеревоДанных, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		
		Если СформироватьОтчетОПродажахКомиссионногоТовараCML(ДеревоДанных) И ПризнакЭД Тогда
			СтруктураПараметров = Новый Структура;
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма"));
			
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   АдресКаталога);
			
			ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных);
			
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
		
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование электронного документа Отчета комитента о списании по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект, по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры с данными документа.
//
Функция СформироватьОтчетОСписанииКомиссионногоТовараПоДокументу(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = СтруктураЭлектронногоДокумента(СсылкаНаОбъект, НастройкиОбменаЭД);
	СтруктураЭД.Вставить("ВидЭД", Перечисления.ВидыЭД.ОтчетОСписанииКомиссионногоТовара);
	СтруктураЭД.Вставить("ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
	
	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
	
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", СсылкаНаОбъект.Дата);
	
	// Сформируем структуру параметров для ОтчетаОПродажахКомиссионногоТовара и заполним ее.
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ОтчетКомиссионераОСписании");
	
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоОтчетуОСписанииКомиссионногоТовара(СсылкаНаОбъект, СтруктураЭД,
		ДеревоДанных, Отказ);
		
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Комитент");
	УчастникиСделки.Добавить("Комиссионер");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДанных);
		
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ПроверитьОтчетОСписанииКомиссионногоТовара(ДеревоДанных, СтруктураЭД, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляCML(ДеревоДанных, СтруктураЭД);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ПолноеИмяФайла = АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД);
		
		ВставитьЗначениеВДерево(ДеревоДанных, "ПолноеИмяФайла", ПолноеИмяФайла);
		ВставитьЗначениеВДерево(ДеревоДанных, "Номер", СтруктураЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "Дата", СтруктураЭД.ДатаДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДанных, "ХозОперация", НСтр("ru = 'Отчет о списании комиссионного товара'"));
		ВставитьЗначениеВДерево(ДеревоДанных, "Роль", "Комитент");
		
		ПоместитьТаблицуДереваВДопДанные(ДеревоДанных, "ДокументыСделки");
		ПоместитьДокументыОснованияВДопДанные(ДеревоДанных, СтруктураЭД.ИдентификаторыДокументовИЭДОснований);
		
		Если СформироватьОтчетОСписанииКомиссионногоТовараCML(ДеревоДанных) И ПризнакЭД Тогда
			СтруктураПараметров = Новый Структура;
			Если ЗначениеЗаполнено(ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка")) Тогда
				СтруктураЭД.Вставить("ДополнительнаяИнформация", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "СопроводительнаяЗаписка"));
			КонецЕсли;
			
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма"));
			
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   АдресКаталога);
			
			ДополнитьПолямиДляДопДанных(СтруктураПараметров, ДеревоДанных);
			
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
		
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;

	
КонецФункции

// Формирование электронного документа Передача товаров между организациями по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект, по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры с данными документа.
//
Функция СформироватьПередачуТоваровМеждуОрганизациями(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	Ошибки = Новый Массив;
	ВозвращаемоеЗначение = Неопределено;
	СтруктураПараметров  = Новый Структура;
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ПередачаВозвратТоваровМеждуОрганизациями");
	
	СтруктураЭД = Новый Структура;
	
	СтруктураЭД.Вставить("ВидЭД",         Перечисления.ВидыЭД.ПередачаТоваровМеждуОрганизациями);
	СтруктураЭД.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Интеркампани);
	СтруктураЭД.Вставить("Отправитель",   НастройкиОбменаЭД.ИдентификаторОрганизации);
	СтруктураЭД.Вставить("Получатель",    НастройкиОбменаЭД.ИдентификаторКонтрагента);
	СтруктураЭД.Вставить("НомерВерсииЭД", ОбменСКонтрагентамиСлужебный.НомерВерсииЭДПоВладельцу(СсылкаНаОбъект));
	СтруктураЭД.Вставить("НомерЭД",       ВернутьИдЭД(СсылкаНаОбъект));
	СтруктураЭД.Вставить("ДатаЭД",        ТекущаяДатаСеанса());
	
	ДокументыОснования = Новый Массив;
	ДокументыОснования.Добавить(СсылкаНаОбъект);
	СтруктураЭД.Вставить("ДокументыОснования", ДокументыОснования);
	
	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",  ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаОбъект, "Дата"));
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",        НастройкиОбменаЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",              НастройкиОбменаЭД.СоглашениеЭД);
	СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",       Перечисления.ТипыЭлементовВерсииЭД.ПервичныйЭД);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Ид",                  СтруктураЭД.НомерЭД);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы",         "4.02");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Исполнитель",         СтруктураЭД.Отправитель);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования",    ТекущаяДатаСеанса());
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидЭД",               СтруктураЭД.ВидЭД);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НаправлениеЭД",       СтруктураЭД.НаправлениеЭД);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Номер",               СтруктураЭД.НомерДокументаОтправителя);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Дата",                СтруктураЭД.ДатаДокументаОтправителя);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТипГрузоотправителя", "Организация");
	
	ОбменСКонтрагентамиПереопределяемый.ПодготовитьДанныеПоПередачеТоваровМеждуОрганизациями(
		СсылкаНаОбъект,
		СтруктураЭД,
		ДеревоДанных);
	
	СтруктураЭД.Вставить("Организация", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Организация"));
	СтруктураЭД.Вставить("Контрагент",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Контрагент"));
	
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	
	Если Не Ошибки.Количество() Тогда
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		СтруктураПараметров.Вставить("ПолноеИмяФайла",
			АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД));
		
		Если СформироватьПередачуВозвратТоваровМеждуОрганизациямиCML(ДеревоДанных, СтруктураПараметров.ПолноеИмяФайла) И ПризнакЭД Тогда
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма"));
			СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
		
	Иначе
		
		ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
		
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование электронного документа Возврат товаров между организациями по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - объект, по которому необходимо сформировать электронный документ.
//  НастройкиОбменаЭД - Структура - настройки обмена электронными документами.
//  ПризнакЭД - Булево - признак необходимости вернуть структуру реквизитов электронного документа.
//
// Возвращаемое значение:
//  Структура - параметры с данными документа.
//
Функция СформироватьВозвратТоваровМеждуОрганизациями(СсылкаНаОбъект, НастройкиОбменаЭД, ПризнакЭД = Истина) Экспорт
	
	Ошибки = Новый Массив;
	ВозвращаемоеЗначение = Неопределено;
	СтруктураПараметров  = Новый Структура;
	
	ДеревоДанных = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ПередачаВозвратТоваровМеждуОрганизациями");
	
	СтруктураЭД = Новый Структура;
	
	СтруктураЭД.Вставить("ВидЭД",         Перечисления.ВидыЭД.ВозвратТоваровМеждуОрганизациями);
	СтруктураЭД.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Интеркампани);
	СтруктураЭД.Вставить("Отправитель",   НастройкиОбменаЭД.ИдентификаторОрганизации);
	СтруктураЭД.Вставить("Получатель",    НастройкиОбменаЭД.ИдентификаторКонтрагента);
	СтруктураЭД.Вставить("НомерВерсииЭД", ОбменСКонтрагентамиСлужебный.НомерВерсииЭДПоВладельцу(СсылкаНаОбъект));
	СтруктураЭД.Вставить("НомерЭД",       ВернутьИдЭД(СсылкаНаОбъект));
	СтруктураЭД.Вставить("ДатаЭД",        ТекущаяДатаСеанса());
	
	ДокументыОснования = Новый Массив;
	ДокументыОснования.Добавить(СсылкаНаОбъект);
	СтруктураЭД.Вставить("ДокументыОснования", ДокументыОснования);
	
	НомерДокументаОтправителя = "";
	ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьПечатныйНомерДокумента(СсылкаНаОбъект, НомерДокументаОтправителя);
	СтруктураЭД.Вставить("НомерДокументаОтправителя", НомерДокументаОтправителя);
	
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаОбъект, "Дата"));
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",       НастройкиОбменаЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",             НастройкиОбменаЭД.СоглашениеЭД);
	СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",      Перечисления.ТипыЭлементовВерсииЭД.ПервичныйЭД);
	
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Ид",                  СтруктураЭД.НомерЭД);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВерсияСхемы",         "4.02");
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Исполнитель",         СтруктураЭД.Отправитель);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ДатаФормирования",    ТекущаяДатаСеанса());
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ВидЭД",               СтруктураЭД.ВидЭД);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "НаправлениеЭД",       СтруктураЭД.НаправлениеЭД);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Номер",               СтруктураЭД.НомерДокументаОтправителя);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "Дата",                СтруктураЭД.ДатаДокументаОтправителя);
	ЭлектронноеВзаимодействие.ЗаполнитьЗначениеРеквизитаВДереве(ДеревоДанных, "ТипГрузоотправителя", "Организация");
	
	ОбменСКонтрагентамиПереопределяемый.ПодготовитьДанныеПоВозвратуТоваровМеждуОрганизациями(
		СсылкаНаОбъект,
		СтруктураЭД,
		ДеревоДанных);
	
	СтруктураЭД.Вставить("Организация", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Организация"));
	СтруктураЭД.Вставить("Контрагент",  ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Контрагент"));
	
	ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДанных, Ошибки);
	
	Если Не Ошибки.Количество() Тогда
	
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		СтруктураПараметров.Вставить("ПолноеИмяФайла",
			АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД));
		
		Если СформироватьПередачуВозвратТоваровМеждуОрганизациямиCML(ДеревоДанных, СтруктураПараметров.ПолноеИмяФайла) И ПризнакЭД Тогда
			СтруктураЭД.Вставить("СуммаДокумента", ЭлектронноеВзаимодействие.ЗначениеРеквизитаВДереве(ДеревоДанных, "Сумма"));
			СтруктураПараметров.Вставить("СтруктураЭД", СтруктураЭД);
			ВозвращаемоеЗначение = СтруктураПараметров;
		КонецЕсли;
	Иначе
		
		ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
		
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирует элемент справочника ЭДПрисоединенныеФайлы для извещения или уведомления.
// об уточнении.
//
// Параметры:
//  СсылкаНаЭД - СправочникСсылка - ссылка на новый элемент.
//  ВидЭД - ПеречислениеСсылка.ВидыЭД - вид электронного документа.
//  ТекстУточнения - Строка - содержимое уточнения.
//
// Возвращаемое значение:
//  Структура - структура с данными документа.
//
Функция СформироватьФайлСлужебногоДокументаПоЭД(СсылкаНаЭД, ВидЭД, ТекстУточнения = "") Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаЭД, "ВладелецФайла, ДатаСоздания, ТипЭлементаВерсииЭД,
		|НаименованиеФайла, ОтправительЭД, ПолучательЭД");
		
	НастройкиОбменаЭД = ОбменСКонтрагентамиСлужебный.ОпределитьНастройкиОбменаЭДПоИсточнику(РеквизитыЭД.ВладелецФайла, , , СсылкаНаЭД);
	Если ТипЗнч(НастройкиОбменаЭД) = Тип("Структура") Тогда
		СтруктураЭД = Новый Структура; // для создания ЭДПрисоединенныеФайлы
		СтруктураЭД.Вставить("ВидЭД", ВидЭД);
		СтруктураЭД.Вставить("НомерЭД",       Новый УникальныйИдентификатор());
		СтруктураЭД.Вставить("ИдПолучателя", НастройкиОбменаЭД.ИдентификаторКонтрагента);
		Если НастройкиОбменаЭД.Свойство("ЭтоИнтеркампани") И НастройкиОбменаЭД.ЭтоИнтеркампани Тогда
			СтруктураЭД.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Интеркампани);
		Иначе
			СтруктураЭД.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Исходящий);
		КонецЕсли;
		
		Если НастройкиОбменаЭД.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезОператораЭДОТакском Тогда
			
			Если РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДПЭСФ
				ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОЭСФ
				ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПЭСФ
				ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПУПДУКД Тогда
				
				СтруктураЭД.Вставить("ОператорЭДО", СтруктураНастроекТакском());
			КонецЕсли;
		КонецЕсли;
		Если НастройкиОбменаЭД.СпособОбменаЭД = Перечисления.СпособыОбменаЭД.ЧерезСервис1СЭДО Тогда
			
			Если РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДПЭСФ
				ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОЭСФ
				ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПЭСФ
				ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПДОИПУПДУКД Тогда
				
				РеквизитыПрофиля = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыЭД.ВладелецФайла,"ПрофильНастроекЭДО.ОператорЭДОИНН,
					|ПрофильНастроекЭДО.ОператорЭДО, ПрофильНастроекЭДО.ОператорЭДОИд");
				
				ОператорЭДО = Новый Структура;
				ОператорЭДО.Вставить("ИНН", РеквизитыПрофиля.ПрофильНастроекЭДООператорЭДОИНН);
				ОператорЭДО.Вставить("Наименование", РеквизитыПрофиля.ПрофильНастроекЭДООператорЭДО);
				ОператорЭДО.Вставить("ИдентификаторОператора", РеквизитыПрофиля.ПрофильНастроекЭДООператорЭДОИд);
				
				СтруктураЭД.Вставить("ОператорЭДО", ОператорЭДО);
			КонецЕсли;
		КонецЕсли;
		
		Если ВидЭД <> Перечисления.ВидыЭД.ПредложениеОбАннулировании
			И (РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ЭСФ
			ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФУПД
			ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.СЧФДОПУПД
			ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОПУПД
			ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФУКД
			ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.КСЧФДИСУКД
			ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДИСУКД
			ИЛИ РеквизитыЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ДОП) Тогда
			
			РеквизитыПервичногоДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыЭД.ВладелецФайла,
				"ДатаДокументаОтправителя, НомерДокументаОтправителя");
			
			СтруктураЭД.Вставить("НаименованиеДокументаОтправителя",
				ОбменСКонтрагентамиСлужебный.ПолучитьПредставлениеЭД(РеквизитыЭД.ВладелецФайла));
			СтруктураЭД.Вставить("ДатаДокументаОтправителя",  РеквизитыПервичногоДокумента.ДатаДокументаОтправителя);
			СтруктураЭД.Вставить("НомерДокументаОтправителя", РеквизитыПервичногоДокумента.НомерДокументаОтправителя);
		КонецЕсли;
		
		СтруктураЭД.Вставить("ИдОтправителя", НастройкиОбменаЭД.ИдентификаторОрганизации);
		СтруктураЭД.Вставить("ВладелецФайла", РеквизитыЭД.ВладелецФайла);
		СтруктураЭД.Вставить("ИдФайла",       ОпределитьИдФайлаЭД(СтруктураЭД));
		СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыЭД.НаименованиеФайла);
		// Дата и время получения файла.
		СтруктураЭД.Вставить("ДатаВремяПолучения", РеквизитыЭД.ДатаСоздания);
		Если ВидЭД <> Перечисления.ВидыЭД.ИзвещениеОПолучении Тогда
			СтруктураЭД.Вставить("ТекстУточнения", ТекстУточнения);
			Если ВидЭД = Перечисления.ВидыЭД.УведомлениеОбУточнении Тогда
				ИмяМакета = "ОбменСКонтрагентами.УведомлениеОбУточнении";
			Иначе
				ИмяМакета = "ОбменСКонтрагентами.ПредложениеОбАннулировании";
			КонецЕсли;
		Иначе
			ИмяМакета = "ОбменСКонтрагентами.ИзвещениеОПолучении";
		КонецЕсли;
		
		Дерево = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента(ИмяМакета);
		Если ПодготовитьДанныеПоСлужебномуДокументу(СсылкаНаЭД, СтруктураЭД, Дерево)
			И ЗаполнитьФайлСлужебногоДокумента(Дерево, ВидЭД) Тогда
			ФайлДанных = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(Дерево, "ПолноеИмяФайла");
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ФайлДанных));
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ФайлДанных);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			ВозвращаемоеЗначение = СтруктураЭД;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирование реквизитов организации.
//
// Параметры:
//  СсылкаНаОбъект - ДокументСсылка - ссылка на объект.
//  НастройкиОбменаЭД - Параметры - настройки обмена.
// 
// Возвращаемое значение:
//  Структура - реквизиты организации.
//
Функция СформироватьРеквизитыОрганизации(СсылкаНаОбъект, НастройкиОбменаЭД) Экспорт
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	СтруктураЭД = Новый Структура;
	СтруктураЭД.Вставить("ВидЭД", "РеквизитыОрганизации");
	СтруктураЭД.Вставить("ВерсияСхемы", ОбменСКонтрагентамиСлужебный.ВерсияСхемыCML2());
	СтруктураЭД.Вставить("ТипЭлементаВерсииЭД", Перечисления.ТипыЭлементовВерсииЭД.ПервичныйЭД);
	СтруктураЭД.Вставить("НаправлениеЭД", Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("Отправитель", НастройкиОбменаЭД.ИдентификаторОрганизации);
	СтруктураЭД.Вставить("Получатель", НастройкиОбменаЭД.ИдентификаторОрганизации);
	СтруктураЭД.Вставить("НомерВерсииЭД", ОбменСКонтрагентамиСлужебный.НомерВерсииЭДПоВладельцу(СсылкаНаОбъект));
	СтруктураЭД.Вставить("НомерЭД", ВернутьИдЭД(СсылкаНаОбъект));
	СтруктураЭД.Вставить("ДатаЭД", ТекущаяДатаСеанса());
	
	ДокументыОснования = Новый Массив;
	ДокументыОснования.Добавить(СсылкаНаОбъект);
	СтруктураЭД.Вставить("ДокументыОснования", ДокументыОснования);
	
	СтруктураЭД.Вставить("НомерДокументаОтправителя","");
	СтруктураЭД.Вставить("ДатаДокументаОтправителя", ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Организация", СсылкаНаОбъект);
	СтруктураЭД.Вставить("Контрагент", СсылкаНаОбъект);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО", НастройкиОбменаЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД", НастройкиОбменаЭД.СоглашениеЭД);
	СтруктураЭД.Вставить("УникальныйИдентификатор", Новый УникальныйИдентификатор);
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.РеквизитыОрганизации");
	
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеРеквизитыОрганизации(СсылкаНаОбъект, СтруктураЭД, ДеревоДокумента, Отказ);
	
	УчастникиСделки = Новый Массив;
	УчастникиСделки.Добавить("Организация");
	ЗаполнитьАдресаУчастниковСделки(УчастникиСделки, ДеревоДокумента);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		
		ДобавитьСлужебныеПоляCML(ДеревоДокумента, СтруктураЭД);
		
			
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаОбъект.УникальныйИдентификатор());
		ПолноеИмяФайла = АдресКаталога + ОпределитьИмяФайлаЭД(СтруктураЭД.ВидЭД, СсылкаНаОбъект, СтруктураЭД.ДатаЭД);
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", ПолноеИмяФайла);
		
		Если СформироватьРеквизитыОрганизацииCML(ДеревоДокумента) Тогда
			
			СтруктураПараметров = Новый Структура;
			СтруктураПараметров.Вставить("СтруктураЭД",    СтруктураЭД);
			СтруктураПараметров.Вставить("ВидЭД",          СтруктураЭД.ВидЭД);
			СтруктураПараметров.Вставить("ПолноеИмяФайла", ПолноеИмяФайла);
			СтруктураПараметров.Вставить("Наименование",   АдресКаталога);
			ВозвращаемоеЗначение = СтруктураПараметров;

		КонецЕсли;
		
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаОбъект);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

#КонецОбласти

#Область ОтветныеТитулыУстаревшихФорматов

// Формирует элемент справочника ЭДПрисоединенныеФайлы для ТОРГ-12 покупатель.
//
// Параметры:
//  СсылкаНаЭД - СправочникСсылка - ссылка на новый элемент.
//
// Возвращаемое значение:
//  СправочникСсылка.ЭДПрсоединенныеФайлы - заполненный электронный документ.
//
Функция СформироватьЭДТорг12Покупатель(СсылкаНаЭД) Экспорт
	
	ДобавленныйФайл = Неопределено;
	АдресВоВременномХранилище = "";
	
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
							СсылкаНаЭД,
							"ВладелецФайла, УникальныйИД, НаименованиеФайла");
	
	Если СтрНачинаетсяС(РеквизитыЭД.НаименованиеФайла, "DP_TOVTORGPR") Тогда
		СтруктураЭД = СформироватьПередачаТоваровПокупатель(СсылкаНаЭД);
	Иначе
		СтруктураЭД = СформироватьФайлТорг12ПокупательФНС(СсылкаНаЭД);
	КонецЕсли;
	
	Если ТипЗнч(СтруктураЭД) = Тип("Структура") И СтруктураЭД.Свойство("АдресВоВременномХранилище", АдресВоВременномХранилище) Тогда
		ДатаСозданияФайла = ТекущаяДатаСеанса();
		
		ПараметрыФайла = Новый Структура();
		ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
		ПараметрыФайла.Вставить("ВладелецФайлов", РеквизитыЭД.ВладелецФайла);
		ПараметрыФайла.Вставить("ИмяБезРасширения", СтруктураЭД.ИдФайла);
		ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
		ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");
		
		ДобавленныйФайл = РаботаСФайлами.ДобавитьФайл(
			ПараметрыФайла, АдресВоВременномХранилище, , , Справочники.ЭДПрисоединенныеФайлы.ПолучитьСсылку(СтруктураЭД.УникальныйИдентификатор));
	
		СтруктураЭД.Вставить("СтатусЭД",                       Перечисления.СтатусыЭД.Утвержден);
		СтруктураЭД.Вставить("УникальныйИД",                   РеквизитыЭД.УникальныйИД);
		СтруктураЭД.Вставить("ЭлектронныйДокументВладелец",    СсылкаНаЭД);
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",            Перечисления.ТипыЭлементовВерсииЭД.ТОРГ12Покупатель);
		СтруктураЭД.Вставить("ДатаФормированияЭДОтправителем", ДатаСозданияФайла);
		СтруктураЭД.Вставить("НаименованиеФайла",              СтруктураЭД.ИдФайла);
		
		ОбменСКонтрагентамиСлужебный.ИзменитьПоСсылкеПрисоединенныйФайл(ДобавленныйФайл, СтруктураЭД);
	КонецЕсли;
	
	Возврат ДобавленныйФайл;
	
КонецФункции

// Формирование электронного документа Расходная накладная (титул покупателя) по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаФайлНаЭД - Ссылка - объект по которому необходимо сформировать электронный документ.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьФайлТорг12ПокупательФНС(СсылкаФайлНаЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
		
	РеквизитыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаФайлНаЭД, "НаименованиеФайла, ВладелецФайла,
		|ОтправительЭД, ПолучательЭД, ДатаФормированияЭДОтправителем");
		
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО, НастройкаЭДО, Контрагент,
		|НомерДокументаОтправителя, ДатаДокументаОтправителя, Организация, СуммаДокумента");
		
	СтруктураЭД = Новый Структура; // для создания ЭДПрисоединенныеФайлы
	СтруктураЭД.Вставить("НаправлениеЭД",                    Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("УникальныйИдентификатор",          Новый  УникальныйИдентификатор);
	СтруктураЭД.Вставить("НомерЭД",                          Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("Получатель",                       РеквизитыФайлаЭД.ОтправительЭД);
	СтруктураЭД.Вставить("ДатаЭД",                           ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Отправитель",                      РеквизитыФайлаЭД.ПолучательЭД);
	СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыФайлаЭД.НаименованиеФайла);
	СтруктураЭД.Вставить("ВладелецЭД",                       РеквизитыФайлаЭД.ВладелецФайла);
	СтруктураЭД.Вставить("Организация",                      РеквизитыЭД.Организация);
	СтруктураЭД.Вставить("Контрагент",                       РеквизитыЭД.Контрагент);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",               РеквизитыЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",                     РеквизитыЭД.НастройкаЭДО);
	СтруктураЭД.Вставить("ПрефиксИдФайла",                   "DP_PTORG12");
	СтруктураЭД.Вставить("ВидЭД",                            Перечисления.ВидыЭД.ТОРГ12Покупатель);
	СтруктураЭД.Вставить("КНД",                              "1175005");
	СтруктураЭД.Вставить("НомерДокументаОтправителя",        РеквизитыЭД.НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",         РеквизитыЭД.ДатаДокументаОтправителя);
	СтруктураЭД.Вставить("СуммаДокумента",                   РеквизитыЭД.СуммаДокумента);
	ПространствоИменВходящегоТитула = ЗначениеДопРеквизитаЭД(СсылкаФайлНаЭД, "ПространствоИмен");
	СтруктураЭД.Вставить("ПространствоИмен",                 ПространствоИменОтветногоТитула(ПространствоИменВходящегоТитула));
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.ТОРГ12_Покупатель");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоТОРГ12ПокупательФНС(СсылкаФайлНаЭД, СтруктураЭД, ДеревоДокумента, Отказ);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
		ДобавитьСлужебныеПоляФНС(ДеревоДокумента, СтруктураЭД);
		
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ВремДокТН",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДФ=HH.mm.ss"));
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ДатаДокТН",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДЛФ=D"));
		ВставитьЗначениеВДерево(ДеревоДокумента, "НомерТоварнойНакладной", РеквизитыЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаТоварнойНакладной",  РеквизитыЭД.ДатаДокументаОтправителя);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаФайлНаЭД.УникальныйИдентификатор());
		ИдФайл = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, "ИдФайл");
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		
		СтруктураПараметров.Вставить("ПолученныеЭП", ЭППолученногоФайла(СсылкаФайлНаЭД));
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИдФайлТН", РеквизитыФайлаЭД.НаименованиеФайла);
		
		Если СформироватьТорг12ПокупательФНСCML(ДеревоДокумента) Тогда
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(СтруктураПараметров.ПолноеИмяФайла));
			СтруктураЭД.Вставить("ИдФайла", ИдФайл);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			ВозвращаемоеЗначение = СтруктураЭД;
		КонецЕсли;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(АдресКаталога);
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаФайлНаЭД);	
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирует элемент справочника ЭДПрисоединенныеФайлы для соглашения об изменении стоимости получателя.
//
// Параметры:
//  СсылкаНаФайлЭД - СправочникСсылка - ссылка на новый элемент.
//
// Возвращаемое значение:
//  СправочникСсылка.ЭДПрисоединенныеФайлы - заполненный электронный документ.
//
Функция СформироватьЭДКорДокументаПолучатель(СсылкаНаФайлЭД) Экспорт
	
	ДобавленныйФайл = Неопределено;
	АдресВоВременномХранилище = "";
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
						СсылкаНаФайлЭД,
						"ВладелецФайла, УникальныйИД");
	СтруктураЭД = СформироватьФайлКорДокументаПолучателя(СсылкаНаФайлЭД);
	Если ТипЗнч(СтруктураЭД) = Тип("Структура")
			И СтруктураЭД.Свойство("АдресВоВременномХранилище", АдресВоВременномХранилище) Тогда
		
		ПараметрыФайла = Новый Структура();
		ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
		ПараметрыФайла.Вставить("ВладелецФайлов", РеквизитыЭД.ВладелецФайла);
		ПараметрыФайла.Вставить("ИмяБезРасширения", СтруктураЭД.ИдФайла);
		ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
		ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");

		НоваяСсылкаЭД = Справочники.ЭДПрисоединенныеФайлы.ПолучитьСсылку(СтруктураЭД.УникальныйИдентификатор);
		
		ДобавленныйФайл = РаботаСФайлами.ДобавитьФайл(
			ПараметрыФайла, АдресВоВременномХранилище, , , НоваяСсылкаЭД);
			
		СтруктураЭД.Вставить("СтатусЭД",                       Перечисления.СтатусыЭД.Утвержден);
		СтруктураЭД.Вставить("УникальныйИД",                   РеквизитыЭД.УникальныйИД);
		СтруктураЭД.Вставить("ЭлектронныйДокументВладелец",    СсылкаНаФайлЭД);
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",            Перечисления.ТипыЭлементовВерсииЭД.СоглашениеОбИзмененииСтоимостиПолучатель); 
		СтруктураЭД.Вставить("ДатаФормированияЭДОтправителем", ТекущаяДатаСеанса());
		СтруктураЭД.Вставить("НаименованиеФайла",              СтруктураЭД.ИдФайла);
		СтруктураЭД.Вставить("НомерЭД",              		   СтруктураЭД.УникальныйИдентификатор);
		
		ОбменСКонтрагентамиСлужебный.ИзменитьПоСсылкеПрисоединенныйФайл(ДобавленныйФайл, СтруктураЭД);
	КонецЕсли;
	
	Возврат ДобавленныйФайл;
	
КонецФункции

// Формирование электронного документа Корректировочная расходная накладная (титул отправителя) по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаФайлЭД - Ссылка - объект по которому необходимо сформировать электронный документ.
//
// Возвращаемое значение:
//  Структура - параметры данных.
//
Функция СформироватьФайлКорДокументаПолучателя(СсылкаНаФайлЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
		
	РеквизитыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаФайлЭД, "НаименованиеФайла, ВладелецФайла,
		|ДатаФормированияЭДОтправителем, ОтправительЭД, ПолучательЭД");
		
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО, НастройкаЭДО, Контрагент,
		|НомерДокументаОтправителя, ДатаДокументаОтправителя, Организация, СуммаДокумента");

			
	СтруктураЭД = Новый Структура; // для создания ЭДПрисоединенныеФайлы
	СтруктураЭД.Вставить("ВидЭД",                   Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиПолучатель);
	СтруктураЭД.Вставить("НаправлениеЭД",           Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("НомерЭД",                 Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("УникальныйИдентификатор", Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("Получатель", РеквизитыФайлаЭД.ОтправительЭД);
	
	СтруктураЭД.Вставить("ДатаЭД",                           ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Отправитель",                      РеквизитыФайлаЭД.ПолучательЭД);
	СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыФайлаЭД.НаименованиеФайла);
	СтруктураЭД.Вставить("ВладелецЭД",                       РеквизитыФайлаЭД.ВладелецФайла);
	СтруктураЭД.Вставить("НомерДокументаОтправителя",        РеквизитыЭД.НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",         РеквизитыЭД.ДатаДокументаОтправителя);
	СтруктураЭД.Вставить("Организация",                      РеквизитыЭД.Организация);
	СтруктураЭД.Вставить("Контрагент",                       РеквизитыЭД.Контрагент);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",               РеквизитыЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",                     РеквизитыЭД.НастройкаЭДО);
	СтруктураЭД.Вставить("ПрефиксИдФайла",                   "PKORDOC");
	СтруктураЭД.Вставить("КНД",                              "");
	СтруктураЭД.Вставить("СуммаДокумента",                   РеквизитыЭД.СуммаДокумента);
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.СоглашениеОбИзмененииСтоимостиПолучатель");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоКорректировочномуДокументуПолучатель(СсылкаНаФайлЭД, СтруктураЭД,
		ДеревоДокумента, Отказ);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
		ДобавитьСлужебныеПоляФНС(ДеревоДокумента, СтруктураЭД);
		
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ВремДокТН",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДФ=HH.mm.ss"));
		ВставитьЗначениеВДерево(ДеревоДокумента,
								"ДатаДокТН",
								Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДЛФ=D"));
		ВставитьЗначениеВДерево(ДеревоДокумента, "НомерТоварнойНакладной", РеквизитыЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаТоварнойНакладной",  РеквизитыЭД.ДатаДокументаОтправителя);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаФайлЭД.УникальныйИдентификатор());
		ИдФайл = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, "ИдФайл");
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		
		СтруктураПараметров.Вставить("ПолученныеЭП", ЭППолученногоФайла(СсылкаНаФайлЭД));
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИдФайлТН", РеквизитыФайлаЭД.НаименованиеФайла);
		
		Если СформироватьКорректировочныйДокументПокупательCML(ДеревоДокумента) Тогда
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(СтруктураПараметров.ПолноеИмяФайла));
			СтруктураЭД.Вставить("ИдФайла", ИдФайл);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			ВозвращаемоеЗначение = СтруктураЭД;
		КонецЕсли;
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаФайлЭД);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

// Формирует элемент справочника ЭДПрисоединенныеФайлы для акта заказчика.
//
// Параметры:
//  СсылкаНаЭД - СправочникСсылка - ссылка на новый элемент.
//
// Возвращаемое значение:
//  СправочникСсылка.ЭДПрисоединенныеФайлы - заполненный электронный документ.
//
Функция СформироватьЭДАкт501Заказчик(СсылкаНаЭД) Экспорт
	
	ДобавленныйФайл = Неопределено;
	АдресВоВременномХранилище = "";
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
						СсылкаНаЭД,
						"ВладелецФайла, УникальныйИД,  НаименованиеФайла"); 
						
	Если СтрНачинаетсяС(РеквизитыЭД.НаименованиеФайла, "DP_REZRUISP") Тогда
		СтруктураЭД = СформироватьПередачаРаботЗаказчик(СсылкаНаЭД);
	Иначе
		СтруктураЭД = СформироватьФайлАкт501ЗаказчикФНС(СсылкаНаЭД);
	КонецЕсли;
	
	Если ТипЗнч(СтруктураЭД) = Тип("Структура")
		И СтруктураЭД.Свойство("АдресВоВременномХранилище", АдресВоВременномХранилище) Тогда
		
		ДатаСозданияФайла = ТекущаяДатаСеанса();
		
		ПараметрыФайла = Новый Структура();
		ПараметрыФайла.Вставить("Автор", Пользователи.АвторизованныйПользователь());
		ПараметрыФайла.Вставить("ВладелецФайлов", РеквизитыЭД.ВладелецФайла);
		ПараметрыФайла.Вставить("ИмяБезРасширения", СтруктураЭД.ИдФайла);
		ПараметрыФайла.Вставить("РасширениеБезТочки", "xml");
		ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное");

		НоваяСсылкаЭД = Справочники.ЭДПрисоединенныеФайлы.ПолучитьСсылку(СтруктураЭД.УникальныйИдентификатор);
		
		ДобавленныйФайл = РаботаСФайлами.ДобавитьФайл(
			ПараметрыФайла, АдресВоВременномХранилище, , , НоваяСсылкаЭД);

		СтруктураЭД.Вставить("СтатусЭД",                       Перечисления.СтатусыЭД.Утвержден);
		СтруктураЭД.Вставить("УникальныйИД",                   РеквизитыЭД.УникальныйИД);
		СтруктураЭД.Вставить("ЭлектронныйДокументВладелец",    СсылкаНаЭД);
		СтруктураЭД.Вставить("ТипЭлементаВерсииЭД",            Перечисления.ТипыЭлементовВерсииЭД.АктЗаказчик); 
		СтруктураЭД.Вставить("ДатаФормированияЭДОтправителем", ДатаСозданияФайла);
		СтруктураЭД.Вставить("НаименованиеФайла",              СтруктураЭД.ИдФайла);
		СтруктураЭД.Вставить("НомерЭД",              		   СтруктураЭД.УникальныйИдентификатор);
		
		ОбменСКонтрагентамиСлужебный.ИзменитьПоСсылкеПрисоединенныйФайл(ДобавленныйФайл, СтруктураЭД);
	КонецЕсли;
	
	Возврат ДобавленныйФайл;
	
КонецФункции

// Формирование электронного документа Расходная накладная (титул покупателя) по ссылке на документ ИБ.
//
// Параметры:
//  СсылкаНаЭД - Ссылка - объект, по которому необходимо сформировать электронный документ.
//
// Возвращаемое значение:
//  Структура - параметры с данными документа.
//
Функция СформироватьФайлАкт501ЗаказчикФНС(СсылкаНаЭД)
	
	ВозвращаемоеЗначение = Неопределено;
	Ошибки = Неопределено; // служебная переменная для хранения списка возникших ошибок
	Отказ = Ложь;
	
	РеквизитыФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаЭД, "НаименованиеФайла, ВладелецФайла,
		|ДатаФормированияЭДОтправителем, ОтправительЭД, ПолучательЭД");
		
	РеквизитыЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыФайлаЭД.ВладелецФайла, "ПрофильНастроекЭДО, НастройкаЭДО, Контрагент,
		|НомерДокументаОтправителя, ДатаДокументаОтправителя, Организация, СуммаДокумента, ВерсияРегламентаЭДО");
		
	СтруктураЭД = Новый Структура; // для создания ЭДПрисоединенныеФайлы
	СтруктураЭД.Вставить("ВидЭД",                   Перечисления.ВидыЭД.АктЗаказчик);
	СтруктураЭД.Вставить("НаправлениеЭД",           Перечисления.НаправленияЭД.Исходящий);
	СтруктураЭД.Вставить("НомерЭД",                 Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("УникальныйИдентификатор", Новый УникальныйИдентификатор);
	СтруктураЭД.Вставить("Получатель", 				РеквизитыФайлаЭД.ОтправительЭД);
	
	СтруктураЭД.Вставить("ДатаЭД",                           ТекущаяДатаСеанса());
	СтруктураЭД.Вставить("Отправитель",                      РеквизитыФайлаЭД.ПолучательЭД);
	СтруктураЭД.Вставить("ИмяПолученногоФайлаБезРасширения", РеквизитыФайлаЭД.НаименованиеФайла);
	СтруктураЭД.Вставить("ВладелецЭД",                       РеквизитыФайлаЭД.ВладелецФайла);
	СтруктураЭД.Вставить("НомерДокументаОтправителя",        РеквизитыЭД.НомерДокументаОтправителя);
	СтруктураЭД.Вставить("ДатаДокументаОтправителя",         РеквизитыЭД.ДатаДокументаОтправителя);
	СтруктураЭД.Вставить("Организация",                      РеквизитыЭД.Организация);
	СтруктураЭД.Вставить("Контрагент",                       РеквизитыЭД.Контрагент);
	СтруктураЭД.Вставить("ПрофильНастроекЭДО",               РеквизитыЭД.ПрофильНастроекЭДО);
	СтруктураЭД.Вставить("СоглашениеЭД",                     РеквизитыЭД.НастройкаЭДО);
	СтруктураЭД.Вставить("ПрефиксИдФайла",                   "DP_ZAKTPRM");
	СтруктураЭД.Вставить("КНД",                              "1175007");
	СтруктураЭД.Вставить("СуммаДокумента",                   РеквизитыЭД.СуммаДокумента);
	ПространствоИменВходящегоТитула = ЗначениеДопРеквизитаЭД(СсылкаНаЭД, "ПространствоИмен");
	СтруктураЭД.Вставить("ПространствоИмен",                 ПространствоИменОтветногоТитула(ПространствоИменВходящегоТитула));
	
	ДеревоДокумента = ЭлектронноеВзаимодействие.ДеревоЭлектронногоДокумента("ОбменСКонтрагентами.Акт501_Заказчик");
	ОбменСКонтрагентамиПереопределяемый.ЗаполнитьДанныеПоАкт501ЗаказчикФНС(СсылкаНаЭД, СтруктураЭД, ДеревоДокумента, Отказ);
	
	// Выполним проверки корректности заполнения данных в дереве.
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда	
		ЭлектронноеВзаимодействиеСлужебный.ПроверитьЗаполнениеРеквизитовДереваДанныхРекурсивно(ДеревоДокумента, Ошибки);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ошибки) И Не Отказ Тогда
			
		ДобавитьСлужебныеПоляФНС(ДеревоДокумента, СтруктураЭД);
		
		Реквизит = Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДФ=HH.mm.ss");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ВремДокАктИ", Реквизит);
		Реквизит = Формат(РеквизитыФайлаЭД.ДатаФормированияЭДОтправителем, "ДЛФ=D");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаДокАктИ", Реквизит);
		ВставитьЗначениеВДерево(ДеревоДокумента, "НомерАкт", РеквизитыЭД.НомерДокументаОтправителя);
		ВставитьЗначениеВДерево(ДеревоДокумента, "ДатаАкт",  РеквизитыЭД.ДатаДокументаОтправителя);
		
		АдресКаталога = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(, СсылкаНаЭД.УникальныйИдентификатор());
		ИдФайл = ЭлектронноеВзаимодействиеСлужебный.ЗначениеРеквизитаВДереве(ДеревоДокумента, "ИдФайл");
		СтруктураПараметров = Новый Структура();
		СтруктураПараметров.Вставить("ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		ВставитьЗначениеВДерево(ДеревоДокумента, "ПолноеИмяФайла", АдресКаталога + ИдФайл + ".xml");
		
		СтруктураПараметров.Вставить("ПолученныеЭП", ЭППолученногоФайла(СсылкаНаЭД));
		
		ВставитьЗначениеВДерево(ДеревоДокумента, "ИдФайлАктИ", РеквизитыФайлаЭД.НаименованиеФайла);
		
		Если СформироватьАкт501ЗаказчикФНСCML(ДеревоДокумента, РеквизитыЭД.ВерсияРегламентаЭДО) Тогда
			АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(СтруктураПараметров.ПолноеИмяФайла));
			СтруктураЭД.Вставить("ИдФайла", ИдФайл);
			СтруктураЭД.Вставить("АдресВоВременномХранилище", АдресВоВременномХранилище);
			ВозвращаемоеЗначение = СтруктураЭД;
		КонецЕсли;
	КонецЕсли;
	
	// Если были ошибки, обработаем их.
	ОбработатьОшибкиФормированияЭД(Ошибки, СтруктураЭД.ВидЭД, СсылкаНаЭД);
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

#КонецОбласти

#Область ЗаполнениеФайлов

// Заполняет свойство объекта XDTO.
//
// Параметры:
//  ОбъектXDTO - ОбъектXDTO - объект заполнения.
//  ИмяСвойства - Строка - свойство объекта.
//  Значение - Произвольный - устанавливаемое значение.
//  Обязательное - Булево - признак обязательности заполнения свойства;
//  ТекстОшибки - Строка - текст ошибки в случае неудачного заполнения;
//  УстанавливатьПустыеЗначения - Булево - если Истина, то пустое значение будет записано в ОбъектXDTO.
//
Процедура ЗаполнитьСвойствоXDTO(ОбъектXDTO, ИмяСвойства, Значение, Обязательное = Ложь, Ошибки = Неопределено,
	УстанавливатьПустыеЗначения = Ложь) Экспорт
	
	Если ТипЗнч(Значение) = Тип("ЗначениеXDTO") ИЛИ ТипЗнч(Значение) = Тип("ОбъектXDTO") Тогда
		УстановитьЗначениеXDTO(ОбъектXDTO, ИмяСвойства, Значение, Ошибки);
	Иначе
		Если Обязательное ИЛИ ЗначениеЗаполнено(Значение) ИЛИ УстанавливатьПустыеЗначения Тогда
			УстановитьЗначениеXDTO(ОбъектXDTO, ИмяСвойства, Значение, Ошибки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Возвращает идентификационный номер электронного документа.
//
// Параметры:
//  СсылкаНаОбъект - Ссылка - ссылка на электронный документ, идентификационный номер которого необходимо получить.
//
// Возвращаемое значение:
//  Строка - строка формата "ИдОтправителя#ИДСсылкиОбъектаИБ##НомерВерсии".
//
Функция ВернутьИдЭД(СсылкаНаОбъект) Экспорт
	
	ИдЭД = Строка(СсылкаНаОбъект.УникальныйИдентификатор());
	
	Возврат ИдЭД;
	
КонецФункции

#КонецОбласти

#Область РазборФайлов

// Осуществляет разбор файла с реквизитами контрагента.
//
// Параметры:
//  СсылкаНаФайл - Строка - адрес хранилища файла с реквизитами контрагента.
//  СтруктураВозврата - Структура - данные контрагента.
//  ОшибкаРазбора - Булево - если Истина, то при разборе файла произошла ошибка.
//
Процедура РазобратьФайлРеквизитовКонтрагента(СсылкаНаФайл, СтруктураВозврата, ОшибкаРазбора) Экспорт
	
	ОшибкаРазбора = Ложь;
	СтруктураВозврата.Вставить("ТелефонПартнера");
	СтруктураВозврата.Вставить("ТелефонКЛ");
	СтруктураВозврата.Вставить("АдресЭППартнера");
	СтруктураВозврата.Вставить("УказыватьЮридическиеРеквизиты");
	СтруктураВозврата.Вставить("НомерСчета");
	СтруктураВозврата.Вставить("БИКБанка");
	СтруктураВозврата.Вставить("КоррСчетБанка");
	СтруктураВозврата.Вставить("ПредставлениеБанка");
	СтруктураВозврата.Вставить("УказатьБанковскийСчетКонтрагента");
	СтруктураВозврата.Вставить("ИспользуетсяБанкДляРасчетов");
	СтруктураВозврата.Вставить("БИКБанкаДляРасчетов");
	СтруктураВозврата.Вставить("КоррСчетБанкаДляРасчетов");
	СтруктураВозврата.Вставить("ПредставлениеБанкаДляРасчетов");
	СтруктураВозврата.Вставить("ВидКомпании");
	СтруктураВозврата.Вставить("ИНН");
	СтруктураВозврата.Вставить("КПП");
	СтруктураВозврата.Вставить("КодПоОКПО");
	СтруктураВозврата.Вставить("НаименованиеКонтрагента");
	СтруктураВозврата.Вставить("ЮридическийАдрес");
	СтруктураВозврата.Вставить("ЮридическийАдресЗначенияПолей");
	СтруктураВозврата.Вставить("УказатьДанныеКонтактногоЛица");
	СтруктураВозврата.Вставить("ФамилияКЛ");
	СтруктураВозврата.Вставить("ИмяКЛ");
	СтруктураВозврата.Вставить("ОтчествоКЛ");
	СтруктураВозврата.Вставить("ФамилияКонтрагента");
	СтруктураВозврата.Вставить("ИмяКонтрагента");
	СтруктураВозврата.Вставить("ОтчествоКонтрагента");
	СтруктураВозврата.Вставить("Название");
	СтруктураВозврата.Вставить("ФактическийАдрес");
	СтруктураВозврата.Вставить("ФактическийАдресЗначенияПолей");

	РезультатРазбора = Ложь;
	ОбменСКонтрагентамиПереопределяемый.РазобратьФайлРеквизитовКонтрагента(СсылкаНаФайл, СтруктураВозврата, РезультатРазбора, ОшибкаРазбора);
	
	Если ТипЗнч(РезультатРазбора) <> Тип("Булево") ИЛИ РезультатРазбора = Ложь Тогда
		ОбъектXML = Новый ЧтениеXML;
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(СсылкаНаФайл);
		ВремФайл = ОбменСКонтрагентамиСлужебный.ТекущееИмяВременногоФайла("xml");
		ДвоичныеДанные.Записать(ВремФайл);
		
		Попытка
			ОбъектXML.ОткрытьФайл(ВремФайл);
			ЭД = ФабрикаXDTO.ПрочитатьXML(ОбъектXML);
		Исключение
			ОбъектXML.Закрыть();
			ОшибкаРазбора = Истина;
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
			Возврат;
		КонецПопытки;
		
		Если НЕ ЭД.Тип() = ПолучитьТипЗначенияCML("Контрагент", "4.02") Тогда
			ОбъектXML.Закрыть();
			ОшибкаРазбора = Истина;
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
			Возврат;
		КонецЕсли;
		
		Попытка
			СвойствоЭД = ЭД.Свойства().Получить("Контакты");
			Если НЕ СвойствоЭД = Неопределено И НЕ ЭД.Контакты = Неопределено Тогда
				Для Каждого ТекКонтакт Из ЭД.Контакты.Контакт Цикл
					Если ТекКонтакт.Тип = НСтр("ru = 'Телефон рабочий'") Тогда
						СтруктураВозврата.ТелефонПартнера = ТекКонтакт.Значение;
						СтруктураВозврата.ТелефонКЛ = ТекКонтакт.Значение;
					ИначеЕсли ТекКонтакт.Тип = НСтр("ru = 'Почта'") Тогда
						СтруктураВозврата.АдресЭППартнера = ТекКонтакт.Значение;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			СвойствоЭД = ЭД.Свойства().Получить("РасчетныеСчета");
			Если СвойствоЭД <> Неопределено Тогда
				
				ЗначениеСвойства = ЭД.Получить(СвойствоЭД);
				Если ЗначениеСвойства <> Неопределено Тогда
					Для Каждого ТекущееСвойство Из ЗначениеСвойства.РасчетныйСчет Цикл
						
						СтруктураВозврата.НомерСчета = ТекущееСвойство.НомерСчета;
						СтруктураВозврата.БИКБанка = ТекущееСвойство.Банк.БИК;
						СтруктураВозврата.КоррСчетБанка = ТекущееСвойство.Банк.СчетКорреспондентский;
						СтруктураВозврата.ПредставлениеБанка = ТекущееСвойство.Банк.Наименование;
						СтруктураВозврата.УказатьБанковскийСчетКонтрагента = Истина;
						
						Если НЕ ТекущееСвойство.БанкКорреспондент = Неопределено Тогда
							СтруктураВозврата.ИспользуетсяБанкДляРасчетов = Истина;
							СтруктураВозврата.БИКБанкаДляРасчетов = ТекущееСвойство.БанкКорреспондент.БИК;
							СтруктураВозврата.КоррСчетБанкаДляРасчетов = ТекущееСвойство.БанкКорреспондент.СчетКорреспондентский;
							СтруктураВозврата.ПредставлениеБанкаДляРасчетов = ТекущееСвойство.БанкКорреспондент.Наименование;
						КонецЕсли;
						Прервать;
					КонецЦикла
				КонецЕсли;
			КонецЕсли;
			
			СтруктураВозврата.УказыватьЮридическиеРеквизиты = Истина;
			ДопустимыеТипы = "Страна, Регион, Район, Город, Улица, Дом, Корпус, Квартира";
			
			СвойствоЭД = ЭД.Свойства().Получить("ЮрЛицо");
			Если СвойствоЭД <> Неопределено Тогда
				ЗначениеСвойства = ЭД.Получить(СвойствоЭД);
				Если ЗначениеСвойства <> Неопределено Тогда
					СтруктураВозврата.ВидКомпании = 0;
					СвойствоИНН = ЗначениеСвойства.Свойства().Получить("ИНН");
					Если СвойствоИНН <> Неопределено Тогда
						СтруктураВозврата.ИНН = ЗначениеСвойства.Получить(СвойствоИНН);
					КонецЕсли;
					СвойствоКПП = ЗначениеСвойства.Свойства().Получить("КПП");
					Если СвойствоКПП <> Неопределено Тогда
						СтруктураВозврата.КПП = ЗначениеСвойства.Получить(СвойствоКПП);
					КонецЕсли;
					СвойствоОКПО = ЗначениеСвойства.Свойства().Получить("ОКПО");
					Если СвойствоОКПО <> Неопределено Тогда
						СтруктураВозврата.КодПоОКПО = ЗначениеСвойства.Получить(СвойствоОКПО);
					КонецЕсли;
					ОфициальноеНаименование = ЗначениеСвойства.Свойства().Получить("ОфициальноеНаименование");
					Если ОфициальноеНаименование <> Неопределено Тогда
						СтруктураВозврата.НаименованиеКонтрагента = ЗначениеСвойства.Получить(ОфициальноеНаименование);
					КонецЕсли;
					
					СвойствоАдрес = ЗначениеСвойства.Свойства().Получить("ЮридическийАдрес");
					Если СвойствоАдрес <> Неопределено Тогда
						ЗначениеАдреса = ЗначениеСвойства.Получить(СвойствоАдрес);
						Если ЗначениеАдреса <> Неопределено Тогда
							
							СтруктураВозврата.ЮридическийАдрес = ЗначениеАдреса.Представление;
							ЮридическийАдрес = Новый СписокЗначений;
							Для Каждого ТекущееСвойство Из ЗначениеАдреса.АдресноеПоле Цикл
								Если ТекущееСвойство.Тип = НСтр("ru ='Почтовый индекс'") Тогда
									ЗначениеПоляАдреса = ЮридическийАдрес.Добавить();
									ЗначениеПоляАдреса.Представление =  "Индекс";
									ЗначениеПоляАдреса.Значение = ТекущееСвойство.Значение;
								ИначеЕсли ТекущееСвойство.Тип = НСтр("ru ='Населенный пункт'") Тогда
									ЗначениеПоляАдреса = ЮридическийАдрес.Добавить();
									ЗначениеПоляАдреса.Представление = "НаселенныйПункт";
									ЗначениеПоляАдреса.Значение = ТекущееСвойство.Значение;
								ИначеЕсли СтрНайти(ДопустимыеТипы, ТекущееСвойство.Тип) > 0 Тогда
									ЗначениеПоляАдреса = ЮридическийАдрес.Добавить();
									ЗначениеПоляАдреса.Представление = ТекущееСвойство.Тип;
									ЗначениеПоляАдреса.Значение = ТекущееСвойство.Значение;
								КонецЕсли;
							КонецЦикла;
							
							СтруктураВозврата.ЮридическийАдресЗначенияПолей = ЮридическийАдрес;
						КонецЕсли
					КонецЕсли;
					
					СвойствоРуководитель = ЗначениеСвойства.Свойства().Получить("Руководитель");
					Если СвойствоРуководитель <> Неопределено Тогда
						РуководительЗначение = ЗначениеСвойства.Получить(СвойствоРуководитель);
						Если РуководительЗначение <> Неопределено Тогда
							СвойствоФизЛицо = РуководительЗначение.Свойства().Получить("ФизЛицо");
							Если СвойствоФизЛицо<> Неопределено Тогда
								ФизЛицо = РуководительЗначение.Получить(СвойствоФизЛицо);
								Если ФизЛицо <> Неопределено Тогда
									СтруктураВозврата.УказатьДанныеКонтактногоЛица = Истина;
									ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(ФизЛицо.ПолноеНаименование);
									СтруктураВозврата.ФамилияКЛ = ФИО.Фамилия;
									СтруктураВозврата.ИмяКЛ = ФИО.Имя;
									СтруктураВозврата.ОтчествоКЛ = ФИО.Отчество;
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			СвойствоЭД = ЭД.Свойства().Получить("ФизЛицо");
			Если СвойствоЭД <> Неопределено Тогда
				ЗначениеСвойства = ЭД.Получить(СвойствоЭД);
				Если ЗначениеСвойства <> Неопределено Тогда
					
					СтруктураВозврата.ВидКомпании = 2;
					СвойствоИНН = ЗначениеСвойства.Свойства().Получить("ИНН");
					Если СвойствоИНН <> Неопределено Тогда
						СтруктураВозврата.ИНН = ЗначениеСвойства.Получить(СвойствоИНН);
					КонецЕсли;
					
					СвойствоОКПО = ЗначениеСвойства.Свойства().Получить("ОКПО");
					Если СвойствоОКПО <> Неопределено Тогда
						КодПоОКПО = ЗначениеСвойства.Получить(СвойствоОКПО);
						СтруктураВозврата.КодПоОКПО = ЗначениеСвойства.Получить(СвойствоОКПО);
					КонецЕсли;
					
					ОфициальноеНаименование = ЗначениеСвойства.Свойства().Получить("ПолноеНаименование");
					Если ОфициальноеНаименование <> Неопределено Тогда
						СтруктураВозврата.НаименованиеКонтрагента = ЗначениеСвойства.Получить(ОфициальноеНаименование);
						ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(СтруктураВозврата.НаименованиеКонтрагента);
						СтруктураВозврата.ФамилияКонтрагента =  ФИО.Фамилия;
						СтруктураВозврата.ИмяКонтрагента =      ФИО.Имя;
						СтруктураВозврата.ОтчествоКонтрагента = ФИО.Отчество;
					КонецЕсли;
					
					СвойствоАдрес = ЗначениеСвойства.Свойства().Получить("ЮридическийАдрес");
					Если СвойствоАдрес <> Неопределено Тогда
						
						ЗначениеАдреса = ЗначениеСвойства.Получить(СвойствоАдрес);
						Если ЗначениеАдреса <> Неопределено Тогда
							
							СтруктураВозврата.ЮридическийАдрес = ЗначениеАдреса.Представление;
							ЮридическийАдрес = Новый СписокЗначений;
							Для Каждого ТекущееСвойство Из ЗначениеАдреса.АдресноеПоле Цикл
								Если ТекущееСвойство.Тип = НСтр("ru ='Почтовый индекс'") Тогда
									ЗначениеПоляАдреса = ЮридическийАдрес.Добавить();
									ЗначениеПоляАдреса.Представление = "Индекс";
									ЗначениеПоляАдреса.Значение = ТекущееСвойство.Значение;
								ИначеЕсли ТекущееСвойство.Тип = НСтр("ru ='Населенный пункт'") Тогда
									ЗначениеПоляАдреса = ЮридическийАдрес.Добавить();
									ЗначениеПоляАдреса.Представление = "НаселенныйПункт";
									ЗначениеПоляАдреса.Значение = ТекущееСвойство.Значение;
								ИначеЕсли СтрНайти(ДопустимыеТипы, ТекущееСвойство.Тип)>0 Тогда
									ЗначениеПоляАдреса = ЮридическийАдрес.Добавить();
									ЗначениеПоляАдреса.Представление = ТекущееСвойство.Тип;
									ЗначениеПоляАдреса.Значение = ТекущееСвойство.Значение;
								КонецЕсли;
							КонецЦикла;
							
							СтруктураВозврата.ЮридическийАдресЗначенияПолей = ЮридическийАдрес;
						КонецЕсли
					КонецЕсли;
				КонецЕсли
			КонецЕсли;
			
			СвойствоЭД = ЭД.Свойства().Получить("Наименование");
			Если СвойствоЭД <> Неопределено Тогда
				СтруктураВозврата.Название = ЭД.Получить(СвойствоЭД);
			КонецЕсли;
			
			СвойствоЭД = ЭД.Свойства().Получить("Адрес");
			Если СвойствоЭД <> Неопределено Тогда
				ЗначениеСвойства = ЭД.Получить(СвойствоЭД);
				Если ЗначениеСвойства <> Неопределено Тогда
					
					СтруктураВозврата.ФактическийАдрес = ЗначениеСвойства.Представление;
					ФактическийАдресЗначенияПолей = Новый СписокЗначений;
					Для Каждого ТекущееСвойство Из ЗначениеСвойства.АдресноеПоле Цикл
						Если ТекущееСвойство.Тип = НСтр("ru ='Почтовый индекс'") Тогда
							ФактАдресЗначения = ФактическийАдресЗначенияПолей.Добавить();
							ФактАдресЗначения.Представление = "Индекс";
							ФактАдресЗначения.Значение = ТекущееСвойство.Значение;
						ИначеЕсли ТекущееСвойство.Тип = НСтр("ru ='Населенный пункт'") Тогда
							ФактАдресЗначения = ФактическийАдресЗначенияПолей.Добавить();
							ФактАдресЗначения.Представление = "НаселенныйПункт";
							ФактАдресЗначения.Значение = ТекущееСвойство.Значение;
						ИначеЕсли СтрНайти(ДопустимыеТипы, ТекущееСвойство.Тип)>0 Тогда
							ФактАдресЗначения = ФактическийАдресЗначенияПолей.Добавить();
							ФактАдресЗначения.Значение = ТекущееСвойство.Значение;
							ФактАдресЗначения.Представление = ТекущееСвойство.Тип;
						КонецЕсли;
					КонецЦикла;
					
					СтруктураВозврата.ФактическийАдресЗначенияПолей = ФактическийАдресЗначенияПолей;
				КонецЕсли;
			КонецЕсли;
		Исключение
			ОшибкаРазбора = Истина;
		КонецПопытки;
		ОбъектXML.Закрыть();
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ВремФайл);
	КонецЕсли;
	
КонецПроцедуры

// Удаляет пространство имен из файла
//
// Параметры:
//   ИмяФайла - Строка - путь к файлу на диске
//   ПространствоИмен - Строка - удаляемое пространство имен.
//
Процедура УдалитьПространствоИмен(ИмяФайла, ПространствоИмен) Экспорт
	
	Текст = Новый ТекстовыйДокумент;
	Текст.Прочитать(ИмяФайла,"windows-1251");
	СтрокаФайл = Текст.ПолучитьСтроку(2);
	СтрокаФайл = СтрЗаменить(СтрокаФайл, "xmlns=""" + ПространствоИмен + """", "");
	Текст.ЗаменитьСтроку(2, СтрокаФайл);
	Текст.Записать(ИмяФайла, "windows-1251");
	
КонецПроцедуры

#КонецОбласти

#Область ПросмотрЭлектронныхДокументов

// Формирование печатной формы электронного документа
//
// Параметры:
//  СсылкаНаФайлЭД - Ссылка - ссылка на электронный документ.
//  ПараметрыПросмотра - Структура - параметры формирования.
// 
// Возвращаемое значение:
//  Строка - Адрес во временном хранилище.
//
Функция ФайлДанныхЭД(СсылкаНаФайлЭД, ПараметрыПросмотра) Экспорт
	
	// Структура содержащая поля "ИмяФайла", "Наименование", "Расширение".
	ПараметрыФайла = СвойстваФайла();
	СохранитьЭДВФайл(СсылкаНаФайлЭД, ПараметрыФайла);
	ИмяФайла = ПараметрыФайла.ИмяФайла;
	
	Если ИмяФайла = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ПараметрыПросмотра.Вставить("ИмяФайла", ИмяФайла);
	ИмяФайлаДопДанных = Неопределено;
	СохранитьДопДанныеВФайл(СсылкаНаФайлЭД, ИмяФайлаДопДанных);
	ПараметрыПросмотра.Вставить("ИмяФайлаДопДанных", ИмяФайлаДопДанных);
	УникальныйИдентификатор = ЗначениеПараметра(ПараметрыПросмотра, "УникальныйИдентификатор");
	Идентификатор = ЗначениеПараметра(ПараметрыПросмотра, "Идентификатор");
	СтруктураПодписей = ЗначениеПараметра(ПараметрыПросмотра, "СтруктураПодписей");
	ИмяФайлаПодчиненногоЭД = ЗначениеПараметра(ПараметрыПросмотра, "ИмяФайлаПодчиненногоЭД");
	СкрыватьИдентификаторДокумента = ЗначениеПараметра(ПараметрыПросмотра, "СкрыватьИдентификаторДокумента", Истина);
	СкрыватьДопДанные = ЗначениеПараметра(ПараметрыПросмотра, "СкрыватьДопДанные", Истина);
	СкрыватьКопияВерна = ЗначениеПараметра(ПараметрыПросмотра, "СкрыватьКопияВерна", Истина);
	
	ПечатьЭД = ЗначениеПараметра(ПараметрыПросмотра, "ПечатьЭД");
	Если ПечатьЭД = Неопределено Тогда
		ПечатьЭД = Ложь;
	КонецЕсли;
	
	СвойстваФайлаЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаФайлЭД, "ТипЭлементаВерсииЭД,НаправлениеЭД,ВладелецФайла");
	СвойстваЭД = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СвойстваФайлаЭД.ВладелецФайла, "ВидЭД");
	
	ИмяФайлаВторогоТитула = ИмяФайлаПодчиненногоЭД;
	Если ИмяФайлаПодчиненногоЭД = Неопределено Тогда
		Если ОбменСКонтрагентамиСлужебный.ЭтоТитулФНС(СсылкаНаФайлЭД.ВладелецФайла) Тогда
			ФайлВторогоТитула = ОбменСКонтрагентамиСлужебный.ВторойТитулДокумента(СсылкаНаФайлЭД);
			Если НЕ ФайлВторогоТитула = Неопределено Тогда
				ПараметрыФайла = СвойстваФайла();
				СохранитьЭДВФайл(ФайлВторогоТитула, ПараметрыФайла);
				ИмяФайлаВторогоТитула = ПараметрыФайла.ИмяФайла;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если СтрНайти(ПараметрыФайла.Расширение, "zip") > 0 Тогда
		
		ПапкаДляРаспаковки = ЭлектронноеВзаимодействиеСлужебный.РабочийКаталог(,СсылкаНаФайлЭД.УникальныйИдентификатор());
		Если ПапкаДляРаспаковки = Неопределено Тогда
			ТекстОшибки = НСтр("ru = 'Не удалось просмотреть электронный документ. Проверьте настройку рабочего каталога'");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
			Возврат Неопределено;
		КонецЕсли;
		
		Если Не РаспаковатьАрхив(ИмяФайла, ПапкаДляРаспаковки, НСтр("ru = 'Распаковка пакета ЭД'")) Тогда
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
			Возврат Неопределено;
		КонецЕсли;
		
		ФайлыАрхиваXML = НайтиФайлы(ПапкаДляРаспаковки, "*.xml");
		
		Для Каждого РаспакованныйФайл Из ФайлыАрхиваXML Цикл
			ИмяФайлаДанных = РаспакованныйФайл.ПолноеИмя;
			Если СтрНайти(РаспакованныйФайл.Имя, "packageDescription") Тогда
				ДвоичныеДанныеФайла = Новый ДвоичныеДанные(ИмяФайла);
				СсылкаНаФайл = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
				Возврат СсылкаНаФайл;
			КонецЕсли;
			ПараметрыПечати = Новый Структура;
			ПараметрыПечати.Вставить("ИД",СсылкаНаФайлЭД.УникальныйИдентификатор());
			ПараметрыПечати.Вставить("ИмяФайлаДопДанных", ИмяФайлаДопДанных);
			ПараметрыПечати.Вставить("СтруктураПодписей", СтруктураПодписей);
			ПараметрыПечати.Вставить("ИмяФайлаПодчиненногоЭД", ИмяФайлаВторогоТитула);
			ПараметрыПечати.Вставить("СкрыватьИдентификаторДокумента", СкрыватьИдентификаторДокумента);
			ПараметрыПечати.Вставить("СкрыватьДопДанные", СкрыватьДопДанные);
			ПараметрыПечати.Вставить("СкрыватьКопияВерна", СкрыватьКопияВерна);
			ТабличныйДокумент = СформироватьПечатнуюФормуЭД(РаспакованныйФайл.ПолноеИмя, СвойстваФайлаЭД.НаправлениеЭД,
				ПараметрыПечати);
			Если ТипЗнч(ТабличныйДокумент) = Тип("ТабличныйДокумент") Тогда
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
				Возврат ТабличныйДокумент;
			КонецЕсли;
		КонецЦикла;
		
		ФайлыАрхиваMXL = НайтиФайлы(ПапкаДляРаспаковки, "*.mxl");
		Для Каждого РаспакованныйФайл Из ФайлыАрхиваMXL Цикл
			ИмяФайлаДанных = РаспакованныйФайл.ПолноеИмя;
			ТабличныйДокумент = Новый ТабличныйДокумент;
			ТабличныйДокумент.Прочитать(ИмяФайлаДанных);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
			Возврат ТабличныйДокумент;
		КонецЦикла;
		
		Если СвойстваЭД.ВидЭД = Перечисления.ВидыЭД.АктНаПередачуПрав И Не ПечатьЭД Тогда
			ФайлыАрхиваPDF = НайтиФайлы(ПапкаДляРаспаковки, "*.pdf");
			Для Каждого РаспакованныйФайл Из ФайлыАрхиваPDF Цикл
				ДвоичныеДанныеФайла = Новый ДвоичныеДанные(РаспакованныйФайл.ПолноеИмя);
				СсылкаНаФайл = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);
				ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
				Возврат СсылкаНаФайл;
			КонецЦикла;
		КонецЕсли;
		
		ФайлыАрхиваHTML = НайтиФайлы(ПапкаДляРаспаковки, "*.html");
		Для Каждого РаспакованныйФайл Из ФайлыАрхиваHTML Цикл
			ДвоичныеДанныеФайла = Новый ДвоичныеДанные(РаспакованныйФайл.ПолноеИмя);
			СсылкаНаФайл = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
			Возврат СсылкаНаФайл;
		КонецЦикла;
		
		ФайлыАрхиваDOCX = НайтиФайлы(ПапкаДляРаспаковки, "*.docx");
		Для Каждого РаспакованныйФайл Из ФайлыАрхиваDOCX Цикл
			ДвоичныеДанныеФайла = Новый ДвоичныеДанные(РаспакованныйФайл.ПолноеИмя);
			СсылкаНаФайл = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
			Возврат СсылкаНаФайл;
		КонецЦикла;
		
		ФайлыАрхиваXLS = НайтиФайлы(ПапкаДляРаспаковки, "*.xls");
		Для Каждого РаспакованныйФайл Из ФайлыАрхиваXLS Цикл
			ДвоичныеДанныеФайла = Новый ДвоичныеДанные(РаспакованныйФайл.ПолноеИмя);
			СсылкаНаФайл = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
			Возврат СсылкаНаФайл;
		КонецЦикла;
		
		ФайлыАрхиваXML = НайтиФайлы(ПапкаДляРаспаковки, "*.xml");
		Для Каждого РаспакованныйФайл Из ФайлыАрхиваXML Цикл
			ДвоичныеДанныеФайла = Новый ДвоичныеДанные(РаспакованныйФайл.ПолноеИмя);
			СсылкаНаФайл = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);
			ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
			Возврат СсылкаНаФайл;
		КонецЦикла;
		
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ПапкаДляРаспаковки);
		
	ИначеЕсли СтрНайти(ПараметрыФайла.Расширение, "xml") > 0 Тогда
		
		ПараметрыПечати = Новый Структура;
		ПараметрыПечати.Вставить("ИД", СсылкаНаФайлЭД.УникальныйИдентификатор());
		ПараметрыПечати.Вставить("ИмяФайлаПодчиненногоЭД", ИмяФайлаВторогоТитула);
		ПараметрыПечати.Вставить("СтруктураПодписей", СтруктураПодписей);
		ПараметрыПечати.Вставить("ИмяФайлаДопДанных", ИмяФайлаДопДанных);
		ПараметрыПечати.Вставить("СкрыватьИдентификаторДокумента", СкрыватьИдентификаторДокумента);
		ПараметрыПечати.Вставить("СкрыватьДопДанные", СкрыватьДопДанные);
		ПараметрыПечати.Вставить("СкрыватьКопияВерна", СкрыватьКопияВерна);

		Если ОбменСКонтрагентамиСлужебный.ЭтоОтветныйТитул(СвойстваФайлаЭД.ТипЭлементаВерсииЭД) Тогда
			
			// Для ответных титулов передадим номер и дату документа ИБ первого титула
			ПервыйТитул = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаФайлЭД, "ВладелецФайла"); 
			СвойстваДокументаПервогоТитула = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПервыйТитул, "НомерДокументаОтправителя, ДатаДокументаОтправителя");
			ПараметрыПечати.Вставить("СвойстваДокументаПервогоТитула", СвойстваДокументаПервогоТитула);

		ИначеЕсли ОбменСКонтрагентамиСлужебный.ЭтоПодтверждение(СвойстваФайлаЭД.ТипЭлементаВерсииЭД)
			ИЛИ ОбменСКонтрагентамиСлужебный.ЭтоИзвещениеОПолучении(СвойстваФайлаЭД.ТипЭлементаВерсииЭД)
			ИЛИ ОбменСКонтрагентамиСлужебный.ЭтоУведомлениеОбУточнении(СвойстваФайлаЭД.ТипЭлементаВерсииЭД)
			ИЛИ СвойстваФайлаЭД.ТипЭлементаВерсииЭД = Перечисления.ТипыЭлементовВерсииЭД.ПОА
			ИЛИ СвойстваЭД.ВидЭД = Перечисления.ВидыЭД.ТОРГ12Продавец
			ИЛИ СвойстваЭД.ВидЭД = Перечисления.ВидыЭД.АктИсполнитель
			ИЛИ СвойстваЭД.ВидЭД = Перечисления.ВидыЭД.СоглашениеОбИзмененииСтоимостиОтправитель
			ИЛИ СвойстваЭД.ВидЭД = Перечисления.ВидыЭД.СчетФактура
			ИЛИ СвойстваЭД.ВидЭД = Перечисления.ВидыЭД.КорректировочныйСчетФактура Тогда
				ПараметрыПечати.Вставить("ИмяФайлаДопДанных", ИмяФайлаДопДанных);
				ПараметрыПечати.Вставить("Идентификатор", Идентификатор);
			
		КонецЕсли;
		
		ТабличныйДокумент = СформироватьПечатнуюФормуЭД(ИмяФайла, СсылкаНаФайлЭД.НаправлениеЭД, ПараметрыПечати);
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
		
		Если ТипЗнч(ТабличныйДокумент)=Тип("ТабличныйДокумент") Тогда
			Возврат ТабличныйДокумент;
		КонецЕсли;
		
	Иначе
		
		ДвоичныеДанныеФайла = Новый ДвоичныеДанные(ИмяФайла);
		СсылкаНаФайл = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, УникальныйИдентификатор);
		ЭлектронноеВзаимодействиеСлужебный.УдалитьВременныеФайлы(ИмяФайла);
		Возврат СсылкаНаФайл;
		
	КонецЕсли;
	
КонецФункции

#КонецОбласти
