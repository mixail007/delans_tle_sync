
#Область РаботаСТабличнойЧастьюНоменклатуры

//Заполняет данные строки табличной части документа, выбранной из списка номенклатуры в новый документ
//Объект - заполняемый документ
//ИмяТабличнойЧасти - Имя табличной части документа, куда добавляется строка
//СтрокаТабличнойЧасти - заполняемая строка
Процедура ЗаполнитьДанныеВСтрокеТабличнойЧасти(Объект, ИмяТабличнойЧасти, СтрокаТабличнойЧасти) Экспорт
	
	СтруктураДанные = Новый Структура;
	СтруктураДанные.Вставить("Организация", Объект.Организация);
	СтруктураДанные.Вставить("Номенклатура", СтрокаТабличнойЧасти.Номенклатура);
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("Характеристика", СтрокаТабличнойЧасти) Тогда
		СтруктураДанные.Вставить("Характеристика", СтрокаТабличнойЧасти.Характеристика);
	КонецЕсли;
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("Дата", Объект) Тогда
		СтруктураДанные.Вставить("ДатаОбработки", ?(ЗначениеЗаполнено(Объект.Дата), Объект.Дата, ТекущаяДата()));
	Иначе
		СтруктураДанные.Вставить("ДатаОбработки", ТекущаяДата());
	КонецЕсли;
	
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("Коэффициент", СтрокаТабличнойЧасти) 
		И НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("Кратность", СтрокаТабличнойЧасти) 
		Тогда
		СтруктураДанные.Вставить("НормаВремени", 1);
	КонецЕсли;
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("НалогообложениеНДС", Объект) Тогда
		СтруктураДанные.Вставить("НалогообложениеНДС", Объект.НалогообложениеНДС);
	КонецЕсли;
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ВалютаДокумента", Объект) Тогда
		СтруктураДанные.Вставить("ВалютаДокумента", Объект.ВалютаДокумента);
	КонецЕсли;
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("СуммаВключаетНДС", Объект) Тогда
		СтруктураДанные.Вставить("СуммаВключаетНДС", Объект.СуммаВключаетНДС);
	КонецЕсли;
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ВидЦен", Объект) И ЗначениеЗаполнено(Объект.ВидЦен) Тогда
		СтруктураДанные.Вставить("ВидЦен", Объект.ВидЦен);
	КонецЕсли; 
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ВидЦенКонтрагента", Объект) И ЗначениеЗаполнено(Объект.ВидЦенКонтрагента) Тогда
		СтруктураДанные.Вставить("ВидЦенКонтрагента", Объект.ВидЦенКонтрагента);
	КонецЕсли;
	//НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ЕдиницаИзмерения", Объект) ИЛИ 
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ЕдиницаИзмерения", СтрокаТабличнойЧасти) И ТипЗнч(СтрокаТабличнойЧасти.ЕдиницаИзмерения)=Тип("СправочникСсылка.ЕдиницыИзмерения") Тогда
		СтруктураДанные.Вставить("Коэффициент", СтрокаТабличнойЧасти.ЕдиницаИзмерения.Коэффициент);
	Иначе
		СтруктураДанные.Вставить("Коэффициент", 1);
	КонецЕсли;
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ВидРабот", Объект) И ЗначениеЗаполнено(Объект.ВидРабот) Тогда
		СтруктураДанные.Вставить("ВидРабот", Объект.ВидРабот);
	КонецЕсли; 
	
	ИспользоватьСкидки = НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ВидСкидкиНаценки", Объект);
	Если ИспользоватьСкидки И ЗначениеЗаполнено(Объект.ВидСкидкиНаценки) Тогда
		СтруктураДанные.Вставить("ВидСкидкиНаценки", Объект.ВидСкидкиНаценки);
	КонецЕсли; 
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ДисконтнаяКарта", Объект) И ЗначениеЗаполнено(Объект.ДисконтнаяКарта) Тогда
		СтруктураДанные.Вставить("ДисконтнаяКарта", Объект.ДисконтнаяКарта);
		СтруктураДанные.Вставить("ПроцентСкидкиПоДисконтнойКарте", Объект.ПроцентСкидкиПоДисконтнойКарте);		
	КонецЕсли; 
	
	ДанныеЗаполненияСтроки = ПолучитьДанныеНоменклатураПриИзменении(СтруктураДанные);
	
	ЗаполнитьЗначенияСвойств(СтрокаТабличнойЧасти, ДанныеЗаполненияСтроки);
	
	Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("Количество", СтрокаТабличнойЧасти) Тогда
		
		Если ИмяТабличнойЧасти = "Работы" Тогда
			
			СтрокаТабличнойЧасти.Количество = СтруктураДанные.НормаВремени;
			
			Если НЕ ЗначениеЗаполнено(СтрокаТабличнойЧасти.Кратность) Тогда
				СтрокаТабличнойЧасти.Кратность = 1;
			КонецЕсли;
			Если НЕ ЗначениеЗаполнено(СтрокаТабличнойЧасти.Коэффициент) Тогда
				СтрокаТабличнойЧасти.Коэффициент = 1;
			КонецЕсли;
			
			СтрокаТабличнойЧасти.ТипНоменклатурыУслуга = СтруктураДанные.ЭтоУслуга;
			
		ИначеЕсли ИмяТабличнойЧасти = "Запасы" Тогда
			
			Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("ТипНоменклатурыЗапас", Объект) Тогда
				СтрокаТабличнойЧасти.ТипНоменклатурыЗапас = СтруктураДанные.ЭтоЗапас;
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(СтрокаТабличнойЧасти.ЕдиницаИзмерения) Тогда
				СтрокаТабличнойЧасти.ЕдиницаИзмерения = СтруктураДанные.БазоваяЕдиницаИзмерения;
			КонецЕсли;
			
		ИначеЕсли ИмяТабличнойЧасти = "МатериалыЗаказчика" Тогда
			
			Если НЕ ЗначениеЗаполнено(СтрокаТабличнойЧасти.ЕдиницаИзмерения) Тогда
				СтрокаТабличнойЧасти.ЕдиницаИзмерения = СтруктураДанные.БазоваяЕдиницаИзмерения;
			КонецЕсли;
			
		КонецЕсли;
		
		Если НоменклатураВДокументахКлиентСервер.ЕстьРеквизитОбъекта("Сумма", СтрокаТабличнойЧасти) Тогда
			НоменклатураВДокументахКлиентСервер.РассчитатьСуммуВСтрокеТабличнойЧасти(Объект, СтрокаТабличнойЧасти, ИмяТабличнойЧасти = "Запасы");
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьДанныеНоменклатураПриИзменении(СтруктураДанные)
	
	СтруктураДанные.Вставить("БазоваяЕдиницаИзмерения", СтруктураДанные.Номенклатура.ЕдиницаИзмерения);
	
	СтруктураДанные.Вставить("ЭтоУслуга", СтруктураДанные.Номенклатура.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Услуга"));
	СтруктураДанные.Вставить("ЭтоЗапас", (СтруктураДанные.Номенклатура.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Запас")
	ИЛИ СтруктураДанные.Номенклатура.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.ПодарочныйСертификат")));
	
	СтруктураДанные.Вставить("СтранаПроисхождения", СтруктураДанные.Номенклатура.СтранаПроисхождения);
	
	Если СтруктураДанные.Свойство("НормаВремени") Тогда
		СтруктураДанные.НормаВремени = УправлениеНебольшойФирмойСервер.ПолучитьНормуВремениРаботы(СтруктураДанные);
	КонецЕсли;
	
	Если СтруктураДанные.Свойство("НалогообложениеНДС")
		И НЕ СтруктураДанные.НалогообложениеНДС = ПредопределенноеЗначение("Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДС") Тогда
		
		Если СтруктураДанные.НалогообложениеНДС = ПредопределенноеЗначение("Перечисление.ТипыНалогообложенияНДС.НеОблагаетсяНДС") Тогда
			СтруктураДанные.Вставить("СтавкаНДС", УправлениеНебольшойФирмойПовтИсп.ПолучитьСтавкуНДСБезНДС());
		Иначе
			СтруктураДанные.Вставить("СтавкаНДС", УправлениеНебольшойФирмойПовтИсп.ПолучитьСтавкуНДСНоль());
		КонецЕсли;
		
	ИначеЕсли ЗначениеЗаполнено(СтруктураДанные.Номенклатура.ВидСтавкиНДС) Тогда
		СтруктураДанные.Вставить("СтавкаНДС", Справочники.СтавкиНДС.СтавкаНДС(СтруктураДанные.Номенклатура.ВидСтавкиНДС, ?(ЗначениеЗаполнено(СтруктураДанные.ДатаОбработки), СтруктураДанные.ДатаОбработки, ТекущаяДатаСеанса())));
	Иначе
		СтруктураДанные.Вставить("СтавкаНДС", Справочники.СтавкиНДС.СтавкаНДС(СтруктураДанные.Организация.ВидСтавкиНДСПоУмолчанию, ?(ЗначениеЗаполнено(СтруктураДанные.ДатаОбработки), СтруктураДанные.ДатаОбработки, ТекущаяДатаСеанса())));
	КонецЕсли;
	
	Если СтруктураДанные.Свойство("Характеристика") Тогда
		СтруктураДанные.Вставить("Спецификация", УправлениеНебольшойФирмойСервер.ПолучитьПоУмолчаниюСпецификацию(СтруктураДанные.Номенклатура, СтруктураДанные.Характеристика));
	Иначе
		СтруктураДанные.Вставить("Спецификация", УправлениеНебольшойФирмойСервер.ПолучитьПоУмолчаниюСпецификацию(СтруктураДанные.Номенклатура));
	КонецЕсли;
	
	Если СтруктураДанные.Свойство("ВидЦен") Тогда
		
		Если НЕ СтруктураДанные.Свойство("Характеристика") Тогда
			СтруктураДанные.Вставить("Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
		КонецЕсли;
		Если НЕ СтруктураДанные.Свойство("ВалютаДокумента") И ЗначениеЗаполнено(СтруктураДанные.ВидЦен) Тогда
			//для ЗаданиеНаРаботу - у которого нет реквизита ВалютыДокумента
			СтруктураДанные.Вставить("ВалютаДокумента", СтруктураДанные.ВидЦен.ВалютаЦены);
		КонецЕсли;
		
		Если СтруктураДанные.Свойство("ВидРабот") Тогда
			
			Если СтруктураДанные.Номенклатура.ФиксированнаяСтоимость Тогда
				
				Цена = УправлениеНебольшойФирмойСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);
				СтруктураДанные.Вставить("Цена", Цена);
				
			Иначе
				
				ТекНоменклатура = СтруктураДанные.Номенклатура;
				СтруктураДанные.Номенклатура = СтруктураДанные.ВидРабот;
				СтруктураДанные.Характеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				Цена = УправлениеНебольшойФирмойСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);
				СтруктураДанные.Вставить("Цена", Цена);
				
				СтруктураДанные.Номенклатура = ТекНоменклатура;
				
			КонецЕсли;
			
		Иначе
			
			Цена = УправлениеНебольшойФирмойСервер.ПолучитьЦенуНоменклатурыПоВидуЦен(СтруктураДанные);
			СтруктураДанные.Вставить("Цена", Цена);
			
		КонецЕсли;
		
	Иначе
		
		СтруктураДанные.Вставить("Цена", 0);
		
	КонецЕсли;
	
	Если СтруктураДанные.Свойство("ВидСкидкиНаценки")
		И ЗначениеЗаполнено(СтруктураДанные.ВидСкидкиНаценки) Тогда
		СтруктураДанные.Вставить("ПроцентСкидкиНаценки", СтруктураДанные.ВидСкидкиНаценки.Процент);
	Иначе
		СтруктураДанные.Вставить("ПроцентСкидкиНаценки", 0);
	КонецЕсли;
	
	Если СтруктураДанные.Свойство("ПроцентСкидкиПоДисконтнойКарте") 
		И ЗначениеЗаполнено(СтруктураДанные.ДисконтнаяКарта) Тогда
		ТекПроцент = СтруктураДанные.ПроцентСкидкиНаценки;
		СтруктураДанные.Вставить("ПроцентСкидкиНаценки", ТекПроцент + СтруктураДанные.ПроцентСкидкиПоДисконтнойКарте);
	КонецЕсли;
	
	Возврат СтруктураДанные;
	
КонецФункции // ПолучитьДанныеНоменклатураПриИзменении()

Функция СформироватьГарантийныеТалоныДокумента(ТабличныйДокумент, ТекущийДокумент, Ошибки) Экспорт
	
	ИмяДокумента = ТекущийДокумент.Метаданные().Имя;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ТекущийДокумент", ТекущийДокумент);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокПечати.Дата КАК ДатаДокумента,
	|	ДокПечати.Номер КАК Номер,
	|	ДокПечати.Организация.Префикс КАК Префикс,
	|	ДокПечати.Организация.ФайлЛоготип КАК ФайлЛоготип,
	|	ДокПечати.Ответственный.Физлицо КАК Ответственный,
	|	ДокПечати.УсловияГарантийногоТалона,
	|	ДокПечати.Запасы.(
	|		НомерСтроки КАК НомерСтроки,
	|		Номенклатура.ГарантийныйСрок КАК ГарантийныйСрок,
	|		Номенклатура.ВыписыватьГарантийныйТалон КАК ВыписыватьГарантийныйТалон,
	|		ВЫБОР
	|			КОГДА (ВЫРАЗИТЬ(ДокПечати.Запасы.Номенклатура.НаименованиеПолное КАК СТРОКА(100))) = """"
	|				ТОГДА ДокПечати.Запасы.Номенклатура.Наименование
	|			ИНАЧЕ ДокПечати.Запасы.Номенклатура.НаименованиеПолное
	|		КОНЕЦ КАК Запас,
	|		Номенклатура.Артикул КАК Артикул,
	|		Номенклатура.Код КАК Код,
	|		ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
	|		Количество КАК Количество,
	|		Характеристика,
	|		Номенклатура.ТипНоменклатуры КАК ТипНоменклатуры,
	|		КлючСвязи
	|	),
	|	ДокПечати.Контрагент,
	|	ДокПечати.Организация,
	|	ДокПечати.СерийныеНомера.(
	|		СерийныйНомер,
	|		КлючСвязи
	|	)
	|ИЗ
	|	Документ."+ИмяДокумента+" КАК ДокПечати
	|ГДЕ
	|	ДокПечати.Ссылка = &ТекущийДокумент
	|	И ДокПечати.Запасы.Номенклатура.ВыписыватьГарантийныйТалон
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Шапка = Запрос.Выполнить().Выбрать();
	Если Шапка.Количество()=0 Тогда
		ТекстСообщения = Нстр("ru = '__________________
		|Документ %1.
		|В документе нет товаров с опцией <Выписывать гарантийный талон>'");
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, ТекущийДокумент);
		ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, , ТекстСообщения, Неопределено);
		Возврат Неопределено;
	КонецЕсли;
	Шапка.Следующий();
	
	ВыборкаСтрокЗапасы = Шапка.Запасы.Выбрать();
	ВыборкаСтрокСерийныеНомера = Шапка.СерийныеНомера.Выбрать();
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ГарантийныйТалон";
	
	Макет = УправлениеПечатью.МакетПечатнойФормы("ОбщийМакет.ПФ_MXL_ГарантийныйТалон");
	
	НомерДокумента = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(Шапка.Номер, Истина, Истина);
	
	Если ЗначениеЗаполнено(Шапка.ФайлЛоготип) Тогда
		
		ОбластьМакета = Макет.ПолучитьОбласть("ЗаголовокСЛоготипом");
		
		ДанныеКартинки = РаботаСФайлами.ДвоичныеДанныеФайла(Шапка.ФайлЛоготип);
		Если ЗначениеЗаполнено(ДанныеКартинки) Тогда
			
			ОбластьМакета.Рисунки.Логотип.Картинка = Новый Картинка(ДанныеКартинки);
			
		КонецЕсли;
		
	Иначе // Если картинки не выбраны печатаем обычный заголовок
		
		ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
		
	КонецЕсли;
	
	ОбластьМакета.Параметры.ТекстЗаголовка = "Гарантийный талон № "
	+ НомерДокумента
	+ " от "
	+ Формат(Шапка.ДатаДокумента, "ДЛФ=DD");
	
	СведенияОбОрганизации = УправлениеНебольшойФирмойСервер.СведенияОЮрФизЛице(Шапка.Организация, Шапка.ДатаДокумента);
	ОбластьМакета.Параметры.Организация = УправлениеНебольшойФирмойСервер.ОписаниеОрганизации(СведенияОбОрганизации, "ПолноеНаименование,ФактическийАдрес,Телефоны");
	ОбластьМакета.Параметры.Контрагент = Шапка.Контрагент;
	
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ТабличныйДокумент.Вывести(ОбластьМакета);
	ОбластьМакета = Макет.ПолучитьОбласть("Строка");
	
	НомерСтроки = 1;
	Пока ВыборкаСтрокЗапасы.Следующий() Цикл
		
		Если НЕ ВыборкаСтрокЗапасы.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Запас Тогда
			Продолжить;
		КонецЕсли;
		
		ОбластьМакета.Параметры.Заполнить(ВыборкаСтрокЗапасы);
		ОбластьМакета.Параметры.НомерСтроки = НомерСтроки;
		
		СтрокаСерийныеНомера = РаботаССерийнымиНомерами.СтрокаСерийныеНомераИзВыборки(ВыборкаСтрокСерийныеНомера, ВыборкаСтрокЗапасы.КлючСвязи);
		ОбластьМакета.Параметры.Запас = УправлениеНебольшойФирмойСервер.ПолучитьПредставлениеНоменклатурыДляПечати(ВыборкаСтрокЗапасы.Запас, 
		ВыборкаСтрокЗапасы.Характеристика, ВыборкаСтрокЗапасы.Артикул, СтрокаСерийныеНомера);
		
		ТабличныйДокумент.Вывести(ОбластьМакета);
		
		НомерСтроки = НомерСтроки+1;
		
	КонецЦикла;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Итого");
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("ДополнительныеУсловия");
	// Дополнительные условия
	Если ЗначениеЗаполнено(Шапка.УсловияГарантийногоТалона) И
		ЗначениеЗаполнено(Макет.Области.Найти("ДополнительныеУсловия")) Тогда
		
		ОбластьМакета = Макет.ПолучитьОбласть("ДополнительныеУсловия");
		
		// Добавим отступ перед текстом
		ТабличныйДокумент.Вывести(ОбластьМакета);
		
		// Выводим построчно многострочный текст
		// для того, чтобы корректно печатались длинные тексты
		ТекстДополнительныхУсловий = Шапка.УсловияГарантийногоТалона.ТекстУсловий;
		ЧислоСтрокТекста = СтрЧислоСтрок(ТекстДополнительныхУсловий);
		Для СчетчикСтрок = 1 По ЧислоСтрокТекста Цикл
			СтруктураПараметров = Новый Структура("ТекстДополнительныхУсловий", 
			СтрПолучитьСтроку(ТекстДополнительныхУсловий, СчетчикСтрок));
			ОбластьМакета.Параметры.Заполнить(СтруктураПараметров);
			ТабличныйДокумент.Вывести(ОбластьМакета);
		КонецЦикла;
	КонецЕсли;			
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Заполнить(Шапка);
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	Возврат ТабличныйДокумент;
	
КонецФункции

Функция СформироватьГарантийныеТалоныПроизводство(ТабличныйДокумент, ТекущийДокумент, Ошибки, ИмяТЧПродукция="Продукция") Экспорт
	
	ИмяДокумента = ТекущийДокумент.Метаданные().Имя;
	
	ИмяТЧСерийныеНомера = "СерийныеНомера"+?(ИмяТЧПродукция="Продукция", "Продукция","");
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ТекущийДокумент", ТекущийДокумент);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокПечати.Дата КАК ДатаДокумента,
	|	ДокПечати.Номер КАК Номер,
	|	ДокПечати.Организация.Префикс КАК Префикс,
	|	ДокПечати.Организация.ФайлЛоготип КАК ФайлЛоготип,
	|	ДокПечати.Автор.ФизическоеЛицо КАК Ответственный,
	|	ДокПечати.УсловияГарантийногоТалона,
	|	ДокПечати."+ИмяТЧПродукция+".(
	|		НомерСтроки КАК НомерСтроки,
	|		Номенклатура.ГарантийныйСрок КАК ГарантийныйСрок,
	|		Номенклатура.ВыписыватьГарантийныйТалон КАК ВыписыватьГарантийныйТалон,
	|		ВЫБОР
	|			КОГДА (ВЫРАЗИТЬ(ДокПечати."+ИмяТЧПродукция+".Номенклатура.НаименованиеПолное КАК СТРОКА(100))) = """"
	|				ТОГДА ДокПечати."+ИмяТЧПродукция+".Номенклатура.Наименование
	|			ИНАЧЕ ДокПечати."+ИмяТЧПродукция+".Номенклатура.НаименованиеПолное
	|		КОНЕЦ КАК Запас,
	|		Номенклатура.Артикул КАК Артикул,
	|		Номенклатура.Код КАК Код,
	|		ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
	|		Количество КАК Количество,
	|		Характеристика,
	|		Номенклатура.ТипНоменклатуры КАК ТипНоменклатуры,
	|		КлючСвязи
	|	),
	|	ДокПечати.ЗаказПокупателя.Контрагент КАК Контрагент,
	|	ДокПечати.Организация,
	|	ДокПечати."+ИмяТЧСерийныеНомера+".(
	|		СерийныйНомер,
	|		КлючСвязи
	|	)
	|ИЗ
	|	Документ.СборкаЗапасов КАК ДокПечати
	|ГДЕ
	|	ДокПечати.Ссылка = &ТекущийДокумент
	|	И ДокПечати."+ИмяТЧПродукция+".Номенклатура.ВыписыватьГарантийныйТалон
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Шапка = Запрос.Выполнить().Выбрать();
	Если Шапка.Количество()=0 Тогда
		ТекстСообщения = Нстр("ru = '__________________
		|Документ %1.
		|В документе нет товаров с опцией <Выписывать гарантийный талон>'");
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, ТекущийДокумент);
		ОбщегоНазначенияКлиентСервер.ДобавитьОшибкуПользователю(Ошибки, , ТекстСообщения, Неопределено);
		Возврат Неопределено;
	КонецЕсли;
	Шапка.Следующий();
	
	ВыборкаСтрокЗапасы = Шапка[ИмяТЧПродукция].Выбрать();
	ВыборкаСтрокСерийныеНомера = Шапка[ИмяТЧСерийныеНомера].Выбрать();
	
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ГарантийныйТалон";
	
	Макет = УправлениеПечатью.МакетПечатнойФормы("ОбщийМакет.ПФ_MXL_ГарантийныйТалон");
	
	НомерДокумента = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(Шапка.Номер, Истина, Истина);
	
	Если ЗначениеЗаполнено(Шапка.ФайлЛоготип) Тогда
		
		ОбластьМакета = Макет.ПолучитьОбласть("ЗаголовокСЛоготипом");
		
		ДанныеКартинки = РаботаСФайлами.ДвоичныеДанныеФайла(Шапка.ФайлЛоготип);
		Если ЗначениеЗаполнено(ДанныеКартинки) Тогда
			
			ОбластьМакета.Рисунки.Логотип.Картинка = Новый Картинка(ДанныеКартинки);
			
		КонецЕсли;
		
	Иначе // Если картинки не выбраны печатаем обычный заголовок
		
		ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
		
	КонецЕсли;
	
	ОбластьМакета.Параметры.ТекстЗаголовка = НСтр("ru = 'Гарантийный талон'")+" № "+НомерДокумента+НСтр("ru = ' от'")+" ___________________";
	//Дату продажи не указываем
	
	СведенияОбОрганизации = УправлениеНебольшойФирмойСервер.СведенияОЮрФизЛице(Шапка.Организация, Шапка.ДатаДокумента);
	ОбластьМакета.Параметры.Организация = УправлениеНебольшойФирмойСервер.ОписаниеОрганизации(СведенияОбОрганизации, "ПолноеНаименование,ФактическийАдрес,Телефоны");
	ОбластьМакета.Параметры.Контрагент = Шапка.Контрагент;
	
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ТабличныйДокумент.Вывести(ОбластьМакета);
	ОбластьМакета = Макет.ПолучитьОбласть("Строка");
	
	НомерСтроки = 1;
	Пока ВыборкаСтрокЗапасы.Следующий() Цикл
		
		Если НЕ ВыборкаСтрокЗапасы.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Запас Тогда
			Продолжить;
		КонецЕсли;
		
		ОбластьМакета.Параметры.Заполнить(ВыборкаСтрокЗапасы);
		ОбластьМакета.Параметры.НомерСтроки = НомерСтроки;
		
		СтрокаСерийныеНомера = РаботаССерийнымиНомерами.СтрокаСерийныеНомераИзВыборки(ВыборкаСтрокСерийныеНомера, ВыборкаСтрокЗапасы.КлючСвязи);
		ОбластьМакета.Параметры.Запас = УправлениеНебольшойФирмойСервер.ПолучитьПредставлениеНоменклатурыДляПечати(ВыборкаСтрокЗапасы.Запас, 
		ВыборкаСтрокЗапасы.Характеристика, ВыборкаСтрокЗапасы.Артикул, СтрокаСерийныеНомера);
		
		ТабличныйДокумент.Вывести(ОбластьМакета);
		
		НомерСтроки = НомерСтроки+1;
		
	КонецЦикла;
	
	ОбластьМакета = Макет.ПолучитьОбласть("Итого");
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	ОбластьМакета = Макет.ПолучитьОбласть("ДополнительныеУсловия");
	// Дополнительные условия
	Если ЗначениеЗаполнено(Шапка.УсловияГарантийногоТалона) И
		ЗначениеЗаполнено(Макет.Области.Найти("ДополнительныеУсловия")) Тогда
		
		ОбластьМакета = Макет.ПолучитьОбласть("ДополнительныеУсловия");
		
		// Добавим отступ перед текстом
		ТабличныйДокумент.Вывести(ОбластьМакета);
		
		// Выводим построчно многострочный текст
		// для того, чтобы корректно печатались длинные тексты
		ТекстДополнительныхУсловий = Шапка.УсловияГарантийногоТалона.ТекстУсловий;
		ЧислоСтрокТекста = СтрЧислоСтрок(ТекстДополнительныхУсловий);
		Для СчетчикСтрок = 1 По ЧислоСтрокТекста Цикл
			СтруктураПараметров = Новый Структура("ТекстДополнительныхУсловий", 
			СтрПолучитьСтроку(ТекстДополнительныхУсловий, СчетчикСтрок));
			ОбластьМакета.Параметры.Заполнить(СтруктураПараметров);
			ТабличныйДокумент.Вывести(ОбластьМакета);
		КонецЦикла;
	КонецЕсли;			
	
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.Заполнить(Шапка);
	ТабличныйДокумент.Вывести(ОбластьМакета);
	
	ТабличныйДокумент.АвтоМасштаб = Истина;
	Возврат ТабличныйДокумент;
	
КонецФункции

Функция ПечатьГарантийныйТалон(МассивОбъектов, ОбъектыПечати) Экспорт
	
	Перем Ошибки;
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ПервыйДокумент = Истина;
	
	Для Каждого ТекущийДокумент Из МассивОбъектов Цикл
		
		Если Не ПервыйДокумент Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;
		ПервыйДокумент = Ложь;
		
		НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
		
		СформироватьГарантийныеТалоныДокумента(ТабличныйДокумент, ТекущийДокумент, Ошибки);
		
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабличныйДокумент, НомерСтрокиНачало, ОбъектыПечати, ТекущийДокумент);
		
	КонецЦикла;
	
	ОбщегоНазначенияКлиентСервер.СообщитьОшибкиПользователю(Ошибки);
	
	Возврат ТабличныйДокумент;
	
КонецФункции

//Заполняет поля табличной части Запасы признаками использования характеристик
//
//Параметры:
//ОткрытиеФормы - Булево. Устанавливается в значение - Истина, если заполнение происходит при открытии формы. 
Процедура ЗаполнитьПризнакиИспользованияХарактеристик(Объект, ОткрытиеФормы = Ложь) Экспорт
	
	ИспользоватьХарактеристики = ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристики");
	ИспользоватьПартии = ПолучитьФункциональнуюОпцию("ИспользоватьПартии");
	
	Если НЕ ИспользоватьПартии и НЕ ИспользоватьХарактеристики Тогда Возврат КонецЕсли;
	
	МетаданныеОбъекта = Объект.Ссылка.Метаданные();
	
	МассивИменТабличныхЧастей = Новый Массив;
	
	Для Каждого ТабличнаяЧасть Из МетаданныеОбъекта.ТабличныеЧасти	Цикл
		
		Если НЕ ТабличнаяЧасть.Реквизиты.Найти("Характеристика") = Неопределено
			Тогда
			МассивИменТабличныхЧастей.Добавить(ТабличнаяЧасть.Имя);
		КонецЕсли;
		
	КонецЦикла;
	
	ЭтоДокументКорректировкаПоступления = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.КорректировкаПоступления"),Истина, Ложь);
	ЭтоДокументКорректировкаРеализации = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.КорректировкаРеализации"),Истина, Ложь);
	ЭтоДокументЗаказПоставщику = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщику"),Истина, Ложь);
	ЭтоДокументСчетНаОплатуПолученный = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.СчетНаОплатуПоставщика"),Истина, Ложь);
	
	НеПроверятьУслуги = ?(ЭтоДокументЗаказПоставщику Или ЭтоДокументСчетНаОплатуПолученный, Истина, Ложь);
	
	Запрос = Новый Запрос;
	
	Если ЭтоДокументКорректировкаПоступления Тогда
		
		ТекстЗапроса =
		"ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ТаблицаНоменклатурыДокумента.Номенклатура КАК Справочник.Номенклатура) КАК Ссылка,
		|	ТаблицаНоменклатурыДокумента.НомерСтроки КАК НомерСтрокиНоменклатуры,
		|	ТаблицаНоменклатурыДокумента.Характеристика КАК Характеристика,
		|	ТаблицаНоменклатурыДокумента.ЕстьВДокументеПоступления КАК ЕстьВДокументеПоступления
		|ПОМЕСТИТЬ ВыборкаИзТабличнойЧастиЗапасы
		|ИЗ
		|	&ИмяТЧ КАК ТаблицаНоменклатурыДокумента
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыборкаИзТабличнойЧастиЗапасы.НомерСтрокиНоменклатуры КАК НомерСтрокиНоменклатуры,
		|	ВЫБОР
		|		КОГДА НЕ ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ИспользоватьХарактеристики
		|				И НЕ ВыборкаИзТабличнойЧастиЗапасы.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ИспользоватьХарактеристики
		|	КОНЕЦ КАК ИспользоватьХарактеристики,
		|	ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ПроверятьЗаполнениеХарактеристики КАК ПроверятьЗаполнениеХарактеристики,
		|	ВыборкаИзТабличнойЧастиЗапасы.ЕстьВДокументеПоступления КАК ЕстьВДокументеПоступления,
		|	ИСТИНА КАК ЗаполнениеХарактеристикиПроверено,
		|	ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ИспользоватьПартии КАК ИспользоватьПартии,
		|	ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ПроверятьЗаполнениеПартий КАК ПроверятьЗаполнениеПартий
		|ИЗ
		|	ВыборкаИзТабличнойЧастиЗапасы КАК ВыборкаИзТабличнойЧастиЗапасы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияНоменклатурыПоУмолчанию КАК ЗначенияНоменклатурыПоУмолчанию
		|		ПО ВыборкаИзТабличнойЧастиЗапасы.Ссылка = ЗначенияНоменклатурыПоУмолчанию.Номенклатура
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтрокиНоменклатуры";
		
	ИначеЕсли ЭтоДокументКорректировкаРеализации Тогда
		ТекстЗапроса =
		"ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ТаблицаНоменклатурыДокумента.Номенклатура КАК Справочник.Номенклатура) КАК Ссылка,
		|	ТаблицаНоменклатурыДокумента.НомерСтроки КАК НомерСтрокиНоменклатуры,
		|	ТаблицаНоменклатурыДокумента.Характеристика КАК Характеристика,
		|	ТаблицаНоменклатурыДокумента.ЕстьВДокументеРеализации КАК ЕстьВДокументеРеализации
		|ПОМЕСТИТЬ ВыборкаИзТабличнойЧастиЗапасы
		|ИЗ
		|	&ИмяТЧ КАК ТаблицаНоменклатурыДокумента
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВыборкаИзТабличнойЧастиЗапасы.НомерСтрокиНоменклатуры КАК НомерСтрокиНоменклатуры,
		|	ВЫБОР
		|		КОГДА НЕ ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ИспользоватьХарактеристики
		|				И НЕ ВыборкаИзТабличнойЧастиЗапасы.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ИспользоватьХарактеристики
		|	КОНЕЦ КАК ИспользоватьХарактеристики,
		|	ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ПроверятьЗаполнениеХарактеристики КАК ПроверятьЗаполнениеХарактеристики,
		|	ВыборкаИзТабличнойЧастиЗапасы.ЕстьВДокументеРеализации КАК ЕстьВДокументеРеализации,
		|	ИСТИНА КАК ЗаполнениеХарактеристикиПроверено,
		|	ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ИспользоватьПартии КАК ИспользоватьПартии,
		|	ВыборкаИзТабличнойЧастиЗапасы.Ссылка.ПроверятьЗаполнениеПартий КАК ПроверятьЗаполнениеПартий
		|ИЗ
		|	ВыборкаИзТабличнойЧастиЗапасы КАК ВыборкаИзТабличнойЧастиЗапасы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияНоменклатурыПоУмолчанию КАК ЗначенияНоменклатурыПоУмолчанию
		|		ПО ВыборкаИзТабличнойЧастиЗапасы.Ссылка = ЗначенияНоменклатурыПоУмолчанию.Номенклатура
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтрокиНоменклатуры";
	Иначе
		
		ТекстЗапроса =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	Номенклатура.ИспользоватьПартии КАК ИспользоватьПартии,
		|	Номенклатура.ИспользоватьХарактеристики КАК ИспользоватьХарактеристики,
		|	Номенклатура.ПроверятьЗаполнениеХарактеристики КАК ПроверятьЗаполнениеХарактеристики,
		|	Номенклатура.ПроверятьЗаполнениеПартий КАК ПроверятьЗаполнениеПартий,
		|	ВЫБОР
		|		КОГДА Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЭтоУслуга,
		|	ИСТИНА КАК ЗаполнениеХарактеристикиПроверено
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Ссылка В(&МассивПроверяемойНоменклатуры)
		|	И НЕ Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)";
		
	КонецЕсли;
	
	МассивПроверяемойНоменклатуры = Новый Массив;
	
	//Если Не ОткрытиеФормы Тогда
	
	КоличествоПакетовЗапроса = 1;
	
	СоответствиеТабличныхЧастейИндексамПакета = Новый Соответствие();
	
	Для Каждого ИмяТабличнойЧасти из МассивИменТабличныхЧастей Цикл
		
		ОтборНеПроверенныхСтрок = Новый Структура("ЗаполнениеХарактеристикиПроверено", Ложь);
		МассивНеПроверенныхСтрок = Объект[ИмяТабличнойЧасти].НайтиСтроки(ОтборНеПроверенныхСтрок);
		
		Если ЭтоДокументКорректировкаПоступления Тогда
			
			Если Не Объект[ИмяТабличнойЧасти].Количество() Тогда Продолжить КонецЕсли;
			
			ТаблицаНоменклатурыДокумента = Объект[ИмяТабличнойЧасти].Выгрузить(МассивНеПроверенныхСтрок,"Номенклатура, НомерСтроки, Характеристика, ЕстьВДокументеПоступления");
		ИначеЕсли ЭтоДокументКорректировкаРеализации Тогда
			
			Если Не Объект[ИмяТабличнойЧасти].Количество() Тогда Продолжить КонецЕсли;
			
			ТаблицаНоменклатурыДокумента = Объект[ИмяТабличнойЧасти].Выгрузить(МассивНеПроверенныхСтрок,"Номенклатура, НомерСтроки, Характеристика, ЕстьВДокументеРеализации");
		Иначе
			
			Если Не Объект[ИмяТабличнойЧасти].Количество() Тогда Продолжить КонецЕсли;
			
			Для Каждого СтрокаТаблицы из Объект[ИмяТабличнойЧасти] Цикл
				
				Если СтрокаТаблицы.ЗаполнениеХарактеристикиПроверено Тогда Продолжить КонецЕсли;
				
				МассивПроверяемойНоменклатуры.Добавить(СтрокаТаблицы.Номенклатура);
				
			КонецЦикла;
			
			Продолжить;
			
		КонецЕсли;
		
		ТекстПакета = ТекстЗапроса;
		
		ТекстПакета = СтрЗаменить(ТекстПакета, "&ИмяТЧ", "&"+ИмяТабличнойЧасти);
		ТекстПакета = СтрЗаменить(ТекстПакета, "ВыборкаИзТабличнойЧастиЗапасы", "ВыборкаИзТабличнойЧастиЗапасы"+ИмяТабличнойЧасти);
		
		Запрос.Текст = Запрос.Текст + ТекстПакета + "
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|";
		
		Запрос.УстановитьПараметр(ИмяТабличнойЧасти, ТаблицаНоменклатурыДокумента);
		
		СоответствиеТабличныхЧастейИндексамПакета.Вставить(КоличествоПакетовЗапроса, ИмяТабличнойЧасти);
		КоличествоПакетовЗапроса = КоличествоПакетовЗапроса + 2;
		
	КонецЦикла;
	
	Если Не ЗначениеЗаполнено(Запрос.Текст) и Не МассивПроверяемойНоменклатуры.Количество() Тогда Возврат КонецЕсли;
	
	ИндексПакета = 1;
	
	Если ЭтоДокументКорректировкаПоступления Тогда
		
		ПакетЗапросов = Запрос.ВыполнитьПакет();
		
		Пока ИндексПакета <= ПакетЗапросов.Количество()-1 Цикл
			
			ВыборкаПоХарактеристикам = ПакетЗапросов[ИндексПакета].Выбрать();
			
			ИмяТабличнойЧасти = СоответствиеТабличныхЧастейИндексамПакета.Получить(ИндексПакета);
			
			Пока ВыборкаПоХарактеристикам.Следующий() Цикл
				
				Если ВыборкаПоХарактеристикам.ЕстьВДокументеПоступления Тогда
					Продолжить;
				КонецЕсли;
				
				СтрокаТабЧасти = Объект[ИмяТабличнойЧасти][ВыборкаПоХарактеристикам.НомерСтрокиНоменклатуры-1];
				ЗаполнитьЗначенияСвойств(СтрокаТабЧасти,ВыборкаПоХарактеристикам);
				
				Если СтрокаТабЧасти.Свойство("Партия") и ЗначениеЗаполнено(СтрокаТабЧасти.Партия) Тогда
					СтрокаТабЧасти.ИспользоватьПартии = Истина
				КонецЕсли;
				
			КонецЦикла;
			
			ИндексПакета = ИндексПакета + 2;
			
		КонецЦикла;
		
	ИначеЕсли ЭтоДокументКорректировкаРеализации Тогда
		
		ПакетЗапросов = Запрос.ВыполнитьПакет();
		
		Пока ИндексПакета <= ПакетЗапросов.Количество()-1 Цикл
			
			ВыборкаПоХарактеристикам = ПакетЗапросов[ИндексПакета].Выбрать();
			
			ИмяТабличнойЧасти = СоответствиеТабличныхЧастейИндексамПакета.Получить(ИндексПакета);
			
			Пока ВыборкаПоХарактеристикам.Следующий() Цикл
				
				Если ВыборкаПоХарактеристикам.ЕстьВДокументеРеализации Тогда
					Продолжить;
				КонецЕсли;
				
				СтрокаТабЧасти = Объект[ИмяТабличнойЧасти][ВыборкаПоХарактеристикам.НомерСтрокиНоменклатуры-1];
				ЗаполнитьЗначенияСвойств(СтрокаТабЧасти,ВыборкаПоХарактеристикам);
				
				Если СтрокаТабЧасти.Свойство("Партия") и ЗначениеЗаполнено(СтрокаТабЧасти.Партия) Тогда
					СтрокаТабЧасти.ИспользоватьПартии = Истина
				КонецЕсли;
				
			КонецЦикла;
			
			ИндексПакета = ИндексПакета + 2;
			
		КонецЦикла;
		
	Иначе
		
		Если НеПроверятьУслуги = Ложь Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"И НЕ Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)","");
		КонецЕсли;
		
		Запрос.Текст = ТекстЗапроса;
		
		Запрос.УстановитьПараметр("МассивПроверяемойНоменклатуры", МассивПроверяемойНоменклатуры);
		ВыборкаПоХарактеристикам = Запрос.Выполнить().Выбрать();
		
		Для Каждого ИмяТабличнойЧасти из МассивИменТабличныхЧастей Цикл
			
			Для Каждого СтрокаТабЧасти из Объект[ИмяТабличнойЧасти] Цикл
				
				ПараметрыОтбора = Новый Структура("Номенклатура", СтрокаТабЧасти.Номенклатура);
				
				НайденаСтрока = ВыборкаПоХарактеристикам.НайтиСледующий(ПараметрыОтбора);
				
				Если НайденаСтрока Тогда
					ЗаполнитьЗначенияСвойств(СтрокаТабЧасти, ВыборкаПоХарактеристикам);
					
					Если СтрокаТабЧасти.Свойство("Партия") и ЗначениеЗаполнено(СтрокаТабЧасти.Партия) Тогда
						СтрокаТабЧасти.ИспользоватьПартии = Истина
					КонецЕсли;
					
					Если СтрокаТабЧасти.Свойство("Характеристика") и ЗначениеЗаполнено(СтрокаТабЧасти.Характеристика) Тогда
						СтрокаТабЧасти.ИспользоватьХарактеристики = Истина
					КонецЕсли;
				КонецЕсли;
				
				ВыборкаПоХарактеристикам.Сбросить();
				
			КонецЦикла;
		КонецЦикла
		
	КонецЕсли;
	
КонецПроцедуры

//Получает значение характеристики номенклатуры по умолчанию
//
Функция ЗначенияНоменклатурыПоУмолчанию(Номенклатура) Экспорт
	
	Если Номенклатура.ЭтоНабор Тогда
		Возврат Неопределено
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Категория", Номенклатура.КатегорияНоменклатуры);
	
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВЫБОР
	|		КОГДА ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПУстаяСсылка)
	|			ТОГДА ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Характеристика
	|		ИНАЧЕ ВЫБОР
	|				КОГДА ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Характеристика.Владелец = ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Номенклатура
	|					ТОГДА ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Характеристика
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Номенклатура.КатегорияНоменклатуры = ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Характеристика.Владелец
	|							ТОГДА ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Характеристика
	|						ИНАЧЕ НЕОПРЕДЕЛЕНО
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК Характеристика
	|ИЗ
	|	РегистрСведений.ЗначенияНоменклатурыПоУмолчанию КАК ЗначенияНоменклатурыПоУмолчаниюНоменклатура
	|ГДЕ
	|	(ВЫРАЗИТЬ(ЗначенияНоменклатурыПоУмолчаниюНоменклатура.Номенклатура КАК Справочник.Номенклатура)) = &Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗначенияНоменклатурыПоУмолчаниюКатегории.Характеристика КАК ХарактеристикаКатегории
	|ИЗ
	|	РегистрСведений.ЗначенияНоменклатурыПоУмолчанию КАК ЗначенияНоменклатурыПоУмолчаниюКатегории
	|ГДЕ
	|	(ВЫРАЗИТЬ(ЗначенияНоменклатурыПоУмолчаниюКатегории.Номенклатура КАК Справочник.КатегорииНоменклатуры)) = &Категория";
	
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	РезультатПоНоменклатуре = РезультатЗапроса[0].Выбрать();
	
	Если РезультатПоНоменклатуре.Следующий() Тогда
		Возврат РезультатПоНоменклатуре.Характеристика
	КонецЕсли;
	
	РезультатПоКатегории = РезультатЗапроса[1].Выбрать();
	
	Если РезультатПоКатегории.Следующий() и ЗначениеЗаполнено(РезультатПоКатегории.ХарактеристикаКатегории) Тогда
		Возврат РезультатПоКатегории.ХарактеристикаКатегории
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция СтавкаНоменклатуры(Номенклатура) Экспорт
	Возврат Справочники.СтавкиНДС.СтавкаНДС(Номенклатура.ВидСтавкиНДС);
КонецФункции

//Проверяет,в зависимости от использования, заполнение характеристик номенклатуры
//
Процедура ПроверитьЗаполнениеХарактеристик(Объект, Отказ, ПроверятьЗаполнениеПартий = Ложь, ИменаТЧДляИсключенияПроверкиПартий = Неопределено) Экспорт
	
	СписокИменТЧДляИсключенияПроверкиПартий = Новый СписокЗначений;
	
	Если Не ИменаТЧДляИсключенияПроверкиПартий = Неопределено Тогда
		СписокИменТЧДляИсключенияПроверкиПартий = ИменаТЧДляИсключенияПроверкиПартий;
	КонецЕсли;
	
	Если Отказ Тогда Возврат КонецЕсли;
	
	Если ПроверятьЗаполнениеПартий и Не Объект.Метаданные().Реквизиты.Найти("ВидОперации") = Неопределено
		И (Объект.ВидОперации = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемВПереработку 
		Или Объект.ВидОперации = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаКомиссию 
		Или Объект.ВидОперации = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаОтветхранение) Тогда
		
		ПроверятьЗаполнениеПартий = Ложь;
	КонецЕсли;
	
	ЭтоДокументКорректировкаПоступления = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.КорректировкаПоступления"),Истина, Ложь);
	ЭтоДокументКорректировкаРеализации = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.КорректировкаРеализации"),Истина, Ложь);
	ЭтоДокументПересортицаЗапасов = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.ПересортицаЗапасов"),Истина, Ложь);
	ЭтоДокументЗаказПоставщику = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщику"),Истина, Ложь);
	ЭтоДокументСчетНаОплатуПолученный = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.СчетНаОплатуПоставщика"),Истина, Ложь);
	
	МетаданныеОбъекта = Объект.Ссылка.Метаданные();
	
	МассивИменТабличныхЧастей = Новый Массив;
	
	Для Каждого ТабличнаяЧасть Из МетаданныеОбъекта.ТабличныеЧасти Цикл
		Если НЕ ТабличнаяЧасть.Реквизиты.Найти("Характеристика") = Неопределено Тогда
			
			Если ТабличнаяЧасть.Имя = "Калькуляция" Тогда Продолжить КонецЕсли;
			
			МассивИменТабличныхЧастей.Добавить(ТабличнаяЧасть.Имя);
			
		КонецЕсли;
	КонецЦикла;
	
	НеПроверятьУслуги = ?(ЭтоДокументЗаказПоставщику Или ЭтоДокументСчетНаОплатуПолученный, Истина, Ложь);
	
	Для Каждого ИмяТабличнойЧасти из МассивИменТабличныхЧастей Цикл
		
		ПроверятьПартии = Ложь;
		
		Если ПроверятьЗаполнениеПартий 
			и Не МетаданныеОбъекта.ТабличныеЧасти[ИмяТабличнойЧасти].Реквизиты.Найти("Партия") = Неопределено Тогда
			
			ПроверятьПартии = ?(Не СписокИменТЧДляИсключенияПроверкиПартий.НайтиПоЗначению(ИмяТабличнойЧасти) = Неопределено, Ложь, Истина);
			
		КонецЕсли;
		
		Для Каждого СтрокаЗапасы из Объект[ИмяТабличнойЧасти] Цикл
			
			ЭтоНоменклатура = ?(ТипЗнч(СтрокаЗапасы.Номенклатура) = Тип("СправочникСсылка.Номенклатура"), Истина, Ложь);
			
			Если Не ЭтоНоменклатура Или (ЭтоНоменклатура и СтрокаЗапасы.Номенклатура.ЭтоГруппа) Тогда Продолжить КонецЕсли;
			
			ПроверятьЗаполнениеХарактеристикВТабЧасти = СтрокаЗапасы.Номенклатура.ПроверятьЗаполнениеХарактеристики и ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристики");
			ПроверятьЗаполнениеПартийВТабЧасти = СтрокаЗапасы.Номенклатура.ПроверятьЗаполнениеПартий и ПолучитьФункциональнуюОпцию("ИспользоватьПартии");
			
			Если (ЭтоДокументКорректировкаПоступления и СтрокаЗапасы.ЕстьВДокументеПоступления) 
				Или (ЭтоДокументКорректировкаРеализации и СтрокаЗапасы.ЕстьВДокументеРеализации) Тогда
				Продолжить;
			КонецЕсли;
			
			Если НеПроверятьУслуги и СтрокаЗапасы.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				Продолжить;
			КонецЕсли;
			
			Если ПроверятьЗаполнениеХарактеристикВТабЧасти
				и Не ЗначениеЗаполнено(СтрокаЗапасы.Характеристика) Тогда
				ТекстСообщения = НСтр("ru = 'В таблице %Таблица%, для номенклатуры %1% в строке %Номер%, заполнение поля ""характеристика"" является обязательным. '");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(СтрокаЗапасы.Номенклатура));
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Номер%", СтрокаЗапасы.НомерСтроки);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Таблица%", ИмяТабличнойЧасти);
				
				УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(
				Объект,
				ТекстСообщения,
				ИмяТабличнойЧасти,
				СтрокаЗапасы.НомерСтроки,
				"Характеристика",
				Отказ
				);
			КонецЕсли;
			
			Если ПроверятьПартии
				и ПроверятьЗаполнениеПартийВТабЧасти
				и Не ЗначениеЗаполнено(СтрокаЗапасы.Партия) Тогда
				
				ТекстСообщения = НСтр("ru = 'В таблице %Таблица%, для номенклатуры %1% в строке %Номер%, заполнение поля ""партия"" является обязательным. '");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(СтрокаЗапасы.Номенклатура));
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Номер%", СтрокаЗапасы.НомерСтроки);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Таблица%", ИмяТабличнойЧасти);
				
				УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(
				Объект,
				ТекстСообщения,
				ИмяТабличнойЧасти,
				СтрокаЗапасы.НомерСтроки,
				"Партия",
				Отказ
				);
			КонецЕсли;
			
			Если ЭтоДокументПересортицаЗапасов
				и ПроверятьЗаполнениеХарактеристикВТабЧасти
				и Не ЗначениеЗаполнено(СтрокаЗапасы.ХарактеристикаОприходование) Тогда
				
				ТекстСообщения = НСтр("ru = 'В таблице %Таблица%, для номенклатуры %1% в строке %Номер%, заполнение поля ""характеристика"" является обязательным. '");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(СтрокаЗапасы.НоменклатураОприходование));
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Номер%", СтрокаЗапасы.НомерСтроки);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Таблица%", ИмяТабличнойЧасти);
				
				УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(
				Объект,
				ТекстСообщения,
				ИмяТабличнойЧасти,
				СтрокаЗапасы.НомерСтроки,
				"ХарактеристикаОприходование",
				Отказ
				);
			КонецЕсли;
			
			Если ЭтоДокументПересортицаЗапасов и ПроверятьПартии
				и ПроверятьЗаполнениеПартийВТабЧасти
				и Не ЗначениеЗаполнено(СтрокаЗапасы.ПартияОприходование) Тогда
				
				ТекстСообщения = НСтр("ru = 'В таблице %Таблица%, для номенклатуры %1% в строке %Номер%, заполнение поля ""партия"" является обязательным. '");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(СтрокаЗапасы.НоменклатураОприходование));
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Номер%", СтрокаЗапасы.НомерСтроки);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Таблица%", ИмяТабличнойЧасти);
				
				УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(
				Объект,
				ТекстСообщения,
				ИмяТабличнойЧасти,
				СтрокаЗапасы.НомерСтроки,
				"ПартияОприходование",
				Отказ
				);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

//Обновляет условное оформление колонки "Характеристика" для формы документа
//Форма - Форма объекта для условного оформления
//СоответствиеИменТабличныхЧастей - Соответствие Имя Табличной части -> Имя колонки табличной части
Процедура ОбновитьУсловноеОформлениеТабличнойЧастиДляХарактеристик(Форма, СоответствиеИменТабличныхЧастей = Неопределено) Экспорт  
	
	ИспользоватьХарактеристики = ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристики");
	ИспользоватьПартии = ПолучитьФункциональнуюОпцию("ИспользоватьПартии");
	
	Если НЕ ИспользоватьПартии и НЕ ИспользоватьХарактеристики Тогда Возврат КонецЕсли;
	
	Если Форма.ИмяФормы = "Документ.ЗаказНаПроизводство.Форма.ФормаДокумента" 
		Или Форма.ИмяФормы = "Документ.СборкаЗапасов.Форма.ФормаДокумента" Тогда
		
		НаименованиеПоляХарактеристика = "РаспределениеЗапасовХарактеристика";
		НаименованиеПоляПартия = "РаспределениеЗапасовПартия";
		
		ЗначениеПоиска = Форма.Элементы.Найти(НаименованиеПоляХарактеристика);
		
		ЗначениеПоискаПартия = Форма.Элементы.Найти(НаименованиеПоляПартия);
		
		Если ИспользоватьХарактеристики и НЕ ЗначениеПоиска = Неопределено Тогда
			
			ИмяПоляПроверятьЗаполнениеХарактеристики = "РаспределениеЗапасов.ПроверятьЗаполнениеХарактеристики";
			ИмяПоляИспользоватьХарактеристики = "РаспределениеЗапасов.ИспользоватьХарактеристики";
			ИмяПоляХарактеристики = НаименованиеПоляХарактеристика;
			
			НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
			РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляИспользоватьХарактеристики, Ложь, ВидСравненияКомпоновкиДанных.Равно);
			
			РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Текст", НСтр("ru = '<Не используется>'"));
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ТолькоПросмотр", Истина);
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветНедоступногоТекстаТабличнойЧасти);
			
			НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
			РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляПроверятьЗаполнениеХарактеристики, Истина, ВидСравненияКомпоновкиДанных.Равно);
			
			РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Истина);
			
			НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
			РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, "РаспределениеЗапасов.Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка(), ВидСравненияКомпоновкиДанных.НеРавно);
			РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
			
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Ложь);
		КонецЕсли;
		
		Если ИспользоватьПартии и НЕ ЗначениеПоискаПартия = Неопределено Тогда
			ИмяПоляПроверятьЗаполнениеПартии = "РаспределениеЗапасов.ПроверятьЗаполнениеПартий";
			ИмяПоляИспользоватьПартии = "РаспределениеЗапасов.ИспользоватьПартии";
			ИмяПоляПартии = НаименованиеПоляПартия;
			
			НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
			РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляИспользоватьПартии, Ложь, ВидСравненияКомпоновкиДанных.Равно);
			
			РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляПартии);
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Текст", НСтр("ru = '<Не используется>'"));
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ТолькоПросмотр", Истина);
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветНедоступногоТекстаТабличнойЧасти);
			
			НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
			РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляПроверятьЗаполнениеПартии, Истина, ВидСравненияКомпоновкиДанных.Равно);
			
			РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляПартии);
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Истина);
			
			НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
			
			РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, "РаспределениеЗапасов.Партия", Справочники.ПартииНоменклатуры.ПустаяСсылка(), ВидСравненияКомпоновкиДанных.НеРавно);
			РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляПартии);
			РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Ложь);
		КонецЕсли;
	КонецЕсли;
	
	Если СоответствиеИменТабличныхЧастей = Неопределено Тогда
		
		МетаданныеОбъекта = Форма.Объект.Ссылка.Метаданные();
		
		Для Каждого ТабличнаяЧасть Из МетаданныеОбъекта.ТабличныеЧасти Цикл
			Если ИспользоватьХарактеристики и НЕ ТабличнаяЧасть.Реквизиты.Найти("Характеристика") = Неопределено Тогда
				НаименованиеПоля = ТабличнаяЧасть.Имя + "Характеристика";
				ЗначениеПоиска = Форма.Элементы.Найти(НаименованиеПоля);
				
				Если НЕ ЗначениеПоиска = Неопределено и ТипЗнч(ЗначениеПоиска.Родитель) = Тип("ТаблицаФормы") Тогда
					ИмяПоляПроверятьЗаполнениеХарактеристики = ЗначениеПоиска.Родитель.ПутьКДанным + ".ПроверятьЗаполнениеХарактеристики";
					ИмяПоляИспользоватьХарактеристики = ЗначениеПоиска.Родитель.ПутьКДанным+".ИспользоватьХарактеристики";
					ИмяПоляХарактеристики = НаименованиеПоля; 
					
					НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляИспользоватьХарактеристики, Ложь, ВидСравненияКомпоновкиДанных.Равно);
					
					Если Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли; 
					
					Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли;
					
					РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Текст", НСтр("ru = '<Не используется>'"));
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ТолькоПросмотр", Истина);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветНедоступногоТекстаТабличнойЧасти);
					
					НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляПроверятьЗаполнениеХарактеристики, Истина, ВидСравненияКомпоновкиДанных.Равно);
					
					Если Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли;
					
					Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли;
					
					РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Истина);
					
					НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным+".Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка(), ВидСравненияКомпоновкиДанных.НеРавно);
					РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Ложь);
				КонецЕсли;
			КонецЕсли;
			
			Если ИспользоватьПартии и НЕ ТабличнаяЧасть.Реквизиты.Найти("Партия") = Неопределено Тогда
				НаименованиеПоля = ТабличнаяЧасть.Имя + "Партия";
				ЗначениеПоиска = Форма.Элементы.Найти(НаименованиеПоля);
				
				Если НЕ ЗначениеПоиска = Неопределено и ТипЗнч(ЗначениеПоиска.Родитель) = Тип("ТаблицаФормы") Тогда
					ИмяПоляИспользоватьПартии = ЗначениеПоиска.Родитель.ПутьКДанным+".ИспользоватьПартии";
					ИмяПоляХарактеристики = НаименованиеПоля; 
					ИмяПоляПроверятьЗаполнениеПартии = ЗначениеПоиска.Родитель.ПутьКДанным + ".ПроверятьЗаполнениеПартий";
					
					ИмяПоляВидОперации = "Объект.ВидОперации";
					СписокИсключенийВидовОпераций = Новый СписокЗначений;
					
					СписокИсключенийВидовОпераций.Добавить(Перечисления.ВидыОперацийПриходнаяНакладная.ПриемВПереработку);
					СписокИсключенийВидовОпераций.Добавить(Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаКомиссию);
					СписокИсключенийВидовОпераций.Добавить(Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаОтветхранение);
					
					НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляИспользоватьПартии, Ложь, ВидСравненияКомпоновкиДанных.Равно);
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляВидОперации, СписокИсключенийВидовОпераций, ВидСравненияКомпоновкиДанных.НеВСписке);
					
					
					Если Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли;
					
					Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли;
					
					РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Текст", НСтр("ru = '<Не используется>'"));
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ТолькоПросмотр", Истина);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветНедоступногоТекстаТабличнойЧасти);
					
					НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляПроверятьЗаполнениеПартии, Истина, ВидСравненияКомпоновкиДанных.Равно);
					
					Если Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли;
					
					Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
						РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
					КонецЕсли;
					
					РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Истина);
					
					НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным+".Партия", Справочники.ПартииНоменклатуры.ПустаяСсылка(), ВидСравненияКомпоновкиДанных.НеРавно);
					РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
					РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Ложь);
					
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
	Иначе
		
		Для Каждого ТабличнаяЧасть Из СоответствиеИменТабличныхЧастей Цикл
			
			НаименованиеПоля =?(ЗначениеЗаполнено(ТабличнаяЧасть.Значение),ТабличнаяЧасть.Значение, ТабличнаяЧасть.Ключ + "Характеристика");
			ЗначениеПоиска = Форма.Элементы.Найти(НаименованиеПоля);
			
			Если ИспользоватьХарактеристики и НЕ ЗначениеПоиска = Неопределено и ТипЗнч(ЗначениеПоиска.Родитель) = Тип("ТаблицаФормы") Тогда
				ИмяПоляПроверятьЗаполнениеХарактеристики = ЗначениеПоиска.Родитель.ПутьКДанным + ".ПроверятьЗаполнениеХарактеристики";
				ИмяПоляИспользоватьХарактеристики = ЗначениеПоиска.Родитель.ПутьКДанным+".ИспользоватьХарактеристики";
				ИмяПоляХарактеристики = НаименованиеПоля; 
				
				НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
				РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляИспользоватьХарактеристики, Ложь, ВидСравненияКомпоновкиДанных.Равно);
				
				Если  Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Текст", НСтр("ru = '<Не используется>'"));
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ТолькоПросмотр", Истина);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветНедоступногоТекстаТабличнойЧасти);
				
				НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
				РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляПроверятьЗаполнениеХарактеристики, Истина, ВидСравненияКомпоновкиДанных.Равно);
				
				Если Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Истина);
				
				НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
				РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным+".Характеристика", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка(), ВидСравненияКомпоновкиДанных.НеРавно);
				РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПоляХарактеристики);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Ложь);
			КонецЕсли;
			
			НаименованиеПоля = ТабличнаяЧасть.Ключ + "Партия";
			ЗначениеПоиска = Форма.Элементы.Найти(НаименованиеПоля);
			
			Если ИспользоватьПартии и НЕ ЗначениеПоиска = Неопределено и ТипЗнч(ЗначениеПоиска.Родитель) = Тип("ТаблицаФормы") Тогда
				ИмяПоляИспользоватьПартии = ЗначениеПоиска.Родитель.ПутьКДанным+".ИспользоватьПартии";
				ИмяПолПартии = НаименованиеПоля; 
				ИмяПоляПроверятьЗаполнениеПартии = ЗначениеПоиска.Родитель.ПутьКДанным + ".ПроверятьЗаполнениеПартий";
				
				ИмяПоляВидОперации = "Объект.ВидОперации";
				СписокИсключенийВидовОпераций = Новый СписокЗначений;
				
				СписокИсключенийВидовОпераций.Добавить(Перечисления.ВидыОперацийПриходнаяНакладная.ПриемВПереработку);
				СписокИсключенийВидовОпераций.Добавить(Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаКомиссию);
				СписокИсключенийВидовОпераций.Добавить(Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаОтветхранение);
				
				НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
				РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляИспользоватьПартии, Ложь, ВидСравненияКомпоновкиДанных.Равно);
				РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляВидОперации, СписокИсключенийВидовОпераций, ВидСравненияКомпоновкиДанных.НеВСписке);
				
				Если Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПолПартии);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Текст", НСтр("ru = '<Не используется>'"));
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ТолькоПросмотр", Истина);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветНедоступногоТекстаТабличнойЧасти);
				
				НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
				РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяПоляПроверятьЗаполнениеПартии, Истина, ВидСравненияКомпоновкиДанных.Равно);
				
				Если Форма.ИмяФормы = "Документ.КорректировкаПоступления.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеПоступления", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				Если Форма.ИмяФормы = "Документ.КорректировкаРеализации.Форма.ФормаДокумента" Тогда
					РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным + ".ЕстьВДокументеРеализации", Ложь, ВидСравненияКомпоновкиДанных.Равно);
				КонецЕсли;
				
				РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПолПартии);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Истина);
				
				НовоеУсловноеОформление = Форма.УсловноеОформление.Элементы.Добавить();
				РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ЗначениеПоиска.Родитель.ПутьКДанным+".Партия", Справочники.ПартииНоменклатуры.ПустаяСсылка(), ВидСравненияКомпоновкиДанных.НеРавно);
				РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, ИмяПолПартии);
				РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ОтметкаНезаполненного", Ложь);
				
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

//Получает значение партии номенклатуры по умолчанию
//
Функция ЗначенияПартийНоменклатурыПоУмолчанию(Номенклатура, СтатусПартии = Неопределено, Контрагент = Неопределено) Экспорт 
	
	СписокСтатусов = Новый СписокЗначений;
	
	Если Не СтатусПартии = Неопределено Тогда
		Если Не ТипЗнч(СтатусПартии) = Тип("СписокЗначений")
			Тогда
			СписокСтатусов.Добавить(СтатусПартии);
		Иначе
			СписокСтатусов = СтатусПартии;
		КонецЕсли;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПартииКонтрагентов.Партия КАК Партия
	|ИЗ
	|	РегистрСведений.ПартииКонтрагентов КАК ПартииКонтрагентов
	|ГДЕ
	|	ПартииКонтрагентов.Номенклатура = &Номенклатура
	|	И ПартииКонтрагентов.Статус В (&СписокСтатусов)
	|	И ПартииКонтрагентов.Контрагент = &Контрагент";
	
	Если СписокСтатусов.Количество() Тогда
		Запрос.УстановитьПараметр("СписокСтатусов", СписокСтатусов);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"И ПартииКонтрагентов.Статус В (&СписокСтатусов)","");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Контрагент) Тогда
		Запрос.УстановитьПараметр("Контрагент", Контрагент);
		ВыборкаЗапроса = Запрос.Выполнить();
		Если ВыборкаЗапроса.Пустой() Тогда
			Запрос.УстановитьПараметр("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
			РезультатЗапроса = Запрос.Выполнить().Выбрать();
		Иначе
			РезультатЗапроса = ВыборкаЗапроса.Выбрать();
		КонецЕсли;
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ПартииКонтрагентов.Контрагент = &Контрагент","");
		РезультатЗапроса = Запрос.Выполнить().Выбрать();
	КонецЕсли;
	
	Если РезультатЗапроса.Количество()>1 Тогда
		Возврат Неопределено
	Иначе	
		Если РезультатЗапроса.Следующий() Тогда
			Возврат РезультатЗапроса.Партия;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

//Возвращает статус партии, соответствующий операции документа
//
Функция СоответствиеВидаОпреацииИлиХозОперацииСтатусуПартии(Объект, ВидОперации = Неопределено, ХозОперация = Неопределено) Экспорт
	
	ОперацияДокумента = ?(Не ВидОперации = Неопределено, ВидОперации, ХозОперация);
	
	ОтборСтатус = Новый СписокЗначений;
	
	Если ОперацияДокумента = Неопределено Тогда
		ОтборСтатус.Добавить(Перечисления.СтатусыПартий.СобственныеЗапасы);
		ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ДавальческоеСырье);
		ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ОтветственноеХранение);
		ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ТоварыНаКомиссии);
		Возврат ОтборСтатус;
	КонецЕсли;
	
	Если Не ОперацияДокумента = Неопределено 
		и ТипЗнч(ОперацияДокумента) = Тип("СправочникСсылка.ХозяйственныеОперации") Тогда
		
		Если ОперацияДокумента = Справочники.ХозяйственныеОперации.ВозвратКомитенту
			Или ОперацияДокумента = Справочники.ХозяйственныеОперации.ПриемНаКомиссию Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ТоварыНаКомиссии);
		ИначеЕсли ОперацияДокумента = Справочники.ХозяйственныеОперации.ПриемНаОтветхранение
			Или ОперацияДокумента = Справочники.ХозяйственныеОперации.ВозвратСОтветхранения Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ОтветственноеХранение);
		ИначеЕсли ОперацияДокумента = Справочники.ХозяйственныеОперации.ПриемВПереработку
			Или ОперацияДокумента = Справочники.ХозяйственныеОперации.ВозвратИзПереработки Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ДавальческоеСырье);
		Иначе
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.СобственныеЗапасы);
			
			Если ОперацияДокумента = Справочники.ХозяйственныеОперации.ПродажаПокупателю Тогда
				ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ТоварыНаКомиссии);
			КонецЕсли;
			
		КонецЕсли;
		
		Если Не ОтборСтатус.Количество()Тогда
			ТекстСообщения = НСтр("ru = 'Для операции документа - %1%, не найден статус партии. Выбор партии не возможен!'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(ОперацияДокумента));
			
			УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(Объект, ТекстСообщения);
			
			Возврат Неопределено;
		КонецЕсли;
		
	ИначеЕсли Не ОперацияДокумента = Неопределено 
		и (ТипЗнч(ОперацияДокумента) = Тип("ПеречислениеСсылка.ВидыОперацийРасходнаяНакладная") 
		или ТипЗнч(ОперацияДокумента) = Тип("ПеречислениеСсылка.ВидыОперацийПриходнаяНакладная"))Тогда
		
		Если ОперацияДокумента = Перечисления.ВидыОперацийРасходнаяНакладная.ВозвратКомитенту
			Или ОперацияДокумента = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаКомиссию Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ТоварыНаКомиссии);
		ИначеЕсли ОперацияДокумента = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаОтветхранение
			Или ОперацияДокумента = Перечисления.ВидыОперацийРасходнаяНакладная.ВозвратСОтветхранения Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ОтветственноеХранение);
		ИначеЕсли ОперацияДокумента = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемВПереработку
			Или ОперацияДокумента = Перечисления.ВидыОперацийРасходнаяНакладная.ВозвратИзПереработки Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ДавальческоеСырье);
		Иначе
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.СобственныеЗапасы);
			
			Если ОперацияДокумента = Перечисления.ВидыОперацийРасходнаяНакладная.ПродажаПокупателю Тогда
				ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ТоварыНаКомиссии);
			КонецЕсли;
			
		КонецЕсли;
		
		Если Не ОтборСтатус.Количество() Тогда
			ТекстСообщения = НСтр("ru = 'Для операции документа - %1%, не найден статус партии. Выбор партии не возможен!'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(ОперацияДокумента));
			
			УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(Объект, ТекстСообщения);
			
			Возврат Неопределено;
		КонецЕсли;
		
	Иначе
		
		Если ОперацияДокумента = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаКомиссию Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ТоварыНаКомиссии);
		ИначеЕсли ОперацияДокумента = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемНаОтветхранение Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ОтветственноеХранение);
		ИначеЕсли ОперацияДокумента = Перечисления.ВидыОперацийПриходнаяНакладная.ПриемВПереработку Тогда
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ДавальческоеСырье);
		Иначе
			ОтборСтатус.Добавить(Перечисления.СтатусыПартий.СобственныеЗапасы);
			
			Если ОперацияДокумента = Перечисления.ВидыОперацийРасходнаяНакладная.ПродажаПокупателю Тогда
				ОтборСтатус.Добавить(Перечисления.СтатусыПартий.ТоварыНаКомиссии);
			КонецЕсли;
			
		КонецЕсли;
		
		Если Не ОтборСтатус.Количество() Тогда
			ТекстСообщения = НСтр("ru = 'Для операции документа - %1%, не найден статус партии. Выбор партии не возможен!'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(ОперацияДокумента));
			
			УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(Объект, ТекстСообщения);
			
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ОтборСтатус;
	
КонецФункции

//Возвращает партию по умолчанию.
//
Функция ПартияУстановленаПоУмолчанию(Ссылка) Экспорт
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Запрос.Текст = "ВЫБРАТЬ
	|	ПартииКонтрагентов.Партия КАК Партия
	|ИЗ
	|	РегистрСведений.ПартииКонтрагентов КАК ПартииКонтрагентов
	|ГДЕ
	|	ПартииКонтрагентов.Партия = &Ссылка";
	
	Возврат Не Запрос.Выполнить().Пустой();
	
КонецФункции

//Заполняет колонки табличной части документа Заказ покупателя значениями по остаткам и резервам
//
Процедура ЗаполнитьЗначенияРезервовИОстатокНоменклатурыВТабличнойЧасти(Объект, СтруктураДанные = Неопределено, НомерВариантаКП, НоменклатураОтбора = Неопределено, РезервированиеЗапасов = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	
	Если СтруктураДанные = Неопределено Тогда
		
		Если Не ЗначениеЗаполнено(НоменклатураОтбора) Тогда
			ПараметрыОтбора = Новый Структура("НомерВариантаКП", НомерВариантаКП);
		Иначе
			ПараметрыОтбора = Новый Структура("НомерВариантаКП, Номенклатура", НомерВариантаКП, НоменклатураОтбора);
		КонецЕсли;
	
		СтрокиДляВыгрузки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
		ТаблицаНоменклатуры = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв");
		
		МассивНоменклатуры = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Номенклатура");
		МассивХарактеристик = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Характеристика");
		МассивПартий = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Партия");
		
	Иначе
		
		Номенклатура = СтруктураДанные.Номенклатура;
		Характеристика = ?(СтруктураДанные.ИспользоватьХарактеристики и ЗначениеЗаполнено(СтруктураДанные.Характеристика)
		, СтруктураДанные.Характеристика, Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
		Партия = ?(СтруктураДанные.ИспользоватьПартии, СтруктураДанные.Партия, Справочники.ПартииНоменклатуры.ПустаяСсылка());
		
		ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, НомерВариантаКП", Номенклатура, Характеристика, Партия, НомерВариантаКП);
		СтрокиДляВыгрузки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
		ТаблицаНоменклатуры = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв");
		
		МассивНоменклатуры = Новый Массив;
		МассивНоменклатуры.Добавить(Номенклатура);
		МассивХарактеристик = Новый Массив;
		МассивХарактеристик.Добавить(Характеристика);
		МассивПартий = Новый Массив;
		МассивПартий.Добавить(Партия);
		
	КонецЕсли;
	
	Организация = УправлениеНебольшойФирмойСервер.ПолучитьОрганизацию(Объект.Организация);
	
	СтрокиОбходаЗапасов = СтрокиДляВыгрузки;
	
	Запрос.УстановитьПараметр("ТаблицаНоменклатура", ТаблицаНоменклатуры);
	Запрос.УстановитьПараметр("Номенклатура", МассивНоменклатуры);
	Запрос.УстановитьПараметр("Характеристика", МассивХарактеристик);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ЗаказПокупателя", Объект.Ссылка);
	
	Запрос.Текст = ТекстЗапросаОстаткиИРезервы();
	
	ТаблицаОстатков = Запрос.Выполнить().Выгрузить();
	
	ТаблицаОтгрузкаПоЗаказу = Неопределено;
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ЗаказПокупателя", Объект.Ссылка);
		
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ПродажиОбороты.Номенклатура КАК Номенклатура,
		|	ПродажиОбороты.Характеристика КАК Характеристика,
		|	ПродажиОбороты.Партия КАК Партия,
		|	СУММА(ПродажиОбороты.КоличествоОборот) КАК Количество,
		|	СУММА(ПродажиОбороты.КоличествоОборот) КАК ОтгруженоИтог
		|ИЗ
		|	РегистрНакопления.Продажи.Обороты(, , , ЗаказПокупателя = &ЗаказПокупателя) КАК ПродажиОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	ПродажиОбороты.Номенклатура,
		|	ПродажиОбороты.Партия,
		|	ПродажиОбороты.Характеристика";
		
		ТаблицаОтгрузкаПоЗаказу = Запрос.Выполнить().Выгрузить();
	КонецЕсли;
	
	ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв");
	
	ПараметрыОтбораБезСклада = Новый Структура();
	ПараметрыОтбораБезСклада.Вставить("Номенклатура");
	ПараметрыОтбораБезСклада.Вставить("Характеристика");
	ПараметрыОтбораБезСклада.Вставить("Партия");

	НомерСтроки = 0;
	ОбъектПроведен = Объект.Проведен;
	ЕстьДубли = Ложь;
	
	Для Каждого СтрокаТабличнойЧасти из СтрокиОбходаЗапасов Цикл
		НомерСтроки = НомерСтроки + 1;
		
		Если Не ЗначениеЗаполнено(СтрокаТабличнойЧасти.ЕдиницаИзмерения) 
			Или ТипЗнч(СтрокаТабличнойЧасти.ЕдиницаИзмерения) = Тип("СправочникСсылка.КлассификаторЕдиницИзмерения")
			Тогда 
			КоэффициентЕдиницыИзмерения = 1;
		Иначе
			КоэффициентЕдиницыИзмерения = СтрокаТабличнойЧасти.ЕдиницаИзмерения.Коэффициент;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СтрокаТабличнойЧасти.Номенклатура) 
			Или ТипЗнч(СтрокаТабличнойЧасти.Номенклатура) = Тип("Строка") Тогда Продолжить КонецЕсли;
		
		ПараметрыОтбораБезСклада.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбораБезСклада.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбораБезСклада.Партия = СтрокаТабличнойЧасти.Партия;
		
		Если Не ТаблицаОтгрузкаПоЗаказу = Неопределено Тогда
			НайденныеСтрокиОтгружено = ТаблицаОтгрузкаПоЗаказу.НайтиСтроки(ПараметрыОтбораБезСклада);
		Иначе
			НайденныеСтрокиОтгружено = Неопределено;
		КонецЕсли;
		
		КоличествоСКэффициентом = СтрокаТабличнойЧасти.Количество*КоэффициентЕдиницыИзмерения;
		
		НеОтгруженоВбазовыхЕд = 0;
		ОтгруженоВБазовыхЕд = 0;
		Отгружено = 0;
		
		ПараметрыОтбора.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбора.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбора.Партия = СтрокаТабличнойЧасти.Партия;
		ПараметрыОтбора.СтруктурнаяЕдиницаРезерв = СтрокаТабличнойЧасти.СтруктурнаяЕдиницаРезерв;
		
		НайденныеСтрокиОстатки = ТаблицаОстатков.НайтиСтроки(ПараметрыОтбора);
		
		Если НайденныеСтрокиОстатки.Количество() Тогда
			СтрокаОстатка = НайденныеСтрокиОстатки[0];
		Иначе
			СтрокаОстатка = Неопределено
		КонецЕсли;
		
		СуммаПоСтрокам = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбораБезСклада, "Количество", НомерВариантаКП);
		СуммаПоСтрокамСТекКоэффициентом = СуммаПоСтрокам / КоэффициентЕдиницыИзмерения;
		
		НеОтгруженоИтог = 0;
		
		Если НайденныеСтрокиОтгружено = Неопределено или Не НайденныеСтрокиОтгружено.Количество() Тогда 
			СтрокаТабличнойЧасти.НеОтгружено = СтрокаТабличнойЧасти.Количество;
			СтрокаТабличнойЧасти.Отгружено = 0;
			СтрокаТабличнойЧасти.ПредставлениеНеОтгружено = "";
			НеОтгруженоВбазовыхЕд = СтрокаТабличнойЧасти.Количество*КоэффициентЕдиницыИзмерения;
			НеОтгруженоИтог = СуммаПоСтрокамСТекКоэффициентом;
		Иначе
			
			Отгружено = Окр(НайденныеСтрокиОтгружено[0].Количество/КоэффициентЕдиницыИзмерения,3);
			ОтгруженоИтог = Окр(НайденныеСтрокиОтгружено[0].ОтгруженоИтог/КоэффициентЕдиницыИзмерения,3, РежимОкругления.Окр15как20);
			ОтгруженоВБазовыхЕд = НайденныеСтрокиОтгружено[0].Количество;
			
			НеОтгруженоИтог = СуммаПоСтрокамСТекКоэффициентом - ОтгруженоИтог; 
			
			Если Не Отгружено = 0 Тогда
				
				Если СтрокаТабличнойЧасти.Количество >= Отгружено Тогда
					
					СтрокаТабличнойЧасти.Отгружено = Отгружено;
					НайденныеСтрокиОтгружено[0].Количество = 0;
					СтрокаТабличнойЧасти.НеОтгружено = ?(СтрокаТабличнойЧасти.Количество - СтрокаТабличнойЧасти.Отгружено<0, 0, СтрокаТабличнойЧасти.Количество - Отгружено);
					НеОтгруженоВбазовыхЕд = СтрокаТабличнойЧасти.Количество*КоэффициентЕдиницыИзмерения - ОтгруженоВБазовыхЕд;
				Иначе
					СтрокаТабличнойЧасти.Отгружено = СтрокаТабличнойЧасти.Количество;
					НайденныеСтрокиОтгружено[0].Количество = ОтгруженоВБазовыхЕд - СтрокаТабличнойЧасти.Количество*КоэффициентЕдиницыИзмерения;
					СтрокаТабличнойЧасти.НеОтгружено = 0;
				КонецЕсли
				
			Иначе
				СтрокаТабличнойЧасти.Отгружено = 0;
				СтрокаТабличнойЧасти.НеОтгружено = СтрокаТабличнойЧасти.Количество;
				НеОтгруженоВбазовыхЕд = СтрокаТабличнойЧасти.Количество*КоэффициентЕдиницыИзмерения;
			КонецЕсли;
	
		КонецЕсли;
		
		ЭтоДубльСтроки = Ложь;
		
		Если Не СтрокаТабличнойЧасти.НеОтгружено = НеОтгруженоИтог и Не СтрокаТабличнойЧасти.НеОтгружено = 0 Тогда
			СтрокаТабличнойЧасти.ПредставлениеНеОтгружено = Формат(СтрокаТабличнойЧасти.НеОтгружено, "ЧДЦ = 3")+" / " + Формат(НеОтгруженоИтог, "ЧДЦ = 3");
			ЭтоДубльСтроки = Истина;
			ЕстьДубли = Истина;
		Иначе
			СтрокаТабличнойЧасти.ПредставлениеНеОтгружено = "";
		КонецЕсли;
		
		СтрокаТабличнойЧасти.ЭтоДубльСтроки = ЭтоДубльСтроки;
		СтрокаТабличнойЧасти.НеОтгруженоВсего = НеОтгруженоИтог;
		СтрокаТабличнойЧасти.СрокПополнения = СтрокаТабличнойЧасти.Номенклатура.СрокПополнения;
		
		Если КоэффициентЕдиницыИзмерения = 1 и СуммаПоСтрокам = СтрокаТабличнойЧасти.Количество Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")
		ИначеЕсли КоэффициентЕдиницыИзмерения = 1 и Не СуммаПоСтрокам = СтрокаТабличнойЧасти.Количество Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")+ " / " + Формат(СуммаПоСтрокам, "ЧДЦ=3");
		ИначеЕсли Не КоэффициентЕдиницыИзмерения = 1 и СуммаПоСтрокам = КоличествоСКэффициентом Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")
		ИначеЕсли Не КоэффициентЕдиницыИзмерения = 1 и Не СуммаПоСтрокам = КоличествоСКэффициентом Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")+ " / " + Формат(СуммаПоСтрокамСТекКоэффициентом, "ЧДЦ=3");
		КонецЕсли;
		
		СтрокаТабличнойЧасти.МожноОтгрузить = 0;
		СтрокаТабличнойЧасти.Обеспечено = 0;
		СтрокаТабличнойЧасти.ВРезерве = 0;
		СтрокаТабличнойЧасти.Зарезервировано = 0;
		
		Если СтрокаОстатка = Неопределено Тогда 
			СтрокаТабличнойЧасти.ОстатокСвободно = 0;
			СтрокаТабличнойЧасти.КПоступлению = 0;
			СтрокаТабличнойЧасти.ОстатокОбщий = 0;
			СтрокаТабличнойЧасти.Размещено = 0;
			СтрокаТабличнойЧасти.СрокПополнения = 1;
			Продолжить
		КонецЕсли;
		
		ОстатокСвободно = Окр(СтрокаОстатка.ОстатокТекСклад/КоэффициентЕдиницыИзмерения,3);
		
		ИтогПоЗначениюВРезервВБазовыхЕдиницах = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "Резервировать", НомерВариантаКП);
		ИтогПоЗначениюВРезерв = Окр(ИтогПоЗначениюВРезервВБазовыхЕдиницах/КоэффициентЕдиницыИзмерения,3);
		
		ЗарезервированоЗаказомСКоэффициентом = Окр(СтрокаОстатка.ЗарезервированоЗаказом/КоэффициентЕдиницыИзмерения,3);
		
		СтрокаТабличнойЧасти.ОстатокСвободно = (ОстатокСвободно +  ЗарезервированоЗаказомСКоэффициентом - ИтогПоЗначениюВРезерв);
		
		ИтогПоЗначениюВРезервВБазовыхЕдиницахПоВсемСкладам = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбораБезСклада, "Резервировать", НомерВариантаКП);
		ИтогПоЗначениюВРезервПоВсемСкладам = Окр(ИтогПоЗначениюВРезервВБазовыхЕдиницахПоВсемСкладам/КоэффициентЕдиницыИзмерения,3);
		
		ИтогПоЗначениюВРезервВБазовыхЕдиницахТекСклад = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "Резервировать", НомерВариантаКП);
		ИтогПоЗначениюВРезервТекСклад = Окр(ИтогПоЗначениюВРезервВБазовыхЕдиницахТекСклад/КоэффициентЕдиницыИзмерения,3);
		
		РезервНаСкладахСКоэффициетом = Окр(СтрокаОстатка.РезервНаСкладах/КоэффициентЕдиницыИзмерения,3);
		СтрокаТабличнойЧасти.ВРезерве = РезервНаСкладахСКоэффициетом + ИтогПоЗначениюВРезервПоВсемСкладам;
		
		РезервТекСкладСКоэффициетом = Окр(СтрокаОстатка.РезервТекСклад/КоэффициентЕдиницыИзмерения,3);
		СтрокаТабличнойЧасти.Зарезервировано = РезервТекСкладСКоэффициетом + ИтогПоЗначениюВРезервТекСклад;
		
		ЗаказаноБезРезерваСКоэффициентом = Окр(СтрокаОстатка.ЗаказаноБезРезерва/КоэффициентЕдиницыИзмерения,3);
		ОстатокОбщийСКоэффициентом = Окр(СтрокаОстатка.ОстатокОбщий/КоэффициентЕдиницыИзмерения,3);
		
		СтрокаТабличнойЧасти.КПоступлению = ЗаказаноБезРезерваСКоэффициентом;
		
		ЗарезервированоЗаказомСКоэффициентомВсеСклады = Окр(СтрокаОстатка.ЗарезервированоЗаказомВсеСклады/КоэффициентЕдиницыИзмерения,3);
		
		Если Не ОбъектПроведен Тогда
			СтрокаТабличнойЧасти.ОстатокОбщий = ОстатокОбщийСКоэффициентом - ИтогПоЗначениюВРезервПоВсемСкладам;
		Иначе
			СтрокаТабличнойЧасти.ОстатокОбщий = ОстатокОбщийСКоэффициентом - ИтогПоЗначениюВРезервПоВсемСкладам + ЗарезервированоЗаказомСКоэффициентомВсеСклады;
		КонецЕсли;
		
		Если РезервированиеЗапасов Тогда
			
			Если ОбъектПроведен Тогда
				
				СтрокаТабличнойЧасти.Размещено = СтрокаОстатка.РезервЗаказано;
				
				Если Не СтрокаТабличнойЧасти.НеОтгружено = 0 Тогда
					СтрокаТабличнойЧасти.Обеспечено = СтрокаТабличнойЧасти.ВРезерве + СтрокаТабличнойЧасти.Размещено;
				КонецЕсли;
			Иначе
				
				СуммаПоСтрокамРезерв = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбораБезСклада, "Резервировать", НомерВариантаКП);
				СуммаПоСтрокамСТекКоэффициентомРезерв = СуммаПоСтрокамРезерв / КоэффициентЕдиницыИзмерения;
				СтрокаТабличнойЧасти.Обеспечено = СуммаПоСтрокамСТекКоэффициентомРезерв;
				
			КонецЕсли;
			
			Если Не ЭтоДубльСтроки Тогда
				РазностьСколькоНужноИСколькоЕсть = (СтрокаТабличнойЧасти.ОстатокСвободно + СтрокаТабличнойЧасти.ВРезерве) - СтрокаТабличнойЧасти.НеОтгружено;
				МожноОтгрузитьВсего = ?(РазностьСколькоНужноИСколькоЕсть > 0, СтрокаТабличнойЧасти.НеОтгружено, СтрокаТабличнойЧасти.ОстатокСвободно + СтрокаТабличнойЧасти.ВРезерве);
				СтрокаТабличнойЧасти.МожноОтгрузить = МожноОтгрузитьВсего;
			КонецЕсли
			
		Иначе
			
			Если Не ЭтоДубльСтроки Тогда
				РазностьСколькоНужноИСколькоЕсть = СтрокаТабличнойЧасти.ОстатокСвободно - СтрокаТабличнойЧасти.НеОтгружено;
				МожноОтгрузитьВсего = ?(РазностьСколькоНужноИСколькоЕсть > 0, СтрокаТабличнойЧасти.НеОтгружено, СтрокаТабличнойЧасти.ОстатокСвободно);
				СтрокаТабличнойЧасти.МожноОтгрузить = МожноОтгрузитьВсего;
			КонецЕсли
			
		КонецЕсли;
		
		Если Не ЭтоДубльСтроки 
			и Не СтрокаТабличнойЧасти.НеОтгружено = 0 
			и СтрокаТабличнойЧасти.МожноОтгрузить > 0 Тогда
			СуммаОстаткаИРезерва = СтрокаТабличнойЧасти.ОстатокСвободно + СтрокаТабличнойЧасти.Зарезервировано;
			СтрокаТабличнойЧасти.ИндексЦвета = ?(СуммаОстаткаИРезерва < СтрокаТабличнойЧасти.НеОтгружено, 1,0);
		КонецЕсли;
		
		Если СтрокаОстатка.КоличествоДокументовЗаказано > 1 Тогда
			
			РасшифровкаСчетчика = ПредметИсчисления(
			СтрокаОстатка.КоличествоДокументовЗаказано,
			НСтр("ru = 'документ'"),
			НСтр("ru = 'документа'"),
			НСтр("ru = 'документов'"),
			"м");
			
			СтрокаТабличнойЧасти.ДатаПоступления = Строка(СтрокаОстатка.КоличествоДокументовЗаказано) + РасшифровкаСчетчика;
		Иначе
			СтрокаТабличнойЧасти.ДатаПоступления = ?(Не ЗначениеЗаполнено(СтрокаОстатка.ДатаПоступления),"", СтрокаОстатка.ДатаПоступления);
		КонецЕсли;
		
	КонецЦикла;
	
	//Дозаполним информацию по дублям строк
	Если Не ЕстьДубли Тогда Возврат КонецЕсли;

	ПараметрыОтбораДляДублей = Новый Структура("НомерВариантаКП, ЭтоДубльСтроки", НомерВариантаКП, Истина);
	СтрокиДляОбхода = Объект.Запасы.НайтиСтроки(ПараметрыОтбораДляДублей);
	ТаблицаНоменклатуры = Объект.Запасы.Выгрузить(СтрокиДляОбхода,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв, ОстатокСвободно, Зарезервировано, ВРезерве");
	ТаблицаНоменклатуры.Свернуть("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв, ОстатокСвободно, Зарезервировано, ВРезерве");
	
	ТаблицаОбхода = ТаблицаНоменклатуры.Скопировать(,"Номенклатура, Характеристика, Партия");
	ТаблицаОбхода.Свернуть("Номенклатура, Характеристика, Партия");
	
	Для Каждого СтрокаИзДублейСтрок из ТаблицаОбхода Цикл
		
		ПараметрыОтбораБезСклада.Номенклатура = СтрокаИзДублейСтрок.Номенклатура;
		ПараметрыОтбораБезСклада.Характеристика = СтрокаИзДублейСтрок.Характеристика;
		ПараметрыОтбораБезСклада.Партия = СтрокаИзДублейСтрок.Партия;
		
		СтрокиДляОбхода = Объект.Запасы.НайтиСтроки(ПараметрыОтбораБезСклада);
		
		ИндексЦвета = 0;
		
		Для Каждого СтрокаТабличнойЧасти из СтрокиДляОбхода Цикл
			
			//Колонка Можно отгрузить
			ИтогПоЗначениюНеОтгруженоВБазовыхЕдиницах = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбораБезСклада, "НеОтгружено", НомерВариантаКП);
			ИтогПоЗначениюНеОтгружено = Окр(ИтогПоЗначениюНеОтгруженоВБазовыхЕдиницах/КоэффициентЕдиницыИзмерения,3);
			
			СтрокиДляВыгрузки = ТаблицаНоменклатуры.НайтиСтроки(ПараметрыОтбораБезСклада);
			ТаблицаДляИтоговПоСкладу = ТаблицаНоменклатуры.Скопировать(СтрокиДляВыгрузки,"Номенклатура, Характеристика, Партия, ОстатокСвободно");
			
			СвободноДляРезерва = ТаблицаДляИтоговПоСкладу.Итог("ОстатокСвободно");
			
			ДоступноКОтгрузке = СвободноДляРезерва + СтрокаТабличнойЧасти.ВРезерве;
			
			СтрокаТабличнойЧасти.МожноОтгрузить = ?(ИтогПоЗначениюНеОтгружено < ДоступноКОтгрузке, ИтогПоЗначениюНеОтгружено, ДоступноКОтгрузке);
			
			//Цвет значния колонки
			Если Не СтрокаТабличнойЧасти.НеОтгружено = 0 
				и СтрокаТабличнойЧасти.МожноОтгрузить > 0 Тогда
				
				ПараметрыОтбора.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
				ПараметрыОтбора.Характеристика = СтрокаТабличнойЧасти.Характеристика;
				ПараметрыОтбора.Партия = СтрокаТабличнойЧасти.Партия;
				ПараметрыОтбора.СтруктурнаяЕдиницаРезерв = СтрокаТабличнойЧасти.СтруктурнаяЕдиницаРезерв;
				
				ИтогПоЗначениюНеОтгруженоВБазовыхЕдиницах = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "НеОтгружено", НомерВариантаКП);
				ИтогПоЗначениюНеОтгружено = Окр(ИтогПоЗначениюНеОтгруженоВБазовыхЕдиницах/КоэффициентЕдиницыИзмерения,3);
				
				ДоступноКОтгрузке = СтрокаТабличнойЧасти.ОстатокСвободно + СтрокаТабличнойЧасти.Зарезервировано;
				
				Если ИтогПоЗначениюНеОтгружено > ДоступноКОтгрузке Тогда
					ИндексЦвета = 1;
				Иначе
					СтрокаТабличнойЧасти.ИндексЦвета = 0;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
		Если ИндексЦвета = 0 Тогда Продолжить КонецЕсли;
		
		Для Каждого СтрокаТабличнойЧасти из СтрокиДляОбхода Цикл
			СтрокаТабличнойЧасти.ИндексЦвета = ИндексЦвета;
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

//Заполняет колонки табличной части документа Расходная накладная значениями по остаткам
//
Процедура ЗаполнитьЗначенияОстатковНоменклатурыВТабличнойЧасти(Объект, СтруктураДанные = Неопределено,  НоменклатураОтбора = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	
	Если СтруктураДанные = Неопределено Тогда
		
		ТаблицаНоменклатуры = Объект.Запасы.Выгрузить(,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, ЕдиницаИзмерения, Заказ, Ячейка, ЯчейкаДоступна");
		
		МассивНоменклатуры = Объект.Запасы.Выгрузить(,"Номенклатура");
		МассивХарактеристик = Объект.Запасы.Выгрузить(,"Характеристика");
		
		СтрокиДляВыгрузки = Объект.Запасы;
		
	Иначе
		
		Номенклатура = СтруктураДанные.Номенклатура;
		Характеристика = ?(СтруктураДанные.ИспользоватьХарактеристики и ЗначениеЗаполнено(СтруктураДанные.Характеристика)
		, СтруктураДанные.Характеристика, Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
		Партия = ?(СтруктураДанные.ИспользоватьПартии, СтруктураДанные.Партия, Справочники.ПартииНоменклатуры.ПустаяСсылка());
		
		Если ЗначениеЗаполнено(НоменклатураОтбора) Тогда
			ПараметрыОтбора = Новый Структура(" Номенклатура", НоменклатураОтбора);
		Иначе
			ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия", Номенклатура, Характеристика, Партия);
		КонецЕсли;
		
		СтрокиДляВыгрузки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
		ТаблицаНоменклатуры = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, ЕдиницаИзмерения, Заказ, Ячейка, ЯчейкаДоступна");
		
		МассивНоменклатуры = Новый Массив;
		МассивНоменклатуры.Добавить(Номенклатура);
		МассивХарактеристик = Новый Массив;
		МассивХарактеристик.Добавить(Характеристика);
		
	КонецЕсли;
	
	Организация = УправлениеНебольшойФирмойСервер.ПолучитьОрганизацию(Объект.Организация);
	
	СтрокиОбходаЗапасов = СтрокиДляВыгрузки;
	
	Запрос.УстановитьПараметр("ТаблицаНоменклатура", ТаблицаНоменклатуры);
	Запрос.УстановитьПараметр("Номенклатура", МассивНоменклатуры);
	Запрос.УстановитьПараметр("Характеристика", МассивХарактеристик);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("МассивЗаказов", Объект.Запасы.Выгрузить(,"Заказ"));
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	
	Запрос.Текст = ТекстЗапросаОстаткиИРезервыРасходнаяНакладная();
		
	ТаблицаОстатков = Запрос.Выполнить().Выгрузить();
	
	ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, Заказ, Ячейка");
	ПараметрыОтбораСкладЗаказБезЯчейки = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, Заказ");
	ПараметрыОтбораБезСклада = Новый Структура("Номенклатура, Характеристика, Партия, Заказ");
	ПараметрыОтбораБезСкладаБезЗаказа = Новый Структура("Номенклатура, Характеристика, Партия");
	ПараметрыОтбораСкладИЯчейка = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, Ячейка");
	ПараметрыОтбораСклад = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница");
	
	ОбщиеОстаткиПоНоменклатуреПоСкладам = ТаблицаОстатков.Скопировать(,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, ОстатокТекСклад, КоличествоПроходов, КоличествоСтрок");
	ОбщиеОстаткиПоНоменклатуреПоСкладам.Свернуть("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, ОстатокТекСклад, КоличествоПроходов, КоличествоСтрок");
	
	НомерСтроки = 0;
	ОбъектПроведен = Объект.Проведен;
	
	Для Каждого СтрокаТабличнойЧасти из СтрокиОбходаЗапасов Цикл
		НомерСтроки = НомерСтроки + 1;
		
		Если Не ЗначениеЗаполнено(СтрокаТабличнойЧасти.ЕдиницаИзмерения) 
			Или ТипЗнч(СтрокаТабличнойЧасти.ЕдиницаИзмерения) = Тип("СправочникСсылка.КлассификаторЕдиницИзмерения")
			Тогда 
			КоэффициентЕдиницыИзмерения = 1;
		Иначе
			КоэффициентЕдиницыИзмерения = СтрокаТабличнойЧасти.ЕдиницаИзмерения.Коэффициент;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СтрокаТабличнойЧасти.Номенклатура) 
			Или ТипЗнч(СтрокаТабличнойЧасти.Номенклатура) = Тип("Строка") Тогда Продолжить КонецЕсли;
		
		ПараметрыОтбораБезСклада.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбораБезСклада.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбораБезСклада.Партия = СтрокаТабличнойЧасти.Партия;
		ПараметрыОтбораБезСклада.Заказ = СтрокаТабличнойЧасти.Заказ;
		
		ПараметрыОтбораСклад.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбораСклад.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбораСклад.Партия = СтрокаТабличнойЧасти.Партия;
		ПараметрыОтбораСклад.СтруктурнаяЕдиница = СтрокаТабличнойЧасти.СтруктурнаяЕдиница;
		
		ПараметрыОтбораБезСкладаБезЗаказа.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбораБезСкладаБезЗаказа.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбораБезСкладаБезЗаказа.Партия = СтрокаТабличнойЧасти.Партия;
		
		КоличествоСКэффициентом = СтрокаТабличнойЧасти.Количество*КоэффициентЕдиницыИзмерения;
		
		ПараметрыОтбора.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбора.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбора.Партия = СтрокаТабличнойЧасти.Партия;
		ПараметрыОтбора.СтруктурнаяЕдиница = СтрокаТабличнойЧасти.СтруктурнаяЕдиница;
		ПараметрыОтбора.Заказ = СтрокаТабличнойЧасти.Заказ;
		ПараметрыОтбора.Ячейка = СтрокаТабличнойЧасти.Ячейка;
		
		ПараметрыОтбораСкладИЯчейка.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбораСкладИЯчейка.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбораСкладИЯчейка.Партия = СтрокаТабличнойЧасти.Партия;
		ПараметрыОтбораСкладИЯчейка.СтруктурнаяЕдиница = СтрокаТабличнойЧасти.СтруктурнаяЕдиница;
		ПараметрыОтбораСкладИЯчейка.Ячейка = СтрокаТабличнойЧасти.Ячейка;
		
		ПараметрыОтбораСкладЗаказБезЯчейки.Номенклатура = СтрокаТабличнойЧасти.Номенклатура;
		ПараметрыОтбораСкладЗаказБезЯчейки.Характеристика = СтрокаТабличнойЧасти.Характеристика;
		ПараметрыОтбораСкладЗаказБезЯчейки.Партия = СтрокаТабличнойЧасти.Партия;
		ПараметрыОтбораСкладЗаказБезЯчейки.СтруктурнаяЕдиница = СтрокаТабличнойЧасти.СтруктурнаяЕдиница;
		ПараметрыОтбораСкладЗаказБезЯчейки.Заказ = СтрокаТабличнойЧасти.Заказ;
		
		НайденныеСтрокиОстатки = ТаблицаОстатков.НайтиСтроки(ПараметрыОтбора);
	
		ЭтоПоследняяСтрокаПоНоменклатуреПоЯчейке = Ложь;
		
		Если НайденныеСтрокиОстатки.Количество() Тогда
			СтрокаОстатка = НайденныеСтрокиОстатки[0];
			
			Если СтрокаОстатка.КоличествоПроходов = 0 Тогда
				СтрокиПоНоменклатуре = Объект.Запасы.НайтиСтроки(ПараметрыОтбораСкладИЯчейка);
				СтрокаОстатка.КоличествоСтрок = СтрокиПоНоменклатуре.Количество();
			КонецЕсли;
			
			СтрокаОстатка.КоличествоПроходов = СтрокаОстатка.КоличествоПроходов+1;
			ЭтоПоследняяСтрокаПоНоменклатуреПоЯчейке = ?(СтрокаОстатка.КоличествоПроходов = СтрокаОстатка.КоличествоСтрок, Истина, Ложь);
			
		Иначе
			СтрокаОстатка = Неопределено
		КонецЕсли;
		
		СтрокаТабличнойЧасти.ПредставлениеДублей = "";
		
		СуммаПоСтрокам = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбораБезСкладаБезЗаказа, "Количество");
		СуммаПоСтрокамСТекКоэффициентом = СуммаПоСтрокам / КоэффициентЕдиницыИзмерения;
		
		Если КоэффициентЕдиницыИзмерения = 1 и СуммаПоСтрокам = СтрокаТабличнойЧасти.Количество Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")
		ИначеЕсли КоэффициентЕдиницыИзмерения = 1 и Не СуммаПоСтрокам = СтрокаТабличнойЧасти.Количество Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")+ " / " + Формат(СуммаПоСтрокам, "ЧДЦ=3");
		ИначеЕсли Не КоэффициентЕдиницыИзмерения = 1 и СуммаПоСтрокам = КоличествоСКэффициентом Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")
		ИначеЕсли Не КоэффициентЕдиницыИзмерения = 1 и Не СуммаПоСтрокам = КоличествоСКэффициентом Тогда
			СтрокаТабличнойЧасти.ПредставлениеДублей = Формат(СтрокаТабличнойЧасти.Количество, "ЧДЦ=3")+ " / " + Формат(СуммаПоСтрокамСТекКоэффициентом, "ЧДЦ=3");
		КонецЕсли;
		
		СтрокаТабличнойЧасти.МожноОтгрузить = 0;
		СтрокаТабличнойЧасти.ВРезерве = 0;
		СтрокаТабличнойЧасти.НеХватает = 0;
		СтрокаТабличнойЧасти.ОстатокВЯчейке = 0;
		СтрокаТабличнойЧасти.ОстатокСвободно = 0;
		СтрокаТабличнойЧасти.ОстатокОбщий = 0;
		
		Если СтрокаОстатка = Неопределено Тогда Продолжить КонецЕсли;
		
		СтрокиОстаткиНоменклатураСкладБезЯчейки = ОбщиеОстаткиПоНоменклатуреПоСкладам.НайтиСтроки(ПараметрыОтбораСклад);
		
		ЭтоПоследняяСтрокаПоНоменклатуре = Ложь;
		
		Если СтрокиОстаткиНоменклатураСкладБезЯчейки.Количество() Тогда
			СтрокаОстаткаВЦелом = СтрокиОстаткиНоменклатураСкладБезЯчейки[0];
			
			Если СтрокаОстаткаВЦелом.КоличествоПроходов = 0 Тогда
				СтрокиПоНоменклатуре = Объект.Запасы.НайтиСтроки(ПараметрыОтбораСклад);
				СтрокаОстаткаВЦелом.КоличествоСтрок = СтрокиПоНоменклатуре.Количество();
			КонецЕсли;
			
			СтрокаОстаткаВЦелом.КоличествоПроходов = СтрокаОстаткаВЦелом.КоличествоПроходов+1;
			ЭтоПоследняяСтрокаПоНоменклатуре = ?(СтрокаОстаткаВЦелом.КоличествоПроходов = СтрокаОстаткаВЦелом.КоличествоСтрок, Истина, Ложь);
			
		Иначе
			СтрокаОстаткаВЦелом = Неопределено
		КонецЕсли;

		Если СтрокаОстаткаВЦелом = Неопределено Тогда Продолжить КонецЕсли;
		
		ОстатокСвободно = Окр(СтрокаОстаткаВЦелом.ОстатокТекСклад/КоэффициентЕдиницыИзмерения,3);
		ОстатокВЯчейке = Окр(СтрокаОстатка.ОстатокВЯчейке/КоэффициентЕдиницыИзмерения,3);
		
		Если Не ЭтоПоследняяСтрокаПоНоменклатуреПоЯчейке Тогда
			
			Если СтрокаТабличнойЧасти.ЯчейкаДоступна Тогда
				ОстатокВЯчейке = ?(СтрокаТабличнойЧасти.Количество < ОстатокВЯчейке, СтрокаТабличнойЧасти.Количество, ОстатокВЯчейке);
				СтрокаТабличнойЧасти.ОстатокВЯчейке = ?(СтрокаТабличнойЧасти.ЯчейкаДоступна, ОстатокВЯчейке, 0);
				СтрокаОстатка.ОстатокВЯчейке = СтрокаОстатка.ОстатокВЯчейке - (СтрокаТабличнойЧасти.ОстатокВЯчейке*КоэффициентЕдиницыИзмерения);
			Иначе
				СтрокаОстатка.ОстатокВЯчейке = 0;
				СтрокаТабличнойЧасти.ОстатокВЯчейке = 0;
			КонецЕсли;
		Иначе
			СтрокаТабличнойЧасти.ОстатокВЯчейке = ?(СтрокаТабличнойЧасти.ЯчейкаДоступна, ОстатокВЯчейке, 0);
		КонецЕсли;
		
		Если Не ЭтоПоследняяСтрокаПоНоменклатуре Тогда
			
			Если СтрокаТабличнойЧасти.ЯчейкаДоступна Тогда
				ОстатокСвободно = ?(СтрокаТабличнойЧасти.ОстатокВЯчейке < ОстатокСвободно, СтрокаТабличнойЧасти.ОстатокВЯчейке - СтрокаТабличнойЧасти.Резерв, ОстатокСвободно);
				СтрокаТабличнойЧасти.ОстатокСвободно = ?(СтрокаТабличнойЧасти.Количество < ОстатокСвободно, СтрокаТабличнойЧасти.Количество, ОстатокСвободно);
				СтрокаОстаткаВЦелом.ОстатокТекСклад = СтрокаОстаткаВЦелом.ОстатокТекСклад - (СтрокаТабличнойЧасти.ОстатокСвободно*КоэффициентЕдиницыИзмерения);
			Иначе
				ОстатокСвободно = ?(СтрокаТабличнойЧасти.Количество < ОстатокСвободно, СтрокаТабличнойЧасти.Количество - СтрокаТабличнойЧасти.Резерв, ОстатокСвободно);
				СтрокаТабличнойЧасти.ОстатокСвободно = ОстатокСвободно;
				СтрокаОстаткаВЦелом.ОстатокТекСклад = СтрокаОстаткаВЦелом.ОстатокТекСклад - (СтрокаТабличнойЧасти.ОстатокСвободно*КоэффициентЕдиницыИзмерения);
			КонецЕсли;
			
		Иначе
			СтрокаТабличнойЧасти.ОстатокСвободно = ОстатокСвободно;
		КонецЕсли;
		
		ИтогПоЗначениюВРезервВБазовыхЕдиницахПоВсемСкладам = ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбораБезСклада, "Резервировать");
		ИтогПоЗначениюВРезервПоВсемСкладам = Окр(ИтогПоЗначениюВРезервВБазовыхЕдиницахПоВсемСкладам/КоэффициентЕдиницыИзмерения,3);
		
		ИтогПоЗначениюВРезервВБазовыхЕдиницахТекСклад= ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбораСкладЗаказБезЯчейки, "Резервировать");
		ИтогПоЗначениюВРезервТекСклад = Окр(ИтогПоЗначениюВРезервВБазовыхЕдиницахТекСклад/КоэффициентЕдиницыИзмерения,3);
		
		Если ЗначениеЗаполнено(СтрокаТабличнойЧасти.Заказ) Тогда
			РезервНаСкладахСКоэффициетом = Окр(СтрокаОстатка.РезервНаСкладахИтог/КоэффициентЕдиницыИзмерения,3);
			РезервТекСкладСКоэффициетом = Окр(СтрокаОстатка.РезервТекСкладИтог/КоэффициентЕдиницыИзмерения,3);
		Иначе
			РезервНаСкладахСКоэффициетом = 0;
			РезервТекСкладСКоэффициетом = 0;
		КонецЕсли;
			
		СтрокаТабличнойЧасти.ВРезерве = РезервНаСкладахСКоэффициетом + СтрокаОстатка.СписаноРезерваНакладной - ИтогПоЗначениюВРезервПоВсемСкладам;
		СтрокаТабличнойЧасти.ВРезервеТекСклад = РезервТекСкладСКоэффициетом + СтрокаОстатка.СписаноРезерваНакладнойТекСклад - ИтогПоЗначениюВРезервТекСклад;
		
		ОстатокОбщийСКоэффициентом = Окр(СтрокаОстатка.ОстатокОбщий/КоэффициентЕдиницыИзмерения,3);
		
		СтрокаТабличнойЧасти.ОстатокОбщий = ОстатокОбщийСКоэффициентом;
		
		ИтогПоРезервам = СтрокаТабличнойЧасти.ВРезерве + ИтогПоЗначениюВРезервПоВсемСкладам;
		
		МожноОтгрузить = СтрокаТабличнойЧасти.ОстатокСвободно+ СтрокаТабличнойЧасти.Резерв;
		
		СтрокаТабличнойЧасти.МожноОтгрузить = ?(СтрокаТабличнойЧасти.Количество < МожноОтгрузить, СтрокаТабличнойЧасти.Количество, МожноОтгрузить);
		
		СтрокаТабличнойЧасти.НеХватает = СтрокаТабличнойЧасти.Количество - СтрокаТабличнойЧасти.МожноОтгрузить;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьКолонкуРезервПоОстаткамЗаказПокупателя(Объект, ПараметрыОтбора = Неопределено, СтруктураОтбораНоменклатуры = Неопределено) Экспорт
	
	Если ПараметрыОтбора = Неопределено Тогда
		ПараметрыОтбора = Новый Структура;
	КонецЕсли;
	
	Если ПараметрыОтбора.Свойство("НомерВариантаКП") Тогда
		НомерВариантаКП = ПараметрыОтбора.НомерВариантаКП;
	Иначе
		НомерВариантаКП = 0;
	КонецЕсли;
	
	ЗаполнитьСтруктурнуюЕдиницуРезерваВТЧ(Объект);
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаЗапасы.СтруктурнаяЕдиницаРезерв КАК СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия
	|ПОМЕСТИТЬ ВременнаяТаблицаЗапасы
	|ИЗ
	|	&ТаблицаЗапасы КАК ТаблицаЗапасы
	|ГДЕ
	|	ТаблицаЗапасы.ТипНоменклатурыЗапас";
	
	Запрос.УстановитьПараметр("ТаблицаЗапасы", Объект.Запасы.Выгрузить(ПараметрыОтбора));
	Запрос.Выполнить();
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапасыОстатки.Организация КАК Организация,
	|	ЗапасыОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ЗапасыОстатки.СчетУчета КАК СчетУчета,
	|	ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыОстатки.Партия КАК Партия,
	|	СУММА(ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0)) КАК КоличествоОстаток,
	|	ВЫБОР
	|		КОГДА ЗапасыОстатки.СтруктурнаяЕдиница = &ПриоритетныйСклад
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК Приоритет,
	|	СУММА(ЕСТЬNULL(ЗапасыОстатки.ВРезервеТекСклад, 0)) КАК ВРезервеТекСклад,
	|	СУММА(ЕСТЬNULL(ЗапасыОстатки.РезервТекДокумент, 0)) КАК РезервТекДокумент
	|ПОМЕСТИТЬ ВтИтог
	|ИЗ
	|	(ВЫБРАТЬ
	|		ЗапасыОстатки.Организация КАК Организация,
	|		ЗапасыОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|		ЗапасыОстатки.СчетУчета КАК СчетУчета,
	|		ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|		ЗапасыОстатки.Характеристика КАК Характеристика,
	|		ЗапасыОстатки.Партия КАК Партия,
	|		ЗапасыОстатки.КоличествоОстаток КАК КоличествоОстаток,
	|		0 КАК ВРезервеТекСклад,
	|		0 КАК РезервТекДокумент
	|	ИЗ
	|		РегистрНакопления.Запасы.Остатки(
	|				,
	|				(Организация, СчетУчета, Номенклатура, Характеристика, Партия, ЗаказПокупателя) В
	|					(ВЫБРАТЬ
	|						&Организация,
	|						ТаблицаЗапасы.Номенклатура.СчетУчетаЗапасов,
	|						ТаблицаЗапасы.Номенклатура,
	|						ТаблицаЗапасы.Характеристика,
	|						ТаблицаЗапасы.Партия,
	|						ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка) КАК ЗаказПокупателя
	|					ИЗ
	|						ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы)) КАК ЗапасыОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДвиженияДокументаЗапасы.Организация,
	|		ДвиженияДокументаЗапасы.СтруктурнаяЕдиница,
	|		ДвиженияДокументаЗапасы.СчетУчета,
	|		ДвиженияДокументаЗапасы.Номенклатура,
	|		ДвиженияДокументаЗапасы.Характеристика,
	|		ДвиженияДокументаЗапасы.Партия,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|		КОНЕЦ,
	|		0,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		РегистрНакопления.Запасы КАК ДвиженияДокументаЗапасы
	|	ГДЕ
	|		ВЫБОР
	|				КОГДА НЕ &Ссылка = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					ТОГДА ДвиженияДокументаЗапасы.Регистратор = &Ссылка
	|			КОНЕЦ
	|		И ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Запасы.Организация,
	|		Запасы.СтруктурнаяЕдиница,
	|		Запасы.СчетУчета,
	|		Запасы.Номенклатура,
	|		Запасы.Характеристика,
	|		Запасы.Партия,
	|		0,
	|		Запасы.Количество,
	|		0
	|	ИЗ
	|		РегистрНакопления.Запасы КАК Запасы
	|	ГДЕ
	|		Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И ВЫБОР
	|				КОГДА НЕ &Ссылка = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					ТОГДА Запасы.ЗаказПокупателя = &Ссылка
	|			КОНЕЦ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Запасы.Организация,
	|		Запасы.СтруктурнаяЕдиница,
	|		Запасы.СчетУчета,
	|		Запасы.Номенклатура,
	|		Запасы.Характеристика,
	|		Запасы.Партия,
	|		Запасы.Количество,
	|		0,
	|		0
	|	ИЗ
	|		РегистрНакопления.Запасы КАК Запасы
	|	ГДЕ
	|		Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И ВЫБОР
	|				КОГДА НЕ &Ссылка = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					ТОГДА Запасы.ЗаказПокупателя = &Ссылка
	|			КОНЕЦ) КАК ЗапасыОстатки
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(ЗапасыОстатки.СтруктурнаяЕдиница) = ТИП(Справочник.СтруктурныеЕдиницы)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстатки.Организация,
	|	ЗапасыОстатки.СтруктурнаяЕдиница,
	|	ЗапасыОстатки.СчетУчета,
	|	ЗапасыОстатки.Номенклатура,
	|	ЗапасыОстатки.Характеристика,
	|	ЗапасыОстатки.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтИтог.Организация КАК Организация,
	|	ВтИтог.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВтИтог.СчетУчета КАК СчетУчета,
	|	ВтИтог.Номенклатура КАК Номенклатура,
	|	ВтИтог.Характеристика КАК Характеристика,
	|	ВтИтог.Партия КАК Партия,
	|	ВтИтог.КоличествоОстаток + (ВтИтог.ВРезервеТекСклад - ВтИтог.РезервТекДокумент) КАК КоличествоОстаток,
	|	ВтИтог.Приоритет КАК Приоритет,
	|	ВтИтог.ВРезервеТекСклад КАК ВРезервеТекСклад,
	|	ВтИтог.РезервТекДокумент КАК РезервТекДокумент,
	|	ВтИтог.ВРезервеТекСклад - ВтИтог.РезервТекДокумент КАК РезервПоДругимДокументам
	|ИЗ
	|	ВтИтог КАК ВтИтог
	|
	|УПОРЯДОЧИТЬ ПО
	|	Приоритет";
	
	Запрос.УстановитьПараметр("Период", Объект.Дата);
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("Организация", УправлениеНебольшойФирмойСервер.ПолучитьОрганизацию(Объект.Организация));
	Запрос.УстановитьПараметр("ПриоритетныйСклад", Объект.СтруктурнаяЕдиницаРезерв);
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаОстатков = РезультатЗапроса.Выгрузить();
	
	СвернутаяТаблицаЗапасы = Объект.Запасы.Выгрузить(,"Номенклатура, Характеристика, Цена, Партия, ЕдиницаИзмерения, ДатаОтгрузки, Количество, Резерв, НомерВариантаКП");
	СвернутаяТаблицаЗапасы.Свернуть("Номенклатура, Характеристика, Цена, Партия, ЕдиницаИзмерения, ДатаОтгрузки, НомерВариантаКП", "Количество, Резерв");
	СвернутаяТаблицаЗапасы.Сортировать("Номенклатура Возр, ДатаОтгрузки Возр");
	
	Если Не СтруктураОтбораНоменклатуры = Неопределено Тогда
		СвернутаяТаблицаЗапасы = СвернутаяТаблицаЗапасы.НайтиСтроки(СтруктураОтбораНоменклатуры);
	Иначе
		СвернутаяТаблицаЗапасы = СвернутаяТаблицаЗапасы.НайтиСтроки(ПараметрыОтбора);
	КонецЕсли;
	
	СтруктураДляПоиска = Новый Структура;
	СтруктураДляПоиска.Вставить("Номенклатура",);
	СтруктураДляПоиска.Вставить("Характеристика",);
	СтруктураДляПоиска.Вставить("Партия",);
	СтруктураДляПоиска.Вставить("ДатаОтгрузки",);
	СтруктураДляПоиска.Вставить("Цена",);
	СтруктураДляПоиска.Вставить("ЕдиницаИзмерения",);
	
	СтруктураДляПоискаБезДатыОтгрузки = Новый Структура;
	СтруктураДляПоискаБезДатыОтгрузки.Вставить("Номенклатура",);
	СтруктураДляПоискаБезДатыОтгрузки.Вставить("Характеристика",);
	СтруктураДляПоискаБезДатыОтгрузки.Вставить("Партия",);
	
	СтруктураДляПоискаПоСкладу = Новый Структура;
	СтруктураДляПоискаПоСкладу.Вставить("Номенклатура",);
	СтруктураДляПоискаПоСкладу.Вставить("Характеристика",);
	СтруктураДляПоискаПоСкладу.Вставить("Партия",);
	СтруктураДляПоискаПоСкладу.Вставить("СтруктурнаяЕдиница",);
	
	Для Каждого СтрокаТабЗапасы из СвернутаяТаблицаЗапасы Цикл
		
		Если НЕ ТипЗнч(СтрокаТабЗапасы.Номенклатура) = Тип("СправочникСсылка.Номенклатура")
			Или Не ЗначениеЗаполнено(СтрокаТабЗапасы.Номенклатура) Тогда 
			Продолжить
		КонецЕсли;
		
		СтруктураДляПоиска.Номенклатура = СтрокаТабЗапасы.Номенклатура;
		СтруктураДляПоиска.Характеристика = СтрокаТабЗапасы.Характеристика;
		СтруктураДляПоиска.Партия = СтрокаТабЗапасы.Партия;
		СтруктураДляПоиска.ДатаОтгрузки = СтрокаТабЗапасы.ДатаОтгрузки;
		СтруктураДляПоиска.Цена = СтрокаТабЗапасы.Цена;
		СтруктураДляПоиска.ЕдиницаИзмерения = СтрокаТабЗапасы.ЕдиницаИзмерения;
		
		СтруктураДляПоискаБезДатыОтгрузки.Номенклатура = СтрокаТабЗапасы.Номенклатура;
		СтруктураДляПоискаБезДатыОтгрузки.Характеристика = СтрокаТабЗапасы.Характеристика;
		СтруктураДляПоискаБезДатыОтгрузки.Партия = СтрокаТабЗапасы.Партия;
		
		МассивСтрокОстаткиОбщие = ТаблицаОстатков.НайтиСтроки(СтруктураДляПоискаБезДатыОтгрузки);
		
		Если Не МассивСтрокОстаткиОбщие.Количество() 
			Или (МассивСтрокОстаткиОбщие.Количество() и МассивСтрокОстаткиОбщие[0].КоличествоОстаток<=0) Тогда Продолжить КонецЕсли;
		
		МассивСтрокЗапасы = Объект.Запасы.НайтиСтроки(СтруктураДляПоиска);
		
		КоличествоДляРаспределения = 0;
		Для Каждого СтрокаМассива из МассивСтрокЗапасы Цикл
			КоличествоДляРаспределения = КоличествоДляРаспределения + СтрокаМассива.Количество;
		КонецЦикла;
		
		СтрокиКУдалению = Новый Массив;
		ПерваяСтрока = Неопределено;
		ОстатокПослеРаспределенияСтроки = 0;
		МассивОбработанныхСтрок = Новый Массив;
		
		ТекстСообщения = НСтр("ru = 'В строке: %1% не заполнено количество.'");
		
		Для Каждого СтрокаЗапасы Из МассивСтрокЗапасы Цикл
			
			Если Не ЗначениеЗаполнено(СтрокаЗапасы.Количество) тогда
				
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(СтрокаЗапасы.НомерСтроки));
				
				УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(
				Объект,
				ТекстСообщения,
				"Запасы",
				СтрокаЗапасы.НомерСтроки,
				"Количество");
				
				Возврат;
			КонецЕсли;
			
		КонецЦикла;
		
		Для Каждого СтрокаЗапасы Из МассивСтрокЗапасы Цикл
			
			Если ЗначениеЗаполнено(СтрокаЗапасы.СтруктурнаяЕдиницаРезерв) Тогда
				СтруктурнаяЕдиницаДляПоиска = СтрокаЗапасы.СтруктурнаяЕдиницаРезерв;
			ИначеЕсли ЗначениеЗаполнено(Объект.СтруктурнаяЕдиницаРезерв) Тогда
				СтруктурнаяЕдиницаДляПоиска = Объект.СтруктурнаяЕдиницаРезерв;
			Иначе
				СтруктурнаяЕдиницаДляПоиска = СтрокаЗапасы.Номенклатура.Склад;
				СтрокаЗапасы.СтруктурнаяЕдиницаРезерв = СтруктурнаяЕдиницаДляПоиска;
			КонецЕсли;
			
			Если Не ЗначениеЗаполнено(СтрокаЗапасы.ЕдиницаИзмерения)
				Или ТипЗнч(СтрокаЗапасы.ЕдиницаИзмерения) = Тип("СправочникСсылка.КлассификаторЕдиницИзмерения")
				Тогда 
				КоэффициентЕдиницыИзмерения = 1;
			Иначе
				КоэффициентЕдиницыИзмерения = СтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СтруктурнаяЕдиницаДляПоиска) Тогда
				
				СтруктураДляПоискаПоСкладу.Номенклатура = СтрокаТабЗапасы.Номенклатура;
				СтруктураДляПоискаПоСкладу.Характеристика = СтрокаТабЗапасы.Характеристика;
				СтруктураДляПоискаПоСкладу.Партия = СтрокаТабЗапасы.Партия;
				СтруктураДляПоискаПоСкладу.СтруктурнаяЕдиница = СтруктурнаяЕдиницаДляПоиска;
				
				МассивСтрокОстатки = ТаблицаОстатков.НайтиСтроки(СтруктураДляПоискаПоСкладу);
				
				Если МассивСтрокОстатки.Количество() и МассивСтрокОстатки[0].КоличествоОстаток = 0 Тогда
					СтрокиКУдалению.Добавить(СтрокаЗапасы);
					Продолжить;
				КонецЕсли;
				
				Если Не МассивСтрокОстатки.Количество() Тогда
					
					Если МассивСтрокОстаткиОбщие.Количество() Тогда
						СтрокиКУдалению.Добавить(СтрокаЗапасы);
					КонецЕсли;
					
					Продолжить;
				КонецЕсли;
				
				СтрокаОстатка = МассивСтрокОстатки[0];
				
				КоличествоОстаток = СтрокаОстатка.КоличествоОстаток/КоэффициентЕдиницыИзмерения;
				
				Если СтрокаЗапасы.Количество < КоличествоОстаток Тогда
					
					Если ЗначениеЗаполнено(ОстатокПослеРаспределенияСтроки) Тогда
						
						Если СтрокаЗапасы.Количество + ОстатокПослеРаспределенияСтроки <= КоличествоОстаток Тогда
							
							СтрокаЗапасы.Количество = СтрокаЗапасы.Количество + ОстатокПослеРаспределенияСтроки;
							ОстатокПослеРаспределенияСтроки = 0;
						Иначе
							СтрокаЗапасы.Количество = КоличествоОстаток;
							ОстатокПослеРаспределенияСтроки = (СтрокаЗапасы.Количество + ОстатокПослеРаспределенияСтроки) - КоличествоОстаток;
						КонецЕсли;
						
					КонецЕсли;
					
				Иначе
					ОстатокПослеРаспределенияСтроки = СтрокаЗапасы.Количество - КоличествоОстаток;
					СтрокаЗапасы.Количество = КоличествоОстаток;
				КонецЕсли;
				
				РезервПоДругимДокументам = СтрокаОстатка.РезервПоДругимДокументам/КоэффициентЕдиницыИзмерения;
				
				Если СтрокаЗапасы.Количество > РезервПоДругимДокументам Тогда
					
					ОстатокСвободно = (СтрокаОстатка.КоличествоОстаток - СтрокаОстатка.ВрезервеТекСклад)/КоэффициентЕдиницыИзмерения;
					
					НеобходимыйРезерв = СтрокаЗапасы.Количество-РезервПоДругимДокументам;
					ДоступныйРезерв = ОстатокСвободно + СтрокаОстатка.ВРезервеТекСклад/КоэффициентЕдиницыИзмерения;
					
					СтрокаЗапасы.Резерв = ?(НеобходимыйРезерв> ДоступныйРезерв, ДоступныйРезерв, НеобходимыйРезерв);
					СтрокаОстатка.РезервПоДругимДокументам = 0;
				Иначе
					СтрокаЗапасы.Резерв = 0;
					СтрокаОстатка.РезервПоДругимДокументам = СтрокаОстатка.РезервПоДругимДокументам - СтрокаЗапасы.Количество*КоэффициентЕдиницыИзмерения;
				КонецЕсли;
				
				СтрокаЗапасы.СтруктурнаяЕдиницаРезерв = ?(Не ЗначениеЗаполнено(СтрокаЗапасы.СтруктурнаяЕдиницаРезерв), СтруктурнаяЕдиницаДляПоиска, СтрокаЗапасы.СтруктурнаяЕдиницаРезерв);
				
				СтрокаОстатка.КоличествоОстаток = СтрокаОстатка.КоличествоОстаток - СтрокаЗапасы.Количество*КоэффициентЕдиницыИзмерения;
				КоличествоДляРаспределения = КоличествоДляРаспределения - СтрокаЗапасы.Количество;
				
				ПерваяСтрока = ?(ПерваяСтрока = Неопределено, СтрокаЗапасы, ПерваяСтрока);
				
				СтрокаУдалена = НайденаСтрокаСТакимЖеСкладомОбработанаТекущаяИУдалена(СтрокиКУдалению,СтрокаЗапасы, МассивОбработанныхСтрок);
				
				Если Не СтрокаУдалена Тогда
					МассивОбработанныхСтрок.Добавить(СтрокаЗапасы);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
		Если КоличествоДляРаспределения > 0 и МассивСтрокОстаткиОбщие.Количество() Тогда
			
			Если ЗначениеЗаполнено(Объект.СтруктурнаяЕдиницаРезерв) Тогда
				СтруктурнаяЕдиницаДляПоиска = Объект.СтруктурнаяЕдиницаРезерв;
			Иначе
				СтруктурнаяЕдиницаДляПоиска = СтрокаЗапасы.Номенклатура.Склад;
				СтрокаЗапасы.СтруктурнаяЕдиницаРезерв = СтруктурнаяЕдиницаДляПоиска;
			КонецЕсли;
			
			ПодготовитьТаблицуСогласноПриоритетам(ТаблицаОстатков, СтруктурнаяЕдиницаДляПоиска);
			
			НоваяСтрока = Неопределено;
			
			Для каждого СтрокаМассиваСтрокОстатки Из МассивСтрокОстаткиОбщие Цикл
				
				ОстатокНаСкладе = СтрокаМассиваСтрокОстатки.КоличествоОстаток/КоэффициентЕдиницыИзмерения;
				
				Если ОстатокНаСкладе = 0 Тогда Продолжить КонецЕсли;
				
				НоваяСтрока = Объект.Запасы.Вставить(СтрокаЗапасы.НомерСтроки);
				
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаЗапасы);
				
				НоваяСтрока.СтруктурнаяЕдиницаРезерв = СтрокаМассиваСтрокОстатки.СтруктурнаяЕдиница;
				
				РезервПоДругимДокументам = СтрокаМассиваСтрокОстатки.РезервПоДругимДокументам/КоэффициентЕдиницыИзмерения;
				
				Если ОстатокНаСкладе > КоличествоДляРаспределения Тогда
					
					НоваяСтрока.Количество = КоличествоДляРаспределения;
					СтрокаМассиваСтрокОстатки.КоличествоОстаток = СтрокаМассиваСтрокОстатки.КоличествоОстаток - КоличествоДляРаспределения*КоэффициентЕдиницыИзмерения;
					КоличествоДляРаспределения = 0;
					
					Если НоваяСтрока.Количество > РезервПоДругимДокументам Тогда
						НоваяСтрока.Резерв = НоваяСтрока.Количество-РезервПоДругимДокументам;
						СтрокаМассиваСтрокОстатки.РезервПоДругимДокументам = 0;
					Иначе
						НоваяСтрока.Резерв = 0;
						СтрокаМассиваСтрокОстатки.РезервПоДругимДокументам = СтрокаМассиваСтрокОстатки.РезервПоДругимДокументам - СтрокаЗапасы.Количество*КоэффициентЕдиницыИзмерения;
					КонецЕсли;
					
					Прервать;
				Иначе
					
					НоваяСтрока.Количество = ОстатокНаСкладе;
					КоличествоДляРаспределения = КоличествоДляРаспределения - ОстатокНаСкладе;
					СтрокаМассиваСтрокОстатки.КоличествоОстаток = 0;
					
					Если НоваяСтрока.Количество > РезервПоДругимДокументам Тогда
						НоваяСтрока.Резерв = НоваяСтрока.Количество-РезервПоДругимДокументам;
						СтрокаМассиваСтрокОстатки.РезервПоДругимДокументам = 0;
					Иначе
						НоваяСтрока.Резерв = 0;
						СтрокаМассиваСтрокОстатки.РезервПоДругимДокументам = СтрокаМассиваСтрокОстатки.РезервПоДругимДокументам - СтрокаЗапасы.Количество*КоэффициентЕдиницыИзмерения;
					КонецЕсли;
					
				КонецЕсли;
				
				СтрокаУдалена = НайденаСтрокаСТакимЖеСкладомОбработанаТекущаяИУдалена(СтрокиКУдалению,НоваяСтрока, МассивОбработанныхСтрок);
				
				Если Не СтрокаУдалена Тогда
					МассивОбработанныхСтрок.Добавить(СтрокаЗапасы);
				КонецЕсли;
				
				Если КоличествоДляРаспределения = 0 Тогда Прервать КонецЕсли;
				
			КонецЦикла;
			
			ПоследнняяСтрокаМассива = ?(МассивОбработанныхСтрок.Количество(), МассивОбработанныхСтрок[МассивОбработанныхСтрок.Количество() - 1], Неопределено);
			
			ПоследняяСтрока = ?(НоваяСтрока = Неопределено, ПоследнняяСтрокаМассива, НоваяСтрока);
			
			Если КоличествоДляРаспределения > 0 и Не ПоследняяСтрока = Неопределено Тогда
				ПоследняяСтрока.Количество = ПоследняяСтрока.Количество + КоличествоДляРаспределения;
			КонецЕсли;
			
		КонецЕсли;
		
		ОчиститьПриоритеты(ТаблицаОстатков);
		
		Для Каждого СтрокаКУдалению из СтрокиКУдалению Цикл
			Объект.Запасы.Удалить(СтрокаКУдалению);
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьКолонкуРезервПоОстаткамЗаказПокупателяБезРазбиения(Объект, ПараметрыОтбора = Неопределено) Экспорт
	
	Если ПараметрыОтбора = Неопределено Тогда
		ПараметрыОтбора = Новый Структура;
	КонецЕсли;
	ПараметрыОтбора.Вставить("ЭтоРазделитель", Ложь);
	
	Строки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
	Для каждого Строка Из Строки Цикл
		Строка.Резерв = 0;
	КонецЦикла;
	
	СтрокиДляВыгрузки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
	ТаблицаЗапасы = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв");
	ТаблицаЗапасы.Свернуть("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв");
	
	Запрос = Новый Запрос;
	
	Запрос.Текст =
	
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия,
	|	ТаблицаЗапасы.СтруктурнаяЕдиницаРезерв КАК СтруктурнаяЕдиницаРезерв
	|ПОМЕСТИТЬ ВТНоменклатура
	|ИЗ
	|	&ТаблицаЗапасы КАК ТаблицаЗапасы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВТНоменклатура.Номенклатура КАК Номенклатура,
	|	ВТНоменклатура.Характеристика КАК Характеристика,
	|	ВТНоменклатура.Партия КАК Партия,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв КАК СтруктурнаяЕдиницаРезерв,
	|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК КоличествоОстаток
	|ПОМЕСТИТЬ ОстаткиНаСкладе
	|ИЗ
	|	ВТНоменклатура КАК ВТНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				Организация = &Организация
	|					И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)) КАК ЗапасыОстатки
	|		ПО ВТНоменклатура.Номенклатура = ЗапасыОстатки.Номенклатура
	|			И ВТНоменклатура.Характеристика = ЗапасыОстатки.Характеристика
	|			И ВТНоменклатура.Партия = ЗапасыОстатки.Партия
	|			И ВТНоменклатура.СтруктурнаяЕдиницаРезерв = ЗапасыОстатки.СтруктурнаяЕдиница
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТНоменклатура.Номенклатура,
	|	ВТНоменклатура.Партия,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв,
	|	ВТНоменклатура.Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВТНоменклатура.Номенклатура КАК Номенклатура,
	|	ВТНоменклатура.Характеристика КАК Характеристика,
	|	ВТНоменклатура.Партия КАК Партия,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв КАК СтруктурнаяЕдиницаРезерв,
	|	СУММА(ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|		КОНЕЦ) КАК КоличествоДвижение
	|ПОМЕСТИТЬ ДвижениеДокумента
	|ИЗ
	|	ВТНоменклатура КАК ВТНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК ДвиженияДокументаЗапасы
	|		ПО ВТНоменклатура.Номенклатура = ДвиженияДокументаЗапасы.Номенклатура
	|			И ВТНоменклатура.Характеристика = ДвиженияДокументаЗапасы.Характеристика
	|			И ВТНоменклатура.Партия = ДвиженияДокументаЗапасы.Партия
	|			И ВТНоменклатура.СтруктурнаяЕдиницаРезерв = ДвиженияДокументаЗапасы.СтруктурнаяЕдиница
	|ГДЕ
	|	ВЫБОР
	|			КОГДА НЕ &Ссылка = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|				ТОГДА ДвиженияДокументаЗапасы.Регистратор = &Ссылка
	|		КОНЕЦ
	|	И ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТНоменклатура.Партия,
	|	ВТНоменклатура.Характеристика,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв,
	|	ВТНоменклатура.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВТНоменклатура.Номенклатура КАК Номенклатура,
	|	ВТНоменклатура.Характеристика КАК Характеристика,
	|	ВТНоменклатура.Партия КАК Партия,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв КАК СтруктурнаяЕдиницаРезерв,
	|	СУММА(ДвиженияДокументаЗапасы.Количество) КАК КоличествоДвижение
	|ПОМЕСТИТЬ ДвижениеРезервовДругимиДокументами
	|ИЗ
	|	ВТНоменклатура КАК ВТНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК ДвиженияДокументаЗапасы
	|		ПО ВТНоменклатура.Номенклатура = ДвиженияДокументаЗапасы.Номенклатура
	|			И ВТНоменклатура.Характеристика = ДвиженияДокументаЗапасы.Характеристика
	|			И ВТНоменклатура.Партия = ДвиженияДокументаЗапасы.Партия
	|			И ВТНоменклатура.СтруктурнаяЕдиницаРезерв = ДвиженияДокументаЗапасы.СтруктурнаяЕдиница
	|ГДЕ
	|	ВЫБОР
	|			КОГДА НЕ &Ссылка = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|				ТОГДА ДвиженияДокументаЗапасы.ЗаказПокупателя = &Ссылка
	|		КОНЕЦ
	|	И ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ВЫБОР
	|			КОГДА НЕ &Ссылка = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|				ТОГДА НЕ ДвиженияДокументаЗапасы.Регистратор = &Ссылка
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТНоменклатура.Партия,
	|	ВТНоменклатура.Характеристика,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв,
	|	ВТНоменклатура.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТНоменклатура.Номенклатура КАК Номенклатура,
	|	ВТНоменклатура.Характеристика КАК Характеристика,
	|	ВТНоменклатура.Партия КАК Партия,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв КАК СтруктурнаяЕдиницаРезерв,
	|	СУММА(ЕСТЬNULL(ДвижениеДокумента.КоличествоДвижение, 0) + ЕСТЬNULL(ОстаткиНаСкладе.КоличествоОстаток, 0)) КАК КоличествоОстаток,
	|	ЕСТЬNULL(ДвижениеРезервовДругимиДокументами.КоличествоДвижение, 0) КАК РезервДругимиДокументами
	|ИЗ
	|	ВТНоменклатура КАК ВТНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиНаСкладе КАК ОстаткиНаСкладе
	|		ПО ВТНоменклатура.Номенклатура = ОстаткиНаСкладе.Номенклатура
	|			И ВТНоменклатура.Характеристика = ОстаткиНаСкладе.Характеристика
	|			И ВТНоменклатура.Партия = ОстаткиНаСкладе.Партия
	|			И ВТНоменклатура.СтруктурнаяЕдиницаРезерв = ОстаткиНаСкладе.СтруктурнаяЕдиницаРезерв
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвижениеДокумента КАК ДвижениеДокумента
	|		ПО ВТНоменклатура.Номенклатура = ДвижениеДокумента.Номенклатура
	|			И ВТНоменклатура.Характеристика = ДвижениеДокумента.Характеристика
	|			И ВТНоменклатура.Партия = ДвижениеДокумента.Партия
	|			И ВТНоменклатура.СтруктурнаяЕдиницаРезерв = ДвижениеДокумента.СтруктурнаяЕдиницаРезерв
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвижениеРезервовДругимиДокументами КАК ДвижениеРезервовДругимиДокументами
	|		ПО ВТНоменклатура.Номенклатура = ДвижениеРезервовДругимиДокументами.Номенклатура
	|			И ВТНоменклатура.Характеристика = ДвижениеРезервовДругимиДокументами.Характеристика
	|			И ВТНоменклатура.Партия = ДвижениеРезервовДругимиДокументами.Партия
	|			И ВТНоменклатура.СтруктурнаяЕдиницаРезерв = ДвижениеРезервовДругимиДокументами.СтруктурнаяЕдиницаРезерв
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТНоменклатура.Характеристика,
	|	ВТНоменклатура.СтруктурнаяЕдиницаРезерв,
	|	ВТНоменклатура.Номенклатура,
	|	ВТНоменклатура.Партия,
	|	ЕСТЬNULL(ДвижениеРезервовДругимиДокументами.КоличествоДвижение, 0)";
	
	Запрос.УстановитьПараметр("ТаблицаЗапасы", ТаблицаЗапасы);
	Запрос.УстановитьПараметр("СкладВТабличнойЧасти", Объект.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", Объект.СтруктурнаяЕдиницаРезерв);
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("Организация", УправлениеНебольшойФирмойСервер.ПолучитьОрганизацию(Объект.Организация));
	
	ТаблицаПериодов = Новый ТаблицаЗначений();
	ТаблицаПериодов.Колонки.Добавить("ДатаОтгрузки");
	ТаблицаПериодов.Колонки.Добавить("СтрокаЗапасы");
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		РезервДругимиДокументамиБазовыеЕдиницы = Выборка.РезервДругимиДокументами;
		
		СтруктураДляПоиска = Новый Структура;
		СтруктураДляПоиска.Вставить("Номенклатура", Выборка.Номенклатура);
		СтруктураДляПоиска.Вставить("Характеристика", Выборка.Характеристика);
		СтруктураДляПоиска.Вставить("Партия", Выборка.Партия);
		СтруктураДляПоиска.Вставить("СтруктурнаяЕдиницаРезерв", Выборка.СтруктурнаяЕдиницаРезерв);
		
		Для каждого КлючИЗначение Из ПараметрыОтбора Цикл
			Если СтруктураДляПоиска.Свойство(КлючИЗначение.Ключ) Тогда
				Продолжить;
			КонецЕсли;
			СтруктураДляПоиска.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение);
		КонецЦикла;
		
		МассивСтрокЗапасы = Объект.Запасы.НайтиСтроки(СтруктураДляПоиска);
		Для каждого СтрокаЗапасы Из МассивСтрокЗапасы Цикл
			НоваяСтрока = ТаблицаПериодов.Добавить();
			НоваяСтрока.ДатаОтгрузки = СтрокаЗапасы.ДатаОтгрузки;
			НоваяСтрока.СтрокаЗапасы = СтрокаЗапасы;
		КонецЦикла;
		
		ВсегоОстаток = Выборка.КоличествоОстаток;
		ТаблицаПериодов.Сортировать("ДатаОтгрузки");
		Для каждого СтрокаТаблицыПериодов Из ТаблицаПериодов Цикл
			СтрокаЗапасы = СтрокаТаблицыПериодов.СтрокаЗапасы;
			
			Если Не ЗначениеЗаполнено(СтрокаЗапасы.ЕдиницаИзмерения)
				Или ТипЗнч(СтрокаЗапасы.ЕдиницаИзмерения) = Тип("СправочникСсылка.КлассификаторЕдиницИзмерения")
				Тогда 
				КоэффициентЕдиницыИзмерения = 1;
			Иначе
				КоэффициентЕдиницыИзмерения = СтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
			КонецЕсли;
			
			ВсегоОстаток = ?(ТипЗнч(СтрокаЗапасы.ЕдиницаИзмерения) = ТИП("СправочникСсылка.КлассификаторЕдиницИзмерения"), ВсегоОстаток, ВсегоОстаток / КоэффициентЕдиницыИзмерения);
			Количество = СтрокаЗапасы.Количество;
			
			Если РезервДругимиДокументамиБазовыеЕдиницы > 0 Тогда
				
				РезервДругимиДокументами = РезервДругимиДокументамиБазовыеЕдиницы/КоэффициентЕдиницыИзмерения;
				
				Если РезервДругимиДокументами>=Количество Тогда
					РезервДругимиДокументамиБазовыеЕдиницы =РезервДругимиДокументамиБазовыеЕдиницы - Количество*КоэффициентЕдиницыИзмерения;
					Продолжить
				Иначе
					Количество = Количество - РезервДругимиДокументами;
				КонецЕсли;
				
			КонецЕсли;
			
			Если Количество >= ВсегоОстаток Тогда
				СтрокаЗапасы.Резерв = ВсегоОстаток;
				ВсегоОстаток = 0;
			Иначе
				СтрокаЗапасы.Резерв = Количество;
				ВсегоОстаток = ВсегоОстаток - Количество;
				ВсегоОстаток = ?(ТипЗнч(СтрокаЗапасы.ЕдиницаИзмерения) = ТИП("СправочникСсылка.КлассификаторЕдиницИзмерения"), ВсегоОстаток, ВсегоОстаток * КоэффициентЕдиницыИзмерения);
			КонецЕсли;
		КонецЦикла;
		
		ТаблицаПериодов.Очистить();
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьКоличествоПоОстаткамИРезервамРасходнаяНакладная(Объект, ПараметрыОтбора = Неопределено, СтруктураОтбораНоменклатуры = Неопределено) Экспорт
	
	Если ПараметрыОтбора = Неопределено Тогда
		ПараметрыОтбора = Новый Структура;
	КонецЕсли;
	
	Строки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
	Для каждого Строка Из Объект.Запасы Цикл
		Строка.Резерв = 0;
	КонецЦикла;
	
	ТекстСообщения = НСтр("ru = 'В строке: %1% не заполнено количество.'");
		
	Для Каждого СтрокаЗапасы Из Объект.Запасы Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаЗапасы.Количество) тогда
			
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(СтрокаЗапасы.НомерСтроки));
			
			УправлениеНебольшойФирмойСервер.СообщитьОбОшибке(
			Объект,
			ТекстСообщения,
			"Запасы",
			СтрокаЗапасы.НомерСтроки,
			"Количество");
			
			Возврат;
		КонецЕсли;
		
	КонецЦикла;
	
	СтрокиДляВыгрузки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
	ТаблицаЗапасы = Объект.Запасы.Выгрузить(СтрокиДляВыгрузки,"Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, Заказ, ТипНоменклатурыЗапас");
	ТаблицаЗапасы.Свернуть("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница, Заказ, ТипНоменклатурыЗапас");
	
	МассивНоменклатуры = ТаблицаЗапасы.ВыгрузитьКолонку("Номенклатура");
	
	Запрос = Новый Запрос;
	
	Запрос.Текст = ТекстЗапросаЗаполнитьКоличествоПоОстаткамИРезервамРасходнаяНакладная();
		
	Организация = УправлениеНебольшойФирмойСервер.ПолучитьОрганизацию(Объект.Организация);
	
	Запрос.УстановитьПараметр("ТаблицаЗапасы", ТаблицаЗапасы);
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ПриоритетныйСклад", Объект.СтруктурнаяЕдиница);
	Запрос.УстановитьПараметр("ЗаказВШапке", Объект.ПоложениеЗаказаПокупателя = Перечисления.ПоложениеРеквизитаНаФорме.ВШапке);
	Запрос.УстановитьПараметр("Заказ", ?(ЗначениеЗаполнено(Объект.Заказ), Объект.Заказ, Документы.ЗаказПокупателя.ПустаяСсылка()));
	Запрос.УстановитьПараметр("СкладВТабличнойЧасти", Объект.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти);
	Запрос.УстановитьПараметр("МассивНоменклатуры", МассивНоменклатуры);
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаОстатков = РезультатЗапроса.Выгрузить();
	
	УчетПоЯчейкам = ПолучитьФункциональнуюОпцию("УчетПоЯчейкам");
	
	Если УчетПоЯчейкам Тогда
		СтруктураПараметров = Новый Структура("Номенклатура, Организация, Регистратор", МассивНоменклатуры, Организация, Объект.Ссылка);
		ОстаткиПоЯчейкам = ОстаткиПоЯчейкам(СтруктураПараметров, ТаблицаЗапасы);
	КонецЕсли;
	
	СвернутаяТаблицаЗапасы = Объект.Запасы.Выгрузить(,"Номенклатура, Характеристика, Цена, Партия, ЕдиницаИзмерения, Количество, Резерв, Заказ");
	СвернутаяТаблицаЗапасы.Свернуть("Номенклатура, Характеристика, Цена, ЕдиницаИзмерения, Партия, Заказ", "Количество, Резерв");
	
	СтруктураДляПоиска = Новый Структура;
	СтруктураДляПоиска.Вставить("Номенклатура",);
	СтруктураДляПоиска.Вставить("Характеристика",);
	СтруктураДляПоиска.Вставить("Партия",);
	СтруктураДляПоиска.Вставить("Цена",);
	СтруктураДляПоиска.Вставить("ЕдиницаИзмерения",);
	СтруктураДляПоиска.Вставить("Заказ",);
	
	СтруктураДляПоискаБезДатыОтгрузки = Новый Структура;
	СтруктураДляПоискаБезДатыОтгрузки.Вставить("Номенклатура",);
	СтруктураДляПоискаБезДатыОтгрузки.Вставить("Характеристика",);
	СтруктураДляПоискаБезДатыОтгрузки.Вставить("Партия",);
	СтруктураДляПоискаБезДатыОтгрузки.Вставить("Заказ",);
	
	СтруктураДляПоискаПоСкладу = Новый Структура;
	СтруктураДляПоискаПоСкладу.Вставить("Номенклатура",);
	СтруктураДляПоискаПоСкладу.Вставить("Характеристика",);
	СтруктураДляПоискаПоСкладу.Вставить("Партия",);
	СтруктураДляПоискаПоСкладу.Вставить("СтруктурнаяЕдиница",);
	СтруктураДляПоискаПоСкладу.Вставить("Заказ",);
	
	СтруктураДляПоискаПоСкладуБезЗаказа = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница");
	
	Если УчетПоЯчейкам Тогда
		СтруктураДляПоискаПоЯчейкам = Новый Структура;
		СтруктураДляПоискаПоЯчейкам.Вставить("Номенклатура",);
		СтруктураДляПоискаПоЯчейкам.Вставить("Характеристика",);
		СтруктураДляПоискаПоЯчейкам.Вставить("Партия",);
		СтруктураДляПоискаПоЯчейкам.Вставить("СтруктурнаяЕдиница",);
		СтруктураДляПоискаПоЯчейкам.Вставить("Ячейка",);
	КонецЕсли;
	
	Для Каждого СтрокаТабЗапасы из СвернутаяТаблицаЗапасы Цикл
		
		Если НЕ ТипЗнч(СтрокаТабЗапасы.Номенклатура) = Тип("СправочникСсылка.Номенклатура")
			Или Не ЗначениеЗаполнено(СтрокаТабЗапасы.Номенклатура) Тогда 
			Продолжить
		КонецЕсли;
		
		СтруктураДляПоиска.Номенклатура = СтрокаТабЗапасы.Номенклатура;
		СтруктураДляПоиска.Характеристика = СтрокаТабЗапасы.Характеристика;
		СтруктураДляПоиска.Партия = СтрокаТабЗапасы.Партия;
		СтруктураДляПоиска.Цена = СтрокаТабЗапасы.Цена;
		СтруктураДляПоиска.ЕдиницаИзмерения = СтрокаТабЗапасы.ЕдиницаИзмерения;
		
		Если ЗначениеЗаполнено(СтрокаТабЗапасы.Заказ) Тогда
			СтруктураДляПоиска.Заказ = СтрокаТабЗапасы.Заказ;
		ИначеЕсли ЗначениеЗаполнено(Объект.Заказ) Тогда
			СтруктураДляПоиска.Заказ = Объект.Заказ;
		Иначе
			СтруктураДляПоиска.Заказ = Неопределено;
		КонецЕсли;
		
		СтруктураДляПоискаБезДатыОтгрузки.Номенклатура = СтрокаТабЗапасы.Номенклатура;
		СтруктураДляПоискаБезДатыОтгрузки.Характеристика = СтрокаТабЗапасы.Характеристика;
		СтруктураДляПоискаБезДатыОтгрузки.Партия = СтрокаТабЗапасы.Партия;
		СтруктураДляПоискаБезДатыОтгрузки.Заказ = ?(СтрокаТабЗапасы.Заказ = Неопределено, Документы.ЗаказПокупателя.ПустаяСсылка(), СтрокаТабЗапасы.Заказ);
		
		МассивСтрокОстаткиОбщие = ТаблицаОстатков.НайтиСтроки(СтруктураДляПоискаБезДатыОтгрузки);
		
		МассивСтрокЗапасы = Объект.Запасы.НайтиСтроки(СтруктураДляПоиска);
		
		КоличествоДляРаспределения = 0;
		Для Каждого СтрокаМассива из МассивСтрокЗапасы Цикл
			КоличествоДляРаспределения = КоличествоДляРаспределения + СтрокаМассива.Количество;
		КонецЦикла;
		
		СтрокиКУдалению = Новый Массив;
		ОстатокПослеРаспределенияСтроки = 0;
		МассивОбработанныхСтрок = Новый Массив;
		
		Для Каждого СтрокаЗапасы Из МассивСтрокЗапасы Цикл
			
			СтрокаУдалена = НайденИУдаленДубльТекущейСтроки(СтрокиКУдалению,СтрокаЗапасы, МассивОбработанныхСтрок);
			
			Если СтрокаУдалена Тогда Продолжить КонецЕсли;
			
			Если ЗначениеЗаполнено(СтрокаЗапасы.СтруктурнаяЕдиница) Тогда
				СтруктурнаяЕдиницаДляПоиска = СтрокаЗапасы.СтруктурнаяЕдиница;
			ИначеЕсли ЗначениеЗаполнено(Объект.СтруктурнаяЕдиница) Тогда
				СтруктурнаяЕдиницаДляПоиска = Объект.СтруктурнаяЕдиница;
			Иначе
				СтруктурнаяЕдиницаДляПоиска = СтрокаЗапасы.Номенклатура.Склад;
				СтрокаЗапасы.СтруктурнаяЕдиница = СтруктурнаяЕдиницаДляПоиска;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СтрокаЗапасы.Заказ) Тогда
				СтруктураДляПоискаПоСкладу.Заказ = СтрокаЗапасы.Заказ;
			Иначе
				СтруктураДляПоискаПоСкладу.Заказ = Документы.ЗаказПокупателя.ПустаяСсылка();
			КонецЕсли;
			
			Если Не ЗначениеЗаполнено(СтрокаЗапасы.ЕдиницаИзмерения)
				Или ТипЗнч(СтрокаЗапасы.ЕдиницаИзмерения) = Тип("СправочникСсылка.КлассификаторЕдиницИзмерения")
				Тогда 
				КоэффициентЕдиницыИзмерения = 1;
			Иначе
				КоэффициентЕдиницыИзмерения = СтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СтруктурнаяЕдиницаДляПоиска) Тогда
				
				СтруктураДляПоискаПоСкладу.Номенклатура = СтрокаТабЗапасы.Номенклатура;
				СтруктураДляПоискаПоСкладу.Характеристика = СтрокаТабЗапасы.Характеристика;
				СтруктураДляПоискаПоСкладу.Партия = СтрокаТабЗапасы.Партия;
				СтруктураДляПоискаПоСкладу.СтруктурнаяЕдиница = СтруктурнаяЕдиницаДляПоиска;
				
				МассивСтрокОстатки = ТаблицаОстатков.НайтиСтроки(СтруктураДляПоискаПоСкладу);
				
				Если МассивСтрокОстатки.Количество() и МассивСтрокОстатки[0].КоличествоОстаток = 0 Тогда
					СтрокиКУдалению.Добавить(СтрокаЗапасы);
					Продолжить;
				КонецЕсли;
				
				Если Не МассивСтрокОстатки.Количество() Тогда
					Если МассивСтрокОстаткиОбщие.Количество() Тогда
						СтрокиКУдалению.Добавить(СтрокаЗапасы);
					КонецЕсли;
					Продолжить;
				КонецЕсли;
				
				СтрокаОстатка = МассивСтрокОстатки[0];
				
				Если УчетПоЯчейкам Тогда
					
					СтруктураДляПоискаПоЯчейкам.Номенклатура = СтрокаТабЗапасы.Номенклатура;
					СтруктураДляПоискаПоЯчейкам.Характеристика = СтрокаТабЗапасы.Характеристика;
					СтруктураДляПоискаПоЯчейкам.Партия = СтрокаТабЗапасы.Партия;
					СтруктураДляПоискаПоЯчейкам.СтруктурнаяЕдиница = СтруктурнаяЕдиницаДляПоиска;
					СтруктураДляПоискаПоЯчейкам.Ячейка = СтрокаЗапасы.Ячейка;
					
					МассивСтрокОстатки = ОстаткиПоЯчейкам.НайтиСтроки(СтруктураДляПоискаПоЯчейкам);
					
					Если МассивСтрокОстатки.Количество() Тогда
						СтрокаПоЯчейке = МассивСтрокОстатки[0];
						КоличествоОстаток = СтрокаПоЯчейке.ОстатокСУчетомДвижения/КоэффициентЕдиницыИзмерения;
					Иначе
						КоличествоОстаток = 0;
					КонецЕсли
					
				Иначе
					КоличествоОстаток = СтрокаОстатка.КоличествоОстаток/КоэффициентЕдиницыИзмерения;
				КонецЕсли;
				
				Если КоличествоДляРаспределения <= КоличествоОстаток Тогда
					СтрокаЗапасы.Количество = КоличествоДляРаспределения;
				Иначе
					СтрокаЗапасы.Количество = КоличествоОстаток;
				КонецЕсли;
				
				Если УчетПоЯчейкам и МассивСтрокОстатки.Количество() Тогда
					СтрокаПоЯчейке.ОстатокСУчетомДвижения = СтрокаПоЯчейке.ОстатокСУчетомДвижения - СтрокаЗапасы.Количество*КоэффициентЕдиницыИзмерения;
				КонецЕсли;
				
				ВсегоРезерва = СтрокаОстатка.ВсегоРезерва/КоэффициентЕдиницыИзмерения;
				
				Если СтрокаЗапасы.Количество > ВсегоРезерва Тогда 
					СтрокаЗапасы.Резерв = ВсегоРезерва;
					СтрокаОстатка.ВсегоРезерва = 0;
				Иначе
					СтрокаЗапасы.Резерв = СтрокаЗапасы.Количество;
					СтрокаОстатка.ВсегоРезерва = СтрокаОстатка.ВсегоРезерва - СтрокаЗапасы.Резерв*КоэффициентЕдиницыИзмерения;
				КонецЕсли;
				
				СтрокаОстатка.КоличествоОстаток = СтрокаОстатка.КоличествоОстаток - СтрокаЗапасы.Количество*КоэффициентЕдиницыИзмерения;
				
				КоличествоДляРаспределения = КоличествоДляРаспределения - СтрокаЗапасы.Количество;
				
				Если СтрокаЗапасы.Количество = 0 Тогда
					СтрокиКУдалению.Добавить(СтрокаЗапасы);
				Иначе
					МассивОбработанныхСтрок.Добавить(СтрокаЗапасы);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
		Если КоличествоДляРаспределения > 0 и МассивСтрокОстаткиОбщие.Количество() Тогда
			
			Если Не ЗначениеЗаполнено(СтруктурнаяЕдиницаДляПоиска) Тогда
				
				Если ЗначениеЗаполнено(Объект.СтруктурнаяЕдиница) Тогда
					СтруктурнаяЕдиницаДляПоиска = Объект.СтруктурнаяЕдиница;
				Иначе
					СтруктурнаяЕдиницаДляПоиска = СтрокаЗапасы.Номенклатура.Склад;
					СтрокаЗапасы.СтруктурнаяЕдиница = СтруктурнаяЕдиницаДляПоиска;
				КонецЕсли;
				
			КонецЕсли;
			
			ПодготовитьТаблицуСогласноПриоритетам(ТаблицаОстатков, СтруктурнаяЕдиницаДляПоиска);
			
			НоваяСтрока = Неопределено;
			
			МассивСтрокОбходаСкладов = Новый Массив;
			
			Для каждого СтрокаМассиваСтрокОстатки Из МассивСтрокОстаткиОбщие Цикл
				
				ОстатокНаСкладе = СтрокаМассиваСтрокОстатки.КоличествоОстаток;
				
				Если ОстатокНаСкладе = 0 Тогда Продолжить КонецЕсли;
				Если КоличествоДляРаспределения = 0 Тогда Прервать КонецЕсли;
				
				Ячейка = Неопределено;
				
				МассивСтрокОбходаСкладов.Очистить();
				
				Если УчетПоЯчейкам Тогда
					СтруктураДляПоискаПоСкладуБезЗаказа.Номенклатура = СтрокаМассиваСтрокОстатки.Номенклатура;
					СтруктураДляПоискаПоСкладуБезЗаказа.Характеристика = СтрокаМассиваСтрокОстатки.Характеристика;
					СтруктураДляПоискаПоСкладуБезЗаказа.Партия = СтрокаМассиваСтрокОстатки.Партия;
					СтруктураДляПоискаПоСкладуБезЗаказа.СтруктурнаяЕдиница = СтрокаМассиваСтрокОстатки.СтруктурнаяЕдиница;
					
					СтрокиОбходаСкладов = ОстаткиПоЯчейкам.НайтиСтроки(СтруктураДляПоискаПоСкладуБезЗаказа);
					
					Если Не СтрокиОбходаСкладов.Количество() Тогда
						МассивСтрокОбходаСкладов.Добавить(СтрокаМассиваСтрокОстатки);
					Иначе
						Для Каждого НайденнаяСтрока из СтрокиОбходаСкладов Цикл
							МассивСтрокОбходаСкладов.Добавить(НайденнаяСтрока);
						КонецЦикла;
					КонецЕсли;
					
				Иначе
					МассивСтрокОбходаСкладов.Добавить(СтрокаМассиваСтрокОстатки);
				КонецЕсли;
				
				НомерСтроки = СтрокаЗапасы.НомерСтроки;
				
				Для Каждого СтрокаОбхода из МассивСтрокОбходаСкладов Цикл
					
					НоваяСтрока = Объект.Запасы.Вставить(НомерСтроки);
					НомерСтроки = НомерСтроки + 1;
					
					ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаЗапасы);
					
					НоваяСтрока.Количество = 0;
					НоваяСтрока.Резерв = 0;
					НоваяСтрока.Ячейка = Неопределено;
					
					Если УчетПоЯчейкам Тогда 
						НоваяСтрока.Ячейка = СтрокаОбхода.Ячейка;
						ОстатокНаСкладе = СтрокаОбхода.ОстатокСУчетомДвижения/КоэффициентЕдиницыИзмерения;
					Иначе
						ОстатокНаСкладе = СтрокаОбхода.КоличествоОстаток/КоэффициентЕдиницыИзмерения;
					Конецесли;
					
					НоваяСтрока.СтруктурнаяЕдиница = СтрокаМассиваСтрокОстатки.СтруктурнаяЕдиница;
					
					ВсегоРезерва = СтрокаМассиваСтрокОстатки.ВсегоРезерва/КоэффициентЕдиницыИзмерения;
					
					Если ОстатокНаСкладе > КоличествоДляРаспределения Тогда
						
						НоваяСтрока.Количество = КоличествоДляРаспределения;
						
						Если СтрокаМассиваСтрокОстатки.ВсегоРезерва > 0 Тогда
							ЗначениеРезерва = ?(ВсегоРезерва > НоваяСтрока.Количество, НоваяСтрока.Количество, ВсегоРезерва);
						КонецЕсли;
						
						НоваяСтрока.Резерв = ЗначениеРезерва;
						
						СтрокаМассиваСтрокОстатки.КоличествоОстаток = СтрокаМассиваСтрокОстатки.КоличествоОстаток - КоличествоДляРаспределения*КоэффициентЕдиницыИзмерения;
						КоличествоДляРаспределения = 0;
						СтрокаМассиваСтрокОстатки.ВсегоРезерва = СтрокаМассиваСтрокОстатки.ВсегоРезерва - НоваяСтрока.Резерв*КоэффициентЕдиницыИзмерения;
						
						Если УчетПоЯчейкам Тогда СтрокаОбхода.ОстатокСУчетомДвижения = СтрокаОбхода.ОстатокСУчетомДвижения - КоличествоДляРаспределения*КоэффициентЕдиницыИзмерения КонецЕсли;
						
						Прервать;
					Иначе
						
						ЗначениеРезерва = 0;
						
						НоваяСтрока.Количество = ОстатокНаСкладе;
						
						Если ВсегоРезерва > 0 Тогда
							ЗначениеРезерва = ?(ВсегоРезерва > НоваяСтрока.Количество, НоваяСтрока.Количество, ВсегоРезерва);
						КонецЕсли;
						СтрокаМассиваСтрокОстатки.ВсегоРезерва = СтрокаМассиваСтрокОстатки.ВсегоРезерва - ЗначениеРезерва;
						
						НоваяСтрока.Резерв = ЗначениеРезерва;
						КоличествоДляРаспределения = КоличествоДляРаспределения - ОстатокНаСкладе;
						СтрокаМассиваСтрокОстатки.КоличествоОстаток = 0;
						Если УчетПоЯчейкам Тогда СтрокаОбхода.ОстатокСУчетомДвижения = 0 КонецЕсли;
						
					КонецЕсли;
					
					СтрокаУдалена = НайденИУдаленДубльТекущейСтроки(СтрокиКУдалению,НоваяСтрока, МассивОбработанныхСтрок, Истина);
					
					Если Не СтрокаУдалена Тогда
						МассивОбработанныхСтрок.Добавить(НоваяСтрока);
					КонецЕсли;
					
				КонецЦикла;
				
			КонецЦикла;
			
			ПоследнняяСтрокаМассива = ?(МассивОбработанныхСтрок.Количество(), МассивОбработанныхСтрок[МассивОбработанныхСтрок.Количество() - 1], Неопределено);
			
			ПоследняяСтрока = ?(НоваяСтрока = Неопределено, ПоследнняяСтрокаМассива, НоваяСтрока);
			
			Если КоличествоДляРаспределения > 0 и Не ПоследняяСтрока = Неопределено Тогда
				ПоследняяСтрока.Количество = ПоследняяСтрока.Количество + КоличествоДляРаспределения;
			КонецЕсли;
			
		КонецЕсли;
		
		ОчиститьПриоритеты(ТаблицаОстатков);
		
		Для Каждого СтрокаКУдалению из СтрокиКУдалению Цикл
			Объект.Запасы.Удалить(СтрокаКУдалению);
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, ВидСуммы = "Резерв", НомерВариантаКП = 0, КоэффициентТекЕдиницы = 1)
	
	Партия = ?(Партия = Неопределено, Справочники.ПартииНоменклатуры.ПустаяСсылка(), Партия);
	
	ЭтоЗаказПокупателя = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя"), Истина, Ложь);
	
	Если ЭтоЗаказПокупателя Тогда
		ПараметрыОтбора.Вставить("НомерВариантаКП", НомерВариантаКП);
		НайденныеСтроки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
		ПараметрыОтбора.Удалить("НомерВариантаКП");
	Иначе
		НайденныеСтроки = Объект.Запасы.НайтиСтроки(ПараметрыОтбора);
	КонецЕсли;
	
	СуммаПоСтрокам = 0;
	
	Если ВидСуммы = "Резервировать" Тогда 
		Для Каждого СтрокаТабличнойЧасти из НайденныеСтроки Цикл
			КоэффициентЕдиницыИзмерения = КоэффициентЕдиницыИзмерения(СтрокаТабличнойЧасти.ЕдиницаИзмерения);
			СуммаПоСтрокам = СуммаПоСтрокам + СтрокаТабличнойЧасти.Резерв*КоэффициентЕдиницыИзмерения;
		КонецЦикла;
	КонецЕсли;
	
	Если ВидСуммы = "ВРезерве" Тогда 
		Для Каждого СтрокаТабличнойЧасти из НайденныеСтроки Цикл
			КоэффициентЕдиницыИзмерения = КоэффициентЕдиницыИзмерения(СтрокаТабличнойЧасти.ЕдиницаИзмерения);
			СуммаПоСтрокам = СуммаПоСтрокам + СтрокаТабличнойЧасти.ВРезерве*КоэффициентЕдиницыИзмерения;
		КонецЦикла;
	КонецЕсли;
	
	Если ВидСуммы = "Количество" Тогда 
		Для Каждого СтрокаТабличнойЧасти из НайденныеСтроки Цикл
			КоэффициентЕдиницыИзмерения = КоэффициентЕдиницыИзмерения(СтрокаТабличнойЧасти.ЕдиницаИзмерения);
			СуммаПоСтрокам = СуммаПоСтрокам + СтрокаТабличнойЧасти.Количество*КоэффициентЕдиницыИзмерения;
		КонецЦикла;
	КонецЕсли;
	
	Если ВидСуммы = "Отгружено" Тогда 
		Для Каждого СтрокаТабличнойЧасти из НайденныеСтроки Цикл
			КоэффициентЕдиницыИзмерения = КоэффициентЕдиницыИзмерения(СтрокаТабличнойЧасти.ЕдиницаИзмерения);
			СуммаПоСтрокам = СуммаПоСтрокам + СтрокаТабличнойЧасти.Отгружено*КоэффициентЕдиницыИзмерения;
		КонецЦикла;
	КонецЕсли;
	
	Если ВидСуммы = "НеОтгружено" Тогда 
		Для Каждого СтрокаТабличнойЧасти из НайденныеСтроки Цикл
			КоэффициентЕдиницыИзмерения = КоэффициентЕдиницыИзмерения(СтрокаТабличнойЧасти.ЕдиницаИзмерения);
			СуммаПоСтрокам = СуммаПоСтрокам + СтрокаТабличнойЧасти.НеОтгружено*КоэффициентЕдиницыИзмерения;
		КонецЦикла;
	КонецЕсли;
	
	Если ВидСуммы = "Свободно" Тогда 
		Для Каждого СтрокаТабличнойЧасти из НайденныеСтроки Цикл
			КоэффициентЕдиницыИзмерения = КоэффициентЕдиницыИзмерения(СтрокаТабличнойЧасти.ЕдиницаИзмерения);
			СуммаПоСтрокам = СуммаПоСтрокам + СтрокаТабличнойЧасти.ОстатокСвободно*КоэффициентЕдиницыИзмерения;
		КонецЦикла;
	КонецЕсли;
	
	СуммаПоСтрокам = СуммаПоСтрокам / КоэффициентТекЕдиницы;
	
	Возврат СуммаПоСтрокам;
	
КонецФункции

Функция КоэффициентЕдиницыИзмерения(ЕдиницаИзмерения)
	
	Если ТипЗнч(ЕдиницаИзмерения) = Тип("СправочникСсылка.ЕдиницыИзмерения") Тогда
		Возврат ЕдиницаИзмерения.Коэффициент
	Иначе
		Возврат 1;
	КонецЕсли;
	
КонецФункции

Функция ПредметИсчисления(Число, ПараметрыПредметаИсчисления1, ПараметрыПредметаИсчисления2, ПараметрыПредметаИсчисления3, Род)
	
	ФорматнаяСтрока = "Л = ru_RU";
	
	ПараметрыПредметаИсчисления = "%1,%2,%3,%4,,,,,0";
	ПараметрыПредметаИсчисления = СтрШаблон(
	ПараметрыПредметаИсчисления,
	ПараметрыПредметаИсчисления1,
	ПараметрыПредметаИсчисления2,
	ПараметрыПредметаИсчисления3,
	Род);
	
	ЧислоСтрокойИПредметИсчисления = НРег(ЧислоПрописью(Число, ФорматнаяСтрока, ПараметрыПредметаИсчисления));
	
	ЧислоПрописью = НРег(СокрЛП(СтрЗаменить(ЧислоПрописью(Число),"00","")));
	
	ПредметИсчисления = СтрЗаменить(ЧислоСтрокойИПредметИсчисления, ЧислоПрописью, "");
	
	Возврат ПредметИсчисления;
	
КонецФункции

Функция СписокДокументовПоЗаказу(Объект, ТипОперации, СтруткураПараметров) Экспорт
	
	Номенклатура = СтруткураПараметров.Номенклатура;
	Характеристика = СтруткураПараметров.Характеристика;
	Партия = СтруткураПараметров.Партия;
	Склад = СтруткураПараметров.Склад;
	ЕдиницаИзмерения = СтруткураПараметров.ЕдиницаИзмерения;
	ЗаказПокупателя = СтруткураПараметров.ЗаказПокупателя;
	НомерВариантаКП = СтруткураПараметров.НомерВариантаКП;
	
	ОрганизацияОбъекта = СтруткураПараметров.ОрганизацияОбъекта;
	
	ЭтоЗаказПокупателя = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя"), Истина, Ложь);
	
	Коэффициент = ?(ТипЗнч(ЕдиницаИзмерения) = Тип("СправочникСсылка.ЕдиницыИзмерения"), ЕдиницаИзмерения.Коэффициент, 1);
	Организация = УправлениеНебольшойФирмойСервер.ПолучитьОрганизацию(ОрганизацияОбъекта);
	
	СписокВозврата = Новый СписокЗначений;
	
	Запрос = Новый Запрос;
	
	ДлинаЧисла = 0;
	
	Если ТипОперации = "Заказано" Тогда
		
		Запрос.УстановитьПараметр("ЗаказПокупателя", Объект.Ссылка);
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Характеристика", Характеристика);
		
		Запрос.Текст = ТекстЗапросаЗаказано();
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Количество = Окр(Выборка.Количество/Коэффициент,3);
			ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(Количество, "ЧДЦ=0")), ДлинаЧисла);
			КоличествоТовара = СформироватьПредставлениеКоличества(Количество, ДлинаЧисла);
			
			СписокВозврата.Добавить(Выборка.Ссылка, КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". " +"Поставка: " + Формат(Выборка.ДатаПоступления,"ДФ=dd.MM.yyyy") + ". " + Строка(Выборка.Ссылка));
		КонецЦикла;
		
	ИначеЕсли ТипОперации = "ЗапасыПоступления" Тогда
		
		Запрос.УстановитьПараметр("ЗаказПокупателя", Объект.Ссылка);
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Характеристика", Характеристика);
		Запрос.УстановитьПараметр("Организация", Организация);
		
		Запрос.Текст = ТекстЗапросаЗапасыПоступления();
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Количество = Окр(Выборка.Количество/Коэффициент,3);
			ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(Количество, "ЧДЦ=0")), ДлинаЧисла);
			КоличествоТовара = СформироватьПредставлениеКоличества(Количество, ДлинаЧисла);
			
			СписокВозврата.Добавить(Выборка.Ссылка, КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". " 
			+"Поставка: " + Формат(Выборка.ДатаПоступления,"ДФ=dd.MM.yyyy") + ". " + Строка(Выборка.Ссылка));
		КонецЦикла;
		
	ИначеЕсли ТипОперации = "Остаток" Тогда
		
		ЗаказПокупателя = ?(ЗначениеЗаполнено(ЗаказПокупателя), ЗаказПокупателя, Объект.Ссылка);
		
		Запрос.УстановитьПараметр("ЗаказПокупателя", ЗаказПокупателя);
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Характеристика", Характеристика);
		Запрос.УстановитьПараметр("Партия", Партия);
		
		Запрос.Текст = ТекстЗапросаОстаток();
		
		Если Склад = Неопределено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,"И Запасы.СтруктурнаяЕдиница = &Склад", "");
		Иначе
			Запрос.УстановитьПараметр("Склад", Склад);
		КонецЕсли;
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		БылоСоответствиеСкладов = Ложь;
		
		Если ЭтоЗаказПокупателя Тогда
			ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв");
		Иначе
			ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница");
		КонецЕсли;
		
		ПараметрыОтбораБезСклада = Новый Структура("Номенклатура, Характеристика, Партия");
		
		Если ЭтоЗаказПокупателя Тогда
			
			Если ЗначениеЗаполнено(Склад) Тогда
				
				ПараметрыОтбора.Номенклатура = Номенклатура;
				ПараметрыОтбора.Характеристика = Характеристика;
				ПараметрыОтбора.Партия = Партия;
				
				Если ЭтоЗаказПокупателя Тогда
					ПараметрыОтбора.СтруктурнаяЕдиницаРезерв = Склад;
				Иначе
					ПараметрыОтбора.СтруктурнаяЕдиница = Склад;
				КонецЕсли;
				
				КоличествоВЕдиницахИзмеренияСтроки= ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "Резервировать", НомерВариантаКП, Коэффициент);
				
				ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(КоличествоВЕдиницахИзмеренияСтроки, "ЧДЦ=0")), ДлинаЧисла);
				КоличествоТовара = СформироватьПредставлениеКоличества(КоличествоВЕдиницахИзмеренияСтроки, ДлинаЧисла);
				
				ПредставлениеДокумента = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". " + Строка(Склад)+ "; "+"<текущий документ>";
				СписокВозврата.Добавить(Объект.Ссылка, ПредставлениеДокумента);
				
			Иначе
				
				ПараметрыОтбораБезСклада.Номенклатура = Номенклатура;
				ПараметрыОтбораБезСклада.Характеристика = Характеристика;
				ПараметрыОтбораБезСклада.Партия = Партия;
				
				СтрокиПоНоменклатуре = Объект.Запасы.НайтиСтроки(ПараметрыОтбораБезСклада);
				
				НаименованиеКолонкиДляСверткиТаблицы = ?(ЭтоЗаказПокупателя = Истина, "СтруктурнаяЕдиницаРезерв", "СтруктурнаяЕдиница");
				ТаблицаСкладов = Объект.Запасы.Выгрузить(СтрокиПоНоменклатуре,НаименованиеКолонкиДляСверткиТаблицы);
				ТаблицаСкладов.Свернуть(НаименованиеКолонкиДляСверткиТаблицы);
				
				Для Каждого СтрокаЗапасов из ТаблицаСкладов Цикл
					
					ПараметрыОтбора.Номенклатура = Номенклатура;
					ПараметрыОтбора.Характеристика = Характеристика;
					ПараметрыОтбора.Партия = Партия;
					
					СтруктурнаяЕдиница = ?(ЭтоЗаказПокупателя = Истина, СтрокаЗапасов.СтруктурнаяЕдиницаРезерв, СтрокаЗапасов.СтруктурнаяЕдиница);
					
					Если ЭтоЗаказПокупателя Тогда
						ПараметрыОтбора.СтруктурнаяЕдиницаРезерв = СтруктурнаяЕдиница;
					Иначе
						ПараметрыОтбора.СтруктурнаяЕдиница = СтруктурнаяЕдиница;
					КонецЕсли;
					
					КоличествоВЕдиницахИзмеренияСтроки= ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "Резервировать", НомерВариантаКП, Коэффициент);
					
					Если Не КоличествоВЕдиницахИзмеренияСтроки > 0 Тогда Продолжить КонецЕсли;
					
					ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(КоличествоВЕдиницахИзмеренияСтроки, "ЧДЦ=0")), ДлинаЧисла);
					КоличествоТовара = СформироватьПредставлениеКоличества(КоличествоВЕдиницахИзмеренияСтроки, ДлинаЧисла);
					
					ПредставлениеДокумента = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". " + Строка(СтруктурнаяЕдиница)+ "; "+"<текущий документ>";
					
					СписокВозврата.Добавить(Объект.Ссылка, ПредставлениеДокумента);
					
				КонецЦикла;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Пока Выборка.Следующий() Цикл
			
			Если Не ЗначениеЗаполнено(Выборка.Количество) или Выборка.Регистратор = Объект.Ссылка Тогда Продолжить КонецЕсли;
			
			ПредставлениеДокумента = "";
			
			Количество = Окр(Выборка.Количество/Коэффициент,3);
			
			Если Количество = 0 Тогда Продолжить КонецЕсли;
			
			ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(Количество, "ЧДЦ=0")), ДлинаЧисла);
			КоличествоТовара = СформироватьПредставлениеКоличества(Количество, ДлинаЧисла);
				
			ПредставлениеДокумента = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". " + Строка(Выборка.Склад)+ "; " + Строка(Выборка.Регистратор);
			СписокВозврата.Добавить(Выборка.Регистратор, ПредставлениеДокумента);
			
		КонецЦикла;
		
	ИначеЕсли ТипОперации = "ОстатокПоРезервамРН" Тогда
		
		ЗаказПокупателя = ?(ЗначениеЗаполнено(ЗаказПокупателя), ЗаказПокупателя, Объект.Ссылка);
		
		Запрос.УстановитьПараметр("ЗаказПокупателя", ЗаказПокупателя);
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Характеристика", Характеристика);
		Запрос.УстановитьПараметр("Партия", Партия);
		
		Запрос.Текст = ТекстЗапросаОстаток();
		
		Если Склад = Неопределено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст,"И Запасы.СтруктурнаяЕдиница = &Склад", "");
		Иначе
			Запрос.УстановитьПараметр("Склад", Склад);
		КонецЕсли;
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		БылоСоответствиеСкладов = Ложь;
		
		ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница");
		ПараметрыОтбораБезСклада = Новый Структура("Номенклатура, Характеристика, Партия");
		
		Если ЗначениеЗаполнено(Склад) Тогда
			
			ПараметрыОтбора.Номенклатура = Номенклатура;
			ПараметрыОтбора.Характеристика = Характеристика;
			ПараметрыОтбора.Партия = Партия;
			ПараметрыОтбора.СтруктурнаяЕдиницаРезерв = Склад;
			
			КоличествоВЕдиницахИзмеренияСтроки= ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "Резервировать", НомерВариантаКП, Коэффициент);
			
			ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(КоличествоВЕдиницахИзмеренияСтроки, "ЧДЦ=0")), ДлинаЧисла);
			КоличествоТовара = СформироватьПредставлениеКоличества(КоличествоВЕдиницахИзмеренияСтроки, ДлинаЧисла);
			
			ПредставлениеДокумента = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". " + Строка(Склад)+ "; "+"<текущий документ>";
			СписокВозврата.Добавить(Объект.Ссылка, ПредставлениеДокумента);
			
		Иначе
			
			ПараметрыОтбораБезСклада.Номенклатура = Номенклатура;
			ПараметрыОтбораБезСклада.Характеристика = Характеристика;
			ПараметрыОтбораБезСклада.Партия = Партия;
			
			СтрокиПоНоменклатуре = Объект.Запасы.НайтиСтроки(ПараметрыОтбораБезСклада);
			
			ТаблицаСкладов = Объект.Запасы.Выгрузить(СтрокиПоНоменклатуре,"СтруктурнаяЕдиницаРезерв");
			ТаблицаСкладов.Свернуть("СтруктурнаяЕдиницаРезерв");
			
			Для Каждого СтрокаЗапасов из ТаблицаСкладов Цикл
				
				ПараметрыОтбора.Номенклатура = Номенклатура;
				ПараметрыОтбора.Характеристика = Характеристика;
				ПараметрыОтбора.Партия = Партия;
				ПараметрыОтбора.СтруктурнаяЕдиницаРезерв = СтрокаЗапасов.СтруктурнаяЕдиницаРезерв;
				
				КоличествоВЕдиницахИзмеренияСтроки= ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "Резервировать", НомерВариантаКП, Коэффициент);
				
				Если Не КоличествоВЕдиницахИзмеренияСтроки > 0 Тогда Продолжить КонецЕсли;
				
				ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(КоличествоВЕдиницахИзмеренияСтроки, "ЧДЦ=0")), ДлинаЧисла);
				КоличествоТовара = СформироватьПредставлениеКоличества(КоличествоВЕдиницахИзмеренияСтроки, ДлинаЧисла);
				
				ПредставлениеДокумента = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". " + Строка(СтрокаЗапасов.СтруктурнаяЕдиницаРезерв)+ "; "+"<текущий документ>";
				
				СписокВозврата.Добавить(Объект.Ссылка, ПредставлениеДокумента);
				
			КонецЦикла;
			
		КонецЕсли;
		
		Пока Выборка.Следующий() Цикл
			
			Если Не ЗначениеЗаполнено(Выборка.Количество) или Выборка.Регистратор = Объект.Ссылка Тогда Продолжить КонецЕсли;
			
			ПредставлениеДокумента = "";
			
			Количество = Окр(Выборка.Количество/Коэффициент,3);
			
			Если Количество = 0 Тогда Продолжить КонецЕсли;
			
			ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(Количество, "ЧДЦ=0")), ДлинаЧисла);
			КоличествоТовара = СформироватьПредставлениеКоличества(Количество, ДлинаЧисла);
				
			ПредставлениеДокумента = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". "+ Строка(Выборка.Склад)+ "; " + Строка(Выборка.Регистратор);
			СписокВозврата.Добавить(Выборка.Регистратор, ПредставлениеДокумента);
			
		КонецЦикла;
		
	ИначеЕсли ТипОперации = "ЗапасыВРезервеПоСкладам" Тогда
		
		ЗаказПокупателя = ?(ЗначениеЗаполнено(ЗаказПокупателя), ЗаказПокупателя, Объект.Ссылка);
		
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Характеристика", Характеристика);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("Партия", Партия);
		Запрос.УстановитьПараметр("ЗаказПокупателя", ЗаказПокупателя);
		
		Запрос.Текст = ТекстЗапросаЗапасыВРезервеПоСкладам();
	
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			СтруктураЗначенийПоСкладу = Новый Структура("Склад, Количество");
			
			Количество = Окр(Выборка.Количество/Коэффициент,3);
			
			Если Количество = 0 Тогда Продолжить КонецЕсли;
			
			ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(Количество, "ЧДЦ=0")), ДлинаЧисла);
			КоличествоТовара = СформироватьПредставлениеКоличества(Количество, ДлинаЧисла);
			
			ПредставлениеЗначения = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". "+ Строка(Выборка.Склад);
			
			СтруктураЗначенийПоСкладу.Склад = Выборка.Склад;
			СтруктураЗначенийПоСкладу.Количество = КоличествоТовара;
			
			СписокВозврата.Добавить(СтруктураЗначенийПоСкладу, ПредставлениеЗначения);
			
		КонецЦикла;
		
	Иначе //ОстаткиОбщие
		
		ЭтоЗаказПокупателя = ?(ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя"), Истина, Ложь);
		
		Если ЭтоЗаказПокупателя Тогда
			ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиницаРезерв");
		Иначе
			ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница");
		КонецЕсли;
		
		ПараметрыОтбора.Номенклатура = Номенклатура;
		ПараметрыОтбора.Характеристика = Характеристика;
		ПараметрыОтбора.Партия = Партия;
		
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Характеристика", Характеристика);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("Партия", Партия);
		
		Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
			Если ЭтоЗаказПокупателя Тогда
				Запрос.УстановитьПараметр("ЗаказПокупателя", Объект.Ссылка);
				Запрос.Текст = ТекстЗапросаОстаткиОбщие(Истина);
			Иначе
				Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
				Запрос.Текст = ТекстЗапросаОстаткиОбщие(Истина, Ложь);
			КонецЕсли;
		Иначе
			Запрос.Текст = ТекстЗапросаОстаткиОбщие();
		Конецесли;
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			СтруктураЗначенийПоСкладу = Новый Структура("Склад, Количество");

			Если ЭтоЗаказПокупателя Тогда
				ПараметрыОтбора.СтруктурнаяЕдиницаРезерв = Выборка.Склад;
			Иначе
				ПараметрыОтбора.СтруктурнаяЕдиница = Выборка.Склад;
			КонецЕсли;
			
			ИтогПоЗначениюВРезерв = 0;
			
			Если ЭтоЗаказПокупателя Тогда
				ИтогПоЗначениюВРезерв = ?(ЭтоЗаказПокупателя = Истина, ПолучитьСуммуПоТабличнойЧасти(Объект, ПараметрыОтбора, "Резервировать", НомерВариантаКП), 0);
			КонецЕсли;
			
			Количество = Выборка.Количество - ИтогПоЗначениюВРезерв + Выборка.ЗарезервированоЗаказом;
			
			Если Количество = 0 Тогда Продолжить КонецЕсли;
			
			Количество = Окр(Количество/Коэффициент,3);
			ДлинаЧисла = ?(ДлинаЧисла = 0, СтрДлина(Формат(Количество, "ЧДЦ=0")), ДлинаЧисла);
			КоличествоТовара = СформироватьПредставлениеКоличества(Количество, ДлинаЧисла);
			
			ПредставлениеЗначения = КоличествоТовара +" "+ Строка(ЕдиницаИзмерения)+". "+ Строка(Выборка.Склад);
			
			СтруктураЗначенийПоСкладу.Склад = Выборка.Склад;
			СтруктураЗначенийПоСкладу.Количество = Количество;
			
			СписокВозврата.Добавить(СтруктураЗначенийПоСкладу, ПредставлениеЗначения);
			
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат СписокВозврата;
	
КонецФункции

Функция ТекстЗапросаЗаполнитьКоличествоПоОстаткамИРезервамРасходнаяНакладная()
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА &ЗаказВШапке
	|			ТОГДА &Заказ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА ТаблицаЗапасы.Заказ ССЫЛКА Документ.ЗаказПокупателя
	|						И ТаблицаЗапасы.Заказ <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					ТОГДА ТаблицаЗапасы.Заказ
	|				ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			КОНЕЦ
	|	КОНЕЦ КАК ЗаказПокупателя
	|ПОМЕСТИТЬ ВтНоменклатураВыбор
	|ИЗ
	|	&ТаблицаЗапасы КАК ТаблицаЗапасы
	|ГДЕ
	|	ТаблицаЗапасы.ТипНоменклатурыЗапас
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ВтНоменклатураВыбор.Номенклатура КАК Номенклатура,
	|	ВтНоменклатураВыбор.Характеристика КАК Характеристика,
	|	ВтНоменклатураВыбор.Партия КАК Партия,
	|	ВтНоменклатураВыбор.ЗаказПокупателя КАК ЗаказПокупателя,
	|	СтруктурныеЕдиницы.Ссылка КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ ВТДекартовоПроизведениеНоменклатурыИСклада
	|ИЗ
	|	ВтНоменклатураВыбор КАК ВтНоменклатураВыбор,
	|	Справочник.СтруктурныеЕдиницы КАК СтруктурныеЕдиницы
	|ГДЕ
	|	СтруктурныеЕдиницы.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапасыОстатки.КоличествоОстаток КАК КоличествоОстаток,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура КАК Номенклатура,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика КАК Характеристика,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Партия КАК Партия,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ ОстаткиНаСкладе
	|ИЗ
	|	ВТДекартовоПроизведениеНоменклатурыИСклада КАК ВТДекартовоПроизведениеНоменклатурыИСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				Организация = &Организация
	|					И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					И Номенклатура В (&МассивНоменклатуры)) КАК ЗапасыОстатки
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ЗапасыОстатки.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ЗапасыОстатки.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ЗапасыОстатки.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ЗапасыОстатки.СтруктурнаяЕдиница
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапасыОстатки.КоличествоОстаток КАК КоличествоОстаток,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура КАК Номенклатура,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика КАК Характеристика,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Партия КАК Партия,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ ОстаткиРезервов
	|ИЗ
	|	ВТДекартовоПроизведениеНоменклатурыИСклада КАК ВТДекартовоПроизведениеНоменклатурыИСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				Организация = &Организация
	|					И НЕ ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					И Номенклатура В (&МассивНоменклатуры)) КАК ЗапасыОстатки
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ЗапасыОстатки.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ЗапасыОстатки.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ЗапасыОстатки.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя = ЗапасыОстатки.ЗаказПокупателя
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ЗапасыОстатки.СтруктурнаяЕдиница
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|		КОНЕЦ) КАК ОтгруженоБезРезерва,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура КАК Номенклатура,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика КАК Характеристика,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Партия КАК Партия,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя КАК ЗаказПокупателя1
	|ПОМЕСТИТЬ ДвижениеДокументаБезРезерва
	|ИЗ
	|	ВТДекартовоПроизведениеНоменклатурыИСклада КАК ВТДекартовоПроизведениеНоменклатурыИСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК ДвиженияДокументаЗапасы
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ДвиженияДокументаЗапасы.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ДвиженияДокументаЗапасы.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ДвиженияДокументаЗапасы.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ДвиженияДокументаЗапасы.СтруктурнаяЕдиница
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя = ДвиженияДокументаЗапасы.ЗаказПокупателя
	|ГДЕ
	|	ДвиженияДокументаЗапасы.Регистратор = &Ссылка
	|	И ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И ДвиженияДокументаЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяССылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Партия,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|		КОНЕЦ) КАК ОтгруженоРезерва,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура КАК Номенклатура,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика КАК Характеристика,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Партия КАК Партия,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя КАК ЗаказПокупателя1
	|ПОМЕСТИТЬ ДвижениеДокументаПоРезерву
	|ИЗ
	|	ВТДекартовоПроизведениеНоменклатурыИСклада КАК ВТДекартовоПроизведениеНоменклатурыИСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК ДвиженияДокументаЗапасы
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ДвиженияДокументаЗапасы.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ДвиженияДокументаЗапасы.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ДвиженияДокументаЗапасы.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ДвиженияДокументаЗапасы.СтруктурнаяЕдиница
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя = ДвиженияДокументаЗапасы.ЗаказПокупателя
	|ГДЕ
	|	ДвиженияДокументаЗапасы.Регистратор = &Ссылка
	|	И ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НЕ ДвиженияДокументаЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяССылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Партия,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ЕСТЬNULL(ОстаткиРезервов.КоличествоОстаток, 0) КАК Зарезервировано,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура КАК Номенклатура,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика КАК Характеристика,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.Партия КАК Партия,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя КАК Заказ,
	|	ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВЫБОР
	|		КОГДА ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = &ПриоритетныйСклад
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК Приоритет,
	|	ЕСТЬNULL(ДвижениеДокументаПоРезерву.ОтгруженоРезерва, 0) КАК ОтгруженоРезерва,
	|	ЕСТЬNULL(ДвижениеДокумента.ОтгруженоБезРезерва, 0) КАК ОтгруженоБезРезерва,
	|	ЕСТЬNULL(ОстаткиНаСкладе.КоличествоОстаток, 0) + ЕСТЬNULL(ОстаткиРезервов.КоличествоОстаток, 0) + ЕСТЬNULL(ДвижениеДокументаПоРезерву.ОтгруженоРезерва, 0) КАК КоличествоОстаток,
	|	ЕСТЬNULL(ДвижениеДокументаПоРезерву.ОтгруженоРезерва, 0) + ЕСТЬNULL(ОстаткиРезервов.КоличествоОстаток, 0) КАК ВсегоРезерва,
	|	ЕСТЬNULL(ОстаткиНаСкладе.КоличествоОстаток, 0) КАК СвободныйОстаток,
	|	ЕСТЬNULL(ОстаткиНаСкладе.КоличествоОстаток, 0) + ЕСТЬNULL(ОстаткиРезервов.КоличествоОстаток, 0) + ЕСТЬNULL(ДвижениеДокументаПоРезерву.ОтгруженоРезерва, 0) КАК ОстатокСУчетомДвижения,
	|	ЗНАЧЕНИЕ(Справочник.Ячейки.ПустаяСсылка) КАК Ячейка
	|ИЗ
	|	ВТДекартовоПроизведениеНоменклатурыИСклада КАК ВТДекартовоПроизведениеНоменклатурыИСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиНаСкладе КАК ОстаткиНаСкладе
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ОстаткиНаСкладе.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ОстаткиНаСкладе.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ОстаткиНаСкладе.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ОстаткиНаСкладе.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвижениеДокументаБезРезерва КАК ДвижениеДокумента
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ДвижениеДокумента.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ДвижениеДокумента.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ДвижениеДокумента.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя = ДвижениеДокумента.ЗаказПокупателя1
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ДвижениеДокумента.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиРезервов КАК ОстаткиРезервов
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ОстаткиРезервов.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя = ОстаткиРезервов.ЗаказПокупателя
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ОстаткиРезервов.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ОстаткиРезервов.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ОстаткиРезервов.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДвижениеДокументаПоРезерву КАК ДвижениеДокументаПоРезерву
	|		ПО ВТДекартовоПроизведениеНоменклатурыИСклада.Номенклатура = ДвижениеДокументаПоРезерву.Номенклатура
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Характеристика = ДвижениеДокументаПоРезерву.Характеристика
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.Партия = ДвижениеДокументаПоРезерву.Партия
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.ЗаказПокупателя = ДвижениеДокументаПоРезерву.ЗаказПокупателя1
	|			И ВТДекартовоПроизведениеНоменклатурыИСклада.СтруктурнаяЕдиница = ДвижениеДокументаПоРезерву.СтруктурнаяЕдиница
	|ГДЕ
	|	(НЕ ЕСТЬNULL(ОстаткиРезервов.КоличествоОстаток, 0) = 0
	|			ИЛИ НЕ ЕСТЬNULL(ОстаткиНаСкладе.КоличествоОстаток, 0) = 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Заказ,
	|	Приоритет,
	|	Зарезервировано";
	
	Возврат ТекстЗапроса;
КонецФункции

Функция ТекстЗапросаОстаткиИРезервы()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ТаблицаНоменклатура.Номенклатура КАК НоменклатураЗапасов,
	|	ТаблицаНоменклатура.Характеристика КАК Характеристика,
	|	ТаблицаНоменклатура.Партия КАК Партия,
	|	ТаблицаНоменклатура.СтруктурнаяЕдиницаРезерв КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ ВтНоменклатура
	|ИЗ
	|	&ТаблицаНоменклатура КАК ТаблицаНоменклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ВтНоменклатура.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.Партия КАК Партия
	|ПОМЕСТИТЬ ВтНоменклатураБезСклада
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ЕСТЬNULL(ЗапасыОстаткиРезервы.КоличествоОстаток, 0)) КАК РезервНаСкладах,
	|	СУММА(ЕСТЬNULL(ЗапасыОстаткиОбщие.КоличествоОстаток, 0)) КАК ОстатокОбщий,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика КАК Характеристика,
	|	ВтНоменклатураБезСклада.Партия КАК Партия,
	|	ЕСТЬNULL(ЗапасыОстаткиРезервы.КоличествоОстаток, 0) КАК РезервНаСкладахИтог
	|ПОМЕСТИТЬ Остатки
	|ИЗ
	|	ВтНоменклатураБезСклада КАК ВтНоменклатураБезСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				ВЫБОР
	|					КОГДА НЕ &ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|						ТОГДА ЗаказПокупателя = &ЗаказПокупателя
	|				КОНЕЦ) КАК ЗапасыОстаткиРезервы
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = ЗапасыОстаткиРезервы.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = ЗапасыОстаткиРезервы.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = ЗапасыОстаткиРезервы.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				Организация = &Организация
	|					И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					И ТИПЗНАЧЕНИЯ(СтруктурнаяЕдиница) = ТИП(Справочник.СтруктурныеЕдиницы)
	|					И СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)) КАК ЗапасыОстаткиОбщие
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = ЗапасыОстаткиОбщие.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = ЗапасыОстаткиОбщие.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = ЗапасыОстаткиОбщие.Партия
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатураБезСклада.Партия,
	|	ВтНоменклатураБезСклада.Характеристика,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов,
	|	ЕСТЬNULL(ЗапасыОстаткиРезервы.КоличествоОстаток, 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВтНоменклатура.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.Партия КАК Партия,
	|	ВтНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	СУММА(ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0)) КАК ОстатокТекСклад,
	|	СУММА(ЕСТЬNULL(ЗапасыОстаткиРезервТекСклад.КоличествоОстаток, 0)) КАК РезервТекСклад
	|ПОМЕСТИТЬ ОстаткиВРазрезеСкладов
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				Организация = &Организация
	|					И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)) КАК ЗапасыОстатки
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ЗапасыОстатки.Номенклатура
	|			И ВтНоменклатура.Характеристика = ЗапасыОстатки.Характеристика
	|			И ВтНоменклатура.Партия = ЗапасыОстатки.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = ЗапасыОстатки.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				ВЫБОР
	|					КОГДА НЕ &ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|						ТОГДА ЗаказПокупателя = &ЗаказПокупателя
	|				КОНЕЦ) КАК ЗапасыОстаткиРезервТекСклад
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ЗапасыОстаткиРезервТекСклад.Номенклатура
	|			И ВтНоменклатура.Характеристика = ЗапасыОстаткиРезервТекСклад.Характеристика
	|			И ВтНоменклатура.Партия = ЗапасыОстаткиРезервТекСклад.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = ЗапасыОстаткиРезервТекСклад.СтруктурнаяЕдиница
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатура.НоменклатураЗапасов,
	|	ВтНоменклатура.СтруктурнаяЕдиница,
	|	ВтНоменклатура.Характеристика,
	|	ВтНоменклатура.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ВтНоменклатура.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	СУММА(ВЫБОР
	|			КОГДА Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Запасы.Количество * -1
	|			ИНАЧЕ Запасы.Количество
	|		КОНЕЦ) КАК ЗарезервированоЗаказом,
	|	ВтНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.Партия КАК Партия
	|ПОМЕСТИТЬ РезервСделанныйЗаказом
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК Запасы
	|		ПО ВтНоменклатура.НоменклатураЗапасов = Запасы.Номенклатура
	|			И ВтНоменклатура.Характеристика = Запасы.Характеристика
	|			И ВтНоменклатура.Партия = Запасы.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = Запасы.СтруктурнаяЕдиница
	|ГДЕ
	|	Запасы.ЗаказПокупателя = &ЗаказПокупателя
	|	И Запасы.Регистратор = &ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Запасы.СтруктурнаяЕдиница,
	|	ВтНоменклатура.НоменклатураЗапасов,
	|	ВтНоменклатура.СтруктурнаяЕдиница,
	|	ВтНоменклатура.Характеристика,
	|	ВтНоменклатура.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СУММА(ВЫБОР
	|			КОГДА Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Запасы.Количество * -1
	|			ИНАЧЕ Запасы.Количество
	|		КОНЕЦ) КАК ЗарезервированоЗаказом,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика КАК Характеристика,
	|	ВтНоменклатураБезСклада.Партия КАК Партия
	|ПОМЕСТИТЬ РезервСделанныйЗаказомПоВсемСкладам
	|ИЗ
	|	ВтНоменклатураБезСклада КАК ВтНоменклатураБезСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК Запасы
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = Запасы.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = Запасы.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = Запасы.Партия
	|ГДЕ
	|	Запасы.ЗаказПокупателя = &ЗаказПокупателя
	|	И Запасы.Регистратор = &ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика,
	|	ВтНоменклатураБезСклада.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗаказыПоставщикамОстаткиДокументы.ЗаказПоставщикуДатаПоступления КАК ДатаПоступления,
	|	ЗаказаноНоменклатуры.ЗаказаноБезРезерва КАК ЗаказаноБезРезерва,
	|	ЗаказаноНоменклатуры.Номенклатура КАК Номенклатура,
	|	ЗаказаноНоменклатуры.Характеристика КАК Характеристика,
	|	ЗаказаноНоменклатуры.Организация КАК Организация,
	|	ЗаказаноНоменклатуры.КоличествоДокументовЗаказано КАК КоличествоДокументовЗаказано
	|ПОМЕСТИТЬ Заказано
	|ИЗ
	|	(ВЫБРАТЬ
	|		СУММА(ВложенныйЗапрос.ЗаказаноБезРезерва) КАК ЗаказаноБезРезерва,
	|		ВложенныйЗапрос.Номенклатура КАК Номенклатура,
	|		ВложенныйЗапрос.Характеристика КАК Характеристика,
	|		ВложенныйЗапрос.Организация КАК Организация,
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ВложенныйЗапрос.КоличествоДокументовЗаказано) КАК КоличествоДокументовЗаказано
	|	ИЗ
	|		(ВЫБРАТЬ
	|			СУММА(ЗаказыПоставщикамОстатки.КоличествоОстаток) КАК ЗаказаноБезРезерва,
	|			ЗаказыПоставщикамОстатки.Номенклатура КАК Номенклатура,
	|			ЗаказыПоставщикамОстатки.Характеристика КАК Характеристика,
	|			ЗаказыПоставщикамОстатки.Организация КАК Организация,
	|			ЗаказыПоставщикамОстатки.ЗаказПоставщику КАК КоличествоДокументовЗаказано
	|		ИЗ
	|			РегистрНакопления.ЗаказыПоставщикам.Остатки(
	|					,
	|					Организация = &Организация
	|						И Номенклатура В (&Номенклатура)
	|						И Характеристика В (&Характеристика)
	|						И НЕ ЗаказПоставщику В
	|								(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|									РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК ИсточникОбеспечения
	|								ИЗ
	|									РегистрНакопления.РазмещениеЗаказов.Остатки(, Номенклатура В (&Номенклатура)
	|										И Характеристика В (&Характеристика)) КАК РазмещениеЗаказовОстатки)) КАК ЗаказыПоставщикамОстатки
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ЗаказыПоставщикамОстатки.Характеристика,
	|			ЗаказыПоставщикамОстатки.Организация,
	|			ЗаказыПоставщикамОстатки.Номенклатура,
	|			ЗаказыПоставщикамОстатки.ЗаказПоставщику
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			СУММА(ЗаказыНаПроизводствоОстатки.КоличествоОстаток),
	|			ЗаказыНаПроизводствоОстатки.Номенклатура,
	|			ЗаказыНаПроизводствоОстатки.Характеристика,
	|			ЗаказыНаПроизводствоОстатки.Организация,
	|			ЗаказыНаПроизводствоОстатки.ЗаказНаПроизводство
	|		ИЗ
	|			РегистрНакопления.ЗаказыНаПроизводство.Остатки(
	|					,
	|					Организация = &Организация
	|						И Номенклатура В (&Номенклатура)
	|						И Характеристика В (&Характеристика)
	|						И НЕ ЗаказНаПроизводство В
	|								(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|									РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК ИсточникОбеспечения
	|								ИЗ
	|									РегистрНакопления.РазмещениеЗаказов.Остатки(, Номенклатура В (&Номенклатура)
	|										И Характеристика В (&Характеристика)) КАК РазмещениеЗаказовОстатки)) КАК ЗаказыНаПроизводствоОстатки
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ЗаказыНаПроизводствоОстатки.ЗаказНаПроизводство,
	|			ЗаказыНаПроизводствоОстатки.Номенклатура,
	|			ЗаказыНаПроизводствоОстатки.Характеристика,
	|			ЗаказыНаПроизводствоОстатки.Организация) КАК ВложенныйЗапрос
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ВложенныйЗапрос.Номенклатура,
	|		ВложенныйЗапрос.Характеристика,
	|		ВложенныйЗапрос.Организация) КАК ЗаказаноНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			МАКСИМУМ(ВложенныйЗапрос.ЗаказПоставщикуДатаПоступления) КАК ЗаказПоставщикуДатаПоступления,
	|			ВложенныйЗапрос.Организация КАК Организация,
	|			ВложенныйЗапрос.Номенклатура КАК Номенклатура,
	|			ВложенныйЗапрос.Характеристика КАК Характеристика
	|		ИЗ
	|			(ВЫБРАТЬ
	|				ГрафикДвиженияЗапасов.Период КАК ЗаказПоставщикуДатаПоступления,
	|				ЗаказыПоставщикамОстатки.Организация КАК Организация,
	|				ЗаказыПоставщикамОстатки.Номенклатура КАК Номенклатура,
	|				ЗаказыПоставщикамОстатки.Характеристика КАК Характеристика
	|			ИЗ
	|				РегистрНакопления.ЗаказыПоставщикам.Остатки(
	|						,
	|						Организация = &Организация
	|							И Номенклатура В (&Номенклатура)
	|							И Характеристика В (&Характеристика)
	|							И НЕ ЗаказПоставщику В
	|									(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|										РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК ИсточникОбеспечения
	|									ИЗ
	|										РегистрНакопления.РазмещениеЗаказов.Остатки(, Номенклатура В (&Номенклатура)
	|											И Характеристика В (&Характеристика)) КАК РазмещениеЗаказовОстатки)) КАК ЗаказыПоставщикамОстатки
	|					ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ГрафикДвиженияЗапасов КАК ГрафикДвиженияЗапасов
	|					ПО ЗаказыПоставщикамОстатки.ЗаказПоставщику = ГрафикДвиженияЗапасов.Заказ
	|						И ЗаказыПоставщикамОстатки.Номенклатура = ГрафикДвиженияЗапасов.Номенклатура
	|						И ЗаказыПоставщикамОстатки.Характеристика = ГрафикДвиженияЗапасов.Характеристика
	|			ГДЕ
	|				ГрафикДвиженияЗапасов.Организация = &Организация
	|			
	|			ОБЪЕДИНИТЬ ВСЕ
	|			
	|			ВЫБРАТЬ
	|				ЗаказыНаПроизводствоОстатки.ЗаказНаПроизводство.Финиш,
	|				ЗаказыНаПроизводствоОстатки.Организация,
	|				ЗаказыНаПроизводствоОстатки.Номенклатура,
	|				ЗаказыНаПроизводствоОстатки.Характеристика
	|			ИЗ
	|				РегистрНакопления.ЗаказыНаПроизводство.Остатки(
	|						,
	|						Организация = &Организация
	|							И Номенклатура В (&Номенклатура)
	|							И Характеристика В (&Характеристика)
	|							И НЕ ЗаказНаПроизводство В
	|									(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|										РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК ИсточникОбеспечения
	|									ИЗ
	|										РегистрНакопления.РазмещениеЗаказов.Остатки(, Номенклатура В (&Номенклатура)
	|											И Характеристика В (&Характеристика)) КАК РазмещениеЗаказовОстатки)) КАК ЗаказыНаПроизводствоОстатки) КАК ВложенныйЗапрос
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ВложенныйЗапрос.Организация,
	|			ВложенныйЗапрос.Характеристика,
	|			ВложенныйЗапрос.Номенклатура) КАК ЗаказыПоставщикамОстаткиДокументы
	|		ПО ЗаказаноНоменклатуры.Номенклатура = ЗаказыПоставщикамОстаткиДокументы.Номенклатура
	|			И ЗаказаноНоменклатуры.Характеристика = ЗаказыПоставщикамОстаткиДокументы.Характеристика
	|			И ЗаказаноНоменклатуры.Организация = ЗаказыПоставщикамОстаткиДокументы.Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗаказыПоставщикамОстаткиДокументы.ЗаказПоставщикуДатаПоступления,
	|	ЗаказаноНоменклатуры.ЗаказаноБезРезерва,
	|	ЗаказаноНоменклатуры.Номенклатура,
	|	ЗаказаноНоменклатуры.Характеристика,
	|	ЗаказаноНоменклатуры.Организация,
	|	ЗаказаноНоменклатуры.КоличествоДокументовЗаказано
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(РазмещениеЗаказовОстатки.КоличествоОстаток) КАК РезеврЗаказано,
	|	СУММА(РазмещениеЗаказовОстаткиНеПоТекДокументу.КоличествоОстаток) КАК РезервЗаказаноОбщий,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика КАК Характеристика,
	|	ВтНоменклатураБезСклада.Партия КАК Партия,
	|	СУММА(РазмещениеЗаказовОстатки.КоличествоОстаток) КАК РезеврЗаказаноИтог
	|ПОМЕСТИТЬ Размещено
	|ИЗ
	|	ВтНоменклатураБезСклада КАК ВтНоменклатураБезСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РазмещениеЗаказов.Остатки(
	|				,
	|				ВЫБОР
	|					КОГДА НЕ &ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|						ТОГДА ЗаказПокупателя = &ЗаказПокупателя
	|				КОНЕЦ) КАК РазмещениеЗаказовОстатки
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = РазмещениеЗаказовОстатки.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = РазмещениеЗаказовОстатки.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РазмещениеЗаказов.Остатки(
	|				,
	|				Организация = &Организация
	|					И НЕ ЗаказПокупателя = &ЗаказПокупателя) КАК РазмещениеЗаказовОстаткиНеПоТекДокументу
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = РазмещениеЗаказовОстаткиНеПоТекДокументу.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = РазмещениеЗаказовОстаткиНеПоТекДокументу.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатураБезСклада.Партия,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СУММА(Запасы.Количество) КАК ОтгрузкаРезерва,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика КАК Характеристика,
	|	ВтНоменклатураБезСклада.Партия КАК Партия
	|ПОМЕСТИТЬ ОтгрузкаПоРезервам
	|ИЗ
	|	ВтНоменклатураБезСклада КАК ВтНоменклатураБезСклада,
	|	РегистрНакопления.Запасы КАК Запасы
	|ГДЕ
	|	Запасы.ЗаказПокупателя = &ЗаказПокупателя
	|	И Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатураБезСклада.Партия,
	|	ВтНоменклатураБезСклада.Характеристика,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ЕСТЬNULL(Заказано.ДатаПоступления, 0) КАК ДатаПоступления,
	|	ЕСТЬNULL(Заказано.КоличествоДокументовЗаказано, 0) КАК КоличествоДокументовЗаказано,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.НоменклатураЗапасов КАК Номенклатура,
	|	ВтНоменклатура.Партия КАК Партия,
	|	ВтНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиницаРезерв,
	|	ЕСТЬNULL(Размещено.РезеврЗаказано, 0) КАК РезервЗаказано,
	|	ЕСТЬNULL(Размещено.РезервЗаказаноОбщий, 0) КАК РезервЗаказаноОбщий,
	|	ЕСТЬNULL(Заказано.ЗаказаноБезРезерва, 0) КАК ЗаказаноБезРезерва,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.ОстатокТекСклад, 0) КАК ОстатокТекСклад,
	|	ЕСТЬNULL(Остатки.ОстатокОбщий, 0) КАК ОстатокОбщий,
	|	ЕСТЬNULL(Остатки.РезервНаСкладахИтог, 0) КАК РезервНаСкладахИтог,
	|	ЕСТЬNULL(Размещено.РезеврЗаказаноИтог, 0) КАК РезервЗаказаноИтог,
	|	ЛОЖЬ КАК СтрокаОбработана,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.ОстатокТекСклад, 0) КАК ОстатокТекСкладПослеРаспределения,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.РезервТекСклад, 0) КАК РезервТекСкладИтог,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.ОстатокТекСклад, 0) + ЕСТЬNULL(ОстаткиВРазрезеСкладов.РезервТекСклад, 0) КАК МожноОтгрузитьПроведенныйДокумент,
	|	ЕСТЬNULL(Остатки.ОстатокОбщий, 0) КАК ОстатокОбщийПослеРаспределения,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.РезервТекСклад, 0) - ЕСТЬNULL(РезервСделанныйЗаказом.ЗарезервированоЗаказом, 0) КАК РезервТекСклад,
	|	ЕСТЬNULL(Остатки.РезервНаСкладах, 0) - ЕСТЬNULL(РезервСделанныйЗаказомПоВсемСкладам.ЗарезервированоЗаказом, 0) КАК РезервНаСкладах,
	|	ЕСТЬNULL(РезервСделанныйЗаказом.ЗарезервированоЗаказом, 0) КАК ЗарезервированоЗаказом,
	|	ОстаткиВРазрезеСкладов.РезервТекСклад КАК РезервТекСкладОбщий,
	|	ЕСТЬNULL(ОтгрузкаПоРезервам.ОтгрузкаРезерва, 0) КАК ОтгрузкаРезерва,
	|	ЕСТЬNULL(РезервСделанныйЗаказомПоВсемСкладам.ЗарезервированоЗаказом, 0) КАК ЗарезервированоЗаказомВсеСклады
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Заказано КАК Заказано
	|		ПО ВтНоменклатура.НоменклатураЗапасов = Заказано.Номенклатура
	|			И ВтНоменклатура.Характеристика = Заказано.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиВРазрезеСкладов КАК ОстаткиВРазрезеСкладов
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ОстаткиВРазрезеСкладов.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = ОстаткиВРазрезеСкладов.Характеристика
	|			И ВтНоменклатура.Партия = ОстаткиВРазрезеСкладов.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = ОстаткиВРазрезеСкладов.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ Размещено КАК Размещено
	|		ПО ВтНоменклатура.НоменклатураЗапасов = Размещено.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = Размещено.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ Остатки КАК Остатки
	|		ПО ВтНоменклатура.НоменклатураЗапасов = Остатки.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = Остатки.Характеристика
	|			И ВтНоменклатура.Партия = Остатки.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервСделанныйЗаказом КАК РезервСделанныйЗаказом
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РезервСделанныйЗаказом.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = РезервСделанныйЗаказом.Характеристика
	|			И ВтНоменклатура.Партия = РезервСделанныйЗаказом.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = РезервСделанныйЗаказом.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОтгрузкаПоРезервам КАК ОтгрузкаПоРезервам
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ОтгрузкаПоРезервам.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = ОтгрузкаПоРезервам.Характеристика
	|			И ВтНоменклатура.Партия = ОтгрузкаПоРезервам.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервСделанныйЗаказомПоВсемСкладам КАК РезервСделанныйЗаказомПоВсемСкладам
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РезервСделанныйЗаказомПоВсемСкладам.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = РезервСделанныйЗаказомПоВсемСкладам.Характеристика
	|			И ВтНоменклатура.Партия = РезервСделанныйЗаказомПоВсемСкладам.Партия";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаОстаткиИРезервыРасходнаяНакладная()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ТаблицаНоменклатура.Номенклатура КАК НоменклатураЗапасов,
	|	ТаблицаНоменклатура.Характеристика КАК Характеристика,
	|	ТаблицаНоменклатура.Партия КАК Партия,
	|	ТаблицаНоменклатура.Заказ КАК Заказ,
	|	ТаблицаНоменклатура.ЯчейкаДоступна КАК ЯчейкаДоступна,
	|	ТаблицаНоменклатура.Ячейка КАК Ячейка,
	|	ТаблицаНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ ВтНоменклатура
	|ИЗ
	|	&ТаблицаНоменклатура КАК ТаблицаНоменклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ВтНоменклатура.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.Заказ КАК Заказ,
	|	ВтНоменклатура.Партия КАК Партия
	|ПОМЕСТИТЬ ВтНоменклатураБезСклада
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ЗапасыОстаткиРезервы.КоличествоОстаток) КАК РезервНаСкладах,
	|	СУММА(ЗапасыОстаткиОбщие.КоличествоОстаток) КАК ОстатокОбщий,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика КАК Характеристика,
	|	ВтНоменклатураБезСклада.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиРезервы.КоличествоОстаток) КАК РезервНаСкладахИтог,
	|	ВтНоменклатураБезСклада.Заказ КАК Заказ,
	|	СУММА(ЗапасыНаСкладахОстатки.КоличествоОстаток) КАК ОстатокОбщийЯчеестоеХранение
	|ПОМЕСТИТЬ Остатки
	|ИЗ
	|	ВтНоменклатураБезСклада КАК ВтНоменклатураБезСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				ЗаказПокупателя В (&МассивЗаказов)
	|					И Номенклатура В (&Номенклатура)) КАК ЗапасыОстаткиРезервы
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = ЗапасыОстаткиРезервы.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = ЗапасыОстаткиРезервы.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = ЗапасыОстаткиРезервы.Партия
	|			И ВтНоменклатураБезСклада.Заказ = ЗапасыОстаткиРезервы.ЗаказПокупателя
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				Организация = &Организация
	|					И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					И ТИПЗНАЧЕНИЯ(СтруктурнаяЕдиница) = ТИП(Справочник.СтруктурныеЕдиницы)
	|					И СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)
	|					И Номенклатура В (&Номенклатура)) КАК ЗапасыОстаткиОбщие
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = ЗапасыОстаткиОбщие.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = ЗапасыОстаткиОбщие.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = ЗапасыОстаткиОбщие.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыНаСкладах.Остатки(
	|				,
	|				Организация = &Организация
	|					И ТИПЗНАЧЕНИЯ(СтруктурнаяЕдиница) = ТИП(Справочник.СтруктурныеЕдиницы)
	|					И СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)
	|					И Номенклатура В (&Номенклатура)
	|					И СтруктурнаяЕдиница.ОрдерныйСклад = ЛОЖЬ) КАК ЗапасыНаСкладахОстатки
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = ЗапасыНаСкладахОстатки.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = ЗапасыНаСкладахОстатки.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = ЗапасыНаСкладахОстатки.Партия
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатураБезСклада.Партия,
	|	ВтНоменклатураБезСклада.Характеристика,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВтНоменклатура.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.Партия КАК Партия,
	|	ВтНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК ОстатокТекСклад,
	|	СУММА(ЗапасыОстаткиРезервТекСклад.КоличествоОстаток) КАК РезервТекСклад,
	|	ВтНоменклатура.Заказ КАК Заказ,
	|	ЗапасыНаСкладахОстатки.Ячейка КАК Ячейка,
	|	ВЫБОР
	|		КОГДА ВтНоменклатура.ЯчейкаДоступна
	|			ТОГДА ЗапасыНаСкладахОстатки.КоличествоОстаток
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ОстатокТекЯчейка
	|ПОМЕСТИТЬ ОстаткиВРазрезеСкладов
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				Организация = &Организация
	|					И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|					И Номенклатура В (&Номенклатура)) КАК ЗапасыОстатки
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ЗапасыОстатки.Номенклатура
	|			И ВтНоменклатура.Характеристика = ЗапасыОстатки.Характеристика
	|			И ВтНоменклатура.Партия = ЗапасыОстатки.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = ЗапасыОстатки.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
	|				,
	|				ЗаказПокупателя В (&МассивЗаказов)
	|					И Номенклатура В (&Номенклатура)) КАК ЗапасыОстаткиРезервТекСклад
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ЗапасыОстаткиРезервТекСклад.Номенклатура
	|			И ВтНоменклатура.Характеристика = ЗапасыОстаткиРезервТекСклад.Характеристика
	|			И ВтНоменклатура.Партия = ЗапасыОстаткиРезервТекСклад.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = ЗапасыОстаткиРезервТекСклад.СтруктурнаяЕдиница
	|			И ВтНоменклатура.Заказ = ЗапасыОстаткиРезервТекСклад.ЗаказПокупателя
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыНаСкладах.Остатки(
	|				,
	|				Организация = &Организация
	|					И Номенклатура В (&Номенклатура)) КАК ЗапасыНаСкладахОстатки
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ЗапасыНаСкладахОстатки.Номенклатура
	|			И ВтНоменклатура.Характеристика = ЗапасыНаСкладахОстатки.Характеристика
	|			И ВтНоменклатура.Партия = ЗапасыНаСкладахОстатки.Партия
	|			И ВтНоменклатура.Ячейка = ЗапасыНаСкладахОстатки.Ячейка
	|			И ВтНоменклатура.СтруктурнаяЕдиница = ЗапасыНаСкладахОстатки.СтруктурнаяЕдиница
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатура.НоменклатураЗапасов,
	|	ВтНоменклатура.СтруктурнаяЕдиница,
	|	ВтНоменклатура.Характеристика,
	|	ВтНоменклатура.Партия,
	|	ВтНоменклатура.Заказ,
	|	ЗапасыНаСкладахОстатки.Ячейка,
	|	ВЫБОР
	|		КОГДА ВтНоменклатура.ЯчейкаДоступна
	|			ТОГДА ЗапасыНаСкладахОстатки.КоличествоОстаток
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ВтНоменклатура.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	СУММА(ВЫБОР
	|			КОГДА Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Запасы.Количество * -1
	|			ИНАЧЕ Запасы.Количество
	|		КОНЕЦ) КАК ЗарезервированоЗаказом,
	|	ВтНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.Партия КАК Партия,
	|	ВтНоменклатура.Заказ КАК Заказ
	|ПОМЕСТИТЬ РезервСделанныйЗаказом
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК Запасы
	|		ПО ВтНоменклатура.НоменклатураЗапасов = Запасы.Номенклатура
	|			И ВтНоменклатура.Характеристика = Запасы.Характеристика
	|			И ВтНоменклатура.Партия = Запасы.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = Запасы.СтруктурнаяЕдиница
	|			И ВтНоменклатура.Заказ = Запасы.ЗаказПокупателя
	|ГДЕ
	|	Запасы.ЗаказПокупателя В(&МассивЗаказов)
	|	И Запасы.Регистратор В(&МассивЗаказов)
	|	И Запасы.Номенклатура В(&Номенклатура)
	|
	|СГРУППИРОВАТЬ ПО
	|	Запасы.СтруктурнаяЕдиница,
	|	ВтНоменклатура.НоменклатураЗапасов,
	|	ВтНоменклатура.СтруктурнаяЕдиница,
	|	ВтНоменклатура.Характеристика,
	|	ВтНоменклатура.Партия,
	|	ВтНоменклатура.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СУММА(ВЫБОР
	|			КОГДА Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Запасы.Количество * -1
	|			ИНАЧЕ Запасы.Количество
	|		КОНЕЦ) КАК ЗарезервированоЗаказом,
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика КАК Характеристика,
	|	ВтНоменклатураБезСклада.Партия КАК Партия,
	|	ВтНоменклатураБезСклада.Заказ КАК Заказ
	|ПОМЕСТИТЬ РезервСделанныйЗаказомПоВсемСкладам
	|ИЗ
	|	ВтНоменклатураБезСклада КАК ВтНоменклатураБезСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК Запасы
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = Запасы.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = Запасы.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = Запасы.Партия
	|			И ВтНоменклатураБезСклада.Заказ = Запасы.ЗаказПокупателя
	|ГДЕ
	|	Запасы.ЗаказПокупателя В(&МассивЗаказов)
	|	И Запасы.Регистратор В(&МассивЗаказов)
	|	И Запасы.Номенклатура В(&Номенклатура)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика,
	|	ВтНоменклатураБезСклада.Партия,
	|	ВтНоменклатураБезСклада.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика КАК Характеристика,
	|	ВтНоменклатураБезСклада.Партия КАК Партия,
	|	СУММА(Запасы.Количество) КАК СписаноРезерваНакладной,
	|	ВтНоменклатураБезСклада.Заказ КАК Заказ
	|ПОМЕСТИТЬ РасходРезерваПоНакладной
	|ИЗ
	|	ВтНоменклатураБезСклада КАК ВтНоменклатураБезСклада
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК Запасы
	|		ПО ВтНоменклатураБезСклада.НоменклатураЗапасов = Запасы.Номенклатура
	|			И ВтНоменклатураБезСклада.Характеристика = Запасы.Характеристика
	|			И ВтНоменклатураБезСклада.Партия = Запасы.Партия
	|			И ВтНоменклатураБезСклада.Заказ = Запасы.ЗаказПокупателя
	|ГДЕ
	|	Запасы.Регистратор = &Ссылка
	|	И Запасы.ЗаказПокупателя В(&МассивЗаказов)
	|	И Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Запасы.Номенклатура В(&Номенклатура)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатураБезСклада.НоменклатураЗапасов,
	|	ВтНоменклатураБезСклада.Характеристика,
	|	ВтНоменклатураБезСклада.Партия,
	|	ВтНоменклатураБезСклада.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(Запасы.Количество) КАК СписаноРезерваНакладной,
	|	ВтНоменклатура.НоменклатураЗапасов КАК НоменклатураЗапасов,
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.Партия КАК Партия,
	|	ВтНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВтНоменклатура.Заказ КАК Заказ,
	|	ВтНоменклатура.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ РасходРезерваПоНакладнойПоСкладам
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы КАК Запасы
	|		ПО ВтНоменклатура.Характеристика = Запасы.Характеристика
	|			И ВтНоменклатура.Партия = Запасы.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = Запасы.СтруктурнаяЕдиница
	|			И ВтНоменклатура.Заказ = Запасы.ЗаказПокупателя
	|			И ВтНоменклатура.НоменклатураЗапасов = Запасы.Номенклатура
	|ГДЕ
	|	Запасы.Регистратор = &Ссылка
	|	И Запасы.ЗаказПокупателя В(&МассивЗаказов)
	|	И Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Запасы.Номенклатура В(&Номенклатура)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтНоменклатура.НоменклатураЗапасов,
	|	ВтНоменклатура.Партия,
	|	ВтНоменклатура.СтруктурнаяЕдиница,
	|	ВтНоменклатура.Характеристика,
	|	ВтНоменклатура.Заказ,
	|	ВтНоменклатура.Ячейка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(Запасы.Количество) КАК СписаноНакладной,
	|	Запасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	Запасы.Номенклатура КАК Номенклатура,
	|	Запасы.Характеристика КАК Характеристика,
	|	Запасы.Партия КАК Партия
	|ПОМЕСТИТЬ РасходБезРезерваПоНакладнойПоСкладам
	|ИЗ
	|	РегистрНакопления.Запасы КАК Запасы
	|ГДЕ
	|	Запасы.Регистратор = &Ссылка
	|	И Запасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	И Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Запасы.Номенклатура В(&Номенклатура)
	|
	|СГРУППИРОВАТЬ ПО
	|	Запасы.Номенклатура,
	|	Запасы.Характеристика,
	|	Запасы.СтруктурнаяЕдиница,
	|	Запасы.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(Запасы.Количество) КАК СписаноНакладной,
	|	Запасы.Номенклатура КАК Номенклатура,
	|	Запасы.Характеристика КАК Характеристика,
	|	Запасы.Партия КАК Партия
	|ПОМЕСТИТЬ РасходБезРезерваПоНакладнойВсего
	|ИЗ
	|	РегистрНакопления.Запасы КАК Запасы
	|ГДЕ
	|	Запасы.Регистратор = &Ссылка
	|	И Запасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	И Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Запасы.Номенклатура В(&Номенклатура)
	|
	|СГРУППИРОВАТЬ ПО
	|	Запасы.Номенклатура,
	|	Запасы.Характеристика,
	|	Запасы.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ЗапасыНаСкладах.Количество) КАК СписаноНакладной,
	|	ЗапасыНаСкладах.Номенклатура КАК Номенклатура,
	|	ЗапасыНаСкладах.Характеристика КАК Характеристика,
	|	ЗапасыНаСкладах.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ЗапасыНаСкладах.Ячейка КАК Ячейка,
	|	ЗапасыНаСкладах.Партия КАК Партия
	|ПОМЕСТИТЬ РасходБезРезерваПоЯчейкам
	|ИЗ
	|	РегистрНакопления.ЗапасыНаСкладах КАК ЗапасыНаСкладах
	|ГДЕ
	|	ЗапасыНаСкладах.Регистратор = &Ссылка
	|	И ЗапасыНаСкладах.Номенклатура В(&Номенклатура)
	|	И ЗапасыНаСкладах.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыНаСкладах.Номенклатура,
	|	ЗапасыНаСкладах.Характеристика,
	|	ЗапасыНаСкладах.СтруктурнаяЕдиница,
	|	ЗапасыНаСкладах.Ячейка,
	|	ЗапасыНаСкладах.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ЗапасыНаСкладах.Количество) КАК СписаноНакладной,
	|	ЗапасыНаСкладах.Номенклатура КАК Номенклатура,
	|	ЗапасыНаСкладах.Характеристика КАК Характеристика,
	|	ЗапасыНаСкладах.Партия КАК Партия
	|ПОМЕСТИТЬ РасходБезРезерваПоЯчейкамВсего
	|ИЗ
	|	РегистрНакопления.ЗапасыНаСкладах КАК ЗапасыНаСкладах
	|ГДЕ
	|	ЗапасыНаСкладах.Регистратор = &Ссылка
	|	И ЗапасыНаСкладах.Номенклатура В(&Номенклатура)
	|	И ЗапасыНаСкладах.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыНаСкладах.Номенклатура,
	|	ЗапасыНаСкладах.Характеристика,
	|	ЗапасыНаСкладах.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыОстатки.Партия КАК Партия,
	|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК ОбщийРезерв
	|ПОМЕСТИТЬ ОбщийРезервПоНоменклатуре
	|ИЗ
	|	РегистрНакопления.Запасы.Остатки(
	|			,
	|			Организация = &Организация
	|				И НЕ ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|				И ТИПЗНАЧЕНИЯ(СтруктурнаяЕдиница) = ТИП(Справочник.СтруктурныеЕдиницы)
	|				И СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)
	|				И Номенклатура В (&Номенклатура)) КАК ЗапасыОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстатки.Номенклатура,
	|	ЗапасыОстатки.Характеристика,
	|	ЗапасыОстатки.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ВтНоменклатура.Характеристика КАК Характеристика,
	|	ВтНоменклатура.НоменклатураЗапасов КАК Номенклатура,
	|	ВтНоменклатура.Партия КАК Партия,
	|	ВтНоменклатура.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(Остатки.ОстатокОбщий, 0) + ЕСТЬNULL(РасходБезРезерваПоНакладнойВсего.СписаноНакладной, 0) КАК ОстатокОбщий,
	|	ЕСТЬNULL(Остатки.РезервНаСкладахИтог, 0) КАК РезервНаСкладахИтог,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.РезервТекСклад, 0) КАК РезервТекСкладИтог,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.РезервТекСклад, 0) - ЕСТЬNULL(РезервСделанныйЗаказом.ЗарезервированоЗаказом, 0) КАК РезервТекСклад,
	|	ЕСТЬNULL(Остатки.РезервНаСкладах, 0) - ЕСТЬNULL(РезервСделанныйЗаказомПоВсемСкладам.ЗарезервированоЗаказом, 0) КАК РезервНаСкладах,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.РезервТекСклад, 0) КАК РезервТекСкладОбщий,
	|	ЕСТЬNULL(РезервСделанныйЗаказомПоВсемСкладам.ЗарезервированоЗаказом, 0) КАК ЗарезервированоЗаказомВсеСклады,
	|	ЕСТЬNULL(РасходРезерваПоНакладной.СписаноРезерваНакладной, 0) КАК СписаноРезерваНакладной,
	|	ЕСТЬNULL(РасходРезерваПоНакладнойПоСкладам.СписаноРезерваНакладной, 0) КАК СписаноРезерваНакладнойТекСклад,
	|	ВтНоменклатура.Заказ КАК Заказ,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.ОстатокТекСклад, 0) + ЕСТЬNULL(РасходБезРезерваПоНакладнойПоСкладам.СписаноНакладной, 0) КАК ОстатокТекСклад,
	|	ВтНоменклатура.Ячейка КАК Ячейка,
	|	ЕСТЬNULL(Остатки.ОстатокОбщий, 0) КАК ОстатокОбщийОрдерныеСклады,
	|	ЕСТЬNULL(Остатки.ОстатокОбщийЯчеестоеХранение, 0) КАК ОстатокОбщийЯчеистыеСклады,
	|	ЕСТЬNULL(ОстаткиВРазрезеСкладов.ОстатокТекСклад, 0) КАК ТекущийОстатокПоСкладу,
	|	0 КАК КоличествоСтрок,
	|	0 КАК КоличествоПроходов,
	|	РасходБезРезерваПоНакладнойПоСкладам.СписаноНакладной КАК РасходОрдерныеСклады,
	|	РасходБезРезерваПоЯчейкам.СписаноНакладной КАК РасходЯчеистыеСклады,
	|	ВЫБОР
	|		КОГДА ВтНоменклатура.ЯчейкаДоступна
	|			ТОГДА ЕСТЬNULL(ОстаткиВРазрезеСкладов.ОстатокТекЯчейка, 0) + ЕСТЬNULL(РасходБезРезерваПоЯчейкам.СписаноНакладной, 0)
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ОстатокВЯчейке
	|ИЗ
	|	ВтНоменклатура КАК ВтНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиВРазрезеСкладов КАК ОстаткиВРазрезеСкладов
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ОстаткиВРазрезеСкладов.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = ОстаткиВРазрезеСкладов.Характеристика
	|			И ВтНоменклатура.Партия = ОстаткиВРазрезеСкладов.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = ОстаткиВРазрезеСкладов.СтруктурнаяЕдиница
	|			И ВтНоменклатура.Заказ = ОстаткиВРазрезеСкладов.Заказ
	|			И ВтНоменклатура.Ячейка = ОстаткиВРазрезеСкладов.Ячейка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Остатки КАК Остатки
	|		ПО ВтНоменклатура.НоменклатураЗапасов = Остатки.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = Остатки.Характеристика
	|			И ВтНоменклатура.Партия = Остатки.Партия
	|			И ВтНоменклатура.Заказ = Остатки.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервСделанныйЗаказом КАК РезервСделанныйЗаказом
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РезервСделанныйЗаказом.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = РезервСделанныйЗаказом.Характеристика
	|			И ВтНоменклатура.Партия = РезервСделанныйЗаказом.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = РезервСделанныйЗаказом.СтруктурнаяЕдиница
	|			И ВтНоменклатура.Заказ = РезервСделанныйЗаказом.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервСделанныйЗаказомПоВсемСкладам КАК РезервСделанныйЗаказомПоВсемСкладам
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РезервСделанныйЗаказомПоВсемСкладам.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = РезервСделанныйЗаказомПоВсемСкладам.Характеристика
	|			И ВтНоменклатура.Партия = РезервСделанныйЗаказомПоВсемСкладам.Партия
	|			И ВтНоменклатура.Заказ = РезервСделанныйЗаказомПоВсемСкладам.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РасходРезерваПоНакладной КАК РасходРезерваПоНакладной
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РасходРезерваПоНакладной.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = РасходРезерваПоНакладной.Характеристика
	|			И ВтНоменклатура.Партия = РасходРезерваПоНакладной.Партия
	|			И ВтНоменклатура.Заказ = РасходРезерваПоНакладной.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РасходРезерваПоНакладнойПоСкладам КАК РасходРезерваПоНакладнойПоСкладам
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РасходРезерваПоНакладнойПоСкладам.НоменклатураЗапасов
	|			И ВтНоменклатура.Характеристика = РасходРезерваПоНакладнойПоСкладам.Характеристика
	|			И ВтНоменклатура.Партия = РасходРезерваПоНакладнойПоСкладам.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = РасходРезерваПоНакладнойПоСкладам.СтруктурнаяЕдиница
	|			И ВтНоменклатура.Заказ = РасходРезерваПоНакладнойПоСкладам.Заказ
	|			И ВтНоменклатура.Ячейка = РасходРезерваПоНакладнойПоСкладам.Ячейка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РасходБезРезерваПоНакладнойПоСкладам КАК РасходБезРезерваПоНакладнойПоСкладам
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РасходБезРезерваПоНакладнойПоСкладам.Номенклатура
	|			И ВтНоменклатура.Характеристика = РасходБезРезерваПоНакладнойПоСкладам.Характеристика
	|			И ВтНоменклатура.Партия = РасходБезРезерваПоНакладнойПоСкладам.Партия
	|			И ВтНоменклатура.СтруктурнаяЕдиница = РасходБезРезерваПоНакладнойПоСкладам.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОбщийРезервПоНоменклатуре КАК ОбщийРезервПоНоменклатуре
	|		ПО ВтНоменклатура.НоменклатураЗапасов = ОбщийРезервПоНоменклатуре.Номенклатура
	|			И ВтНоменклатура.Характеристика = ОбщийРезервПоНоменклатуре.Характеристика
	|			И ВтНоменклатура.Партия = ОбщийРезервПоНоменклатуре.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ РасходБезРезерваПоЯчейкам КАК РасходБезРезерваПоЯчейкам
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РасходБезРезерваПоЯчейкам.Номенклатура
	|			И ВтНоменклатура.Характеристика = РасходБезРезерваПоЯчейкам.Характеристика
	|			И ВтНоменклатура.Партия = РасходБезРезерваПоЯчейкам.Партия
	|			И ВтНоменклатура.Ячейка = РасходБезРезерваПоЯчейкам.Ячейка
	|			И ВтНоменклатура.СтруктурнаяЕдиница = РасходБезРезерваПоЯчейкам.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ РасходБезРезерваПоЯчейкамВсего КАК РасходБезРезерваПоЯчейкамВсего
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РасходБезРезерваПоЯчейкамВсего.Номенклатура
	|			И ВтНоменклатура.Характеристика = РасходБезРезерваПоЯчейкамВсего.Характеристика
	|			И ВтНоменклатура.Партия = РасходБезРезерваПоЯчейкамВсего.Партия
	|		ЛЕВОЕ СОЕДИНЕНИЕ РасходБезРезерваПоНакладнойВсего КАК РасходБезРезерваПоНакладнойВсего
	|		ПО ВтНоменклатура.НоменклатураЗапасов = РасходБезРезерваПоНакладнойВсего.Номенклатура
	|			И ВтНоменклатура.Партия = РасходБезРезерваПоНакладнойВсего.Партия
	|			И ВтНоменклатура.Характеристика = РасходБезРезерваПоНакладнойВсего.Характеристика";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаЗаказано()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК Ссылка,
	|	СУММА(РазмещениеЗаказовОстатки.КоличествоОстаток) КАК Количество,
	|	ТИПЗНАЧЕНИЯ(РазмещениеЗаказовОстатки.ИсточникОбеспечения) КАК ТипДокумента,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(РазмещениеЗаказовОстатки.ИсточникОбеспечения) = ТИП(Документ.ЗаказНаПроизводство)
	|			ТОГДА РазмещениеЗаказовОстатки.ИсточникОбеспечения.Финиш
	|		ИНАЧЕ РазмещениеЗаказовОстатки.ИсточникОбеспечения.ДатаПоступления
	|	КОНЕЦ КАК ДатаПоступления
	|ИЗ
	|	РегистрНакопления.РазмещениеЗаказов.Остатки(
	|			,
	|			ЗаказПокупателя = &ЗаказПокупателя
	|				И Номенклатура = &Номенклатура
	|				И Характеристика = &Характеристика) КАК РазмещениеЗаказовОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	РазмещениеЗаказовОстатки.ИсточникОбеспечения,
	|	ТИПЗНАЧЕНИЯ(РазмещениеЗаказовОстатки.ИсточникОбеспечения),
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(РазмещениеЗаказовОстатки.ИсточникОбеспечения) = ТИП(Документ.ЗаказНаПроизводство)
	|			ТОГДА РазмещениеЗаказовОстатки.ИсточникОбеспечения.Финиш
	|		ИНАЧЕ РазмещениеЗаказовОстатки.ИсточникОбеспечения.ДатаПоступления
	|	КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	Количество УБЫВ,
	|	ТипДокумента,
	|	Ссылка";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаЗапасыПоступления()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВложенныйЗапрос.Количество КАК Количество,
	|	ВложенныйЗапрос.Ссылка КАК Ссылка,
	|	ВложенныйЗапрос.ДатаПоступления КАК ДатаПоступления
	|ИЗ
	|	(ВЫБРАТЬ
	|		СУММА(ЗаказыПоставщикамОстатки.КоличествоОстаток) КАК Количество,
	|		ЗаказыПоставщикамОстатки.ЗаказПоставщику КАК Ссылка,
	|		ВложенныйЗапрос.Период КАК ДатаПоступления
	|	ИЗ
	|		РегистрНакопления.ЗаказыПоставщикам.Остатки(
	|				,
	|				Организация = &Организация
	|					И Номенклатура = &Номенклатура
	|					И Характеристика = &Характеристика
	|					И НЕ ЗаказПоставщику В
	|							(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|								РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК ИсточникОбеспечения
	|							ИЗ
	|								РегистрНакопления.РазмещениеЗаказов.Остатки(, Номенклатура = &Номенклатура
	|									И Характеристика = &Характеристика) КАК РазмещениеЗаказовОстатки)) КАК ЗаказыПоставщикамОстатки
	|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|				МАКСИМУМ(ГрафикДвиженияЗапасов.Период) КАК Период,
	|				ГрафикДвиженияЗапасов.Заказ КАК Заказ,
	|				ГрафикДвиженияЗапасов.Номенклатура КАК Номенклатура,
	|				ГрафикДвиженияЗапасов.Характеристика КАК Характеристика
	|			ИЗ
	|				РегистрНакопления.ГрафикДвиженияЗапасов КАК ГрафикДвиженияЗапасов
	|			ГДЕ
	|				ГрафикДвиженияЗапасов.Номенклатура = &Номенклатура
	|				И ГрафикДвиженияЗапасов.Характеристика = &Характеристика
	|				И НЕ ГрафикДвиженияЗапасов.Заказ В
	|							(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|								РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК ИсточникОбеспечения
	|							ИЗ
	|								РегистрНакопления.РазмещениеЗаказов.Остатки(, Номенклатура = &Номенклатура
	|									И Характеристика = &Характеристика) КАК РазмещениеЗаказовОстатки)
	|				И ГрафикДвиженияЗапасов.Организация = &Организация
	|			
	|			СГРУППИРОВАТЬ ПО
	|				ГрафикДвиженияЗапасов.Характеристика,
	|				ГрафикДвиженияЗапасов.Заказ,
	|				ГрафикДвиженияЗапасов.Номенклатура) КАК ВложенныйЗапрос
	|			ПО ЗаказыПоставщикамОстатки.ЗаказПоставщику = ВложенныйЗапрос.Заказ
	|				И ЗаказыПоставщикамОстатки.Номенклатура = ВложенныйЗапрос.Номенклатура
	|				И ЗаказыПоставщикамОстатки.Характеристика = ВложенныйЗапрос.Характеристика
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ЗаказыПоставщикамОстатки.ЗаказПоставщику,
	|		ВложенныйЗапрос.Период
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		СУММА(ЗаказыНаПроизводствоОстатки.КоличествоОстаток),
	|		ЗаказыНаПроизводствоОстатки.ЗаказНаПроизводство,
	|		ЗаказыНаПроизводствоОстатки.ЗаказНаПроизводство.Финиш
	|	ИЗ
	|		РегистрНакопления.ЗаказыНаПроизводство.Остатки(
	|				,
	|				Организация = &Организация
	|					И Номенклатура = &Номенклатура
	|					И Характеристика = &Характеристика
	|					И НЕ ЗаказНаПроизводство В
	|							(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|								РазмещениеЗаказовОстатки.ИсточникОбеспечения КАК ИсточникОбеспечения
	|							ИЗ
	|								РегистрНакопления.РазмещениеЗаказов.Остатки(, Номенклатура = &Номенклатура
	|									И Характеристика = &Характеристика) КАК РазмещениеЗаказовОстатки)) КАК ЗаказыНаПроизводствоОстатки
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ЗаказыНаПроизводствоОстатки.ЗаказНаПроизводство,
	|		ЗаказыНаПроизводствоОстатки.ЗаказНаПроизводство.Финиш) КАК ВложенныйЗапрос
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаПоступления";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаОстаток()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Запасы.Регистратор КАК Регистратор,
	|	СУММА(ВЫБОР
	|			КОГДА Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Запасы.Количество * -1
	|			ИНАЧЕ Запасы.Количество
	|		КОНЕЦ) КАК Количество,
	|	Запасы.СтруктурнаяЕдиница КАК Склад
	|ИЗ
	|	РегистрНакопления.Запасы КАК Запасы
	|ГДЕ
	|	Запасы.ЗаказПокупателя = &ЗаказПокупателя
	|	И Запасы.Номенклатура = &Номенклатура
	|	И Запасы.Характеристика = &Характеристика
	|	И Запасы.Партия = &Партия
	|	И Запасы.СтруктурнаяЕдиница = &Склад
	|
	|СГРУППИРОВАТЬ ПО
	|	Запасы.Регистратор,
	|	Запасы.СтруктурнаяЕдиница
	|
	|УПОРЯДОЧИТЬ ПО
	|	Количество УБЫВ,
	|	Регистратор";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаЗапасыВРезервеПоСкладам()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК Количество,
	|	ЗапасыОстатки.СтруктурнаяЕдиница КАК Склад
	|ИЗ
	|	РегистрНакопления.Запасы.Остатки(
	|			,
	|			Номенклатура = &Номенклатура
	|				И ЗаказПокупателя = &ЗаказПокупателя
	|				И Организация = &Организация
	|				И Характеристика = &Характеристика
	|				И Партия = &Партия) КАК ЗапасыОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстатки.СтруктурнаяЕдиница
	|
	|УПОРЯДОЧИТЬ ПО
	|	Количество УБЫВ";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаОстаткиОбщие(ЕстьСсылка = Ложь, ЭтоЗаказ = Истина)
	
	Если ЕстьСсылка Тогда
		
		Если ЭтоЗаказ Тогда
			
			ТекстЗапроса =
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	СтруктурныеЕдиницы.Ссылка КАК СтруктурнаяЕдиница
			|ПОМЕСТИТЬ Склады
			|ИЗ
			|	Справочник.СтруктурныеЕдиницы КАК СтруктурныеЕдиницы
			|ГДЕ
			|	СтруктурныеЕдиницы.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК Количество,
			|	ЗапасыОстатки.СтруктурнаяЕдиница КАК Склад
			|ПОМЕСТИТЬ Остатки
			|ИЗ
			|	РегистрНакопления.Запасы.Остатки(
			|			,
			|			Организация = &Организация
			|				И Номенклатура = &Номенклатура
			|				И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
			|				И Организация = &Организация
			|				И Характеристика = &Характеристика
			|				И Партия = &Партия
			|				И СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)) КАК ЗапасыОстатки
			|
			|СГРУППИРОВАТЬ ПО
			|	ЗапасыОстатки.СтруктурнаяЕдиница
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	Запасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	СУММА(ВЫБОР
			|			КОГДА Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|				ТОГДА Запасы.Количество * -1
			|			ИНАЧЕ Запасы.Количество
			|		КОНЕЦ) КАК ЗарезервированоЗаказом
			|ПОМЕСТИТЬ РезервСделанныйЗаказом
			|ИЗ
			|	РегистрНакопления.Запасы КАК Запасы
			|ГДЕ
			|	Запасы.Регистратор = &ЗаказПокупателя
			|	И Запасы.ЗаказПокупателя = &ЗаказПокупателя
			|	И Запасы.Номенклатура = &Номенклатура
			|	И Запасы.Характеристика = &Характеристика
			|	И Запасы.Партия = &Партия
			|
			|СГРУППИРОВАТЬ ПО
			|	Запасы.СтруктурнаяЕдиница
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЕСТЬNULL(Остатки.Количество, 0) КАК Количество,
			|	ЕСТЬNULL(РезервСделанныйЗаказом.ЗарезервированоЗаказом, 0) КАК ЗарезервированоЗаказом,
			|	Склады.СтруктурнаяЕдиница КАК Склад
			|ИЗ
			|	Склады КАК Склады
			|		ЛЕВОЕ СОЕДИНЕНИЕ Остатки КАК Остатки
			|		ПО Склады.СтруктурнаяЕдиница = Остатки.Склад
			|		ЛЕВОЕ СОЕДИНЕНИЕ РезервСделанныйЗаказом КАК РезервСделанныйЗаказом
			|		ПО Склады.СтруктурнаяЕдиница = РезервСделанныйЗаказом.СтруктурнаяЕдиница";
			
		Иначе
			ТекстЗапроса =
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	СтруктурныеЕдиницы.Ссылка КАК СтруктурнаяЕдиница
			|ПОМЕСТИТЬ Склады
			|ИЗ
			|	Справочник.СтруктурныеЕдиницы КАК СтруктурныеЕдиницы
			|ГДЕ
			|	СтруктурныеЕдиницы.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК Количество,
			|	ЗапасыОстатки.СтруктурнаяЕдиница КАК Склад
			|ПОМЕСТИТЬ Остатки
			|ИЗ
			|	РегистрНакопления.Запасы.Остатки(
			|			,
			|			Организация = &Организация
			|				И Номенклатура = &Номенклатура
			|				И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
			|				И Характеристика = &Характеристика
			|				И Партия = &Партия
			|				И СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)) КАК ЗапасыОстатки
			|
			|СГРУППИРОВАТЬ ПО
			|	ЗапасыОстатки.СтруктурнаяЕдиница
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	Запасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	СУММА(Запасы.Количество) КАК ЗарезервированоЗаказом
			|ПОМЕСТИТЬ ДвижениеПоНакладнойБезРезерва
			|ИЗ
			|	РегистрНакопления.Запасы КАК Запасы
			|ГДЕ
			|	Запасы.Регистратор = &Ссылка
			|	И Запасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
			|	И Запасы.Номенклатура = &Номенклатура
			|	И Запасы.Характеристика = &Характеристика
			|	И Запасы.Партия = &Партия
			|	И Запасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
			|
			|СГРУППИРОВАТЬ ПО
			|	Запасы.СтруктурнаяЕдиница
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЕСТЬNULL(Остатки.Количество, 0) КАК Количество,
			|	ЕСТЬNULL(РезервСделанныйЗаказом.ЗарезервированоЗаказом, 0) КАК ЗарезервированоЗаказом,
			|	Склады.СтруктурнаяЕдиница КАК Склад
			|ИЗ
			|	Склады КАК Склады
			|		ЛЕВОЕ СОЕДИНЕНИЕ Остатки КАК Остатки
			|		ПО Склады.СтруктурнаяЕдиница = Остатки.Склад
			|		ЛЕВОЕ СОЕДИНЕНИЕ ДвижениеПоНакладнойБезРезерва КАК РезервСделанныйЗаказом
			|		ПО Склады.СтруктурнаяЕдиница = РезервСделанныйЗаказом.СтруктурнаяЕдиница
			|
			|УПОРЯДОЧИТЬ ПО
			|	Склад,
			|	Количество УБЫВ";
			
			
			
		КонецЕсли;
		
	Иначе
		
		ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК Количество,
		|	ЗапасыОстатки.СтруктурнаяЕдиница КАК Склад,
		|	0 КАК ЗарезервированоЗаказом
		|ИЗ
		|	РегистрНакопления.Запасы.Остатки(
		|			,
		|			Организация = &Организация
		|				И Номенклатура = &Номенклатура
		|				И ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|				И Организация = &Организация
		|				И Характеристика = &Характеристика
		|				И Партия = &Партия
		|				И СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы = ЗНАЧЕНИЕ(Перечисление.ТипыСтруктурныхЕдиниц.Склад)) КАК ЗапасыОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗапасыОстатки.СтруктурнаяЕдиница
		|
		|УПОРЯДОЧИТЬ ПО
		|	Количество УБЫВ";
		
	КонецЕсли;
	
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция СформироватьПредставлениеКоличества(ОбрабатываемоеЧисло, ДлинаЧисла)
	
	СтрокаДляДополнения = Формат(ОбрабатываемоеЧисло, "ЧЦ=10; ЧДЦ=3");
	ДлинаТекЧисла = СтрДлина(Формат(ОбрабатываемоеЧисло, "ЧДЦ=0"));
	
	Если ДлинаТекЧисла = ДлинаЧисла Тогда Возврат СтрокаДляДополнения КонецЕсли;
	
	Для НомерПробела = ДлинаТекЧисла по ДлинаЧисла Цикл
		СтрокаДляДополнения = " " + СтрокаДляДополнения;
	КонецЦикла;
	
	Возврат СтрокаДляДополнения;
	
КонецФункции

Функция НайденаСтрокаСТакимЖеСкладомОбработанаТекущаяИУдалена(СтрокиКУдалению, СтрокаЗапасы, МассивОбработанныхСтрок)
	
	ИмяКолонкиРезерв = ?(СтрокаЗапасы.Свойство("СтруктурнаяЕдиницаРезерв"), "СтруктурнаяЕдиницаРезерв", "СтруктурнаяЕдиница");
	
	Для Каждого СтрокаМассива из МассивОбработанныхСтрок Цикл
		
		Если СтрокаЗапасы[ИмяКолонкиРезерв] = СтрокаМассива[ИмяКолонкиРезерв]
			и СтрокаЗапасы.Цена = СтрокаМассива.Цена Тогда
			
			СтрокаМассива.Количество = СтрокаМассива.Количество + СтрокаЗапасы.Количество;
			СтрокаМассива.Резерв = СтрокаМассива.Резерв + СтрокаЗапасы.Резерв;
			
			СтрокиКУдалению.Добавить(СтрокаЗапасы);
			Возврат Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция НайденИУдаленДубльТекущейСтроки(СтрокиКУдалению, СтрокаЗапасы, МассивОбработанныхСтрок, УчитыватьЯчейку = Ложь)
	
	ИмяКолонки =  "СтруктурнаяЕдиница";
	
	Если Не УчитыватьЯчейку Тогда
		
		Для Каждого СтрокаМассива из МассивОбработанныхСтрок Цикл
			
			Если СтрокаЗапасы[ИмяКолонки] = СтрокаМассива[ИмяКолонки]
				и СтрокаЗапасы.Цена = СтрокаМассива.Цена 
				и СтрокаЗапасы.ЕдиницаИзмерения = СтрокаМассива.ЕдиницаИзмерения Тогда
				
				СтрокиКУдалению.Добавить(СтрокаЗапасы);
				Возврат Истина;
			КонецЕсли;
			
		КонецЦикла;
		
	Иначе
		Для Каждого СтрокаМассива из МассивОбработанныхСтрок Цикл
			
			Если СтрокаЗапасы[ИмяКолонки] = СтрокаМассива[ИмяКолонки]
				и СтрокаЗапасы["Ячейка"] = СтрокаМассива["Ячейка"]
				и СтрокаЗапасы.Цена = СтрокаМассива.Цена
				и СтрокаЗапасы.ЕдиницаИзмерения = СтрокаМассива.ЕдиницаИзмерения Тогда
				
				СтрокиКУдалению.Добавить(СтрокаЗапасы);
				Возврат Истина;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Процедура ПодготовитьТаблицуСогласноПриоритетам(ТаблицаОстатков, СтруктурнаяЕдиницаОтгрузки)
	
	Если Не ЗначениеЗаполнено(СтруктурнаяЕдиницаОтгрузки) Тогда 
		
		ТаблицаОстатков.Сортировать("КоличествоОстаток Убыв");
		Возврат 
	КонецЕсли;
	
	Для Каждого СтрокаОстатка из ТаблицаОстатков Цикл
		СтрокаОстатка.Приоритет = ?(СтрокаОстатка.СтруктурнаяЕдиница = СтруктурнаяЕдиницаОтгрузки, 0, СтрокаОстатка.Приоритет);
	КонецЦикла;
	
	ТаблицаОстатков.Сортировать("Приоритет Возр");
	
КонецПроцедуры

Процедура ОчиститьПриоритеты(ТаблицаОстатков)
	
	Для Каждого СтрокаОстатка из ТаблицаОстатков Цикл
		СтрокаОстатка.Приоритет = ?(Не СтрокаОстатка.Приоритет = 1, 2, СтрокаОстатка.Приоритет);
	КонецЦикла;
	
КонецПроцедуры

Функция ОстаткиПоЯчейкам(СтруктураПараметров, ТаблицаЗапасы)
	
	Заказы = ТаблицаЗапасы.Скопировать(,"Заказ");
	Заказы.Свернуть("Заказ");
	
	ТаблицаНоменклатуры = ТаблицаЗапасы.Скопировать();
	ТаблицаНоменклатуры.Свернуть("Номенклатура, Характеристика, Партия");
	
	ТаблицаЗапасы.Свернуть("Номенклатура, Характеристика, Партия");
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Организация", СтруктураПараметров.Организация);
	Запрос.УстановитьПараметр("Номенклатура", СтруктураПараметров.Номенклатура);
	Запрос.УстановитьПараметр("ТаблицаЗапасы", ТаблицаЗапасы);
	Запрос.УстановитьПараметр("Регистратор", СтруктураПараметров.Регистратор);
	Запрос.УстановитьПараметр("Заказы", Заказы);
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ЕСТЬNULL(ТаблицаЗапасы.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК Характеристика,
	|	ЕСТЬNULL(ТаблицаЗапасы.Партия, ЗНАЧЕНИЕ(Справочник.ПартииНоменклатуры.ПустаяСсылка)) КАК Партия
	|ПОМЕСТИТЬ ТаблицаОстатков
	|ИЗ
	|	&ТаблицаЗапасы КАК ТаблицаЗапасы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапасыОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыОстатки.Партия КАК Партия,
	|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК КоличествоОстаток
	|ПОМЕСТИТЬ РезервПоСкладу
	|ИЗ
	|	РегистрНакопления.Запасы.Остатки(
	|			,
	|			Организация = &Организация
	|				И Номенклатура В (&Номенклатура)
	|				И НЕ ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|				И НЕ ЗаказПокупателя В (&Заказы)) КАК ЗапасыОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстатки.Партия,
	|	ЗапасыОстатки.СтруктурнаяЕдиница,
	|	ЗапасыОстатки.Характеристика,
	|	ЗапасыОстатки.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВЫБОР
	|		КОГДА ЗапасыНаСкладахОстатки.СтруктурнаяЕдиница.ОрдерныйСклад
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ЗапасыНаСкладахОстатки.Ячейка
	|	КОНЕЦ КАК Ячейка,
	|	ЗапасыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыНаСкладахОстатки.Характеристика КАК Характеристика,
	|	ЗапасыНаСкладахОстатки.Партия КАК Партия,
	|	ЗапасыНаСкладахОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	СУММА(ЗапасыНаСкладахОстатки.КоличествоОстаток) КАК КоличествоОстаток
	|ПОМЕСТИТЬ ОстаткиПоЯчейкам
	|ИЗ
	|	РегистрНакопления.ЗапасыНаСкладах.Остатки(
	|			,
	|			Организация = &Организация
	|				И Номенклатура В (&Номенклатура)) КАК ЗапасыНаСкладахОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыНаСкладахОстатки.Партия,
	|	ЗапасыНаСкладахОстатки.Характеристика,
	|	ЗапасыНаСкладахОстатки.СтруктурнаяЕдиница,
	|	ЗапасыНаСкладахОстатки.Номенклатура,
	|	ВЫБОР
	|		КОГДА ЗапасыНаСкладахОстатки.СтруктурнаяЕдиница.ОрдерныйСклад
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ЗапасыНаСкладахОстатки.Ячейка
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапасыНаСкладах.Номенклатура КАК Номенклатура,
	|	ЗапасыНаСкладах.Характеристика КАК Характеристика,
	|	ЗапасыНаСкладах.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыНаСкладах.СтруктурнаяЕдиница.ОрдерныйСклад
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ЗапасыНаСкладах.Ячейка
	|	КОНЕЦ КАК Ячейка,
	|	СУММА(ЗапасыНаСкладах.Количество) КАК Количество,
	|	ЗапасыНаСкладах.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ РасходПоЯчейкам
	|ИЗ
	|	РегистрНакопления.ЗапасыНаСкладах КАК ЗапасыНаСкладах
	|ГДЕ
	|	ЗапасыНаСкладах.Регистратор = &Регистратор
	|	И ЗапасыНаСкладах.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыНаСкладах.Партия,
	|	ЗапасыНаСкладах.Характеристика,
	|	ЗапасыНаСкладах.Номенклатура,
	|	ЗапасыНаСкладах.СтруктурнаяЕдиница,
	|	ВЫБОР
	|		КОГДА ЗапасыНаСкладах.СтруктурнаяЕдиница.ОрдерныйСклад
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ЗапасыНаСкладах.Ячейка
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОстаткиПоЯчейкам.Номенклатура КАК Номенклатура,
	|	ОстаткиПоЯчейкам.Характеристика КАК Характеристика,
	|	ОстаткиПоЯчейкам.Партия КАК Партия,
	|	ОстаткиПоЯчейкам.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ОстаткиПоЯчейкам.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ Ячейки
	|ИЗ
	|	ОстаткиПоЯчейкам КАК ОстаткиПоЯчейкам
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РасходПоЯчейкам.Номенклатура,
	|	РасходПоЯчейкам.Характеристика,
	|	РасходПоЯчейкам.Партия,
	|	РасходПоЯчейкам.СтруктурнаяЕдиница,
	|	РасходПоЯчейкам.Ячейка
	|ИЗ
	|	РасходПоЯчейкам КАК РасходПоЯчейкам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ТаблицаОстатков.Номенклатура КАК Номенклатура,
	|	ТаблицаОстатков.Характеристика КАК Характеристика,
	|	ТаблицаОстатков.Партия КАК Партия,
	|	Ячейки.Ячейка КАК Ячейка,
	|	Ячейки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ НоменклатураПоЯчейкам
	|ИЗ
	|	ТаблицаОстатков КАК ТаблицаОстатков
	|		ЛЕВОЕ СОЕДИНЕНИЕ Ячейки КАК Ячейки
	|		ПО ТаблицаОстатков.Номенклатура = Ячейки.Номенклатура
	|			И ТаблицаОстатков.Характеристика = Ячейки.Характеристика
	|			И ТаблицаОстатков.Партия = Ячейки.Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НоменклатураПоЯчейкам.Номенклатура КАК Номенклатура,
	|	НоменклатураПоЯчейкам.Характеристика КАК Характеристика,
	|	НоменклатураПоЯчейкам.Партия КАК Партия,
	|	НоменклатураПоЯчейкам.Ячейка КАК Ячейка,
	|	НоменклатураПоЯчейкам.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ОстаткиПоЯчейкам.КоличествоОстаток КАК ОстатокВЯчейке,
	|	РасходПоЯчейкам.Количество КАК ДвижениеПоЯчейке,
	|	ЕСТЬNULL(ОстаткиПоЯчейкам.КоличествоОстаток, 0) + ЕСТЬNULL(РасходПоЯчейкам.Количество, 0) КАК ОстатокСУчетомДвижения,
	|	ЕСТЬNULL(РезервПоСкладу.КоличествоОстаток, 0) КАК РезервПоСкладуБезТекЗаказов
	|ИЗ
	|	НоменклатураПоЯчейкам КАК НоменклатураПоЯчейкам
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиПоЯчейкам КАК ОстаткиПоЯчейкам
	|		ПО НоменклатураПоЯчейкам.Номенклатура = ОстаткиПоЯчейкам.Номенклатура
	|			И НоменклатураПоЯчейкам.Характеристика = ОстаткиПоЯчейкам.Характеристика
	|			И НоменклатураПоЯчейкам.Партия = ОстаткиПоЯчейкам.Партия
	|			И НоменклатураПоЯчейкам.Ячейка = ОстаткиПоЯчейкам.Ячейка
	|			И НоменклатураПоЯчейкам.СтруктурнаяЕдиница = ОстаткиПоЯчейкам.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ РасходПоЯчейкам КАК РасходПоЯчейкам
	|		ПО НоменклатураПоЯчейкам.Номенклатура = РасходПоЯчейкам.Номенклатура
	|			И НоменклатураПоЯчейкам.Характеристика = РасходПоЯчейкам.Характеристика
	|			И НоменклатураПоЯчейкам.Партия = РасходПоЯчейкам.Партия
	|			И НоменклатураПоЯчейкам.Ячейка = РасходПоЯчейкам.Ячейка
	|			И НоменклатураПоЯчейкам.СтруктурнаяЕдиница = РасходПоЯчейкам.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервПоСкладу КАК РезервПоСкладу
	|		ПО НоменклатураПоЯчейкам.Номенклатура = РезервПоСкладу.Номенклатура
	|			И НоменклатураПоЯчейкам.Характеристика = РезервПоСкладу.Характеристика
	|			И НоменклатураПоЯчейкам.Партия = РезервПоСкладу.Партия
	|			И НоменклатураПоЯчейкам.СтруктурнаяЕдиница = РезервПоСкладу.СтруктурнаяЕдиница
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОстатокСУчетомДвижения,
	|	Ячейка";
	
	ТаблицаПоЯчейкам = Запрос.Выполнить().Выгрузить();
	
	МассивСтрокКУделению = Новый Массив;
	
	ТаблицаСкладов = ТаблицаПоЯчейкам.Скопировать(,"СтруктурнаяЕдиница");
	ТаблицаСкладов.Свернуть("СтруктурнаяЕдиница");
	
	Для Каждого СтрокаТаблицы из ТаблицаНоменклатуры Цикл
		
		Для Каждого СкладСОстатками из ТаблицаСкладов Цикл
			
			ПараметрыОтбора = Новый Структура("Номенклатура, Характеристика, Партия, СтруктурнаяЕдиница"
			, СтрокаТаблицы.Номенклатура, СтрокаТаблицы.Характеристика, СтрокаТаблицы.Партия, СкладСОстатками.СтруктурнаяЕдиница);
			СтрокиПоЯчейкам = ТаблицаПоЯчейкам.НайтиСтроки(ПараметрыОтбора);
			
			МассивСтрокКУделению.Очистить();
			
			ПерваяИтерация = Истина;
			РезервПоСкладуБезТекЗаказов = 0;
			
			Для Каждого СтрокаПоЯчейке из СтрокиПоЯчейкам Цикл
				
				РезервПоСкладуБезТекЗаказов = ?(ПерваяИтерация, СтрокаПоЯчейке.РезервПоСкладуБезТекЗаказов, РезервПоСкладуБезТекЗаказов);
				ПерваяИтерация = Ложь;
				
				Если РезервПоСкладуБезТекЗаказов <= 0 Тогда Прервать КонецЕсли;
				
				Если РезервПоСкладуБезТекЗаказов > СтрокаПоЯчейке.ОстатокСУчетомДвижения Тогда
					РезервПоСкладуБезТекЗаказов = РезервПоСкладуБезТекЗаказов - СтрокаПоЯчейке.ОстатокСУчетомДвижения;
					СтрокаПоЯчейке.ОстатокСУчетомДвижения = 0;
					МассивСтрокКУделению.Добавить(СтрокаПоЯчейке);
				Иначе
					СтрокаПоЯчейке.ОстатокСУчетомДвижения = СтрокаПоЯчейке.ОстатокСУчетомДвижения - РезервПоСкладуБезТекЗаказов;
					РезервПоСкладуБезТекЗаказов = 0;
				КонецЕсли;
				
				СтрокаПоЯчейке.РезервПоСкладуБезТекЗаказов = РезервПоСкладуБезТекЗаказов;
				
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Для Каждого СтрокаКУдалению из МассивСтрокКУделению Цикл
		ТаблицаПоЯчейкам.Удалить(СтрокаКУдалению);
	КонецЦикла;
	
	Возврат ТаблицаПоЯчейкам;
	
КонецФункции

Процедура ЗаполнитьСтруктурнуюЕдиницуРезерваВТЧ(Объект)
	
	Если Объект.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти Тогда
		Возврат;
	КонецЕсли; 
	
	Для каждого СтрокаТабличнойЧасти Из Объект.Запасы Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаТабличнойЧасти.Номенклатура) 
			ИЛИ ТипЗнч(СтрокаТабличнойЧасти.Номенклатура)<>Тип("СправочникСсылка.Номенклатура") Тогда
			Продолжить;
		КонецЕсли;
		Если НЕ СтрокаТабличнойЧасти.ТипНоменклатурыЗапас Тогда
			Продолжить;
		КонецЕсли; 
		СтрокаТабличнойЧасти.СтруктурнаяЕдиницаРезерв = Объект.СтруктурнаяЕдиницаРезерв;
		СтрокаТабличнойЧасти.Ячейка = Объект.Ячейка;
	КонецЦикла;
	Для каждого СтрокаТабличнойЧасти Из Объект.Материалы Цикл
		СтрокаТабличнойЧасти.СтруктурнаяЕдиницаРезерв = Объект.СтруктурнаяЕдиницаРезерв;
		СтрокаТабличнойЧасти.Ячейка = Объект.Ячейка;
	КонецЦикла;
	
КонецПроцедуры

Функция ИнформацияОбОтборе(НаименованиеМетки) Экспорт
	
	Цвет = ЦветаСтиля.ТекстВторостепеннойНадписи;
	Шрифт = ШрифтыСтиля.ШрифтПравойПанелиОтборов;
	
	КомпонентыФС = Новый Массив;
	КомпонентыФС.Добавить(Новый ФорматированнаяСтрока(НаименованиеМетки + " ", Шрифт, Цвет));
	КомпонентыФС.Добавить(Новый ФорматированнаяСтрока(БиблиотекаКартинок.Очистить, , , , "ДублиСтрок"));
	
	Возврат  Новый ФорматированнаяСтрока(КомпонентыФС);
	
КонецФункции

#КонецОбласти

#Область ОбновлениеОстатков

Процедура ОбновитьОстаткиНоменклатурыВФоне() Экспорт
	
	ВнешняяТранзакция = ТранзакцияАктивна();
	Если НЕ ВнешняяТранзакция Тогда
		НачатьТранзакцию();
	КонецЕсли;
	
	// Тут будут ждать другие фоновые задания.
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ОстаткиТоваров");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	Блокировка.Заблокировать();
	
	// Запрос возвращает разницу между регистром сведений ОстаткиТоваров и регистром накопления ЗапасыНаСкладах.
	// В запросе нельзя использовать ПОЛНОЕ СОЕДИНЕНИЕ из-за ограничений при работе на СУБД Postgresql.
	// Запрос корректно отрабатывает номенклатуру, которой нет в остатках РН, но есть в регистре сведений.
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	| ВложенныйЗапрос.Номенклатура КАК Номенклатура,
	| СУММА(ВложенныйЗапрос.КоличествоОстаток) КАК Количество
	|ИЗ
	| (ВЫБРАТЬ
	|  ЗапасыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|  ЗапасыНаСкладахОстатки.КоличествоОстаток КАК КоличествоОстаток,
	|  0 КАК Количество
	| ИЗ
	|  РегистрНакопления.ЗапасыНаСкладах.Остатки КАК ЗапасыНаСкладахОстатки
	| 
	| ОБЪЕДИНИТЬ ВСЕ
	| 
	| ВЫБРАТЬ
	|  ОстаткиТоваров.Номенклатура,
	|  0,
	|  ОстаткиТоваров.Количество
	| ИЗ
	|  РегистрСведений.ОстаткиТоваров КАК ОстаткиТоваров) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	| ВложенныйЗапрос.Номенклатура
	|
	|ИМЕЮЩИЕ
	| СУММА(ВложенныйЗапрос.КоличествоОстаток) <> СУММА(ВложенныйЗапрос.Количество)"; 
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		НаборЗаписей = РегистрыСведений.ОстаткиТоваров.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Номенклатура.Установить(Выборка.Номенклатура);
		
		Запись = НаборЗаписей.Добавить();
		Запись.Номенклатура = Выборка.Номенклатура;
		Запись.Количество = Выборка.Количество;
		
		НаборЗаписей.Записать(Истина);
		
	КонецЦикла;
	
	Если НЕ ВнешняяТранзакция Тогда
		ЗафиксироватьТранзакцию();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
